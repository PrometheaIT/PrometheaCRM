import{a as _t}from"./chunk-RABAOIS3.js";import{a as mt}from"./chunk-QZTS6G3I.js";import{c as ut,f as gt}from"./chunk-DS74SF54.js";import{a as pt}from"./chunk-4JVSDGSA.js";import{b as ot,d as rt,f as at,o as st,p as lt,u as ct}from"./chunk-RJG6IVUB.js";import{b as dt}from"./chunk-DJQTFFKQ.js";import{a as nt}from"./chunk-KESXA3II.js";import{b as et,c as it}from"./chunk-2LFLHQ3L.js";import{c as G,d as J,e as Q,k as X,p as Z,q as tt}from"./chunk-CMIGMSNZ.js";import{A as D,Db as M,Ga as R,I as z,La as f,S,Va as Y,Wa as p,X as u,Xa as n,Y as g,Ya as o,Za as b,bb as N,cb as U,ea as E,eb as x,f as L,hb as _,ib as m,jb as y,lb as I,nb as s,ob as P,pb as w,rb as K,sa as A,sb as B,tb as j,ua as l,ub as H,wb as W,x as F,yb as q,za as $}from"./chunk-54AF7LZE.js";import"./chunk-X5YLR3NI.js";import{a as T,b as V,i as v}from"./chunk-ODN5LVDJ.js";var ht=()=>["/soggetto/nuovo"],vt=(a,t)=>({"product-promethea":a,"product-yuvi":t});function Pt(a,t){if(a&1&&(n(0,"span"),s(1),o()),a&2){let e=m();l(),P(e.totalProspectCount())}}function xt(a,t){if(a&1&&(n(0,"span"),s(1),o()),a&2){let e=m();l(),P(e.kpi().senzaContatto)}}function Ct(a,t){if(a&1&&(n(0,"span"),s(1),o()),a&2){let e=m();l(),P(e.kpi().daRichiamare)}}function bt(a,t){if(a&1&&(n(0,"span"),s(1),o()),a&2){let e=m();l(),P(e.configuredCount())}}function St(a,t){a&1&&b(0,"span",52)}function yt(a,t){if(a&1&&(n(0,"option",53),s(1),o()),a&2){let e=t.$implicit;p("value",e),l(),P(e)}}function wt(a,t){if(a&1&&(n(0,"option",53),s(1),o()),a&2){let e=t.$implicit;p("value",e),l(),P(e)}}function Et(a,t){if(a&1&&(n(0,"option",53),s(1),o()),a&2){let e=t.$implicit;p("value",e),l(),P(e)}}function It(a,t){if(a&1&&(n(0,"option",53),s(1),o()),a&2){let e=t.$implicit;p("value",e),l(),P(e)}}function kt(a,t){if(a&1&&(n(0,"span"),s(1),o()),a&2){let e=m().$implicit;l(),P(e.comune)}}function Tt(a,t){if(a&1&&(n(0,"span"),s(1),o()),a&2){let e=m().$implicit;l(),w(" (",e.provincia,")")}}function Lt(a,t){a&1&&(n(0,"span",77),s(1," Nessun indirizzo "),o())}function Mt(a,t){a&1&&(n(0,"span",78),s(1,"S\xEC"),o())}function Ot(a,t){a&1&&(n(0,"span",79),s(1,"No"),o())}function Vt(a,t){if(a&1&&(n(0,"div",83),s(1),o()),a&2){let e=m().ngIf,i=m(2);l(),w(" ",i.formatEsitoDate(e)," ")}}function Ft(a,t){if(a&1&&(N(0),n(1,"div",80)(2,"div",81),s(3),o(),f(4,Vt,2,1,"div",82),o(),U()),a&2){let e=t.ngIf;l(3),P(e.tipo),l(),p("ngIf",e.tipo==="Richiamare"||e.tipo==="Appuntamento")}}function Dt(a,t){a&1&&s(0,"\u2014")}function zt(a,t){if(a&1){let e=x();n(0,"button",88),_("click",function(){u(e);let r=m().$implicit,c=m(2).$implicit,d=m();return g(d.removeSelectedProduct(c,r))}),s(1," \xD7 "),o()}if(a&2){let e=m().$implicit;p("title",H("Rimuovi ",e))}}function At(a,t){if(a&1&&(n(0,"span",86),s(1),f(2,zt,2,2,"button",87),o()),a&2){let e=t.$implicit,i=m(2).$implicit,r=m();p("ngClass",q(3,vt,e==="Promethea",e==="YUVI")),l(),w(" ",e," "),l(),p("ngIf",!r.isProdottoAutomatico(e,i))}}function $t(a,t){if(a&1&&(n(0,"div",84),f(1,At,3,6,"span",85),o()),a&2){let e=m().$implicit,i=m();l(),p("ngForOf",i.getSelectedProducts(e))}}function Rt(a,t){if(a&1&&(n(0,"option",53),s(1),o()),a&2){let e=t.$implicit;p("value",e.nome),l(),w(" ",e.nome," ")}}function Yt(a,t){a&1&&(n(0,"div",94),b(1,"span",95),o())}function Nt(a,t){if(a&1){let e=x();n(0,"div",89)(1,"select",90,7),_("change",function(r){u(e);let c=m().$implicit,d=m();return g(d.onProductSelectChange(c,r))}),f(3,Rt,2,2,"option",32),o(),n(4,"div",91)(5,"button",92),_("click",function(){u(e);let r=m(2);return g(r.closeProductPicker())}),s(6,"Chiudi"),o(),f(7,Yt,2,0,"div",93),o()()}if(a&2){let e=m().$implicit,i=m();l(),p("value",i.getSelectedProducts(e))("disabled",i.updatingProdottoIds.has(e.id)),l(2),p("ngForOf",i.getManualProducts()),l(4),p("ngIf",i.updatingProdottoIds.has(e.id))}}function Ut(a,t){if(a&1){let e=x();n(0,"button",96),_("click",function(r){u(e);let c=m().$implicit,d=m();return r.stopPropagation(),g(d.vediConfigurazionePromethea(c))}),b(1,"img",97),o()}}function Kt(a,t){if(a&1){let e=x();n(0,"button",98),_("click",function(r){u(e);let c=m().$implicit,d=m();return r.stopPropagation(),g(d.vediTrattativaYuvi(c))}),b(1,"img",99),o()}}function Bt(a,t){if(a&1){let e=x();n(0,"button",105),_("click",function(r){u(e);let c=m(2).$implicit,d=m();return r.stopPropagation(),d.vediConfigurazionePromethea(c),g(d.closeAllDropdowns())}),b(1,"img",106),n(2,"span"),s(3,"Configura Promethea"),o()()}}function jt(a,t){if(a&1){let e=x();n(0,"button",105),_("click",function(r){u(e);let c=m(2).$implicit,d=m();return r.stopPropagation(),d.vediTrattativaYuvi(c),g(d.closeAllDropdowns())}),b(1,"img",107),n(2,"span"),s(3,"Trattativa YUVI"),o()()}}function Ht(a,t){if(a&1){let e=x();n(0,"div",100)(1,"div",101),f(2,Bt,4,0,"button",102)(3,jt,4,0,"button",102),n(4,"button",103),_("click",function(r){u(e);let c=m().$implicit,d=m();return r.stopPropagation(),d.onEdit(c),g(d.closeAllDropdowns())}),n(5,"span",17),s(6,"edit"),o(),n(7,"span"),s(8,"Modifica"),o()(),n(9,"button",103),_("click",function(r){u(e);let c=m().$implicit,d=m();return r.stopPropagation(),d.openEsito(c),g(d.closeAllDropdowns())}),n(10,"span",17),s(11,"add"),o(),n(12,"span"),s(13,"Aggiungi esito"),o()(),n(14,"button",103),_("click",function(r){u(e);let c=m().$implicit,d=m();return r.stopPropagation(),g(d.openProductPicker(c))}),n(15,"span",17),s(16,"inventory_2"),o(),n(17,"span"),s(18,"Aggiungi Prodotto"),o()(),n(19,"button",104),_("click",function(r){u(e);let c=m().$implicit,d=m();return r.stopPropagation(),d.onDelete(c),g(d.closeAllDropdowns())}),n(20,"span",17),s(21,"delete"),o(),n(22,"span"),s(23,"Elimina"),o()()()()}if(a&2){let e=m().$implicit,i=m();l(2),p("ngIf",e.hasConfigPromethea),l(),p("ngIf",e.hasTrattativaYuvi),l(16),p("disabled",i.deletingIds.has(e.id))}}function Wt(a,t){if(a&1){let e=x();n(0,"div",108),_("click",function(){u(e);let r=m(2);return g(r.closeAllDropdowns())}),o()}}function qt(a,t){if(a&1){let e=x();n(0,"tr",54)(1,"td",55)(2,"div",56)(3,"strong",57),_("click",function(){let r=u(e).$implicit,c=m();return g(c.apriScheda(r))}),s(4),o()()(),n(5,"td",58)(6,"div",56),s(7),o()(),n(8,"td",59)(9,"div",56),s(10),o()(),n(11,"td",60)(12,"div",56),f(13,kt,2,1,"span",48)(14,Tt,2,1,"span",48)(15,Lt,2,0,"span",61),o()(),n(16,"td",62)(17,"div",56),f(18,Mt,2,0,"span",63)(19,Ot,2,0,"span",64),o()(),n(20,"td",65)(21,"div",56),f(22,Ft,5,2,"ng-container",22)(23,Dt,1,0,"ng-template",null,6,M),o()(),n(25,"td",66)(26,"div",56),f(27,$t,2,1,"div",67)(28,Nt,8,4,"div",68),o()(),n(29,"td",69)(30,"div",70),f(31,Ut,2,0,"button",71)(32,Kt,2,0,"button",72),n(33,"div",73)(34,"button",74),_("click",function(r){let c=u(e).$implicit,d=m();return r.stopPropagation(),g(d.toggleActionsDropdown(c.id,r))}),n(35,"span",17),s(36,"more_vert"),o()(),f(37,Ht,24,3,"div",75)(38,Wt,1,0,"div",76),o()()()()}if(a&2){let e=t.$implicit,i=y(24),r=m();Y("data-row-id",e.id),l(4),P(e.ragione_sociale),l(3),P(e.referente||"\u2014"),l(3),P(e.telefono||"\u2014"),l(3),p("ngIf",e.comune),l(),p("ngIf",e.provincia),l(),p("ngIf",!e.comune&&!e.provincia),l(3),p("ngIf",e.configurato),l(),p("ngIf",!e.configurato),l(3),p("ngIf",e.ultimoEsito)("ngIfElse",i),l(5),p("ngIf",r.getSelectedProducts(e).length>0),l(),p("ngIf",r.isProductPickerOpen(e)),l(3),p("ngIf",e.hasConfigPromethea),l(),p("ngIf",e.hasTrattativaYuvi),l(),I("open",r.activeDropdownId===e.id),l(4),p("ngIf",r.activeDropdownId===e.id),l(),p("ngIf",r.activeDropdownId===e.id)}}function Gt(a,t){if(a&1&&(n(0,"tr")(1,"td",109),s(2),o()()),a&2){let e=m();l(2),w(" ",e.searchTerm?"Nessun prospect trovato":"Nessun prospect"," ")}}function Jt(a,t){a&1&&(n(0,"span",17),s(1,"unfold_more"),o())}function Qt(a,t){a&1&&(n(0,"span",17),s(1,"hourglass_bottom"),o())}function Xt(a,t){if(a&1){let e=x();n(0,"div",110)(1,"button",111),_("click",function(){u(e);let r=m();return g(r.caricaTutti())}),f(2,Jt,2,0,"span",112)(3,Qt,2,0,"span",112),s(4),o()()}if(a&2){let e=m();l(),p("disabled",e.loading()),l(),p("ngIf",!e.loading()),l(),p("ngIf",e.loading()),l(),w(" ",e.loading()?"Caricamento\u2026":"Carica tutti"," ")}}function Zt(a,t){if(a&1&&(n(0,"div",113),s(1),o()),a&2){let e=m();l(),w(" ",e.error()," ")}}var ft=class a{listaService=S(mt);soggettiService=S(dt);authService=S(it);userService=S(nt);router=S(Z);renderer=S($);supa=S(et);searchSubject=new L;destroy$=new L;rows=this.listaService.rows;filteredRows=this.listaService.filteredRows;loading=this.listaService.loading;error=this.listaService.error;hasMore=this.listaService.hasMore;currentFiltri=this.listaService.currentFiltri;prodottiList=[];prodotti=E([]);updatingProdottoIds=new Set;productPickerOpenId=null;configuredCountValue=-1;categorieMerceologiche=gt;selectedCategoria="tutte";province=E([]);kpiLoading=E(!1);kpi=E({senzaContatto:0,daRichiamare:0,configurati:0});totalProspectCount=E(0);deletingIds=new Set;showEsito=!1;selectedId=null;activeDropdownId=null;clickListener;esitiTipi=ut;searchTerm="";filtroConfigurato=null;isLoading=E(!0);constructor(){this.searchSubject.pipe(z(this.destroy$),F(300),D()).subscribe(t=>{this.onSearchExecuted(t)})}ngOnInit(){return v(this,null,function*(){console.log("\u{1F680} Lista Prospect - START"),this.isLoading.set(!0);try{if(yield this.authService.getAuthState(),!this.authService.user()){console.error("\u274C Nessun utente autenticato!"),this.isLoading.set(!1);return}yield this.loadProdotti(),this.listaService.inizializza({tipo:"prospect",abilitaConfigurazioni:!0,abilitaTrattative:!0}),console.log("\u2699\uFE0F Servizio inizializzato"),yield Promise.all([this.listaService.caricaIniziali(),this.loadProvince(),this.loadTotalKPI()]),yield this.loadConfiguredCount(),console.log("\u2705 Init completato")}catch(t){console.error("\u274C Errore durante init:",t),this.refreshLocalKPI()}finally{setTimeout(()=>{this.isLoading.set(!1)},300)}})}refreshData(){return v(this,null,function*(){try{yield this.listaService.caricaTutti(),yield this.loadTotalKPI()}catch(t){console.error("\u274C Errore refresh data:",t),this.refreshLocalKPI()}})}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete(),this.closeAllDropdowns()}loadMore(t=!1){return v(this,null,function*(){yield this.listaService.caricaTutti()})}loadProdotti(){return v(this,null,function*(){try{let t=yield this.supa.getProdotti();if(t.error)throw t.error;let e=(t.data??[]).map(i=>V(T({},i),{nome:String(i.nome??"").trim()})).filter(i=>!!i.attivo);this.prodotti.set(e)}catch(t){console.error("Errore loadProdotti lista-prospect:",t),this.prodotti.set([{nome:"Promethea",attivo:!0},{nome:"YUVI",attivo:!0}])}})}allLoaded(){return this.listaService.allLoaded()}caricaTutti(){return v(this,null,function*(){yield this.listaService.caricaTutti()})}onSearchExecuted(t){return v(this,null,function*(){yield this.listaService.cerca(t)})}onSearchChange(t){this.searchTerm=t,this.searchSubject.next(t)}onChangeFiltroEsito(t){this.listaService.applicaFiltri({esito:t,configurato:null}),this.filtroConfigurato=null}onChangeFiltroProvincia(t){this.listaService.applicaFiltri({provincia:t})}onChangeSortDir(t){this.listaService.applicaFiltri({sortDir:t})}onFiltroTotale(){this.listaService.applicaFiltri({esito:"tutti",provincia:"tutte",configurato:null}),this.filtroConfigurato=null}onFiltroSenzaContatto(){this.listaService.applicaFiltri({esito:"senza-esito",configurato:null}),this.filtroConfigurato=null}onFiltroDaRichiamare(){this.listaService.applicaFiltri({esito:"Richiamare",configurato:null}),this.filtroConfigurato=null}onFiltroConfigurati(){this.listaService.applicaFiltri({esito:"tutti",configurato:!0}),this.filtroConfigurato=!0}vediConfigurazionePromethea(t){this.router.navigate(["/alchemizzatore"],{queryParams:{prospectId:t.id,step:6}})}vediTrattativaYuvi(t){return v(this,null,function*(){try{let{data:e,error:i}=yield this.soggettiService.supabaseService.supabase.from("trattative_yuvi").select("*").eq("prospect_id",t.id).order("created_at",{ascending:!1}).limit(1).single();if(i)throw i;if(!e){alert("Nessuna trattativa YUVI trovata per questo prospect");return}this.router.navigate(["/yuvi-trattativa"],{queryParams:{prospectId:t.id,trattativaId:e.id,step:7},state:{prospect:t,trattativaEsistente:e,from:"lista-prospect"}})}catch(e){alert("Errore nel caricamento della trattativa: "+e.message)}})}onDelete(t){return v(this,null,function*(){if(!(!t?.id||!confirm(`Eliminare il prospect "${t.ragione_sociale}"?`))){this.deletingIds.add(t.id);try{(yield this.listaService.eliminaSoggetto(t.id))&&(yield this.loadTotalKPI())}catch(i){console.error("Errore durante l'eliminazione:",i)}finally{this.deletingIds.delete(t.id)}}})}onEdit(t){t?.id&&this.router.navigate(["/soggetto",t.id,"edit"])}openEsito(t){this.selectedId=t.id,this.showEsito=!0}onPopupClosed(t){return v(this,null,function*(){this.showEsito=!1,this.selectedId=null,t.saved&&(yield Promise.all([this.listaService.caricaTutti(),this.loadTotalKPI()]))})}onProductSelectChange(t,e){let i=e.target,r=Array.from(i.selectedOptions).map(c=>c.value);this.onChangeProdotto(t,r)}invalidateProdottoCache(t){t._prodottiCache&&delete t._prodottiCache}onChangeProdotto(t,e){return v(this,null,function*(){if(!t?.id||this.updatingProdottoIds.has(t.id))return;let i=this.prodotti().map(h=>h.nome),r=e.filter(h=>i.includes(h)),c=[];t.hasConfigPromethea&&c.push("Promethea"),t.hasTrattativaYuvi&&c.push("YUVI");let C=[...new Set([...c,...r])].join(", ");if((t.prodotto||"").toString().trim()!==C){this.updatingProdottoIds.add(t.id);try{let h=yield this.listaService.aggiornaProdotto(t.id,C);h&&!h.error?(t.prodotto=C,this.invalidateProdottoCache(t),yield this.listaService.caricaIniziali(),this.closeProductPicker()):console.error("Errore aggiornamento prodotto:",h?.error)}catch(h){console.error("Errore durante aggiornamento prodotto:",h)}finally{this.updatingProdottoIds.delete(t.id)}}})}getProdottiAutomatici(t){let e=[];return t.hasConfigPromethea&&e.push("Promethea"),t.hasTrattativaYuvi&&e.push("YUVI"),e.length?e.join(", "):(t.prodotto??"").toString()}trackById=(t,e)=>`${e.id}-${e.prodotto}-${e.hasConfigPromethea}-${e.hasTrattativaYuvi}`;toggleActionsDropdown(t,e){e&&e.stopPropagation();let i=this.activeDropdownId===t;this.activeDropdownId=i?null:t,this.activeDropdownId?(this.clickListener=this.renderer.listen("document","click",r=>{r.target.closest(".actions-dropdown")||this.closeAllDropdowns()}),document.body.classList.add("dropdown-open")):this.closeAllDropdowns()}closeAllDropdowns(){this.activeDropdownId=null,document.body.classList.remove("dropdown-open"),this.clickListener&&(this.clickListener(),this.clickListener=void 0)}onWindowScroll(){this.activeDropdownId&&this.closeAllDropdowns()}loadProvince(){return v(this,null,function*(){let{data:t}=yield this.soggettiService.getProvinceByTipo("prospect");t&&this.province.set(t)})}loadTotalKPI(){return v(this,null,function*(){this.kpiLoading.set(!0);try{let e=(yield this.soggettiService.countByTipo("prospect")).data||0;if(this.totalProspectCount.set(e),e===0){this.kpi.set({senzaContatto:0,daRichiamare:0,configurati:0});return}let{data:i,error:r}=yield this.soggettiService.getSoggettiByTipo("prospect",0,Math.max(e,1e3));if(r)throw console.warn("\u26A0\uFE0F Errore caricamento prospect per KPI:",r),r;if(!i||i.length===0){this.kpi.set({senzaContatto:0,daRichiamare:0,configurati:0});return}if(i.map(h=>h.id).filter(h=>!!h).length===0){this.kpi.set({senzaContatto:0,daRichiamare:0,configurati:0});return}yield this.loadConfiguredCount();let d=0,C=0;i.forEach(h=>{let O=this.getLastEsito(h.esiti);O||d++,O?.tipo==="Richiamare"&&C++});let k=this.configuredCountValue>=0?this.configuredCountValue:0;this.kpi.set({senzaContatto:d,daRichiamare:C,configurati:k}),console.log("\u2705 KPI calcolati:",{total:e,senzaContatto:d,daRichiamare:C,configurati:k,prospectProcessati:i.length})}catch(t){console.error("\u274C Errore nel caricamento KPI totali:",t),this.refreshLocalKPI()}finally{this.kpiLoading.set(!1)}})}loadConfiguredCount(){return v(this,null,function*(){try{let t=new Set,{data:e,error:i}=yield this.supa.supabase.from("configurazioni_promethea").select("prospect_id");!i&&Array.isArray(e)&&e.forEach(d=>{d?.prospect_id&&t.add(String(d.prospect_id))});let{data:r,error:c}=yield this.supa.supabase.from("trattative_yuvi").select("prospect_id");!c&&Array.isArray(r)&&r.forEach(d=>{d?.prospect_id&&t.add(String(d.prospect_id))}),this.configuredCountValue=t.size}catch(t){console.error("Errore conteggio configurati:",t),this.configuredCountValue=0}})}refreshLocalKPI(){console.log("\u{1F504} Usando KPI locali come fallback...");let t=this.rows();if(t.length===0){let i=this.kpi();i.senzaContatto===0&&i.daRichiamare===0&&i.configurati===0&&(this.totalProspectCount.set(0),this.kpi.set({senzaContatto:0,daRichiamare:0,configurati:0}));return}let e={senzaContatto:t.filter(i=>!i.ultimoEsito).length,daRichiamare:t.filter(i=>i.ultimoEsito?.tipo==="Richiamare").length,configurati:t.filter(i=>i.hasConfigPromethea||i.hasTrattativaYuvi).length};this.totalProspectCount.set(t.length),this.kpi.set(e),this.configuredCountValue=e.configurati,console.log("\u{1F4CA} KPI locali:",T({totalLocal:t.length},e))}getLastEsito(t){return!Array.isArray(t)||t.length===0?null:t.reduce((e,i)=>{let r=new Date(i.ts).getTime(),c=new Date(e.ts).getTime();return r>c?i:e})}formatEsitoDate(t){if(!t)return"";let e=t.tipo==="Appuntamento"||t.tipo==="Fissato appuntamento";if(t.tipo==="Richiamare"&&t.scheduleAt){let i=new Date(t.scheduleAt),r=i.getDate().toString().padStart(2,"0"),c=(i.getMonth()+1).toString().padStart(2,"0"),d=i.getFullYear(),C=i.getHours().toString().padStart(2,"0"),k=i.getMinutes().toString().padStart(2,"0");return`${r}/${c}/${d} alle ${C}:${k}`}if(e&&t.dataAppuntamento){let i=t.oraAppuntamento?` alle ${t.oraAppuntamento}`:"";return`${this.formatDateString(t.dataAppuntamento)}${i}`}return""}pad(t){return t.toString().padStart(2,"0")}formatDateString(t){if(!t&&t!==0)return"";if(t instanceof Date)return`${this.pad(t.getDate())}/${this.pad(t.getMonth()+1)}/${t.getFullYear()}`;let e=String(t).trim(),i=e.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(i)return`${i[3]}/${i[2]}/${i[1]}`;let r=Date.parse(e);if(!isNaN(r)){let c=new Date(r);return`${this.pad(c.getDate())}/${this.pad(c.getMonth()+1)}/${c.getFullYear()}`}return e}apriScheda(t){t?.id&&this.router.navigate(["/soggetto",t.id])}getSelectedProducts(t){if(t._prodottiCache)return t._prodottiCache;let e=[];if(t.prodotto){let i=t.prodotto.split(",").map(r=>r.trim()).filter(r=>{let c=r.toLowerCase();return r&&c!=="promethea"&&c!=="yuvi"});e.push(...i)}return t.hasConfigPromethea&&!e.includes("Promethea")&&e.push("Promethea"),t.hasTrattativaYuvi&&!e.includes("YUVI")&&e.push("YUVI"),t._prodottiCache=e,e}isProdottoAutomatico(t,e){let i=(t??"").toString().trim().toLowerCase();return i==="promethea"?!!e.hasConfigPromethea:i==="yuvi"?!!e.hasTrattativaYuvi:!1}removeSelectedProduct(t,e){if(!t)return;let r=(Array.isArray(this.getSelectedProducts(t))?this.getSelectedProducts(t):[]).filter(c=>c!==e);this.onChangeProdotto(t,r)}openProductPicker(t,e){e&&e.stopPropagation(),this.productPickerOpenId=t?.id??null,this.closeAllDropdowns()}closeProductPicker(){this.productPickerOpenId=null}isProductPickerOpen(t){return!!t&&this.productPickerOpenId===t.id}getManualProducts(){let t=new Set(["promethea","yuvi"]);return this.prodotti().filter(e=>{let i=(e.nome??"").toString().trim().toLowerCase();return i&&!t.has(i)})}prodottiOptions(){let t=new Map;for(let e of this.prodotti()){let i=(e.nome??"").toString().trim();if(!i)continue;let r=i.toLowerCase();t.has(r)||t.set(r,i)}return t.set("promethea",t.get("promethea")??"Promethea"),t.set("yuvi",t.get("yuvi")??"YUVI"),Array.from(t.values())}onChangeFiltroProdotto(t){this.listaService.applicaFiltri({prodotto:t})}resetAllFilters(){return v(this,null,function*(){this.searchTerm="",this.filtroConfigurato=null,this.listaService.applicaFiltri({provincia:"tutte",searchTerm:"",esito:"tutti",sortDir:"desc",configurato:null,prodotto:"tutti",categoria_ateco:"tutte",conIban:!1,conReferente:!1});try{yield this.listaService.caricaIniziali(),yield this.loadTotalKPI()}catch(t){console.error("Errore reset filtri:",t)}})}configuredCount(){return this.configuredCountValue>=0?this.configuredCountValue:this.kpi&&this.kpi().configurati?this.kpi().configurati:0}updateConfiguredCount(...t){let e=new Set,i=r=>{if(r){if(r instanceof Map){r.forEach((c,d)=>{d&&e.add(String(d))});return}if(Array.isArray(r)){for(let c of r){let d=c?.prospect_id??c?.soggetto_id??c?.id??null;d&&e.add(String(d))}return}typeof r=="object"&&Object.keys(r).forEach(c=>{c&&e.add(String(c))})}};for(let r of t)i(r);this.configuredCountValue=e.size}displayRows(){return this.filtroConfigurato===!0?this.rows().filter(t=>!!(t.hasConfigPromethea||t.hasTrattativaYuvi)):this.filteredRows()}onChangeFiltroCategoria(t){this.selectedCategoria=t;let e=t==="tutte"?null:t||null;this.listaService.applicaFiltri({categoria_ateco:e}),console.debug("Filtro categoria impostato:",e,"currentFiltri():",this.currentFiltri())}static \u0275fac=function(e){return new(e||a)};static \u0275cmp=R({type:a,selectors:[["app-lista-prospect"]],hostBindings:function(e,i){e&1&&_("scroll",function(){return i.onWindowScroll()},A)},decls:130,vars:39,consts:[["loadingSpinner",""],["filtroSel",""],["ordinaSel",""],["provSel",""],["prodSel",""],["categoriaSel",""],["noEsito",""],["sel",""],["title","Caricamento Prospect","subtitle","Stiamo caricando i tuoi prospect...",3,"isLoading"],[1,"form-section"],[1,"section-header"],[1,"material-icons","header-icon"],[1,"section-titles"],[1,"section-title"],[1,"sottotitolo"],[1,"flex-1"],["title","Aggiungi prospect","aria-label","Aggiungi prospect",1,"icon-btn",3,"routerLink"],[1,"material-icons"],[1,"prospect-cards"],[1,"card",3,"click"],[1,"card-title"],[1,"card-number"],[4,"ngIf","ngIfElse"],[1,"table-section"],[1,"table-tools"],[1,"tool"],["for","search",1,"label"],["id","search","type","text","placeholder","Nome, telefono, email...",1,"table-inline-input",3,"ngModelChange","ngModel"],["for","filtroEsito",1,"label"],["id","filtroEsito",1,"table-inline-select",3,"change","value"],["value","tutti"],["value","senza-esito"],[3,"value",4,"ngFor","ngForOf"],["for","ordinaPer",1,"label"],["id","ordinaPer",1,"table-inline-select",3,"change","value"],["value","desc"],["value","asc"],["for","filtroProvincia",1,"label"],["id","filtroProvincia",1,"table-inline-select",3,"change","value"],["value","tutte"],["for","filtroProdotto",1,"label"],["id","filtroProdotto",1,"table-inline-select",3,"change","value"],["for","filtroCategoria",1,"label"],["id","filtroCategoria",1,"table-inline-select",3,"change","value"],["type","button",1,"promethea-button","ghost",3,"click"],[1,"table-container"],[1,"crm-table"],["class","row-clickable",4,"ngFor","ngForOf","ngForTrackBy"],[4,"ngIf"],["class","load-more-container",4,"ngIf"],["style","text-align:center; color:#ef4444; margin-top:1rem;",4,"ngIf"],[3,"closed","open","soggettoId","tipo"],[1,"loading-spinner"],[3,"value"],[1,"row-clickable"],["data-label","Ragione Sociale"],[1,"cell-content"],[1,"link",3,"click"],["data-label","Referente"],["data-label","Telefono"],["data-label","Localit\xE0"],["style","color: #6b7280; font-style: italic;",4,"ngIf"],["data-label","Configurato"],["class","badge badge-success",4,"ngIf"],["class","badge badge-danger",4,"ngIf"],["data-label","Ultimo Esito"],["data-label","Prodotto"],["class","selected-badges",4,"ngIf"],["class","product-picker",4,"ngIf"],["data-label","Azioni"],[1,"actions-container"],["class","action-btn document","title","Configurazione Promethea",3,"click",4,"ngIf"],["class","action-btn email","title","Trattativa YUVI",3,"click",4,"ngIf"],[1,"actions-dropdown"],["title","Altre azioni",1,"action-btn",3,"click"],["class","modal",4,"ngIf"],["class","mobile-dropdown-backdrop",3,"click",4,"ngIf"],[2,"color","#6b7280","font-style","italic"],[1,"badge","badge-success"],[1,"badge","badge-danger"],[1,"esito-container"],[1,"esito-tipo"],["class","esito-details text-muted",4,"ngIf"],[1,"esito-details","text-muted"],[1,"selected-badges"],["class","product-badge",3,"ngClass",4,"ngFor","ngForOf"],[1,"product-badge",3,"ngClass"],["class","badge-remove","type","button",3,"title","click",4,"ngIf"],["type","button",1,"badge-remove",3,"click","title"],[1,"product-picker"],["multiple","",1,"table-inline-select",3,"change","value","disabled"],[2,"margin-top","0.5rem","display","flex","gap","0.5rem","align-items","center"],[1,"promethea-button","outline",3,"click"],["class","loading-indicator","style","margin-left:0.5rem;",4,"ngIf"],[1,"loading-indicator",2,"margin-left","0.5rem"],[1,"loading-spinner",2,"width","20px","height","20px","border-width","2px"],["title","Configurazione Promethea",1,"action-btn","document",3,"click"],["src","assets/Logo.png","alt","Promethea",1,"icon-img"],["title","Trattativa YUVI",1,"action-btn","email",3,"click"],["src","assets/yuvi.png","alt","YUVI",1,"icon-img"],[1,"modal"],[1,"modal-body",2,"padding","0"],["class","dropdown-item mobile-only",3,"click",4,"ngIf"],[1,"dropdown-item",3,"click"],[1,"dropdown-item",3,"click","disabled"],[1,"dropdown-item","mobile-only",3,"click"],["src","assets/Logo.png","alt","Promethea",1,"icon-img",2,"width","16px","height","16px"],["src","assets/yuvi.png","alt","YUVI",1,"icon-img",2,"width","16px","height","16px"],[1,"mobile-dropdown-backdrop",3,"click"],["colspan","8",2,"text-align","center","padding","1.5rem"],[1,"load-more-container"],[1,"promethea-button",3,"click","disabled"],["class","material-icons",4,"ngIf"],[2,"text-align","center","color","#ef4444","margin-top","1rem"]],template:function(e,i){if(e&1){let r=x();b(0,"app-page-loader",8),n(1,"div")(2,"div",9)(3,"div",10)(4,"i",11),s(5,"group"),o(),n(6,"div",12)(7,"h2",13),s(8,"Prospect"),o(),n(9,"p",14),s(10,"Panoramica prospect e filtri rapidi"),o()(),b(11,"div",15),n(12,"a",16)(13,"span",17),s(14,"add_circle"),o()()(),n(15,"div",18)(16,"div",19),_("click",function(){return u(r),g(i.onFiltroTotale())}),n(17,"h3",20),s(18,"Totale"),o(),n(19,"div",21),f(20,Pt,2,1,"span",22),o()(),n(21,"div",19),_("click",function(){return u(r),g(i.onFiltroSenzaContatto())}),n(22,"h3",20),s(23,"Senza Contatto"),o(),n(24,"div",21),f(25,xt,2,1,"span",22),o()(),n(26,"div",19),_("click",function(){return u(r),g(i.onFiltroDaRichiamare())}),n(27,"h3",20),s(28,"Da Richiamare"),o(),n(29,"div",21),f(30,Ct,2,1,"span",22),o()(),n(31,"div",19),_("click",function(){return u(r),g(i.onFiltroConfigurati())}),n(32,"h3",20),s(33,"Configurati"),o(),n(34,"div",21),f(35,bt,2,1,"span",22),o()(),f(36,St,1,0,"ng-template",null,0,M),o()(),n(38,"section",23)(39,"div",24)(40,"div",25)(41,"label",26)(42,"span",17),s(43,"search"),o(),s(44," Cerca "),o(),n(45,"input",27),j("ngModelChange",function(d){return u(r),B(i.searchTerm,d)||(i.searchTerm=d),g(d)}),_("ngModelChange",function(d){return u(r),g(i.onSearchChange(d))}),o()(),n(46,"div",25)(47,"label",28)(48,"span",17),s(49,"filter_list"),o(),s(50," Ultimo esito "),o(),n(51,"select",29,1),_("change",function(){u(r);let d=y(52);return g(i.onChangeFiltroEsito(d.value))}),n(53,"option",30),s(54,"Tutti"),o(),n(55,"option",31),s(56,"Senza esito"),o(),f(57,yt,2,2,"option",32),o()(),n(58,"div",25)(59,"label",33)(60,"span",17),s(61,"sort"),o(),s(62," Ordina per: "),o(),n(63,"select",34,2),_("change",function(){u(r);let d=y(64);return g(i.onChangeSortDir(d.value))}),n(65,"option",35),s(66,"Pi\xF9 recente"),o(),n(67,"option",36),s(68,"Meno recente"),o()()(),n(69,"div",25)(70,"label",37)(71,"span",17),s(72,"place"),o(),s(73," Provincia "),o(),n(74,"select",38,3),_("change",function(){u(r);let d=y(75);return g(i.onChangeFiltroProvincia(d.value))}),n(76,"option",39),s(77,"Tutte"),o(),f(78,wt,2,2,"option",32),o()(),n(79,"div",25)(80,"label",40)(81,"span",17),s(82,"inventory_2"),o(),s(83," Prodotto "),o(),n(84,"select",41,4),_("change",function(){u(r);let d=y(85);return g(i.onChangeFiltroProdotto(d.value))}),n(86,"option",30),s(87,"Tutti"),o(),f(88,Et,2,2,"option",32),o()(),n(89,"div",25)(90,"label",42)(91,"span",17),s(92,"category"),o(),s(93," Categoria "),o(),n(94,"select",43,5),_("change",function(){u(r);let d=y(95);return g(i.onChangeFiltroCategoria(d.value))}),n(96,"option",39),s(97,"Tutte"),o(),f(98,It,2,2,"option",32),o()(),n(99,"div",25)(100,"button",44),_("click",function(){return u(r),g(i.resetAllFilters())}),n(101,"span",17),s(102,"filter_alt_off"),o(),s(103," Azzera filtri "),o()()(),n(104,"div",45)(105,"table",46)(106,"thead")(107,"tr")(108,"th"),s(109,"Ragione Sociale"),o(),n(110,"th"),s(111,"Referente"),o(),n(112,"th"),s(113,"Telefono"),o(),n(114,"th"),s(115,"Localit\xE0"),o(),n(116,"th"),s(117,"Configurato"),o(),n(118,"th"),s(119,"Ultimo Esito"),o(),n(120,"th"),s(121,"Prodotto"),o(),n(122,"th"),s(123,"Azioni"),o()()(),n(124,"tbody"),f(125,qt,39,19,"tr",47)(126,Gt,3,1,"tr",48),o()()(),f(127,Xt,5,4,"div",49)(128,Zt,2,1,"div",50),o(),n(129,"app-esito-popup",51),_("closed",function(d){return u(r),g(i.onPopupClosed(d))}),o()()}if(e&2){let r=y(37);p("isLoading",i.isLoading()),l(),I("hidden",i.isLoading()),l(11),p("routerLink",W(38,ht)),l(4),I("card-active",i.currentFiltri().esito==="tutti"&&i.filtroConfigurato===null),l(4),p("ngIf",!i.kpiLoading())("ngIfElse",r),l(),I("card-active",i.currentFiltri().esito==="senza-esito"),l(4),p("ngIf",!i.kpiLoading())("ngIfElse",r),l(),I("card-active",i.currentFiltri().esito==="Richiamare"),l(4),p("ngIf",!i.kpiLoading())("ngIfElse",r),l(),I("card-active",i.filtroConfigurato===!0),l(4),p("ngIf",!i.kpiLoading())("ngIfElse",r),l(10),K("ngModel",i.searchTerm),l(6),p("value",i.currentFiltri().esito),l(6),p("ngForOf",i.esitiTipi),l(6),p("value",i.currentFiltri().sortDir),l(11),p("value",i.currentFiltri().provincia),l(4),p("ngForOf",i.province()),l(6),p("value",i.currentFiltri().prodotto||"tutti"),l(4),p("ngForOf",i.prodottiOptions()),l(6),p("value",i.currentFiltri().categoria_ateco||"tutte"),l(4),p("ngForOf",i.categorieMerceologiche),l(27),p("ngForOf",i.displayRows())("ngForTrackBy",i.trackById),l(),p("ngIf",!i.loading()&&!i.error()&&i.displayRows().length===0),l(),p("ngIf",!i.error()&&i.hasMore()),l(),p("ngIf",i.error()),l(),p("open",i.showEsito)("soggettoId",i.selectedId)("tipo","prospect")}},dependencies:[X,G,J,Q,_t,ct,st,lt,ot,rt,at,tt,pt],styles:['.actions-dropdown[_ngcontent-%COMP%]{position:relative;display:inline-flex}.actions-dropdown[_ngcontent-%COMP%]   .modal[_ngcontent-%COMP%]{position:absolute;top:100%;right:0;width:200px;z-index:1000;border:1px solid var(--smoke-color-1);border-radius:12px;box-shadow:0 8px 24px var(--shadow);background:var(--background);animation:_ngcontent-%COMP%_slideDown .2s ease-out}@keyframes _ngcontent-%COMP%_slideDown{0%{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}.dropdown-item[_ngcontent-%COMP%]{width:100%;display:flex;align-items:center;gap:var(--gutter-sm);padding:.75rem 1rem;border:none;background:transparent;color:var(--text-color);cursor:pointer;transition:background .15s ease;font-size:var(--fs-sm);text-align:left;border-bottom:1px solid var(--smoke-color-1)}.dropdown-item[_ngcontent-%COMP%]:last-child{border-bottom:none}.dropdown-item[_ngcontent-%COMP%]:hover{background:var(--smoke-color-2)}.dropdown-item[_ngcontent-%COMP%]:disabled{opacity:.4;cursor:not-allowed}.dropdown-item[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:1.1rem;width:20px}.dropdown-overlay[_ngcontent-%COMP%]{position:fixed;inset:0;background:transparent;z-index:999;display:none}.actions-dropdown.open[_ngcontent-%COMP%] ~ .dropdown-overlay[_ngcontent-%COMP%]{display:block}@container (max-width: 768px){.crm-table[_ngcontent-%COMP%]   td[data-label=Azioni][_ngcontent-%COMP%]   .actions-container[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]:not(.actions-dropdown){display:none}.crm-table[_ngcontent-%COMP%]   td[data-label=Azioni][_ngcontent-%COMP%]   .actions-dropdown[_ngcontent-%COMP%]   .dropdown-item[style*="display: none"][_ngcontent-%COMP%]{display:flex!important}.crm-table[_ngcontent-%COMP%]   td[data-label=Azioni][_ngcontent-%COMP%]   .actions-dropdown.open[_ngcontent-%COMP%]   .modal[_ngcontent-%COMP%]{position:fixed!important;inset:50% auto auto 50%!important;transform:translate(-50%,-50%)!important;width:min(90vw,300px)!important;max-height:70vh!important;overflow-y:auto!important;z-index:1001!important;border-radius:16px!important;box-shadow:0 20px 40px var(--shadow)!important}.crm-table[_ngcontent-%COMP%]   td[data-label=Azioni][_ngcontent-%COMP%]   .actions-dropdown[_ngcontent-%COMP%]   .action-btn[_ngcontent-%COMP%]{width:3rem!important;height:3rem!important;font-size:1.3rem!important}.crm-table[_ngcontent-%COMP%]   td[data-label=Azioni][_ngcontent-%COMP%]   .actions-container[_ngcontent-%COMP%]{justify-content:center!important;padding:var(--gutter-sm) 0}}@container (min-width: 769px){.actions-dropdown[_ngcontent-%COMP%]   .modal[_ngcontent-%COMP%]{min-width:180px}.actions-dropdown.left[_ngcontent-%COMP%]   .modal[_ngcontent-%COMP%]{right:auto;left:0}.actions-dropdown.top[_ngcontent-%COMP%]   .modal[_ngcontent-%COMP%]{top:auto;bottom:100%}}.table-container[_ngcontent-%COMP%]{overflow-x:auto;position:relative}body.dropdown-open[_ngcontent-%COMP%]{overflow:hidden}.mobile-dropdown-backdrop[_ngcontent-%COMP%]{position:fixed;inset:0;background:color-mix(in srgb,var(--text-color) 20%,transparent);-webkit-backdrop-filter:blur(2px);backdrop-filter:blur(2px);z-index:998;display:none}.actions-dropdown.open[_ngcontent-%COMP%] ~ .mobile-dropdown-backdrop[_ngcontent-%COMP%]{display:block}.esito-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.2rem}.esito-details[_ngcontent-%COMP%]{line-height:1.2;font-size:calc(var(--fs-sm) / 1.25)}.crm-table[_ngcontent-%COMP%]   td[data-label="Ultimo Esito"][_ngcontent-%COMP%]{min-width:120px}@media (max-width: 768px){.crm-table[_ngcontent-%COMP%]   td[data-label="Ultimo Esito"][_ngcontent-%COMP%]{min-width:auto}.esito-details[_ngcontent-%COMP%]{font-size:.7rem}}.table-inline-select[multiple][_ngcontent-%COMP%]{width:100%;min-width:160px;max-height:9rem;height:auto;padding:.35rem .5rem;border-radius:10px;border:1px solid var(--smoke-color-1);background:var(--background);color:var(--text-color);overflow-y:auto;box-sizing:border-box;line-height:1.25}.table-inline-select[multiple][_ngcontent-%COMP%]   option.prodotto-automatico[_ngcontent-%COMP%]{color:color-mix(in srgb,var(--text-color) 40%,transparent);font-style:italic;background:linear-gradient(90deg,rgba(0,0,0,.02),transparent)}.table-inline-select[multiple][_ngcontent-%COMP%]   option[_ngcontent-%COMP%]:checked{background:color-mix(in srgb,var(--primary) 12%,transparent);color:var(--text-color)}.selected-badges[_ngcontent-%COMP%]{display:flex;gap:.4rem;flex-wrap:wrap;margin-top:.5rem;align-items:center}.selected-badges[_ngcontent-%COMP%]   .product-badge[_ngcontent-%COMP%]{padding:.25rem .6rem;font-size:.85rem;border-radius:999px;display:inline-flex;align-items:center;gap:.4rem;border:1px solid var(--smoke-color-1);background:var(--smoke-color-2)}.selected-badges[_ngcontent-%COMP%]   .product-promethea[_ngcontent-%COMP%]{background:var(--primary);color:#fff;border-color:color-mix(in srgb,var(--primary) 60%,transparent)}.selected-badges[_ngcontent-%COMP%]   .product-yuvi[_ngcontent-%COMP%]{background:color-mix(in srgb,var(--secondary) 18%,transparent);color:var(--text-color);border-color:color-mix(in srgb,var(--secondary) 60%,transparent)}.selected-badges[_ngcontent-%COMP%]   .badge-remove[_ngcontent-%COMP%]{border:none;background:transparent;color:inherit;font-weight:700;cursor:pointer;padding:0 .15rem;line-height:1;border-radius:4px}.selected-badges[_ngcontent-%COMP%]   .badge-remove[_ngcontent-%COMP%]:hover{color:var(--secondary);transform:translateY(-1px)}td[_ngcontent-%COMP%]   .cell-content[_ngcontent-%COMP%]   .table-inline-select[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   .cell-content[_ngcontent-%COMP%]   .selected-badges[_ngcontent-%COMP%]{width:100%}@media (max-width: 768px){.table-inline-select[multiple][_ngcontent-%COMP%]{max-height:7rem}.selected-badges[_ngcontent-%COMP%]{gap:.25rem}}.product-picker[_ngcontent-%COMP%]{width:100%;margin-top:.5rem}.product-picker[_ngcontent-%COMP%]   .table-inline-select[_ngcontent-%COMP%]{width:100%;min-height:88px;max-height:10rem;overflow-y:auto}']})};export{ft as ListaProspect};
