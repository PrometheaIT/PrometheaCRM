import{a as ke}from"./chunk-IZICGKZ5.js";import{b as Ne,e as De,f as Ve,g as Oe}from"./chunk-HZQUGBKA.js";import{a as ze}from"./chunk-TKSIP4W4.js";import{a as Me}from"./chunk-AFMN6PFM.js";import{b as fe,c as A,d as ve,e as xe,f as he,g as Se,k as be,n as ye,o as Ce,p as Ee,q as Pe,u as we,v as Ie,w as Ae}from"./chunk-DK6BTRCD.js";import{b as Te}from"./chunk-3M63M74O.js";import{a as _e}from"./chunk-ERQHX2OH.js";import"./chunk-SJ4NRQ5G.js";import{d as pe,f as ge}from"./chunk-NWP7JNX6.js";import{b as ue}from"./chunk-7K4EWSAC.js";import{g as ae,j as re,k as le,n as se,o as ce,q as me,r as de}from"./chunk-XADZCZ3D.js";import{$b as ne,Fa as r,Ib as N,Kb as l,Lb as u,Mb as v,N as X,Nb as Q,Ob as ee,Pb as te,Qb as ie,Ra as K,Rb as oe,S as z,Ub as L,Wa as p,X as b,Y as y,Zb as S,_b as C,ea as w,fb as J,gc as O,lb as c,mb as s,nb as n,ob as f,sb as G,tb as Y,vb as M,yb as I,zb as m}from"./chunk-QBO2HR3F.js";import"./chunk-X5YLR3NI.js";import{a as q,b as Z,i as T}from"./chunk-ODN5LVDJ.js";var $=class i{fallbackProvinces=[{code:"AG",name:"Agrigento",region:"Sicilia"},{code:"AL",name:"Alessandria",region:"Piemonte"},{code:"AN",name:"Ancona",region:"Marche"},{code:"AO",name:"Aosta",region:"Valle d'Aosta"},{code:"AR",name:"Arezzo",region:"Toscana"},{code:"AP",name:"Ascoli Piceno",region:"Marche"},{code:"AT",name:"Asti",region:"Piemonte"},{code:"AV",name:"Avellino",region:"Campania"},{code:"BA",name:"Bari",region:"Puglia"},{code:"BG",name:"Bergamo",region:"Lombardia"},{code:"BI",name:"Biella",region:"Piemonte"},{code:"BL",name:"Belluno",region:"Veneto"},{code:"BN",name:"Benevento",region:"Campania"},{code:"BR",name:"Brindisi",region:"Puglia"},{code:"BS",name:"Brescia",region:"Lombardia"},{code:"BT",name:"Barletta-Andria-Trani",region:"Puglia"},{code:"CA",name:"Cagliari",region:"Sardegna"},{code:"CB",name:"Campobasso",region:"Molise"},{code:"CE",name:"Caserta",region:"Campania"},{code:"CH",name:"Chieti",region:"Abruzzo"},{code:"CI",name:"Carboni Iglesias",region:"Sardegna"},{code:"CL",name:"Caltanissetta",region:"Sicilia"},{code:"CN",name:"Cuneo",region:"Piemonte"},{code:"CO",name:"Como",region:"Lombardia"},{code:"CR",name:"Cremona",region:"Lombardia"},{code:"CS",name:"Cosenza",region:"Calabria"},{code:"CT",name:"Catania",region:"Sicilia"},{code:"CZ",name:"Catanzaro",region:"Calabria"},{code:"EN",name:"Enna",region:"Sicilia"},{code:"FC",name:"Forl\xEC Cesena",region:"Emilia Romagna"},{code:"FE",name:"Ferrara",region:"Emilia Romagna"},{code:"FG",name:"Foggia",region:"Puglia"},{code:"FI",name:"Firenze",region:"Toscana"},{code:"FM",name:"Fermo",region:"Marche"},{code:"FR",name:"Frosinone",region:"Lazio"},{code:"GE",name:"Genova",region:"Liguria"},{code:"GO",name:"Gorizia",region:"Friuli Venezia Giulia"},{code:"GR",name:"Grosseto",region:"Toscana"},{code:"IM",name:"Imperia",region:"Liguria"},{code:"IS",name:"Isernia",region:"Molise"},{code:"KR",name:"Crotone",region:"Calabria"},{code:"LC",name:"Lecco",region:"Lombardia"},{code:"LE",name:"Lecce",region:"Puglia"},{code:"LI",name:"Livorno",region:"Toscana"},{code:"LO",name:"Lodi",region:"Lombardia"},{code:"LT",name:"Latina",region:"Lazio"},{code:"LU",name:"Lucca",region:"Toscana"},{code:"MB",name:"Monza e della Brianza",region:"Lombardia"},{code:"MC",name:"Macerata",region:"Marche"},{code:"ME",name:"Messina",region:"Sicilia"},{code:"MI",name:"Milano",region:"Lombardia"},{code:"MN",name:"Mantova",region:"Lombardia"},{code:"MO",name:"Modena",region:"Emilia Romagna"},{code:"MS",name:"Massa Carrara",region:"Toscana"},{code:"MT",name:"Matera",region:"Basilicata"},{code:"NA",name:"Napoli",region:"Campania"},{code:"NO",name:"Novara",region:"Piemonte"},{code:"NU",name:"Nuoro",region:"Sardegna"},{code:"OG",name:"Ogliastra",region:"Sardegna"},{code:"OR",name:"Oristano",region:"Sardegna"},{code:"OT",name:"Olbia Tempio",region:"Sardegna"},{code:"PA",name:"Palermo",region:"Sicilia"},{code:"PC",name:"Piacenza",region:"Emilia Romagna"},{code:"PD",name:"Padova",region:"Veneto"},{code:"PE",name:"Pescara",region:"Abruzzo"},{code:"PG",name:"Perugia",region:"Umbria"},{code:"PI",name:"Pisa",region:"Toscana"},{code:"PN",name:"Pordenone",region:"Friuli Venezia Giulia"},{code:"PO",name:"Prato",region:"Toscana"},{code:"PR",name:"Parma",region:"Emilia Romagna"},{code:"PT",name:"Pistoia",region:"Toscana"},{code:"PV",name:"Pavia",region:"Lombardia"},{code:"PZ",name:"Potenza",region:"Basilicata"},{code:"RA",name:"Ravenna",region:"Emilia Romagna"},{code:"RC",name:"Reggio Calabria",region:"Calabria"},{code:"RE",name:"Reggio Emilia",region:"Emilia Romagna"},{code:"RG",name:"Ragusa",region:"Sicilia"},{code:"RI",name:"Rieti",region:"Lazio"},{code:"RM",name:"Roma",region:"Lazio"},{code:"RN",name:"Rimini",region:"Emilia Romagna"},{code:"RO",name:"Rovigo",region:"Veneto"},{code:"SA",name:"Salerno",region:"Campania"},{code:"SI",name:"Siena",region:"Toscana"},{code:"SO",name:"Sondrio",region:"Lombardia"},{code:"SP",name:"La Spezia",region:"Liguria"},{code:"SR",name:"Siracusa",region:"Sicilia"},{code:"SS",name:"Sassari",region:"Sardegna"},{code:"SU",name:"Medio Campidano",region:"Sardegna"},{code:"SV",name:"Savona",region:"Liguria"},{code:"TA",name:"Taranto",region:"Puglia"},{code:"TE",name:"Teramo",region:"Abruzzo"},{code:"TN",name:"Trento",region:"Trentino-Alto Adige"},{code:"TO",name:"Torino",region:"Piemonte"},{code:"TP",name:"Trapani",region:"Sicilia"},{code:"TR",name:"Terni",region:"Umbria"},{code:"TS",name:"Trieste",region:"Friuli Venezia Giulia"},{code:"TV",name:"Treviso",region:"Veneto"},{code:"UD",name:"Udine",region:"Friuli Venezia Giulia"},{code:"VA",name:"Varese",region:"Lombardia"},{code:"VB",name:"Verbano-Cusio-Ossola",region:"Piemonte"},{code:"VC",name:"Vercelli",region:"Piemonte"},{code:"VE",name:"Venezia",region:"Veneto"},{code:"VI",name:"Vicenza",region:"Veneto"},{code:"VT",name:"Viterbo",region:"Lazio"}];getProvinces(){return[...this.fallbackProvinces].sort((t,e)=>t.name.localeCompare(e.name))}searchProvinces(t){if(!t||t.length<1)return this.getProvinces();let e=t.toLowerCase();return this.fallbackProvinces.filter(a=>a.name.toLowerCase().includes(e)||a.code.toLowerCase().includes(e)||a.region.toLowerCase().includes(e)).sort((a,o)=>a.name.localeCompare(o.name))}getProvinceByCode(t){return this.fallbackProvinces.find(e=>e.code.toUpperCase()===t.toUpperCase())||null}getRegions(){return[...new Set(this.fallbackProvinces.map(e=>e.region))].sort()}getProvincesByRegion(t){return this.fallbackProvinces.filter(e=>e.region===t).sort((e,a)=>e.name.localeCompare(a.name))}static \u0275fac=function(e){return new(e||i)};static \u0275prov=X({token:i,factory:i.\u0275fac,providedIn:"root"})};var U=()=>[],Le=()=>({standalone:!0});function Re(i,t){if(i&1&&f(0,"app-page-loader",12),i&2){let e=m();c("isLoading",e.loading())}}function Ge(i,t){if(i&1&&(s(0,"p",13),l(1),n()),i&2){let e=m();r(),v(" ",e.sottotitolo()," ")}}function Ye(i,t){if(i&1){let e=M();G(0),s(1,"button",14),I("click",function(){b(e);let o=m();return y(o.navigateBack())}),s(2,"span",15),l(3,"arrow_back"),n(),l(4," Indietro "),n(),Y()}}function $e(i,t){if(i&1){let e=M();G(0),s(1,"button",14),I("click",function(){b(e);let o=m();return y(o.cancel())}),s(2,"span",15),l(3,"close"),n(),l(4," Annulla "),n(),Y()}}function Ue(i,t){i&1&&(s(0,"span",15),l(1,"save"),n())}function We(i,t){i&1&&f(0,"span",53)}function je(i,t){if(i&1&&(s(0,"span",54),l(1),n()),i&2){let e=m(2);r(),v(" Prodotto: ",e.prodottoDisplay()," ")}}function qe(i,t){i&1&&(s(0,"span",54),l(1," Configurazione salvata "),n())}function He(i,t){if(i&1&&(s(0,"span",54),l(1),n()),i&2){let e=m(2);r(),v(" Trattative Yuvi: ",(e.trattativeYuvi()??L(1,U)).length," ")}}function Ze(i,t){i&1&&f(0,"input",55)}function Xe(i,t){if(i&1&&(s(0,"span",26),l(1),n()),i&2){let e,a=m(2);r(),u(((e=a.soggettoData())==null?null:e.ragione_sociale)||"\u2014")}}function Ke(i,t){i&1&&(s(0,"small",56),l(1,"Campo obbligatorio"),n())}function Je(i,t){i&1&&(s(0,"small",56),l(1,"Minimo 2 caratteri"),n())}function Qe(i,t){i&1&&f(0,"input",57)}function et(i,t){if(i&1&&(s(0,"span",26),l(1),n()),i&2){let e,a=m(2);r(),u(((e=a.soggettoData())==null?null:e.piva)||"\u2014")}}function tt(i,t){i&1&&(s(0,"small",56),l(1,"Formato non valido (max 11 cifre)"),n())}function it(i,t){if(i&1&&(s(0,"option",61),l(1),n()),i&2){let e=t.$implicit;c("value",e),r(),u(e)}}function ot(i,t){if(i&1&&(s(0,"select",58)(1,"option",59),l(2,"\u2014 Seleziona \u2014"),n(),p(3,it,2,2,"option",60),n()),i&2){let e=m(2);r(3),c("ngForOf",e.formuleSocietarie)}}function nt(i,t){if(i&1&&(s(0,"span",26),l(1),n()),i&2){let e,a=m(2);r(),u(((e=a.soggettoData())==null?null:e.formula_societaria)||"\u2014")}}function at(i,t){i&1&&(s(0,"small",56),l(1,"Campo obbligatorio"),n())}function rt(i,t){if(i&1&&(s(0,"option",61),l(1),n()),i&2){let e=t.$implicit;c("value",e),r(),u(e)}}function lt(i,t){if(i&1&&(s(0,"select",62)(1,"option",59),l(2,"\u2014 Seleziona \u2014"),n(),p(3,rt,2,2,"option",60),n()),i&2){let e=m(2);r(3),c("ngForOf",e.categorieAtecoMacro)}}function st(i,t){if(i&1&&(s(0,"span",26),l(1),n()),i&2){let e,a=m(2);r(),u(((e=a.soggettoData())==null?null:e.categoria_ateco)||"\u2014")}}function ct(i,t){if(i&1){let e=M();s(0,"div",68),I("click",function(){let o=b(e).$implicit,d=m(4);return y(d.onProvinciaSelect(o))}),s(1,"div",69)(2,"strong"),l(3),n(),s(4,"span",70),l(5),n()(),s(6,"small",71),l(7),n()()}if(i&2){let e=t.$implicit;r(3),u(e.name),r(2),v("(",e.code,")"),r(2),u(e.region)}}function mt(i,t){if(i&1&&(s(0,"div",66),p(1,ct,8,3,"div",67),n()),i&2){let e=m(3);r(),c("ngForOf",e.filteredProvinces.slice(0,8))}}function dt(i,t){if(i&1){let e=M();s(0,"div",63)(1,"input",64),ie("ngModelChange",function(o){b(e);let d=m(2);return te(d.provinciaSearch,o)||(d.provinciaSearch=o),y(o)}),I("input",function(o){b(e);let d=m(2);return y(d.onProvinciaSearchChange(o.target.value))})("focus",function(){b(e);let o=m(2);return y(o.onProvinciaFocus())})("blur",function(){b(e);let o=m(2);return y(o.onProvinciaBlur())}),n(),p(2,mt,2,1,"div",65),n()}if(i&2){let e=m(2);r(),ee("ngModel",e.provinciaSearch),c("ngModelOptions",L(3,Le)),r(),c("ngIf",e.showProvinceDropdown&&e.filteredProvinces.length>0)}}function pt(i,t){if(i&1&&(s(0,"span",26),l(1),n()),i&2){let e,a=m(2);r(),u(a.getProvinciaName(((e=a.soggettoData())==null?null:e.provincia)||"")||"\u2014")}}function gt(i,t){i&1&&f(0,"input",72)}function ut(i,t){if(i&1&&(s(0,"span",26),l(1),n()),i&2){let e,a=m(2);r(),u(((e=a.soggettoData())==null?null:e.comune)||"\u2014")}}function _t(i,t){i&1&&f(0,"input",73)}function ft(i,t){if(i&1&&(s(0,"span",26),l(1),n()),i&2){let e,a=m(2);r(),u(((e=a.soggettoData())==null?null:e.indirizzo)||"\u2014")}}function vt(i,t){i&1&&f(0,"input",74)}function xt(i,t){if(i&1&&(s(0,"span",26),l(1),n()),i&2){let e,a=m(2);r(),u(((e=a.soggettoData())==null?null:e.numero_civico)||"\u2014")}}function ht(i,t){if(i&1&&(s(0,"div",29)(1,"span",30)(2,"span",15),l(3,"location_on"),n(),l(4," Coordinate "),n(),s(5,"span",26),l(6),S(7,"number"),S(8,"number"),n()()),i&2){let e,a=m(2);r(6),v(" ",(e=a.soggettoData())!=null&&e.latitude&&((e=a.soggettoData())!=null&&e.longitude)?C(7,1,(e=a.soggettoData())==null?null:e.latitude,"1.4-4")+", "+C(8,4,(e=a.soggettoData())==null?null:e.longitude,"1.4-4"):"\u2014"," ")}}function St(i,t){i&1&&f(0,"input",75)}function bt(i,t){if(i&1&&(s(0,"span",26),l(1),n()),i&2){let e,a=m(2);r(),u(((e=a.soggettoData())==null?null:e.referente)||"\u2014")}}function yt(i,t){i&1&&f(0,"input",76)}function Ct(i,t){if(i&1&&(s(0,"span",26),l(1),n()),i&2){let e,a=m(2);r(),u(((e=a.soggettoData())==null?null:e.telefono)||"\u2014")}}function Et(i,t){i&1&&(s(0,"small",56),l(1,"Numero non valido"),n())}function Pt(i,t){i&1&&f(0,"input",77)}function wt(i,t){if(i&1&&(s(0,"span",26),l(1),n()),i&2){let e,a=m(2);r(),u(((e=a.soggettoData())==null?null:e.email)||"\u2014")}}function It(i,t){i&1&&(s(0,"small",56),l(1,"Email non valida"),n())}function At(i,t){i&1&&f(0,"input",78)}function Tt(i,t){if(i&1&&(s(0,"span",26),l(1),n()),i&2){let e,a=m(2);r(),u(((e=a.soggettoData())==null?null:e.sito_web)||"\u2014")}}function zt(i,t){i&1&&(s(0,"small",56),l(1,"URL non valido"),n())}function Mt(i,t){i&1&&f(0,"input",79)}function Nt(i,t){if(i&1&&(s(0,"span",26),l(1),n()),i&2){let e,a=m(2);r(),u(((e=a.soggettoData())==null?null:e.facebook)||"\u2014")}}function Dt(i,t){i&1&&f(0,"input",80)}function Vt(i,t){if(i&1&&(s(0,"span",26),l(1),n()),i&2){let e,a=m(2);r(),u(((e=a.soggettoData())==null?null:e.instagram)||"\u2014")}}function Ot(i,t){if(i&1&&(s(0,"option",61),l(1),n()),i&2){let e=t.$implicit;c("value",e),r(),u(e)}}function kt(i,t){if(i&1&&(s(0,"select",81)(1,"option",59),l(2,"\u2014 Non specificato \u2014"),n(),p(3,Ot,2,2,"option",60),n()),i&2){let e=m(2);r(3),c("ngForOf",e.metodiPagamento)}}function Ft(i,t){if(i&1&&(s(0,"span",26),l(1),n()),i&2){let e,a=m(2);r(),u(((e=a.soggettoData())==null?null:e.metodo_pagamento)||"\u2014")}}function Bt(i,t){i&1&&f(0,"input",82)}function Lt(i,t){if(i&1&&(s(0,"span",26),l(1),n()),i&2){let e,a=m(2);r(),u(((e=a.soggettoData())==null?null:e.iban)||"\u2014")}}function Rt(i,t){i&1&&(s(0,"small",56),l(1,"IBAN non valido"),n())}function Gt(i,t){i&1&&f(0,"textarea",83)}function Yt(i,t){if(i&1&&(s(0,"span",26),l(1),n()),i&2){let e,a=m(2);r(),u(((e=a.soggettoData())==null?null:e.note)||"\u2014")}}function $t(i,t){if(i&1){let e=M();s(0,"div",89)(1,"input",90),I("change",function(o){let d=b(e).$implicit,_=m(4);return y(_.toggleProduct(d,o.target.checked))}),n(),s(2,"label",91),l(3),n()()}if(i&2){let e=t.$implicit,a=t.index,o=m(4);r(),c("id","prod-"+a)("checked",o.isProductSelected(e)),J("aria-label","Seleziona prodotto "+e),r(),c("title",oe(e))("for","prod-"+a),r(),v(" ",e," ")}}function Ut(i,t){if(i&1&&(s(0,"div",85),p(1,$t,4,7,"div",86),s(2,"div",87)(3,"small",88),l(4,"Promethea e YUVI vengono aggiunti automaticamente quando presenti."),n()()()),i&2){let e=m(3);r(),c("ngForOf",e.prodottiFiltered())}}function Wt(i,t){if(i&1&&(s(0,"span",26),l(1),n()),i&2){let e=m(3);r(),v(" ",e.prodottoDisplay()||"\u2014"," ")}}function jt(i,t){if(i&1&&(s(0,"fieldset",27)(1,"legend",5)(2,"span",15),l(3,"widgets"),n(),l(4," Prodotto "),n(),s(5,"div",28)(6,"label",34)(7,"span",30)(8,"span",15),l(9,"apps"),n(),l(10," Prodotto assegnato"),n(),p(11,Ut,5,1,"div",84)(12,Wt,2,1,"span",32),n()()()),i&2){let e=m(2);r(11),c("ngIf",e.mode()!=="view"),r(),c("ngIf",e.mode()==="view")}}function qt(i,t){if(i&1&&(s(0,"span",95),l(1),S(2,"date"),n()),i&2){let e,a=m(3);r(),v(" Creato il ",C(2,1,(e=a.soggettoData())==null?null:e.created_at,"dd/MM/yyyy HH:mm")," ")}}function Ht(i,t){if(i&1&&(s(0,"span",95),l(1),S(2,"date"),n()),i&2){let e,a=m(3);r(),v(" Aggiornato il ",C(2,1,(e=a.soggettoData())==null?null:e.updated_at,"dd/MM/yyyy HH:mm")," ")}}function Zt(i,t){if(i&1&&(s(0,"span",104)(1,"small"),l(2),S(3,"number"),n()()),i&2){let e,a=m(4);r(2),v("(da ",C(3,1,(e=a.configurazionePromethea())==null?null:e.totale_mensile,"1.0-2")," \u20AC)")}}function Xt(i,t){if(i&1&&(s(0,"span",104)(1,"small"),l(2),S(3,"number"),n()()),i&2){let e,a=m(4);r(2),v("(da ",C(3,1,(e=a.configurazionePromethea())==null?null:e.totale_una_tantum,"1.0-2")," \u20AC)")}}function Kt(i,t){if(i&1&&(s(0,"span"),l(1),S(2,"number"),n()),i&2){let e,a=m(4);r(),Q(" \u2014 sconto ",C(2,2,(e=a.configurazionePromethea())==null?null:e._sconto_percentuale,"1.2-2"),"% (",(e=a.configurazionePromethea())==null?null:e._sconto_target,")")}}function Jt(i,t){if(i&1){let e=M();s(0,"button",105),I("click",function(){b(e);let o=m(4);return y(o.apriConfigurazione())}),s(1,"span",15),l(2,"description"),n(),l(3," Vai al Preventivo "),n()}}function Qt(i,t){if(i&1&&(s(0,"fieldset",96)(1,"legend",5),f(2,"img",97),l(3," Configurazione Promethea "),n(),s(4,"div",98)(5,"div",99)(6,"h3",100),l(7),n(),s(8,"p",101),l(9," Totale mensile: "),s(10,"strong"),l(11),S(12,"number"),n(),p(13,Zt,4,4,"span",102),f(14,"br"),l(15," Totale una tantum: "),s(16,"strong"),l(17),S(18,"number"),n(),p(19,Xt,4,4,"span",102),f(20,"br"),s(21,"small",88),l(22," Totale complessivo scontato: "),s(23,"strong"),l(24),S(25,"number"),n(),p(26,Kt,3,5,"span",9),n()(),p(27,Jt,4,0,"button",103),n()()()),i&2){let e,a,o,d,_,g,E,h=m(3);r(7),v("N. Preventivo: ",((e=h.configurazionePromethea())==null?null:e.numero_preventivo_formattato)??((e=h.configurazionePromethea())!=null&&e.numero_preventivo?"Preventivo #"+((e=h.configurazionePromethea())==null?null:e.numero_preventivo):"Riepilogo")," "),r(4),v(" ",C(12,8,((a=h.configurazionePromethea())==null?null:a.totale_mensile_scontato)??((a=h.configurazionePromethea())==null?null:a.totale_mensile),"1.0-2")," \u20AC "),r(2),c("ngIf",(o=h.configurazionePromethea())==null?null:o._sconto_percentuale),r(4),v(" ",C(18,11,((d=h.configurazionePromethea())==null?null:d.totale_una_tantum_scontato)??((d=h.configurazionePromethea())==null?null:d.totale_una_tantum),"1.0-2")," \u20AC "),r(2),c("ngIf",(_=h.configurazionePromethea())==null?null:_._sconto_percentuale),r(5),v("",C(25,14,((g=h.configurazionePromethea())==null?null:g.totale_scontato)??((g=h.configurazionePromethea())==null?null:g.totale),"1.0-2")," \u20AC"),r(2),c("ngIf",(E=h.configurazionePromethea())==null?null:E._sconto_percentuale),r(),c("ngIf",h.configurazionePromethea())}}function ei(i,t){if(i&1&&(s(0,"p",88),l(1," Importo: "),s(2,"strong"),l(3),S(4,"number"),n()()),i&2){let e=m().$implicit;r(3),v("",C(4,1,e.importo??e.amount,"1.0-0")," \u20AC")}}function ti(i,t){if(i&1&&(s(0,"p",88),l(1),S(2,"date"),n()),i&2){let e=m().$implicit;r(),v(" Data: ",C(2,1,e.data??e.created_at,"dd/MM/yyyy")," ")}}function ii(i,t){if(i&1){let e=M();s(0,"div",109)(1,"div",110)(2,"h3",100),l(3),S(4,"slice"),n(),s(5,"span",95),l(6),n()(),p(7,ei,5,4,"p",111)(8,ti,3,4,"p",111),s(9,"div",112)(10,"button",113),I("click",function(){let o=b(e).$implicit,d=m(4);return y(d.vaiTrattativaYuviById(o.id))}),s(11,"span",15),l(12,"open_in_new"),n(),l(13," Apri trattativa "),n()()()}if(i&2){let e=t.$implicit;r(3),u(e.nome||"Trattativa "+ne(4,4,e.id,0,8)),r(3),u(e.stato||e.status||"\u2014"),r(),c("ngIf",e.importo||e.amount),r(),c("ngIf",e.data||e.created_at)}}function oi(i,t){if(i&1&&(s(0,"fieldset",96)(1,"legend",5),f(2,"img",106),l(3," Trattative Yuvi "),n(),s(4,"div",107),p(5,ii,14,8,"div",108),n()()),i&2){let e=m(3);r(5),c("ngForOf",e.trattativeYuvi()??L(1,U))}}function ni(i,t){if(i&1&&(s(0,"p",118),l(1),n()),i&2){let e=m().$implicit;r(),u(e.note)}}function ai(i,t){if(i&1&&(s(0,"div",116)(1,"div",110)(2,"h3",100),l(3),n(),s(4,"span",95),l(5),S(6,"date"),n()(),p(7,ni,2,1,"p",117),n()),i&2){let e=t.$implicit;r(3),u(e.tipo),r(2),u(C(6,3,e.ts,"dd/MM/yyyy HH:mm")),r(2),c("ngIf",e.note)}}function ri(i,t){if(i&1&&(s(0,"fieldset",96)(1,"legend",5)(2,"span",15),l(3,"history"),n(),l(4," Cronologia esiti "),n(),s(5,"div",114),p(6,ai,8,6,"div",115),n()()),i&2){let e=m(3);r(6),c("ngForOf",e.esitiOrdinati())}}function li(i,t){if(i&1&&(G(0),s(1,"div",92),p(2,qt,3,4,"span",93)(3,Ht,3,4,"span",93),n(),p(4,Qt,28,17,"fieldset",94)(5,oi,6,2,"fieldset",94)(6,ri,7,1,"fieldset",94),Y()),i&2){let e,a,o=m(2);r(2),c("ngIf",(e=o.soggettoData())==null?null:e.created_at),r(),c("ngIf",(a=o.soggettoData())==null?null:a.updated_at),r(),c("ngIf",o.configurazionePromethea()),r(),c("ngIf",(o.trattativeYuvi()??L(5,U)).length),r(),c("ngIf",o.esitiOrdinati().length)}}function si(i,t){if(i&1){let e=M();s(0,"form",16),I("submit",function(){b(e);let o=m();return y(o.submit())}),s(1,"div",17)(2,"button",18),I("click",function(){b(e);let o=m();return y(o.switchToEdit())}),s(3,"span",15),l(4,"edit"),n(),l(5," Modifica "),n(),s(6,"button",19),I("click",function(){b(e);let o=m();return y(o.apriEsito())}),s(7,"span",15),l(8,"note_add"),n(),l(9," Aggiungi esito "),n(),s(10,"button",20),p(11,Ue,2,0,"span",21)(12,We,1,0,"span",22),l(13),n()(),s(14,"fieldset",23),p(15,je,2,1,"span",24)(16,qe,2,0,"span",24)(17,He,2,2,"span",24),s(18,"span",25),l(19," Creato da: "),s(20,"span",26),l(21),n()()(),s(22,"fieldset",27)(23,"legend",5)(24,"span",15),l(25,"apartment"),n(),l(26," Dati aziendali "),n(),s(27,"div",28)(28,"label",29)(29,"span",30)(30,"span",15),l(31,"business"),n(),l(32," Ragione sociale"),n(),p(33,Ze,1,0,"input",31)(34,Xe,2,1,"span",32)(35,Ke,2,0,"small",33)(36,Je,2,0,"small",33),n(),s(37,"label",34)(38,"span",30)(39,"span",15),l(40,"numbers"),n(),l(41," P.IVA"),n(),p(42,Qe,1,0,"input",35)(43,et,2,1,"span",32)(44,tt,2,0,"small",33),n(),s(45,"label",34)(46,"span",30)(47,"span",15),l(48,"domain"),n(),l(49," Formula societaria"),n(),p(50,ot,4,1,"select",36)(51,nt,2,1,"span",32)(52,at,2,0,"small",33),n(),s(53,"label",34)(54,"span",30)(55,"span",15),l(56,"category"),n(),l(57," Categoria merceologica (ATECO macro)"),n(),p(58,lt,4,1,"select",37)(59,st,2,1,"span",32),n()()(),s(60,"fieldset",27)(61,"legend",5)(62,"span",15),l(63,"place"),n(),l(64," Indirizzo "),n(),s(65,"div",28)(66,"label",34)(67,"span",30)(68,"span",15),l(69,"map"),n(),l(70," Provincia "),n(),p(71,dt,3,4,"div",38)(72,pt,2,1,"span",32),n(),s(73,"label",34)(74,"span",30)(75,"span",15),l(76,"location_city"),n(),l(77," Comune "),n(),p(78,gt,1,0,"input",39)(79,ut,2,1,"span",32),n(),s(80,"label",29)(81,"span",30)(82,"span",15),l(83,"signpost"),n(),l(84," Indirizzo "),n(),p(85,_t,1,0,"input",40)(86,ft,2,1,"span",32),n(),s(87,"label",34)(88,"span",30)(89,"span",15),l(90,"home"),n(),l(91," Numero Civico "),n(),p(92,vt,1,0,"input",41)(93,xt,2,1,"span",32),n(),p(94,ht,9,7,"div",42),n()(),s(95,"fieldset",27)(96,"legend",5)(97,"span",15),l(98,"contacts"),n(),l(99," Referente e contatti "),n(),s(100,"div",28)(101,"label",34)(102,"span",30)(103,"span",15),l(104,"badge"),n(),l(105," Referente"),n(),p(106,St,1,0,"input",43)(107,bt,2,1,"span",32),n(),s(108,"label",34)(109,"span",30)(110,"span",15),l(111,"call"),n(),l(112," Telefono"),n(),p(113,yt,1,0,"input",44)(114,Ct,2,1,"span",32)(115,Et,2,0,"small",33),n(),s(116,"label",34)(117,"span",30)(118,"span",15),l(119,"mail"),n(),l(120," Email"),n(),p(121,Pt,1,0,"input",45)(122,wt,2,1,"span",32)(123,It,2,0,"small",33),n()()(),s(124,"fieldset",27)(125,"legend",5)(126,"span",15),l(127,"public"),n(),l(128," Web e social "),n(),s(129,"div",28)(130,"label",34)(131,"span",30)(132,"span",15),l(133,"language"),n(),l(134," Sito web"),n(),p(135,At,1,0,"input",46)(136,Tt,2,1,"span",32)(137,zt,2,0,"small",33),n(),s(138,"label",34)(139,"span",30)(140,"span",15),l(141,"facebook"),n(),l(142," Facebook"),n(),p(143,Mt,1,0,"input",47)(144,Nt,2,1,"span",32),n(),s(145,"label",34)(146,"span",30)(147,"span",15),l(148,"camera_alt"),n(),l(149," Instagram"),n(),p(150,Dt,1,0,"input",48)(151,Vt,2,1,"span",32),n()()(),s(152,"fieldset",27)(153,"legend",5)(154,"span",15),l(155,"payments"),n(),l(156," Pagamenti "),n(),s(157,"div",28)(158,"label",34)(159,"span",30)(160,"span",15),l(161,"account_balance_wallet"),n(),l(162," Metodo di pagamento"),n(),p(163,kt,4,1,"select",49)(164,Ft,2,1,"span",32),n(),s(165,"label",29)(166,"span",30)(167,"span",15),l(168,"credit_card"),n(),l(169," IBAN"),n(),p(170,Bt,1,0,"input",50)(171,Lt,2,1,"span",32)(172,Rt,2,0,"small",33),n()()(),s(173,"fieldset",27)(174,"legend",5)(175,"span",15),l(176,"notes"),n(),l(177," Note "),n(),s(178,"div",28)(179,"label",29),p(180,Gt,1,0,"textarea",51)(181,Yt,2,1,"span",32),n()()(),p(182,jt,13,2,"fieldset",52)(183,li,7,6,"ng-container",9),n()}if(i&2){let e,a,o=m();N("view-mode",o.mode()==="view"),c("formGroup",o.form),r(6),c("disabled",!((e=o.soggettoData())!=null&&e.id)),r(4),c("disabled",o.form.invalid||o.isSubmitting()),r(),c("ngIf",!o.isSubmitting()),r(),c("ngIf",o.isSubmitting()),r(),v(" ",o.isSubmitting()?"Salvataggio...":o.mode()==="create"?"Crea":"Aggiorna"," "),r(),N("disabled",o.mode()==="view"),r(),c("ngIf",o.prodottoDisplay()),r(),c("ngIf",o.configurazionePromethea()),r(),c("ngIf",(o.trattativeYuvi()??L(71,U)).length),r(4),u(o.creatorName()||((a=o.soggettoData())==null?null:a.created_by)||"\u2014"),r(),N("disabled",o.mode()==="view"),r(11),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(),c("ngIf",o.mode()!=="view"&&o.hasError("ragioneSociale","required")),r(),c("ngIf",o.mode()!=="view"&&o.hasError("ragioneSociale","minlength")),r(6),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(),c("ngIf",o.mode()!=="view"&&o.hasError("piva","pattern")),r(6),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(),c("ngIf",o.mode()!=="view"&&o.hasError("formulaSocietaria","required")),r(6),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(),N("disabled",o.mode()==="view"),r(11),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(6),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(6),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(6),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(),c("ngIf",o.mode()==="view"),r(),N("disabled",o.mode()==="view"),r(11),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(6),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(),c("ngIf",o.mode()!=="view"&&o.hasError("telefono","pattern")),r(6),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(),c("ngIf",o.mode()!=="view"&&o.hasError("email","email")),r(),N("disabled",o.mode()==="view"),r(11),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(),c("ngIf",o.mode()!=="view"&&o.hasError("sitoWeb","pattern")),r(6),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(6),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(),N("disabled",o.mode()==="view"),r(11),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(6),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(),c("ngIf",o.mode()!=="view"&&o.hasError("iban","pattern")),r(),N("disabled",o.mode()==="view"),r(7),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view")}}var Fe=class i{fb=z(we);route=z(pe);router=z(ge);location=z(ae);soggettiService=z(Te);alchemizzatoreService=z(Me);geoService=z($);userService=z(_e);supa=z(ue);creatorName=w(null);mode=w("create");loading=w(!1);isSubmitting=w(!1);esitoPopupOpen=w(!1);selectedProducts=w([]);prodottiDynamic=[];tipo=w("prospect");id=w(null);soggettoData=w(null);configurazionePromethea=w(null);trattativeYuvi=w(null);form;provinces=[];filteredProvinces=[];showProvinceDropdown=!1;selectedProvince="";provinciaSearch="";prodotti=Ne;formuleSocietarie=De;categorieAtecoMacro=Ve;metodiPagamento=Oe;submitCooldown=!1;titolo=O(()=>{let t=e=>e==="cliente"?"Cliente":e==="fornitore"?"Fornitore":"Prospect";switch(this.mode()){case"create":return`Nuovo ${t(this.tipo())}`;case"edit":return`Modifica ${t(this.tipo())}`;case"view":return this.soggettoData()?.ragione_sociale||"Scheda soggetto"}});sottotitolo=O(()=>{let t=this.tipo();return t==="cliente"?"Cliente":t==="fornitore"?"Fornitore":"Prospect"});icona=O(()=>{let t=this.tipo();return t==="cliente"?"person":t==="fornitore"?"local_shipping":"person_search"});prodottoDisplay=O(()=>{let e=((this.soggettoData()?.prodotto??"")?.toString()??"").split(",").map(o=>o.trim()).filter(Boolean),a=new Set(e.map(o=>o.toLowerCase()));return this.configurazionePromethea()&&(a.has("promethea")||(e.unshift("Promethea"),a.add("promethea"))),(this.trattativeYuvi()??[]).length&&(a.has("yuvi")||(e.push("YUVI"),a.add("yuvi"))),e.length?e.join(", "):null});isCliente=O(()=>this.tipo()==="cliente");esitiOrdinati=O(()=>[...Array.isArray(this.soggettoData()?.esiti)?this.soggettoData()?.esiti:[]].sort((e,a)=>new Date(a.ts).getTime()-new Date(e.ts).getTime()));ngOnInit(){return T(this,null,function*(){this.provinces=this.geoService.getProvinces(),this.filteredProvinces=this.provinces,yield this.loadProdotti(),yield this.determineModeAndParams(),this.initializeForm(),this.mode()!=="create"&&this.id()&&(yield this.loadSoggetto(this.id()),this.mode()==="view"&&(yield this.loadConfigurazionePromethea(this.id()),yield this.loadTrattativeYuvi(this.id()))),this.route.paramMap.subscribe(t=>T(this,null,function*(){yield this.determineModeAndParams()}))})}determineModeAndParams(){return T(this,null,function*(){let t=this.route.snapshot.paramMap.get("id"),e=(this.route.snapshot.paramMap.get("tipo")||"").toLowerCase(),a=this.router.url;["cliente","fornitore","prospect"].includes(e)&&this.tipo.set(e),t?(this.id.set(t),a.includes("/edit")?this.mode.set("edit"):this.mode.set("view")):this.mode.set("create")})}initializeForm(){this.form=this.fb.group({ragioneSociale:["",[A.required,A.minLength(2)]],piva:["",[A.pattern(/^\d{0,11}$/)]],formulaSocietaria:[""],categoriaAteco:[""],referente:[""],telefono:["",[A.pattern(/^[+]?[\d\s\-()]{0,}$/)]],email:["",[A.email]],sitoWeb:["",[A.pattern(/^(https?:\/\/)?([\w\-]+\.)+[\w\-]{2,}(\/.*)?$|^$/i)]],facebook:[""],instagram:[""],iban:["",[A.pattern(/^[A-Z]{2}\d{2}[A-Z0-9]{0,30}$|^$/i)]],metodoPagamento:[""],note:[""],prodotto:["Promethea"],provincia:[""],comune:[""],indirizzo:[""],numeroCivico:[""]}),this.updateConditionalValidators(),this.form.get("metodoPagamento").valueChanges.subscribe(t=>{let e=this.form.get("iban");t==="Bonifico"||t==="SEPA Direct Debit"?e.enable({emitEvent:!1}):(e.disable({emitEvent:!1}),e.reset("",{emitEvent:!1}))})}loadSoggetto(t){return T(this,null,function*(){this.loading.set(!0);let{data:e,error:a}=yield this.soggettiService.getSoggettoById(t);if(a||!e){alert("Impossibile caricare il soggetto selezionato"),this.loading.set(!1);return}if(this.tipo.set(e.tipo),this.soggettoData.set(e),this.creatorName.set(null),console.log("[AddSoggetto] loadSoggetto id=",t,"created_by=",e.created_by),e.created_by)try{let o=yield this.userService.getUserById(e.created_by);if(console.log("[AddSoggetto] getUserById result=",o),o&&o.data&&!o.error){let d=[o.data.first_name,o.data.last_name].filter(Boolean).join(" ").trim();this.creatorName.set(d||o.data.email||e.created_by),this.soggettoData.set(Z(q({},e),{created_by_user:{id:o.data.id,first_name:o.data.first_name??null,last_name:o.data.last_name??null}}))}else console.warn("[AddSoggetto] user not found or error:",o?.error),this.creatorName.set(e.created_by)}catch(o){console.warn("Errore recupero creatore:",o),this.creatorName.set(e.created_by)}if(e.provincia){this.selectedProvince=e.provincia;let o=this.geoService.getProvinceByCode(e.provincia);o&&(this.provinciaSearch=`${o.name} (${o.code})`)}if(this.mode()==="edit"){let d=String(e.prodotto||"").split(",").map(_=>_.trim()).filter(Boolean).filter(_=>{let g=String(_).toLowerCase();return g!=="promethea"&&g!=="yuvi"});this.selectedProducts.set(d),this.form.patchValue({ragioneSociale:e.ragione_sociale,piva:e.piva,formulaSocietaria:e.formula_societaria,categoriaAteco:e.categoria_ateco,prodotto:d.join(","),referente:e.referente,telefono:e.telefono,email:e.email,sitoWeb:e.sito_web,facebook:e.facebook,instagram:e.instagram,metodoPagamento:e.metodo_pagamento,iban:e.iban,note:e.note,provincia:e.provincia,comune:e.comune,indirizzo:e.indirizzo,numeroCivico:e.numero_civico}),this.updateConditionalValidators()}this.loading.set(!1)})}loadConfigurazionePromethea(t){return T(this,null,function*(){try{let e=yield this.alchemizzatoreService.getConfigurazioniByProspect(t);if(console.log("[loadConfigurazionePromethea] raw result:",e),!e||e.error){console.warn("[loadConfigurazionePromethea] no config or error:",e?.error),this.configurazionePromethea.set(null);return}let a=(e.data??[]).at(0)??null;if(!a){this.configurazionePromethea.set(null);return}let o=a,d=[],_=o.dettagli??o.items??o.lines??o.struttura??o;Array.isArray(_)?d=_.slice():_&&typeof _=="object"?Object.values(_).forEach(x=>{if(!x)return;let B=x.servizi_selezionati??x.servizi??x.items??[];Array.isArray(B)&&d.push(...B)}):["immagine_marketing","contabilita_fiscalita","ottimizzazione_management","digitalizzazione_automatismi"].forEach(B=>{let D=o[B];if(D){let V=D.servizi_selezionati??D.servizi??[];Array.isArray(V)&&d.push(...V)}});let g=0,E=0;d.forEach(x=>{if(!x)return;let B=(x.id??x.key??"").toString(),D=Number(x.prezzo_mensile??x.prezzoMensile??x.price_monthly??x.priceMonthly??0)||0,V=Number(x.prezzo??x.price??x.totale??x.valore??0)||0;D>0&&(g+=D),B.startsWith("social_")&&D===0&&V>0?g+=V:V>0&&(E+=V)}),typeof o.totale_mensile=="number"&&(g=o.totale_mensile||g),typeof o.totale_una_tantum=="number"&&(E=o.totale_una_tantum||E),g=Number(g.toFixed(2)),E=Number(E.toFixed(2));let h=Number((g+E).toFixed(2)),R=o.meta??o.dettagli?.meta??{},k=Number(R.scontoPercentuale??R.sconto_percentuale??R.sconto??0)||0,F=(R.scontoTarget??R.sconto_target??"una").toString().toLowerCase(),W=k>0&&(F==="mensile"||F==="entrambi")?Number((g*(1-k/100)).toFixed(2)):g,j=k>0&&(F==="una"||F==="entrambi")?Number((E*(1-k/100)).toFixed(2)):E,H=Number((W+j).toFixed(2)),P=q({},o);P.totale_mensile=g,P.totale_una_tantum=E,P.totale=h,P.totale_mensile_scontato=W,P.totale_una_tantum_scontato=j,P.totale_scontato=H,P._sconto_percentuale=k,P._sconto_target=F,console.log("[loadConfigurazionePromethea] calcolati:",{totaleMensile:P.totale_mensile,totaleUnaTantum:P.totale_una_tantum,totale:P.totale,mensileScontato:W,unaScontata:j,totaleScontato:H,scontoPercentuale:k,scontoTarget:F}),this.configurazionePromethea.set(P)}catch(e){console.error("[loadConfigurazionePromethea] error",e),this.configurazionePromethea.set(null)}})}loadTrattativeYuvi(t){return T(this,null,function*(){try{console.log("[loadTrattativeYuvi] ricerca trattative_yuvi per prospect",t);let e=this.soggettiService.supabaseService?.supabase??this.soggettiService.supabase;if(!e){console.warn("[loadTrattativeYuvi] supabase client non disponibile su soggettiService"),this.trattativeYuvi.set([]);return}let{data:a,error:o}=yield e.from("trattative_yuvi").select("*").eq("prospect_id",t).order("created_at",{ascending:!1});if(o){console.warn("[loadTrattativeYuvi] query errore:",o),this.trattativeYuvi.set([]);return}let d=Array.isArray(a)?a:a?[a]:[];console.log("[loadTrattativeYuvi] raw rows count:",d.length,d.slice(0,3));let _=d.map(g=>({id:g.id??g.uuid??g.trattativa_id??null,nome:g.nome??g.title??g.name??`Trattativa ${String(g.id??"").slice(0,8)}`,stato:g.stato??g.status??null,importo:g.importo??g.amount??g.totale??null,data:g.created_at??g.data??g.ts??null,prospectId:g.prospect_id??g.prospectId??null,raw:g})).filter(g=>!!g.id);console.log("[loadTrattativeYuvi] normalizzate count",_.length,_.slice(0,3)),this.trattativeYuvi.set(_)}catch(e){console.error("[loadTrattativeYuvi] eccezione",e),this.trattativeYuvi.set([])}})}vaiTrattativaYuviById(t){return T(this,null,function*(){let e=this.soggettoData();if(e?.id)try{let a=this.soggettiService.supabaseService?.supabase??this.soggettiService.supabase;if(!a){alert("Client Supabase non disponibile");return}let o=null;if(t){let{data:d,error:_}=yield a.from("trattative_yuvi").select("*").eq("id",t).single();!_&&d&&(o=d)}if(!o){let{data:d,error:_}=yield a.from("trattative_yuvi").select("*").eq("prospect_id",e.id).order("created_at",{ascending:!1}).limit(1).single();!_&&d&&(o=d)}if(!o){alert("Nessuna trattativa YUVI trovata per questo prospect");return}this.router.navigate(["/yuvi-trattativa"],{queryParams:{prospectId:e.id,trattativaId:o.id,step:7},state:{prospect:e,trattativaEsistente:o,from:"add-soggetto"}})}catch(a){console.error("Errore apertura trattativa Yuvi:",a),alert("Errore nel caricamento della trattativa: "+(a?.message??String(a)))}})}vaiTrattativaYuvi(){let t=(this.trattativeYuvi()??[]).at(0);t?.id&&this.vaiTrattativaYuviById(t.id)}apriConfigurazione(){let t=this.configurazionePromethea();t?.id&&this.router.navigate(["/preventivo",t.id])}switchToEdit(){this.id()&&this.router.navigate(["/soggetto",this.id(),"edit"])}cancel(){if(this.id())this.router.navigate(["/soggetto",this.id()]);else{let t=globalThis?.history;t&&typeof t.length=="number"&&t.length>1?this.location.back():this.router.navigate([this.tipo()==="prospect"?"/lista-prospect":"/home"])}}navigateBack(){let t=globalThis?.history;t&&typeof t.length=="number"&&t.length>1?this.location.back():this.router.navigate([this.tipo()==="prospect"?"/lista-prospect":"/home"])}submit(){return T(this,null,function*(){if(this.submitCooldown||this.isSubmitting())return;if(this.submitCooldown=!0,setTimeout(()=>{this.submitCooldown=!1},2e3),this.form.markAllAsTouched(),this.form.invalid){alert("Compila tutti i campi obbligatori correttamente");return}this.isSubmitting.set(!0);let t=this.form.value;try{let e=this.selectedProducts().length?this.selectedProducts().join(","):t.prodotto||"";if(this.mode()==="edit"&&this.id()){let a={id:this.id(),ragioneSociale:t.ragioneSociale,piva:t.piva?.trim()??"",formulaSocietaria:t.formulaSocietaria,categoriaAteco:t.categoriaAteco,referente:t.referente,telefono:t.telefono,email:t.email,sitoWeb:t.sitoWeb,facebook:t.facebook,instagram:t.instagram,metodoPagamento:t.metodoPagamento,iban:t.iban,note:t.note,prodotto:e,provincia:t.provincia,comune:t.comune,indirizzo:t.indirizzo,numeroCivico:t.numeroCivico},o=yield this.soggettiService.updateSoggetto(a);if(!o.success)throw new Error(o.error);if(t.provincia||t.comune){console.log("\u{1F504} Geocodifica automatica dopo modifica...");let d=yield this.soggettiService.geocodificaEAggiornaSoggetto(this.id());d.success?console.log("\u2705 Coordinate aggiornate con successo"):console.warn("\u26A0\uFE0F Geocodifica non riuscita:",d.error)}alert("Anagrafica aggiornata con successo"),this.router.navigate(["/soggetto",this.id()])}else if(this.mode()==="create"){let a={tipo:this.tipo(),ragioneSociale:t.ragioneSociale,piva:t.piva?.trim()||void 0,formulaSocietaria:t.formulaSocietaria,categoriaAteco:t.categoriaAteco,referente:t.referente,telefono:t.telefono,email:t.email,sitoWeb:t.sitoWeb,facebook:t.facebook,instagram:t.instagram,metodoPagamento:t.metodoPagamento,iban:t.iban,note:t.note,prodotto:e||"Promethea",provincia:t.provincia,comune:t.comune,indirizzo:t.indirizzo,numeroCivico:t.numeroCivico},o=yield this.soggettiService.createSoggetto(a);if(!o.success)throw new Error(o.error);if(o.data&&o.data.id){if(t.provincia||t.comune){console.log("\u{1F504} Geocodifica automatica dopo creazione...");let d=yield this.soggettiService.geocodificaEAggiornaSoggetto(o.data.id);d.success?console.log("\u2705 Coordinate aggiornate con successo"):console.warn("\u26A0\uFE0F Geocodifica non riuscita:",d.error)}alert(`${this.titolo()} aggiunto con successo!`),this.router.navigate(["/soggetto",o.data.id])}else throw new Error("ID del soggetto non restituito dal server")}}catch(e){console.error("Errore durante il salvataggio:",e),alert(`Errore: ${e?.message||"Operazione non riuscita"}`)}finally{this.isSubmitting.set(!1)}})}apriEsito(){this.soggettoData()?.id&&this.esitoPopupOpen.set(!0)}onEsitoPopupClosed(t){return T(this,null,function*(){this.esitoPopupOpen.set(!1),t.saved&&this.id()&&(yield this.loadSoggetto(this.id()))})}updateConditionalValidators(){let t=this.tipo()!=="prospect",e=this.form.get("ragioneSociale"),a=this.form.get("formulaSocietaria");t?(e.addValidators(A.required),a.removeValidators(A.required)):(e.removeValidators(A.required),a.removeValidators(A.required)),e.updateValueAndValidity(),a.updateValueAndValidity()}hasError(t,e){let a=this.form.get(t);return!!(a&&a.touched&&a.hasError(e))}onProvinciaSearchChange(t){if(this.provinciaSearch=t,!t||t.length<1){this.filteredProvinces=[];return}this.filteredProvinces=this.geoService.searchProvinces(t),this.showProvinceDropdown=!0}onProvinciaSelect(t){this.selectedProvince=t.code,this.provinciaSearch=`${t.name} (${t.code})`,this.form.patchValue({provincia:t.code}),this.filteredProvinces=[],this.showProvinceDropdown=!1}onProvinciaFocus(){this.provinciaSearch.length>0&&(this.filteredProvinces=this.geoService.searchProvinces(this.provinciaSearch)),this.showProvinceDropdown=!0}onProvinciaBlur(){setTimeout(()=>{this.showProvinceDropdown=!1},200)}getProvinciaName(t){if(!t)return"";let e=this.geoService.getProvinceByCode(t);return e?`${e.name} (${e.code})`:t}prodottiFiltered=()=>{let t=Array.isArray(this.prodotti)?this.prodotti.map(a=>typeof a=="string"?a:a.nome??""):[];return Array.from(new Map([...t,...this.prodottiDynamic].filter(Boolean).map(a=>[a.toLowerCase(),a])).values()).filter(a=>{let o=(a??"").toString().toLowerCase();return o!=="promethea"&&o!=="yuvi"})};isProductSelected(t){return this.selectedProducts().includes(t)}toggleProduct(t,e){let a=[...this.selectedProducts()];if(e)a.includes(t)||a.push(t);else{let o=a.indexOf(t);o>=0&&a.splice(o,1)}this.selectedProducts.set(a),this.form&&this.form.patchValue({prodotto:a.join(",")},{emitEvent:!1})}loadProdotti(){return T(this,null,function*(){try{let t=yield this.supa.getProdotti();if(t?.error||!Array.isArray(t.data)){this.prodottiDynamic=Array.isArray(this.prodotti)?this.prodotti.map(o=>typeof o=="string"?o:o.nome??"").filter(Boolean):[];return}let e=(t.data??[]).map(o=>String(o.nome??"").trim()).filter(Boolean),a=new Map;e.forEach(o=>a.set(o.toLowerCase(),o)),this.prodottiDynamic=Array.from(a.values())}catch(t){console.warn("[add-soggetto] loadProdotti failed",t),this.prodottiDynamic=Array.isArray(this.prodotti)?this.prodotti.map(e=>typeof e=="string"?e:e.nome??"").filter(Boolean):[]}})}static \u0275fac=function(e){return new(e||i)};static \u0275cmp=K({type:i,selectors:[["app-soggetto"]],decls:15,vars:10,consts:[["title","Caricamento in corso","subtitle","Recupero informazioni dal database...",3,"isLoading",4,"ngIf"],[1,"add-wrapper"],[1,"section-header"],[1,"material-icons","header-icon"],[1,"section-titles"],[1,"section-title"],["class","section-subtitle",4,"ngIf"],[1,"flex-1"],[1,"actions-container"],[4,"ngIf"],["class","form-sections","id","soggettoForm",3,"formGroup","view-mode","submit",4,"ngIf"],[3,"closed","open","soggettoId","tipo"],["title","Caricamento in corso","subtitle","Recupero informazioni dal database...",3,"isLoading"],[1,"section-subtitle"],["type","button",1,"promethea-button","ghost",3,"click"],[1,"material-icons"],["id","soggettoForm",1,"form-sections",3,"submit","formGroup"],[1,"actions-container","sticky-actions",2,"flex-direction","row"],["type","button",1,"promethea-button",3,"click"],["type","button",1,"promethea-button",3,"click","disabled"],["type","submit","form","soggettoForm",1,"promethea-button",3,"disabled"],["class","material-icons",4,"ngIf"],["class","loading-spinner",4,"ngIf"],[2,"padding","var(--gutter-sm)","border","1px solid var(--smoke-color-1)","border-radius","16px","box-shadow","0 4px 12px var(--shadow)","gap","var(--gutter-sm)"],["class","chip info","style","margin: var(--gutter-sm) ;",4,"ngIf"],[2,"margin","var(--gutter-sm)"],[1,"view-value"],[1,"form-section"],[1,"grid-form"],[1,"form-field","form-field-col-span"],[1,"form-label"],["type","text","formControlName","ragioneSociale","placeholder","Es. Acme S.r.l.",4,"ngIf"],["class","view-value",4,"ngIf"],["class","error",4,"ngIf"],[1,"form-field"],["type","text","formControlName","piva","placeholder","Opzionale - 11 cifre","inputmode","numeric",4,"ngIf"],["formControlName","formulaSocietaria",4,"ngIf"],["formControlName","categoriaAteco",4,"ngIf"],["class","autocomplete-container",4,"ngIf"],["type","text","formControlName","comune","placeholder","Es. Trieste",4,"ngIf"],["type","text","formControlName","indirizzo","placeholder","Es. Via Roma",4,"ngIf"],["type","text","formControlName","numeroCivico","placeholder","Es. 123",4,"ngIf"],["class","form-field form-field-col-span",4,"ngIf"],["type","text","formControlName","referente","placeholder","Es. Mario Rossi",4,"ngIf"],["type","tel","formControlName","telefono","placeholder","+39 ...","inputmode","tel",4,"ngIf"],["type","email","formControlName","email","placeholder","nome@dominio.tld",4,"ngIf"],["type","url","formControlName","sitoWeb","placeholder","https://...",4,"ngIf"],["type","url","formControlName","facebook","placeholder","https://facebook.com/...",4,"ngIf"],["type","url","formControlName","instagram","placeholder","https://instagram.com/...",4,"ngIf"],["formControlName","metodoPagamento",4,"ngIf"],["type","text","formControlName","iban","placeholder","IT60X0542811101000000123456",4,"ngIf"],["rows","4","formControlName","note","placeholder","Aggiungi note utili...",4,"ngIf"],["class","form-section",4,"ngIf"],[1,"loading-spinner"],[1,"chip","info",2,"margin","var(--gutter-sm)"],["type","text","formControlName","ragioneSociale","placeholder","Es. Acme S.r.l."],[1,"error"],["type","text","formControlName","piva","placeholder","Opzionale - 11 cifre","inputmode","numeric"],["formControlName","formulaSocietaria"],["value",""],[3,"value",4,"ngFor","ngForOf"],[3,"value"],["formControlName","categoriaAteco"],[1,"autocomplete-container"],["type","text","placeholder","Cerca provincia...","autocomplete","off",3,"ngModelChange","input","focus","blur","ngModel","ngModelOptions"],["class","autocomplete-dropdown",4,"ngIf"],[1,"autocomplete-dropdown"],["class","autocomplete-item",3,"click",4,"ngFor","ngForOf"],[1,"autocomplete-item",3,"click"],[1,"autocomplete-main"],[1,"province-code"],[1,"autocomplete-secondary"],["type","text","formControlName","comune","placeholder","Es. Trieste"],["type","text","formControlName","indirizzo","placeholder","Es. Via Roma"],["type","text","formControlName","numeroCivico","placeholder","Es. 123"],["type","text","formControlName","referente","placeholder","Es. Mario Rossi"],["type","tel","formControlName","telefono","placeholder","+39 ...","inputmode","tel"],["type","email","formControlName","email","placeholder","nome@dominio.tld"],["type","url","formControlName","sitoWeb","placeholder","https://..."],["type","url","formControlName","facebook","placeholder","https://facebook.com/..."],["type","url","formControlName","instagram","placeholder","https://instagram.com/..."],["formControlName","metodoPagamento"],["type","text","formControlName","iban","placeholder","IT60X0542811101000000123456"],["rows","4","formControlName","note","placeholder","Aggiungi note utili..."],["class","product-checkboxes",4,"ngIf"],[1,"product-checkboxes"],["class","mod-toggle","style","margin:0 0.4rem 0.4rem 0;",4,"ngFor","ngForOf"],[2,"width","100%","margin-top","0.25rem"],[1,"text-muted"],[1,"mod-toggle",2,"margin","0 0.4rem 0.4rem 0"],["type","checkbox",3,"change","id","checked"],[1,"mod-chip",3,"for","title"],[1,"chips-row"],["class","chip outline",4,"ngIf"],["class","form-section view-section",4,"ngIf"],[1,"chip","outline"],[1,"form-section","view-section"],["src","assets/Logo.png","alt","Promethea",1,"section-logo","promethea-logo"],[1,"config-section"],[1,"card","highlight"],[1,"card-title"],[1,"totale"],["class","text-muted","style","margin-left:6px;",4,"ngIf"],["type","button","style","margin-top: var(--gutter-md)","class","promethea-button",3,"click",4,"ngIf"],[1,"text-muted",2,"margin-left","6px"],["type","button",1,"promethea-button",2,"margin-top","var(--gutter-md)",3,"click"],["src","assets/yuvi.png","alt","Yuvi",1,"section-logo","yuvi-logo"],[1,"list-section"],["class","card soft",4,"ngFor","ngForOf"],[1,"card","soft"],[1,"card-title-row"],["class","text-muted",4,"ngIf"],[1,"card-actions"],[1,"promethea-button",2,"margin-top","var(--gutter-md)",3,"click"],[1,"esiti-timeline"],["class","card soft esito-card",4,"ngFor","ngForOf"],[1,"card","soft","esito-card"],["class","text-muted","style","margin-top: var(--gutter-sm);",4,"ngIf"],[1,"text-muted",2,"margin-top","var(--gutter-sm)"]],template:function(e,a){if(e&1&&(p(0,Re,1,1,"app-page-loader",0),s(1,"section",1)(2,"header",2)(3,"i",3),l(4),n(),s(5,"div",4)(6,"h2",5),l(7),n(),p(8,Ge,2,1,"p",6),n(),f(9,"div",7),s(10,"div",8),p(11,Ye,5,0,"ng-container",9)(12,$e,5,0,"ng-container",9),n()(),p(13,si,184,72,"form",10),n(),s(14,"app-esito-popup",11),I("closed",function(d){return a.onEsitoPopupClosed(d)}),n()),e&2){let o;c("ngIf",a.loading()),r(4),u(a.icona()),r(3),u(a.titolo()),r(),c("ngIf",a.mode()==="view"),r(3),c("ngIf",a.mode()==="view"),r(),c("ngIf",a.mode()!=="view"),r(),c("ngIf",!a.loading()),r(),c("open",a.esitoPopupOpen())("soggettoId",((o=a.soggettoData())==null?null:o.id)??"")("tipo",a.tipo())}},dependencies:[de,re,le,Ae,Se,Ee,Pe,fe,Ce,ve,xe,be,ye,Ie,he,ze,ke,me,ce,se],styles:[".form-sections[_ngcontent-%COMP%]{display:grid;gap:var(--gutter-lg)}.autocomplete-container[_ngcontent-%COMP%]{position:relative}.autocomplete-dropdown[_ngcontent-%COMP%]{position:absolute;top:100%;left:0;right:0;background:var(--background);border:1px solid var(--smoke-color-1);border-radius:8px;box-shadow:0 4px 12px var(--shadow);max-height:250px;overflow-y:auto;z-index:1000;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)}.autocomplete-item[_ngcontent-%COMP%]{padding:var(--gutter-sm);cursor:pointer;border-bottom:1px solid var(--smoke-color-1);transition:background-color .2s ease;display:flex;flex-direction:column;gap:.25rem}.autocomplete-item[_ngcontent-%COMP%]:hover{background:color-mix(in srgb,var(--primary) 10%,transparent)}.autocomplete-item[_ngcontent-%COMP%]:last-child{border-bottom:none}.autocomplete-main[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem}.province-code[_ngcontent-%COMP%]{color:var(--primary);font-weight:500;font-size:var(--fs-sm)}.autocomplete-secondary[_ngcontent-%COMP%]{color:var(--text-muted);font-size:var(--fs-sm);font-style:italic}.section-titles[_ngcontent-%COMP%]   .section-title[_ngcontent-%COMP%]{white-space:normal;overflow-wrap:anywhere;word-break:break-word;line-height:1.1}.section-header[_ngcontent-%COMP%]{padding:var(--gutter-sm)}.chips-row[_ngcontent-%COMP%]{display:flex;gap:var(--gutter-sm);margin:var(--gutter-sm) 0;flex-wrap:wrap}.section-title[_ngcontent-%COMP%]   .section-logo[_ngcontent-%COMP%], .section-logo[_ngcontent-%COMP%]{width:var(--fs-lg);height:var(--fs-lg);display:inline-block;object-fit:contain;vertical-align:middle;margin-right:.6rem;border-radius:6px}.section-logo.promethea-logo[_ngcontent-%COMP%], .section-logo.yuvi-logo[_ngcontent-%COMP%]{background:transparent}.esiti-timeline[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:var(--gutter-sm)}legend.section-title[_ngcontent-%COMP%]{margin:0}fieldset.form-section[_ngcontent-%COMP%]{margin-bottom:var(--gutter-lg)}.actions-container.sticky-actions[_ngcontent-%COMP%]{position:sticky;top:0;z-index:60;display:flex;align-items:center;gap:.5rem;background:transparent;padding:var(--gutter-sm);-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px)}"]})};export{Fe as AddSoggetto};
