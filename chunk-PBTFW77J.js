import{a as d}from"./chunk-QQWCK2ZL.js";import{v as g,w as p}from"./chunk-VUYFDMJB.js";import{N as l,S as c}from"./chunk-CVFHM34U.js";import{i}from"./chunk-ODN5LVDJ.js";var f=class u{supabaseService=c(g);authService=c(p);userService=c(d);soggettoCache=new Map;CACHE_TTL=3e4;createSoggetto(e){return i(this,null,function*(){try{if(console.log("\u{1F527} Creazione soggetto con dati:",e),e.piva?.trim()&&(yield this.supabaseService.checkPivaExists(e.piva.trim())))return{success:!1,error:"P.IVA gi\xE0 esistente nel sistema"};let r=this.mapToSnakeCase(e),t=this.authService.user();t&&(r.created_by=t.id),r.created_at=new Date().toISOString(),r.updated_at=r.created_at;let o=yield this.supabaseService.createSoggetto(r);return o.error?(console.error("\u274C Errore Supabase:",o.error),{success:!1,error:this.getErrorMessage(o.error)}):(this.soggettoCache.clear(),{success:!0,data:o.data||void 0})}catch(r){return console.error("\u274C Errore createSoggetto:",r),{success:!1,error:"Errore di sistema durante il salvataggio"}}})}clearCache(){this.soggettoCache.clear()}get supabase(){return this.supabaseService.supabase}getSoggettiByTipo(e,r=0,t=49){return i(this,null,function*(){if(this.userService.isAdmin()||e!=="prospect")return this.supabaseService.getSoggettiByTipo(e,r,t);let o=this.authService.user();if(!o)return{data:[],error:null};console.log(`\u{1F50D} Query prospect per utente: user=${o.id}, range=${r}-${t}`);let{data:a,error:s}=yield this.supabaseService.supabase.from("soggetti").select("*").eq("tipo",e).eq("created_by",o.id).order("created_at",{ascending:!1}).range(r,t);return{data:a,error:s}})}getSoggettoById(e){return i(this,null,function*(){return yield this.supabaseService.getSoggettoById(e)})}deleteSoggetto(e){return i(this,null,function*(){try{let r=yield this.unlinkOrDelete("trattative_yuvi","prospect_id",e);if(!r.ok)return{success:!1,error:this.getErrorMessage(r.error)};let t=yield this.unlinkOrDelete("configurazioni_promethea","prospect_id",e);if(!t.ok)return{success:!1,error:this.getErrorMessage(t.error)};let o=yield this.supabaseService.deleteSoggetto(e);return o.error?{success:!1,error:this.getErrorMessage(o.error),code:o.error.code}:{success:!0,data:o.data||void 0}}catch{return{success:!1,error:"Errore di sistema durante l'eliminazione"}}})}unlinkOrDelete(e,r,t){return i(this,null,function*(){let{error:o}=yield this.supabaseService.supabase.from(e).update({[r]:null}).eq(r,t);if(!o)return{ok:!0};let a=String(o?.message||"");if(!(o?.code==="23502"||/not[- ]?null/i.test(a)||/violates not-null constraint/i.test(a)))return{ok:!1,error:o};let{error:n}=yield this.supabaseService.supabase.from(e).delete().eq(r,t);return n?{ok:!1,error:n}:{ok:!0}})}updateSoggetto(e){return i(this,null,function*(){try{let r=this.mapUpdateToSnakeCase(e),t=yield this.supabaseService.updateSoggetto(e.id,r);return t.error?{success:!1,error:this.getErrorMessage(t.error),code:t.error.code}:{success:!0,data:t.data||void 0}}catch{return{success:!1,error:"Errore di sistema durante l'aggiornamento"}}})}searchSoggetti(e,r){return i(this,null,function*(){try{if(r!=="prospect"||this.userService.isAdmin()){let n=yield this.supabaseService.searchSoggetti(e,r);return r?{data:(n.data??[]).filter(m=>m.tipo===r),error:null}:n}let t=this.authService.user();if(!t)return{data:[],error:null};let o=(e??"").trim(),{data:a,error:s}=yield this.supabaseService.supabase.from("soggetti").select("*").eq("tipo","prospect").eq("created_by",t.id).or(`ragione_sociale.ilike.%${o}%,referente.ilike.%${o}%,piva.ilike.%${o}%,telefono.ilike.%${o}%,email.ilike.%${o}%`).order("created_at",{ascending:!1}).limit(50);return{data:a,error:s}}catch(t){return console.error("Errore nella ricerca soggetti:",t),{data:null,error:t}}})}updateProdotto(e,r){return i(this,null,function*(){try{let t=yield this.supabaseService.updateSoggetto(e,{prodotto:r});return t.error?{success:!1,error:this.getErrorMessage(t.error),code:t.error.code}:{success:!0,data:t.data||void 0}}catch{return{success:!1,error:"Errore di sistema durante l'aggiornamento del prodotto"}}})}getProvinceByTipo(e){return i(this,null,function*(){return this.supabaseService.getProvinceByTipo(e)})}countByTipo(e){return i(this,null,function*(){if(this.userService.isAdmin()||e!=="prospect")return this.supabaseService.countSoggettiByTipo(e);let r=this.authService.user();if(!r)return{data:0,error:null};let{count:t,error:o}=yield this.supabaseService.supabase.from("soggetti").select("*",{count:"exact",head:!0}).eq("tipo",e).eq("created_by",r.id);return{data:t??0,error:o}})}getConfigurazioniProspect(e){return i(this,null,function*(){try{if(!e.length)return new Map;let[r,t]=yield Promise.all([this.supabaseService.supabase.from("configurazioni_promethea").select("prospect_id").in("prospect_id",e),this.supabaseService.supabase.from("trattative_yuvi").select("prospect_id").in("prospect_id",e)]),o=new Map;return e.forEach(a=>o.set(a,!1)),r.data&&r.data.forEach(a=>{a.prospect_id&&o.set(a.prospect_id,!0)}),t.data&&t.data.forEach(a=>{a.prospect_id&&o.set(a.prospect_id,!0)}),o}catch(r){return console.error("Errore bulk configurazioni:",r),new Map}})}getConfigurazioniPrometheaByCliente(e){return i(this,null,function*(){try{if(!e.length)return new Map;let{data:r,error:t}=yield this.supabaseService.supabase.from("configurazioni_promethea").select("prospect_id").in("prospect_id",e);if(t)return console.error("Errore verifica configurazioni Promethea per clienti:",t),new Map;let o=new Map;return e.forEach(a=>o.set(a,!1)),r&&r.forEach(a=>{a.prospect_id&&o.set(a.prospect_id,!0)}),o}catch(r){return console.error("Errore bulk configurazioni Promethea per clienti:",r),new Map}})}getTrattativeYuviByProspect(e){return i(this,null,function*(){if(!e.length)return new Map;try{let{data:r,error:t}=yield this.supabaseService.supabase.from("trattative_yuvi").select("prospect_id").in("prospect_id",e);if(t)return console.error("Errore verifica trattative YUVI:",t),new Map;let o=new Map;return e.forEach(a=>o.set(a,!1)),r&&r.forEach(a=>{a.prospect_id&&o.set(a.prospect_id,!0)}),o}catch(r){return console.error("Errore bulk trattative YUVI:",r),new Map}})}getTrattativeYuviByCliente(e){return i(this,null,function*(){try{if(!e.length)return new Map;let{data:r,error:t}=yield this.supabaseService.supabase.from("trattative_yuvi").select("prospect_id").in("prospect_id",e);if(t)return console.error("Errore verifica trattative YUVI per clienti:",t),new Map;let o=new Map;return e.forEach(a=>o.set(a,!1)),r&&r.forEach(a=>{a.prospect_id&&o.set(a.prospect_id,!0)}),o}catch(r){return console.error("Errore bulk trattative YUVI per clienti:",r),new Map}})}mapToSnakeCase(e){return{tipo:e.tipo,ragione_sociale:e.ragioneSociale,piva:e.piva&&e.piva.trim()!==""?e.piva:null,formula_societaria:e.formulaSocietaria||null,categoria_ateco:e.categoriaAteco||null,referente:e.referente||null,telefono:e.telefono||null,email:e.email||null,sito_web:e.sitoWeb||null,facebook:e.facebook||null,instagram:e.instagram||null,metodo_pagamento:e.metodoPagamento||null,iban:e.iban||null,note:e.note||null,prodotto:e.prodotto||"Promethea",provincia:e.provincia||null,comune:e.comune||null,indirizzo:e.indirizzo||null,numero_civico:e.numeroCivico||null,esiti:[],created_by:null}}mapUpdateToSnakeCase(e){let r={};return e.tipo!==void 0&&(r.tipo=e.tipo),e.ragioneSociale!==void 0&&(r.ragione_sociale=e.ragioneSociale),e.piva!==void 0&&(r.piva=e.piva&&e.piva.trim()!==""?e.piva:null),e.formulaSocietaria!==void 0&&(r.formula_societaria=e.formulaSocietaria),e.categoriaAteco!==void 0&&(r.categoria_ateco=e.categoriaAteco),e.referente!==void 0&&(r.referente=e.referente),e.telefono!==void 0&&(r.telefono=e.telefono),e.email!==void 0&&(r.email=e.email),e.sitoWeb!==void 0&&(r.sito_web=e.sitoWeb),e.facebook!==void 0&&(r.facebook=e.facebook),e.instagram!==void 0&&(r.instagram=e.instagram),e.metodoPagamento!==void 0&&(r.metodo_pagamento=e.metodoPagamento),e.iban!==void 0&&(r.iban=e.iban),e.note!==void 0&&(r.note=e.note),e.prodotto!==void 0&&(r.prodotto=e.prodotto),e.provincia!==void 0&&(r.provincia=e.provincia),e.comune!==void 0&&(r.comune=e.comune),e.indirizzo!==void 0&&(r.indirizzo=e.indirizzo),e.numeroCivico!==void 0&&(r.numero_civico=e.numeroCivico),r}getErrorMessage(e){return typeof e=="string"?e:{23505:"Dati duplicati: il soggetto potrebbe gi\xE0 esistere",42501:"Permessi insufficienti per completare l'operazione",P0001:"Errore di validazione dei dati",network_error:"Errore di connessione al server"}[e.code]||e.message||"Errore durante il salvataggio"}getEsitiBySoggetto(e){return i(this,null,function*(){try{let{data:r,error:t}=yield this.supabaseService.getSoggettoById(e);if(t)return{data:null,error:t};let o=r?.esiti??[];return{data:this.normalizzaEsiti(o),error:null}}catch(r){return{data:null,error:r}}})}appendEsito(e,r){return i(this,null,function*(){try{let t=[];try{t=(yield this.getEsitiBySoggetto(e)).data??[]}catch(n){console.warn("Errore recupero esiti, procedo con array vuoto:",n),t=[]}let o=this.creaEsitoCompleto(r),a=[...t,o],s=yield this.supabaseService.updateSoggetto(e,{esiti:a});return s.error?{success:!1,error:this.getErrorMessage(s.error),code:s.error.code}:{success:!0,data:s.data||void 0}}catch(t){return console.error("Errore in appendEsito:",t),{success:!1,error:"Errore di sistema durante il salvataggio dell'esito"}}})}normalizzaEsiti(e){return e.map(r=>({tipo:r.tipo||"Non interessato",note:r.note||null,ts:r.ts||new Date().toISOString(),scheduleAt:r.scheduleAt||null,dataAppuntamento:r.dataAppuntamento||null,oraAppuntamento:r.oraAppuntamento||null}))}creaEsitoCompleto(e){return{tipo:e.tipo,note:e.note||null,ts:new Date().toISOString(),scheduleAt:e.scheduleAt||null,dataAppuntamento:e.dataAppuntamento||null,oraAppuntamento:e.oraAppuntamento||null}}convertiProspectInCliente(e){return i(this,null,function*(){try{let r={tipo:"cliente",updated_at:new Date().toISOString()},{data:t,error:o}=yield this.supabaseService.supabase.from("soggetti").update(r).eq("id",e).eq("tipo","prospect").select().single();return o?(console.error("Errore nella conversione prospect -> cliente:",o),{data:null,error:o}):(console.log("Prospect convertito in cliente:",t),{data:t,error:null})}catch(r){return console.error("Errore generale nella conversione:",r),{data:null,error:r}}})}static \u0275fac=function(r){return new(r||u)};static \u0275prov=l({token:u,factory:u.\u0275fac,providedIn:"root"})};export{f as a};
