import{a as ie,b as g}from"./chunk-JHFRRPN6.js";import{a as L,b as y,c as U,d as H,f as J,g as K,h as Q,i as W,j as X,k as Y,n as Z,p as ee}from"./chunk-QHMRLWV2.js";import{a as te}from"./chunk-MYIP52J4.js";import{j as $,k as z,m as G,p as j}from"./chunk-CSZ7WPY7.js";import{Aa as C,Eb as B,Ga as D,La as d,Na as F,X as h,Xa as p,Y as x,Ya as o,Za as n,_a as u,bb as k,cb as R,db as T,fa as c,gb as E,ha as M,hb as m,ib as P,mb as a,nb as f,ob as v,pb as q,ua as r,vb as A,xb as w,zb as N}from"./chunk-QS6MTI54.js";import{i as _}from"./chunk-ODN5LVDJ.js";function ae(t,i){if(t&1){let e=T();o(0,"div",4),E("click",function(){h(e);let s=m();return x(s.close())}),n()}}function re(t,i){if(t&1&&(o(0,"div",38),a(1),n()),t&2){let e=m().$implicit;r(),f(e.note)}}function se(t,i){if(t&1&&(o(0,"div",39)(1,"span",9),a(2,"event"),n(),o(3,"span"),a(4),A(5,"date"),n()()),t&2){let e=m().$implicit;r(4),v("Programmato: ",w(5,1,e.scheduleAt,"short"))}}function le(t,i){if(t&1&&(o(0,"div",39)(1,"span",9),a(2,"schedule"),n(),o(3,"span"),a(4),n()()),t&2){let e=m().$implicit;r(4),q("Appuntamento: ",e.dataAppuntamento," alle ",e.oraAppuntamento)}}function pe(t,i){if(t&1&&(o(0,"div",32)(1,"div",33)(2,"span",34),a(3),n(),o(4,"span",35),a(5),A(6,"date"),n()(),d(7,re,2,1,"div",36)(8,se,6,4,"div",37)(9,le,5,2,"div",37),n()),t&2){let e=i.$implicit;r(3),f(e.tipo),r(2),f(w(6,5,e.ts,"short")),r(2),p("ngIf",e.note),r(),p("ngIf",e.scheduleAt),r(),p("ngIf",e.dataAppuntamento&&e.oraAppuntamento)}}function de(t,i){t&1&&(o(0,"div",40),a(1,"Nessun esito"),n())}function me(t,i){if(t&1&&(o(0,"div",29),d(1,pe,10,8,"div",30)(2,de,2,0,"div",31),n()),t&2){let e=m(2);r(),p("ngForOf",e.esiti()),r(),p("ngIf",e.esiti().length===0)}}function ce(t,i){t&1&&(o(0,"div",40),a(1,"Caricamento\u2026"),n())}function ue(t,i){if(t&1&&(k(0),u(1,"input",41),R()),t&2){let e=m(2);r(),p("value",e.currentReferente())}}function ge(t,i){t&1&&u(0,"input",42)}function fe(t,i){if(t&1&&(o(0,"option",43),a(1),n()),t&2){let e=i.$implicit;p("value",e),r(),f(e)}}function ve(t,i){t&1&&(o(0,"small",44),a(1,"Campo obbligatorio"),n())}function _e(t,i){t&1&&(o(0,"small",44),a(1,"La data \xE8 obbligatoria"),n())}function he(t,i){t&1&&(o(0,"small",44),a(1,"L'orario \xE8 obbligatorio"),n())}function xe(t,i){if(t&1&&(o(0,"div",45)(1,"label",17)(2,"span",15)(3,"span",9),a(4,"event"),n(),a(5),n(),u(6,"input",46),d(7,_e,2,0,"small",21),n(),o(8,"label",17)(9,"span",15)(10,"span",9),a(11,"schedule"),n(),a(12),n(),u(13,"input",47),d(14,he,2,0,"small",21),n()()),t&2){let e,l,s=m(2);r(5),v(" ",((e=s.form.get("tipo"))==null?null:e.value)==="Richiamare"?"Data richiamo":"Data appuntamento"," * "),r(),p("min",s.getTodayDate()),r(),p("ngIf",s.hasError("dataAppuntamento","required")),r(5),v(" ",((l=s.form.get("tipo"))==null?null:l.value)==="Richiamare"?"Ora richiamo":"Ora appuntamento"," * "),r(2),p("ngIf",s.hasError("oraAppuntamento","required"))}}function Ee(t,i){t&1&&(o(0,"span",9),a(1,"add"),n())}function Se(t,i){t&1&&(o(0,"span",48),a(1,"hourglass_bottom"),n())}function Ie(t,i){if(t&1&&(o(0,"div",44),a(1),n()),t&2){let e=m(2);r(),f(e.error())}}function ye(t,i){if(t&1){let e=T();o(0,"div",5)(1,"header",6)(2,"h2",7),a(3),n(),o(4,"button",8),E("click",function(){h(e);let s=m();return x(s.close())}),o(5,"span",9),a(6,"close"),n()()(),o(7,"section",10),d(8,me,3,2,"div",11)(9,ce,2,0,"ng-template",null,0,N),u(11,"div",12),o(12,"form",13),E("ngSubmit",function(){h(e);let s=m();return x(s.save())}),o(13,"label",14)(14,"span",15)(15,"span",9),a(16,"person"),n(),a(17," Referente"),n(),d(18,ue,2,1,"ng-container",16)(19,ge,1,0,"ng-template",null,1,N),n(),o(21,"label",17)(22,"span",15)(23,"span",9),a(24,"category"),n(),a(25," Tipologia"),n(),o(26,"select",18)(27,"option",19),a(28,"\u2014 Seleziona \u2014"),n(),d(29,fe,2,2,"option",20),n(),d(30,ve,2,0,"small",21),n(),d(31,xe,15,5,"div",22),o(32,"label",14)(33,"span",15)(34,"span",9),a(35,"notes"),n(),a(36," Note"),n(),u(37,"textarea",23),n(),o(38,"div",24)(39,"button",25),E("click",function(){h(e);let s=m();return x(s.close())}),o(40,"span",9),a(41,"close"),n(),a(42," Annulla "),n(),o(43,"button",26),d(44,Ee,2,0,"span",27)(45,Se,2,0,"span",28),a(46),n()()(),d(47,Ie,2,1,"div",21),n()()}if(t&2){let e=P(10),l=P(20),s=m();r(3),v("Esiti ",s.tipo),r(5),p("ngIf",!s.loading())("ngIfElse",e),r(4),p("formGroup",s.form),r(6),p("ngIf",s.currentReferente())("ngIfElse",l),r(11),p("ngForOf",s.esitiTipi),r(),p("ngIf",s.hasError("tipo","required")),r(),p("ngIf",s.requireSchedule()),r(12),p("disabled",s.saving()||s.form.invalid),r(),p("ngIf",!s.saving()),r(),p("ngIf",s.saving()),r(),v(" ",s.saving()?"Salvataggio...":"Aggiungi esito"," "),r(),p("ngIf",s.error())}}var ne=class t{constructor(i,e){this.fb=i;this.soggettiService=e;this.form=this.fb.group({tipo:["",y.required],note:[""],dataAppuntamento:[""],oraAppuntamento:[""],referente:[""]}),this.form.get("tipo")?.valueChanges.subscribe(l=>{this.selectedTipo.set(l),this.updateValidators(l)})}open=!1;soggettoId;tipo;closed=new F;esiti=c([]);loading=c(!1);saving=c(!1);error=c(null);currentReferente=c(null);form;esitiTipi=ie;selectedTipo=c("");requireSchedule=B(()=>{let i=this.selectedTipo();return console.log("\u{1F50D} Tipo selezionato:",i,"Richiede appuntamento?",g.includes(i)),g.includes(i)});updateValidators(i){let e=this.form.get("dataAppuntamento"),l=this.form.get("oraAppuntamento");g.includes(i)?(e?.setValidators([y.required]),l?.setValidators([y.required])):(e?.clearValidators(),l?.clearValidators(),e?.reset(""),l?.reset("")),e?.updateValueAndValidity({emitEvent:!1}),l?.updateValueAndValidity({emitEvent:!1}),this.form.updateValueAndValidity({emitEvent:!1})}ngOnChanges(i){return _(this,null,function*(){if(i.open&&this.open&&this.soggettoId){yield Promise.all([this.loadEsiti(),this.loadAnagrafica()]);let e=this.form.get("tipo")?.value;this.selectedTipo.set(e),this.updateValidators(e)}i.open&&!this.open&&(this.form.reset(),this.selectedTipo.set(""),this.currentReferente.set(null))})}loadAnagrafica(){return _(this,null,function*(){try{let{data:i,error:e}=yield this.soggettiService.getSoggettoById(this.soggettoId);!e&&i&&this.currentReferente.set(i.referente??null)}catch{}})}loadEsiti(){return _(this,null,function*(){this.loading.set(!0),this.error.set(null);try{let i=yield this.soggettiService.getEsitiBySoggetto(this.soggettoId);if(i.error)throw new Error(i.error.message||"Errore nel caricamento esiti");this.esiti.set(i.data??[])}catch(i){this.error.set(i?.message||"Errore nel caricamento esiti")}finally{this.loading.set(!1)}})}save(){return _(this,null,function*(){if(this.form.markAllAsTouched(),this.form.invalid||this.saving())return;let{tipo:i,note:e,dataAppuntamento:l,oraAppuntamento:s,referente:b}=this.form.value,O=null;g.includes(i)&&l&&s&&(O=new Date(`${l}T${s}`).toISOString());let oe=!this.currentReferente()&&b?.trim()?.length>0;this.saving.set(!0),this.error.set(null);try{if(oe){let I=yield this.soggettiService.updateSoggetto({id:this.soggettoId,referente:b.trim()});if(!I.success)throw new Error(I.error||"Errore aggiornamento referente");this.currentReferente.set(b.trim())}let S={tipo:i,note:e||null,ts:new Date().toISOString(),scheduleAt:O,dataAppuntamento:g.includes(i)?l:null,oraAppuntamento:g.includes(i)?s:null},V=yield this.soggettiService.appendEsito(this.soggettoId,S);if(!V.success)throw new Error(V.error||"Errore salvataggio esito");this.esiti.update(I=>[...I,S]),this.form.reset(),this.selectedTipo.set(""),this.close(!0)}catch(S){this.error.set(S?.message||"Errore nel salvataggio")}finally{this.saving.set(!1)}})}close(i=!1){this.closed.emit({saved:i})}hasError(i,e){let l=this.form.get(i);return!!(l&&l.touched&&l.hasError(e))}getTodayDate(){return new Date().toISOString().split("T")[0]}static \u0275fac=function(e){return new(e||t)(C(Z),C(te))};static \u0275cmp=D({type:t,selectors:[["app-esito-popup"]],inputs:{open:"open",soggettoId:"soggettoId",tipo:"tipo"},outputs:{closed:"closed"},features:[M],decls:2,vars:2,consts:[["loadingTpl",""],["referenteInput",""],["class","modal-backdrop",3,"click",4,"ngIf"],["class","modal","role","dialog","aria-modal","true",4,"ngIf"],[1,"modal-backdrop",3,"click"],["role","dialog","aria-modal","true",1,"modal"],[1,"modal-header"],[1,"modal-title"],["aria-label","Chiudi",1,"icon-btn",3,"click"],[1,"material-icons"],[1,"modal-body"],["class","esiti-list",4,"ngIf","ngIfElse"],[1,"divider"],[1,"form-grid",3,"ngSubmit","formGroup"],[1,"form-field","form-field-col-span"],[1,"form-label"],[4,"ngIf","ngIfElse"],[1,"form-field"],["formControlName","tipo"],["value",""],[3,"value",4,"ngFor","ngForOf"],["class","error",4,"ngIf"],["class","field-group",4,"ngIf"],["rows","3","formControlName","note","placeholder","Aggiungi note..."],[1,"actions-container"],["type","button",1,"promethea-button","ghost",3,"click"],["type","submit",1,"promethea-button",3,"disabled"],["class","material-icons",4,"ngIf"],["class","material-icons spinning",4,"ngIf"],[1,"esiti-list"],["class","esito-item",4,"ngFor","ngForOf"],["class","empty-state",4,"ngIf"],[1,"esito-item"],[1,"esito-top"],[1,"chip"],[1,"esito-ts"],["class","esito-note",4,"ngIf"],["class","esito-schedule",4,"ngIf"],[1,"esito-note"],[1,"esito-schedule"],[1,"empty-state"],["type","text","disabled","",3,"value"],["type","text","formControlName","referente","placeholder","Inserisci il referente"],[3,"value"],[1,"error"],[1,"field-group"],["type","date","formControlName","dataAppuntamento",3,"min"],["type","time","formControlName","oraAppuntamento"],[1,"material-icons","spinning"]],template:function(e,l){e&1&&d(0,ae,1,0,"div",2)(1,ye,48,14,"div",3),e&2&&(p("ngIf",l.open),r(),p("ngIf",l.open))},dependencies:[j,$,z,ee,J,X,Y,L,W,U,H,K,Q,G],styles:[".esiti-list[_ngcontent-%COMP%]{display:grid;gap:var(--gutter-sm);margin-bottom:var(--gutter-lg)}.esito-item[_ngcontent-%COMP%]{border:1px solid var(--smoke-color-1);border-radius:12px;padding:var(--gutter-sm) var(--gutter-lg);background:var(--background);transition:all .2s ease}.esito-item[_ngcontent-%COMP%]:hover{border-color:var(--primary);box-shadow:0 2px 8px var(--shadow)}.esito-top[_ngcontent-%COMP%]{display:flex;gap:var(--gutter-sm);align-items:center;justify-content:space-between}.esito-ts[_ngcontent-%COMP%]{opacity:.8;font-size:.9em;color:var(--text-color)}.esito-note[_ngcontent-%COMP%]{margin-top:.5rem;color:var(--text-color);line-height:1.4}.esito-schedule[_ngcontent-%COMP%]{margin-top:.5rem;display:inline-flex;gap:.4rem;align-items:center;color:var(--primary);font-size:var(--fs-sm)}.esito-schedule[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:1rem}.field-group[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr 1fr;gap:var(--gutter-sm);margin:var(--gutter-sm) 0;width:100%}"]})};export{ne as a};
