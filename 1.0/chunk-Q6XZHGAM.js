import{c as q,d as G,e as L,f as B}from"./chunk-JHFRRPN6.js";import{a as T,b as d,c as P,d as V,f as M,g as z,h as w,i as F,j as O,k as D,m as k,n as R,p as $}from"./chunk-QHMRLWV2.js";import{a as W}from"./chunk-MYIP52J4.js";import{b as N,d as I}from"./chunk-A73PPQIR.js";import"./chunk-7VD3EVFT.js";import{g as _,j as C,k as y,p as A}from"./chunk-CSZ7WPY7.js";import{Eb as E,Ga as b,La as p,S as g,Xa as m,Ya as n,Za as e,_a as s,fa as S,gb as h,mb as i,nb as u,ob as x,ua as l}from"./chunk-QS6MTI54.js";import"./chunk-X5YLR3NI.js";import{i as f}from"./chunk-ODN5LVDJ.js";function Z(r,t){r&1&&(n(0,"small",38),i(1,"Campo obbligatorio"),e())}function j(r,t){r&1&&(n(0,"small",38),i(1,"Minimo 2 caratteri"),e())}function X(r,t){r&1&&(n(0,"small",38),i(1,"Formato non valido (max 11 cifre)"),e())}function H(r,t){if(r&1&&(n(0,"option",39),i(1),e()),r&2){let o=t.$implicit;m("value",o),l(),u(o)}}function J(r,t){r&1&&(n(0,"small",38),i(1,"Campo obbligatorio"),e())}function K(r,t){if(r&1&&(n(0,"option",39),i(1),e()),r&2){let o=t.$implicit;m("value",o),l(),u(o)}}function Q(r,t){r&1&&(n(0,"small",38),i(1,"Numero non valido"),e())}function Y(r,t){r&1&&(n(0,"small",38),i(1,"Email non valida"),e())}function ee(r,t){r&1&&(n(0,"small",38),i(1,"URL non valido"),e())}function te(r,t){if(r&1&&(n(0,"option",39),i(1),e()),r&2){let o=t.$implicit;m("value",o),l(),u(o)}}function ie(r,t){r&1&&(n(0,"small",38),i(1,"IBAN non valido"),e())}function oe(r,t){r&1&&(n(0,"span",8),i(1,"save"),e())}function ne(r,t){r&1&&s(0,"span",40)}var U=class r{fb=g(R);route=g(N);router=g(I);soggettiService=g(W);location=g(_);tipo=S("prospect");isSubmitting=S(!1);id=S(null);isEdit=E(()=>!!this.id());prodotti=q;form;formuleSocietarie=G;categorieAtecoMacro=L;metodiPagamento=B;submitCooldown=!1;titolo=E(()=>{let t=o=>o==="cliente"?"Cliente":o==="fornitore"?"Fornitore":"Prospect";return`${this.isEdit()?"Modifica":"Nuovo"} ${t(this.tipo())}`});icona=E(()=>{let t=this.tipo();return t==="cliente"?"person":t==="fornitore"?"local_shipping":"person_search"});ngOnInit(){return f(this,null,function*(){let t=(this.route.snapshot.paramMap.get("tipo")||"").toLowerCase();["cliente","fornitore","prospect"].includes(t)&&this.tipo.set(t);let o=this.route.snapshot.paramMap.get("id");o&&this.id.set(o),this.initializeForm(),this.isEdit()&&(yield this.loadSoggetto(this.id())),this.route.paramMap.subscribe(a=>f(this,null,function*(){let c=a.get("id"),v=(a.get("tipo")||"").toLowerCase();c&&c!==this.id()?(this.id.set(c),yield this.loadSoggetto(c)):["cliente","fornitore","prospect"].includes(v)&&(this.tipo.set(v),this.updateConditionalValidators())}))})}loadSoggetto(t){return f(this,null,function*(){let{data:o,error:a}=yield this.soggettiService.getSoggettoById(t);if(a||!o){alert("Impossibile caricare il soggetto selezionato");return}this.tipo.set(o.tipo),this.form.patchValue({ragioneSociale:o.ragione_sociale,piva:o.piva,formulaSocietaria:o.formula_societaria,categoriaAteco:o.categoria_ateco,prodotto:o.prodotto||"Promethea",referente:o.referente,telefono:o.telefono,email:o.email,sitoWeb:o.sito_web,facebook:o.facebook,instagram:o.instagram,metodoPagamento:o.metodo_pagamento,iban:o.iban,note:o.note},{emitEvent:!1}),this.updateConditionalValidators()})}initializeForm(){this.form=this.fb.group({ragioneSociale:["",[d.required,d.minLength(2)]],piva:["",[d.pattern(/^\d{0,11}$/)]],formulaSocietaria:[""],categoriaAteco:[""],referente:[""],telefono:["",[d.pattern(/^[+]?[\d\s\-()]{0,}$/)]],email:["",[d.email]],sitoWeb:["",[d.pattern(/^(https?:\/\/)?([\w\-]+\.)+[\w\-]{2,}(\/.*)?$|^$/i)]],facebook:[""],instagram:[""],iban:["",[d.pattern(/^[A-Z]{2}\d{2}[A-Z0-9]{0,30}$|^$/i)]],metodoPagamento:[""],note:[""],prodotto:["Promethea",d.required],provincia:[""],comune:[""],indirizzo:[""],numeroCivico:[""]}),this.updateConditionalValidators(),this.form.get("metodoPagamento").valueChanges.subscribe(t=>{let o=this.form.get("iban");t==="Bonifico"||t==="SEPA Direct Debit"?o.enable({emitEvent:!1}):(o.disable({emitEvent:!1}),o.reset("",{emitEvent:!1}))}),this.form.updateValueAndValidity()}updateConditionalValidators(){let t=this.tipo()!=="prospect",o=this.form.get("ragioneSociale"),a=this.form.get("piva"),c=this.form.get("formulaSocietaria");t?(o.addValidators(d.required),c.addValidators(d.required)):(o.removeValidators(d.required),c.removeValidators(d.required)),o.updateValueAndValidity(),a.updateValueAndValidity(),c.updateValueAndValidity()}submit(){return f(this,null,function*(){if(this.submitCooldown||this.isSubmitting()||(this.submitCooldown=!0,setTimeout(()=>{this.submitCooldown=!1},2e3),this.isSubmitting()))return;if(this.form.markAllAsTouched(),this.form.invalid){alert("Compila tutti i campi obbligatori correttamente");return}this.isSubmitting.set(!0);let t=this.form.value;try{if(this.isEdit()){let o={id:this.id(),ragioneSociale:t.ragioneSociale,piva:t.piva?.trim()??"",formulaSocietaria:t.formulaSocietaria,categoriaAteco:t.categoriaAteco,referente:t.referente,telefono:t.telefono,email:t.email,sitoWeb:t.sitoWeb,facebook:t.facebook,instagram:t.instagram,metodoPagamento:t.metodoPagamento,iban:t.iban,note:t.note,prodotto:t.prodotto,provincia:t.provincia,comune:t.comune,indirizzo:t.indirizzo,numeroCivico:t.numeroCivico},a=yield this.soggettiService.updateSoggetto(o);if(!a.success)throw new Error(a.error);alert("Anagrafica aggiornata con successo"),this.router.navigate(["/lista-prospect"])}else{let o={tipo:this.tipo(),ragioneSociale:t.ragioneSociale,piva:t.piva?.trim()||void 0,formulaSocietaria:t.formulaSocietaria,categoriaAteco:t.categoriaAteco,referente:t.referente,telefono:t.telefono,email:t.email,sitoWeb:t.sitoWeb,facebook:t.facebook,instagram:t.instagram,metodoPagamento:t.metodoPagamento,iban:t.iban,note:t.note,prodotto:t.prodotto||"Promethea",provincia:t.provincia,comune:t.comune,indirizzo:t.indirizzo,numeroCivico:t.numeroCivico},a=yield this.soggettiService.createSoggetto(o);if(!a.success)throw new Error(a.error);alert(`${this.titolo()} aggiunto con successo!`),this.resetFormCompletely()}}catch(o){console.error("Errore durante il salvataggio:",o),alert(`Errore: ${o?.message||"Operazione non riuscita"}`)}finally{this.isSubmitting.set(!1)}})}resetFormCompletely(){this.form.reset({prodotto:"Promethea"},{emitEvent:!1}),this.form.markAsPristine(),this.form.markAsUntouched(),this.updateConditionalValidators(),setTimeout(()=>{this.form.updateValueAndValidity()},0)}hasError(t,o){let a=this.form.get(t);return!!(a&&a.touched&&a.hasError(o))}cancel(){let t=globalThis?.history;if(t&&typeof t.length=="number"&&t.length>1)this.location.back();else{let o=this.tipo();this.router.navigate([o==="prospect"?"/lista-prospect":"/home"])}}static \u0275fac=function(o){return new(o||r)};static \u0275cmp=b({type:r,selectors:[["app-add-soggetto"]],decls:169,vars:18,consts:[[1,"add-wrapper"],[1,"section-header"],[1,"material-icons","header-icon"],[1,"section-titles"],[1,"section-title"],[1,"flex-1"],[1,"form-sections",3,"submit","formGroup"],[1,"form-section"],[1,"material-icons"],[1,"grid-form"],[1,"form-field","form-field-col-span"],[1,"form-label"],["type","text","formControlName","ragioneSociale","placeholder","Es. Acme S.r.l."],["class","error",4,"ngIf"],[1,"form-field"],["type","text","formControlName","piva","placeholder","Opzionale - 11 cifre","inputmode","numeric"],["formControlName","formulaSocietaria"],["value",""],[3,"value",4,"ngFor","ngForOf"],["formControlName","categoriaAteco"],["type","text","formControlName","comune","placeholder","Es. Trieste"],["type","text","formControlName","provincia","placeholder","Es. TS","maxlength","2"],["type","text","formControlName","indirizzo","placeholder","Es. Via Roma"],["type","text","formControlName","numeroCivico","placeholder","Es. 123"],["type","text","formControlName","referente","placeholder","Es. Mario Rossi"],["type","tel","formControlName","telefono","placeholder","+39 ...","inputmode","tel"],["type","email","formControlName","email","placeholder","nome@dominio.tld"],["type","url","formControlName","sitoWeb","placeholder","https://..."],["type","url","formControlName","facebook","placeholder","https://facebook.com/..."],["type","url","formControlName","instagram","placeholder","https://instagram.com/..."],["formControlName","metodoPagamento"],["type","text","formControlName","iban","placeholder","IT60X0542811101000000123456"],["rows","4","formControlName","note","placeholder","Aggiungi note utili..."],[1,"actions-container"],["type","button",1,"promethea-button","ghost",3,"click"],["type","submit",1,"promethea-button",3,"disabled"],["class","material-icons",4,"ngIf"],["class","loading-spinner",4,"ngIf"],[1,"error"],[3,"value"],[1,"loading-spinner"]],template:function(o,a){o&1&&(n(0,"section",0)(1,"header",1)(2,"i",2),i(3),e(),n(4,"div",3)(5,"h2",4),i(6),e()(),s(7,"div",5),e(),n(8,"form",6),h("submit",function(){return a.submit()}),n(9,"fieldset",7)(10,"legend",4)(11,"span",8),i(12,"apartment"),e(),i(13," Dati aziendali "),e(),n(14,"div",9)(15,"label",10)(16,"span",11)(17,"span",8),i(18,"business"),e(),i(19," Ragione sociale"),e(),s(20,"input",12),p(21,Z,2,0,"small",13)(22,j,2,0,"small",13),e(),n(23,"label",14)(24,"span",11)(25,"span",8),i(26,"numbers"),e(),i(27," P.IVA"),e(),s(28,"input",15),p(29,X,2,0,"small",13),e(),n(30,"label",14)(31,"span",11)(32,"span",8),i(33,"domain"),e(),i(34," Formula societaria"),e(),n(35,"select",16)(36,"option",17),i(37,"\u2014 Seleziona \u2014"),e(),p(38,H,2,2,"option",18),e(),p(39,J,2,0,"small",13),e(),n(40,"label",14)(41,"span",11)(42,"span",8),i(43,"category"),e(),i(44," Categoria merceologica (ATECO macro)"),e(),n(45,"select",19)(46,"option",17),i(47,"\u2014 Seleziona \u2014"),e(),p(48,K,2,2,"option",18),e()()()(),n(49,"fieldset",7)(50,"legend",4)(51,"span",8),i(52,"place"),e(),i(53," Indirizzo "),e(),n(54,"div",9)(55,"label",14)(56,"span",11)(57,"span",8),i(58,"location_city"),e(),i(59," Comune"),e(),s(60,"input",20),e(),n(61,"label",14)(62,"span",11)(63,"span",8),i(64,"map"),e(),i(65," Provincia"),e(),s(66,"input",21),e(),n(67,"label",10)(68,"span",11)(69,"span",8),i(70,"signpost"),e(),i(71," Indirizzo"),e(),s(72,"input",22),e(),n(73,"label",14)(74,"span",11)(75,"span",8),i(76,"home"),e(),i(77," Numero Civico"),e(),s(78,"input",23),e()()(),n(79,"fieldset",7)(80,"legend",4)(81,"span",8),i(82,"contacts"),e(),i(83," Referente e contatti "),e(),n(84,"div",9)(85,"label",14)(86,"span",11)(87,"span",8),i(88,"badge"),e(),i(89," Referente"),e(),s(90,"input",24),e(),n(91,"label",14)(92,"span",11)(93,"span",8),i(94,"call"),e(),i(95," Telefono"),e(),s(96,"input",25),p(97,Q,2,0,"small",13),e(),n(98,"label",14)(99,"span",11)(100,"span",8),i(101,"mail"),e(),i(102," Email"),e(),s(103,"input",26),p(104,Y,2,0,"small",13),e()()(),n(105,"fieldset",7)(106,"legend",4)(107,"span",8),i(108,"public"),e(),i(109," Web e social "),e(),n(110,"div",9)(111,"label",14)(112,"span",11)(113,"span",8),i(114,"language"),e(),i(115," Sito web"),e(),s(116,"input",27),p(117,ee,2,0,"small",13),e(),n(118,"label",14)(119,"span",11)(120,"span",8),i(121,"facebook"),e(),i(122," Facebook"),e(),s(123,"input",28),e(),n(124,"label",14)(125,"span",11)(126,"span",8),i(127,"camera_alt"),e(),i(128," Instagram"),e(),s(129,"input",29),e()()(),n(130,"fieldset",7)(131,"legend",4)(132,"span",8),i(133,"payments"),e(),i(134," Pagamenti "),e(),n(135,"div",9)(136,"label",14)(137,"span",11)(138,"span",8),i(139,"account_balance_wallet"),e(),i(140," Metodo di pagamento"),e(),n(141,"select",30)(142,"option",17),i(143,"\u2014 Non specificato \u2014"),e(),p(144,te,2,2,"option",18),e()(),n(145,"label",10)(146,"span",11)(147,"span",8),i(148,"credit_card"),e(),i(149," IBAN"),e(),s(150,"input",31),p(151,ie,2,0,"small",13),e()()(),n(152,"fieldset",7)(153,"legend",4)(154,"span",8),i(155,"notes"),e(),i(156," Note "),e(),n(157,"div",9)(158,"label",10),s(159,"textarea",32),e()()(),n(160,"div",33)(161,"button",34),h("click",function(){return a.cancel()}),n(162,"span",8),i(163,"close"),e(),i(164," Annulla "),e(),n(165,"button",35),p(166,oe,2,0,"span",36)(167,ne,1,0,"span",37),i(168),e()()()()),o&2&&(l(3),u(a.icona()),l(3),u(a.titolo()),l(2),m("formGroup",a.form),l(13),m("ngIf",a.hasError("ragioneSociale","required")),l(),m("ngIf",a.hasError("ragioneSociale","minlength")),l(7),m("ngIf",a.hasError("piva","pattern")),l(9),m("ngForOf",a.formuleSocietarie),l(),m("ngIf",a.hasError("formulaSocietaria","required")),l(9),m("ngForOf",a.categorieAtecoMacro),l(49),m("ngIf",a.hasError("telefono","pattern")),l(7),m("ngIf",a.hasError("email","email")),l(13),m("ngIf",a.hasError("sitoWeb","pattern")),l(27),m("ngForOf",a.metodiPagamento),l(7),m("ngIf",a.hasError("iban","pattern")),l(14),m("disabled",a.form.invalid||a.isSubmitting()),l(),m("ngIf",!a.isSubmitting()),l(),m("ngIf",a.isSubmitting()),l(),x(" ",a.isSubmitting()?"Salvataggio...":"Salva"," "))},dependencies:[A,C,y,$,M,O,D,T,F,P,V,k,z,w],styles:[".form-sections[_ngcontent-%COMP%]{display:grid;gap:var(--gutter-lg)}"]})};export{U as AddSoggetto};
