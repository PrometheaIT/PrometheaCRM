import{b}from"./chunk-7VD3EVFT.js";import{N as c,S as p,fa as u,g as o}from"./chunk-QS6MTI54.js";import{i as r}from"./chunk-ODN5LVDJ.js";var h=class a{supabase=p(b);userSubject=new o(null);user$=this.userSubject.asObservable();_user=u(null);_session=u(null);loading=u(!0);authSubscription;constructor(){this.bootstrap()}bootstrap(){return r(this,null,function*(){let{data:t}=yield this.supabase.getUser(),e=t?.user??null;this.userSubject.next(e),e&&(yield this.ensureAppUser(e.id,e.email??"")),this.supabase.onAuthStateChange((s,i)=>r(this,null,function*(){let n=i?.user??null;this.userSubject.next(n),n&&(yield this.ensureAppUser(n.id,n.email??""))})),this.loading.set(!1)})}ensureAppUser(t,e){return r(this,null,function*(){let{data:s}=yield this.supabase.getAppUserById(t);s||(yield this.supabase.createAppUser({id:t,email:e,is_active:!1,ruoli:["user"],moduli:[]}))})}user(){return this.userSubject.value}session(){return this.supabase.getSession()}logout(){return r(this,null,function*(){yield this.supabase.signOut(),this.userSubject.next(null)})}getAuthState(){return new Promise(t=>{if(!this.loading())t();else{let e=()=>{this.loading()?setTimeout(e,100):t()};e()}})}register(t,e){return r(this,null,function*(){let{data:s,error:i}=yield this.supabase.signUp(t,e);if(i)throw i;return s.user&&(this._user.set(s.user),this.userSubject.next(s.user),yield this.ensureAppUser(s.user.id,s.user.email??t)),s.session&&this._session.set(s.session),s})}login(t,e){return r(this,null,function*(){let{data:s,error:i}=yield this.supabase.signInWithPassword(t,e);if(i)throw i;return s.user&&(this._user.set(s.user),this.userSubject.next(s.user),yield this.ensureAppUser(s.user.id,s.user.email??t)),s.session&&this._session.set(s.session),s})}ngOnDestroy(){this.authSubscription&&(typeof this.authSubscription.unsubscribe=="function"?this.authSubscription.unsubscribe():this.authSubscription.subscription&&typeof this.authSubscription.subscription.unsubscribe=="function"?this.authSubscription.subscription.unsubscribe():typeof this.authSubscription=="function"&&this.authSubscription())}static \u0275fac=function(e){return new(e||a)};static \u0275prov=c({token:a,factory:a.\u0275fac,providedIn:"root"})};export{h as a};
