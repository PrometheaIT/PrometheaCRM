import{a as H}from"./chunk-D3KV7EOV.js";import{b as $,d as B,f as L,u as G}from"./chunk-EXOBR4AO.js";import{b as W}from"./chunk-JUOMJRR2.js";import"./chunk-Y2XJCRVM.js";import{b as j}from"./chunk-3ZXX2K2L.js";import{d as V,e as N,h as R,i as A,j as Q,k as q}from"./chunk-3DLJ4ULO.js";import{Ab as D,Ga as k,Jb as y,Kb as F,La as p,Lb as T,N as P,S as z,X as _,Xa as l,Y as S,Ya as o,Za as n,_a as x,fb as h,ib as v,jb as m,sb as b,ua as c,ub as r,vb as f,wb as g,xb as M,yb as w,zb as O}from"./chunk-6W5NKFNP.js";import"./chunk-X5YLR3NI.js";import{a as I,b as E,i as u}from"./chunk-ODN5LVDJ.js";var C=class a{supabaseService=z(j);getScadenzeBySoggetto(t){return u(this,null,function*(){let e=this.supabaseService.supabase,{data:i,error:s}=yield e.from("scadenze_fiscali").select("*").eq("soggetto_id",t).order("data_scadenza",{ascending:!0});return{data:i,error:s}})}createScadenza(t){return u(this,null,function*(){let e=this.supabaseService.supabase,i=new Date().toISOString(),{data:s,error:d}=yield e.from("scadenze_fiscali").insert([E(I({},t),{created_at:i,updated_at:i})]).select().single();return{data:s,error:d}})}updateScadenza(t,e){return u(this,null,function*(){let i=this.supabaseService.supabase,{data:s,error:d}=yield i.from("scadenze_fiscali").update(E(I({},e),{updated_at:new Date().toISOString()})).eq("id",t).select().single();return{data:s,error:d}})}deleteScadenza(t){return u(this,null,function*(){let e=this.supabaseService.supabase,{data:i,error:s}=yield e.from("scadenze_fiscali").delete().eq("id",t).select().single();return{data:i,error:s}})}inviaPromemoria(t){return u(this,null,function*(){return console.log("Invio promemoria per scadenza:",t),{success:!0}})}inviaDocumenti(t){return u(this,null,function*(){return console.log("Invio documenti per scadenza:",t),{success:!0}})}inviaPromemoriaScadenza(t,e,i){return u(this,null,function*(){if(!e.email)return{success:!1,error:"Nessuna email registrata per questo cliente"};let s=`Promemoria scadenza: ${t.tipo_scadenza}`,d=i.generateSingolaScadenzaMessage(e,t);return yield i.sendEmail({to:e.email,subject:s,message:d})})}inviaPromemoriaTutteScadenze(t,e,i){return u(this,null,function*(){if(!t.email)return{success:!1,error:"Nessuna email registrata per questo cliente"};if(e.length===0)return{success:!1,error:"Nessuna scadenza da segnalare"};let s=`Riepilogo scadenze fiscali - ${t.ragione_sociale}`,d=i.generateTutteScadenzeMessage(t,e);return yield i.sendEmail({to:t.email,subject:s,message:d})})}static \u0275fac=function(e){return new(e||a)};static \u0275prov=P({token:a,factory:a.\u0275fac,providedIn:"root"})};function U(a,t){if(a&1){let e=h();o(0,"button",20),v("click",function(){_(e);let s=m();return S(s.resetRicerca())}),r(1,"\u{1F504}"),n()}}function X(a,t){a&1&&(o(0,"div",21),x(1,"span",22),r(2," Ricerca in corso\u2026 "),n())}function Y(a,t){if(a&1&&(o(0,"div",23),r(1),n()),a&2){let e=m();c(),g(' Nessun cliente trovato per "',e.searchQuery,'" ')}}function Z(a,t){a&1&&(o(0,"div",24),r(1," Inserisci il nome, P.IVA o referente per cercare un cliente "),n())}function ee(a,t){if(a&1){let e=h();o(0,"div",27),v("click",function(){let s=_(e).$implicit,d=m(2);return S(d.selezionaCliente(s))}),o(1,"div",28)(2,"div",29)(3,"strong"),r(4),n()(),o(5,"div",30),r(6),n()(),o(7,"div",31),r(8,"\u2795"),n()()}if(a&2){let e=t.$implicit;c(4),f(e.ragione_sociale),c(2),M(" ",e.piva||"\u2014"," \u2022 ",e.email||"\u2014"," ")}}function te(a,t){if(a&1&&(o(0,"div",25),p(1,ee,9,3,"div",26),y(2,"slice"),n()),a&2){let e=m();c(),l("ngForOf",T(2,1,e.clienti,0,8))}}function ie(a,t){if(a&1&&(o(0,"div",24),r(1," Selezionato: "),o(2,"strong"),r(3),n()()),a&2){let e=m();c(3),f(e.clienteSelezionato.ragione_sociale)}}function ne(a,t){if(a&1&&(o(0,"span"),r(1," | "),o(2,"strong"),r(3,"P.IVA:"),n(),r(4),n()),a&2){let e=m(2);c(4),g(" ",e.clienteSelezionato.piva)}}function ae(a,t){if(a&1){let e=h();o(0,"div",42)(1,"div",43)(2,"button",44),v("click",function(){_(e);let s=m(2);return S(s.inviaPromemoriaTutteScadenze())}),r(3," \u{1F4E7} Avvisa di tutte le scadenze fiscali "),n()(),o(4,"p",45),r(5),n()()}if(a&2){let e=m(2);c(2),l("disabled",e.loading),c(3),g("Verr\xE0 inviata un'unica email con il riepilogo di tutte le ",e.scadenze.length," scadenze")}}function oe(a,t){a&1&&(o(0,"div",46),r(1," \u26A0\uFE0F Impossibile inviare email: nessun indirizzo email registrato per questo cliente "),n())}function re(a,t){a&1&&(o(0,"div",38)(1,"div",39),r(2,"\u{1F4E7}"),n(),o(3,"div",40),r(4,"Email Attiva"),n()())}function ce(a,t){if(a&1&&(o(0,"div",1)(1,"h3",5)(2,"i",32),r(3,"assignment"),n(),r(4),n(),o(5,"p",33)(6,"strong"),r(7,"Email:"),n(),r(8),p(9,ne,5,1,"span",34),n(),p(10,ae,6,2,"div",35)(11,oe,2,0,"div",36),o(12,"div",37)(13,"div",38)(14,"div",39),r(15),n(),o(16,"div",40),r(17,"Scadenze Totali"),n()(),o(18,"div",38)(19,"div",39),r(20),n(),o(21,"div",40),r(22,"Scadenze Imminenti"),n()(),p(23,re,5,0,"div",41),n()()),a&2){let e=m();c(4),g(" Riepilogo Scadenze \u2014 ",e.clienteSelezionato.ragione_sociale," "),c(4),g(" ",e.clienteSelezionato.email||"Nessuna email registrata"," "),c(),l("ngIf",e.clienteSelezionato.piva),c(),l("ngIf",e.scadenze.length>0&&e.clienteSelezionato.email),c(),l("ngIf",e.scadenze.length>0&&!e.clienteSelezionato.email),c(4),f(e.scadenze.length),c(3),b("imminente",e.scadenzeImminenti>0),c(2),f(e.scadenzeImminenti),c(3),l("ngIf",e.clienteSelezionato.email)}}function se(a,t){a&1&&(o(0,"div",1)(1,"h4",5)(2,"i",32),r(3,"add_task"),n(),r(4," Aggiungi Nuova Scadenza "),n(),x(5,"div",47),n())}function le(a,t){if(a&1&&(o(0,"span",60),r(1),n()),a&2){let e=m().$implicit;c(),g(" - ",e.descrizione_altro," ")}}function de(a,t){if(a&1&&(o(0,"div",61),r(1),n()),a&2){let e=m().$implicit,i=m(2);c(),g(" \u26A0\uFE0F Scade tra ",i.calcolaGiorniRimanenti(e)," giorni ")}}function me(a,t){if(a&1){let e=h();o(0,"tr")(1,"td"),r(2),p(3,le,2,1,"span",52),n(),o(4,"td")(5,"strong"),r(6),y(7,"date"),n(),p(8,de,2,1,"div",53),n(),o(9,"td",54),r(10),y(11,"number"),n(),o(12,"td"),r(13),n(),o(14,"td"),x(15,"input",55),n(),o(16,"td",56)(17,"button",57),v("click",function(){let s=_(e).$implicit,d=m(2);return S(d.inviaPromemoria(s))}),r(18," \u{1F4E7} "),n(),o(19,"button",58),v("click",function(){let s=_(e).$implicit,d=m(2);return S(d.inviaDocumenti(s))}),r(20," \u{1F4C4} "),n(),o(21,"button",59),v("click",function(){let s=_(e).$implicit,d=m(2);return S(d.eliminaScadenza(s.id))}),r(22," \u274C "),n()()()}if(a&2){let e=t.$implicit,i=m(2);b("scadenza-imminente",i.isScadenzaImminente(e)),c(2),g(" ",e.tipo_scadenza," "),c(),l("ngIf",e.descrizione_altro),c(3),f(F(7,10,e.data_scadenza,"dd/MM/yyyy")),c(2),l("ngIf",i.isScadenzaImminente(e)),c(2),g(" ",F(11,13,e.importo,"1.2-2")," \u20AC "),c(3),g(" ",e.giorni_avviso," "),c(2),l("checked",e.avviso_automatico),c(2),l("disabled",!i.clienteSelezionato.email)}}function ue(a,t){if(a&1&&(o(0,"div",48)(1,"div",49)(2,"table",50)(3,"thead")(4,"tr")(5,"th"),r(6,"Fiscalit\xE0"),n(),o(7,"th"),r(8,"Data Scadenza"),n(),o(9,"th"),r(10,"Importo (\u20AC)"),n(),o(11,"th"),r(12,"Giorni Avviso"),n(),o(13,"th"),r(14,"Avviso Auto"),n(),o(15,"th"),r(16,"Azioni"),n()()(),o(17,"tbody"),p(18,me,23,16,"tr",51),n()()()()),a&2){let e=m();c(18),l("ngForOf",e.scadenze)}}var J=class a{scadenzeService=z(C);soggettiService=z(W);emailService=z(H);searchQuery="";clienti=[];clienteSelezionato=null;ricercaLoading=!1;scadenze=[];nuovaScadenza={giorni_avviso:10,avviso_automatico:!0};tipiScadenza=["Ritenuta","TARI","Redditi","Diritto Camerale","Bollo","Inail","Inps IVS Fissi","Inps IVS Variabili","Inps Dipendenti","Altro"];loading=!1;mostraFormNuovaScadenza=!1;ngOnInit(){}cercaClienti(){return u(this,null,function*(){if(!this.searchQuery.trim()){this.clienti=[];return}this.ricercaLoading=!0,console.log("\u{1F50D} Ricerca clienti con query:",this.searchQuery);try{let t=yield this.soggettiService.searchSoggetti(this.searchQuery);console.log("\u{1F4CA} Risultati ricerca:",t),t.data?(this.clienti=t.data.filter(e=>e.tipo==="cliente"),console.log("\u{1F465} Clienti filtrati:",this.clienti)):this.clienti=[]}catch(t){console.error("\u274C Errore nella ricerca clienti:",t),this.clienti=[]}finally{this.ricercaLoading=!1}})}selezionaCliente(t){console.log("\u2705 Cliente selezionato:",t),this.clienteSelezionato=t,this.clienti=[],this.searchQuery=t.ragione_sociale,this.caricaScadenze()}caricaScadenze(){return u(this,null,function*(){if(!this.clienteSelezionato)return;this.loading=!0,console.log("\u{1F4E1} Caricamento scadenze per cliente:",this.clienteSelezionato.id);let t=yield this.scadenzeService.getScadenzeBySoggetto(this.clienteSelezionato.id);console.log("\u{1F4CA} Risultato scadenze:",t),t.data?this.scadenze=t.data:this.scadenze=[],this.loading=!1})}aggiungiScadenza(){return u(this,null,function*(){if(!this.clienteSelezionato||!this.nuovaScadenza.tipo_scadenza||!this.nuovaScadenza.data_scadenza||!this.nuovaScadenza.importo)return;let t={soggetto_id:this.clienteSelezionato.id,tipo_scadenza:this.nuovaScadenza.tipo_scadenza,data_scadenza:this.nuovaScadenza.data_scadenza,importo:Number(this.nuovaScadenza.importo),giorni_avviso:this.nuovaScadenza.giorni_avviso||10,avviso_automatico:this.nuovaScadenza.avviso_automatico??!0,descrizione_altro:this.nuovaScadenza.descrizione_altro};this.loading=!0;let e=yield this.scadenzeService.createScadenza(t);e.data&&(this.scadenze.push(e.data),this.resetFormNuovaScadenza(),this.mostraFormNuovaScadenza=!1),this.loading=!1})}eliminaScadenza(t){return u(this,null,function*(){confirm("Sei sicuro di voler eliminare questa scadenza?")&&(this.loading=!0,yield this.scadenzeService.deleteScadenza(t),this.scadenze=this.scadenze.filter(e=>e.id!==t),this.loading=!1)})}resetFormNuovaScadenza(){this.nuovaScadenza={giorni_avviso:10,avviso_automatico:!0}}isScadenzaImminente(t){let e=new Date,s=new Date(t.data_scadenza).getTime()-e.getTime();return Math.ceil(s/(1e3*60*60*24))<=t.giorni_avviso}get scadenzeImminenti(){return this.scadenze.filter(t=>this.isScadenzaImminente(t)).length}getDataOggi(){return new Date().toISOString().split("T")[0]}calcolaGiorniRimanenti(t){let e=new Date,s=new Date(t.data_scadenza).getTime()-e.getTime();return Math.ceil(s/(1e3*60*60*24))}resetRicerca(){this.clienteSelezionato=null,this.scadenze=[],this.searchQuery="",this.clienti=[]}inviaPromemoria(t){return u(this,null,function*(){if(!this.clienteSelezionato)return;this.loading=!0;let e=yield this.scadenzeService.inviaPromemoriaScadenza(t,this.clienteSelezionato,this.emailService);if(e.success)e.error&&e.error.includes("notificato")?alert("\u2705 Il team \xE8 stato notificato per inviare il promemoria al cliente. Verr\xE0 contattato al pi\xF9 presto."):alert("\u2705 Promemoria inviato con successo al cliente!");else{let i="Errore nell'invio del promemoria: "+e.error;alert(i)}this.loading=!1})}inviaPromemoriaTutteScadenze(){return u(this,null,function*(){if(!this.clienteSelezionato)return;this.loading=!0;let t=yield this.scadenzeService.inviaPromemoriaTutteScadenze(this.clienteSelezionato,this.scadenze,this.emailService);t.success?t.error&&t.error.includes("notificato")?alert("\u2705 Il team \xE8 stato notificato per inviare il riepilogo al cliente. Verr\xE0 contattato al pi\xF9 presto."):alert("\u2705 Email di riepilogo inviata con successo al cliente!"):alert("Errore nell'invio dell'email di riepilogo: "+t.error),this.loading=!1})}inviaDocumenti(t){return u(this,null,function*(){this.loading=!0,console.log("Invio documenti per scadenza:",t),alert("Funzionalit\xE0 di invio documenti in sviluppo"),this.loading=!1})}static \u0275fac=function(e){return new(e||a)};static \u0275cmp=k({type:a,selectors:[["app-scadenze-fiscali"]],decls:28,vars:14,consts:[[1,"stack-lg"],[1,"form-section"],[1,"section-header"],[1,"material-icons","header-icon"],[1,"section-titles"],[1,"section-title"],[1,"sottotitolo"],[1,"search-box"],[1,"form-label"],[1,"search-input-container"],["type","text","placeholder","Inserisci ragione sociale, P.IVA o referente...",3,"ngModelChange","input","ngModel","disabled"],["class","action-btn reset","title","Cambia cliente",3,"click",4,"ngIf"],["class","status-message loading","style","margin-top:.5rem;",4,"ngIf"],["class","status-message error","style","margin-top:.5rem;",4,"ngIf"],["class","status-message info","style","margin-top:.5rem;",4,"ngIf"],["class","search-results","role","listbox",4,"ngIf"],["class","form-section",4,"ngIf"],[1,"actions-container",2,"justify-content","flex-start"],[1,"promethea-button",3,"click"],["class","table-section",4,"ngIf"],["title","Cambia cliente",1,"action-btn","reset",3,"click"],[1,"status-message","loading",2,"margin-top",".5rem"],[1,"loading-spinner"],[1,"status-message","error",2,"margin-top",".5rem"],[1,"status-message","info",2,"margin-top",".5rem"],["role","listbox",1,"search-results"],["class","search-result-item","role","option",3,"click",4,"ngFor","ngForOf"],["role","option",1,"search-result-item",3,"click"],[1,"result-text"],[1,"result-title"],[1,"result-subtitle"],[1,"result-icon"],[1,"material-icons"],[1,"email-cliente"],[4,"ngIf"],["class","status-message info",4,"ngIf"],["class","status-message warning",4,"ngIf"],[1,"grid-responsive"],[1,"card"],[1,"card-number"],[1,"card-title"],["class","card",4,"ngIf"],[1,"status-message","info"],[1,"actions-container",2,"justify-content","center"],[1,"promethea-button",3,"click","disabled"],[1,"hint"],[1,"status-message","warning"],[1,"card",2,"animation","slideIn 0.3s ease"],[1,"table-section"],[1,"table-container"],[1,"crm-table"],[3,"scadenza-imminente",4,"ngFor","ngForOf"],["class","descrizione-altro",4,"ngIf"],["class","giorni-rimanenti",4,"ngIf"],[1,"importo-cell"],["type","checkbox","disabled","",1,"avviso-checkbox",3,"checked"],[1,"table-actions"],["title","Invia promemoria email",1,"action-btn","email",3,"click","disabled"],["title","Invio Documenti (in sviluppo)",1,"action-btn","document",3,"click"],["title","Elimina",1,"action-btn","delete",3,"click"],[1,"descrizione-altro"],[1,"giorni-rimanenti"]],template:function(e,i){e&1&&(o(0,"div",0)(1,"div",1)(2,"div",2)(3,"i",3),r(4,"request_quote"),n(),o(5,"div",4)(6,"h2",5),r(7,"Gestione Scadenze Fiscali"),n(),o(8,"p",6),r(9,"Ricerca cliente, riepilogo e scadenze"),n()()()(),o(10,"div",1)(11,"div",7)(12,"label",8),r(13,"Cerca Cliente"),n(),o(14,"div",9)(15,"input",10),D("ngModelChange",function(d){return O(i.searchQuery,d)||(i.searchQuery=d),d}),v("input",function(){return i.cercaClienti()}),n(),p(16,U,2,0,"button",11)(17,X,3,0,"div",12)(18,Y,2,1,"div",13)(19,Z,2,0,"div",14)(20,te,3,5,"div",15),n(),p(21,ie,4,1,"div",14),n()(),p(22,ce,24,10,"div",16)(23,se,6,0,"div",16),o(24,"div",17)(25,"button",18),v("click",function(){return i.mostraFormNuovaScadenza=!i.mostraFormNuovaScadenza}),r(26),n()(),p(27,ue,19,1,"div",19),n()),e&2&&(c(15),w("ngModel",i.searchQuery),l("disabled",!!i.clienteSelezionato),c(),l("ngIf",i.clienteSelezionato),c(),l("ngIf",i.ricercaLoading),c(),l("ngIf",!i.ricercaLoading&&i.searchQuery.trim()&&i.clienti.length===0&&!i.clienteSelezionato),c(),l("ngIf",!i.ricercaLoading&&!i.searchQuery.trim()&&i.clienti.length===0&&!i.clienteSelezionato),c(),l("ngIf",i.clienti.length>0&&!i.clienteSelezionato),c(),l("ngIf",i.clienteSelezionato),c(),l("ngIf",i.clienteSelezionato),c(),l("ngIf",i.clienteSelezionato&&i.mostraFormNuovaScadenza),c(2),b("secondary",i.mostraFormNuovaScadenza),c(),g(" ",i.mostraFormNuovaScadenza?"Annulla":"\u2795 Nuova Scadenza"," "),c(),l("ngIf",i.clienteSelezionato))},dependencies:[q,V,N,G,$,B,L,Q,A,R],styles:['.actions-container[_ngcontent-%COMP%]{margin-top:var(--gutter-lg)}.form-section[_ngcontent-%COMP%] + .form-section[_ngcontent-%COMP%], .form-section[_ngcontent-%COMP%] + .table-section[_ngcontent-%COMP%], .form-section[_ngcontent-%COMP%] + .grid-responsive[_ngcontent-%COMP%], .table-section[_ngcontent-%COMP%] + .form-section[_ngcontent-%COMP%]{margin-top:var(--gutter-lg)}.stack-lg[_ngcontent-%COMP%] > *[_ngcontent-%COMP%] + *[_ngcontent-%COMP%]{margin-top:var(--gutter-lg)}.section-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:var(--gutter-lg);margin-bottom:var(--gutter-lg)}.header-icon[_ngcontent-%COMP%]{font-size:var(--fs-lg);color:var(--primary)}.sottotitolo[_ngcontent-%COMP%]{opacity:.8;font-style:italic}.card.imminente[_ngcontent-%COMP%]{border-color:#ef4444!important;background:color-mix(in srgb,#ef4444 8%,transparent)!important}.card.imminente[_ngcontent-%COMP%]   .card-number[_ngcontent-%COMP%]{color:#ef4444}.scadenza-imminente[_ngcontent-%COMP%]{background:color-mix(in srgb,#ef4444 10%,transparent)!important;border-left:4px solid #ef4444;animation:pulse 2s infinite}.descrizione-altro[_ngcontent-%COMP%]{font-size:var(--fs-sm);color:var(--text-color);opacity:.7;font-style:italic}.giorni-rimanenti[_ngcontent-%COMP%]{font-size:var(--fs-sm);color:#ef4444;font-weight:600;margin-top:4px}.importo-cell[_ngcontent-%COMP%]{font-weight:600;color:var(--primary)}.checkbox-label[_ngcontent-%COMP%]{display:flex;align-items:center;gap:var(--gutter-sm);cursor:pointer;font-size:var(--fs-sm);color:var(--text-color)}.checkbox-label[_ngcontent-%COMP%]   input[type=checkbox][_ngcontent-%COMP%]{display:none}.checkmark[_ngcontent-%COMP%]{width:20px;height:20px;border:2px solid var(--smoke-color-1);border-radius:4px;display:flex;align-items:center;justify-content:center;transition:all .2s ease}.checkbox-label[_ngcontent-%COMP%]   input[type=checkbox][_ngcontent-%COMP%]:checked + .checkmark[_ngcontent-%COMP%]{background:var(--primary);border-color:var(--primary);color:#fffaf7}.checkbox-label[_ngcontent-%COMP%]   input[type=checkbox][_ngcontent-%COMP%]:checked + .checkmark[_ngcontent-%COMP%]:after{content:"\\2713";font-size:12px;font-weight:700}.scadenze-section[_ngcontent-%COMP%]{margin-top:var(--gutter-lg)}']})};export{J as ScadenzeFiscali};
