import{v as h}from"./chunk-67GYVHNT.js";import{N as c,S as p,fa as n,g as a}from"./chunk-QS6MTI54.js";import{i as r}from"./chunk-ODN5LVDJ.js";var l=class o{supabase=p(h);userSubject=new a(null);user$=this.userSubject.asObservable();_user=n(null);_session=n(null);loading=n(!0);authSubscription;constructor(){this.bootstrap()}bootstrap(){return r(this,null,function*(){this.loading.set(!0);try{let{data:t}=yield this.supabase.getUser(),e=t?.user??null;console.log("\u{1F510} AuthService bootstrap - User:",e),this.userSubject.next(e),this._user.set(e),e&&(yield this.ensureAppUser(e.id,e.email??"")),this.authSubscription=this.supabase.onAuthStateChange((s,i)=>r(this,null,function*(){console.log("\u{1F510} AuthService - Auth event:",s);let u=i?.user??null;this.userSubject.next(u),this._user.set(u),this._session.set(i),u&&(yield this.ensureAppUser(u.id,u.email??""))}))}catch(t){console.error("\u{1F510} AuthService bootstrap error:",t),this.userSubject.next(null),this._user.set(null)}finally{this.loading.set(!1)}})}ensureAppUser(t,e){return r(this,null,function*(){try{let{data:s}=yield this.supabase.getAppUserById(t);s?console.log("\u{1F510} App user exists:",s):(console.log("\u{1F510} Creating new app user for:",e),yield this.supabase.createAppUser({id:t,email:e,is_active:!1,ruoli:["user"],moduli:[]}))}catch(s){console.error("\u{1F510} Error ensuring app user:",s)}})}user(){return this.userSubject.value}session(){return this.supabase.getSession()}logout(){return r(this,null,function*(){yield this.supabase.signOut(),this.userSubject.next(null)})}getAuthState(){return new Promise(t=>{if(!this.loading())t();else{let e=()=>{this.loading()?setTimeout(e,10):t()};e()}})}register(t,e){return r(this,null,function*(){let{data:s,error:i}=yield this.supabase.signUp(t,e);if(i)throw i;return s.user&&(this._user.set(s.user),this.userSubject.next(s.user),yield this.ensureAppUser(s.user.id,s.user.email??t)),s.session&&this._session.set(s.session),s})}login(t,e){return r(this,null,function*(){let{data:s,error:i}=yield this.supabase.signInWithPassword(t,e);if(i)throw i;return s.user&&(this._user.set(s.user),this.userSubject.next(s.user),yield this.ensureAppUser(s.user.id,s.user.email??t)),s.session&&this._session.set(s.session),s})}ngOnDestroy(){this.authSubscription&&(typeof this.authSubscription.unsubscribe=="function"?this.authSubscription.unsubscribe():this.authSubscription.subscription&&typeof this.authSubscription.subscription.unsubscribe=="function"?this.authSubscription.subscription.unsubscribe():typeof this.authSubscription=="function"&&this.authSubscription())}static \u0275fac=function(e){return new(e||o)};static \u0275prov=c({token:o,factory:o.\u0275fac,providedIn:"root"})};export{l as a};
