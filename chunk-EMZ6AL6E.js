import{a as x}from"./chunk-CZQHU2W7.js";import{a as F,b as B,d as L,f as G,h as j,n as $,o as q,p as H,u as J}from"./chunk-Z6GIDEG7.js";import{a as D}from"./chunk-XDKKMB7K.js";import{b as N}from"./chunk-WPZ527DH.js";import{d as R,e as V,j as W}from"./chunk-PJ4DYJTI.js";import{Ga as I,La as _,S as A,Wa as m,X as p,Xa as r,Y as u,Ya as o,Za as y,db as E,ea as S,gb as M,hb as g,kb as z,lb as T,mb as l,nb as h,ob as k,qb as f,rb as v,sb as P,ua as s}from"./chunk-R5VHGKSY.js";import"./chunk-X5YLR3NI.js";import{a as O,b as U,i as b}from"./chunk-ODN5LVDJ.js";function Q(d,e){d&1&&(r(0,"div",23),y(1,"span",24),l(2," Caricamento utenti\u2026 "),o())}function X(d,e){if(d&1&&(r(0,"div",25),l(1),o()),d&2){let t=g();s(),h(t.error())}}function Y(d,e){if(d&1&&(r(0,"div",26)(1,"div",27)(2,"h3",28),l(3,"Totale Utenti"),o(),r(4,"div",29),l(5),o()(),r(6,"div",27)(7,"h3",28),l(8,"In Attesa Approvazione"),o(),r(9,"div",29),l(10),o()(),r(11,"div",27)(12,"h3",28),l(13,"Utenti Attivi"),o(),r(14,"div",29),l(15),o()(),r(16,"div",27)(17,"h3",28),l(18,"Amministratori"),o(),r(19,"div",29),l(20),o()()()),d&2){let t=g();s(5),h(t.getTotalUsers()),s(),z("card-highlight",t.getPendingUsers()>0),s(3),z("text-danger",t.getPendingUsers()>0),s(),k(" ",t.getPendingUsers()," "),s(5),h(t.getActiveUsers()),s(5),h(t.getAdminUsers())}}function Z(d,e){d&1&&(r(0,"small",48),l(1," In attesa di approvazione "),o())}function ee(d,e){if(d&1){let t=E();r(0,"label",49)(1,"input",36),M("change",function(){let n=p(t).$implicit,a=g().$implicit,c=g(2);return u(c.toggleModulo(a,n))}),o(),r(2,"span",50),l(3),o()()}if(d&2){let t=e.$implicit,i=g().$implicit;s(),m("checked",i.moduli.includes(t)||!1),s(),T("mod-chip-"+t),z("selected",i.moduli.includes(t)),s(),h(t)}}function te(d,e){d&1&&y(0,"span",24)}function ie(d,e){d&1&&(r(0,"i",51),l(1,"save"),o())}function ne(d,e){if(d&1){let t=E();r(0,"tr")(1,"td",31)(2,"div",32)(3,"div")(4,"strong"),l(5),o(),_(6,Z,2,0,"small",33),o()()(),r(7,"td",34)(8,"div",32)(9,"label",35)(10,"input",36),M("change",function(){let n=p(t).$implicit;return u(n.is_active=!n.is_active)}),o(),y(11,"span",37),o(),r(12,"span",38),l(13),o()()(),r(14,"td",39)(15,"div",32)(16,"label",40)(17,"input",36),M("change",function(){let n=p(t).$implicit,a=g(2);return u(a.toggleAdmin(n))}),o(),y(18,"span",37),o()()(),r(19,"td",41)(20,"div",42),_(21,ee,4,6,"label",43),o()(),r(22,"td",44)(23,"div",32)(24,"button",45),M("click",function(){let n=p(t).$implicit,a=g(2);return u(a.saveRow(n))}),_(25,te,1,0,"span",46)(26,ie,2,0,"i",47),l(27," Salva "),o()()()()}if(d&2){let t=e.$implicit,i=g(2);z("row-inactive",!t.is_active),s(5),h(t.email),s(),m("ngIf",!t.is_active),s(4),m("checked",t.is_active===!0),s(3),h(t.is_active?"Attivo":"Inattivo"),s(4),m("checked",t.ruoli.includes("admin")||!1),s(4),m("ngForOf",i.mods),s(3),m("disabled",!i.hasChanges(t)||i.savingIds.has(t.id)),s(),m("ngIf",i.savingIds.has(t.id)),s(),m("ngIf",!i.savingIds.has(t.id))}}function oe(d,e){if(d&1&&(r(0,"section",12)(1,"div",20)(2,"table",21)(3,"thead")(4,"tr")(5,"th"),l(6,"Email"),o(),r(7,"th"),l(8,"Stato"),o(),r(9,"th"),l(10,"Admin"),o(),r(11,"th"),l(12,"Moduli"),o(),r(13,"th"),l(14,"Azioni"),o()()(),r(15,"tbody"),_(16,ne,28,11,"tr",30),o()()()()),d&2){let t=g();s(16),m("ngForOf",t.rows())}}function re(d,e){d&1&&(r(0,"div",52)(1,"i",53),l(2,"group"),o(),r(3,"p"),l(4,"Nessun utente trovato nel sistema."),o()())}function ae(d,e){if(d&1&&(r(0,"option",54),l(1),o()),d&2){let t=e.$implicit;m("value",t),s(),h(t)}}function le(d,e){if(d&1&&(r(0,"option",54),l(1),o()),d&2){let t=e.$implicit;m("value",t),s(),h(t)}}function se(d,e){if(d&1){let t=E();r(0,"tr")(1,"td")(2,"input",55),P("ngModelChange",function(n){let a=p(t).$implicit;return v(a.nome,n)||(a.nome=n),u(n)}),o()(),r(3,"td")(4,"input",55),P("ngModelChange",function(n){let a=p(t).$implicit;return v(a.descrizione,n)||(a.descrizione=n),u(n)}),o()(),r(5,"td")(6,"select",16),P("ngModelChange",function(n){let a=p(t).$implicit;return v(a.categoria,n)||(a.categoria=n),u(n)}),_(7,le,2,2,"option",17),o()(),r(8,"td")(9,"input",56),P("ngModelChange",function(n){let a=p(t).$implicit;return v(a.prezzo_base,n)||(a.prezzo_base=n),u(n)}),o()(),r(10,"td")(11,"label",57)(12,"input",58),P("ngModelChange",function(n){let a=p(t).$implicit;return v(a.attivo,n)||(a.attivo=n),u(n)}),o(),y(13,"span",37),o()(),r(14,"td")(15,"div",59)(16,"button",19),M("click",function(){let n=p(t).$implicit,a=g();return u(a.updateProdottoRow(n))}),l(17,"Salva"),o(),r(18,"button",60),M("click",function(){let n=p(t).$implicit,a=g();return u(a.removeProdotto(n.id))}),l(19,"Elimina"),o()()()()}if(d&2){let t=e.$implicit,i=g();s(2),f("ngModel",t.nome),s(2),f("ngModel",t.descrizione),s(2),f("ngModel",t.categoria),s(),m("ngForOf",i.categories),s(2),f("ngModel",t.prezzo_base),s(3),f("ngModel",t.attivo)}}var K=class d{supa=A(N);userService=A(D);loading=S(!0);error=S(null);rows=S([]);mods=["immagine","digitalizzazione","contabilita","ottimizzazione"];savingIds=new Set;prodotti=S([]);newProdottoName="";newProdottoDescrizione="";newProdottoCategoria=x[0];newProdottoPrezzo=null;CATEGORIE_PRODOTTO=x;categories=[];original=new Map;ngOnInit(){return b(this,null,function*(){this.loading.set(!0),this.error.set(null);try{if(!this.userService.isAdmin()){this.error.set("Non autorizzato ad accedere a questa sezione");return}yield this.refreshRows()}catch(e){console.error("\u274C Errore AdminUtenti ngOnInit:",e),this.error.set(e?.message||"Errore durante il caricamento degli utenti")}finally{this.loading.set(!1)}yield this.loadProdotti()})}refreshRows(){return b(this,null,function*(){try{let e=yield this.supa.getAppUsers();if(e.error)throw new Error(e.error.message||"Errore durante il recupero degli utenti");let t=e.data??[];this.original.clear();let i=t.map(n=>U(O({},n),{ruoli:n.ruoli||[],moduli:n.moduli||[]}));for(let n of i)this.original.set(n.id,{ruoli:[...n.ruoli],moduli:[...n.moduli],is_active:n.is_active});this.rows.set(i),console.log("\u2705 Caricati",i.length,"utenti")}catch(e){throw console.error("\u274C Errore refreshRows:",e),e}})}toggleAdmin(e){e.ruoli||(e.ruoli=[]);let t=new Set(e.ruoli);t.has("admin")?(t.delete("admin"),t.add("user")):t.add("admin"),e.ruoli=Array.from(t)}toggleModulo(e,t){e.moduli||(e.moduli=[]);let i=[...e.moduli],n=i.indexOf(t);n>=0?i.splice(n,1):i.push(t),e.moduli=i}hasChanges(e){let t=this.original.get(e.id);if(!t||t.is_active!==e.is_active)return!0;let i=new Set(t.ruoli||[]),n=new Set(e.ruoli||[]);if(i.size!==n.size)return!0;for(let w of i)if(!n.has(w))return!0;let a=new Set(t.moduli||[]),c=new Set(e.moduli||[]);if(a.size!==c.size)return!0;for(let w of a)if(!c.has(w))return!0;return!1}saveRow(e){return b(this,null,function*(){if(!e.id){console.error("\u274C Row senza ID:",e);return}let t=this.original.get(e.id);if(!t){console.error("\u274C Nessun originale trovato per:",e.id);return}if(this.savingIds.has(e.id)){console.log("\u23F3 Salvataggio gi\xE0 in corso per:",e.id);return}this.savingIds.add(e.id);try{console.log("\u{1F4BE} Salvando utente:",e.email);let i={};t.is_active!==e.is_active&&(i.is_active=e.is_active);let n=new Set(t.ruoli||[]),a=new Set(e.ruoli||[]);(n.size!==a.size||[...n].some(C=>!a.has(C)))&&(i.ruoli=e.ruoli);let c=new Set(t.moduli||[]),w=new Set(e.moduli||[]);if((c.size!==w.size||[...c].some(C=>!w.has(C)))&&(i.moduli=e.moduli),Object.keys(i).length>0){console.log("\u{1F504} Aggiornamenti da salvare:",i);let C=yield this.supa.updateAppUser(e.id,i);if(C.error)throw new Error(C.error.message||"Errore durante l'aggiornamento");console.log("\u2705 Utente aggiornato:",e.email)}else console.log("\u2139\uFE0F Nessun cambiamento da salvare per:",e.email);yield this.refreshRows()}catch(i){console.error("\u274C Errore saveRow:",i),this.error.set(`Errore durante il salvataggio di ${e.email}: ${i.message}`);let n=this.original.get(e.id);if(n){e.ruoli=[...n.ruoli],e.moduli=[...n.moduli],e.is_active=n.is_active;let c=this.rows().map(w=>w.id===e.id?O({},e):w);this.rows.set(c)}setTimeout(()=>this.error.set(null),5e3)}finally{this.savingIds.delete(e.id)}})}getTotalUsers(){return this.rows().length}getAdminUsers(){return this.rows().filter(e=>e.ruoli?.includes("admin")||!1).length}getActiveUsers(){return this.rows().filter(e=>e.is_active===!0).length}getPendingUsers(){return this.rows().filter(e=>e.is_active===!1).length}loadProdotti(){return b(this,null,function*(){try{let e=yield this.supa.getProdotti();if(e.error)throw e.error;let t=e.data??[];console.log("DEBUG getProdotti:",t);let i=t.map(c=>({id:c.id,nome:c.nome,descrizione:c.descrizione??"",categoria:(c.categoria??"")||x[0],prezzo_base:c.prezzo_base??null,attivo:!!c.attivo}));this.prodotti.set(i);let n=t.map(c=>String(c.categoria??"").trim()).filter(Boolean),a=i.map(c=>String(c.categoria??"").trim()).filter(Boolean);this.categories=Array.from(new Set([...x,...n,...a])),console.log("Categorie disponibili:",this.categories)}catch(e){console.error("Errore loadProdotti:",e),this.error.set(e?.message||"Errore caricamento prodotti"),setTimeout(()=>this.error.set(null),4e3)}})}addProdotto(){return b(this,null,function*(){let e=(this.newProdottoName||"").trim();if(e)try{let t={nome:e,descrizione:this.newProdottoDescrizione?this.newProdottoDescrizione:void 0,categoria:this.newProdottoCategoria?this.newProdottoCategoria:void 0,prezzo_base:this.newProdottoPrezzo??void 0,attivo:!0},i=yield this.supa.createProdotto(t);if(i.error)throw i.error;this.newProdottoName="",this.newProdottoDescrizione="",this.newProdottoCategoria=x[0],this.newProdottoPrezzo=null,yield this.loadProdotti()}catch(t){console.error("Errore create prodotto:",t),this.error.set(t?.message||"Errore creazione prodotto"),setTimeout(()=>this.error.set(null),4e3)}})}updateProdottoRow(e){return b(this,null,function*(){if(e.id)try{let t={nome:e.nome,descrizione:e.descrizione?e.descrizione:void 0,categoria:e.categoria?e.categoria:void 0,prezzo_base:e.prezzo_base??void 0,attivo:!!e.attivo},i=yield this.supa.updateProdotto(e.id,t);if(i.error)throw i.error;yield this.loadProdotti()}catch(t){console.error("Errore updateProdottoRow:",t),this.error.set(t?.message||"Errore aggiornamento prodotto"),setTimeout(()=>this.error.set(null),4e3)}})}toggleProdottoAttivo(e){return b(this,null,function*(){try{yield this.supa.updateProdotto(e.id,{attivo:!e.attivo}),yield this.loadProdotti()}catch(t){console.error("Errore toggleProdottoAttivo:",t)}})}removeProdotto(e){return b(this,null,function*(){if(!e){console.warn("removeProdotto chiamato senza id");return}if(confirm("Eliminare il prodotto?"))try{let t=yield this.supa.deleteProdotto(e);if(t.error)throw t.error;yield this.loadProdotti()}catch(t){console.error("Errore deleteProdotto:",t),this.error.set(t?.message||"Errore eliminazione prodotto"),setTimeout(()=>this.error.set(null),4e3)}})}static \u0275fac=function(t){return new(t||d)};static \u0275cmp=I({type:d,selectors:[["app-admin-utenti"]],decls:50,vars:11,consts:[[1,"form-section"],[1,"section-header"],[1,"material-icons","header-icon"],[1,"section-titles"],[1,"section-title"],[1,"text-muted"],["class","status-message loading",4,"ngIf"],["class","status-message error",4,"ngIf"],["class","prospect-cards",4,"ngIf"],["class","table-section",4,"ngIf"],["class","empty-state",4,"ngIf"],[1,"form-section",2,"margin-top","1.25rem"],[1,"table-section"],[2,"display","flex","gap","0.5rem","align-items","center","margin-bottom","0.5rem"],["type","text","placeholder","Nome prodotto",1,"form-field",3,"ngModelChange","ngModel"],["type","text","placeholder","Descrizione",1,"form-field",3,"ngModelChange","ngModel"],[1,"table-inline-select",3,"ngModelChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],["type","number","placeholder","Prezzo base",1,"form-field",3,"ngModelChange","ngModel"],[1,"promethea-button",3,"click"],[1,"table-container"],[1,"crm-table"],[4,"ngFor","ngForOf"],[1,"status-message","loading"],[1,"loading-spinner"],[1,"status-message","error"],[1,"prospect-cards"],[1,"card"],[1,"card-title"],[1,"card-number"],[3,"row-inactive",4,"ngFor","ngForOf"],["data-label","Email"],[1,"cell-content"],["class","text-danger user-pending",4,"ngIf"],["data-label","Stato"],["title","Utente attivo",1,"toggle-switch"],["type","checkbox",3,"change","checked"],[1,"toggle-slider"],[1,"status-label"],["data-label","Admin"],["title","Amministratore",1,"toggle-switch"],["data-label","Moduli"],[1,"cell-content","modules-container"],["class","mod-toggle",4,"ngFor","ngForOf"],["data-label","Azioni"],["type","button",1,"promethea-button",3,"click","disabled"],["class","loading-spinner",4,"ngIf"],["class","material-icons",4,"ngIf"],[1,"text-danger","user-pending"],[1,"mod-toggle"],[1,"chip","mod-chip"],[1,"material-icons"],[1,"empty-state"],[1,"material-icons",2,"font-size","4rem","opacity","0.3","margin-bottom","var(--gutter-md)"],[3,"value"],[1,"table-inline-input",3,"ngModelChange","ngModel"],["type","number",1,"table-inline-input",3,"ngModelChange","ngModel"],[1,"toggle-switch"],["type","checkbox",3,"ngModelChange","ngModel"],[1,"actions-container"],[1,"promethea-button","outline",3,"click"]],template:function(t,i){t&1&&(r(0,"div",0)(1,"div",1)(2,"i",2),l(3,"admin_panel_settings"),o(),r(4,"div",3)(5,"h2",4),l(6,"Gestione Utenti"),o(),r(7,"p",5),l(8,"Amministra utenti, ruoli e permessi del sistema"),o()()(),_(9,Q,3,0,"div",6)(10,X,2,1,"div",7)(11,Y,21,8,"div",8),o(),_(12,oe,17,1,"section",9)(13,re,5,0,"div",10),r(14,"div",11)(15,"div",1)(16,"i",2),l(17,"inventory_2"),o(),r(18,"div",3)(19,"h2",4),l(20,"Prodotti"),o(),r(21,"p",5),l(22,"Aggiungi / attiva / disattiva prodotti disponibili"),o()()(),r(23,"div",12)(24,"div",13)(25,"input",14),P("ngModelChange",function(a){return v(i.newProdottoName,a)||(i.newProdottoName=a),a}),o(),r(26,"input",15),P("ngModelChange",function(a){return v(i.newProdottoDescrizione,a)||(i.newProdottoDescrizione=a),a}),o(),r(27,"select",16),P("ngModelChange",function(a){return v(i.newProdottoCategoria,a)||(i.newProdottoCategoria=a),a}),_(28,ae,2,2,"option",17),o(),r(29,"input",18),P("ngModelChange",function(a){return v(i.newProdottoPrezzo,a)||(i.newProdottoPrezzo=a),a}),o(),r(30,"button",19),M("click",function(){return i.addProdotto()}),l(31,"Aggiungi"),o()(),r(32,"div",20)(33,"table",21)(34,"thead")(35,"tr")(36,"th"),l(37,"Nome"),o(),r(38,"th"),l(39,"Descrizione"),o(),r(40,"th"),l(41,"Categoria"),o(),r(42,"th"),l(43,"Prezzo base"),o(),r(44,"th"),l(45,"Stato"),o(),r(46,"th"),l(47,"Azioni"),o()()(),r(48,"tbody"),_(49,se,20,6,"tr",22),o()()()()()),t&2&&(s(9),m("ngIf",i.loading()),s(),m("ngIf",i.error()),s(),m("ngIf",!i.loading()),s(),m("ngIf",!i.loading()&&!i.error()),s(),m("ngIf",!i.loading()&&!i.error()&&i.rows().length===0),s(12),f("ngModel",i.newProdottoName),s(),f("ngModel",i.newProdottoDescrizione),s(),f("ngModel",i.newProdottoCategoria),s(),m("ngForOf",i.categories),s(),f("ngModel",i.newProdottoPrezzo),s(20),m("ngForOf",i.prodotti()))},dependencies:[W,R,V,J,q,H,B,j,F,$,L,G],styles:['.toggle-switch[_ngcontent-%COMP%]{position:relative;display:inline-block;width:44px;height:24px}.toggle-switch[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{opacity:0;width:0;height:0}.toggle-slider[_ngcontent-%COMP%]{position:absolute;cursor:pointer;inset:0;background-color:var(--smoke-color-1);transition:.3s;border-radius:24px}.toggle-slider[_ngcontent-%COMP%]:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:#fff;transition:.3s;border-radius:50%}.toggle-switch[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:checked + .toggle-slider[_ngcontent-%COMP%]{background:var(--primary)}.toggle-switch[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:checked + .toggle-slider[_ngcontent-%COMP%]:before{transform:translate(20px)}.row-inactive[_ngcontent-%COMP%]{opacity:.6;background:color-mix(in srgb,#ef4444 5%,transparent)!important}.status-label[_ngcontent-%COMP%]{margin-left:var(--gutter-sm);font-size:var(--fs-sm);color:var(--text-muted)}.user-pending[_ngcontent-%COMP%]{display:block;font-style:italic;margin-top:.25rem}.text-danger[_ngcontent-%COMP%]{color:#ef4444!important}.card-highlight[_ngcontent-%COMP%]{border-color:#ef4444!important;animation:_ngcontent-%COMP%_pulse-warning 2s infinite}@keyframes _ngcontent-%COMP%_pulse-warning{0%,to{box-shadow:0 4px 12px var(--shadow)}50%{box-shadow:0 4px 16px color-mix(in srgb,#ef4444 30%,transparent)}}.modules-container[_ngcontent-%COMP%]{flex-wrap:wrap;gap:var(--gutter-sm)}.mod-chip-immagine.selected[_ngcontent-%COMP%]{border-color:var(--primary)!important;background:#0f0f0f!important;color:#fffaf7}.mod-chip-digitalizzazione.selected[_ngcontent-%COMP%]{background:var(--secondary)!important;border-color:var(--primary)!important}.mod-chip-contabilita.selected[_ngcontent-%COMP%]{background:var(--tertiary)!important;border-color:var(--primary)!important}.mod-chip-ottimizzazione.selected[_ngcontent-%COMP%]{background:var(--primary)!important;border-color:var(--secondary)!important}@media (max-width: 768px){.modules-container[_ngcontent-%COMP%]{flex-direction:column;align-items:flex-start}.toggle-switch[_ngcontent-%COMP%]{flex-shrink:0}.status-label[_ngcontent-%COMP%]{margin-left:var(--gutter-sm);font-size:var(--fs-sm)}}.form-section[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .crm-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]:nth-child(2), .form-section[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .crm-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:nth-child(2){width:30%;min-width:240px}.form-section[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .crm-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]:nth-child(1), .form-section[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .crm-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:nth-child(1){width:15%;max-width:6.5rem}.form-section[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .crm-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]:nth-child(4), .form-section[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .crm-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]:nth-child(4){width:15%;max-width:6.5rem}.form-section[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .crm-table[_ngcontent-%COMP%]   .table-inline-input[_ngcontent-%COMP%], .form-section[_ngcontent-%COMP%]   .table-container[_ngcontent-%COMP%]   .crm-table[_ngcontent-%COMP%]   .table-inline-select[_ngcontent-%COMP%]{width:100%;box-sizing:border-box}']})};export{K as AdminUtenti};
