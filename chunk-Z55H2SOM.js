import{a as Q}from"./chunk-B2TAGDN2.js";import{a as ee}from"./chunk-T2RYCGX3.js";import{a as X}from"./chunk-WXMXMCHO.js";import{a as Z}from"./chunk-JHFRRPN6.js";import{a as J}from"./chunk-5STMSNPF.js";import{a as Y,c as K,e as j,j as q,k as H,n as W}from"./chunk-RG37TT4Q.js";import{a as G}from"./chunk-PBTFW77J.js";import"./chunk-QQWCK2ZL.js";import{e as B}from"./chunk-7BQHTMQB.js";import{j as A,k as $,p as U}from"./chunk-VUYFDMJB.js";import{A as T,Bb as N,Ga as V,I as L,La as f,S as x,Wa as M,X as u,Xa as d,Y as g,Ya as i,Za as n,_a as I,cb as F,db as O,eb as C,f as y,fa as E,hb as _,ib as m,jb as b,lb as S,nb as a,ob as v,pb as w,rb as D,sb as R,ta as k,tb as z,ua as l,x as P}from"./chunk-CVFHM34U.js";import"./chunk-X5YLR3NI.js";import{i as h}from"./chunk-ODN5LVDJ.js";function ie(o,e){if(o&1&&(i(0,"option",41),a(1),n()),o&2){let t=e.$implicit;d("value",t),l(),v(t)}}function ne(o,e){if(o&1&&(i(0,"option",41),a(1),n()),o&2){let t=e.$implicit;d("value",t),l(),v(t)}}function re(o,e){if(o&1&&(i(0,"span"),a(1),n()),o&2){let t=m().$implicit;l(),v(t.comune)}}function ae(o,e){if(o&1&&(i(0,"span"),a(1),n()),o&2){let t=m().$implicit;l(),w(" (",t.provincia,")")}}function oe(o,e){o&1&&(i(0,"span",64),a(1," Nessun indirizzo "),n())}function le(o,e){o&1&&(i(0,"span",65),a(1,"S\xEC"),n())}function se(o,e){o&1&&(i(0,"span",66),a(1,"No"),n())}function ce(o,e){if(o&1&&(F(0),i(1,"span"),a(2),n(),O()),o&2){let t=e.ngIf;l(2),v(t.tipo)}}function de(o,e){o&1&&a(0,"\u2014")}function pe(o,e){if(o&1){let t=C();i(0,"button",67),_("click",function(s){u(t);let p=m().$implicit,c=m();return s.stopPropagation(),g(c.vediConfigurazionePromethea(p))}),I(1,"img",68),n()}}function me(o,e){if(o&1){let t=C();i(0,"button",69),_("click",function(s){u(t);let p=m().$implicit,c=m();return s.stopPropagation(),g(c.vediTrattativaYuvi(p))}),I(1,"img",70),n()}}function ue(o,e){if(o&1){let t=C();i(0,"div",71)(1,"div",72)(2,"button",73),_("click",function(s){u(t);let p=m().$implicit,c=m();return s.stopPropagation(),c.onEdit(p),g(c.activeDropdownId=null)}),i(3,"span",20),a(4,"edit"),n(),i(5,"span"),a(6,"Modifica"),n()(),i(7,"button",73),_("click",function(s){u(t);let p=m().$implicit,c=m();return s.stopPropagation(),c.openEsito(p),g(c.activeDropdownId=null)}),i(8,"span",20),a(9,"add"),n(),i(10,"span"),a(11,"Aggiungi esito"),n()(),i(12,"button",74),_("click",function(s){u(t);let p=m().$implicit,c=m();return s.stopPropagation(),c.onDelete(p),g(c.activeDropdownId=null)}),i(13,"span",20),a(14,"delete"),n(),i(15,"span"),a(16,"Elimina"),n()()()()}if(o&2){let t=m().$implicit,r=m();l(12),d("disabled",r.deletingIds.has(t.id))}}function ge(o,e){if(o&1){let t=C();i(0,"tr")(1,"td",42)(2,"div",43)(3,"strong"),a(4),n()()(),i(5,"td",44)(6,"div",43),a(7),n()(),i(8,"td",45)(9,"div",43),a(10),n()(),i(11,"td",46)(12,"div",43),f(13,re,2,1,"span",37)(14,ae,2,1,"span",37)(15,oe,2,0,"span",47),n()(),i(16,"td",48)(17,"div",43)(18,"select",49,3),_("change",function(){let s=u(t).$implicit,p=b(19),c=m();return g(c.onChangeProdotto(s,p.value))}),i(20,"option",50),a(21,"Promethea"),n(),i(22,"option",51),a(23,"YUVI"),n()()()(),i(24,"td",52)(25,"div",43),f(26,le,2,0,"span",53)(27,se,2,0,"span",54),n()(),i(28,"td",55)(29,"div",43),f(30,ce,3,1,"ng-container",56)(31,de,1,0,"ng-template",null,4,N),n()(),i(33,"td",57)(34,"div",58),f(35,pe,2,0,"button",59)(36,me,2,0,"button",60),i(37,"div",61)(38,"button",62),_("click",function(s){let p=u(t).$implicit,c=m();return s.stopPropagation(),g(c.toggleActionsDropdown(p.id))}),i(39,"span",20),a(40,"more_vert"),n()(),f(41,ue,17,1,"div",63),n()()()()}if(o&2){let t=e.$implicit,r=b(32),s=m();M("data-row-id",t.id),l(4),v(t.ragione_sociale),l(3),v(t.referente||"\u2014"),l(3),v(t.telefono||"\u2014"),l(3),d("ngIf",t.comune),l(),d("ngIf",t.provincia),l(),d("ngIf",!t.comune&&!t.provincia),l(3),d("value",t.prodotto)("disabled",s.updatingProdottoIds.has(t.id)),l(8),d("ngIf",t.configurato),l(),d("ngIf",!t.configurato),l(3),d("ngIf",t.ultimoEsito)("ngIfElse",r),l(5),d("ngIf",t.hasConfigPromethea),l(),d("ngIf",t.hasTrattativaYuvi),l(),S("open",s.activeDropdownId===t.id),l(4),d("ngIf",s.activeDropdownId===t.id)}}function _e(o,e){if(o&1&&(i(0,"tr")(1,"td",75),a(2),n()()),o&2){let t=m();l(2),w(" ",t.searchTerm?"Nessun cliente trovato":"Nessun cliente"," ")}}function fe(o,e){o&1&&(i(0,"span",20),a(1,"expand_more"),n())}function ve(o,e){o&1&&(i(0,"span",20),a(1,"hourglass_bottom"),n())}function he(o,e){if(o&1){let t=C();i(0,"div",76)(1,"button",77),_("click",function(){u(t);let s=m();return g(s.loadMore())}),f(2,fe,2,0,"span",78)(3,ve,2,0,"span",78),a(4),n()()}if(o&2){let t=m();l(),d("disabled",t.loading()),l(),d("ngIf",!t.loading()),l(),d("ngIf",t.loading()),l(),w(" ",t.loading()?"Caricamento\u2026":"Carica altri"," ")}}function Ce(o,e){if(o&1&&(i(0,"div",79),a(1),n()),o&2){let t=m();l(),w(" ",t.error()," ")}}var te=class o{listaService=x(X);soggettiService=x(G);kpiService=x(Q);router=x(B);searchSubject=new y;destroy$=new y;rows=this.listaService.rows;filteredRows=this.listaService.filteredRows;loading=this.listaService.loading;error=this.listaService.error;hasMore=this.listaService.hasMore;currentFiltri=this.listaService.currentFiltri;province=E([]);kpi=E({totale:0,conIban:0,conReferente:0});deletingIds=new Set;showEsito=!1;selectedId=null;updatingProdottoIds=new Set;activeDropdownId=null;esitiTipi=Z;searchTerm="";filtroConIban=!1;filtroConReferente=!1;isLoading=E(!0);constructor(){this.searchSubject.pipe(L(this.destroy$),P(300),T()).subscribe(e=>{this.onSearchExecuted(e)})}ngOnInit(){return h(this,null,function*(){this.listaService.inizializza({tipo:"cliente",abilitaConfigurazioni:!0,abilitaTrattative:!0});try{yield Promise.all([this.listaService.caricaAltri(!0),this.loadProvince(),this.refreshKpi()])}finally{setTimeout(()=>{this.isLoading.set(!1)},300)}})}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}loadMore(e=!1){return h(this,null,function*(){yield this.listaService.caricaAltri(e)})}onSearchExecuted(e){return h(this,null,function*(){yield this.listaService.cerca(e)})}onSearchChange(e){this.searchTerm=e,this.searchSubject.next(e)}onChangeFiltroEsito(e){this.listaService.applicaFiltri({esito:e,conIban:this.filtroConIban,conReferente:this.filtroConReferente})}onChangeFiltroProvincia(e){this.listaService.applicaFiltri({provincia:e})}onChangeSortDir(e){this.listaService.applicaFiltri({sortDir:e})}onFiltroTotale(){this.filtroConIban=!1,this.filtroConReferente=!1,this.listaService.applicaFiltri({esito:"tutti",provincia:"tutte",conIban:!1,conReferente:!1})}onFiltroConIban(){this.filtroConIban=!0,this.filtroConReferente=!1,this.listaService.applicaFiltri({esito:"tutti",conIban:!0,conReferente:!1})}onFiltroConReferente(){this.filtroConIban=!1,this.filtroConReferente=!0,this.listaService.applicaFiltri({esito:"tutti",conIban:!1,conReferente:!0})}vediConfigurazionePromethea(e){this.router.navigate(["/alchemizzatore"],{queryParams:{prospectId:e.id,step:6},state:{prospect:e,goToStep:6,from:"lista-clienti"}})}vediTrattativaYuvi(e){return h(this,null,function*(){try{let{data:t,error:r}=yield this.soggettiService.supabaseService.supabase.from("trattative_yuvi").select("*").eq("prospect_id",e.id).order("created_at",{ascending:!1}).limit(1).single();if(r)throw r;if(!t){alert("Nessuna trattativa YUVI trovata per questo cliente");return}this.router.navigate(["/yuvi-trattativa"],{queryParams:{clienteId:e.id,trattativaId:t.id},state:{cliente:e,trattativaEsistente:t}})}catch(t){alert("Errore nel caricamento della trattativa: "+t.message)}})}onDelete(e){return h(this,null,function*(){if(!(!e?.id||!confirm(`Eliminare il cliente "${e.ragione_sociale}"?`))){this.deletingIds.add(e.id);try{(yield this.listaService.eliminaSoggetto(e.id))&&(yield this.refreshKpi())}catch(r){console.error("Errore durante l'eliminazione:",r)}finally{this.deletingIds.delete(e.id)}}})}onEdit(e){e?.id&&this.router.navigate(["/soggetti/modifica",e.id])}openEsito(e){this.selectedId=e.id,this.showEsito=!0}onPopupClosed(e){return h(this,null,function*(){this.showEsito=!1,this.selectedId=null,e.saved&&(yield Promise.all([this.listaService.caricaAltri(!0),this.refreshKpi()]))})}onChangeProdotto(e,t){return h(this,null,function*(){if(!e?.id)return;let r=t;if(e.prodotto!==r){this.updatingProdottoIds.add(e.id);try{yield this.listaService.aggiornaProdotto(e.id,r)}catch(s){console.error("Errore durante l'aggiornamento del prodotto:",s)}finally{this.updatingProdottoIds.delete(e.id)}}})}trackById=(e,t)=>t.id;toggleActionsDropdown(e){let t=this.activeDropdownId===e;this.activeDropdownId=t?null:e;let r=document.querySelector(".table-container");r&&(this.activeDropdownId?r.classList.add("dropdown-open"):r.classList.remove("dropdown-open"))}closeDropdown(e){e.target.closest(".actions-dropdown")||(this.activeDropdownId=null)}loadProvince(){return h(this,null,function*(){let{data:e}=yield this.soggettiService.getProvinceByTipo("cliente");e&&this.province.set(e)})}refreshKpi(){return h(this,null,function*(){try{let e=yield this.kpiService.getAnagraficaKPI("cliente");this.kpi.set({totale:e.totale,conIban:e.conIban,conReferente:e.conReferente})}catch(e){console.error("Errore nel caricamento KPI:",e)}})}getLastEsito(e){return!Array.isArray(e)||e.length===0?null:e.reduce((t,r)=>{let s=new Date(r.ts).getTime(),p=new Date(t.ts).getTime();return s>p?r:t})}static \u0275fac=function(t){return new(t||o)};static \u0275cmp=V({type:o,selectors:[["app-lista-clienti"]],hostBindings:function(t,r){t&1&&_("click",function(p){return r.closeDropdown(p)},k)},decls:94,vars:26,consts:[["filtroSel",""],["ordinaSel",""],["provSel",""],["sel",""],["noEsito",""],["title","Caricamento Clienti","subtitle","Stiamo caricando i tuoi clienti...",3,"isLoading"],[1,"form-section"],[1,"section-header"],[1,"material-icons","header-icon"],[1,"section-titles"],[1,"section-title"],[1,"sottotitolo"],[1,"prospect-cards"],[1,"card",3,"click"],[1,"card-title"],[1,"card-number"],[1,"table-section"],[1,"table-tools"],[1,"tool"],["for","search",1,"label"],[1,"material-icons"],["id","search","type","text","placeholder","Nome, telefono, email...",1,"table-inline-input",3,"ngModelChange","ngModel"],["for","filtroEsito",1,"label"],["id","filtroEsito",1,"table-inline-select",3,"change","value"],["value","tutti"],["value","senza-esito"],[3,"value",4,"ngFor","ngForOf"],["for","ordinaPer",1,"label"],["id","ordinaPer",1,"table-inline-select",3,"change","value"],["value","desc"],["value","asc"],["for","filtroProvincia",1,"label"],["id","filtroProvincia",1,"table-inline-select",3,"change","value"],["value","tutte"],[1,"table-container"],[1,"crm-table"],[4,"ngFor","ngForOf","ngForTrackBy"],[4,"ngIf"],["class","load-more-container",4,"ngIf"],["style","text-align:center; color:#ef4444; margin-top:1rem;",4,"ngIf"],[3,"closed","open","soggettoId","tipo"],[3,"value"],["data-label","Ragione Sociale"],[1,"cell-content"],["data-label","Referente"],["data-label","Telefono"],["data-label","Localit\xE0"],["style","color: #6b7280; font-style: italic;",4,"ngIf"],["data-label","Prodotto"],[1,"table-inline-select",3,"change","value","disabled"],["value","Promethea"],["value","YUVI"],["data-label","Configurato"],["class","badge badge-success",4,"ngIf"],["class","badge badge-danger",4,"ngIf"],["data-label","Ultimo Esito"],[4,"ngIf","ngIfElse"],["data-label","Azioni"],[1,"actions-container"],["class","action-btn document","title","Configurazione Promethea",3,"click",4,"ngIf"],["class","action-btn email","title","Trattativa YUVI",3,"click",4,"ngIf"],[1,"actions-dropdown"],["title","Altre azioni",1,"action-btn",3,"click"],["class","modal","style",`position: absolute; top: calc(100% + 8px); right: 0; 
                            width: 180px; transform: none; left: auto; 
                            max-height: none; overflow: visible;`,4,"ngIf"],[2,"color","#6b7280","font-style","italic"],[1,"badge","badge-success"],[1,"badge","badge-danger"],["title","Configurazione Promethea",1,"action-btn","document",3,"click"],["src","assets/Logo.png","alt","Promethea",1,"icon-img"],["title","Trattativa YUVI",1,"action-btn","email",3,"click"],["src","assets/yuvi.png","alt","YUVI",1,"icon-img"],[1,"modal",2,"position","absolute","top","calc(100% + 8px)","right","0","width","180px","transform","none","left","auto","max-height","none","overflow","visible"],[1,"modal-body",2,"padding","0"],[1,"dropdown-item",3,"click"],[1,"dropdown-item",2,"color","#ef4444",3,"click","disabled"],["colspan","8",2,"text-align","center","padding","1.5rem"],[1,"load-more-container"],[1,"promethea-button",3,"click","disabled"],["class","material-icons",4,"ngIf"],[2,"text-align","center","color","#ef4444","margin-top","1rem"]],template:function(t,r){if(t&1){let s=C();I(0,"app-page-loader",5),i(1,"div")(2,"div",6)(3,"div",7)(4,"i",8),a(5,"business"),n(),i(6,"div",9)(7,"h2",10),a(8,"Clienti"),n(),i(9,"p",11),a(10,"Panoramica clienti e filtri rapidi"),n()()(),i(11,"div",12)(12,"div",13),_("click",function(){return u(s),g(r.onFiltroTotale())}),i(13,"h3",14),a(14,"Totale"),n(),i(15,"div",15),a(16),n()(),i(17,"div",13),_("click",function(){return u(s),g(r.onFiltroConIban())}),i(18,"h3",14),a(19,"Con IBAN"),n(),i(20,"div",15),a(21),n()(),i(22,"div",13),_("click",function(){return u(s),g(r.onFiltroConReferente())}),i(23,"h3",14),a(24,"Con Referente"),n(),i(25,"div",15),a(26),n()()()(),i(27,"section",16)(28,"div",17)(29,"div",18)(30,"label",19)(31,"span",20),a(32,"search"),n(),a(33," Cerca "),n(),i(34,"input",21),z("ngModelChange",function(c){return u(s),R(r.searchTerm,c)||(r.searchTerm=c),g(c)}),_("ngModelChange",function(c){return u(s),g(r.onSearchChange(c))}),n()(),i(35,"div",18)(36,"label",22)(37,"span",20),a(38,"filter_list"),n(),a(39," Ultimo esito "),n(),i(40,"select",23,0),_("change",function(){u(s);let c=b(41);return g(r.onChangeFiltroEsito(c.value))}),i(42,"option",24),a(43,"Tutti"),n(),i(44,"option",25),a(45,"Senza esito"),n(),f(46,ie,2,2,"option",26),n()(),i(47,"div",18)(48,"label",27)(49,"span",20),a(50,"sort"),n(),a(51," Ordina per: "),n(),i(52,"select",28,1),_("change",function(){u(s);let c=b(53);return g(r.onChangeSortDir(c.value))}),i(54,"option",29),a(55,"Pi\xF9 recente"),n(),i(56,"option",30),a(57,"Meno recente"),n()()(),i(58,"div",18)(59,"label",31)(60,"span",20),a(61,"place"),n(),a(62," Provincia "),n(),i(63,"select",32,2),_("change",function(){u(s);let c=b(64);return g(r.onChangeFiltroProvincia(c.value))}),i(65,"option",33),a(66,"Tutte"),n(),f(67,ne,2,2,"option",26),n()()(),i(68,"div",34)(69,"table",35)(70,"thead")(71,"tr")(72,"th"),a(73,"Ragione Sociale"),n(),i(74,"th"),a(75,"Referente"),n(),i(76,"th"),a(77,"Telefono"),n(),i(78,"th"),a(79,"Localit\xE0"),n(),i(80,"th"),a(81,"Prodotto"),n(),i(82,"th"),a(83,"Configurato"),n(),i(84,"th"),a(85,"Ultimo Esito"),n(),i(86,"th"),a(87,"Azioni"),n()()(),i(88,"tbody"),f(89,ge,42,18,"tr",36)(90,_e,3,1,"tr",37),n()()(),f(91,he,5,4,"div",38)(92,Ce,2,1,"div",39),n(),i(93,"app-esito-popup",40),_("closed",function(c){return u(s),g(r.onPopupClosed(c))}),n()()}t&2&&(d("isLoading",r.isLoading()),l(),S("hidden",r.isLoading()),l(11),S("card-active",r.currentFiltri().esito==="tutti"&&r.currentFiltri().provincia==="tutte"&&!r.currentFiltri().conIban&&!r.currentFiltri().conReferente),l(4),v(r.kpi().totale),l(),S("card-active",r.currentFiltri().conIban),l(4),v(r.kpi().conIban),l(),S("card-active",r.currentFiltri().conReferente),l(4),v(r.kpi().conReferente),l(8),D("ngModel",r.searchTerm),l(6),d("value",r.currentFiltri().esito),l(6),d("ngForOf",r.esitiTipi),l(6),d("value",r.currentFiltri().sortDir),l(11),d("value",r.currentFiltri().provincia),l(4),d("ngForOf",r.province()),l(22),d("ngForOf",r.filteredRows())("ngForTrackBy",r.trackById),l(),d("ngIf",!r.loading()&&!r.error()&&r.filteredRows().length===0),l(),d("ngIf",!r.error()&&r.hasMore()),l(),d("ngIf",r.error()),l(),d("open",r.showEsito)("soggettoId",r.selectedId)("tipo","cliente"))},dependencies:[U,A,$,ee,W,q,H,Y,K,j,J],styles:[".actions-dropdown[_ngcontent-%COMP%]{position:relative;display:inline-flex}.table-container[_ngcontent-%COMP%]{overflow:visible}.dropdown-item[_ngcontent-%COMP%]{width:100%;display:flex;align-items:center;gap:var(--gutter-sm);padding:.75rem 1rem;border:none;background:transparent;color:var(--text-color);cursor:pointer;transition:background .15s ease;font-size:var(--fs-sm);text-align:left;border-bottom:1px solid var(--smoke-color-1)}.dropdown-item[_ngcontent-%COMP%]:last-child{border-bottom:none}.dropdown-item[_ngcontent-%COMP%]:hover{background:var(--smoke-color-2)}.dropdown-item[_ngcontent-%COMP%]:disabled{opacity:.4;cursor:not-allowed}.dropdown-item[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:1rem}@container (max-width: 768px){.crm-table[_ngcontent-%COMP%]   td[data-label=Azioni][_ngcontent-%COMP%]   .actions-dropdown[_ngcontent-%COMP%]   .modal[_ngcontent-%COMP%]{position:static!important;width:100%!important;transform:none!important;box-shadow:none!important;border:1px solid var(--smoke-color-1)!important;border-radius:12px!important;margin-top:var(--gutter-sm)!important}.crm-table[_ngcontent-%COMP%]   td[data-label=Azioni][_ngcontent-%COMP%]   .actions-container[_ngcontent-%COMP%]{flex-direction:column;align-items:stretch}.crm-table[_ngcontent-%COMP%]   td[data-label=Azioni][_ngcontent-%COMP%]   .actions-dropdown[_ngcontent-%COMP%]{width:100%}}"]})};export{te as ListaClienti};
