import{c as ne,d as v}from"./chunk-CZQHU2W7.js";import{b as U,c as b,d as H,e as J,g as K,j as Q,m as W,n as X,o as Y,p as Z,t as ee,v as te}from"./chunk-Z6GIDEG7.js";import{b as ie}from"./chunk-H4JMM7IJ.js";import{d as z,e as G,g as j,j as L}from"./chunk-PJ4DYJTI.js";import{Aa as C,Bb as O,Ga as F,Gb as $,La as d,Na as k,Wa as p,X as E,Xa as o,Y as h,Ya as n,Za as u,bb as R,cb as q,db as P,ea as c,ga as D,gb as x,hb as m,ib as A,mb as r,nb as g,ob as f,pb as B,ua as a,yb as w,zb as N}from"./chunk-R5VHGKSY.js";import{i as _}from"./chunk-ODN5LVDJ.js";function se(t,i){if(t&1){let e=P();o(0,"div",4),x("click",function(){E(e);let s=m();return h(s.close())}),n()}}function le(t,i){if(t&1&&(o(0,"div",38),r(1),n()),t&2){let e=m().$implicit;a(),g(e.note)}}function pe(t,i){if(t&1&&(o(0,"div",39)(1,"span",9),r(2,"event"),n(),o(3,"span"),r(4),w(5,"date"),n()()),t&2){let e=m().$implicit;a(4),f("Programmato: ",N(5,1,e.scheduleAt,"short"))}}function de(t,i){if(t&1&&(o(0,"div",39)(1,"span",9),r(2,"schedule"),n(),o(3,"span"),r(4),n()()),t&2){let e=m().$implicit;a(4),B("Appuntamento: ",e.dataAppuntamento," alle ",e.oraAppuntamento)}}function me(t,i){if(t&1&&(o(0,"div",32)(1,"div",33)(2,"span",34),r(3),n(),o(4,"span",35),r(5),w(6,"date"),n()(),d(7,le,2,1,"div",36)(8,pe,6,4,"div",37)(9,de,5,2,"div",37),n()),t&2){let e=i.$implicit;a(3),g(e.tipo),a(2),g(N(6,5,e.ts,"short")),a(2),p("ngIf",e.note),a(),p("ngIf",e.scheduleAt),a(),p("ngIf",e.dataAppuntamento&&e.oraAppuntamento)}}function ce(t,i){t&1&&(o(0,"div",40),r(1,"Nessun esito"),n())}function ue(t,i){if(t&1&&(o(0,"div",29),d(1,me,10,8,"div",30)(2,ce,2,0,"div",31),n()),t&2){let e=m(2);a(),p("ngForOf",e.esiti()),a(),p("ngIf",e.esiti().length===0)}}function ge(t,i){t&1&&(o(0,"div",40),r(1,"Caricamento\u2026"),n())}function fe(t,i){if(t&1&&(R(0),u(1,"input",41),q()),t&2){let e=m(2);a(),p("value",e.currentReferente())}}function ve(t,i){t&1&&u(0,"input",42)}function _e(t,i){if(t&1&&(o(0,"option",43),r(1),n()),t&2){let e=i.$implicit;p("value",e),a(),g(e)}}function Ee(t,i){t&1&&(o(0,"small",44),r(1,"Campo obbligatorio"),n())}function he(t,i){t&1&&(o(0,"small",44),r(1,"La data \xE8 obbligatoria"),n())}function xe(t,i){t&1&&(o(0,"small",44),r(1,"L'orario \xE8 obbligatorio"),n())}function Se(t,i){if(t&1&&(o(0,"div",45)(1,"label",17)(2,"span",15)(3,"span",9),r(4,"event"),n(),r(5),n(),u(6,"input",46),d(7,he,2,0,"small",21),n(),o(8,"label",17)(9,"span",15)(10,"span",9),r(11,"schedule"),n(),r(12),n(),u(13,"input",47),d(14,xe,2,0,"small",21),n()()),t&2){let e,l,s=m(2);a(5),f(" ",((e=s.form.get("tipo"))==null?null:e.value)==="Richiamare"?"Data richiamo":"Data appuntamento"," * "),a(),p("min",s.getTodayDate()),a(),p("ngIf",s.hasError("dataAppuntamento","required")),a(5),f(" ",((l=s.form.get("tipo"))==null?null:l.value)==="Richiamare"?"Ora richiamo":"Ora appuntamento"," * "),a(2),p("ngIf",s.hasError("oraAppuntamento","required"))}}function Ie(t,i){t&1&&(o(0,"span",9),r(1,"add"),n())}function ye(t,i){t&1&&(o(0,"span",48),r(1,"hourglass_bottom"),n())}function be(t,i){if(t&1&&(o(0,"div",44),r(1),n()),t&2){let e=m(2);a(),g(e.error())}}function Te(t,i){if(t&1){let e=P();o(0,"div",5)(1,"header",6)(2,"h2",7),r(3),n(),o(4,"button",8),x("click",function(){E(e);let s=m();return h(s.close())}),o(5,"span",9),r(6,"close"),n()()(),o(7,"section",10),d(8,ue,3,2,"div",11)(9,ge,2,0,"ng-template",null,0,O),u(11,"div",12),o(12,"form",13),x("ngSubmit",function(){E(e);let s=m();return h(s.save())}),o(13,"label",14)(14,"span",15)(15,"span",9),r(16,"person"),n(),r(17," Referente"),n(),d(18,fe,2,1,"ng-container",16)(19,ve,1,0,"ng-template",null,1,O),n(),o(21,"label",17)(22,"span",15)(23,"span",9),r(24,"category"),n(),r(25," Tipologia"),n(),o(26,"select",18)(27,"option",19),r(28,"\u2014 Seleziona \u2014"),n(),d(29,_e,2,2,"option",20),n(),d(30,Ee,2,0,"small",21),n(),d(31,Se,15,5,"div",22),o(32,"label",14)(33,"span",15)(34,"span",9),r(35,"notes"),n(),r(36," Note"),n(),u(37,"textarea",23),n(),o(38,"div",24)(39,"button",25),x("click",function(){E(e);let s=m();return h(s.close())}),o(40,"span",9),r(41,"close"),n(),r(42," Annulla "),n(),o(43,"button",26),d(44,Ie,2,0,"span",27)(45,ye,2,0,"span",28),r(46),n()()(),d(47,be,2,1,"div",21),n()()}if(t&2){let e=A(10),l=A(20),s=m();a(3),f("Esiti ",s.tipo),a(5),p("ngIf",!s.loading())("ngIfElse",e),a(4),p("formGroup",s.form),a(6),p("ngIf",s.currentReferente())("ngIfElse",l),a(11),p("ngForOf",s.esitiTipi),a(),p("ngIf",s.hasError("tipo","required")),a(),p("ngIf",s.requireSchedule()),a(12),p("disabled",s.saving()||s.form.invalid),a(),p("ngIf",!s.saving()),a(),p("ngIf",s.saving()),a(),f(" ",s.saving()?"Salvataggio...":"Aggiungi esito"," "),a(),p("ngIf",s.error())}}var oe=class t{constructor(i,e){this.fb=i;this.soggettiService=e;this.form=this.fb.group({tipo:["",b.required],note:[""],dataAppuntamento:[""],oraAppuntamento:[""],referente:[""]}),this.form.get("tipo")?.valueChanges.subscribe(l=>{this.selectedTipo.set(l),this.updateValidators(l)})}open=!1;soggettoId;tipo;closed=new k;esiti=c([]);loading=c(!1);saving=c(!1);error=c(null);currentReferente=c(null);form;esitiTipi=ne;selectedTipo=c("");requireSchedule=$(()=>{let i=this.selectedTipo();return i!==""&&v.includes(i)});updateValidators(i){let e=this.form.get("dataAppuntamento"),l=this.form.get("oraAppuntamento");i!==""&&v.includes(i)?(e?.setValidators([b.required]),l?.setValidators([b.required])):(e?.clearValidators(),l?.clearValidators(),e?.reset(""),l?.reset("")),e?.updateValueAndValidity({emitEvent:!1}),l?.updateValueAndValidity({emitEvent:!1}),this.form.updateValueAndValidity({emitEvent:!1})}ngOnChanges(i){return _(this,null,function*(){if(i.open&&this.open&&this.soggettoId){yield Promise.all([this.loadEsiti(),this.loadAnagrafica()]);let e=this.form.get("tipo")?.value;this.selectedTipo.set(e),this.updateValidators(e)}i.open&&!this.open&&(this.form.reset(),this.selectedTipo.set(""),this.currentReferente.set(null))})}loadAnagrafica(){return _(this,null,function*(){try{let{data:i,error:e}=yield this.soggettiService.getSoggettoById(this.soggettoId);!e&&i&&this.currentReferente.set(i.referente??null)}catch{}})}loadEsiti(){return _(this,null,function*(){this.loading.set(!0),this.error.set(null);try{let i=yield this.soggettiService.getEsitiBySoggetto(this.soggettoId);if(i.error)throw new Error(i.error.message||"Errore nel caricamento esiti");this.esiti.set(i.data??[])}catch(i){this.error.set(i?.message||"Errore nel caricamento esiti")}finally{this.loading.set(!1)}})}save(){return _(this,null,function*(){if(this.form.markAllAsTouched(),this.form.invalid||this.saving())return;let{tipo:i,note:e,dataAppuntamento:l,oraAppuntamento:s,referente:re}=this.form.value;if(!i){this.error.set("Seleziona un tipo di esito");return}let S=i,T=re?.trim()??"",V=null;v.includes(S)&&l&&s&&(V=new Date(`${l}T${s}`).toISOString());let ae=!this.currentReferente()&&T.length>0;this.saving.set(!0),this.error.set(null);try{if(ae){let y=yield this.soggettiService.updateSoggetto({id:this.soggettoId,referente:T});if(!y.success)throw new Error(y.error||"Errore aggiornamento referente");this.currentReferente.set(T)}let I={tipo:S,note:e||null,ts:new Date().toISOString(),scheduleAt:V,dataAppuntamento:v.includes(S)?l:null,oraAppuntamento:v.includes(S)?s:null},M=yield this.soggettiService.appendEsito(this.soggettoId,I);if(!M.success)throw new Error(M.error||"Errore salvataggio esito");this.esiti.update(y=>[...y,I]),this.form.reset(),this.selectedTipo.set(""),this.close(!0)}catch(I){this.error.set(I?.message||"Errore nel salvataggio")}finally{this.saving.set(!1)}})}close(i=!1){this.closed.emit({saved:i})}hasError(i,e){let l=this.form.get(i);return!!(l&&l.touched&&l.hasError(e))}getTodayDate(){return new Date().toISOString().split("T")[0]}static \u0275fac=function(e){return new(e||t)(C(ee),C(ie))};static \u0275cmp=F({type:t,selectors:[["app-esito-popup"]],inputs:{open:"open",soggettoId:"soggettoId",tipo:"tipo"},outputs:{closed:"closed"},features:[D],decls:2,vars:2,consts:[["loadingTpl",""],["referenteInput",""],["class","modal-backdrop",3,"click",4,"ngIf"],["class","modal","role","dialog","aria-modal","true",4,"ngIf"],[1,"modal-backdrop",3,"click"],["role","dialog","aria-modal","true",1,"modal"],[1,"modal-header"],[1,"modal-title"],["aria-label","Chiudi",1,"icon-btn",3,"click"],[1,"material-icons"],[1,"modal-body"],["class","esiti-list",4,"ngIf","ngIfElse"],[1,"divider"],[1,"form-grid",3,"ngSubmit","formGroup"],[1,"form-field","form-field-col-span"],[1,"form-label"],[4,"ngIf","ngIfElse"],[1,"form-field"],["formControlName","tipo"],["value",""],[3,"value",4,"ngFor","ngForOf"],["class","error",4,"ngIf"],["class","field-group",4,"ngIf"],["rows","3","formControlName","note","placeholder","Aggiungi note..."],[1,"actions-container"],["type","button",1,"promethea-button","ghost",3,"click"],["type","submit",1,"promethea-button",3,"disabled"],["class","material-icons",4,"ngIf"],["class","material-icons spinning",4,"ngIf"],[1,"esiti-list"],["class","esito-item",4,"ngFor","ngForOf"],["class","empty-state",4,"ngIf"],[1,"esito-item"],[1,"esito-top"],[1,"chip"],[1,"esito-ts"],["class","esito-note",4,"ngIf"],["class","esito-schedule",4,"ngIf"],[1,"esito-note"],[1,"esito-schedule"],[1,"empty-state"],["type","text","disabled","",3,"value"],["type","text","formControlName","referente","placeholder","Inserisci il referente"],[3,"value"],[1,"error"],[1,"field-group"],["type","date","formControlName","dataAppuntamento",3,"min"],["type","time","formControlName","oraAppuntamento"],[1,"material-icons","spinning"]],template:function(e,l){e&1&&d(0,se,1,0,"div",2)(1,Te,48,14,"div",3),e&2&&(p("ngIf",l.open),a(),p("ngIf",l.open))},dependencies:[L,z,G,te,K,Y,Z,U,X,H,J,Q,W,j],styles:[".esiti-list[_ngcontent-%COMP%]{display:grid;gap:var(--gutter-sm);margin-bottom:var(--gutter-lg)}.esito-item[_ngcontent-%COMP%]{border:1px solid var(--smoke-color-1);border-radius:12px;padding:var(--gutter-sm) var(--gutter-lg);background:var(--background);transition:all .2s ease}.esito-item[_ngcontent-%COMP%]:hover{border-color:var(--primary);box-shadow:0 2px 8px var(--shadow)}.esito-top[_ngcontent-%COMP%]{display:flex;gap:var(--gutter-sm);align-items:center;justify-content:space-between}.esito-ts[_ngcontent-%COMP%]{opacity:.8;font-size:.9em;color:var(--text-color)}.esito-note[_ngcontent-%COMP%]{margin-top:.5rem;color:var(--text-color);line-height:1.4}.esito-schedule[_ngcontent-%COMP%]{margin-top:.5rem;display:inline-flex;gap:.4rem;align-items:center;color:var(--primary);font-size:var(--fs-sm)}.esito-schedule[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:1rem}.field-group[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr 1fr;gap:var(--gutter-sm);margin:var(--gutter-sm) 0;width:100%}"]})};export{oe as a};
