import{a as M}from"./chunk-B2PGE4B5.js";import{e as O}from"./chunk-LOD6TMDG.js";import{j as T,k as z,m as R,p as L,v as D}from"./chunk-67GYVHNT.js";import{Aa as f,Ga as b,La as u,Xa as p,Ya as e,Za as t,_a as y,hb as h,ib as I,mb as i,nb as m,ua as r,vb as k,xb as C,zb as P}from"./chunk-QS6MTI54.js";import"./chunk-X5YLR3NI.js";import{i as v}from"./chunk-ODN5LVDJ.js";function H(l,n){l&1&&(e(0,"div",24),y(1,"span",25),i(2," Caricamento dashboard\u2026 "),t())}function N(l,n){if(l&1&&(e(0,"div",26),i(1),t()),l&2){let a=h();r(),m(a.error)}}function F(l,n){if(l&1&&(e(0,"tr")(1,"td",30)(2,"div",31)(3,"strong"),i(4),t()()(),e(5,"td",32)(6,"div",31),i(7),t()(),e(8,"td",33)(9,"div",31),i(10),t()(),e(11,"td",34)(12,"div",31),i(13),t()(),e(14,"td",35)(15,"div",31),i(16),k(17,"date"),t()()()),l&2){let a=n.$implicit;r(4),m(a.ragione_sociale),r(3),m(a.telefono||"\u2014"),r(3),m(a.email||"\u2014"),r(3),m(a.provincia||"\u2014"),r(3),m(C(17,5,a.created_at,"short"))}}function Y(l,n){if(l&1&&(e(0,"div",27)(1,"table",28)(2,"thead")(3,"tr")(4,"th"),i(5,"Ragione Sociale"),t(),e(6,"th"),i(7,"Telefono"),t(),e(8,"th"),i(9,"Email"),t(),e(10,"th"),i(11,"Provincia"),t(),e(12,"th"),i(13,"Creato il"),t()()(),e(14,"tbody"),u(15,F,18,8,"tr",29),t()()()),l&2){let a=h();r(15),p("ngForOf",a.ultimiProspect)}}function A(l,n){l&1&&(e(0,"div",36),i(1,"Nessun prospect trovato."),t())}var w=class l{constructor(n,a){this.soggetti=n;this.supabase=a}loading=!1;error=null;kpi={prospect:0,clienti:0,daRichiamare:0,senzaContatto:0,configurati:0,trattativeYuvi:0,referenzeCtr:0};ultimiProspect=[];ngOnInit(){return v(this,null,function*(){yield this.loadData()})}getLastEsito(n){if(!Array.isArray(n)||n.length===0)return null;let a=n[0];for(let o of n)new Date(o.ts).getTime()>new Date(a.ts).getTime()&&(a=o);return a}loadData(){return v(this,null,function*(){this.loading=!0,this.error=null;try{let[n,a,o,d,g]=yield Promise.all([this.soggetti.countByTipo("prospect"),this.soggetti.countByTipo("cliente"),this.soggetti.getSoggettiByTipo("prospect",0,199),this.supabase.supabase.from("trattative_yuvi").select("id",{count:"exact",head:!0}),this.supabase.supabase.from("trattative_yuvi").select("nominativi_presi")]);if(!n.error&&typeof n.data=="number"&&(this.kpi.prospect=n.data),!a.error&&typeof a.data=="number"&&(this.kpi.clienti=a.data),o.error)throw o.error;let S=o.data??[],x=0,E=0,_=0;for(let s of S){let c=this.getLastEsito(s.esiti);c||x++,c&&c.tipo==="Richiamare"&&E++,s.configurato===!0&&_++}this.kpi.senzaContatto=x,this.kpi.daRichiamare=E,this.kpi.configurati=_,this.ultimiProspect=S.sort((s,c)=>new Date(c.created_at).getTime()-new Date(s.created_at).getTime()).slice(0,5).map(s=>({id:s.id,ragione_sociale:s.ragione_sociale||"Senza nome",telefono:s.telefono,email:s.email,provincia:s.provincia,created_at:s.created_at,esiti:s.esiti})),!d.error&&typeof d.count=="number"&&(this.kpi.trattativeYuvi=d.count),!g.error&&Array.isArray(g.data)&&(this.kpi.referenzeCtr=g.data.reduce((s,c)=>s+(c.nominativi_presi??0),0))}catch(n){this.error=n?.message||"Errore durante il caricamento della dashboard"}finally{this.loading=!1}})}static \u0275fac=function(a){return new(a||l)(f(M),f(D))};static \u0275cmp=b({type:l,selectors:[["app-home"]],decls:64,vars:10,consts:[["emptyProspect",""],[1,"form-section"],[1,"section-header"],[1,"material-icons","header-icon"],[1,"section-titles"],[1,"section-title"],[1,"sottotitolo"],["class","status-message loading",4,"ngIf"],["class","status-message error",4,"ngIf"],[1,"prospect-cards"],["routerLink","/lista-prospect",1,"card","clickable"],[1,"card-title"],[1,"card-number"],["routerLink","/clienti",1,"card","clickable"],["routerLink","/yuvi-trattativa",1,"card","clickable"],["routerLink","/visualizzazione-kpi",1,"card","clickable"],[1,"actions-container",2,"margin-top","var(--gutter-lg)","justify-content","center"],["routerLink","/aggiungi-prospect",1,"promethea-button","outline"],["routerLink","/yuvi-trattativa",1,"promethea-button"],["routerLink","/visualizzazione-kpi",1,"promethea-button","secondary"],[1,"form-section",2,"margin-top","var(--gutter-lg)"],["class","table-container",4,"ngIf","ngIfElse"],[1,"actions-container",2,"margin-top","var(--gutter-md)"],["routerLink","/lista-prospect",1,"promethea-button","secondary"],[1,"status-message","loading"],[1,"loading-spinner"],[1,"status-message","error"],[1,"table-container"],[1,"crm-table"],[4,"ngFor","ngForOf"],["data-label","Ragione Sociale"],[1,"cell-content"],["data-label","Telefono"],["data-label","Email"],["data-label","Provincia"],["data-label","Creato il"],[1,"empty-state"]],template:function(a,o){if(a&1&&(e(0,"div",1)(1,"div",2)(2,"i",3),i(3,"dashboard"),t(),e(4,"div",4)(5,"h2",5),i(6,"Dashboard CRM"),t(),e(7,"p",6),i(8,"Panoramica rapida su attivit\xE0 e KPI"),t()()(),u(9,H,3,0,"div",7)(10,N,2,1,"div",8),e(11,"div",9)(12,"a",10)(13,"h3",11),i(14,"Totale Prospect"),t(),e(15,"div",12),i(16),t()(),e(17,"a",13)(18,"h3",11),i(19,"Totale Clienti"),t(),e(20,"div",12),i(21),t()(),e(22,"a",10)(23,"h3",11),i(24,"Da Richiamare"),t(),e(25,"div",12),i(26),t()(),e(27,"a",10)(28,"h3",11),i(29,"Senza Contatto"),t(),e(30,"div",12),i(31),t()(),e(32,"a",14)(33,"h3",11),i(34,"Trattative YUVI"),t(),e(35,"div",12),i(36),t()(),e(37,"a",15)(38,"h3",11),i(39,"Referenze da CTR"),t(),e(40,"div",12),i(41),t()()(),e(42,"div",16)(43,"a",17),i(44,"Nuovo Prospect"),t(),e(45,"a",18),i(46,"Nuova Trattativa YUVI"),t(),e(47,"a",19),i(48,"Visualizza KPI"),t()()(),e(49,"div",20)(50,"div",2)(51,"i",3),i(52,"group"),t(),e(53,"div",4)(54,"h3",5),i(55,"Ultimi Prospect"),t(),e(56,"p",6),i(57,"Gli ultimi inserimenti nel sistema"),t()()(),u(58,Y,16,1,"div",21)(59,A,2,0,"ng-template",null,0,P),e(61,"div",22)(62,"a",23),i(63,"Vai alla lista prospect"),t()()()),a&2){let d=I(60);r(9),p("ngIf",o.loading),r(),p("ngIf",o.error),r(6),m(o.kpi.prospect),r(5),m(o.kpi.clienti),r(5),m(o.kpi.daRichiamare),r(5),m(o.kpi.senzaContatto),r(5),m(o.kpi.trattativeYuvi),r(5),m(o.kpi.referenzeCtr),r(17),p("ngIf",o.ultimiProspect.length>0)("ngIfElse",d)}},dependencies:[L,T,z,O,R],styles:['a.card[_ngcontent-%COMP%]{text-decoration:none;color:inherit}a.card[_ngcontent-%COMP%]   .card-title[_ngcontent-%COMP%]{display:inline-flex;align-items:center;gap:.4rem}a.card[_ngcontent-%COMP%]   .card-title[_ngcontent-%COMP%]:before{content:"\\2022";color:var(--primary);font-size:1.2em;line-height:1}.form-section[_ngcontent-%COMP%] + .form-section[_ngcontent-%COMP%]{margin-top:var(--gutter-lg)}']})};export{w as Home};
