import{b as g}from"./chunk-7VD3EVFT.js";import{N as l,S as u}from"./chunk-QS6MTI54.js";import{i}from"./chunk-ODN5LVDJ.js";var p=class n{supabaseService=u(g);createSoggetto(e){return i(this,null,function*(){try{if(console.log("\u{1F527} Creazione soggetto con dati:",e),e.piva&&e.piva.trim()!==""){let o=yield this.supabaseService.checkPivaExists(e.piva);if(console.log("\u{1F527} Verifica P.IVA:",{piva:e.piva,exists:o}),o)return{success:!1,error:"P.IVA gi\xE0 esistente nel sistema"}}let t=this.mapToSnakeCase(e);console.log("\u{1F527} Dati mappati per Supabase:",t);let r=yield this.supabaseService.createSoggetto(t);return console.log("\u{1F527} Risultato Supabase:",r),r.error?(console.error("\u274C Errore Supabase:",r.error),{success:!1,error:this.getErrorMessage(r.error)}):(console.log("\u2705 Soggetto creato con successo"),{success:!0,data:r.data||void 0})}catch(t){return console.error("\u274C Errore inaspettato:",t),{success:!1,error:"Errore di sistema durante il salvataggio"}}})}get supabase(){return this.supabaseService.supabase}getSoggettiByTipo(e,t=0,r=49){return i(this,null,function*(){return this.supabaseService.getSoggettiByTipo(e,t,r)})}getSoggettoById(e){return i(this,null,function*(){return yield this.supabaseService.getSoggettoById(e)})}deleteSoggetto(e){return i(this,null,function*(){try{let t=yield this.unlinkOrDelete("trattative_yuvi","prospect_id",e);if(!t.ok)return{success:!1,error:this.getErrorMessage(t.error)};let r=yield this.unlinkOrDelete("configurazioni_promethea","prospect_id",e);if(!r.ok)return{success:!1,error:this.getErrorMessage(r.error)};let o=yield this.supabaseService.deleteSoggetto(e);return o.error?{success:!1,error:this.getErrorMessage(o.error),code:o.error.code}:{success:!0,data:o.data||void 0}}catch{return{success:!1,error:"Errore di sistema durante l'eliminazione"}}})}unlinkOrDelete(e,t,r){return i(this,null,function*(){let{error:o}=yield this.supabaseService.supabase.from(e).update({[t]:null}).eq(t,r);if(!o)return{ok:!0};let a=String(o?.message||"");if(!(o?.code==="23502"||/not[- ]?null/i.test(a)||/violates not-null constraint/i.test(a)))return{ok:!1,error:o};let{error:s}=yield this.supabaseService.supabase.from(e).delete().eq(t,r);return s?{ok:!1,error:s}:{ok:!0}})}updateSoggetto(e){return i(this,null,function*(){try{let t=this.mapUpdateToSnakeCase(e),r=yield this.supabaseService.updateSoggetto(e.id,t);return r.error?{success:!1,error:this.getErrorMessage(r.error),code:r.error.code}:{success:!0,data:r.data||void 0}}catch{return{success:!1,error:"Errore di sistema durante l'aggiornamento"}}})}searchSoggetti(e,t){return i(this,null,function*(){try{let r=yield this.supabaseService.searchSoggetti(e,t);return r.error?r:t?{data:(r.data??[]).filter(a=>a.tipo===t),error:null}:r}catch(r){return console.error("Errore nella ricerca soggetti:",r),{data:null,error:r}}})}updateProdotto(e,t){return i(this,null,function*(){try{let r=yield this.supabaseService.updateSoggetto(e,{prodotto:t});return r.error?{success:!1,error:this.getErrorMessage(r.error),code:r.error.code}:{success:!0,data:r.data||void 0}}catch{return{success:!1,error:"Errore di sistema durante l'aggiornamento del prodotto"}}})}getProvinceByTipo(e){return i(this,null,function*(){return this.supabaseService.getProvinceByTipo(e)})}countByTipo(e){return i(this,null,function*(){return this.supabaseService.countSoggettiByTipo(e)})}getConfigurazioniProspect(e){return i(this,null,function*(){try{if(!e.length)return new Map;let[t,r]=yield Promise.all([this.supabaseService.supabase.from("configurazioni_promethea").select("prospect_id").in("prospect_id",e),this.supabaseService.supabase.from("trattative_yuvi").select("prospect_id").in("prospect_id",e)]),o=new Map;return e.forEach(a=>o.set(a,!1)),t.data&&t.data.forEach(a=>{a.prospect_id&&o.set(a.prospect_id,!0)}),r.data&&r.data.forEach(a=>{a.prospect_id&&o.set(a.prospect_id,!0)}),o}catch(t){return console.error("Errore bulk configurazioni:",t),new Map}})}getConfigurazioniPrometheaByCliente(e){return i(this,null,function*(){try{if(!e.length)return new Map;let{data:t,error:r}=yield this.supabaseService.supabase.from("configurazioni_promethea").select("prospect_id").in("prospect_id",e);if(r)return console.error("Errore verifica configurazioni Promethea per clienti:",r),new Map;let o=new Map;return e.forEach(a=>o.set(a,!1)),t&&t.forEach(a=>{a.prospect_id&&o.set(a.prospect_id,!0)}),o}catch(t){return console.error("Errore bulk configurazioni Promethea per clienti:",t),new Map}})}getTrattativeYuviByProspect(e){return i(this,null,function*(){if(!e.length)return new Map;try{let{data:t,error:r}=yield this.supabaseService.supabase.from("trattative_yuvi").select("prospect_id").in("prospect_id",e);if(r)return console.error("Errore verifica trattative YUVI:",r),new Map;let o=new Map;return e.forEach(a=>o.set(a,!1)),t&&t.forEach(a=>{a.prospect_id&&o.set(a.prospect_id,!0)}),o}catch(t){return console.error("Errore bulk trattative YUVI:",t),new Map}})}getTrattativeYuviByCliente(e){return i(this,null,function*(){try{if(!e.length)return new Map;let{data:t,error:r}=yield this.supabaseService.supabase.from("trattative_yuvi").select("prospect_id").in("prospect_id",e);if(r)return console.error("Errore verifica trattative YUVI per clienti:",r),new Map;let o=new Map;return e.forEach(a=>o.set(a,!1)),t&&t.forEach(a=>{a.prospect_id&&o.set(a.prospect_id,!0)}),o}catch(t){return console.error("Errore bulk trattative YUVI per clienti:",t),new Map}})}mapToSnakeCase(e){return{tipo:e.tipo,ragione_sociale:e.ragioneSociale,piva:e.piva&&e.piva.trim()!==""?e.piva:null,formula_societaria:e.formulaSocietaria||null,categoria_ateco:e.categoriaAteco||null,referente:e.referente||null,telefono:e.telefono||null,email:e.email||null,sito_web:e.sitoWeb||null,facebook:e.facebook||null,instagram:e.instagram||null,metodo_pagamento:e.metodoPagamento||null,iban:e.iban||null,note:e.note||null,prodotto:e.prodotto||"Promethea",provincia:e.provincia||null,comune:e.comune||null,indirizzo:e.indirizzo||null,numero_civico:e.numeroCivico||null,esiti:[]}}mapUpdateToSnakeCase(e){let t={};return e.tipo!==void 0&&(t.tipo=e.tipo),e.ragioneSociale!==void 0&&(t.ragione_sociale=e.ragioneSociale),e.piva!==void 0&&(t.piva=e.piva&&e.piva.trim()!==""?e.piva:null),e.formulaSocietaria!==void 0&&(t.formula_societaria=e.formulaSocietaria),e.categoriaAteco!==void 0&&(t.categoria_ateco=e.categoriaAteco),e.referente!==void 0&&(t.referente=e.referente),e.telefono!==void 0&&(t.telefono=e.telefono),e.email!==void 0&&(t.email=e.email),e.sitoWeb!==void 0&&(t.sito_web=e.sitoWeb),e.facebook!==void 0&&(t.facebook=e.facebook),e.instagram!==void 0&&(t.instagram=e.instagram),e.metodoPagamento!==void 0&&(t.metodo_pagamento=e.metodoPagamento),e.iban!==void 0&&(t.iban=e.iban),e.note!==void 0&&(t.note=e.note),e.prodotto!==void 0&&(t.prodotto=e.prodotto),e.provincia!==void 0&&(t.provincia=e.provincia),e.comune!==void 0&&(t.comune=e.comune),e.indirizzo!==void 0&&(t.indirizzo=e.indirizzo),e.numeroCivico!==void 0&&(t.numero_civico=e.numeroCivico),t}getErrorMessage(e){return typeof e=="string"?e:{23505:"Dati duplicati: il soggetto potrebbe gi\xE0 esistere",42501:"Permessi insufficienti per completare l'operazione",P0001:"Errore di validazione dei dati",network_error:"Errore di connessione al server"}[e.code]||e.message||"Errore durante il salvataggio"}getEsitiBySoggetto(e){return i(this,null,function*(){try{let{data:t,error:r}=yield this.supabaseService.getSoggettoById(e);if(r)return{data:null,error:r};let o=t?.esiti??[];return{data:this.normalizzaEsiti(o),error:null}}catch(t){return{data:null,error:t}}})}appendEsito(e,t){return i(this,null,function*(){try{let r=yield this.getEsitiBySoggetto(e),o=r.error?[]:r.data??[],a=this.creaEsitoCompleto(t),c=[...o,a],s=yield this.supabaseService.updateSoggetto(e,{esiti:c});return s.error?{success:!1,error:this.getErrorMessage(s.error),code:s.error.code}:{success:!0,data:s.data||void 0}}catch(r){return console.error("Errore in appendEsito:",r),{success:!1,error:"Errore di sistema durante il salvataggio dell'esito"}}})}normalizzaEsiti(e){return e.map(t=>({tipo:t.tipo||"Non interessato",note:t.note||null,ts:t.ts||new Date().toISOString(),scheduleAt:t.scheduleAt||null,dataAppuntamento:t.dataAppuntamento||null,oraAppuntamento:t.oraAppuntamento||null}))}creaEsitoCompleto(e){return{tipo:e.tipo,note:e.note||null,ts:new Date().toISOString(),scheduleAt:e.scheduleAt||null,dataAppuntamento:e.dataAppuntamento||null,oraAppuntamento:e.oraAppuntamento||null}}convertiProspectInCliente(e){return i(this,null,function*(){try{let t={tipo:"cliente",updated_at:new Date().toISOString()},{data:r,error:o}=yield this.supabaseService.supabase.from("soggetti").update(t).eq("id",e).eq("tipo","prospect").select().single();return o?(console.error("Errore nella conversione prospect -> cliente:",o),{data:null,error:o}):(console.log("Prospect convertito in cliente:",r),{data:r,error:null})}catch(t){return console.error("Errore generale nella conversione:",t),{data:null,error:t}}})}static \u0275fac=function(t){return new(t||n)};static \u0275prov=l({token:n,factory:n.\u0275fac,providedIn:"root"})};export{p as a};
