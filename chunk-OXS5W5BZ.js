import{a as ft}from"./chunk-T34MCJS6.js";import{a as xt}from"./chunk-XB5NTRTT.js";import{a as kt}from"./chunk-ZN3F4CYF.js";import{a as vt}from"./chunk-O7PKPPU5.js";import{b as rt,d as st,f as lt,i as ct,o as dt,p as mt,q as gt,t as _t,v as pt}from"./chunk-DITEEB7V.js";import{b as ut}from"./chunk-4ZO3JJK7.js";import{a as ot}from"./chunk-23T6KXZP.js";import{a as nt}from"./chunk-6TYR3BRN.js";import{b as tt,d as et,f as it}from"./chunk-KPVFMQJV.js";import{b as at}from"./chunk-7SDV3Z56.js";import{i as Q,j as J,k as X,n as Y,r as Z}from"./chunk-G7C3XVRV.js";import{$b as D,Ab as d,Ba as B,Fa as H,Ga as l,Hb as V,Ib as j,Jb as z,Kb as $,Lb as s,Ma as P,Mb as E,Nb as C,Ob as N,Pb as f,Qb as h,Rb as T,Sa as q,Vb as R,X as g,Xa as x,Y as _,_b as O,bc as K,gb as G,mb as m,nb as o,ob as n,pb as I,tb as A,ub as L,wb as S,zb as u}from"./chunk-S7YZFXYO.js";import"./chunk-X5YLR3NI.js";import{a as U,c as F,i as y}from"./chunk-ODN5LVDJ.js";var St=()=>[1,2,3,4,5],yt=()=>["da_fare","in_lavorazione","completato"],wt=()=>[];function Ct(c,i){if(c&1&&(o(0,"div",18)(1,"p",19),s(2),n()()),c&2){let t=d();l(2),C("ID: ",t.macroTask.id)}}function bt(c,i){if(c&1){let t=S();o(0,"button",29),u("click",function(){g(t);let e=d(2);return _(e.eliminaMacroTask())}),o(1,"i",22),s(2,"delete_forever"),n(),o(3,"span",23),s(4,"Elimina"),n()()}if(c&2){let t=d(2);m("disabled",t.loading)}}function Mt(c,i){if(c&1){let t=S();o(0,"button",30),u("click",function(){g(t);let e=d(2);return _(e.salvaComeTemplate())}),o(1,"i",22),s(2,"content_copy"),n(),o(3,"span",23),s(4,"Template"),n()()}if(c&2){let t=d(2);m("disabled",t.loading)}}function Et(c,i){if(c&1){let t=S();o(0,"div",20)(1,"button",21),u("click",function(){g(t);let e=d();return _(e.router.navigate(["/task"]))}),o(2,"i",22),s(3,"arrow_back"),n(),o(4,"span",23),s(5,"Lista"),n()(),o(6,"button",24),u("click",function(){g(t);let e=d();return _(e.copyMacroTaskToClipboard())}),o(7,"i",22),s(8,"content_copy"),n(),o(9,"span",23),s(10,"Copia"),n()(),o(11,"a",25),u("click",function(){g(t);let e=d();return _(e.sendMacroTaskRiepilogo())}),o(12,"i",22),s(13,"email"),n(),o(14,"span",23),s(15,"Invia"),n()(),x(16,bt,5,1,"button",26)(17,Mt,5,1,"button",27),o(18,"button",28),u("click",function(){g(t);let e=d();return _(e.salvaMacroTask())}),o(19,"i",22),s(20,"save"),n(),o(21,"span",23),s(22),n()()()}if(c&2){let t=d();l(16),m("ngIf",t.currentUser==null?null:t.currentUser.is_admin),l(),m("ngIf",t.currentUser==null?null:t.currentUser.is_admin),l(),m("disabled",t.loading),l(),z("spin",t.loading),l(3),E(t.loading?"Salva...":"Salva")}}function zt(c,i){if(c&1&&(o(0,"div",31)(1,"i",22),s(2,"warning"),n(),s(3),n()),c&2){let t=d();l(3),C(" ",t.error," ")}}function Pt(c,i){if(c&1&&(o(0,"option",77),s(1),n()),c&2){let t=i.$implicit;m("ngValue",t.id),l(),E(t.ragione_sociale)}}function Vt(c,i){if(c&1){let t=S();o(0,"div")(1,"label",75),s(2,"Cliente"),n(),o(3,"select",76),T("ngModelChange",function(e){g(t);let r=d(2);return h(r.macroTask.cliente_id,e)||(r.macroTask.cliente_id=e),_(e)}),o(4,"option",77),s(5,"Nessun cliente"),n(),x(6,Pt,2,2,"option",49),n()()}if(c&2){let t=d(2);l(3),f("ngModel",t.macroTask.cliente_id),l(),m("ngValue",""),l(2),m("ngForOf",t.clienti)}}function It(c,i){if(c&1&&(o(0,"option",77),s(1),n()),c&2){let t=i.$implicit;m("ngValue",t.id),l(),E(t.nome)}}function Ot(c,i){if(c&1){let t=S();o(0,"div")(1,"label",78),s(2,"Prodotto"),n(),o(3,"select",79),T("ngModelChange",function(e){g(t);let r=d(2);return h(r.macroTask.extra_data.prodotto_id,e)||(r.macroTask.extra_data.prodotto_id=e),_(e)}),o(4,"option",77),s(5,"Nessun prodotto"),n(),x(6,It,2,2,"option",49),n()()}if(c&2){let t=d(2);l(3),f("ngModel",t.macroTask.extra_data.prodotto_id),l(),m("ngValue",""),l(2),m("ngForOf",t.prodotti)}}function Dt(c,i){if(c&1&&(o(0,"option",77),s(1),n()),c&2){let t=i.$implicit,a=d(2);m("ngValue",t),l(),N(" P",t," - ",a.taskService.getNomePriorita(t)," ")}}function Wt(c,i){if(c&1){let t=S();o(0,"div",80)(1,"button",81),u("click",function(){g(t);let e=d(2);return _(e.salvaMacroTask())}),o(2,"i",22),s(3,"save"),n(),s(4," Crea Macro Task "),n()()}if(c&2){let t=d(2);l(),m("disabled",t.loading),l(),z("spin",t.loading)}}function At(c,i){if(c&1&&(A(0),o(1,"span",82),s(2),n(),o(3,"span",82),s(4),n(),L()),c&2){let t=d(2);l(2),N(" Sottotask: ",t.getCountsAggregate().completedSotto," / ",t.getCountsAggregate().totalSotto," "),l(2),N(" Dettagli: ",t.getCountsAggregate().completedDet," / ",t.getCountsAggregate().totalDet," ")}}function Lt(c,i){c&1&&(o(0,"div",87)(1,"i",22),s(2,"layers"),n(),o(3,"h4"),s(4,"Nessuna sotto task"),n(),o(5,"p"),s(6,"Crea la prima sotto task per suddividere il lavoro"),n()())}function Nt(c,i){if(c&1&&(A(0),o(1,"span",97),s(2),n(),L()),c&2){let t=d().$implicit,a=d(4);l(),$(a.getStatoBadgeClass(t.stato)),l(),C(" ",a.getStatoTesto(t.stato)," ")}}function Bt(c,i){if(c&1&&(o(0,"span",109)(1,"i",22),s(2,"checklist"),n(),s(3),n()),c&2){let t=d().$implicit;l(3),C(" ",t.task_dettaglio.length," dettagli ")}}function Rt(c,i){if(c&1&&(A(0),o(1,"div",110)(2,"div",111),I(3,"div",72),o(4,"span",112),s(5),n()()(),L()),c&2){let t=d().$implicit,a=d(4);l(3),j("width",a.getSottoTaskCompletionPercent(t),"%"),m("ngClass",t.stato),l(2),C(" ",a.getSottoTaskCompletionPercent(t),"% ")}}function jt(c,i){if(c&1){let t=S();o(0,"li")(1,"a",104),u("click",function(){let e=g(t).$implicit,r=d(2).$implicit,p=V(27);return d(4).cambiaStatoSottoTask(r,e),_(p.close())}),s(2),n()()}if(c&2){let t=i.$implicit,a=d(6);l(2),C(" ",a.getStatoTesto(t)," ")}}function $t(c,i){c&1&&(A(0),o(1,"li")(2,"h6",113),s(3,"Cambia Stato"),n()(),x(4,jt,3,1,"li",114),o(5,"li"),I(6,"hr",115),n(),L()),c&2&&(l(4),m("ngForOf",R(1,yt)))}function Ut(c,i){c&1&&(o(0,"div",116)(1,"i",22),s(2,"android"),n()())}function Ft(c,i){if(c&1){let t=S();o(0,"p",129),u("click",function(){g(t);let e=d().$implicit,r=d(2).$implicit,p=d(4);return _(p.apriDettaglio(e,r))}),n()}if(c&2){let t=d().$implicit,a=d(6);m("innerHTML",a.highlightDescrizione(t.descrizione),B)}}function Ht(c,i){if(c&1){let t=S();o(0,"div",119)(1,"div",120)(2,"input",121),u("change",function(){let e=g(t).$implicit,r=d(2).$implicit,p=d(4);return _(p.toggleDettaglioCompletato(e,r))})("click",function(e){return g(t),_(e.stopPropagation())})("mousedown",function(e){return g(t),_(e.stopPropagation())}),n(),o(3,"div",122)(4,"div",123),I(5,"strong",124),o(6,"span",19)(7,"i",22),s(8,"schedule"),n(),s(9),O(10,"date"),n(),o(11,"div",125),u("click",function(e){return g(t),_(e.stopPropagation())}),o(12,"button",126),u("click",function(e){let r=g(t).$implicit,p=d(2).$implicit,k=d(4);return e.stopPropagation(),_(k.apriDettaglio(r,p))}),o(13,"i",22),s(14,"edit"),n()(),o(15,"button",127),u("click",function(e){let r=g(t).$implicit,p=d(2).$implicit,k=d(4);return e.stopPropagation(),_(k.eliminaDettaglio(r,p))}),o(16,"i",22),s(17,"delete_forever"),n()()()(),x(18,Ft,1,1,"p",128),n()()()}if(c&2){let t=i.$implicit,a=d(6);l(2),m("checked",t.completato),l(3),z("completed",t.completato),m("innerHTML",a.highlightDettaglioNome(t.nome),B),l(4),C(" ",D(10,6,t.data_scadenza_prevista,"dd/MM/yyyy")," "),l(9),m("ngIf",t.descrizione)}}function qt(c,i){if(c&1&&(o(0,"div",117),x(1,Ht,19,9,"div",118),n()),c&2){let t=d().$implicit,a=d(4);l(),m("ngForOf",a.getDettagliOrdinati(t))("ngForTrackBy",a.trackByDettaglio)}}function Gt(c,i){if(c&1){let t=S();o(0,"div",87)(1,"i",22),s(2,"info"),n(),s(3," Nessun dettaglio aggiunto. "),o(4,"a",130),u("click",function(){g(t);let e=d().$implicit,r=d(4);return _(r.apriModal("dettaglio",e))}),s(5,"Aggiungi il primo dettaglio"),n()()}}function Kt(c,i){if(c&1){let t=S();o(0,"div",90)(1,"div",91),u("click",function(){let e=g(t).$implicit,r=d(4);return _(r.toggleSottoTaskEspansa(e.id))}),o(2,"div",92)(3,"button",93),u("click",function(e){let r=g(t).$implicit,p=d(4);return e.stopPropagation(),_(p.toggleSottoTaskEspansa(r.id))}),o(4,"i",22),s(5),n()(),o(6,"div",94),I(7,"h4",95),o(8,"div",96)(9,"span",97),s(10),n(),x(11,Nt,3,3,"ng-container",46),o(12,"span",19)(13,"i",22),s(14,"calendar_today"),n(),s(15),O(16,"date"),n(),x(17,Bt,4,1,"span",98)(18,Rt,6,4,"ng-container",46),n()()(),o(19,"div",99),u("click",function(e){return g(t),_(e.stopPropagation())}),o(20,"button",100),u("click",function(){let e=g(t).$implicit,r=d(4);return _(r.apriModal("modificaSottoTask",e))}),o(21,"i",22),s(22,"edit"),n()(),o(23,"button",101),u("click",function(){let e=g(t).$implicit,r=d(4);return _(r.exportSottoTask(e))}),o(24,"i",22),s(25,"content_copy"),n()(),o(26,"app-action-dropdown",102,3),u("action",function(e){let r=g(t).$implicit,p=d(4);return _(p.handleSottoTaskAction(e,r))}),o(28,"div",103),u("click",function(e){return g(t),_(e.stopPropagation())}),x(29,$t,7,2,"ng-container",46),o(30,"li")(31,"a",104),u("click",function(){let e=g(t).$implicit,r=V(27);return d(4).apriModal("dettaglio",e),_(r.close())}),o(32,"i",22),s(33,"add"),n(),s(34," Aggiungi Dettaglio "),n()(),o(35,"li")(36,"a",104),u("click",function(){let e=g(t).$implicit,r=V(27);return d(4).eliminaSottoTask(e),_(r.close())}),o(37,"i",22),s(38,"delete"),n(),s(39," Elimina sotto-task "),n()()()(),x(40,Ut,3,0,"div",105),n()(),o(41,"div",106),x(42,qt,2,2,"div",107)(43,Gt,6,0,"div",108),n()()}if(c&2){let t=i.$implicit,a=d(4);z("expanded",a.isSottoTaskEspansa(t.id))("dropdown-open",a.isDropdownOpen(t.id)),l(3),m("title",a.isSottoTaskEspansa(t.id)?"Riduci dettagli":"Espandi dettagli"),G("aria-expanded",a.isSottoTaskEspansa(t.id)),l(2),C(" ",a.isSottoTaskEspansa(t.id)?"expand_less":"expand_more"," "),l(2),m("innerHTML",a.highlightSotto(t.nome),B),l(2),$(a.getPrioritaBadgeClass(t.priorita)),l(),C(" P",t.priorita," "),l(),m("ngIf",!(t.stato==="completato"&&a.getSottoTaskCompletionPercent(t)<100)),l(4),C(" ",D(16,22,t.created_at,"dd/MM/yyyy")," "),l(2),m("ngIf",t.task_dettaglio&&t.task_dettaglio.length>0),l(),m("ngIf",t.task_dettaglio&&t.task_dettaglio.length>0),l(8),m("row",t),l(3),m("ngIf",a.puoiModificareSottoTask(t)),l(11),m("ngIf",!a.puoiModificareSottoTask(t)),l(),z("show",a.isSottoTaskEspansa(t.id)),l(),m("ngIf",t.task_dettaglio&&t.task_dettaglio.length>0),l(),m("ngIf",!t.task_dettaglio||t.task_dettaglio.length===0)}}function Qt(c,i){if(c&1&&(o(0,"div",88),x(1,Kt,44,25,"div",89),n()),c&2){let t=d(3);l(),m("ngForOf",t.filteredSottoTasks())("ngForTrackBy",t.trackBySottoTask)}}function Jt(c,i){if(c&1){let t=S();o(0,"div",7)(1,"div",8)(2,"h3",10)(3,"i",22),s(4,"layers"),n(),s(5," Sotto Tasks "),o(6,"span",83),s(7),n()(),o(8,"div",20)(9,"button",84),u("click",function(){g(t);let e=d(2);return _(e.toggleEspandiTutti())}),o(10,"i",22),s(11),n(),o(12,"span",23),s(13),n()(),o(14,"button",85),u("click",function(){g(t);let e=d(2);return _(e.apriModal("sottoTask"))}),o(15,"i",22),s(16,"add"),n(),o(17,"span",23),s(18,"Nuova"),n()()()(),x(19,Lt,7,0,"ng-template",null,2,K)(21,Qt,2,2,"div",86),n()}if(c&2){let t=V(20),a=d(2);l(7),E((a.macroTask.sotto_tasks==null?null:a.macroTask.sotto_tasks.length)||0),l(2),m("title",a.espandiTutti?"Riduci tutte":"Espandi tutte"),l(2),C(" ",a.espandiTutti?"unfold_less":"unfold_more"," "),l(2),E(a.espandiTutti?"Riduci":"Espandi"),l(8),m("ngIf",a.macroTask.sotto_tasks&&a.macroTask.sotto_tasks.length>0)("ngIfElse",t)}}function Xt(c,i){if(c&1&&(o(0,"option",77),s(1),n()),c&2){let t=i.$implicit;m("ngValue",t.id),l(),C(" ",t.ragione_sociale," ")}}function Yt(c,i){if(c&1){let t=S();o(0,"div")(1,"label",75),s(2,"Cliente"),n(),o(3,"select",76),T("ngModelChange",function(e){g(t);let r=d(2);return h(r.macroTask.cliente_id,e)||(r.macroTask.cliente_id=e),_(e)}),o(4,"option",77),s(5,"Nessun cliente"),n(),x(6,Xt,2,2,"option",49),n()()}if(c&2){let t=d(2);l(3),f("ngModel",t.macroTask.cliente_id),l(),m("ngValue",""),l(2),m("ngForOf",t.clienti)}}function Zt(c,i){if(c&1&&(o(0,"option",77),s(1),n()),c&2){let t=i.$implicit;m("ngValue",t.id),l(),E(t.nome)}}function te(c,i){if(c&1){let t=S();o(0,"div")(1,"label",78),s(2,"Prodotto"),n(),o(3,"select",79),T("ngModelChange",function(e){g(t);let r=d(2);return h(r.macroTask.extra_data.prodotto_id,e)||(r.macroTask.extra_data.prodotto_id=e),_(e)}),o(4,"option",77),s(5,"Nessun prodotto"),n(),x(6,Zt,2,2,"option",49),n()()}if(c&2){let t=d(2);l(3),f("ngModel",t.macroTask.extra_data.prodotto_id),l(),m("ngValue",""),l(2),m("ngForOf",t.prodotti)}}function ee(c,i){if(c&1){let t=S();o(0,"div",32)(1,"div",33)(2,"div",7)(3,"h3",10),s(4,"Informazioni Principali"),n(),o(5,"div",34)(6,"div",35)(7,"label",36),s(8,"Nome Task *"),n(),o(9,"input",37,0),T("ngModelChange",function(e){g(t);let r=d();return h(r.macroTask.nome,e)||(r.macroTask.nome=e),_(e)}),n()(),o(11,"div",38)(12,"label",39),s(13,"Data Scadenza"),n(),o(14,"input",40),T("ngModelChange",function(e){g(t);let r=d();return h(r.macroTask.data_scadenza,e)||(r.macroTask.data_scadenza=e),_(e)}),n()(),o(15,"div",38)(16,"label",41),s(17,"Stato"),n(),I(18,"input",42),n()(),o(19,"div",38)(20,"label",43),s(21,"Associato a"),n(),o(22,"div",44)(23,"label")(24,"input",45),T("ngModelChange",function(e){g(t);let r=d();return h(r.macroTask.extra_data.tipo_assoc,e)||(r.macroTask.extra_data.tipo_assoc=e),_(e)}),u("change",function(){g(t);let e=d();return _(e.onAssocTipoChange())}),n(),s(25," Cliente"),n(),o(26,"label")(27,"input",45),T("ngModelChange",function(e){g(t);let r=d();return h(r.macroTask.extra_data.tipo_assoc,e)||(r.macroTask.extra_data.tipo_assoc=e),_(e)}),u("change",function(){g(t);let e=d();return _(e.onAssocTipoChange())}),n(),s(28," Prodotto"),n(),o(29,"label")(30,"input",45),T("ngModelChange",function(e){g(t);let r=d();return h(r.macroTask.extra_data.tipo_assoc,e)||(r.macroTask.extra_data.tipo_assoc=e),_(e)}),u("change",function(){g(t);let e=d();return _(e.onAssocTipoChange())}),n(),s(31," Interna"),n()(),x(32,Vt,7,3,"div",46)(33,Ot,7,3,"div",46),n(),o(34,"div",38)(35,"label",47),s(36,"Priorit\xE0"),n(),o(37,"select",48),T("ngModelChange",function(e){g(t);let r=d();return h(r.macroTask.priorita_globale,e)||(r.macroTask.priorita_globale=e),_(e)}),x(38,Dt,2,3,"option",49),n()(),o(39,"div",38)(40,"label",50),s(41,"Modulo *"),n(),o(42,"select",51,1),T("ngModelChange",function(e){g(t);let r=d();return h(r.macroTask.assegnazione_id,e)||(r.macroTask.assegnazione_id=e),_(e)}),o(44,"option",52),s(45,"Seleziona Modulo"),n(),o(46,"option",53),s(47,"Immagine"),n(),o(48,"option",54),s(49,"Digitalizzazione"),n(),o(50,"option",55),s(51,"Contabilit\xE0"),n(),o(52,"option",56),s(53,"Ottimizzazione"),n(),o(54,"option",57),s(55,"Tutti i moduli"),n()()(),o(56,"div",38)(57,"label",58),s(58,"Note"),n(),o(59,"textarea",59),T("ngModelChange",function(e){g(t);let r=d();return h(r.macroTask.note,e)||(r.macroTask.note=e),_(e)}),n()(),x(60,Wt,5,3,"div",60),n(),o(61,"div",61)(62,"label",62)(63,"span",22),s(64,"search"),n(),s(65," Cerca "),n(),o(66,"input",63),T("ngModelChange",function(e){g(t);let r=d();return h(r.sottoSearch,e)||(r.sottoSearch=e),_(e)}),n(),o(67,"div",64),x(68,At,5,4,"ng-container",46),n()(),x(69,Jt,22,6,"div",65),n(),o(70,"div",66)(71,"div",67)(72,"h4"),s(73,"Riepilogo Task"),n(),o(74,"div",68)(75,"div",69)(76,"label"),s(77,"Stato:"),n(),o(78,"span",70),s(79),n()(),o(80,"div",69)(81,"label"),s(82,"Priorit\xE0:"),n(),o(83,"span",70),s(84),n()(),o(85,"div",69)(86,"label"),s(87,"Progresso:"),n(),o(88,"div",71)(89,"div",72)(90,"span",73),s(91),n()()()(),o(92,"div",38)(93,"label",43),s(94,"Associato a"),n(),o(95,"div",44)(96,"label")(97,"input",74),T("ngModelChange",function(e){g(t);let r=d();return h(r.macroTask.extra_data.tipo_assoc,e)||(r.macroTask.extra_data.tipo_assoc=e),_(e)}),u("change",function(){g(t);let e=d();return _(e.onAssocTipoChange())}),n(),s(98," Cliente"),n(),o(99,"label")(100,"input",74),T("ngModelChange",function(e){g(t);let r=d();return h(r.macroTask.extra_data.tipo_assoc,e)||(r.macroTask.extra_data.tipo_assoc=e),_(e)}),u("change",function(){g(t);let e=d();return _(e.onAssocTipoChange())}),n(),s(101," Prodotto"),n(),o(102,"label")(103,"input",74),T("ngModelChange",function(e){g(t);let r=d();return h(r.macroTask.extra_data.tipo_assoc,e)||(r.macroTask.extra_data.tipo_assoc=e),_(e)}),u("change",function(){g(t);let e=d();return _(e.onAssocTipoChange())}),n(),s(104," Interna"),n()(),x(105,Yt,7,3,"div",46)(106,te,7,3,"div",46),n(),o(107,"div",69)(108,"label"),s(109,"Modulo:"),n(),o(110,"span"),s(111),n()(),o(112,"div",69)(113,"label"),s(114,"Scadenza:"),n(),o(115,"span"),s(116),O(117,"date"),n()(),o(118,"div",69)(119,"label"),s(120,"Creato il:"),n(),o(121,"span"),s(122),O(123,"date"),n()(),o(124,"div",69)(125,"label"),s(126,"Aggiornato il:"),n(),o(127,"span"),s(128),O(129,"date"),n()()()()()()}if(c&2){let t=V(10),a=V(43),e=d();l(9),z("input-error",t.invalid&&(t.touched||e.submitted)),f("ngModel",e.macroTask.nome),l(5),f("ngModel",e.macroTask.data_scadenza),l(4),m("value",e.taskService.getStatoTesto(e.macroTask.stato)),l(6),f("ngModel",e.macroTask.extra_data.tipo_assoc),m("value","cliente"),l(3),f("ngModel",e.macroTask.extra_data.tipo_assoc),m("value","prodotto"),l(3),f("ngModel",e.macroTask.extra_data.tipo_assoc),m("value","interna"),l(2),m("ngIf",(e.macroTask.extra_data==null?null:e.macroTask.extra_data.tipo_assoc)==="cliente"),l(),m("ngIf",(e.macroTask.extra_data==null?null:e.macroTask.extra_data.tipo_assoc)==="prodotto"),l(4),f("ngModel",e.macroTask.priorita_globale),l(),m("ngForOf",R(57,St)),l(4),z("input-error",a.invalid&&(a.touched||e.submitted)),f("ngModel",e.macroTask.assegnazione_id),l(2),m("value",null),l(15),f("ngModel",e.macroTask.note),l(),m("ngIf",!e.macroTask.id),l(6),f("ngModel",e.sottoSearch),l(2),m("ngIf",e.macroTask),l(),m("ngIf",e.macroTask.id),l(9),m("ngClass",e.taskService.getStatoBadgeClass(e.macroTask.stato)),l(),C(" ",e.taskService.getStatoTesto(e.macroTask.stato)," "),l(4),m("ngClass",e.taskService.getPrioritaBadgeClass(e.macroTask.priorita_globale)),l(),C(" P",e.macroTask.priorita_globale," "),l(5),j("width",e.macroTask.progresso,"%"),m("ngClass",e.taskService.getStatoBadgeClass(e.macroTask.stato)),l(2),C("",e.macroTask.progresso,"%"),l(6),f("ngModel",e.macroTask.extra_data.tipo_assoc),m("value","cliente"),l(3),f("ngModel",e.macroTask.extra_data.tipo_assoc),m("value","prodotto"),l(3),f("ngModel",e.macroTask.extra_data.tipo_assoc),m("value","interna"),l(2),m("ngIf",(e.macroTask.extra_data==null?null:e.macroTask.extra_data.tipo_assoc)==="cliente"),l(),m("ngIf",(e.macroTask.extra_data==null?null:e.macroTask.extra_data.tipo_assoc)==="prodotto"),l(5),E(e.taskService.getModuloName(e.macroTask.assegnazione_id||null)),l(4),z("text-danger",e.taskService.isScaduta(e.macroTask.data_scadenza))("text-warning",e.taskService.isScadenzaImminente(e.macroTask.data_scadenza)),l(),C(" ",D(117,48,e.macroTask.data_scadenza,"dd/MM/yyyy")," "),l(6),E(D(123,51,e.macroTask.created_at,"dd/MM/yyyy HH:mm")),l(6),E(D(129,54,e.macroTask.updated_at,"dd/MM/yyyy HH:mm"))}}function ie(c,i){if(c&1){let t=S();o(0,"div",131),u("click",function(){g(t);let e=d();return _(e.chiudiModal("sottoTask"))}),n()}}function ae(c,i){if(c&1){let t=S();o(0,"div",132)(1,"div",133)(2,"div",134)(3,"div",135)(4,"h5",136)(5,"i",22),s(6,"layers"),n(),s(7," Nuova Sotto Task "),n(),o(8,"button",137),u("click",function(){g(t);let e=d();return _(e.chiudiModal("sottoTask"))}),n()(),o(9,"div",138)(10,"div",38)(11,"label",139),s(12,"Nome *"),n(),o(13,"input",140,4),T("ngModelChange",function(e){g(t);let r=d();return h(r.nuovaSottoTask.nome,e)||(r.nuovaSottoTask.nome=e),_(e)}),n()(),o(15,"div",38)(16,"label",141),s(17,"Priorit\xE0"),n(),o(18,"select",142),T("ngModelChange",function(e){g(t);let r=d();return h(r.nuovaSottoTask.priorita,e)||(r.nuovaSottoTask.priorita=e),_(e)}),o(19,"option",77),s(20,"1 - Minima"),n(),o(21,"option",77),s(22,"2 - Bassa"),n(),o(23,"option",77),s(24,"3 - Media"),n(),o(25,"option",77),s(26,"4 - Alta"),n(),o(27,"option",77),s(28,"5 - Critica"),n()()()(),o(29,"div",143)(30,"button",144),u("click",function(){g(t);let e=d();return _(e.chiudiModal("sottoTask"))}),s(31,"Annulla"),n(),o(32,"button",145),u("click",function(){g(t);let e=d();return _(e.creaSottoTask())}),s(33,"Crea"),n()()()()()}if(c&2){let t=V(14),a=d();l(13),z("input-error",t.invalid&&(t.touched||a.submitted)),f("ngModel",a.nuovaSottoTask.nome),l(5),f("ngModel",a.nuovaSottoTask.priorita),l(),m("ngValue",1),l(2),m("ngValue",2),l(2),m("ngValue",3),l(2),m("ngValue",4),l(2),m("ngValue",5)}}function ne(c,i){if(c&1){let t=S();o(0,"div",131),u("click",function(){g(t);let e=d();return _(e.chiudiModal("modificaSottoTask"))}),n()}}function oe(c,i){if(c&1){let t=S();o(0,"div",132)(1,"div",133)(2,"div",134)(3,"div",135)(4,"h5",136)(5,"i",22),s(6,"edit"),n(),s(7," Modifica Sotto Task "),n(),o(8,"button",137),u("click",function(){g(t);let e=d();return _(e.chiudiModal("modificaSottoTask"))}),n()(),o(9,"div",138)(10,"div",38)(11,"label",146),s(12,"Nome *"),n(),o(13,"input",147),T("ngModelChange",function(e){g(t);let r=d();return h(r.sottoTaskModificata.nome,e)||(r.sottoTaskModificata.nome=e),_(e)}),n()(),o(14,"div",38)(15,"label",148),s(16,"Priorit\xE0"),n(),o(17,"select",149),T("ngModelChange",function(e){g(t);let r=d();return h(r.sottoTaskModificata.priorita,e)||(r.sottoTaskModificata.priorita=e),_(e)}),o(18,"option",150),s(19,"1 - Minima"),n(),o(20,"option",151),s(21,"2 - Bassa"),n(),o(22,"option",152),s(23,"3 - Media"),n(),o(24,"option",153),s(25,"4 - Alta"),n(),o(26,"option",154),s(27,"5 - Critica"),n()()(),o(28,"div",38)(29,"label",155),s(30,"Stato"),n(),o(31,"select",156),T("ngModelChange",function(e){g(t);let r=d();return h(r.sottoTaskModificata.stato,e)||(r.sottoTaskModificata.stato=e),_(e)}),o(32,"option",157),s(33,"Da Fare"),n(),o(34,"option",158),s(35,"In Lavorazione"),n(),o(36,"option",159),s(37,"Completato"),n()()()(),o(38,"div",143)(39,"button",144),u("click",function(){g(t);let e=d();return _(e.chiudiModal("modificaSottoTask"))}),s(40,"Annulla"),n(),o(41,"button",145),u("click",function(){g(t);let e=d();return _(e.salvaModificaSottoTask())}),s(42,"Salva Modifiche"),n()()()()()}if(c&2){let t=d();l(13),f("ngModel",t.sottoTaskModificata.nome),l(4),f("ngModel",t.sottoTaskModificata.priorita),l(14),f("ngModel",t.sottoTaskModificata.stato)}}function re(c,i){if(c&1){let t=S();o(0,"div",131),u("click",function(){g(t);let e=d();return _(e.chiudiModal("dettaglio"))}),n()}}function se(c,i){if(c&1){let t=S();o(0,"div",132)(1,"div",133)(2,"div",134)(3,"div",135)(4,"h5",136)(5,"i",22),s(6,"task"),n(),s(7),n(),o(8,"button",137),u("click",function(){g(t);let e=d();return _(e.chiudiModal("dettaglio"))}),n()(),o(9,"div",138)(10,"div",38)(11,"label",160),s(12,"Nome *"),n(),o(13,"input",161),T("ngModelChange",function(e){g(t);let r=d();return h(r.dettaglioModal.nome,e)||(r.dettaglioModal.nome=e),_(e)}),n()(),o(14,"div",38)(15,"label",162),s(16,"Descrizione"),n(),o(17,"textarea",163),T("ngModelChange",function(e){g(t);let r=d();return h(r.dettaglioModal.descrizione,e)||(r.dettaglioModal.descrizione=e),_(e)}),n()(),o(18,"div",38)(19,"label",164),s(20,"Data Scadenza Prevista"),n(),o(21,"input",165),T("ngModelChange",function(e){g(t);let r=d();return h(r.dettaglioModal.data_scadenza_prevista,e)||(r.dettaglioModal.data_scadenza_prevista=e),_(e)}),n()()(),o(22,"div",143)(23,"button",144),u("click",function(){g(t);let e=d();return _(e.chiudiModal("dettaglio"))}),s(24,"Annulla"),n(),o(25,"button",166),u("click",function(){g(t);let e=d();return _(e.salvaDettaglio())}),o(26,"i",22),s(27),n(),s(28),n()()()()()}if(c&2){let t=d();l(7),C(" ",t.modalDettaglioMode==="create"?"Nuovo Task di Dettaglio":"Modifica Dettaglio"," "),l(6),f("ngModel",t.dettaglioModal.nome),l(4),f("ngModel",t.dettaglioModal.descrizione),l(4),f("ngModel",t.dettaglioModal.data_scadenza_prevista),l(4),m("disabled",t.loading),l(2),E(t.modalDettaglioMode==="create"?"save":"edit"),l(),C(" ",t.modalDettaglioMode==="create"?"Crea Dettaglio":"Salva Modifiche"," ")}}function le(c,i){if(c&1){let t=S();o(0,"div",131),u("click",function(){g(t);let e=d();return _(e.chiudiTemplateModal())}),n()}}function ce(c,i){if(c&1&&(o(0,"li")(1,"strong"),s(2),n(),s(3),n()),c&2){let t=i.$implicit;l(2),E(t.nome),l(),C(" - ",t.descrizione," ")}}function de(c,i){if(c&1&&(o(0,"ul"),x(1,ce,4,2,"li",114),n()),c&2){let t=d().$implicit;l(),m("ngForOf",t.task_dettaglio)}}function me(c,i){if(c&1&&(o(0,"div",174)(1,"strong"),s(2),n(),s(3),x(4,de,2,1,"ul",46),n()),c&2){let t=i.$implicit,a=i.index;l(2),N("",a+1,". ",t.nome),l(),C(" (Priorit\xE0: ",t.priorita,") "),l(),m("ngIf",t.task_dettaglio&&t.task_dettaglio.length>0)}}function ge(c,i){if(c&1){let t=S();o(0,"div",132)(1,"div",133)(2,"div",134)(3,"div",135)(4,"h5",136)(5,"i",22),s(6,"content_copy"),n(),s(7," Salva come Template "),n(),o(8,"button",167),u("click",function(){g(t);let e=d();return _(e.chiudiTemplateModal())}),n()(),o(9,"div",138)(10,"div",38)(11,"label",168),s(12,"Nome Template *"),n(),o(13,"input",169),T("ngModelChange",function(e){g(t);let r=d();return h(r.nomeTemplate,e)||(r.nomeTemplate=e),_(e)}),n()(),o(14,"div",38)(15,"label",170),s(16,"Descrizione"),n(),o(17,"textarea",171),T("ngModelChange",function(e){g(t);let r=d();return h(r.descrizioneTemplate,e)||(r.descrizioneTemplate=e),_(e)}),n()(),o(18,"div",38)(19,"label",43),s(20,"Anteprima Struttura"),n(),o(21,"div",172),x(22,me,5,4,"div",173),n()()(),o(23,"div",143)(24,"button",144),u("click",function(){g(t);let e=d();return _(e.chiudiTemplateModal())}),s(25,"Annulla"),n(),o(26,"button",166),u("click",function(){g(t);let e=d();return _(e.confermaCreaTemplate())}),o(27,"i",22),s(28,"save"),n(),s(29),n()()()()()}if(c&2){let t=d();l(13),f("ngModel",t.nomeTemplate),l(4),f("ngModel",t.descrizioneTemplate),l(5),m("ngForOf",(t.macroTask==null?null:t.macroTask.sotto_tasks)||R(7,wt)),l(4),m("disabled",!t.nomeTemplate.trim()||t.loading),l(),z("fa-spin",t.loading),l(2),C(" ",t.loading?"Salvataggio...":"Crea Template"," ")}}function _e(c,i){if(c&1){let t=S();o(0,"div",131),u("click",function(){g(t);let e=d();return _(e.chiudiModal("leggiDettaglio"))}),n()}}function pe(c,i){if(c&1&&(o(0,"div",38)(1,"label",43),s(2,"Scadenza prevista"),n(),o(3,"div"),s(4),O(5,"date"),n()()),c&2){let t=d().ngIf;l(4),E(D(5,1,t.data_scadenza_prevista,"dd/MM/yyyy"))}}function ue(c,i){if(c&1&&(o(0,"div",38)(1,"label",43),s(2,"Descrizione completa"),n(),o(3,"div",176),s(4),n()()),c&2){let t=d().ngIf;l(4),E(t.descrizione)}}function ve(c,i){if(c&1&&(A(0),o(1,"div",38)(2,"label",43),s(3,"Nome"),n(),o(4,"div"),s(5),n()(),x(6,pe,6,4,"div",175)(7,ue,5,1,"div",175),L()),c&2){let t=i.ngIf;l(5),E(t.nome),l(),m("ngIf",t.data_scadenza_prevista),l(),m("ngIf",t.descrizione)}}function ke(c,i){if(c&1){let t=S();o(0,"div",132)(1,"div",133)(2,"div",134)(3,"div",135)(4,"h5",136)(5,"i",22),s(6,"description"),n(),s(7," Dettaglio "),n(),o(8,"button",137),u("click",function(){g(t);let e=d();return _(e.chiudiModal("leggiDettaglio"))}),n()(),o(9,"div",138),x(10,ve,8,3,"ng-container",46),n(),o(11,"div",143)(12,"button",144),u("click",function(){g(t);let e=d();return _(e.chiudiModal("leggiDettaglio"))}),s(13,"Chiudi"),n()()()()()}if(c&2){let t=d();l(10),m("ngIf",t.selectedDettaglioView)}}var ht=class c{constructor(i,t,a,e,r,p,k,w,b){this.router=i;this.route=t;this.taskService=a;this.soggettiService=e;this.supabaseService=r;this.userService=p;this.authService=k;this.emailService=w;this.sanitizer=b}currentUser=null;macroTask=null;clienti=[];loading=!1;error="";activeDropdownId=null;selectedDettaglioView=null;modals={sottoTask:!1,dettaglio:!1,modificaSottoTask:!1,leggiDettaglio:!1};modalDettaglioMode="create";dettaglioModal={id:void 0,nome:"",descrizione:"",data_scadenza_prevista:new Date().toISOString().split("T")[0],sotto_task_id:""};sottoSearch="";sottoTaskStati=["da_fare","in_lavorazione","completato"];showTemplateModal=!1;nomeTemplate="";descrizioneTemplate="";submitted=!1;nuovaSottoTask={nome:"",priorita:3,macro_task_id:""};nuovoDettaglio={nome:"",descrizione:"",data_scadenza_prevista:new Date().toISOString().split("T")[0],sotto_task_id:""};sottoTaskModificata={};sottoTaskDaModificare=null;selectedSottoTask=null;prodotti=[];sottoTaskEspanse=new Set;espandiTutti=!1;ngOnInit(){return y(this,null,function*(){try{let t=this.authService.user();if(t&&t.id){let a=yield this.userService.getUserById(t.id);this.currentUser=a.data??null}else this.currentUser=null;this.userService.refreshAdminStatus&&(yield this.userService.refreshAdminStatus())}catch(t){console.warn("Impossibile recuperare utente corrente",t),this.currentUser=null}let i=this.route.snapshot.paramMap.get("id");i==="nuova"?this.inizializzaNuovaTask():i?yield this.caricaTask(i):this.inizializzaNuovaTask();try{yield this.caricaDatiSupporto()}catch(t){console.warn("Errore caricamento dati di supporto",t)}})}inizializzaNuovaTask(){this.macroTask={id:"",nome:"",data_scadenza:new Date().toISOString().split("T")[0],cliente_id:"",assegnazione_id:null,note:"",stato:"da_fare",priorita_globale:1,progresso:0,created_at:"",updated_at:"",sotto_tasks:[],extra_data:{}}}caricaTask(i){return y(this,null,function*(){this.loading=!0;try{let t=yield this.taskService.getMacroTaskById(i);if(t.error)this.error="Errore: "+t.error.message;else{this.macroTask=t.data;let a=new Set((this.macroTask?.sotto_tasks||[]).map(e=>e.id));this.sottoTaskEspanse.forEach(e=>{a.has(e)||this.sottoTaskEspanse.delete(e)}),this.espandiTutti&&(this.macroTask?.sotto_tasks||[]).forEach(e=>this.sottoTaskEspanse.add(e.id))}}catch(t){this.error="Errore: "+t.message}finally{this.loading=!1}})}caricaDatiSupporto(){return y(this,null,function*(){try{let i=yield this.soggettiService.getSoggettiByTipo("cliente");this.clienti=i.data||[];try{let t=yield this.supabaseService.getProdotti();this.prodotti=t?.data||[]}catch(t){console.warn("Impossibile caricare prodotti",t),this.prodotti=[]}}catch(i){console.error("Errore caricamento clienti:",i)}})}copiaMacroTask(){return y(this,null,function*(){if(this.macroTask?.id&&confirm("Creare una copia completa di questa task (sotto-task + dettagli)?")){this.loading=!0;try{let i=yield this.taskService.copyMacroTask(this.macroTask.id,this.macroTask.cliente_id);i?.error?alert("Errore copia: "+(i.error.message||"Errore sconosciuto")):i?.data?.id&&this.router.navigate(["/task-singola",i.data.id])}catch(i){console.error("Errore copia task",i),alert("Errore copia: "+(i?.message||String(i)))}finally{this.loading=!1}}})}apriModal(i,t){if(this.modals[i]=!0,i==="sottoTask"){let a=this.macroTask?.id;a&&(this.nuovaSottoTask.macro_task_id=a)}i==="dettaglio"&&t&&(this.selectedSottoTask=t,this.modalDettaglioMode="create",this.dettaglioModal={id:void 0,nome:"",descrizione:"",data_scadenza_prevista:new Date().toISOString().split("T")[0],sotto_task_id:t.id}),i==="modificaSottoTask"&&t&&(this.sottoTaskDaModificare=t,this.sottoTaskModificata={id:t.id,nome:t.nome,descrizione:t.descrizione??void 0,priorita:t.priorita,stato:t.stato})}chiudiModal(i){this.modals[i]=!1,i==="sottoTask"&&(this.nuovaSottoTask={nome:"",priorita:3,macro_task_id:""}),i==="dettaglio"&&(this.modalDettaglioMode="create",this.dettaglioModal={id:void 0,nome:"",descrizione:"",data_scadenza_prevista:new Date().toISOString().split("T")[0],sotto_task_id:this.selectedSottoTask?.id??""},this.selectedSottoTask=null),i==="modificaSottoTask"&&(this.sottoTaskDaModificare=null,this.sottoTaskModificata={})}salvaDettaglio(){return y(this,null,function*(){if(!this.dettaglioModal.nome.trim()){this.error="Il nome del dettaglio \xE8 obbligatorio";return}if(!this.dettaglioModal.sotto_task_id){this.error="Seleziona una sotto-task valida";return}try{let i;if(this.modalDettaglioMode==="create"){let t={nome:this.dettaglioModal.nome,descrizione:this.dettaglioModal.descrizione,data_scadenza_prevista:this.dettaglioModal.data_scadenza_prevista,sotto_task_id:this.dettaglioModal.sotto_task_id};if(i=yield this.taskService.createTaskDettaglio(t),!i?.error){let a=this.macroTask?.sotto_tasks?.find(e=>e.id===t.sotto_task_id);a&&a.stato==="completato"&&(a.stato="in_lavorazione"),yield this.reopenSottoTaskIfCompleted(t.sotto_task_id)}}else{if(!this.dettaglioModal.id)return;i=yield this.taskService.updateTaskDettaglio(this.dettaglioModal.id,{nome:this.dettaglioModal.nome,descrizione:this.dettaglioModal.descrizione,data_scadenza_prevista:this.dettaglioModal.data_scadenza_prevista})}i?.error?this.error="Errore: "+i.error.message:(yield this.aggiornaTask(),this.chiudiModal("dettaglio"))}catch(i){this.error="Errore: "+i.message}})}reopenSottoTaskIfCompleted(i){return y(this,null,function*(){if(i)try{let t=this.macroTask?.sotto_tasks?.find(a=>a.id===i);if(!t)return;if(t.stato==="completato"){let a=yield this.taskService.updateSottoTask(i,{stato:"in_lavorazione"});a?.error?console.warn("Impossibile riaprire sotto-task:",a.error):t.stato="in_lavorazione"}}catch(t){console.warn("Errore reopenSottoTaskIfCompleted",t)}})}salvaMacroTask(){return y(this,null,function*(){if(this.submitted=!0,!(!this.macroTask||!this.validazioneTask())){this.loading=!0,this.error="";try{let t;if(this.macroTask.id){let i=this.macroTask,{cliente:a,sotto_tasks:e}=i,r=F(i,["cliente","sotto_tasks"]),p={nome:r.nome,data_scadenza:r.data_scadenza,note:r.note||"",stato:r.stato,priorita_globale:Number(r.priorita_globale)||1,progresso:r.progresso,extra_data:this.macroTask.extra_data||{}};r.cliente_id&&this.isValidUUID(r.cliente_id)&&(p.cliente_id=r.cliente_id),r.assegnazione_id&&(p.assegnazione_id=r.assegnazione_id),console.log("Aggiorno MacroTask:",this.macroTask.id,p),t=yield this.taskService.updateMacroTask(this.macroTask.id,p)}else{let a={nome:this.macroTask.nome,data_scadenza:this.macroTask.data_scadenza,note:this.macroTask.note||"",stato:"da_fare",priorita_globale:Number(this.macroTask.priorita_globale)||1,extra_data:this.macroTask.extra_data||{}};this.macroTask.cliente_id&&this.isValidUUID(this.macroTask.cliente_id)&&(a.cliente_id=this.macroTask.cliente_id),this.macroTask.assegnazione_id&&(a.assegnazione_id=this.macroTask.assegnazione_id),t=yield this.taskService.createMacroTask(a)}t.error?this.error="Errore: "+t.error.message:t?.data?.id?this.router.navigate(["/task-singola",t.data.id]):this.router.navigate(["/task"])}catch(t){this.error="Errore: "+t.message}finally{this.loading=!1}}})}isValidUUID(i){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(i)}validazioneTask(){return this.macroTask.nome.trim()?this.macroTask.assegnazione_id?!0:(this.error="Seleziona un modulo per assegnare la task",!1):(this.error="Il nome della task \xE8 obbligatorio",!1)}creaSottoTask(){return y(this,null,function*(){if(!this.nuovaSottoTask.nome.trim()){this.error="Il nome della sotto-task \xE8 obbligatorio";return}try{let i=yield this.taskService.createSottoTask(this.nuovaSottoTask);i.error?this.error="Errore: "+i.error.message:yield this.aggiornaTask(),this.chiudiModal("sottoTask")}catch(i){this.error="Errore: "+i.message}})}creaTaskDettaglio(){return y(this,null,function*(){if(!this.nuovoDettaglio.nome.trim()){this.error="Il nome del dettaglio \xE8 obbligatorio";return}try{let i=yield this.taskService.createTaskDettaglio(this.nuovoDettaglio);i.error?this.error="Errore: "+i.error.message:(yield this.reopenSottoTaskIfCompleted(this.nuovoDettaglio.sotto_task_id),yield this.aggiornaTask()),this.chiudiModal("dettaglio")}catch(i){this.error="Errore: "+i.message}})}salvaModificaSottoTask(){return y(this,null,function*(){if(!this.sottoTaskDaModificare||!this.sottoTaskModificata.nome?.trim()){this.error="Il nome della sotto-task \xE8 obbligatorio";return}try{let i=U({nome:this.sottoTaskModificata.nome,priorita:Number(this.sottoTaskModificata.priorita)||this.sottoTaskDaModificare.priorita},this.sottoTaskModificata.stato?{stato:this.sottoTaskModificata.stato}:{}),t=yield this.taskService.updateSottoTask(this.sottoTaskDaModificare.id,i);t.error?this.error="Errore: "+t.error.message:yield this.aggiornaTask(),this.chiudiModal("modificaSottoTask")}catch(i){this.error="Errore: "+i.message}})}toggleDettaglioCompletato(i,t){return y(this,null,function*(){try{(yield this.taskService.toggleTaskDettaglioCompletato(i.id,!i.completato)).error||(i.completato=!i.completato,i.data_completamento=i.completato?new Date().toISOString():null,yield this.aggiornaStatoSottoTaskAutomatico(t),yield this.aggiornaTask())}catch(a){this.error="Errore: "+a.message}})}aggiornaStatoSottoTaskAutomatico(i){return y(this,null,function*(){if(!i.task_dettaglio?.length)return;let t=i.task_dettaglio.every(r=>r.completato),a=i.task_dettaglio.every(r=>!r.completato),e=i.stato;if(t?e="completato":a?e="da_fare":e="in_lavorazione",e!==i.stato){let r=i.stato;try{yield this.taskService.updateSottoTask(i.id,{stato:e}),i.stato=e,r!=="completato"&&e==="completato"&&(console.log("Sotto-task completata, verifica invio email...",i),this.maybeAskAndSendCompletionEmail(i).catch(p=>{console.warn("Invio email completamento sotto-task fallito:",p)}))}catch(p){console.error("Errore aggiornamento stato sotto-task:",p)}yield this.aggiornaTask()}})}aggiornaTask(){return y(this,null,function*(){let i=this.macroTask?.id;i&&(yield this.caricaTask(i))})}toggleDropdown(i,t){t?.stopPropagation(),this.activeDropdownId=this.activeDropdownId===i?null:i}isDropdownOpen(i){return this.activeDropdownId===i}closeDropdown(){this.activeDropdownId=null}puoiModificareSottoTask(i){return!i.task_dettaglio||i.task_dettaglio.length===0}getNomeCliente(i){return this.clienti.find(t=>t.id===i)?.ragione_sociale||"Non assegnato"}trackBySottoTask(i,t){return t.id}trackByDettaglio(i,t){return t.id}eliminaMacroTask(){return y(this,null,function*(){if(!this.currentUser?.is_admin){this.error="Non autorizzato";return}let i=this.macroTask?.id;if(!(!i||!confirm("Sei sicuro di voler eliminare questa macro task e tutti i contenuti collegati?"))){this.loading=!0,this.error="";try{let a=yield this.taskService.deleteMacroTaskCascade(i);if(a.error){this.error="Errore eliminazione: "+a.error.message;return}this.router.navigate(["/task"])}catch(a){this.error="Errore: "+a.message}finally{this.loading=!1}}})}eliminaDettaglio(i,t){return y(this,null,function*(){if(confirm("Sei sicuro di eliminare questo dettaglio?"))try{let a=yield this.taskService.deleteTaskDettaglio(i.id);if(a.error){this.error="Errore: "+a.error.message;return}t.task_dettaglio&&(t.task_dettaglio=t.task_dettaglio.filter(r=>r.id!==i.id)),yield this.aggiornaStatoSottoTaskAutomatico(t);let e=this.macroTask?.id;e&&(yield this.caricaTask(e))}catch(a){this.error="Errore: "+a.message}})}cambiaStatoSottoTask(i,t){return y(this,null,function*(){if(!this.puoiModificareSottoTask(i)){this.error="Impossibile modificare lo stato: questa sotto-task ha dettagli e lo stato viene gestito automaticamente";return}try{let a=yield this.taskService.updateSottoTask(i.id,{stato:t});a.error?this.error="Errore: "+a.error.message:(i.stato=t,this.macroTask&&(yield this.caricaTask(this.macroTask.id)))}catch(a){this.error="Errore: "+a.message}})}getPrioritaBadgeClass(i){return this.taskService.getPrioritaBadgeClass(i)}getStatoBadgeClass(i){return this.taskService.getStatoBadgeClass(i)}getStatoTesto(i){return this.taskService.getStatoTesto(i)}getModuloName(i){return this.taskService.getModuloName(i.assegnazione_id||null)}isScaduta(i){return this.taskService.isScaduta(i)}isScadenzaImminente(i){return this.taskService.isScadenzaImminente(i)}salvaComeTemplate(){if(!this.currentUser?.is_admin){this.error="Non autorizzato";return}if(!this.macroTask){this.error="Nessuna task da salvare come template";return}this.nomeTemplate=this.macroTask.nome+" - Template",this.descrizioneTemplate=this.macroTask.note||"",this.showTemplateModal=!0}chiudiTemplateModal(){this.showTemplateModal=!1,this.nomeTemplate="",this.descrizioneTemplate=""}confermaCreaTemplate(){return y(this,null,function*(){if(!this.macroTask||!this.nomeTemplate.trim()){this.error="Il nome del template \xE8 obbligatorio";return}this.loading=!0;try{let i={sotto_tasks:[]};if(this.macroTask.sotto_tasks)for(let e of this.macroTask.sotto_tasks){let r={nome:e.nome,priorita:e.priorita,task_dettaglio:[]};if(e.task_dettaglio)for(let p of e.task_dettaglio){let k=this.calcolaOffsetGiorni(p.data_scadenza_prevista,this.macroTask.created_at),w={nome:p.nome,descrizione:p.descrizione||"",data_scadenza_prevista_offset:k};r.task_dettaglio.push(w)}i.sotto_tasks.push(r)}let t={nome:this.nomeTemplate,descrizione:this.descrizioneTemplate||null,modulo:this.macroTask.assegnazione_id||"immagine",priorita_globale:this.macroTask.priorita_globale,data_scadenza_default:30,struttura_template:i},a=yield this.taskService.createMacroTaskTemplate(t);a.error?this.error="Errore nel salvataggio del template: "+a.error.message:(this.chiudiTemplateModal(),alert("Template salvato con successo!"))}catch(i){this.error="Errore: "+i.message}finally{this.loading=!1}})}calcolaOffsetGiorni(i,t){let a=new Date(i),e=new Date(t),r=a.getTime()-e.getTime();return Math.ceil(r/(1e3*60*60*24))}apriDettaglio(i,t){this.selectedSottoTask=t,this.modalDettaglioMode="edit",this.dettaglioModal={id:i.id,nome:i.nome,descrizione:i.descrizione??"",data_scadenza_prevista:i.data_scadenza_prevista?i.data_scadenza_prevista.split("T")[0]:new Date().toISOString().split("T")[0],sotto_task_id:t.id},this.modals.dettaglio=!0}toggleSottoTaskEspansa(i){requestAnimationFrame(()=>{this.sottoTaskEspanse.has(i)?this.sottoTaskEspanse.delete(i):this.sottoTaskEspanse.add(i)})}isSottoTaskEspansa(i){return this.sottoTaskEspanse.has(i)}toggleEspandiTutti(){this.espandiTutti=!this.espandiTutti,requestAnimationFrame(()=>{this.espandiTutti&&this.macroTask?.sotto_tasks?this.macroTask.sotto_tasks.forEach(i=>{this.sottoTaskEspanse.add(i.id)}):this.sottoTaskEspanse.clear()})}canEditTask(){return this.taskService.canModifyTask(this.currentUser,this.macroTask??null)}maybeAskAndSendCompletionEmail(i){return y(this,null,function*(){try{if(!this.currentUser?.is_admin){console.log("Utente non admin: invio email disabilitato per completamento sotto-task",i.id);return}let t=this.macroTask?.assegnazione_id==="interna",a="",e="",r="",p;if(t)a="info@prometheasrl.it",e=`Completamento attivit\xE0 interna: ${i.nome}`,r="Team Promethea";else{let M=this.macroTask?.cliente_id;if(!M){console.warn("Nessun cliente associato alla macro task");return}if(p=this.clienti.find(Tt=>Tt.id===M),!p){console.warn("Cliente non trovato");return}if(a=p.email||p.referente_email||p.contatto_email||p.mail||"",!a||!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a)){console.warn("Email cliente non valida o assente:",a);return}e=`Completamento attivit\xE0: ${i.nome}`,r=p.referente||p.ragione_sociale||"Cliente"}if(!a){console.warn("Nessun destinatario email trovato");return}if(!confirm(`La sotto-task "${i.nome}" \xE8 stata completata.

Inviare una email di notifica${t?" al team Promethea":" al cliente"}?
Destinatario: ${a}`))return;let w=(i.task_dettaglio||[]).filter(M=>M.completato).map(M=>({nome:M.nome,data:M.data_scadenza_prevista?new Date(M.data_scadenza_prevista).toLocaleDateString("it-IT"):"N/D",descrizione:M.descrizione??""}));if(w.length===0){alert("Nessun dettaglio completato trovato nella sotto-task");return}let b="",v="";if(t)b=this.emailService.generateEmailTextInterna(i.nome,w),v=this.emailService.generateEmailHtmlInterna(i.nome,w);else{let M=p??{referente:r,ragione_sociale:r};b=this.generateEmailText(M,i.nome,w),v=this.emailService.generateSottoTaskCompletionHtml?this.emailService.generateSottoTaskCompletionHtml(M,i.nome,w):`<pre style="white-space:pre-wrap;">${this.escapeHtml(b)}</pre>`}console.log("\u{1F4E4} Invio email tramite servizio Aruba...");let W=yield this.emailService.sendEmail({to:a,subject:e,message:b,html:v});W.success?alert(`Email inviata con successo ${t?"al team Promethea":"al cliente"}!`):(this.error="Invio email fallito: "+(W.error||"Errore sconosciuto"),console.error("Errore invio email:",W.error))}catch(t){console.error("Errore durante l'invio dell'email:",t),this.error="Errore invio email: "+(t?.message||String(t))}})}generateEmailText(i,t,a){let e=i.referente||i.ragione_sociale||"Cliente",r=a.map(p=>`\u2022 ${p.nome}${p.data?` (Scadenza: ${p.data})`:""}${p.descrizione?` \u2014 ${p.descrizione}`:""}`).join(`
`);return`
Gentile ${e},

la informiamo che la sotto-task "${t}" \xE8 stata completata.

DETTAGLI COMPLETATI:
${r}

Cordiali saluti,
Il Team di Promethea S.r.l.

[Questo messaggio \xE8 stato generato automaticamente]
  `.trim()}handleSottoTaskAction(i,t){switch(i){case"edit":this.apriModal("modificaSottoTask",t);break;case"delete":confirm("Eliminare questa sotto-task?")&&console.log("delete requested",t.id);break;case"add-product":console.log("add-product per",t);break;default:console.log("Azione non gestita dall'action-dropdown:",i,t)}}eliminaSottoTask(i){return y(this,null,function*(){if(i?.id&&confirm("Eliminare questa sotto-task e i dettagli associati?")){this.loading=!0;try{let t=yield this.taskService.deleteSottoTask(i.id);t?.error?alert("Errore eliminazione: "+(t.error.message||"Errore")):this.macroTask?.id&&(yield this.caricaTask(this.macroTask.id))}catch(t){console.error("Errore elimina sotto-task",t),alert("Errore eliminazione: "+(t?.message||String(t)))}finally{this.loading=!1}}})}getSottoTaskMailto(i){let a=this.clienti.find(p=>p.id===this.macroTask?.cliente_id)?.email||"",e=encodeURIComponent("Sotto-task: "+(i?.nome||"")),r=encodeURIComponent(this.buildExportTextFull(i));return`mailto:${a}?subject=${e}&body=${r}`}getMacroTaskRiepilogoMailto(){let t=(this.clienti||[]).find(p=>p.id===this.macroTask?.cliente_id)?.email||"",a=encodeURIComponent("Riepilogo Task: "+(this.macroTask?.nome||"")),e=(this.macroTask?.sotto_tasks||[]).map(p=>this.buildExportTextListOnly?this.buildExportTextListOnly(p,!1):p.nome||"").join(`

`),r=encodeURIComponent(e);return`mailto:${t}?subject=${a}&body=${r}`}getCountsAggregate(){return this.macroTask?this.taskService.getCountsAggregate(this.macroTask):{totalSotto:0,completedSotto:0,totalDet:0,completedDet:0}}buildExportTextFull(i,t=!1){let a=`Salve, vorrei vedere con te delle task che sto facendo.

Per programmare uso angular 20.0 (Controlla questa versione prima di rispondere) e ora ti dar\xF2 la lista delle task che vorrei che ti mi aiutassi a compilare.
Non dare nulla per scontato e prima di creare una nuova funzione verifica se gi\xE0 abbiamo una funzione che possiamo usare o modificare. Vorrei sempre soluzioni semplici senza complicare troppo il codice.

Ora ti dar\xF2 una lista di task con il dettaglio della stessa.

`,e=`

Ora dimmi come procedere per risolvere le task che ti ho elencato in ordine. Se hai bisogno di informazioni ulteriori per essere precisa e professionale fammi delle domande a cui posso risponderti per darti un contesto pi\xF9 preciso se ne hai bisogno.`,r=`Sotto-task: ${i.nome||"Senza nome"}

`,p=(i.task_dettaglio||[]).filter(w=>t?!w.completato:!0).map(w=>{let b=(w.nome||"").toString().trim(),v=(w.descrizione||"").toString().trim();return`- ${b}: ${v||"(nessuna descrizione)"}`}),k=p.length?p.join(`
`):"- (nessun dettaglio presente)";return`${a}${r}${k}${e}`}buildExportTextListOnly(i,t=!1){let a=`Sotto-task: ${i.nome||"Senza nome"}

`,e=(i.task_dettaglio||[]).filter(r=>t?!r.completato:!0).map(r=>{let p=(r.nome||"").toString().trim(),k=(r.descrizione||"").toString().trim();return`- ${p}: ${k||"(nessuna descrizione)"}`});return`${a}${e.length?e.join(`
`):"- (nessun dettaglio presente)"}`}exportSottoTask(i){return y(this,null,function*(){try{let t=window.confirm(`Vuoi includere anche il testo per l'IA (frase 1 e frase 2)?

Rispondi "OK" per S\xEC (testo completo) oppure "Annulla" per No (solo lista).`),a=window.confirm("Vuoi copiare solo i dettagli non completati? OK = solo non completati, Annulla = tutte"),e=t?this.buildExportTextFull(i,a):this.buildExportTextListOnly(i,a);if(typeof navigator<"u"&&navigator.clipboard&&navigator.clipboard.writeText){yield navigator.clipboard.writeText(e),alert(t?a?"Testo completo (solo non completati) copiato negli appunti.":"Testo completo copiato negli appunti.":a?"Lista dettagli (solo non completati) copiata negli appunti.":"Lista dettagli copiata negli appunti.");return}let r=new Blob([e],{type:"text/plain;charset=utf-8"}),p=URL.createObjectURL(r),k=document.createElement("a");k.href=p,k.download=`sotto-task-${i.id||"export"}.txt`,document.body.appendChild(k),k.click(),k.remove(),URL.revokeObjectURL(p),alert("Testo scaricato come file (fallback).")}catch(t){console.error("Export sotto-task error",t),alert("Errore esportazione testo: "+(t?.message||String(t)))}})}copyMacroTaskToClipboard(){return y(this,null,function*(){if(!this.macroTask)return;let i=confirm("Copiare solo i dettagli non completati? OK = solo non completati, Annulla = tutti"),t=`Macro Task: ${this.macroTask.nome||"Senza nome"}

`,a=(this.macroTask.sotto_tasks||[]).map(r=>this.buildExportTextListOnly(r,i)),e=t+(a.length?a.join(`

`):"- Nessuna sotto-task -");try{if(typeof navigator<"u"&&navigator.clipboard&&navigator.clipboard.writeText){yield navigator.clipboard.writeText(e),alert("Testo della task copiato negli appunti.");return}let r=new Blob([e],{type:"text/plain;charset=utf-8"}),p=URL.createObjectURL(r),k=document.createElement("a");k.href=p,k.download=`macro-task-${this.macroTask.id||"export"}.txt`,document.body.appendChild(k),k.click(),k.remove(),URL.revokeObjectURL(p),alert("Testo scaricato come file (fallback).")}catch(r){console.error("Errore copia task negli appunti",r),alert("Errore durante la copia negli appunti: "+(r?.message||String(r)))}})}filteredSottoTasks(){let i=(this.sottoSearch||"").trim().toLowerCase();if(!this.macroTask)return[];let t=this.macroTask.sotto_tasks||[];i&&(t=t.filter(r=>this.matchesSubtask(r,i)));let a=t.filter(r=>r.stato!=="completato"),e=t.filter(r=>r.stato==="completato");return a.sort((r,p)=>p.priorita!==r.priorita?p.priorita-r.priorita:new Date(p.created_at).getTime()-new Date(r.created_at).getTime()),e.sort((r,p)=>{let k=w=>{if(w.task_dettaglio&&w.task_dettaglio.length>0){let b=w.task_dettaglio.filter(v=>v.completato&&v.data_completamento);if(b.length>0){let v=b.reduce((W,M)=>M.data_completamento>W?M.data_completamento:W,b[0].data_completamento);return new Date(v).getTime()}}return new Date(w.updated_at||w.created_at).getTime()};return k(p)-k(r)}),[...a,...e]}matchesSubtask(i,t){if((i.nome||"").toString().toLowerCase().includes(t))return!0;let a=i.task_dettaglio||[];for(let e of a)if((e.nome||"").toString().toLowerCase().includes(t)||(e.descrizione||"").toString().toLowerCase().includes(t))return!0;return!1}escapeHtml(i){return(i||"").toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}escapeRegex(i){return(i||"").toString().replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}highlightSotto(i){let t=(this.sottoSearch||"").trim(),a=this.escapeHtml(i||"");if(!t)return this.sanitizer.bypassSecurityTrustHtml(a);let e=new RegExp(this.escapeRegex(t),"ig");return this.sanitizer.bypassSecurityTrustHtml(a.replace(e,r=>`<mark>${r}</mark>`))}highlightDettaglioNome(i){return this.highlightSotto(i)}highlightDescrizione(i){let t=(this.sottoSearch||"").trim(),a=i||"",e=a.length>100?a.slice(0,100)+"\u2026":a,r=this.escapeHtml(e);if(!t)return this.sanitizer.bypassSecurityTrustHtml(r);let p=new RegExp(this.escapeRegex(t),"ig");return this.sanitizer.bypassSecurityTrustHtml(r.replace(p,k=>`<mark>${k}</mark>`))}getTaskCounts(){if(!this.macroTask?.sotto_tasks)return{sottoTasks:0,dettagli:0};let i=this.sottoSearch?this.filteredSottoTasks():this.macroTask.sotto_tasks,t=i.length,a=i.reduce((e,r)=>e+(r.task_dettaglio?.length||0),0);return{sottoTasks:t,dettagli:a}}generateEmailTextInterna(i,t){let a=t.map(e=>`\u2022 ${e.nome}${e.data?` (Scadenza: ${e.data})`:""}${e.descrizione?` \u2014 ${e.descrizione}`:""}`).join(`
`);return`
Completamento attivit\xE0 interna:

SOTTO-TASK: ${i}

DETTAGLI COMPLETATI:
${a}

Questa email \xE8 stata generata automaticamente dal sistema di gestione task.

Cordiali saluti,
Sistema di Gestione Task Promethea
  `.trim()}getDettagliOrdinati(i){return i.task_dettaglio?[...i.task_dettaglio].sort((t,a)=>t.completato&&!a.completato?1:!t.completato&&a.completato?-1:0):[]}getSottoTaskCompletionPercent(i){let t=i?.task_dettaglio||[],a=t.length;if(a===0)return 100;let e=t.filter(r=>!!r.completato).length;return Math.round(e/a*100)}loadProdotti(){return y(this,null,function*(){try{let i=yield this.supabaseService.getProdotti();this.prodotti=i?.data||[]}catch(i){console.warn("Impossibile caricare prodotti",i),this.prodotti=[]}})}sendMacroTaskRiepilogo(i=!1){return y(this,null,function*(){if(!this.macroTask)return;let t=this.macroTask.assegnazione_id==="interna",a=this.clienti.find(v=>v.id===this.macroTask?.cliente_id),e=t?"info@prometheasrl.it":a?.email||"";if(!t&&!e){alert("Nessun indirizzo email cliente disponibile per invio.");return}if(!confirm(`${t?"Inviare riepilogo attivit\xE0 interna a info@prometheasrl.it?":"Inviare riepilogo task al cliente "+(a?.ragione_sociale||"")+" ?"}`))return;let p=`Macro Task: ${this.macroTask.nome||"Senza nome"}

`,k=(this.macroTask.sotto_tasks||[]).map(v=>this.buildExportTextListOnly(v,i)),w=p+(k.length?k.join(`

`):"- Nessuna sotto-task -"),b=`<pre style="white-space:pre-wrap;font-family:inherit">${w.replace(/</g,"&lt;")}</pre>`;try{let v=yield this.emailService.sendEmail({to:e,subject:t?`Riepilogo attivit\xE0 interna: ${this.macroTask.nome}`:`Riepilogo Task: ${this.macroTask.nome}`,message:w,html:b});v?.success?alert("Riepilogo inviato con successo."):alert("Invio fallito: "+(v?.error||"Errore sconosciuto"))}catch(v){console.error("Errore invio riepilogo:",v),alert("Errore invio: "+(v?.message||String(v)))}})}sendSottoTaskRiepilogo(i,t=!1){return y(this,null,function*(){if(!i)return;let a=this.macroTask?.assegnazione_id==="interna",e=this.clienti.find(v=>v.id===this.macroTask?.cliente_id),r=a?"info@prometheasrl.it":e?.email||"";if(!a&&!r){alert("Nessun indirizzo email cliente disponibile per invio.");return}if(!confirm(`${a?"Inviare riepilogo attivit\xE0 interna a info@prometheasrl.it?":"Inviare riepilogo sotto-task al cliente "+(e?.ragione_sociale||"")+" ?"}`))return;let k=this.buildExportTextListOnly(i,t),w=e??{referente:e?.ragione_sociale||"Cliente"},b=this.emailService.generateSottoTaskCompletionHtml?this.emailService.generateSottoTaskCompletionHtml(w,i.nome,(i.task_dettaglio||[]).filter(v=>t?!v.completato:!0).map(v=>({nome:v.nome,data:v.data_scadenza_prevista,descrizione:v.descrizione}))):`<pre style="white-space:pre-wrap;">${this.escapeHtml(k)}</pre>`;try{let v=yield this.emailService.sendEmail({to:r,subject:a?`Riepilogo attivit\xE0 interna: ${i.nome}`:`Riepilogo sotto-task: ${i.nome}`,message:k,html:b});v?.success?alert("Email inviata con successo."):alert("Invio fallito: "+(v?.error||"Errore sconosciuto"))}catch(v){console.error("Errore invio sotto-task:",v),alert("Errore invio: "+(v?.message||String(v)))}})}onAssocTipoChange(){if(!this.macroTask)return;this.macroTask.extra_data=this.macroTask.extra_data||{};let i=this.macroTask.extra_data.tipo_assoc;i!=="cliente"&&(this.macroTask.cliente_id=""),i!=="prodotto"&&this.macroTask.extra_data&&(this.macroTask.extra_data.prodotto_id="")}static \u0275fac=function(t){return new(t||c)(P(it),P(et),P(ft),P(ut),P(at),P(ot),P(nt),P(xt),P(tt))};static \u0275cmp=q({type:c,selectors:[["app-task-singola"]],hostBindings:function(t,a){t&1&&u("click",function(){return a.closeDropdown()},H)},decls:23,vars:16,consts:[["nomeCtrl","ngModel"],["assegnazioneCtrl","ngModel"],["tplNessunaSottoTask",""],["ad",""],["stNomeCtrl","ngModel"],["title","Caricamento task...","subtitle","Caricamento contenuti della task in corso...",3,"isLoading"],[1,"task-detail-container"],[1,"form-section"],[1,"section-header"],[1,"section-titles"],[1,"section-title"],[1,"material-icons","header-icon"],["class","table-section",4,"ngIf"],["class","header-actions",4,"ngIf"],["class","status-message error",4,"ngIf"],["class","task-content marcotaskform",4,"ngIf"],["class","modal-backdrop show",3,"click",4,"ngIf"],["class","modal show d-block","tabindex","-1",4,"ngIf"],[1,"table-section"],[1,"text-muted"],[1,"header-actions"],[1,"promethea-button","secondary",3,"click"],[1,"material-icons"],[1,"btn-text"],["type","button",1,"promethea-button","outline",3,"click"],["target","_blank","rel","noopener noreferrer","title","Invia riepilogo al cliente",1,"promethea-button","outline",3,"click"],["class","promethea-button delete",3,"disabled","click",4,"ngIf"],["class","promethea-button edit",3,"disabled","click",4,"ngIf"],[1,"promethea-button","primary",3,"click","disabled"],[1,"promethea-button","delete",3,"click","disabled"],[1,"promethea-button","edit",3,"click","disabled"],[1,"status-message","error"],[1,"task-content","marcotaskform"],[1,"main-section"],[1,"grid-form"],[1,"form-field","full-width"],["for","nome",1,"form-label"],["type","text","id","nome","name","nome","required","","placeholder","Inserisci il nome della task",3,"ngModelChange","ngModel"],[1,"form-field"],["for","data_scadenza",1,"form-label"],["type","date","id","data_scadenza",3,"ngModelChange","ngModel"],["for","stato",1,"form-label"],["type","text","id","stato","disabled","",3,"value"],[1,"form-label"],[2,"display","flex","gap","12px","align-items","center","margin-bottom","8px"],["type","radio","name","assocTipoMain",3,"ngModelChange","change","ngModel","value"],[4,"ngIf"],["for","priorita",1,"form-label"],["id","priorita",3,"ngModelChange","ngModel"],[3,"ngValue",4,"ngFor","ngForOf"],["for","assegnazione_id",1,"form-label"],["id","assegnazione_id","name","assegnazione_id","required","",3,"ngModelChange","ngModel"],[3,"value"],["value","immagine"],["value","digitalizzazione"],["value","contabilita"],["value","ottimizzazione"],["value","tutti"],["for","note",1,"form-label"],["id","note","rows","4","placeholder","Aggiungi note o descrizione...",3,"ngModelChange","ngModel"],["class","form-actions",4,"ngIf"],[1,"tool",2,"margin-top","var(--gutter-lg)"],["for","search",1,"label"],["id","search","type","text","placeholder","Cerca in sotto-task / dettagli...",1,"table-inline-input",3,"ngModelChange","ngModel"],[1,"counter-container",2,"display","flex","gap","8px","margin-top","8px","flex-wrap","wrap"],["class","form-section",4,"ngIf"],[1,"form-section","riepilogo"],[1,"card","info-card"],[1,"info-grid"],[1,"info-item"],[1,"badge",3,"ngClass"],[1,"progress","flex-1"],[1,"progress-bar",3,"ngClass"],[1,"progress-text"],["type","radio","name","assocTipo",3,"ngModelChange","change","ngModel","value"],["for","cliente_id",1,"form-label"],["id","cliente_id",3,"ngModelChange","ngModel"],[3,"ngValue"],["for","prodotto_id",1,"form-label"],["id","prodotto_id",3,"ngModelChange","ngModel"],[1,"form-actions"],[1,"promethea-button",2,"margin-top","var(--gutter-lg)",3,"click","disabled"],[1,"chip"],[1,"card-number",2,"font-size","var(--fs-md)"],[1,"promethea-button","outline",3,"click","title"],[1,"promethea-button","outline",3,"click"],["class","contenitore-sottotask",4,"ngIf","ngIfElse"],[1,"empty-state"],[1,"contenitore-sottotask"],["class","card sotto-task-card",3,"expanded","dropdown-open",4,"ngFor","ngForOf","ngForTrackBy"],[1,"card","sotto-task-card"],[1,"sotto-task-header",3,"click"],[1,"sotto-task-info"],[1,"icon-btn","expand",3,"click","title"],[1,"sotto-task-content"],[1,"sotto-task-title",3,"innerHTML"],[1,"sotto-task-meta"],[1,"badge"],["class","dettaglio-counter",4,"ngIf"],[1,"sotto-task-actions",3,"click"],["title","Modifica sotto-task",1,"action-btn",3,"click"],["title","Esporta dettagli (copia testo)",1,"action-btn",3,"click"],["mode","modal",3,"action","row"],["dropdown-items","",3,"click"],[1,"dropdown-item",3,"click"],["class","action-btn","style","cursor: auto;","title","Stato gestito automaticamente dai dettagli",4,"ngIf"],[1,"dettaglio-container"],["class","dettaglio-list",4,"ngIf"],["class","empty-state",4,"ngIf"],[1,"dettaglio-counter"],[1,"progress-section",2,"margin-top","6px","width","160px"],["aria-hidden","true",1,"progress",2,"height","16px"],[1,"progress-text",2,"font-size","0.75rem"],[1,"dropdown-header"],[4,"ngFor","ngForOf"],[1,"dropdown-divider"],["title","Stato gestito automaticamente dai dettagli",1,"action-btn",2,"cursor","auto"],[1,"dettaglio-list"],["class","dettaglio-item",4,"ngFor","ngForOf","ngForTrackBy"],[1,"dettaglio-item"],[1,"dettaglio-content"],["type","checkbox",3,"change","click","mousedown","checked"],[1,"dettaglio-info"],[1,"dettaglio-header"],[3,"innerHTML"],[1,"dettaglio-actions",3,"click"],["title","Modifica dettaglio",1,"icon-btn",3,"click"],["title","Elimina dettaglio",1,"icon-btn","danger",3,"click"],["class","dettaglio-descrizione text-muted",3,"innerHTML","click",4,"ngIf"],[1,"dettaglio-descrizione","text-muted",3,"click","innerHTML"],[3,"click"],[1,"modal-backdrop","show",3,"click"],["tabindex","-1",1,"modal","show","d-block"],[1,"modal-dialog"],[1,"modal-content"],[1,"modal-header"],[1,"modal-title"],["type","button","aria-label","Chiudi",1,"icon-btn","close",3,"click"],[1,"modal-body"],["for","stNome",1,"form-label"],["id","stNome","name","stNome","required","","type","text","placeholder","Inserisci nome sotto-task",3,"ngModelChange","ngModel"],["for","stPriorita",1,"form-label"],["id","stPriorita",3,"ngModelChange","ngModel"],[1,"modal-footer"],["type","button",1,"promethea-button","secondary",3,"click"],["type","button",1,"promethea-button",3,"click"],["for","modificaNome",1,"form-label"],["type","text","id","modificaNome","placeholder","Inserisci il nome della sotto task",3,"ngModelChange","ngModel"],["for","modificaPriorita",1,"form-label"],["id","modificaPriorita",3,"ngModelChange","ngModel"],["value","1"],["value","2"],["value","3"],["value","4"],["value","5"],["for","modificaStato",1,"form-label"],["id","modificaStato",3,"ngModelChange","ngModel"],["value","da_fare"],["value","in_lavorazione"],["value","completato"],["for","dettaglioNome",1,"form-label"],["type","text","id","dettaglioNome","placeholder","Inserisci il nome del dettaglio",3,"ngModelChange","ngModel"],["for","dettaglioDescrizione",1,"form-label"],["id","dettaglioDescrizione","rows","3","placeholder","Aggiungi una descrizione...",3,"ngModelChange","ngModel"],["for","dettaglioScadenza",1,"form-label"],["type","date","id","dettaglioScadenza",3,"ngModelChange","ngModel"],["type","button",1,"promethea-button",3,"click","disabled"],["type","button",1,"icon-btn",3,"click"],["for","nomeTemplate",1,"form-label"],["type","text","id","nomeTemplate","placeholder","Inserisci un nome per il template",3,"ngModelChange","ngModel"],["for","descrizioneTemplate",1,"form-label"],["id","descrizioneTemplate","rows","3","placeholder","Aggiungi una descrizione...",3,"ngModelChange","ngModel"],[1,"template-preview"],["class","sotto-task-preview",4,"ngFor","ngForOf"],[1,"sotto-task-preview"],["class","form-field",4,"ngIf"],[2,"white-space","pre-wrap"]],template:function(t,a){t&1&&(I(0,"app-page-loader",5),o(1,"div",6)(2,"div",7)(3,"div",8)(4,"div",9)(5,"h1",10)(6,"i",11),s(7,"task"),n(),s(8),n(),x(9,Ct,3,1,"div",12),n(),x(10,Et,23,6,"div",13),n()(),x(11,zt,4,1,"div",14)(12,ee,130,58,"div",15)(13,ie,1,0,"div",16)(14,ae,34,9,"div",17)(15,ne,1,0,"div",16)(16,oe,43,3,"div",17)(17,re,1,0,"div",16)(18,se,29,7,"div",17)(19,le,1,0,"div",16)(20,ge,30,8,"div",17)(21,_e,1,0,"div",16)(22,ke,14,1,"div",17),n()),t&2&&(m("isLoading",a.loading&&!a.macroTask),l(8),C(" ",a.macroTask!=null&&a.macroTask.id?"Modifica Task":"Nuova Macro Task"," "),l(),m("ngIf",a.macroTask==null?null:a.macroTask.id),l(),m("ngIf",a.macroTask==null?null:a.macroTask.id),l(),m("ngIf",a.error),l(),m("ngIf",a.macroTask),l(),m("ngIf",a.modals.sottoTask),l(),m("ngIf",a.modals.sottoTask),l(),m("ngIf",a.modals.modificaSottoTask),l(),m("ngIf",a.modals.modificaSottoTask),l(),m("ngIf",a.modals.dettaglio),l(),m("ngIf",a.modals.dettaglio),l(),m("ngIf",a.showTemplateModal),l(),m("ngIf",a.showTemplateModal),l(),m("ngIf",a.modals.leggiDettaglio),l(),m("ngIf",a.modals.leggiDettaglio))},dependencies:[Z,Q,J,X,pt,mt,gt,rt,dt,ct,st,_t,lt,kt,vt,Y],styles:['.section-title[_ngcontent-%COMP%]{margin:0}.header-actions[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:var(--gutter-sm);width:100%;max-width:320px;container-type:inline-size;padding:var(--gutter-md)}@container (max-width: 300px){.header-actions[_ngcontent-%COMP%]{grid-template-columns:1fr;max-width:100%}}@container (min-width: 301px) and (max-width: 500px){.header-actions[_ngcontent-%COMP%]{grid-template-columns:1fr 1fr;max-width:280px}}@container (min-width: 501px){.header-actions[_ngcontent-%COMP%]{grid-template-columns:1fr 1fr;max-width:320px}}.section-header[_ngcontent-%COMP%]{align-items:flex-start;justify-content:space-between;container-type:inline-size;margin:0}.task-detail-container[_ngcontent-%COMP%]{padding:var(--gutter-lg);background:var(--background);min-height:100vh}.task-content[_ngcontent-%COMP%]{display:grid;grid-template-columns:minmax(0,1fr) minmax(260px,350px);gap:var(--gutter-lg);align-items:flex-start}@container (max-width: 600px){.section-header[_ngcontent-%COMP%]{flex-direction:column;align-items:stretch;gap:var(--gutter-md)}.header-actions[_ngcontent-%COMP%]{max-width:100%;justify-self:center}}.header-actions[_ngcontent-%COMP%]   .promethea-button[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;gap:var(--gutter-sm);padding:var(--gutter-sm) var(--gutter-md);font-size:var(--fs-sm);min-height:2.5rem;white-space:nowrap}@container (max-width: 160px){.header-actions[_ngcontent-%COMP%]   .promethea-button[_ngcontent-%COMP%]   .btn-text[_ngcontent-%COMP%]{display:none}.header-actions[_ngcontent-%COMP%]   .promethea-button[_ngcontent-%COMP%]{padding:var(--gutter-md);min-width:2.5rem}}.main-section[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:var(--gutter-md);min-width:0}.task-card[_ngcontent-%COMP%]{position:relative;border-left:4px solid var(--primary);padding:var(--gutter-lg);gap:var(--gutter-sm);border-radius:18px;display:flex;flex-direction:column;justify-content:space-between;height:100%}.task-card[_ngcontent-%COMP%]   .card-body[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:var(--gutter-sm)}.task-card.scaduta[_ngcontent-%COMP%]{border-left-color:#ef4444;background:linear-gradient(135deg,var(--background) 0%,color-mix(in srgb,#ef4444 8%,transparent) 100%)}.task-header[_ngcontent-%COMP%]{display:flex;align-items:flex-start;gap:var(--gutter-sm);margin-bottom:var(--gutter-sm);flex-wrap:wrap}.task-main-info[_ngcontent-%COMP%]{flex:1;min-width:0}.task-title[_ngcontent-%COMP%]{cursor:pointer;margin-bottom:var(--gutter-sm)}.task-meta-compact[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:4px}.meta-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:var(--gutter-sm);color:color-mix(in srgb,var(--text-color) 60%,transparent)}.task-header-actions[_ngcontent-%COMP%]{display:flex;align-items:center;gap:var(--gutter-sm);flex-shrink:0;margin-left:auto}.priority-badge[_ngcontent-%COMP%]{display:inline-flex;align-items:center;justify-content:center;min-width:5rem;height:var(--fs-md);padding:0 var(--gutter-sm);border-radius:6px;font-weight:700;border:1px solid var(--smoke-color-1);background:color-mix(in srgb,var(--text-color) 10%,transparent);text-transform:uppercase;letter-spacing:.5px}.priority-badge[data-priority="5"][_ngcontent-%COMP%]{background:linear-gradient(90deg,#6b0218,#a50b1f);color:#fff;border:1px solid rgba(0,0,0,.12);box-shadow:0 6px 16px #a50b1f1f}.priority-badge[data-priority="4"][_ngcontent-%COMP%]{background:linear-gradient(90deg,#ef4444,#c53030);color:#fff;border:1px solid rgba(0,0,0,.08)}.priority-badge[data-priority="3"][_ngcontent-%COMP%]{background:linear-gradient(90deg,#f59e0b,#d97706);color:#1a1a1a;border:1px solid rgba(0,0,0,.06)}.priority-badge[data-priority="2"][_ngcontent-%COMP%]{background:linear-gradient(90deg,#10b981,#059669);color:#fff;border:1px solid rgba(0,0,0,.06)}.priority-badge[data-priority="1"][_ngcontent-%COMP%], .priority-badge[data-priority="0"][_ngcontent-%COMP%], .priority-badge[_ngcontent-%COMP%]:not([data-priority]){background:color-mix(in srgb,var(--text-color) 6%,transparent);color:var(--text-color);border:1px solid var(--smoke-color-1)}.progress-section[_ngcontent-%COMP%]{margin:var(--gutter-sm) 0}.progress-info[_ngcontent-%COMP%]{display:flex;align-items:center;gap:var(--gutter-sm)}.progress-stats[_ngcontent-%COMP%]{flex-shrink:0}.scadenza-date[_ngcontent-%COMP%]{font-weight:700;margin-top:var(--gutter-sm)}.task-counts-grid[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:var(--gutter-sm);margin:var(--gutter-sm) 0}.count-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;padding:var(--gutter-sm);background:var(--smoke-color-2);border-radius:8px;border:1px solid var(--smoke-color-1)}.count-badge[_ngcontent-%COMP%]{display:inline-flex;align-items:center;justify-content:center;width:var(--fs-md);height:var(--fs-md);padding:var(--gutter-sm);border-radius:50%;font-weight:700;color:#fff}.count-badge.da-fare[_ngcontent-%COMP%]{background:#42464d}.count-badge.in-lavorazione[_ngcontent-%COMP%]{background:var(--secondary)}.count-badge.completate[_ngcontent-%COMP%]{background:#10b981}.count-label[_ngcontent-%COMP%]{margin-top:4px;text-align:center;color:color-mix(in srgb,var(--text-color) 70%,transparent);text-transform:uppercase;letter-spacing:.5px}.task-footer[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding-top:var(--gutter-sm);border-top:1px solid var(--smoke-color-1);margin-top:auto}.sotto-task-card[_ngcontent-%COMP%]{border-left:4px solid var(--primary);display:flex;flex-direction:column;height:100%;container-type:inline-size;min-width:0;position:relative;overflow:visible}.sotto-task-card.expanded[_ngcontent-%COMP%]{box-shadow:0 8px 24px var(--shadow2);border-color:var(--primary)}.sotto-task-card[_ngcontent-%COMP%]   .dropdown-menu[_ngcontent-%COMP%]{z-index:50}.sotto-task-header[_ngcontent-%COMP%]{display:flex;align-items:flex-start;gap:var(--gutter-sm);margin-bottom:var(--gutter-sm);flex-wrap:wrap;cursor:pointer}.sotto-task-info[_ngcontent-%COMP%]{flex:1 1 auto;min-width:0;display:flex;align-items:flex-start;gap:var(--gutter-sm)}.sotto-task-content[_ngcontent-%COMP%]{flex:1;min-width:0}.sotto-task-meta[_ngcontent-%COMP%]{display:flex;gap:var(--gutter-sm);align-items:center;flex-wrap:wrap;margin-top:.25rem}.sotto-task-actions[_ngcontent-%COMP%]{display:flex;align-items:center;gap:var(--gutter-sm);margin-left:auto;flex:1 1 auto;justify-content:flex-end;flex-wrap:wrap;min-width:0;max-width:100%;position:relative;z-index:2}.dettaglio-container[_ngcontent-%COMP%]{max-height:0;overflow:hidden;opacity:0;transition:max-height .5s cubic-bezier(.4,0,.2,1),opacity .3s ease .1s}.dettaglio-container.show[_ngcontent-%COMP%]{max-height:5000px;opacity:1;transition:max-height .8s cubic-bezier(.4,0,.2,1),opacity .4s ease .1s}.dettaglio-list[_ngcontent-%COMP%]{border-top:1px solid var(--smoke-color-1);padding-top:var(--gutter-sm);display:flex;flex-direction:column;gap:var(--gutter-sm)}.dettaglio-item[_ngcontent-%COMP%]{padding:var(--gutter-sm);background:var(--background);border-radius:10px;border:1px solid var(--smoke-color-1);transition:all .2s ease}.dettaglio-item[_ngcontent-%COMP%]:hover{border-color:var(--primary);background:var(--smoke-color-2)}.dettaglio-content[_ngcontent-%COMP%]{display:grid;grid-template-columns:auto 1fr;column-gap:var(--gutter-sm);justify-content:center;align-items:first baseline}.dettaglio-descrizione[_ngcontent-%COMP%]{padding:var(--gutter-sm) 0}.dettaglio-header[_ngcontent-%COMP%]{display:grid;grid-template-columns:minmax(0,1fr) auto auto;align-items:center;gap:var(--gutter-sm)}.dettaglio-header[_ngcontent-%COMP%]   strong.completed[_ngcontent-%COMP%]{text-decoration:line-through;color:color-mix(in srgb,var(--text-color) 50%,transparent)}.dettaglio-counter[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.25rem;font-size:.75rem;color:color-mix(in srgb,var(--text-color) 60%,transparent);background:var(--smoke-color-2);padding:.125rem .5rem;border-radius:12px;border:1px solid var(--smoke-color-1)}.sotto-task-card[_ngcontent-%COMP%]:not(.expanded)   .dettaglio-counter[_ngcontent-%COMP%]{background:color-mix(in srgb,var(--primary) 15%,transparent);color:var(--primary);border-color:color-mix(in srgb,var(--primary) 30%,transparent)}.form-section.riepilogo[_ngcontent-%COMP%]{padding:0;background:transparent;border:none;box-shadow:none;align-self:flex-start;position:sticky;top:var(--gutter-lg)}.contenitore-sottotask[_ngcontent-%COMP%]{gap:var(--gutter-md);display:flex;flex-direction:column}.marcotaskform[_ngcontent-%COMP%]{margin-top:var(--gutter-lg)!important}.info-card[_ngcontent-%COMP%]{background:var(--background);border:1px solid var(--smoke-color-1);border-radius:16px;padding:var(--gutter-lg);box-shadow:0 4px 12px var(--shadow);position:sticky;top:var(--gutter-lg);z-index:10}.info-card[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{color:var(--text-color);margin-bottom:var(--gutter-sm);font-weight:600;border-bottom:2px solid var(--primary);padding-bottom:var(--gutter-sm)}.info-item[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;gap:var(--gutter-sm);padding:var(--gutter-sm) 0;border-bottom:1px solid color-mix(in srgb,var(--text-color) 15%,transparent)}.info-item[_ngcontent-%COMP%]:last-child{border-bottom:none}.info-item[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{font-weight:500;color:var(--text-color);margin:0}.info-item[_ngcontent-%COMP%]   span.scaduta[_ngcontent-%COMP%]{color:#e74c3c;font-weight:500}.info-item[_ngcontent-%COMP%]   span.imminente[_ngcontent-%COMP%]{color:#f39c12;font-weight:500}.form-section.riepilogo[_ngcontent-%COMP%]{padding:0;background:transparent;border:none;box-shadow:none;align-self:flex-start;position:sticky;top:var(--gutter-lg);z-index:10}.sotto-task-actions[_ngcontent-%COMP%]   .action-btn[_ngcontent-%COMP%], .sotto-task-actions[_ngcontent-%COMP%]   .dropdown[_ngcontent-%COMP%]{flex:0 0 auto}.dropdown[_ngcontent-%COMP%]{position:relative;display:inline-block}.dropdown-menu[_ngcontent-%COMP%]{position:absolute;top:100%;right:0;display:none;min-width:180px;padding:8px 0;margin:4px 0 0;background:var(--background);border:1px solid var(--smoke-color-1);border-radius:8px;box-shadow:0 4px 12px var(--shadow);list-style:none;z-index:10000}.dropdown-menu.show[_ngcontent-%COMP%]{display:block}.dropdown-header[_ngcontent-%COMP%]{padding:var(--gutter-sm);font-weight:800;background:color-mix(in srgb,var(--text-color) 10%,transparent);text-transform:uppercase;border-bottom:1px solid color-mix(in srgb,var(--text-color) 30%,transparent)}.dropdown-menu[_ngcontent-%COMP%], .dropdown-menu[_ngcontent-%COMP%]   li[_ngcontent-%COMP%], .dropdown-header[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]{list-style:none}.dropdown-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;width:100%;padding:8px 16px;background:transparent;border:none;color:var(--text-color);text-align:left;text-decoration:none;cursor:pointer;transition:all .2s ease;font-size:.85em}.dropdown-item[_ngcontent-%COMP%]:hover{background:var(--smoke-color-2);color:var(--primary)}.dropdown-divider[_ngcontent-%COMP%]{height:1px;background:var(--smoke-color-1);margin:8px 0;border:none}.sotto-task-card.dropdown-open[_ngcontent-%COMP%]{z-index:200}.dettaglio-actions[_ngcontent-%COMP%]{display:flex;align-items:center;gap:var(--gutter-sm)}.grid-responsive-tasks[_ngcontent-%COMP%]{grid-template-columns:repeat(auto-fit,minmax(380px,1fr));display:grid;gap:var(--gutter-lg)}@media (max-width: 1024px){.task-content[_ngcontent-%COMP%]{grid-template-columns:1fr}.form-section.riepilogo[_ngcontent-%COMP%]{position:static;order:-1}}@media (max-width: 768px){.section-header[_ngcontent-%COMP%]{display:flex;flex-direction:column}.contenitore-bottoni[_ngcontent-%COMP%]{display:flex;justify-content:center}.section-title[_ngcontent-%COMP%]{display:flex;flex-direction:row;justify-content:center}.sotto-task-header[_ngcontent-%COMP%], .task-header[_ngcontent-%COMP%]{flex-direction:column;align-items:stretch}.sotto-task-actions[_ngcontent-%COMP%], .task-header-actions[_ngcontent-%COMP%]{margin-left:0;justify-content:flex-start}.dettaglio-header[_ngcontent-%COMP%]{grid-template-columns:1fr;gap:var(--gutter-sm)}.sotto-tasks-counts[_ngcontent-%COMP%]{grid-template-columns:1fr}.sotto-task-global-actions[_ngcontent-%COMP%]{flex-direction:column;width:100%;margin-top:var(--gutter-sm)}}.search-highlight[_ngcontent-%COMP%], mark.search-highlight[_ngcontent-%COMP%]{display:inline!important;background:#ffeb3b65;padding:0 .12em;border-radius:2px;line-height:inherit;vertical-align:baseline}']})};export{ht as TaskSingola};
