import{a as j}from"./chunk-2QDHCWUP.js";import{a as V}from"./chunk-3WLDIF5C.js";import"./chunk-P5EFXTG7.js";import"./chunk-WMLYL4YD.js";import{b as Y,c as B}from"./chunk-Q4FMGKSF.js";import{c as M,d as O,e as A,g as F,j as U,p as q}from"./chunk-NOCF4HQD.js";import{Ab as y,Ga as P,La as d,S as _,Wa as m,Xa as e,Ya as t,Za as T,bb as z,cb as L,ea as k,hb as g,ib as b,mb as i,nb as c,ob as R,ua as l,ub as D,vb as H,xb as w,yb as N}from"./chunk-PE6PP35I.js";import"./chunk-X5YLR3NI.js";import{i as h}from"./chunk-ODN5LVDJ.js";var J=()=>["Richiamare","Contratto Chiuso"],Q=(r,n,a)=>({"badge-warning":r,"badge-success":n,"badge-info":a});function W(r,n){r&1&&T(0,"app-page-loader",4)}function X(r,n){if(r&1&&(e(0,"div",28),i(1),t()),r&2){let a=g(2);l(),c(a.error)}}function Z(r,n){if(r&1&&(z(0),e(1,"span",40),i(2),t(),L()),r&2){let a=n.ngIf;l(),m("ngClass",H(3,Q,a.tipo==="Richiamare",a.tipo==="Appuntamento",!D(2,J).includes(a.tipo))),l(),R(" ",a.tipo," ")}}function ee(r,n){r&1&&(e(0,"span",41),i(1,"Nessun contatto"),t())}function te(r,n){if(r&1&&(e(0,"tr")(1,"td",32)(2,"div",33)(3,"strong"),i(4),t()()(),e(5,"td",34)(6,"div",33),i(7),t()(),e(8,"td",35)(9,"div",33),i(10),t()(),e(11,"td",36)(12,"div",33),i(13),t()(),e(14,"td",37)(15,"div",33),d(16,Z,3,7,"ng-container",38)(17,ee,2,0,"ng-template",null,1,y),t()(),e(19,"td",39)(20,"div",33),i(21),w(22,"date"),t()()()),r&2){let a=n.$implicit,o=b(18),p=g(3);l(4),c(a.ragione_sociale),l(3),c(a.telefono||"\u2014"),l(3),c(a.email||"\u2014"),l(3),c(a.provincia||"\u2014"),l(3),m("ngIf",p.getLastEsito(a.esiti))("ngIfElse",o),l(5),c(N(22,7,a.created_at,"dd/MM/yyyy"))}}function ie(r,n){if(r&1&&(e(0,"div",29)(1,"table",30)(2,"thead")(3,"tr")(4,"th"),i(5,"Ragione Sociale"),t(),e(6,"th"),i(7,"Telefono"),t(),e(8,"th"),i(9,"Email"),t(),e(10,"th"),i(11,"Provincia"),t(),e(12,"th"),i(13,"Ultimo Esito"),t(),e(14,"th"),i(15,"Creato il"),t()()(),e(16,"tbody"),d(17,te,23,10,"tr",31),t()()()),r&2){let a=g(2);l(17),m("ngForOf",a.ultimiProspect)}}function ae(r,n){r&1&&(e(0,"div",42),i(1,"Nessun prospect trovato."),t())}function ne(r,n){if(r&1&&(e(0,"div")(1,"div",5)(2,"div",6)(3,"i",7),i(4,"dashboard"),t(),e(5,"div",8)(6,"h2",9),i(7,"Dashboard CRM"),t(),e(8,"p",10),i(9,"Panoramica rapida su attivit\xE0 e KPI"),t()()(),d(10,X,2,1,"div",11),e(11,"div",12)(12,"a",13)(13,"h3",14),i(14,"Totale Prospect"),t(),e(15,"div",15),i(16),t()(),e(17,"a",16)(18,"h3",14),i(19,"Totale Clienti"),t(),e(20,"div",15),i(21),t()(),e(22,"a",13)(23,"h3",14),i(24,"Da Richiamare"),t(),e(25,"div",15),i(26),t()(),e(27,"a",13)(28,"h3",14),i(29,"Senza Contatto"),t(),e(30,"div",15),i(31),t()(),e(32,"a",13)(33,"h3",14),i(34,"Configurati"),t(),e(35,"div",15),i(36),t()(),e(37,"a",17)(38,"h3",14),i(39,"Trattative YUVI"),t(),e(40,"div",15),i(41),t()(),e(42,"a",18)(43,"h3",14),i(44,"Trattative Promethea"),t(),e(45,"div",15),i(46),t()(),e(47,"a",19)(48,"h3",14),i(49,"Referenze da CTR"),t(),e(50,"div",15),i(51),t()()(),e(52,"div",20)(53,"a",21),i(54,"Nuovo Prospect"),t(),e(55,"a",22),i(56,"Nuova Trattativa YUVI"),t(),e(57,"a",23),i(58,"Visualizza KPI"),t()()(),e(59,"div",24)(60,"div",6)(61,"i",7),i(62,"group"),t(),e(63,"div",8)(64,"h3",9),i(65,"Ultimi Prospect"),t(),e(66,"p",10),i(67,"Gli ultimi inserimenti nel sistema"),t()()(),d(68,ie,18,1,"div",25)(69,ae,2,0,"ng-template",null,0,y),e(71,"div",26)(72,"a",27),i(73,"Vai alla lista prospect"),t()()()()),r&2){let a=b(70),o=g();l(10),m("ngIf",o.error),l(6),c(o.kpi.prospect),l(5),c(o.kpi.clienti),l(5),c(o.kpi.daRichiamare),l(5),c(o.kpi.senzaContatto),l(5),c(o.kpi.configurati),l(5),c(o.kpi.trattativeYuvi),l(5),c(o.kpi.trattativePromethea),l(5),c(o.kpi.referenzeCtr),l(17),m("ngIf",o.ultimiProspect.length>0)("ngIfElse",a)}}var K=class r{soggetti=_(V);supabase=_(Y);authService=_(B);isLoading=k(!0);error=null;kpi={prospect:0,clienti:0,daRichiamare:0,senzaContatto:0,configurati:0,trattativeYuvi:0,trattativePromethea:0,referenzeCtr:0};ultimiProspect=[];ngOnInit(){return h(this,null,function*(){console.log("\u{1F3E0} Home - Inizio caricamento"),this.isLoading.set(!0);try{yield this.loadData(),console.log("\u2705 Home - Caricamento completato")}catch(n){console.error("\u274C Errore in ngOnInit:",n)}finally{setTimeout(()=>{this.isLoading.set(!1),console.log("\u{1F44B} Home - Loader nascosto")},500)}})}getLastEsito(n){if(!Array.isArray(n)||n.length===0)return null;let a=n[0];for(let o of n)new Date(o.ts).getTime()>new Date(a.ts).getTime()&&(a=o);return a}loadData(){return h(this,null,function*(){this.error=null;try{yield this.authService.getAuthState();let n=this.authService.user();if(console.log("\u{1F464} User in home:",{id:n?.id,email:n?.email}),!n){this.error="Utente non autenticato. Effettua il login.";return}let[a,o,p,v,x,E]=yield Promise.all([this.soggetti.countByTipo("prospect"),this.soggetti.countByTipo("cliente"),this.soggetti.getSoggettiByTipo("prospect",0,199),this.supabase.supabase.from("trattative_yuvi").select("id",{count:"exact",head:!0}).eq("created_by",n.id),this.supabase.supabase.from("configurazioni_promethea").select("id",{count:"exact",head:!0}).eq("created_by",n.id),this.supabase.supabase.from("trattative_yuvi").select("nominativi_presi").eq("created_by",n.id)]);if(console.log("\u{1F4CA} Dati caricati:",{prospect:a.data,clienti:o.data,trattative:v.count}),!a.error&&typeof a.data=="number"&&(this.kpi.prospect=a.data),!o.error&&typeof o.data=="number"&&(this.kpi.clienti=o.data),p.error)throw p.error;let f=p.data??[],C=0,I=0,$=f.map(s=>this.verificaConfigurazioniProspect(s.id)),G=yield Promise.all($);for(let s=0;s<f.length;s++){let u=f[s],S=this.getLastEsito(u.esiti);S||C++,S&&S.tipo==="Richiamare"&&I++,G[s]&&this.kpi.configurati++}this.kpi.senzaContatto=C,this.kpi.daRichiamare=I,!v.error&&typeof v.count=="number"&&(this.kpi.trattativeYuvi=v.count),!x?.error&&typeof x?.count=="number"&&(this.kpi.trattativePromethea=x.count),!E.error&&Array.isArray(E.data)&&(this.kpi.referenzeCtr=E.data.reduce((s,u)=>s+(u.nominativi_presi??0),0)),this.ultimiProspect=f.sort((s,u)=>new Date(u.created_at).getTime()-new Date(s.created_at).getTime()).slice(0,5).map(s=>({id:s.id,ragione_sociale:s.ragione_sociale||"Senza nome",telefono:s.telefono,email:s.email,provincia:s.provincia,created_at:s.created_at,esiti:s.esiti})),console.log("\u2705 Home - Caricamento completato")}catch(n){console.error("\u274C Errore nel caricamento home:",n),this.error=n?.message||"Errore durante il caricamento della dashboard"}})}verificaConfigurazioniProspect(n){return h(this,null,function*(){try{let[a,o]=yield Promise.all([this.supabase.supabase.from("configurazioni_promethea").select("id").eq("prospect_id",n).maybeSingle(),this.supabase.supabase.from("trattative_yuvi").select("id").eq("prospect_id",n).maybeSingle()]);return!!(a.data||o.data)}catch(a){return console.warn(`\u26A0\uFE0F Errore verifica configurazioni per prospect ${n}:`,a),!1}})}static \u0275fac=function(a){return new(a||r)};static \u0275cmp=P({type:r,selectors:[["app-home"]],decls:2,vars:2,consts:[["emptyProspect",""],["noEsito",""],["title","Caricamento Dashboard","subtitle","Stiamo preparando i tuoi dati...",4,"ngIf"],[4,"ngIf"],["title","Caricamento Dashboard","subtitle","Stiamo preparando i tuoi dati..."],[1,"form-section"],[1,"section-header"],[1,"material-icons","header-icon"],[1,"section-titles"],[1,"section-title"],[1,"sottotitolo"],["class","status-message error",4,"ngIf"],[1,"prospect-cards"],["routerLink","/lista-prospect",1,"card","clickable"],[1,"card-title"],[1,"card-number"],["routerLink","/clienti",1,"card","clickable"],["routerLink","/yuvi-trattativa",1,"card","clickable"],["routerLink","/alchemizzatore",1,"card","clickable"],["routerLink","/visualizzazione-kpi",1,"card","clickable"],[1,"actions-container",2,"margin-top","var(--gutter-lg)","justify-content","center"],["routerLink","/aggiungi-prospect",1,"promethea-button","outline"],["routerLink","/yuvi-trattativa",1,"promethea-button"],["routerLink","/visualizzazione-kpi",1,"promethea-button","secondary"],[1,"form-section",2,"margin-top","var(--gutter-lg)"],["class","table-container",4,"ngIf","ngIfElse"],[1,"actions-container",2,"margin-top","var(--gutter-md)"],["routerLink","/lista-prospect",1,"promethea-button","secondary"],[1,"status-message","error"],[1,"table-container"],[1,"crm-table"],[4,"ngFor","ngForOf"],["data-label","Ragione Sociale"],[1,"cell-content"],["data-label","Telefono"],["data-label","Email"],["data-label","Provincia"],["data-label","Ultimo Esito"],[4,"ngIf","ngIfElse"],["data-label","Creato il"],[1,"badge",3,"ngClass"],[1,"badge","badge-info"],[1,"empty-state"]],template:function(a,o){a&1&&d(0,W,1,0,"app-page-loader",2)(1,ne,74,11,"div",3),a&2&&(m("ngIf",o.isLoading()),l(),m("ngIf",!o.isLoading()))},dependencies:[U,M,O,A,q,j,F],styles:["a.card[_ngcontent-%COMP%]{text-decoration:none;color:inherit}.form-section[_ngcontent-%COMP%] + .form-section[_ngcontent-%COMP%]{margin-top:var(--gutter-lg)}"]})};export{K as Home};
