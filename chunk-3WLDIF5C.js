import{a as h}from"./chunk-P5EFXTG7.js";import{a as S}from"./chunk-WMLYL4YD.js";import{b as f,c as m}from"./chunk-Q4FMGKSF.js";import{N as p,S as l}from"./chunk-PE6PP35I.js";import{i}from"./chunk-ODN5LVDJ.js";var v=class g{supabaseService=l(f);authService=l(m);userService=l(S);mapService=l(h);soggettoCache=new Map;CACHE_TTL=3e4;createSoggetto(e){return i(this,null,function*(){try{if(console.log("\u{1F527} Creazione soggetto con dati:",e),e.piva?.trim()&&(yield this.supabaseService.checkPivaExists(e.piva.trim())))return{success:!1,error:"P.IVA gi\xE0 esistente nel sistema"};let r=this.mapToSnakeCase(e),o=this.authService.user();o&&(r.created_by=o.id),r.created_at=new Date().toISOString(),r.updated_at=r.created_at;let t=yield this.supabaseService.createSoggetto(r);return t.error?(console.error("\u274C Errore Supabase:",t.error),{success:!1,error:this.getErrorMessage(t.error)}):(this.soggettoCache.clear(),{success:!0,data:t.data||void 0})}catch(r){return console.error("\u274C Errore createSoggetto:",r),{success:!1,error:"Errore di sistema durante il salvataggio"}}})}clearCache(){this.soggettoCache.clear()}get supabase(){return this.supabaseService.supabase}getSoggettiByTipo(e,r=0,o=49){return i(this,null,function*(){if(this.userService.isAdmin()||e!=="prospect")return this.supabaseService.getSoggettiByTipo(e,r,o);let t=this.authService.user();if(!t)return{data:[],error:null};console.log(`\u{1F50D} Query prospect per utente: user=${t.id}, range=${r}-${o}`);let{data:a,error:s}=yield this.supabaseService.supabase.from("soggetti").select("*").eq("tipo",e).eq("created_by",t.id).order("created_at",{ascending:!1}).range(r,o);return{data:a,error:s}})}getSoggettoById(e){return i(this,null,function*(){return yield this.supabaseService.getSoggettoById(e)})}deleteSoggetto(e){return i(this,null,function*(){try{let r=yield this.unlinkOrDelete("trattative_yuvi","prospect_id",e);if(!r.ok)return{success:!1,error:this.getErrorMessage(r.error)};let o=yield this.unlinkOrDelete("configurazioni_promethea","prospect_id",e);if(!o.ok)return{success:!1,error:this.getErrorMessage(o.error)};let t=yield this.supabaseService.deleteSoggetto(e);return t.error?{success:!1,error:this.getErrorMessage(t.error),code:t.error.code}:{success:!0,data:t.data||void 0}}catch{return{success:!1,error:"Errore di sistema durante l'eliminazione"}}})}unlinkOrDelete(e,r,o){return i(this,null,function*(){let{error:t}=yield this.supabaseService.supabase.from(e).update({[r]:null}).eq(r,o);if(!t)return{ok:!0};let a=String(t?.message||"");if(!(t?.code==="23502"||/not[- ]?null/i.test(a)||/violates not-null constraint/i.test(a)))return{ok:!1,error:t};let{error:n}=yield this.supabaseService.supabase.from(e).delete().eq(r,o);return n?{ok:!1,error:n}:{ok:!0}})}updateSoggetto(e){return i(this,null,function*(){try{let r=this.mapUpdateToSnakeCase(e),o=yield this.supabaseService.updateSoggetto(e.id,r);return o.error?{success:!1,error:this.getErrorMessage(o.error),code:o.error.code}:{success:!0,data:o.data||void 0}}catch{return{success:!1,error:"Errore di sistema durante l'aggiornamento"}}})}searchSoggetti(e,r){return i(this,null,function*(){try{if(r!=="prospect"||this.userService.isAdmin()){let n=yield this.supabaseService.searchSoggetti(e,r);return r?{data:(n.data??[]).filter(u=>u.tipo===r),error:null}:n}let o=this.authService.user();if(!o)return{data:[],error:null};let t=(e??"").trim(),{data:a,error:s}=yield this.supabaseService.supabase.from("soggetti").select("*").eq("tipo","prospect").eq("created_by",o.id).or(`ragione_sociale.ilike.%${t}%,referente.ilike.%${t}%,piva.ilike.%${t}%,telefono.ilike.%${t}%,email.ilike.%${t}%`).order("created_at",{ascending:!1}).limit(50);return{data:a,error:s}}catch(o){return console.error("Errore nella ricerca soggetti:",o),{data:null,error:o}}})}updateProdotto(e,r){return i(this,null,function*(){try{let o=yield this.supabaseService.updateSoggetto(e,{prodotto:r});return o.error?{success:!1,error:this.getErrorMessage(o.error),code:o.error.code}:{success:!0,data:o.data||void 0}}catch{return{success:!1,error:"Errore di sistema durante l'aggiornamento del prodotto"}}})}getProvinceByTipo(e){return i(this,null,function*(){return this.supabaseService.getProvinceByTipo(e)})}countByTipo(e){return i(this,null,function*(){if(this.userService.isAdmin()||e!=="prospect")return this.supabaseService.countSoggettiByTipo(e);let r=this.authService.user();if(!r)return{data:0,error:null};let{count:o,error:t}=yield this.supabaseService.supabase.from("soggetti").select("*",{count:"exact",head:!0}).eq("tipo",e).eq("created_by",r.id);return{data:o??0,error:t}})}getConfigurazioniProspect(e){return i(this,null,function*(){try{if(!e.length)return new Map;let[r,o]=yield Promise.all([this.supabaseService.supabase.from("configurazioni_promethea").select("prospect_id").in("prospect_id",e),this.supabaseService.supabase.from("trattative_yuvi").select("prospect_id").in("prospect_id",e)]),t=new Map;return e.forEach(a=>t.set(a,!1)),r.data&&r.data.forEach(a=>{a.prospect_id&&t.set(a.prospect_id,!0)}),o.data&&o.data.forEach(a=>{a.prospect_id&&t.set(a.prospect_id,!0)}),t}catch(r){return console.error("Errore bulk configurazioni:",r),new Map}})}getConfigurazioniPrometheaByCliente(e){return i(this,null,function*(){try{if(!e.length)return new Map;let{data:r,error:o}=yield this.supabaseService.supabase.from("configurazioni_promethea").select("prospect_id, dettagli").in("prospect_id",e);if(o)return console.error("Errore verifica configurazioni Promethea per clienti:",o),new Map;let t=new Map;return e.forEach(a=>t.set(a,null)),r&&r.forEach(a=>{a.prospect_id&&t.set(a.prospect_id,a.dettagli)}),t}catch(r){return console.error("Errore bulk configurazioni Promethea per clienti:",r),new Map}})}getTrattativeYuviByProspect(e){return i(this,null,function*(){if(!e.length)return new Map;try{let{data:r,error:o}=yield this.supabaseService.supabase.from("trattative_yuvi").select("prospect_id").in("prospect_id",e);if(o)return console.error("Errore verifica trattative YUVI:",o),new Map;let t=new Map;return e.forEach(a=>t.set(a,!1)),r&&r.forEach(a=>{a.prospect_id&&t.set(a.prospect_id,!0)}),t}catch(r){return console.error("Errore bulk trattative YUVI:",r),new Map}})}getTrattativeYuviByCliente(e){return i(this,null,function*(){try{if(!e.length)return new Map;let{data:r,error:o}=yield this.supabaseService.supabase.from("trattative_yuvi").select("prospect_id").in("prospect_id",e);if(o)return console.error("Errore verifica trattative YUVI per clienti:",o),new Map;let t=new Map;return e.forEach(a=>t.set(a,!1)),r&&r.forEach(a=>{a.prospect_id&&t.set(a.prospect_id,!0)}),t}catch(r){return console.error("Errore bulk trattative YUVI per clienti:",r),new Map}})}mapToSnakeCase(e){return{tipo:e.tipo,ragione_sociale:e.ragioneSociale,piva:e.piva&&e.piva.trim()!==""?e.piva:null,formula_societaria:e.formulaSocietaria||null,categoria_ateco:e.categoriaAteco||null,referente:e.referente||null,telefono:e.telefono||null,email:e.email||null,sito_web:e.sitoWeb||null,facebook:e.facebook||null,instagram:e.instagram||null,metodo_pagamento:e.metodoPagamento||null,iban:e.iban||null,note:e.note||null,prodotto:e.prodotto||"Promethea",referenza_da_id:e.referenzaDaId??null,provincia:e.provincia||null,comune:e.comune||null,indirizzo:e.indirizzo||null,numero_civico:e.numeroCivico||null,esiti:[],created_by:null}}mapUpdateToSnakeCase(e){let r={};return e.tipo!==void 0&&(r.tipo=e.tipo),e.ragioneSociale!==void 0&&(r.ragione_sociale=e.ragioneSociale),e.piva!==void 0&&(r.piva=e.piva&&e.piva.trim()!==""?e.piva:null),e.formulaSocietaria!==void 0&&(r.formula_societaria=e.formulaSocietaria),e.categoriaAteco!==void 0&&(r.categoria_ateco=e.categoriaAteco),e.referente!==void 0&&(r.referente=e.referente),e.telefono!==void 0&&(r.telefono=e.telefono),e.email!==void 0&&(r.email=e.email),e.sitoWeb!==void 0&&(r.sito_web=e.sitoWeb),e.facebook!==void 0&&(r.facebook=e.facebook),e.instagram!==void 0&&(r.instagram=e.instagram),e.metodoPagamento!==void 0&&(r.metodo_pagamento=e.metodoPagamento),e.iban!==void 0&&(r.iban=e.iban),e.note!==void 0&&(r.note=e.note),e.prodotto!==void 0&&(r.prodotto=e.prodotto),e.provincia!==void 0&&(r.provincia=e.provincia),e.comune!==void 0&&(r.comune=e.comune),e.indirizzo!==void 0&&(r.indirizzo=e.indirizzo),e.numeroCivico!==void 0&&(r.numero_civico=e.numeroCivico),e.referenzaDaId!==void 0&&(r.referenza_da_id=e.referenzaDaId??null),r}getErrorMessage(e){return typeof e=="string"?e:{23505:"Dati duplicati: il soggetto potrebbe gi\xE0 esistere",42501:"Permessi insufficienti per completare l'operazione",P0001:"Errore di validazione dei dati",network_error:"Errore di connessione al server"}[e.code]||e.message||"Errore durante il salvataggio"}getEsitiBySoggetto(e){return i(this,null,function*(){try{let{data:r,error:o}=yield this.supabaseService.getSoggettoById(e);if(o)return{data:null,error:o};let t=r?.esiti??[];return{data:this.normalizzaEsiti(t),error:null}}catch(r){return{data:null,error:r}}})}appendEsito(e,r){return i(this,null,function*(){try{let o=[];try{o=(yield this.getEsitiBySoggetto(e)).data??[]}catch(n){console.warn("Errore recupero esiti, procedo con array vuoto:",n),o=[]}let t=this.creaEsitoCompleto(r),a=[...o,t],s=yield this.supabaseService.updateSoggetto(e,{esiti:a});return s.error?{success:!1,error:this.getErrorMessage(s.error),code:s.error.code}:{success:!0,data:s.data||void 0}}catch(o){return console.error("Errore in appendEsito:",o),{success:!1,error:"Errore di sistema durante il salvataggio dell'esito"}}})}normalizzaEsiti(e){return e.map(r=>({tipo:r.tipo||"Non interessato",note:r.note||null,ts:r.ts||new Date().toISOString(),scheduleAt:r.scheduleAt||null,dataAppuntamento:r.dataAppuntamento||null,oraAppuntamento:r.oraAppuntamento||null}))}creaEsitoCompleto(e){return{tipo:e.tipo,note:e.note||null,ts:new Date().toISOString(),scheduleAt:e.scheduleAt||null,dataAppuntamento:e.dataAppuntamento||null,oraAppuntamento:e.oraAppuntamento||null}}convertiProspectInCliente(e){return i(this,null,function*(){try{let r={tipo:"cliente",updated_at:new Date().toISOString()},{data:o,error:t}=yield this.supabaseService.supabase.from("soggetti").update(r).eq("id",e).eq("tipo","prospect").select().single();return t?(console.error("Errore nella conversione prospect -> cliente:",t),{data:null,error:t}):(console.log("Prospect convertito in cliente:",o),{data:o,error:null})}catch(r){return console.error("Errore generale nella conversione:",r),{data:null,error:r}}})}aggiornaCoordinateSoggetto(e,r,o){return i(this,null,function*(){try{let t=yield this.supabaseService.updateSoggetto(e,{latitude:r,longitude:o,updated_at:new Date().toISOString()});return t.error?{success:!1,error:this.getErrorMessage(t.error),code:t.error.code}:{success:!0,data:t.data||void 0}}catch(t){return console.error("Errore aggiornamento coordinate:",t),{success:!1,error:"Errore durante l'aggiornamento delle coordinate"}}})}geocodificaEAggiornaSoggetto(e){return i(this,null,function*(){try{let{data:r,error:o}=yield this.getSoggettoById(e);if(o||!r)return{success:!1,error:"Soggetto non trovato"};if(!r.provincia&&!r.comune)return{success:!1,error:"Dati insufficienti per la geocodifica (manca provincia/comune)"};let t=yield this.mapService.geocodificaSoggetto(r);return t?yield this.aggiornaCoordinateSoggetto(e,t.lat,t.lng):{success:!1,error:"Impossibile determinare le coordinate dall'indirizzo"}}catch(r){return console.error("Errore geocodifica soggetto:",r),{success:!1,error:"Errore durante la geocodifica"}}})}geocodificaSoggettiSenzaCoordinate(e=50){return i(this,null,function*(){try{let{data:r,error:o}=yield this.supabaseService.supabase.from("soggetti").select("*").or("latitude.is.null,longitude.is.null").not("provincia","is",null).limit(e);if(o)throw o;if(!r||r.length===0)return{success:0,failed:0,total:0,errors:[]};console.log(`\u{1F504} Geocodifica batch di ${r.length} soggetti...`);let t=yield this.mapService.geocodificaSoggettiBatch(r),a=0,s=0,n=[];for(let c of r){let u=t.get(c.id);if(u){let d=yield this.aggiornaCoordinateSoggetto(c.id,u.lat,u.lng);d.success?a++:(s++,n.push(`${c.ragione_sociale}: ${d.error}`))}else s++,n.push(`${c.ragione_sociale}: Coordinate non trovate`)}return console.log(`\u2705 Geocodifica batch completata: ${a} successi, ${s} falliti`),{success:a,failed:s,total:r.length,errors:n}}catch(r){return console.error("Errore geocodifica batch:",r),{success:0,failed:0,total:0,errors:["Errore generale durante la geocodifica batch"]}}})}static \u0275fac=function(r){return new(r||g)};static \u0275prov=p({token:g,factory:g.\u0275fac,providedIn:"root"})};export{v as a};
