import{b as w}from"./chunk-7SDV3Z56.js";import{N as _,S as C}from"./chunk-S7YZFXYO.js";import{a as b,b as d,i as f}from"./chunk-ODN5LVDJ.js";var y=class p{supabaseService=C(w);getKPIYuvi(e){return f(this,null,function*(){try{let t=this.supabaseService.supabase.from("trattative_yuvi").select("*, soggetti!inner(*)").order("created_at",{ascending:!1});e&&(t=t.eq("soggetti.created_by",e));let{data:a,error:r}=yield t,o=this.supabaseService.supabase.from("trattative_yuvi").select("nominativi_presi, soggetti!inner(created_by)");e&&(o=o.eq("soggetti.created_by",e));let{data:c,error:n}=yield o,s=0;c&&!n&&(s=c.reduce((i,m)=>i+(m.nominativi_presi||0),0)),r&&console.error("Errore KPI (trattative):",r),n&&console.error("Errore conteggio referenze da CTR:",n);let l=this.calcolaKPI(a||[]),u=this.raccogliDettagliSoftware(a||[]);return d(b({},l),{referenzeDaCtr:s,dettagliSoftware:u})}catch(t){return console.error("Errore generale KPI:",t),this.getKPIEmpty()}})}raccogliDettagliSoftware(e){let t={};return e.forEach(a=>{if(a.motivazione==="usano_software_proprio"&&a.risposte_questionario){let r=a.risposte_questionario,o="Non specificato";r.domanda_software&&r.domanda_software.nome_software?o=r.domanda_software.nome_software:r.domanda_software&&r.domanda_software.utilizza_software==="si"&&(o="Software non specificato"),o&&(t[o]=(t[o]||0)+1)}}),t}calcolaKPI(e){let t=new Date,a=new Date(t.getFullYear(),t.getMonth(),1),r=e.length,o=e.filter(i=>i.esito==="contratto_chiuso"),c=o.filter(i=>new Date(i.created_at)>=a),n=o.filter(i=>i.nominativi_presi&&i.nominativi_presi>0),s=e.filter(i=>i.esito==="da_richiamare").length,l=e.filter(i=>i.esito==="non_chiuso"),u={};return l.forEach(i=>{i.motivazione&&(u[i.motivazione]=(u[i.motivazione]||0)+1)}),{totaleTrattative:r,contrattiChiusiTotali:o.length,contrattiChiusiMeseCorrente:c.length,percentualeChiusiTotali:r>0?o.length/r*100:0,percentualeChiusiMese:r>0?c.length/r*100:0,percentualeNominativiPresi:o.length>0?n.length/o.length*100:0,percentualeDaRichiamare:r>0?s/r*100:0,motivazioniNonChiusi:u,referenzeDaCtr:0,dettagliSoftware:{}}}getKPIEmpty(){return{totaleTrattative:0,contrattiChiusiTotali:0,contrattiChiusiMeseCorrente:0,percentualeChiusiTotali:0,percentualeChiusiMese:0,percentualeNominativiPresi:0,percentualeDaRichiamare:0,motivazioniNonChiusi:{},referenzeDaCtr:0,dettagliSoftware:{}}}getProspectKPI(){return f(this,null,function*(){let{data:e,error:t}=yield this.supabaseService.supabase.rpc("get_prospect_kpi");if(t)return console.error("get_prospect_kpi error",t),{totale:0,senzaContatto:0,daRichiamare:0,configurati:0};let a=(Array.isArray(e)?e[0]:e)||{};return{totale:a.totale??0,senzaContatto:a.senza_contatto??0,daRichiamare:a.da_richiamare??0,configurati:a.configurati??0}})}getAnagraficaKPI(e){return f(this,null,function*(){let{data:t,error:a}=yield this.supabaseService.supabase.rpc("get_anagrafica_kpi",{p_tipo:e});if(a)return console.error("get_anagrafica_kpi error",e,a),{totale:0,conIban:0,conReferente:0};let r=(Array.isArray(t)?t[0]:t)||{};return{totale:r.totale??0,conIban:r.con_iban??0,conReferente:r.con_referente??0}})}getKPIPromethea(e){return f(this,null,function*(){try{let t=this.supabaseService.supabase.from("configurazioni_promethea").select("*, soggetti!inner(*)").order("created_at",{ascending:!1});e&&(t=t.eq("soggetti.created_by",e));let{data:a,error:r}=yield t;if(r)return console.error("getKPIPromethea error",r),this.getKPIEmpty();let o=new Date,c=new Date(o.getFullYear(),o.getMonth(),1),n=(a??[]).length,s=(a??[]).filter(h=>Number(h.totale)>0).length,l=(a??[]).filter(h=>new Date(h.created_at)>=c).length,u=this.supabaseService.supabase.from("soggetti").select("id, created_at, created_by").eq("prodotto","Promethea").ilike("note","%Creato da configurazione Promethea%");e&&(u=u.eq("created_by",e));let{data:i,error:m}=yield u;m&&console.error("Errore conteggio nominativi Promethea:",m);let g=Array.isArray(i)?i.length:0,P=s>0?g/s*100:n>0?g/n*100:0;return{totaleTrattative:n,contrattiChiusiTotali:s,contrattiChiusiMeseCorrente:l,percentualeChiusiTotali:n>0?s/n*100:0,percentualeChiusiMese:n>0?l/n*100:0,percentualeNominativiPresi:Math.round(P*100)/100,percentualeDaRichiamare:0,motivazioniNonChiusi:{},referenzeDaCtr:g,dettagliSoftware:{}}}catch(t){return console.error("getKPIPromethea exception",t),this.getKPIEmpty()}})}countContractsForSeller(e,t,a){return f(this,null,function*(){let r=new Date(t,a-1,1).toISOString(),o=new Date(t,a,1).toISOString();try{let{data:c,error:n}=yield this.supabaseService.supabase.from("contratti").select("id, totale, data_contratto").eq("created_by",e).gte("data_contratto",r).lt("data_contratto",o);if(n)throw n;let s=Array.isArray(c)?c:[],l=s.length,u=s.reduce((i,m)=>i+(Number(m.totale)||0),0);return{count:l,sumTotal:u}}catch(c){return console.error("countContractsForSeller error",c),{count:0,sumTotal:0}}})}computeCommission(e,t,a){if(!e||e.abilitato===!1)return 0;if((e.tipo??"gettone")==="percentuale"){let s=Number(e.percentuale?.percent??e.percent??0);return a*s/100}let o=Number(e.gettone?.per_contratto??e.per_contratto??0),c=t*o,n=e.gettone?.passi??e.passi??[];if(Array.isArray(n))for(let s of n){let l=Number(s?.soglia??0),u=Number(s?.bonus??0);t>=l&&(c+=u)}return c}static \u0275fac=function(t){return new(t||p)};static \u0275prov=_({token:p,factory:p.\u0275fac,providedIn:"root"})};export{y as a};
