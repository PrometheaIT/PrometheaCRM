import{a as H}from"./chunk-VZ4X25J2.js";import"./chunk-K3JKJW2Z.js";import{p as N,q as O,v as P}from"./chunk-DITEEB7V.js";import"./chunk-7SDV3Z56.js";import{r as A}from"./chunk-G7C3XVRV.js";import{Ab as l,Ga as s,Ib as k,Jb as L,Lb as c,Ma as R,Mb as I,Nb as M,Ob as z,Sa as V,Vb as D,X as u,Y as C,ea as g,gb as S,hb as m,ib as _,jb as F,kb as T,lb as y,mb as v,nb as r,ob as o,pb as $,wb as x,zb as f}from"./chunk-S7YZFXYO.js";import"./chunk-X5YLR3NI.js";import{a as h,b,i as E}from"./chunk-ODN5LVDJ.js";var B=()=>[],j=(i,e)=>e.id;function Q(i,e){i&1&&(r(0,"div",1),c(1,"Caricamento intervista..."),o())}function G(i,e){if(i&1&&(r(0,"span",7),c(1),o()),i&2){let t=l(2);s(),I(t.saveMessage())}}function J(i,e){if(i&1&&(r(0,"p",8),c(1),o()),i&2){let t=l(2);s(),I(t.intervista().descrizione)}}function K(i,e){i&1&&(r(0,"span",20),c(1,"*"),o())}function U(i,e){if(i&1&&(r(0,"div",26),c(1),o()),i&2){let t=l(2).$implicit,n=l(2);s(),z(" ",(n.risposte()[t.id]||"").length," / ",t.max_caratteri," ")}}function W(i,e){if(i&1){let t=x();r(0,"input",25),f("input",function(a){u(t);let p=l().$implicit,d=l(2);return C(d.onRispostaChange(p.id,a))}),o(),m(1,U,2,2,"div",26)}if(i&2){let t=l().$implicit,n=l(2);v("value",n.risposte()[t.id]||"")("maxLength",t.max_caratteri||255),S("required",t.obbligatoria),s(),_(t.max_caratteri?1:-1)}}function X(i,e){if(i&1){let t=x();r(0,"textarea",27),f("input",function(a){u(t);let p=l().$implicit,d=l(2);return C(d.onTextareaChange(p.id,a))}),c(1,"              "),o()}if(i&2){let t=l().$implicit,n=l(2);v("value",n.risposte()[t.id]||""),S("required",t.obbligatoria)}}function Y(i,e){if(i&1&&(r(0,"option",30),c(1),o()),i&2){let t=e.$implicit;v("value",t),s(),I(t)}}function Z(i,e){if(i&1){let t=x();r(0,"select",28),f("change",function(a){u(t);let p=l().$implicit,d=l(2);return C(d.onSelectChange(p.id,a))}),r(1,"option",29),c(2,"Seleziona un'opzione"),o(),T(3,Y,2,2,"option",30,F),o()}if(i&2){let t=l().$implicit,n=l(2);v("value",n.risposte()[t.id]||""),S("required",t.obbligatoria),s(3),y(t.opzioni)}}function tt(i,e){if(i&1){let t=x();r(0,"label",31)(1,"input",32),f("change",function(a){let p=u(t).$implicit,d=l(2).$implicit,w=l(2);return C(w.toggleOpzioneMultipla(d.id,p,a.target.checked))}),o(),c(2),o()}if(i&2){let t=e.$implicit,n=l(2).$implicit,a=l(2);s(),v("checked",(a.risposte()[n.id]||D(2,B)).includes(t)),s(),M(" ",t," ")}}function et(i,e){if(i&1&&(r(0,"div",23),T(1,tt,3,3,"label",31,F),o()),i&2){let t=l().$implicit;s(),y(t.opzioni)}}function it(i,e){i&1&&(r(0,"div",24),c(1,"Questa domanda \xE8 obbligatoria"),o())}function nt(i,e){if(i&1&&(r(0,"div",18)(1,"label",19),c(2),m(3,K,2,0,"span",20),o(),m(4,W,2,4)(5,X,2,2,"textarea",21)(6,Z,5,2,"select",22)(7,et,3,0,"div",23),m(8,it,2,0,"div",24),o()),i&2){let t,n=e.$implicit,a=l(2);L("obbligatoria",n.obbligatoria)("completata",a.isDomandaCompletata(n.id)),s(2),M(" ",n.testo," "),s(),_(n.obbligatoria?3:-1),s(),_((t=n.tipo)==="text"?4:t==="textarea"?5:t==="select"?6:t==="multiselect"?7:-1),s(4),_(n.obbligatoria&&!a.isDomandaCompletata(n.id)?8:-1)}}function at(i,e){i&1&&c(0," Salvataggio... ")}function ot(i,e){i&1&&c(0," Completa Intervista ")}function rt(i,e){i&1&&(r(0,"span",16),c(1,"\u2713 Tutte le domande obbligatorie sono complete"),o())}function st(i,e){i&1&&(r(0,"span",17),c(1,"Completa tutte le domande obbligatorie per terminare"),o())}function lt(i,e){if(i&1){let t=x();r(0,"div",3)(1,"h2"),c(2),o(),r(3,"div",4)(4,"span",5),c(5),o(),r(6,"span",6),c(7),o(),m(8,G,2,1,"span",7),o(),m(9,J,2,1,"p",8),o(),r(10,"div",9),$(11,"div",10),o(),r(12,"div",11),T(13,nt,9,8,"div",12,j),o(),r(15,"div",13)(16,"button",14),f("click",function(){u(t);let a=l();return C(a.completaIntervista())}),m(17,at,1,0)(18,ot,1,0),o(),r(19,"div",15),m(20,rt,2,0,"span",16)(21,st,2,0,"span",17),o()()}if(i&2){let t=l();s(2),I(t.intervista().nome),s(3),I(t.intervista().modulo),s(2),M("",t.getProgresso(),"% completato"),s(),_(t.saveMessage()?8:-1),s(),_(t.intervista().descrizione?9:-1),s(2),k("width",t.getProgresso(),"%"),s(2),y(t.intervista().domande),s(3),v("disabled",!t.isIntervistaCompletata()||t.isSaving()),s(),_(t.isSaving()?17:18),s(3),_(t.isIntervistaCompletata()?20:21)}}function ct(i,e){i&1&&(r(0,"div",2),c(1,"Intervista non trovata"),o())}var q=class i{constructor(e){this.intervisteService=e}clienteId;intervistaId;intervista=g(null);risposte=g({});isLoading=g(!1);isSaving=g(!1);saveMessage=g("");ngOnInit(){return E(this,null,function*(){yield this.caricaIntervistaERisposte()})}caricaIntervistaERisposte(){return E(this,null,function*(){this.isLoading.set(!0);try{let e=yield this.intervisteService.getIntervistaById(this.intervistaId);e.data?this.intervista.set(e.data):e.error&&(console.error("Errore nel caricamento intervista:",e.error),this.saveMessage.set("Errore nel caricamento dell'intervista"));let t=yield this.intervisteService.getRispostaByClienteEIntervista(this.clienteId,this.intervistaId);t.data&&this.risposte.set(t.data.risposte||{})}catch(e){console.error("Errore durante il caricamento:",e),this.saveMessage.set("Errore durante il caricamento")}finally{this.isLoading.set(!1)}})}salvaRisposta(){return E(this,null,function*(){if(this.intervista()){this.isSaving.set(!0);try{let t={cliente_id:this.clienteId,intervista_id:this.intervistaId,risposte:this.risposte(),completed:this.isIntervistaCompletata()},n=yield this.intervisteService.saveRisposta(t);n.error?(console.error("Errore nel salvataggio:",n.error),this.saveMessage.set("Errore nel salvataggio")):(this.saveMessage.set("Salvato \u2713"),setTimeout(()=>this.saveMessage.set(""),2e3))}catch(t){console.error("Errore durante il salvataggio:",t),this.saveMessage.set("Errore durante il salvataggio")}finally{this.isSaving.set(!1)}}})}onRispostaChange(e,t){let n=t.target;this.risposte.update(a=>b(h({},a),{[e]:n.value})),this.salvaRisposta()}onTextareaChange(e,t){let n=t.target;this.risposte.update(a=>b(h({},a),{[e]:n.value})),this.salvaRisposta()}onSelectChange(e,t){let n=t.target;this.risposte.update(a=>b(h({},a),{[e]:n.value})),this.salvaRisposta()}toggleOpzioneMultipla(e,t,n){this.risposte.update(a=>{let p=a[e]||[],d;return n?d=[...p,t]:d=p.filter(w=>w!==t),b(h({},a),{[e]:d})}),this.salvaRisposta()}isIntervistaCompletata(){let e=this.intervista(),t=this.risposte();return e?e.domande.every(n=>{if(!n.obbligatoria)return!0;let a=t[n.id];return a!=null&&a!==""&&(!Array.isArray(a)||a.length>0)}):!1}completaIntervista(){return E(this,null,function*(){if(this.isIntervistaCompletata()){let e=yield this.intervisteService.markAsCompleted(this.clienteId,this.intervistaId);e.error?(console.error("Errore nel completamento:",e.error),alert("Errore nel completamento dell'intervista")):alert("Intervista completata con successo!")}else alert("Completa tutte le domande obbligatorie prima di completare l'intervista.")})}getProgresso(){let e=this.intervista(),t=this.risposte();if(!e)return 0;let n=e.domande.filter(p=>p.obbligatoria);if(n.length===0)return 100;let a=n.filter(p=>{let d=t[p.id];return d!=null&&d!==""&&(!Array.isArray(d)||d.length>0)}).length;return Math.round(a/n.length*100)}isDomandaCompletata(e){let t=this.risposte()[e];return t!=null&&t!==""&&(!Array.isArray(t)||t.length>0)}static \u0275fac=function(t){return new(t||i)(R(H))};static \u0275cmp=V({type:i,selectors:[["app-compila-intervista"]],inputs:{clienteId:"clienteId",intervistaId:"intervistaId"},decls:4,vars:1,consts:[[1,"compila-intervista-container"],[1,"loading"],[1,"error"],[1,"intervista-header"],[1,"intervista-info"],[1,"modulo-badge"],[1,"progress-badge"],[1,"save-message"],[1,"descrizione"],[1,"progress-bar"],[1,"progress-fill"],[1,"domande-container"],[1,"domanda-item",3,"obbligatoria","completata"],[1,"actions"],[1,"btn","btn-primary",3,"click","disabled"],[1,"completion-status"],[1,"status-complete"],[1,"status-incomplete"],[1,"domanda-item"],[1,"domanda-label"],[1,"required"],["rows","4",1,"form-control",3,"value"],[1,"form-control",3,"value"],[1,"multiselect-options"],[1,"error-message"],["type","text",1,"form-control",3,"input","value","maxLength"],[1,"char-counter"],["rows","4",1,"form-control",3,"input","value"],[1,"form-control",3,"change","value"],["value",""],[3,"value"],[1,"checkbox-option"],["type","checkbox",3,"change","checked"]],template:function(t,n){t&1&&(r(0,"div",0),m(1,Q,2,0,"div",1)(2,lt,22,10)(3,ct,2,0,"div",2),o()),t&2&&(s(),_(n.isLoading()?1:n.intervista()?2:3))},dependencies:[A,P,N,O],encapsulation:2})};export{q as CompilaIntervista};
