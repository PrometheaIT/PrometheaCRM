import{a as D}from"./chunk-23T6KXZP.js";import{a as w}from"./chunk-6TYR3BRN.js";import{b as k}from"./chunk-7SDV3Z56.js";import{N as E,S as y}from"./chunk-S7YZFXYO.js";import{a as R,b as N,i as c}from"./chunk-ODN5LVDJ.js";var A=class z{supabaseService=y(k);authService=y(w);ALLOW_CLIENT_GEOCODING=!0;coordinateCache=new Map;provinceFallback={Roma:{lat:41.9028,lng:12.4964,indirizzo:"Roma"},Milano:{lat:45.4642,lng:9.19,indirizzo:"Milano"},Napoli:{lat:40.8518,lng:14.2681,indirizzo:"Napoli"},Torino:{lat:45.0703,lng:7.6869,indirizzo:"Torino"},Palermo:{lat:38.1157,lng:13.3615,indirizzo:"Palermo"},Genova:{lat:44.4056,lng:8.9463,indirizzo:"Genova"},Bologna:{lat:44.4949,lng:11.3426,indirizzo:"Bologna"},Firenze:{lat:43.7696,lng:11.2558,indirizzo:"Firenze"},Bari:{lat:41.1171,lng:16.8719,indirizzo:"Bari"},Catania:{lat:37.5079,lng:15.083,indirizzo:"Catania"},Venezia:{lat:45.4408,lng:12.3155,indirizzo:"Venezia"},Verona:{lat:45.4384,lng:10.9916,indirizzo:"Verona"},Trieste:{lat:45.6495,lng:13.7768,indirizzo:"Trieste"},Ancona:{lat:43.6158,lng:13.5189,indirizzo:"Ancona"}};constructor(){Object.entries(this.provinceFallback).forEach(([e,t])=>{this.coordinateCache.set(e.toLowerCase(),t)})}loadSoggettiPerMappa(e){return c(this,null,function*(){let t=this.authService.user(),r=yield this.supabaseService.isAdmin();console.log("DEBUG MapService.loadSoggettiPerMappa",{options:e,userId:t?.id,isAdmin:r});let i=e?.includeFornitori?["prospect","cliente","fornitore"]:["prospect","cliente"],a=this.supabaseService.supabase.from("soggetti").select(`id, tipo, ragione_sociale, referente, telefono, email, provincia, comune, indirizzo, numero_civico,
        prodotto, latitude, longitude, created_at, updated_at, created_by, piva, formula_societaria, categoria_ateco,
        sito_web, facebook, instagram, metodo_pagamento, iban, note, esiti, "Modulo", referenza_da_id`).in("tipo",i);e?.soloMiei&&t&&(a=a.eq("created_by",t.id));let{data:o,error:n}=yield a;if(console.log("DEBUG Query soggetti - options:",e),n?console.error("DEBUG Query soggetti - error:",n):console.log("DEBUG Query soggetti - rows:",Array.isArray(o)?o.length:0,"sample created_by:",Array.isArray(o)&&o.length?o.slice(0,5).map(s=>s.created_by):[]),n||!o)return n&&console.error("Errore loadSoggettiPerMappa:",n),[];let l=(o??[]).map(s=>{let f=s.created_at??s.createdAt??new Date().toISOString(),p=s.updated_at??s.updatedAt??f,h=s.latitude??s.lat??null,_=s.longitude??s.lng??null,v=h!=null&&_!=null;return{id:s.id,tipo:s.tipo,ragione_sociale:s.ragione_sociale??s.ragioneSociale??"",piva:s.piva??null,formula_societaria:s.formula_societaria??s.formulaSocietaria??null,categoria_ateco:s.categoria_ateco??null,referente:s.referente??null,telefono:s.telefono??null,email:s.email??null,sito_web:s.sito_web??null,facebook:s.facebook??null,instagram:s.instagram??null,metodo_pagamento:s.metodo_pagamento??null,iban:s.iban??null,provincia:s.provincia??null,comune:s.comune??null,indirizzo:s.indirizzo??null,numero_civico:s.numero_civico??s.numeroCivico??null,note:s.note??null,prodotto:s.prodotto??"Promethea",esiti:s.esiti??[],Modulo:s.Modulo??null,created_at:f,updated_at:p,created_by:s.created_by??null,latitude:h,longitude:_,referenza_da_id:s.referenza_da_id??null,coordinate:v?{lat:h,lng:_}:null,hasCoordinate:v,configurato:!1,hasConfigPromethea:!1,hasTrattativaYuvi:!1,ultimoEsito:null}}),u=l.map(s=>s.id);if(!u.length)return l;console.log("\u{1F50D} Verifica configurazioni per IDs:",u);try{let f=[],p=[],h=[];for(let g=0;g<u.length;g+=500)h.push(u.slice(g,g+500));let _=h.map(g=>this.supabaseService.supabase.from("configurazioni_promethea").select("prospect_id").in("prospect_id",g)),v=h.map(g=>this.supabaseService.supabase.from("trattative_yuvi").select("prospect_id").in("prospect_id",g));(yield Promise.allSettled(_)).forEach((g,b)=>{if(g.status==="fulfilled"){let{data:S,error:P}=g.value;P?console.warn(`Batch config error (batch ${b}):`,P):Array.isArray(S)&&f.push(...S)}else console.warn(`Batch config rejected (batch ${b}):`,g.reason)}),(yield Promise.allSettled(v)).forEach((g,b)=>{if(g.status==="fulfilled"){let{data:S,error:P}=g.value;P?console.warn(`Batch trattative error (batch ${b}):`,P):Array.isArray(S)&&p.push(...S)}else console.warn(`Batch trattative rejected (batch ${b}):`,g.reason)});let M=new Set(f.map(g=>g.prospect_id)),$=new Set(p.map(g=>g.prospect_id));console.log("\u{1F3AF} ID TROVATI (chunked):",{configuratiPromethea:Array.from(M).slice(0,50),configuratiYuvi:Array.from($).slice(0,50),totalConfigurazioni:M.size,totalTrattative:$.size});let B=l.map(g=>{let b=M.has(g.id),S=$.has(g.id),P=b||S,O=g.esiti&&g.esiti.length>0?g.esiti[g.esiti.length-1]:null,F=null;if(O){let m=O,q=typeof m=="string"?null:m.ts??m.dataAppuntamento??m.scheduleAt??m.data??m.data_esito??m.created_at??m.date??m.timestamp??null,I=q?new Date(q):null,U=I&&!isNaN(I.getTime())?I.toISOString():null;F={tipo:typeof m=="string"?m:m.tipo??m.esito??null,data:U}}return N(R({},g),{hasConfigPromethea:b,hasTrattativaYuvi:S,configurato:P,ultimoEsito:F})}),j=B.filter(g=>g.configurato).length;return console.log(`\u{1F4C8} TOTALE SOGGETTI CONFIGURATI: ${j}/${B.length}`),B}catch(s){return console.error("\u{1F4A5} Errore critico nel caricamento configurazioni:",s),l}})}getProvinceConSoggetti(e){return c(this,null,function*(){let t=this.authService.user(),r=yield this.supabaseService.isAdmin(),i=this.supabaseService.supabase.from("soggetti").select("provincia").in("tipo",["prospect","cliente"]);e?.soloMiei&&t&&(i=i.eq("created_by",t.id));let{data:a,error:o}=yield i;if(o||!a)return o&&console.error("Errore getProvinceConSoggetti:",o),[];let n=a.reduce((u,s)=>(s.provincia&&(u[s.provincia]=(u[s.provincia]??0)+1),u),{}),d=Object.entries(n),l=[];for(let[u,s]of d){let f=Object.keys(this.provinceFallback).find(p=>p.toLowerCase()===u.toLowerCase());if(f){let p=this.provinceFallback[f];l.push({nome:u,coordinate:p,conteggio:s})}else{console.warn(`Provincia non trovata nel fallback: ${u}`);let p=yield this.getCoordinateProvinciaSemplice(u);p&&l.push({nome:u,coordinate:p,conteggio:s})}}return l.sort((u,s)=>s.conteggio-u.conteggio)})}getCoordinateProvinciaSemplice(e){return c(this,null,function*(){let t=e.toLowerCase();if(this.coordinateCache.has(t))return this.coordinateCache.get(t);let i=N(R({},this.provinceFallback),{Udine:{lat:46.0647,lng:13.24,indirizzo:"Udine"},Pordenone:{lat:45.9544,lng:12.6575,indirizzo:"Pordenone"},Gorizia:{lat:45.9414,lng:13.6217,indirizzo:"Gorizia"},Trieste:{lat:45.6495,lng:13.7768,indirizzo:"Trieste"},Torino:{lat:45.0703,lng:7.6869,indirizzo:"Torino"},Vercelli:{lat:45.321,lng:8.426,indirizzo:"Vercelli"},Novara:{lat:45.445,lng:8.616,indirizzo:"Novara"},Cuneo:{lat:44.388,lng:7.547,indirizzo:"Cuneo"},Asti:{lat:44.9,lng:8.206,indirizzo:"Asti"},Alessandria:{lat:44.913,lng:8.616,indirizzo:"Alessandria"},Imperia:{lat:43.887,lng:8.03,indirizzo:"Imperia"}})[e];return i?(this.coordinateCache.set(t,i),i):(console.warn(`Nessun fallback per provincia: ${e}`),null)})}getProvinciaUtenteCorrente(){return c(this,null,function*(){let e=this.authService.user();if(!e)return null;let{data:t,error:r}=yield this.supabaseService.supabase.from("app_users").select("provincia").eq("id",e.id).single();return r?(console.warn("Provincia utente non reperita:",r),null):t?.provincia??null})}getCoordinateProvincia(e){return c(this,null,function*(){let t=e?.toLowerCase();if(!t)return null;if(this.coordinateCache.has(t))return this.coordinateCache.get(t);let r=yield this.geocodificaIndirizzo(void 0,e);return r&&this.coordinateCache.set(t,r),r??null})}geocodificaSoggetto(e){return c(this,null,function*(){return this.geocodificaIndirizzo(e.comune,e.provincia,e.indirizzo,e.numero_civico)})}geocodificaSoggettiBatch(e){return c(this,null,function*(){let t=new Map,r=5;for(let i=0;i<e.length;i+=r){let a=e.slice(i,i+r);yield Promise.all(a.map(o=>c(this,null,function*(){let n=yield this.geocodificaSoggetto(o);n&&t.set(o.id,n)}))),i+r<e.length&&(yield new Promise(o=>setTimeout(o,1e3)))}return t})}normalizeTipo(e){return e==="cliente"?"cliente":e==="fornitore"?"fornitore":"prospect"}resolveCoordinate(e){let t=a=>a==null?NaN:typeof a=="number"?a:Number(a.toString().trim().replace(",",".")),r=t(e.latitude),i=t(e.longitude);if(!Number.isNaN(r)&&!Number.isNaN(i)&&Math.abs(r)<=90&&Math.abs(i)<=180&&!(r===0&&i===0)){let a=[e.indirizzo,e.numero_civico,e.comune,e.provincia].filter(Boolean).join(" ").trim();return{lat:r,lng:i,indirizzo:a||`${e.comune??""} ${e.provincia??""}`.trim()}}return e.provincia&&this.provinceFallback[e.provincia]?this.provinceFallback[e.provincia]:null}geocodificaIndirizzo(e,t,r,i){return c(this,null,function*(){let a=[r,i,e,t].filter(Boolean).map(n=>n.toLowerCase().trim());if(!a.length)return null;let o=a.join("|");if(this.coordinateCache.has(o))return this.coordinateCache.get(o);if(t&&!r&&!e){let n=this.provinceFallback[t];return n?(this.coordinateCache.set(o,n),n):null}if(!this.ALLOW_CLIENT_GEOCODING){let n=t?this.provinceFallback[t]:void 0;return n?(this.coordinateCache.set(o,n),n):null}try{let n=[r?`${r}${i?` ${i}`:""}`:null,e,t,"Italia"].filter(Boolean).join(", ");console.log(`\u{1F30D} Tentativo geocodifica: ${n}`);let d=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(n)}&limit=1`,l=yield fetch(d,{headers:{"Accept-Language":"it","User-Agent":"PrometheaApp/1.0"}});if(!l.ok)throw console.warn(`Nominatim risposta non ok: ${l.status}`),new Error(`Nominatim ${l.status}`);let u=yield l.json();if(Array.isArray(u)&&u.length>0){let f={lat:parseFloat(u[0].lat),lng:parseFloat(u[0].lon),indirizzo:u[0].display_name};return this.coordinateCache.set(o,f),console.log(`\u2705 Geocodifica riuscita: ${f.lat}, ${f.lng}`),f}console.warn("Nessun risultato dalla geocodifica, uso fallback provincia");let s=t?this.provinceFallback[t]:void 0;return s?(this.coordinateCache.set(o,s),s):null}catch(n){console.warn("Geocodifica fallita, uso fallback provincia:",n);let d=t?this.provinceFallback[t]:void 0;return d?(this.coordinateCache.set(o,d),d):null}})}static \u0275fac=function(t){return new(t||z)};static \u0275prov=E({token:z,factory:z.\u0275fac,providedIn:"root"})};var G=class z{supabaseService=y(k);authService=y(w);userService=y(D);mapService=y(A);soggettoCache=new Map;CACHE_TTL=3e4;createSoggetto(e){return c(this,null,function*(){try{if(console.log("\u{1F527} Creazione soggetto con dati:",e),e.piva?.trim()&&(yield this.supabaseService.checkPivaExists(e.piva.trim())))return{success:!1,error:"P.IVA gi\xE0 esistente nel sistema"};let t=this.mapToSnakeCase(e),r=this.authService.user();r&&(t.created_by=r.id),t.created_at=new Date().toISOString(),t.updated_at=t.created_at;let i=yield this.supabaseService.createSoggetto(t);return i.error?(console.error("\u274C Errore Supabase:",i.error),{success:!1,error:this.getErrorMessage(i.error)}):(this.soggettoCache.clear(),{success:!0,data:i.data||void 0})}catch(t){return console.error("\u274C Errore createSoggetto:",t),{success:!1,error:"Errore di sistema durante il salvataggio"}}})}clearCache(){this.soggettoCache.clear()}get supabase(){return this.supabaseService.supabase}getSoggettiByTipo(e,t=0,r=49){return c(this,null,function*(){if(this.userService.isAdmin()||e!=="prospect")return this.supabaseService.getSoggettiByTipo(e,t,r);let i=this.authService.user();if(!i)return{data:[],error:null};console.log(`\u{1F50D} Query prospect per utente: user=${i.id}, range=${t}-${r}`);let{data:a,error:o}=yield this.supabaseService.supabase.from("soggetti").select("*").eq("tipo",e).eq("created_by",i.id).order("created_at",{ascending:!1}).range(t,r);return{data:a,error:o}})}getSoggettoById(e){return c(this,null,function*(){return yield this.supabaseService.getSoggettoById(e)})}deleteSoggetto(e){return c(this,null,function*(){try{let t=this.supabase??this.supa??this.supabaseClient;if(!t)throw new Error("Supabase client non disponibile");let{data:r,error:i}=yield t.from("soggetti").delete().eq("id",e).select();return i?{success:!1,error:i.message||String(i)}:(Array.isArray(r)?r:r?[r]:[]).length===0?{success:!1,error:"Operazione non autorizzata: non \xE8 stato possibile eliminare questo soggetto (permessi insufficienti)."}:{success:!0}}catch(t){return{success:!1,error:t?.message??String(t)}}})}unlinkOrDelete(e,t,r){return c(this,null,function*(){try{let{data:i,error:a}=yield this.supabaseService.supabase.from(e).update({[t]:null}).eq(t,r).select();if(a){let o=a?.code??null,n=a?.message??String(a);if(String(o)==="23502"||/not-?null/i.test(n)){let{error:d}=yield this.supabaseService.supabase.from(e).delete().eq(t,r);return d?{ok:!1,error:d}:{ok:!0}}return{ok:!1,error:a}}return{ok:!0}}catch(i){return console.error("unlinkOrDelete exception",i),{ok:!1,error:i}}})}updateSoggetto(e){return c(this,null,function*(){try{let t=this.supabase??this.supa??this.supabaseClient;if(!t)throw new Error("Supabase client non disponibile");let{data:r,error:i}=yield t.from("soggetti").update({ragione_sociale:e.ragioneSociale,piva:e.piva,formula_societaria:e.formulaSocietaria,categoria_ateco:e.categoriaAteco,referente:e.referente,telefono:e.telefono,email:e.email,sito_web:e.sitoWeb,facebook:e.facebook,instagram:e.instagram,metodo_pagamento:e.metodoPagamento,iban:e.iban,note:e.note,prodotto:e.prodotto,provincia:e.provincia,comune:e.comune,indirizzo:e.indirizzo,numero_civico:e.numeroCivico,updated_at:new Date().toISOString()}).eq("id",e.id).select();if(i)return{success:!1,error:i.message||String(i)};let a=Array.isArray(r)?r:r?[r]:[];return a.length===0?{success:!1,error:"Operazione non autorizzata: non \xE8 stato possibile modificare questo soggetto (permessi insufficienti)."}:{success:!0,data:a[0]}}catch(t){return{success:!1,error:t?.message??String(t)}}})}searchSoggetti(e,t){return c(this,null,function*(){try{if(t!=="prospect"||this.userService.isAdmin()){let n=yield this.supabaseService.searchSoggetti(e,t);return t?{data:(n.data??[]).filter(l=>l.tipo===t),error:null}:n}let r=this.authService.user();if(!r)return{data:[],error:null};let i=(e??"").trim(),{data:a,error:o}=yield this.supabaseService.supabase.from("soggetti").select("*").eq("tipo","prospect").eq("created_by",r.id).or(`ragione_sociale.ilike.%${i}%,referente.ilike.%${i}%,piva.ilike.%${i}%,telefono.ilike.%${i}%,email.ilike.%${i}%`).order("created_at",{ascending:!1}).limit(50);return{data:a,error:o}}catch(r){return console.error("Errore nella ricerca soggetti:",r),{data:null,error:r}}})}updateProdotto(e,t){return c(this,null,function*(){try{let r=yield this.supabaseService.updateSoggetto(e,{prodotto:t});return r.error?{success:!1,error:this.getErrorMessage(r.error),code:r.error.code}:{success:!0,data:r.data||void 0}}catch{return{success:!1,error:"Errore di sistema durante l'aggiornamento del prodotto"}}})}getProvinceByTipo(e){return c(this,null,function*(){return this.supabaseService.getProvinceByTipo(e)})}countByTipo(e){return c(this,null,function*(){if(this.userService.isAdmin()||e!=="prospect")return this.supabaseService.countSoggettiByTipo(e);let t=this.authService.user();if(!t)return{data:0,error:null};let{count:r,error:i}=yield this.supabaseService.supabase.from("soggetti").select("*",{count:"exact",head:!0}).eq("tipo",e).eq("created_by",t.id);return{data:r??0,error:i}})}getConfigurazioniProspect(e){return c(this,null,function*(){try{if(!e.length)return new Map;let[t,r]=yield Promise.all([this.supabaseService.supabase.from("configurazioni_promethea").select("prospect_id").in("prospect_id",e),this.supabaseService.supabase.from("trattative_yuvi").select("prospect_id").in("prospect_id",e)]),i=new Map;return e.forEach(a=>i.set(a,!1)),t.data&&t.data.forEach(a=>{a.prospect_id&&i.set(a.prospect_id,!0)}),r.data&&r.data.forEach(a=>{a.prospect_id&&i.set(a.prospect_id,!0)}),i}catch(t){return console.error("Errore bulk configurazioni:",t),new Map}})}getConfigurazioniPrometheaByCliente(e){return c(this,null,function*(){if(!e.length)return new Map;let t=(r,i=100)=>{let a=[];for(let o=0;o<r.length;o+=i)a.push(r.slice(o,o+i));return a};try{let r=new Map;e.forEach(n=>r.set(n,null));let a=t(e,100).map(n=>this.supabaseService.supabase.from("configurazioni_promethea").select("prospect_id, dettagli").in("prospect_id",n)),o=yield Promise.all(a);for(let n of o){if(n.error){console.warn("Partial fetch error for configurazioni_promethea chunk:",n.error);continue}(n.data??[]).forEach(l=>{l?.prospect_id&&r.set(l.prospect_id,l.dettagli)})}return r}catch(r){return console.error("Errore bulk configurazioni Promethea per clienti:",r),new Map}})}getTrattativeYuviByProspect(e){return c(this,null,function*(){if(!e.length)return new Map;let t=(r,i=100)=>{let a=[];for(let o=0;o<r.length;o+=i)a.push(r.slice(o,o+i));return a};try{let r=new Map;e.forEach(n=>r.set(n,!1));let a=t(e,100).map(n=>this.supabaseService.supabase.from("trattative_yuvi").select("prospect_id").in("prospect_id",n)),o=yield Promise.all(a);for(let n of o){if(n.error){console.warn("Partial fetch error for trattative_yuvi chunk:",n.error);continue}(n.data??[]).forEach(l=>{l?.prospect_id&&r.set(l.prospect_id,!0)})}return r}catch(r){return console.error("Errore bulk trattative YUVI:",r),new Map}})}getTrattativeYuviByCliente(e){return c(this,null,function*(){if(!e.length)return new Map;let t=(r,i=100)=>{let a=[];for(let o=0;o<r.length;o+=i)a.push(r.slice(o,o+i));return a};try{let r=new Map;e.forEach(n=>r.set(n,!1));let a=t(e,100).map(n=>this.supabaseService.supabase.from("trattative_yuvi").select("prospect_id").in("prospect_id",n)),o=yield Promise.all(a);for(let n of o){if(n.error){console.warn("Partial fetch error for trattative_yuvi chunk (clienti):",n.error);continue}(n.data??[]).forEach(l=>{l?.prospect_id&&r.set(l.prospect_id,!0)})}return r}catch(r){return console.error("Errore bulk trattative YUVI per clienti:",r),new Map}})}syncProdottiForProspects(e){return c(this,null,function*(){if(!e||e.length===0)return{updated:0,errors:[]};let t=(r,i=100)=>{let a=[];for(let o=0;o<r.length;o+=i)a.push(r.slice(o,o+i));return a};try{let[r,i]=yield Promise.all([this.getConfigurazioniPrometheaByCliente(e),this.getTrattativeYuviByProspect(e)]),a=0,o=[],n=t(e,100);for(let d of n){let{data:l,error:u}=yield this.supabaseService.supabase.from("soggetti").select("id, prodotto").in("id",d);if(u){console.warn("Errore fetch soggetti per sync prodotti chunk:",u),o.push(String(u.message||u));continue}let s=[];(l||[]).forEach(f=>{let p=f.id,h=!!r.get(p),_=!!i.get(p),v=[];if(h&&v.push("Promethea"),_&&v.push("Yuvi"),v.length===0)return;let T=v.join(", ");(f.prodotto??"").trim()!==T&&s.push(this.supabaseService.updateSoggetto(p,{prodotto:T}).then(C=>{C.error?o.push(`id=${p}: ${C.error.message||C.error}`):a++}).catch(C=>{o.push(`id=${p}: ${String(C)}`)}))}),yield Promise.all(s)}return{updated:a,errors:o}}catch(r){return console.error("Errore sync prodotti:",r),{updated:0,errors:[String(r)]}}})}mapToSnakeCase(e){return{tipo:e.tipo,ragione_sociale:e.ragioneSociale,piva:e.piva&&e.piva.trim()!==""?e.piva:null,formula_societaria:e.formulaSocietaria||null,categoria_ateco:e.categoriaAteco||null,referente:e.referente||null,telefono:e.telefono||null,email:e.email||null,sito_web:e.sitoWeb||null,facebook:e.facebook||null,instagram:e.instagram||null,metodo_pagamento:e.metodoPagamento||null,iban:e.iban||null,note:e.note||null,prodotto:e.prodotto||"Promethea",referenza_da_id:e.referenzaDaId??null,provincia:e.provincia||null,comune:e.comune||null,indirizzo:e.indirizzo||null,numero_civico:e.numeroCivico||null,esiti:[],created_by:null}}mapUpdateToSnakeCase(e){let t={};return e.tipo!==void 0&&(t.tipo=e.tipo),e.ragioneSociale!==void 0&&(t.ragione_sociale=e.ragioneSociale),e.piva!==void 0&&(t.piva=e.piva&&e.piva.trim()!==""?e.piva:null),e.formulaSocietaria!==void 0&&(t.formula_societaria=e.formulaSocietaria),e.categoriaAteco!==void 0&&(t.categoria_ateco=e.categoriaAteco),e.referente!==void 0&&(t.referente=e.referente),e.telefono!==void 0&&(t.telefono=e.telefono),e.email!==void 0&&(t.email=e.email),e.sitoWeb!==void 0&&(t.sito_web=e.sitoWeb),e.facebook!==void 0&&(t.facebook=e.facebook),e.instagram!==void 0&&(t.instagram=e.instagram),e.metodoPagamento!==void 0&&(t.metodo_pagamento=e.metodoPagamento),e.iban!==void 0&&(t.iban=e.iban),e.note!==void 0&&(t.note=e.note),e.prodotto!==void 0&&(t.prodotto=e.prodotto),e.provincia!==void 0&&(t.provincia=e.provincia),e.comune!==void 0&&(t.comune=e.comune),e.indirizzo!==void 0&&(t.indirizzo=e.indirizzo),e.numeroCivico!==void 0&&(t.numero_civico=e.numeroCivico),e.referenzaDaId!==void 0&&(t.referenza_da_id=e.referenzaDaId??null),t}getErrorMessage(e){return typeof e=="string"?e:{23505:"Dati duplicati: il soggetto potrebbe gi\xE0 esistere",42501:"Permessi insufficienti per completare l'operazione",P0001:"Errore di validazione dei dati",network_error:"Errore di connessione al server"}[e.code]||e.message||"Errore durante il salvataggio"}getEsitiBySoggetto(e){return c(this,null,function*(){try{let{data:t,error:r}=yield this.supabaseService.getSoggettoById(e);if(r)return{data:null,error:r};let i=t?.esiti??[];return{data:this.normalizzaEsiti(i),error:null}}catch(t){return{data:null,error:t}}})}appendEsito(e,t){return c(this,null,function*(){try{let r=[];try{r=(yield this.getEsitiBySoggetto(e)).data??[]}catch(n){console.warn("Errore recupero esiti, procedo con array vuoto:",n),r=[]}let i=this.creaEsitoCompleto(t),a=[...r,i],o=yield this.supabaseService.updateSoggetto(e,{esiti:a});return o.error?{success:!1,error:this.getErrorMessage(o.error),code:o.error.code}:{success:!0,data:o.data||void 0}}catch(r){return console.error("Errore in appendEsito:",r),{success:!1,error:"Errore di sistema durante il salvataggio dell'esito"}}})}normalizzaEsiti(e){return e.map(t=>({tipo:t.tipo||"Non interessato",note:t.note||null,ts:t.ts||new Date().toISOString(),scheduleAt:t.scheduleAt||null,dataAppuntamento:t.dataAppuntamento||null,oraAppuntamento:t.oraAppuntamento||null}))}creaEsitoCompleto(e){return{tipo:e.tipo,note:e.note||null,ts:new Date().toISOString(),scheduleAt:e.scheduleAt||null,dataAppuntamento:e.dataAppuntamento||null,oraAppuntamento:e.oraAppuntamento||null}}convertiProspectInCliente(e){return c(this,null,function*(){try{let t={tipo:"cliente",updated_at:new Date().toISOString()},{data:r,error:i}=yield this.supabaseService.supabase.from("soggetti").update(t).eq("id",e).eq("tipo","prospect").select().single();return i?(console.error("Errore nella conversione prospect -> cliente:",i),{data:null,error:i}):(console.log("Prospect convertito in cliente:",r),{data:r,error:null})}catch(t){return console.error("Errore generale nella conversione:",t),{data:null,error:t}}})}aggiornaCoordinateSoggetto(e,t,r){return c(this,null,function*(){try{let i=yield this.supabaseService.updateSoggetto(e,{latitude:t,longitude:r,updated_at:new Date().toISOString()});return i.error?{success:!1,error:this.getErrorMessage(i.error),code:i.error.code}:{success:!0,data:i.data||void 0}}catch(i){return console.error("Errore aggiornamento coordinate:",i),{success:!1,error:"Errore durante l'aggiornamento delle coordinate"}}})}geocodificaEAggiornaSoggetto(e){return c(this,null,function*(){try{let{data:t,error:r}=yield this.getSoggettoById(e);if(r||!t)return{success:!1,error:"Soggetto non trovato"};if(!t.provincia&&!t.comune)return{success:!1,error:"Dati insufficienti per la geocodifica (manca provincia/comune)"};let i=yield this.mapService.geocodificaSoggetto(t);return i?yield this.aggiornaCoordinateSoggetto(e,i.lat,i.lng):{success:!1,error:"Impossibile determinare le coordinate dall'indirizzo"}}catch(t){return console.error("Errore geocodifica soggetto:",t),{success:!1,error:"Errore durante la geocodifica"}}})}geocodificaSoggettiSenzaCoordinate(e=50){return c(this,null,function*(){try{let{data:t,error:r}=yield this.supabaseService.supabase.from("soggetti").select("*").or("latitude.is.null,longitude.is.null").not("provincia","is",null).limit(e);if(r)throw r;if(!t||t.length===0)return{success:0,failed:0,total:0,errors:[]};console.log(`\u{1F504} Geocodifica batch di ${t.length} soggetti...`);let i=yield this.mapService.geocodificaSoggettiBatch(t),a=0,o=0,n=[];for(let d of t){let l=i.get(d.id);if(l){let u=yield this.aggiornaCoordinateSoggetto(d.id,l.lat,l.lng);u.success?a++:(o++,n.push(`${d.ragione_sociale}: ${u.error}`))}else o++,n.push(`${d.ragione_sociale}: Coordinate non trovate`)}return console.log(`\u2705 Geocodifica batch completata: ${a} successi, ${o} falliti`),{success:a,failed:o,total:t.length,errors:n}}catch(t){return console.error("Errore geocodifica batch:",t),{success:0,failed:0,total:0,errors:["Errore generale durante la geocodifica batch"]}}})}static \u0275fac=function(t){return new(t||z)};static \u0275prov=E({token:z,factory:z.\u0275fac,providedIn:"root"})};export{A as a,G as b};
