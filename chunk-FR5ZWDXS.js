import{b as l}from"./chunk-UNZMF5LD.js";import{p as g}from"./chunk-T73ZBVQL.js";import{N as f,S as p}from"./chunk-54AF7LZE.js";import{a as u,b as c,i}from"./chunk-ODN5LVDJ.js";var d=class n{supabaseService=p(l);router=p(g);salvaConfigurazione(e,r){return i(this,null,function*(){let a=new Date().toISOString();if(r){let{data:z,error:h}=yield this.supabaseService.supabase.from("configurazioni_promethea").update(c(u({},e),{updated_at:a})).eq("id",r).select("*").single();return{data:z,error:h}}let o=new Date().getFullYear(),{data:t,error:m}=yield this.supabaseService.supabase.from("configurazioni_promethea").select("numero_preventivo, created_at").not("numero_preventivo","is",null).gte("created_at",`${o}-01-01T00:00:00Z`).lt("created_at",`${o+1}-01-01T00:00:00Z`).order("numero_preventivo",{ascending:!1}).limit(1);m&&console.error("Errore nel recupero ultimo numero preventivo:",m);let s=1;t&&t.length>0&&t[0].numero_preventivo&&(s=t[0].numero_preventivo+1);let v=`${o}/${s.toString().padStart(4,"0")}`,{data:b,error:_}=yield this.supabaseService.supabase.from("configurazioni_promethea").insert([c(u({},e),{numero_preventivo:s,numero_preventivo_formattato:v,created_at:a,updated_at:a})]).select("*").single();return{data:b,error:_}})}getConfigurazioniByProspect(e){return i(this,null,function*(){let{data:r,error:a}=yield this.supabaseService.supabase.from("configurazioni_promethea").select("*").eq("prospect_id",e).order("created_at",{ascending:!1});return{data:r,error:a}})}getConfigurazioneById(e){return i(this,null,function*(){let{data:r,error:a}=yield this.supabaseService.supabase.from("configurazioni_promethea").select("*").eq("id",e).single();return{data:r,error:a}})}vaiAConfigurazionePromethea(e,r){this.router.navigate(["/alchemizzatore"],{queryParams:{prospectId:e.id,step:6},state:{prospect:e,goToStep:6,from:r}})}verificaConfigurazioniPromethea(e){return i(this,null,function*(){if(!e.length)return new Map;let{data:r,error:a}=yield this.supabaseService.supabase.from("configurazioni_promethea").select("prospect_id").in("prospect_id",e);if(a)return console.error("Errore verifica configurazioni Promethea:",a),new Map;let o=new Map;return e.forEach(t=>o.set(t,!1)),r&&r.forEach(t=>{t.prospect_id&&o.set(t.prospect_id,!0)}),o})}calcolaPrezzoServizio(e,r){switch(e){case"contab_sempl_90":return 1421;case"contab_sempl_180":return 1811;default:return 0}}salvaDettagliConfigurazione(e,r){return i(this,null,function*(){let a=new Date().toISOString(),{data:o,error:t}=yield this.supabaseService.supabase.from("configurazioni_promethea").update({dettagli:r,updated_at:a}).eq("id",e).select("*").single();return{data:o,error:t}})}static \u0275fac=function(r){return new(r||n)};static \u0275prov=f({token:n,factory:n.\u0275fac,providedIn:"root"})};export{d as a};
