import{a as $}from"./chunk-NM3TEZ7A.js";import{a as A,c as V,e as z,i as O,j as B,k as K,o as W}from"./chunk-IYVBQW5G.js";import{a as j}from"./chunk-B2PGE4B5.js";import{d as R}from"./chunk-LOD6TMDG.js";import{j as k,k as D,p as N,v as P}from"./chunk-67GYVHNT.js";import{Aa as b,Ga as L,La as v,S as C,X as _,Xa as d,Y as S,Ya as n,Za as r,db as y,gb as h,hb as f,mb as o,nb as p,ob as w,qb as F,rb as I,sb as M,ua as l}from"./chunk-QS6MTI54.js";import"./chunk-X5YLR3NI.js";import{a as E,b as x,i as u}from"./chunk-ODN5LVDJ.js";function H(c,t){c&1&&(n(0,"span",14),o(1,"delete"),r())}function J(c,t){c&1&&(n(0,"span",14),o(1,"hourglass_bottom"),r())}function Q(c,t){if(c&1){let i=y();n(0,"tr")(1,"td",33)(2,"div",34)(3,"strong"),o(4),r()()(),n(5,"td",35)(6,"div",34),o(7),r()(),n(8,"td",36)(9,"div",34),o(10),r()(),n(11,"td",37)(12,"div",34),o(13),r()(),n(14,"td",38)(15,"div",34),o(16),r()(),n(17,"td",39)(18,"div",40)(19,"button",41),h("click",function(s){let a=_(i).$implicit,m=f();return s.stopPropagation(),S(m.onEdit(a))}),n(20,"span",14),o(21,"edit"),r()(),n(22,"button",42),h("click",function(s){let a=_(i).$implicit,m=f();return s.stopPropagation(),S(m.onAddDocument(a))}),n(23,"span",14),o(24,"description"),r()(),n(25,"button",43),h("click",function(s){let a=_(i).$implicit,m=f();return s.stopPropagation(),S(m.onDelete(a))}),v(26,H,2,0,"span",44)(27,J,2,0,"span",44),r()()()()}if(c&2){let i=t.$implicit,e=f();l(4),p(i.ragione_sociale),l(3),p(i.referente||"\u2014"),l(3),p(i.telefono||"\u2014"),l(3),p(i.email||"\u2014"),l(3),p(i.metodo_pagamento||"\u2014"),l(9),d("disabled",e.deletingIds.has(i.id)),l(),d("ngIf",!e.deletingIds.has(i.id)),l(),d("ngIf",e.deletingIds.has(i.id))}}function U(c,t){c&1&&(n(0,"tr")(1,"td",45),o(2,"Nessun fornitore"),r()())}function X(c,t){c&1&&(n(0,"span",14),o(1,"expand_more"),r())}function Y(c,t){c&1&&(n(0,"span",14),o(1,"hourglass_bottom"),r())}function Z(c,t){if(c&1){let i=y();n(0,"div",46)(1,"button",47),h("click",function(){_(i);let s=f();return S(s.loadMoreClick())}),v(2,X,2,0,"span",44)(3,Y,2,0,"span",44),o(4),r()()}if(c&2){let i=f();l(),d("disabled",i.loading||!i.hasMore),l(),d("ngIf",!i.loading),l(),d("ngIf",i.loading),l(),w(" ",i.loading?"Caricamento\u2026":i.hasMore?"Carica altri":"Niente da caricare"," ")}}function ee(c,t){if(c&1&&(n(0,"div",48),o(1),r()),c&2){let i=f();l(),w(" ",i.error," ")}}var q=class c{constructor(t,i){this.supabase=t;this.kpiService=i}soggettiService=C(j);router=C(R);rows=[];loading=!1;error=null;hasMore=!0;deletingIds=new Set;page=0;pageSize=50;filtroEsito="";sortDir="desc";filteredRows=[];totaleFornitori=0;fornitoriConIban=0;fornitoriConReferente=0;searchTerm="";searchDebounce;ngOnInit(){return u(this,null,function*(){yield this.loadMore(!0),yield this.refreshKpiFornitori()})}refreshKpiFornitori(){return u(this,null,function*(){let t=yield this.kpiService.getAnagraficaKPI("fornitore");this.totaleFornitori=t.totale,this.fornitoriConIban=t.conIban,this.fornitoriConReferente=t.conReferente})}getLastEsito(t){if(!Array.isArray(t)||t.length===0)return null;let i=t[0];for(let e of t)new Date(e.ts).getTime()>new Date(i.ts).getTime()&&(i=e);return i}loadMore(t=!1){return u(this,null,function*(){if(!(this.loading||!this.hasMore&&!t)){this.loading=!0,this.error=null;try{t&&(this.page=0,this.rows=[],this.hasMore=!0);let i=this.page*this.pageSize,e=i+this.pageSize-1,{data:s,error:a}=yield this.soggettiService.getSoggettiByTipo("fornitore",i,e);if(a){let g=a?.message??String(a);this.error="Errore nel caricamento dei fornitori: "+g;return}let m=(s??[]).map(g=>x(E({},g),{ultimoEsito:this.getLastEsito(g.esiti)})),G=new Set(this.rows.map(g=>g.id)),T=m.filter(g=>!G.has(g.id));this.rows=t?T:[...this.rows,...T],this.hasMore=m.length===this.pageSize,this.hasMore&&this.page++,this.applyFilters()}catch(i){this.error="Errore di connessione",console.error("Errore caricamento fornitori:",i)}finally{this.loading=!1}}})}onDelete(t){return u(this,null,function*(){if(!(!confirm(`Sei sicuro di voler eliminare il fornitore "${t.ragione_sociale}"?`)||!t.id)){this.deletingIds.add(t.id);try{let e=yield this.soggettiService.deleteSoggetto(t.id);if(e.error){alert("Errore durante l'eliminazione: "+e.error);return}this.rows=this.rows.filter(s=>s.id!==t.id),alert("Fornitore eliminato con successo")}catch(e){alert("Errore durante l'eliminazione"),console.error("Errore eliminazione fornitore:",e)}finally{this.deletingIds.delete(t.id)}yield this.refreshKpiFornitori()}})}onEdit(t){this.router.navigate(["/modifica-fornitore",t.id])}onAddDocument(t){console.log("Aggiungi documento per:",t.ragione_sociale)}loadMoreClick(){this.loadMore()}trackById(t,i){return i.id}onSearchChange(t){this.searchTerm=t,this.searchDebounce&&clearTimeout(this.searchDebounce),this.searchDebounce=setTimeout(()=>{if(!this.searchTerm.trim()){this.resetList();return}this.onSearch()},300)}onSearch(){return u(this,null,function*(){try{this.loading=!0,this.error=null;let t=this.searchTerm.trim().replace(/[%_]/g,""),i=`ragione_sociale.ilike.%${t}%,telefono.ilike.%${t}%,email.ilike.%${t}%`,{data:e,error:s}=yield this.supabase.supabase.from("soggetti").select("id, ragione_sociale, referente, telefono, email, metodo_pagamento, created_at, esiti").eq("tipo","fornitore").or(i).order("created_at",{ascending:!1}).limit(50);if(s)throw s;this.rows=(e||[]).map(a=>x(E({},a),{ultimoEsito:this.getLastEsito(a.esiti)})),this.hasMore=!1,this.applyFilters()}catch(t){this.error=t?.message||"Errore ricerca"}finally{this.loading=!1}})}resetList(){this.rows=[],this.hasMore=!0,this.loadMoreClick()}getSortTime(t){let i=this.getLastEsito(t.esiti),e=i?.ts?new Date(i.ts).getTime():0,s=t.created_at?new Date(t.created_at).getTime():0;return e||s}matchEsito(t,i){if(!i)return!0;if(i==="Non Contattato")return!t;let e=(t?.tipo||t?.esito||"").toString().toLowerCase();switch(i){case"Richiamare":return e.includes("richiam");case"Contratto Chiuso":return e.includes("contratto")||e.includes("chiuso")||e==="contratto_chiuso";case"Non Chiuso":return e.includes("non")&&e.includes("chiuso")||e==="non_chiuso";default:return!0}}applyFilters(){let t=(this.searchTerm||"").trim().toLowerCase(),i=[...this.rows];t&&(i=i.filter(e=>[e.ragione_sociale,e.referente,e.telefono,e.email].map(a=>(a||"").toString().toLowerCase()).join(" ").includes(t))),i=i.filter(e=>this.matchEsito(this.getLastEsito(e.esiti),this.filtroEsito)),i.sort((e,s)=>{let a=this.getSortTime(e),m=this.getSortTime(s);return this.sortDir==="desc"?m-a:a-m}),this.filteredRows=i}onChangeSortDir(t){this.sortDir=t,this.applyFilters()}static \u0275fac=function(i){return new(i||c)(b(P),b($))};static \u0275cmp=L({type:c,selectors:[["app-lista-fornitori"]],decls:80,vars:11,consts:[[1,"form-section"],[1,"section-header"],[1,"material-icons","header-icon"],[1,"section-titles"],[1,"section-title"],[1,"sottotitolo"],[1,"prospect-cards"],[1,"card"],[1,"card-title"],[1,"card-number"],[1,"table-section"],[1,"table-tools"],[1,"tool"],["for","fornitori-search",1,"label"],[1,"material-icons"],["id","fornitori-search","type","text","placeholder","Ragione sociale, telefono, email\u2026",1,"table-inline-input",3,"ngModelChange","ngModel"],["for","filtro-esito-forn",1,"label"],["id","filtro-esito-forn",1,"table-inline-select",3,"ngModelChange","ngModel"],["value",""],["value","Non Contattato"],["value","Richiamare"],["value","Contratto Chiuso"],["value","Non Chiuso"],["for","ordinaPerForn",1,"label"],["id","ordinaPerForn",1,"table-inline-select",3,"ngModelChange","ngModel"],["value","desc"],["value","asc"],[1,"table-container"],[1,"crm-table"],[4,"ngFor","ngForOf","ngForTrackBy"],[4,"ngIf"],["class","load-more-container",4,"ngIf"],["style","text-align:center; color:#ef4444; margin-top:1rem;",4,"ngIf"],["data-label","Ragione Sociale"],[1,"cell-content"],["data-label","Referente"],["data-label","Telefono"],["data-label","Email"],["data-label","Metodo Pagamento"],["data-label","Azioni"],[1,"actions-container"],["title","Modifica",1,"action-btn","edit",3,"click"],["title","Documento",1,"action-btn","document",3,"click"],["title","Elimina",1,"action-btn","delete",3,"click","disabled"],["class","material-icons",4,"ngIf"],["colspan","6",2,"text-align","center","padding","1.5rem"],[1,"load-more-container"],[1,"promethea-button",3,"click","disabled"],[2,"text-align","center","color","#ef4444","margin-top","1rem"]],template:function(i,e){i&1&&(n(0,"div",0)(1,"div",1)(2,"i",2),o(3,"local_shipping"),r(),n(4,"div",3)(5,"h2",4),o(6,"Fornitori"),r(),n(7,"p",5),o(8,"Panoramica fornitori e KPI"),r()()(),n(9,"div",6)(10,"div",7)(11,"h3",8),o(12,"Totale Fornitori"),r(),n(13,"div",9),o(14),r()(),n(15,"div",7)(16,"h3",8),o(17,"Con IBAN"),r(),n(18,"div",9),o(19),r()(),n(20,"div",7)(21,"h3",8),o(22,"Con Referente"),r(),n(23,"div",9),o(24),r()()()(),n(25,"section",10)(26,"div",11)(27,"div",12)(28,"label",13)(29,"span",14),o(30,"search"),r(),o(31," Cerca "),r(),n(32,"input",15),M("ngModelChange",function(a){return I(e.searchTerm,a)||(e.searchTerm=a),a}),h("ngModelChange",function(a){return e.onSearchChange(a)}),r()(),n(33,"div",12)(34,"label",16)(35,"span",14),o(36,"flag"),r(),o(37," Esito "),r(),n(38,"select",17),M("ngModelChange",function(a){return I(e.filtroEsito,a)||(e.filtroEsito=a),a}),h("ngModelChange",function(){return e.applyFilters()}),n(39,"option",18),o(40,"Tutti"),r(),n(41,"option",19),o(42,"Non contattato"),r(),n(43,"option",20),o(44,"Da richiamare"),r(),n(45,"option",21),o(46,"Contratto chiuso"),r(),n(47,"option",22),o(48,"Non chiuso"),r()()(),n(49,"div",12)(50,"label",23)(51,"span",14),o(52,"sort"),r(),o(53," Ordina per: "),r(),n(54,"select",24),h("ngModelChange",function(a){return e.onChangeSortDir(a)}),n(55,"option",25),o(56,"Pi\xF9 recente"),r(),n(57,"option",26),o(58,"Meno recente"),r()()()(),n(59,"div",27)(60,"table",28)(61,"thead")(62,"tr")(63,"th"),o(64,"Ragione Sociale"),r(),n(65,"th"),o(66,"Referente"),r(),n(67,"th"),o(68,"Telefono"),r(),n(69,"th"),o(70,"Email"),r(),n(71,"th"),o(72,"Metodo Pagamento"),r(),n(73,"th"),o(74,"Azioni"),r()()(),n(75,"tbody"),v(76,Q,28,8,"tr",29)(77,U,3,0,"tr",30),r()()(),v(78,Z,5,4,"div",31)(79,ee,2,1,"div",32),r()),i&2&&(l(14),p(e.totaleFornitori),l(5),p(e.fornitoriConIban),l(5),p(e.fornitoriConReferente),l(8),F("ngModel",e.searchTerm),l(6),F("ngModel",e.filtroEsito),l(16),d("ngModel",e.sortDir),l(22),d("ngForOf",e.filteredRows)("ngForTrackBy",e.trackById),l(),d("ngIf",!e.loading&&!e.error&&e.filteredRows.length===0),l(),d("ngIf",!e.error),l(),d("ngIf",e.error))},dependencies:[N,k,D,W,B,K,A,O,V,z],encapsulation:2})};export{q as ListFornitori};
