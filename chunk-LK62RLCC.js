import{a as S}from"./chunk-3WLDIF5C.js";import{c as v}from"./chunk-Q4FMGKSF.js";import{Fb as l,N as m,S as h,ea as d}from"./chunk-PE6PP35I.js";import{a as g,b as p,i as c}from"./chunk-ODN5LVDJ.js";var w=class f{soggettiService=h(S);authService=h(v);stato=d({rows:[],filteredRows:[],loading:!1,error:null,hasMore:!0,page:0,allLoaded:!1});allLoaded=l(()=>this.stato().allLoaded);filtri=d({provincia:"tutte",searchTerm:"",esito:"tutti",sortDir:"desc"});config;rows=l(()=>this.stato().rows);filteredRows=l(()=>this.stato().filteredRows);loading=l(()=>this.stato().loading);error=l(()=>this.stato().error);hasMore=l(()=>this.stato().hasMore);currentFiltri=l(()=>this.filtri());inizializza(e){this.config=g({pageSize:20,abilitaConfigurazioni:!0,abilitaTrattative:!0},e),this.reset()}caricaIniziali(){return c(this,null,function*(){if(!this.stato().loading){this.aggiornaStato({loading:!0,error:null});try{let e=this.config.pageSize??20,[{data:t,error:o},{data:a,error:s}]=yield Promise.all([this.soggettiService.countByTipo(this.config.tipo),this.soggettiService.getSoggettiByTipo(this.config.tipo,0,Math.max(e-1,0))]);if(o)throw o;if(s)throw s;let i=t??0,r=a??[],n=yield this.arricchisciDati(r);this.aggiornaStato({rows:n,hasMore:i>e,page:i>0?1:0,allLoaded:i<=e}),this.applicaFiltri()}catch(e){this.aggiornaStato({error:e?.message||"Errore durante il caricamento"})}finally{this.aggiornaStato({loading:!1})}}})}caricaTutti(){return c(this,null,function*(){if(!this.stato().loading){this.aggiornaStato({loading:!0,error:null});try{let{data:e,error:t}=yield this.soggettiService.countByTipo(this.config.tipo);if(t)throw t;let o=e??0;if(o===0){this.aggiornaStato({rows:[],filteredRows:[],hasMore:!1,page:0,allLoaded:!0});return}let a=Math.max(o-1,0),{data:s,error:i}=yield this.soggettiService.getSoggettiByTipo(this.config.tipo,0,a);if(i)throw i;let r=s??[],n=yield this.arricchisciDati(r);this.aggiornaStato({rows:n,hasMore:!1,page:1,allLoaded:!0}),this.applicaFiltri()}catch(e){this.aggiornaStato({error:e?.message||"Errore durante il caricamento"})}finally{this.aggiornaStato({loading:!1})}}})}cerca(e){return c(this,null,function*(){this.aggiornaStato({loading:!0,error:null});try{if(!e.trim()){this.stato().allLoaded?this.applicaFiltri():yield this.caricaIniziali();return}let t=yield this.soggettiService.searchSoggetti(e,this.config.tipo);if(t.error)throw t.error;let o=t.data??[],a=yield this.arricchisciDati(o);this.aggiornaStato({rows:a,hasMore:!1,page:0}),this.applicaFiltri()}catch(t){this.aggiornaStato({error:t?.message||"Errore durante la ricerca"})}finally{this.aggiornaStato({loading:!1})}})}applicaFiltri(e){e&&this.filtri.update(i=>g(g({},i),e));let t=this.filtri(),o=this.stato().rows;console.log("\u{1F39B}\uFE0F Applicazione filtri:",{filtri:t,rowsOriginali:o.length,tipo:this.config.tipo});let a=o.filter(i=>!(t.provincia!=="tutte"&&i.provincia!==t.provincia||t.esito!=="tutti"&&(t.esito==="senza-esito"&&i.ultimoEsito||t.esito!=="senza-esito"&&i.ultimoEsito?.tipo!==t.esito)||(this.config.tipo==="cliente"||this.config.tipo==="fornitore")&&(t.conIban&&!i.iban||t.conReferente&&!i.referente)||this.config.tipo==="prospect"&&t.configurato!==null&&t.configurato!==void 0&&i.configurato!==t.configurato));console.log("\u{1F50D} Dopo filtri:",{filtrati:a.length,eliminati:o.length-a.length});let s=i=>{let r=i.ultimoEsito?.ts?new Date(i.ultimoEsito.ts).getTime():0,n=i.created_at?new Date(i.created_at).getTime():0;return r||n};a.sort((i,r)=>{let n=s(i),u=s(r);return t.sortDir==="desc"?u-n:n-u}),console.log("\u{1F4CA} Filtri finali applicati:",a.length),this.aggiornaStato({filteredRows:a})}eliminaSoggetto(e){return c(this,null,function*(){try{let t=yield this.soggettiService.deleteSoggetto(e);if(!t.success)throw new Error(t.error);return this.aggiornaStato({rows:this.stato().rows.filter(o=>o.id!==e)}),this.applicaFiltri(),!0}catch(t){return this.aggiornaStato({error:t.message||"Errore durante l'eliminazione"}),!1}})}aggiornaProdotto(e,t){return c(this,null,function*(){try{let o=yield this.soggettiService.updateSoggetto({id:e,prodotto:t});if(!o.success)throw new Error(o.error);return this.aggiornaStato({rows:this.stato().rows.map(a=>a.id===e?p(g({},a),{prodotto:t}):a)}),this.applicaFiltri(),!0}catch(o){return this.aggiornaStato({error:o?.message||"Errore aggiornamento prodotto"}),!1}})}getModuliAttivi(e){if(!e)return[];let t=e.dettagli??e;if(!t||typeof t!="object")return[];let o={immagine_marketing:"immagine",digitalizzazione_automatismi:"digital",contabilita_fiscalita:"accounting",ottimizzazione_management:"optimization"},a=[];return Object.entries(o).forEach(([s,i])=>{let r=t[s];if(!r)return;let n=r.totale??r.totale_modulo??0,u=Array.isArray(r.servizi_selezionati)?r.servizi_selezionati:Array.isArray(r.servizi)?r.servizi:[];(n&&n>0||u.length>0)&&a.push(i)}),a}arricchisciDati(e){return c(this,null,function*(){let t=e.map(i=>i.id).filter(i=>!!i);if(t.length===0)return[];let o=[];if(this.config.abilitaConfigurazioni?o.push(this.soggettiService.getConfigurazioniPrometheaByCliente(t)):o.push(Promise.resolve(new Map)),this.config.abilitaTrattative){let i=this.config.tipo==="prospect"?this.soggettiService.getTrattativeYuviByProspect(t):this.soggettiService.getTrattativeYuviByCliente(t);o.push(i)}else o.push(Promise.resolve(new Map));let[a,s]=yield Promise.all(o);return e.map(i=>{let r=a.get(i.id),n=this.getModuliAttivi(r);return{id:i.id,tipo:i.tipo??this.config.tipo,ragione_sociale:i.ragione_sociale||"Senza nome",referente:i.referente,telefono:i.telefono,email:i.email,provincia:i.provincia,comune:i.comune,prodotto:i.prodotto||"Promethea",esiti:i.esiti,ultimoEsito:this.getUltimoEsito(i.esiti),configurato:!!r,hasConfigPromethea:!!r,hasTrattativaYuvi:s.get(i.id)||!1,moduliAttivi:n,created_at:i.created_at,iban:i.iban}})})}getUltimoEsito(e){return!Array.isArray(e)||e.length===0?null:e.reduce((t,o)=>{let a=new Date(o.ts).getTime(),s=new Date(t.ts).getTime();return a>s?o:t})}aggiornaStato(e){this.stato.update(t=>g(g({},t),e))}reset(){this.stato.set({rows:[],filteredRows:[],loading:!1,error:null,hasMore:!0,page:0,allLoaded:!1}),this.filtri.set({provincia:"tutte",searchTerm:"",esito:"tutti",sortDir:"desc"})}static \u0275fac=function(t){return new(t||f)};static \u0275prov=m({token:f,factory:f.\u0275fac,providedIn:"root"})};export{w as a};
