import{b as v}from"./chunk-H4JMM7IJ.js";import{c as m}from"./chunk-WPZ527DH.js";import{Gb as g,N as p,S as d,ea as h}from"./chunk-R5VHGKSY.js";import{a as u,i as c}from"./chunk-ODN5LVDJ.js";var S=class f{soggettiService=d(v);authService=d(m);stato=h({rows:[],filteredRows:[],loading:!1,error:null,hasMore:!0,page:0,allLoaded:!1});allLoaded=g(()=>this.stato().allLoaded);filtri=h({provincia:"tutte",searchTerm:"",esito:"tutti",sortDir:"desc"});config;rows=g(()=>this.stato().rows);filteredRows=g(()=>this.stato().filteredRows);loading=g(()=>this.stato().loading);error=g(()=>this.stato().error);hasMore=g(()=>this.stato().hasMore);currentFiltri=g(()=>this.filtri());inizializza(o){this.config=u({pageSize:20,abilitaConfigurazioni:!0,abilitaTrattative:!0},o),this.reset()}caricaIniziali(){return c(this,null,function*(){if(!this.stato().loading){this.aggiornaStato({loading:!0,error:null});try{let o=this.config.pageSize??20,[{data:t,error:e},{data:a,error:n}]=yield Promise.all([this.soggettiService.countByTipo(this.config.tipo),this.soggettiService.getSoggettiByTipo(this.config.tipo,0,Math.max(o-1,0))]);if(e)throw e;if(n)throw n;let i=t??0,r=a??[],s=yield this.arricchisciDati(r);this.aggiornaStato({rows:s,hasMore:i>o,page:i>0?1:0,allLoaded:i<=o}),this.applicaFiltri()}catch(o){this.aggiornaStato({error:o?.message||"Errore durante il caricamento"})}finally{this.aggiornaStato({loading:!1})}}})}caricaTutti(){return c(this,null,function*(){if(!this.stato().loading){this.aggiornaStato({loading:!0,error:null});try{let{data:o,error:t}=yield this.soggettiService.countByTipo(this.config.tipo);if(t)throw t;let e=o??0;if(e===0){this.aggiornaStato({rows:[],filteredRows:[],hasMore:!1,page:0,allLoaded:!0});return}let a=Math.max(e-1,0),{data:n,error:i}=yield this.soggettiService.getSoggettiByTipo(this.config.tipo,0,a);if(i)throw i;let r=n??[],s=yield this.arricchisciDati(r);this.aggiornaStato({rows:s,hasMore:!1,page:1,allLoaded:!0}),this.applicaFiltri()}catch(o){this.aggiornaStato({error:o?.message||"Errore durante il caricamento"})}finally{this.aggiornaStato({loading:!1})}}})}cerca(o){return c(this,null,function*(){this.aggiornaStato({loading:!0,error:null});try{if(!o.trim()){this.stato().allLoaded?this.applicaFiltri():yield this.caricaIniziali();return}let t=yield this.soggettiService.searchSoggetti(o,this.config.tipo);if(t.error)throw t.error;let e=t.data??[],a=yield this.arricchisciDati(e);this.aggiornaStato({rows:a,hasMore:!1,page:0}),this.applicaFiltri()}catch(t){this.aggiornaStato({error:t?.message||"Errore durante la ricerca"})}finally{this.aggiornaStato({loading:!1})}})}applicaFiltri(o){o&&this.filtri.update(i=>u(u({},i),o));let t=this.filtri(),e=this.stato().rows;console.log("\u{1F39B}\uFE0F Applicazione filtri:",{filtri:t,rowsOriginali:e.length,tipo:this.config.tipo});let a=e.filter(i=>{if(t.provincia!=="tutte"&&i.provincia!==t.provincia||t.esito!=="tutti"&&(t.esito==="senza-esito"&&i.ultimoEsito||t.esito!=="senza-esito"&&i.ultimoEsito?.tipo!==t.esito)||(this.config.tipo==="cliente"||this.config.tipo==="fornitore")&&(t.conIban&&!i.iban||t.conReferente&&!i.referente)||this.config.tipo==="prospect"&&t.configurato!==null&&t.configurato!==void 0&&i.configurato!==t.configurato)return!1;if(t.prodotto&&t.prodotto!=="tutti"){let r=String(t.prodotto).trim().toLowerCase();if(!(l=>!!(String(l.prodotto??"").toLowerCase().split(",").map(w=>w.trim()).filter(Boolean).includes(r)||r==="promethea"&&l.hasConfigPromethea||r==="yuvi"&&l.hasTrattativaYuvi))(i))return!1}return!0});console.log("\u{1F50D} Dopo filtri:",{filtrati:a.length,eliminati:e.length-a.length});let n=i=>{let r=i.ultimoEsito?.ts?new Date(i.ultimoEsito.ts).getTime():0,s=i.created_at?new Date(i.created_at).getTime():0;return r||s};a.sort((i,r)=>{let s=n(i),l=n(r);return t.sortDir==="desc"?l-s:s-l}),console.log("\u{1F4CA} Filtri finali applicati:",a.length),this.aggiornaStato({filteredRows:a})}eliminaSoggetto(o){return c(this,null,function*(){try{let t=yield this.soggettiService.deleteSoggetto(o);if(!t.success)throw new Error(t.error);return this.aggiornaStato({rows:this.stato().rows.filter(e=>e.id!==o)}),this.applicaFiltri(),!0}catch(t){return this.aggiornaStato({error:t.message||"Errore durante l'eliminazione"}),!1}})}aggiornaProdotto(o,t){return c(this,null,function*(){try{return yield this.soggettiService.updateProdotto(o,t)}catch(e){return console.error("Errore aggiornamento prodotto:",e),{error:e}}})}getModuliAttivi(o){if(!o)return[];let t=o.dettagli??o;if(!t||typeof t!="object")return[];let e={immagine_marketing:"immagine",digitalizzazione_automatismi:"digital",contabilita_fiscalita:"accounting",ottimizzazione_management:"optimization"},a=[];return Object.entries(e).forEach(([n,i])=>{let r=t[n];if(!r)return;let s=r.totale??r.totale_modulo??0,l=Array.isArray(r.servizi_selezionati)?r.servizi_selezionati:Array.isArray(r.servizi)?r.servizi:[];(s&&s>0||l.length>0)&&a.push(i)}),a}arricchisciDati(o){return c(this,null,function*(){let t=o.map(i=>i.id).filter(i=>!!i);if(t.length===0)return[];let e=[];if(this.config.abilitaConfigurazioni?e.push(this.soggettiService.getConfigurazioniPrometheaByCliente(t)):e.push(Promise.resolve(new Map)),this.config.abilitaTrattative){let i=this.config.tipo==="prospect"?this.soggettiService.getTrattativeYuviByProspect(t):this.soggettiService.getTrattativeYuviByCliente(t);e.push(i)}else e.push(Promise.resolve(new Map));let[a,n]=yield Promise.all(e);return o.map(i=>{let r=a.get(i.id),s=this.getModuliAttivi(r);return{id:i.id,tipo:i.tipo??this.config.tipo,ragione_sociale:i.ragione_sociale||"Senza nome",referente:i.referente,telefono:i.telefono,email:i.email,provincia:i.provincia,comune:i.comune,prodotto:typeof i.prodotto=="string"?i.prodotto.trim():"",esiti:i.esiti,ultimoEsito:this.getUltimoEsito(i.esiti),configurato:!!r,hasConfigPromethea:!!r,hasTrattativaYuvi:n.get(i.id)||!1,moduliAttivi:s,created_at:i.created_at,iban:i.iban}})})}getUltimoEsito(o){return!Array.isArray(o)||o.length===0?null:o.reduce((t,e)=>{let a=new Date(e.ts).getTime(),n=new Date(t.ts).getTime();return a>n?e:t})}aggiornaStato(o){this.stato.update(t=>u(u({},t),o))}reset(){this.stato.set({rows:[],filteredRows:[],loading:!1,error:null,hasMore:!0,page:0,allLoaded:!1}),this.filtri.set({provincia:"tutte",searchTerm:"",esito:"tutti",sortDir:"desc",prodotto:"tutti"})}static \u0275fac=function(t){return new(t||f)};static \u0275prov=p({token:f,factory:f.\u0275fac,providedIn:"root"})};export{S as a};
