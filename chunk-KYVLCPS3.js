import{b as v}from"./chunk-4ZO3JJK7.js";import{a as m}from"./chunk-6TYR3BRN.js";import{N as h,S as d,ea as p,hc as g}from"./chunk-S7YZFXYO.js";import{a as l,i as u}from"./chunk-ODN5LVDJ.js";var y=class f{soggettiService=d(v);authService=d(m);stato=p({rows:[],filteredRows:[],loading:!1,error:null,hasMore:!0,page:0,allLoaded:!1});allLoaded=g(()=>this.stato().allLoaded);filtri=p({provincia:"tutte",searchTerm:"",esito:"tutti",sortDir:"desc"});config;rows=g(()=>this.stato().rows);filteredRows=g(()=>this.stato().filteredRows);loading=g(()=>this.stato().loading);error=g(()=>this.stato().error);hasMore=g(()=>this.stato().hasMore);currentFiltri=g(()=>{let o=this.filtri();return l({provincia:o.provincia??"tutte",searchTerm:o.searchTerm??"",esito:o.esito??"tutti",sortDir:o.sortDir??"desc",configurato:o.configurato??null,conIban:!!o.conIban,conReferente:!!o.conReferente,prodotto:o.prodotto??"tutti",categoria_ateco:o.categoria_ateco??"tutte"},o)});inizializza(o){this.config=l({pageSize:20,abilitaConfigurazioni:!0,abilitaTrattative:!0},o),this.reset()}caricaIniziali(){return u(this,null,function*(){if(!this.stato().loading){this.aggiornaStato({loading:!0,error:null});try{let o=this.config.pageSize??20,[{data:i,error:r},{data:n,error:s}]=yield Promise.all([this.soggettiService.countByTipo(this.config.tipo),this.soggettiService.getSoggettiByTipo(this.config.tipo,0,Math.max(o-1,0))]);if(r)throw r;if(s)throw s;let t=i??0,e=n??[],a=yield this.arricchisciDati(e);this.aggiornaStato({rows:a,hasMore:t>o,page:t>0?1:0,allLoaded:t<=o}),this.applicaFiltri()}catch(o){this.aggiornaStato({error:o?.message||"Errore durante il caricamento"})}finally{this.aggiornaStato({loading:!1})}}})}caricaTutti(){return u(this,null,function*(){if(!this.stato().loading){this.aggiornaStato({loading:!0,error:null});try{let{data:o,error:i}=yield this.soggettiService.countByTipo(this.config.tipo);if(i)throw i;let r=o??0;if(r===0){this.aggiornaStato({rows:[],filteredRows:[],hasMore:!1,page:0,allLoaded:!0});return}let n=Math.max(r-1,0),{data:s,error:t}=yield this.soggettiService.getSoggettiByTipo(this.config.tipo,0,n);if(t)throw t;let e=s??[],a=yield this.arricchisciDati(e);this.aggiornaStato({rows:a,hasMore:!1,page:1,allLoaded:!0}),this.applicaFiltri()}catch(o){this.aggiornaStato({error:o?.message||"Errore durante il caricamento"})}finally{this.aggiornaStato({loading:!1})}}})}cerca(o){return u(this,null,function*(){this.aggiornaStato({loading:!0,error:null});try{if(!o.trim()){this.stato().allLoaded?this.applicaFiltri():yield this.caricaIniziali();return}let i=yield this.soggettiService.searchSoggetti(o,this.config.tipo);if(i.error)throw i.error;let r=i.data??[],n=yield this.arricchisciDati(r);this.aggiornaStato({rows:n,hasMore:!1,page:0}),this.applicaFiltri()}catch(i){this.aggiornaStato({error:i?.message||"Errore durante la ricerca"})}finally{this.aggiornaStato({loading:!1})}})}applicaFiltri(o){if(o&&Object.keys(o).length>0){let t=a=>a==="tutte"||a==="tutti"||a===""?null:a,e=l({},o||{});if("provincia"in e&&(e.provincia=t(e.provincia)),"esito"in e&&(e.esito=t(e.esito)),"prodotto"in e&&(e.prodotto=t(e.prodotto)),"categoria_ateco"in e&&(e.categoria_ateco=t(e.categoria_ateco)),"configurato"in e&&typeof e.configurato=="string"){let a=String(e.configurato).toLowerCase();e.configurato=a==="true"?!0:a==="false"?!1:null}this.filtri.update(a=>l(l({},a),e))}let i=this.filtri(),r=this.stato().rows;console.debug("\u{1F39B}\uFE0F Applicazione filtri:",{filtri:i,totaleRows:r.length});let n=r.filter(t=>{if(i.provincia&&i.provincia!=="tutte"&&i.provincia!=="tutti"&&t.provincia!==i.provincia)return!1;if(i.esito&&i.esito!=="tutti"){if(i.esito==="senza-esito"){if(t.ultimoEsito)return!1}else if(t.ultimoEsito?.tipo!==i.esito)return!1}if(i.configurato!==void 0&&i.configurato!==null){let e=i.configurato,a=e===!0||typeof e=="string"&&e.toLowerCase()==="true",c=i.configuredIds;if(Array.isArray(c)&&c.length>0){if(!c.includes(t.id))return!1}else if(!!t.configurato!=!!a)return!1}if(i.categoria_ateco){let e=String(i.categoria_ateco).trim().toLowerCase(),a=String(t.categoria_ateco??t.categoria??"").trim().toLowerCase();if(!a||a!==e)return!1}if((this.config.tipo==="cliente"||this.config.tipo==="fornitore")&&(i.conIban&&!t.iban||i.conReferente&&!t.referente)||this.config.tipo==="prospect"&&i.configurato!==null&&i.configurato!==void 0&&t.configurato!==i.configurato)return!1;if(i.prodotto&&i.prodotto!=="tutti"){let e=String(i.prodotto).trim().toLowerCase();if(!(String(t.prodotto??"").toLowerCase().split(",").map(S=>S.trim()).filter(Boolean).includes(e)||e==="promethea"&&!!t.hasConfigPromethea||e==="yuvi"&&!!t.hasTrattativaYuvi))return!1}return!0}),s=t=>{let e=t.ultimoEsito?.ts?new Date(t.ultimoEsito.ts).getTime():0,a=t.created_at?new Date(t.created_at).getTime():0;return e||a};n.sort((t,e)=>{let a=s(t),c=s(e);return i.sortDir==="desc"?c-a:a-c}),console.debug("\u{1F50D} Filtri applicati, risultati:",n.length),this.aggiornaStato({filteredRows:n})}eliminaSoggetto(o){return u(this,null,function*(){try{let i=yield this.soggettiService.deleteSoggetto(o);if(!i.success)throw new Error(i.error);return this.aggiornaStato({rows:this.stato().rows.filter(r=>r.id!==o)}),this.applicaFiltri(),!0}catch(i){return this.aggiornaStato({error:i.message||"Errore durante l'eliminazione"}),!1}})}aggiornaProdotto(o,i){return u(this,null,function*(){try{return yield this.soggettiService.updateProdotto(o,i)}catch(r){return console.error("Errore aggiornamento prodotto:",r),{error:r}}})}getModuliAttivi(o){if(!o)return[];let i=o.dettagli??o;if(!i||typeof i!="object")return[];let r={immagine_marketing:"immagine",digitalizzazione_automatismi:"digital",contabilita_fiscalita:"accounting",ottimizzazione_management:"optimization"},n=[];return Object.entries(r).forEach(([s,t])=>{let e=i[s];if(!e)return;let a=e.totale??e.totale_modulo??0,c=Array.isArray(e.servizi_selezionati)?e.servizi_selezionati:Array.isArray(e.servizi)?e.servizi:[];(a&&a>0||c.length>0)&&n.push(t)}),n}arricchisciDati(o){return u(this,null,function*(){let i=o.map(t=>t.id).filter(t=>!!t);if(i.length===0)return[];let r=[];if(this.config.abilitaConfigurazioni?r.push(this.soggettiService.getConfigurazioniPrometheaByCliente(i)):r.push(Promise.resolve(new Map)),this.config.abilitaTrattative){let t=this.config.tipo==="prospect"?this.soggettiService.getTrattativeYuviByProspect(i):this.soggettiService.getTrattativeYuviByCliente(i);r.push(t)}else r.push(Promise.resolve(new Map));let[n,s]=yield Promise.all(r);return o.map(t=>{let e=n.get(t.id),a=this.getModuliAttivi(e);return{id:t.id,tipo:t.tipo??this.config.tipo,ragione_sociale:t.ragione_sociale||"Senza nome",referente:t.referente,telefono:t.telefono,email:t.email,provincia:t.provincia,comune:t.comune,prodotto:typeof t.prodotto=="string"?t.prodotto.trim():"",esiti:t.esiti,ultimoEsito:this.getUltimoEsito(t.esiti),configurato:!!e,hasConfigPromethea:!!e,hasTrattativaYuvi:s.get(t.id)||!1,moduliAttivi:a,created_at:t.created_at,iban:t.iban,categoria_ateco:t.categoria_ateco??t.categoriaAteco??t.categoria??null,created_by:t.created_by??t.createdBy??null,created_by_user:t.created_by_user??t.createdByUser??null}})})}getUltimoEsito(o){return!Array.isArray(o)||o.length===0?null:o.reduce((i,r)=>{let n=new Date(r.ts).getTime(),s=new Date(i.ts).getTime();return n>s?r:i})}aggiornaStato(o){this.stato.update(i=>l(l({},i),o))}reset(){this.stato.set({rows:[],filteredRows:[],loading:!1,error:null,hasMore:!0,page:0,allLoaded:!1}),this.filtri.set({provincia:"tutte",searchTerm:"",esito:"tutti",sortDir:"desc",prodotto:"tutti"})}static \u0275fac=function(i){return new(i||f)};static \u0275prov=h({token:f,factory:f.\u0275fac,providedIn:"root"})};export{y as a};
