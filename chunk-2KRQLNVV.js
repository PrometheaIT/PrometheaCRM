import{a as mt}from"./chunk-HQJW367C.js";import{a as gt}from"./chunk-VHHLB7VF.js";import{c as ut}from"./chunk-CZQHU2W7.js";import{a as pt}from"./chunk-64LBLDON.js";import{b as ot,d as rt,f as at,o as st,p as lt,u as ct}from"./chunk-Z6GIDEG7.js";import{b as dt}from"./chunk-H4JMM7IJ.js";import{a as nt}from"./chunk-XDKKMB7K.js";import{b as et,c as it}from"./chunk-WPZ527DH.js";import{c as G,d as J,e as Q,j as X,o as Z,p as tt}from"./chunk-PJ4DYJTI.js";import{A as z,Bb as M,Ga as R,I as F,La as f,S,Va as Y,Wa as p,X as u,Xa as n,Y as g,Ya as r,Za as b,bb as N,cb as U,db as x,ea as w,f as L,gb as _,hb as m,ib as E,kb as I,mb as s,nb as P,ob as y,qb as K,rb as B,sa as A,sb as j,tb as H,ua as l,vb as W,wb as q,x as D,za as $}from"./chunk-R5VHGKSY.js";import"./chunk-X5YLR3NI.js";import{a as T,b as V,i as v}from"./chunk-ODN5LVDJ.js";var ft=()=>["/soggetti/nuovo","prospect"],ht=(a,t)=>({"product-promethea":a,"product-yuvi":t});function vt(a,t){if(a&1&&(n(0,"span"),s(1),r()),a&2){let e=m();l(),P(e.totalProspectCount())}}function Pt(a,t){if(a&1&&(n(0,"span"),s(1),r()),a&2){let e=m();l(),P(e.kpi().senzaContatto)}}function xt(a,t){if(a&1&&(n(0,"span"),s(1),r()),a&2){let e=m();l(),P(e.kpi().daRichiamare)}}function Ct(a,t){if(a&1&&(n(0,"span"),s(1),r()),a&2){let e=m();l(),P(e.configuredCount())}}function bt(a,t){a&1&&b(0,"span",49)}function St(a,t){if(a&1&&(n(0,"option",50),s(1),r()),a&2){let e=t.$implicit;p("value",e),l(),P(e)}}function yt(a,t){if(a&1&&(n(0,"option",50),s(1),r()),a&2){let e=t.$implicit;p("value",e),l(),P(e)}}function wt(a,t){if(a&1&&(n(0,"option",50),s(1),r()),a&2){let e=t.$implicit;p("value",e),l(),P(e)}}function Et(a,t){if(a&1&&(n(0,"span"),s(1),r()),a&2){let e=m().$implicit;l(),P(e.comune)}}function It(a,t){if(a&1&&(n(0,"span"),s(1),r()),a&2){let e=m().$implicit;l(),y(" (",e.provincia,")")}}function kt(a,t){a&1&&(n(0,"span",74),s(1," Nessun indirizzo "),r())}function Tt(a,t){a&1&&(n(0,"span",75),s(1,"S\xEC"),r())}function Lt(a,t){a&1&&(n(0,"span",76),s(1,"No"),r())}function Mt(a,t){if(a&1&&(n(0,"div",80),s(1),r()),a&2){let e=m().ngIf,i=m(2);l(),y(" ",i.formatEsitoDate(e)," ")}}function Ot(a,t){if(a&1&&(N(0),n(1,"div",77)(2,"div",78),s(3),r(),f(4,Mt,2,1,"div",79),r(),U()),a&2){let e=t.ngIf;l(3),P(e.tipo),l(),p("ngIf",e.tipo==="Richiamare"||e.tipo==="Appuntamento")}}function Vt(a,t){a&1&&s(0,"\u2014")}function Dt(a,t){if(a&1){let e=x();n(0,"button",85),_("click",function(){u(e);let o=m().$implicit,c=m(2).$implicit,d=m();return g(d.removeSelectedProduct(c,o))}),s(1," \xD7 "),r()}if(a&2){let e=m().$implicit;p("title",H("Rimuovi ",e))}}function zt(a,t){if(a&1&&(n(0,"span",83),s(1),f(2,Dt,2,2,"button",84),r()),a&2){let e=t.$implicit,i=m(2).$implicit,o=m();p("ngClass",q(3,ht,e==="Promethea",e==="YUVI")),l(),y(" ",e," "),l(),p("ngIf",!o.isProdottoAutomatico(e,i))}}function Ft(a,t){if(a&1&&(n(0,"div",81),f(1,zt,3,6,"span",82),r()),a&2){let e=m().$implicit,i=m();l(),p("ngForOf",i.getSelectedProducts(e))}}function At(a,t){if(a&1&&(n(0,"option",50),s(1),r()),a&2){let e=t.$implicit;p("value",e.nome),l(),y(" ",e.nome," ")}}function $t(a,t){a&1&&(n(0,"div",91),b(1,"span",92),r())}function Rt(a,t){if(a&1){let e=x();n(0,"div",86)(1,"select",87,6),_("change",function(o){u(e);let c=m().$implicit,d=m();return g(d.onProductSelectChange(c,o))}),f(3,At,2,2,"option",31),r(),n(4,"div",88)(5,"button",89),_("click",function(){u(e);let o=m(2);return g(o.closeProductPicker())}),s(6,"Chiudi"),r(),f(7,$t,2,0,"div",90),r()()}if(a&2){let e=m().$implicit,i=m();l(),p("value",i.getSelectedProducts(e))("disabled",i.updatingProdottoIds.has(e.id)),l(2),p("ngForOf",i.getManualProducts()),l(4),p("ngIf",i.updatingProdottoIds.has(e.id))}}function Yt(a,t){if(a&1){let e=x();n(0,"button",93),_("click",function(o){u(e);let c=m().$implicit,d=m();return o.stopPropagation(),g(d.vediConfigurazionePromethea(c))}),b(1,"img",94),r()}}function Nt(a,t){if(a&1){let e=x();n(0,"button",95),_("click",function(o){u(e);let c=m().$implicit,d=m();return o.stopPropagation(),g(d.vediTrattativaYuvi(c))}),b(1,"img",96),r()}}function Ut(a,t){if(a&1){let e=x();n(0,"button",102),_("click",function(o){u(e);let c=m(2).$implicit,d=m();return o.stopPropagation(),d.vediConfigurazionePromethea(c),g(d.closeAllDropdowns())}),b(1,"img",103),n(2,"span"),s(3,"Configura Promethea"),r()()}}function Kt(a,t){if(a&1){let e=x();n(0,"button",102),_("click",function(o){u(e);let c=m(2).$implicit,d=m();return o.stopPropagation(),d.vediTrattativaYuvi(c),g(d.closeAllDropdowns())}),b(1,"img",104),n(2,"span"),s(3,"Trattativa YUVI"),r()()}}function Bt(a,t){if(a&1){let e=x();n(0,"div",97)(1,"div",98),f(2,Ut,4,0,"button",99)(3,Kt,4,0,"button",99),n(4,"button",100),_("click",function(o){u(e);let c=m().$implicit,d=m();return o.stopPropagation(),d.onEdit(c),g(d.closeAllDropdowns())}),n(5,"span",16),s(6,"edit"),r(),n(7,"span"),s(8,"Modifica"),r()(),n(9,"button",100),_("click",function(o){u(e);let c=m().$implicit,d=m();return o.stopPropagation(),d.openEsito(c),g(d.closeAllDropdowns())}),n(10,"span",16),s(11,"add"),r(),n(12,"span"),s(13,"Aggiungi esito"),r()(),n(14,"button",100),_("click",function(o){u(e);let c=m().$implicit,d=m();return o.stopPropagation(),g(d.openProductPicker(c))}),n(15,"span",16),s(16,"inventory_2"),r(),n(17,"span"),s(18,"Aggiungi Prodotto"),r()(),n(19,"button",101),_("click",function(o){u(e);let c=m().$implicit,d=m();return o.stopPropagation(),d.onDelete(c),g(d.closeAllDropdowns())}),n(20,"span",16),s(21,"delete"),r(),n(22,"span"),s(23,"Elimina"),r()()()()}if(a&2){let e=m().$implicit,i=m();l(2),p("ngIf",e.hasConfigPromethea),l(),p("ngIf",e.hasTrattativaYuvi),l(16),p("disabled",i.deletingIds.has(e.id))}}function jt(a,t){if(a&1){let e=x();n(0,"div",105),_("click",function(){u(e);let o=m(2);return g(o.closeAllDropdowns())}),r()}}function Ht(a,t){if(a&1){let e=x();n(0,"tr",51)(1,"td",52)(2,"div",53)(3,"strong",54),_("click",function(){let o=u(e).$implicit,c=m();return g(c.apriScheda(o))}),s(4),r()()(),n(5,"td",55)(6,"div",53),s(7),r()(),n(8,"td",56)(9,"div",53),s(10),r()(),n(11,"td",57)(12,"div",53),f(13,Et,2,1,"span",45)(14,It,2,1,"span",45)(15,kt,2,0,"span",58),r()(),n(16,"td",59)(17,"div",53),f(18,Tt,2,0,"span",60)(19,Lt,2,0,"span",61),r()(),n(20,"td",62)(21,"div",53),f(22,Ot,5,2,"ng-container",21)(23,Vt,1,0,"ng-template",null,5,M),r()(),n(25,"td",63)(26,"div",53),f(27,Ft,2,1,"div",64)(28,Rt,8,4,"div",65),r()(),n(29,"td",66)(30,"div",67),f(31,Yt,2,0,"button",68)(32,Nt,2,0,"button",69),n(33,"div",70)(34,"button",71),_("click",function(o){let c=u(e).$implicit,d=m();return o.stopPropagation(),g(d.toggleActionsDropdown(c.id,o))}),n(35,"span",16),s(36,"more_vert"),r()(),f(37,Bt,24,3,"div",72)(38,jt,1,0,"div",73),r()()()()}if(a&2){let e=t.$implicit,i=E(24),o=m();Y("data-row-id",e.id),l(4),P(e.ragione_sociale),l(3),P(e.referente||"\u2014"),l(3),P(e.telefono||"\u2014"),l(3),p("ngIf",e.comune),l(),p("ngIf",e.provincia),l(),p("ngIf",!e.comune&&!e.provincia),l(3),p("ngIf",e.configurato),l(),p("ngIf",!e.configurato),l(3),p("ngIf",e.ultimoEsito)("ngIfElse",i),l(5),p("ngIf",o.getSelectedProducts(e).length>0),l(),p("ngIf",o.isProductPickerOpen(e)),l(3),p("ngIf",e.hasConfigPromethea),l(),p("ngIf",e.hasTrattativaYuvi),l(),I("open",o.activeDropdownId===e.id),l(4),p("ngIf",o.activeDropdownId===e.id),l(),p("ngIf",o.activeDropdownId===e.id)}}function Wt(a,t){if(a&1&&(n(0,"tr")(1,"td",106),s(2),r()()),a&2){let e=m();l(2),y(" ",e.searchTerm?"Nessun prospect trovato":"Nessun prospect"," ")}}function qt(a,t){a&1&&(n(0,"span",16),s(1,"unfold_more"),r())}function Gt(a,t){a&1&&(n(0,"span",16),s(1,"hourglass_bottom"),r())}function Jt(a,t){if(a&1){let e=x();n(0,"div",107)(1,"button",108),_("click",function(){u(e);let o=m();return g(o.caricaTutti())}),f(2,qt,2,0,"span",109)(3,Gt,2,0,"span",109),s(4),r()()}if(a&2){let e=m();l(),p("disabled",e.loading()),l(),p("ngIf",!e.loading()),l(),p("ngIf",e.loading()),l(),y(" ",e.loading()?"Caricamento\u2026":"Carica tutti"," ")}}function Qt(a,t){if(a&1&&(n(0,"div",110),s(1),r()),a&2){let e=m();l(),y(" ",e.error()," ")}}var _t=class a{listaService=S(mt);soggettiService=S(dt);authService=S(it);userService=S(nt);router=S(Z);renderer=S($);supa=S(et);searchSubject=new L;destroy$=new L;rows=this.listaService.rows;filteredRows=this.listaService.filteredRows;loading=this.listaService.loading;error=this.listaService.error;hasMore=this.listaService.hasMore;currentFiltri=this.listaService.currentFiltri;prodottiList=[];prodotti=w([]);updatingProdottoIds=new Set;productPickerOpenId=null;configuredCountValue=-1;province=w([]);kpiLoading=w(!1);kpi=w({senzaContatto:0,daRichiamare:0,configurati:0});totalProspectCount=w(0);deletingIds=new Set;showEsito=!1;selectedId=null;activeDropdownId=null;clickListener;esitiTipi=ut;searchTerm="";filtroConfigurato=null;isLoading=w(!0);constructor(){this.searchSubject.pipe(F(this.destroy$),D(300),z()).subscribe(t=>{this.onSearchExecuted(t)})}ngOnInit(){return v(this,null,function*(){console.log("\u{1F680} Lista Prospect - START"),this.isLoading.set(!0);try{if(yield this.authService.getAuthState(),!this.authService.user()){console.error("\u274C Nessun utente autenticato!"),this.isLoading.set(!1);return}yield this.loadProdotti(),this.listaService.inizializza({tipo:"prospect",abilitaConfigurazioni:!0,abilitaTrattative:!0}),console.log("\u2699\uFE0F Servizio inizializzato"),yield Promise.all([this.listaService.caricaIniziali(),this.loadProvince(),this.loadTotalKPI()]),yield this.loadConfiguredCount(),console.log("\u2705 Init completato")}catch(t){console.error("\u274C Errore durante init:",t),this.refreshLocalKPI()}finally{setTimeout(()=>{this.isLoading.set(!1)},300)}})}refreshData(){return v(this,null,function*(){try{yield this.listaService.caricaTutti(),yield this.loadTotalKPI()}catch(t){console.error("\u274C Errore refresh data:",t),this.refreshLocalKPI()}})}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete(),this.closeAllDropdowns()}loadMore(t=!1){return v(this,null,function*(){yield this.listaService.caricaTutti()})}loadProdotti(){return v(this,null,function*(){try{let t=yield this.supa.getProdotti();if(t.error)throw t.error;let e=(t.data??[]).map(i=>V(T({},i),{nome:String(i.nome??"").trim()})).filter(i=>!!i.attivo);this.prodotti.set(e)}catch(t){console.error("Errore loadProdotti lista-prospect:",t),this.prodotti.set([{nome:"Promethea",attivo:!0},{nome:"YUVI",attivo:!0}])}})}allLoaded(){return this.listaService.allLoaded()}caricaTutti(){return v(this,null,function*(){yield this.listaService.caricaTutti()})}onSearchExecuted(t){return v(this,null,function*(){yield this.listaService.cerca(t)})}onSearchChange(t){this.searchTerm=t,this.searchSubject.next(t)}onChangeFiltroEsito(t){this.listaService.applicaFiltri({esito:t,configurato:null}),this.filtroConfigurato=null}onChangeFiltroProvincia(t){this.listaService.applicaFiltri({provincia:t})}onChangeSortDir(t){this.listaService.applicaFiltri({sortDir:t})}onFiltroTotale(){this.listaService.applicaFiltri({esito:"tutti",provincia:"tutte",configurato:null}),this.filtroConfigurato=null}onFiltroSenzaContatto(){this.listaService.applicaFiltri({esito:"senza-esito",configurato:null}),this.filtroConfigurato=null}onFiltroDaRichiamare(){this.listaService.applicaFiltri({esito:"Richiamare",configurato:null}),this.filtroConfigurato=null}onFiltroConfigurati(){this.listaService.applicaFiltri({esito:"tutti",configurato:!0}),this.filtroConfigurato=!0}vediConfigurazionePromethea(t){this.router.navigate(["/alchemizzatore"],{queryParams:{prospectId:t.id,step:6}})}vediTrattativaYuvi(t){return v(this,null,function*(){try{let{data:e,error:i}=yield this.soggettiService.supabaseService.supabase.from("trattative_yuvi").select("*").eq("prospect_id",t.id).order("created_at",{ascending:!1}).limit(1).single();if(i)throw i;if(!e){alert("Nessuna trattativa YUVI trovata per questo prospect");return}this.router.navigate(["/yuvi-trattativa"],{queryParams:{prospectId:t.id,trattativaId:e.id,step:7},state:{prospect:t,trattativaEsistente:e,from:"lista-prospect"}})}catch(e){alert("Errore nel caricamento della trattativa: "+e.message)}})}onDelete(t){return v(this,null,function*(){if(!(!t?.id||!confirm(`Eliminare il prospect "${t.ragione_sociale}"?`))){this.deletingIds.add(t.id);try{(yield this.listaService.eliminaSoggetto(t.id))&&(yield this.loadTotalKPI())}catch(i){console.error("Errore durante l'eliminazione:",i)}finally{this.deletingIds.delete(t.id)}}})}onEdit(t){t?.id&&this.router.navigate(["/soggetti/modifica",t.id])}openEsito(t){this.selectedId=t.id,this.showEsito=!0}onPopupClosed(t){return v(this,null,function*(){this.showEsito=!1,this.selectedId=null,t.saved&&(yield Promise.all([this.listaService.caricaTutti(),this.loadTotalKPI()]))})}onProductSelectChange(t,e){let i=e.target,o=Array.from(i.selectedOptions).map(c=>c.value);this.onChangeProdotto(t,o)}invalidateProdottoCache(t){t._prodottiCache&&delete t._prodottiCache}onChangeProdotto(t,e){return v(this,null,function*(){if(!t?.id||this.updatingProdottoIds.has(t.id))return;let i=this.prodotti().map(h=>h.nome),o=e.filter(h=>i.includes(h)),c=[];t.hasConfigPromethea&&c.push("Promethea"),t.hasTrattativaYuvi&&c.push("YUVI");let C=[...new Set([...c,...o])].join(", ");if((t.prodotto||"").toString().trim()!==C){this.updatingProdottoIds.add(t.id);try{let h=yield this.listaService.aggiornaProdotto(t.id,C);h&&!h.error?(t.prodotto=C,this.invalidateProdottoCache(t),yield this.listaService.caricaIniziali(),this.closeProductPicker()):console.error("Errore aggiornamento prodotto:",h?.error)}catch(h){console.error("Errore durante aggiornamento prodotto:",h)}finally{this.updatingProdottoIds.delete(t.id)}}})}getProdottiAutomatici(t){let e=[];return t.hasConfigPromethea&&e.push("Promethea"),t.hasTrattativaYuvi&&e.push("YUVI"),e.length?e.join(", "):(t.prodotto??"").toString()}trackById=(t,e)=>`${e.id}-${e.prodotto}-${e.hasConfigPromethea}-${e.hasTrattativaYuvi}`;toggleActionsDropdown(t,e){e&&e.stopPropagation();let i=this.activeDropdownId===t;this.activeDropdownId=i?null:t,this.activeDropdownId?(this.clickListener=this.renderer.listen("document","click",o=>{o.target.closest(".actions-dropdown")||this.closeAllDropdowns()}),document.body.classList.add("dropdown-open")):this.closeAllDropdowns()}closeAllDropdowns(){this.activeDropdownId=null,document.body.classList.remove("dropdown-open"),this.clickListener&&(this.clickListener(),this.clickListener=void 0)}onWindowScroll(){this.activeDropdownId&&this.closeAllDropdowns()}loadProvince(){return v(this,null,function*(){let{data:t}=yield this.soggettiService.getProvinceByTipo("prospect");t&&this.province.set(t)})}loadTotalKPI(){return v(this,null,function*(){this.kpiLoading.set(!0);try{let e=(yield this.soggettiService.countByTipo("prospect")).data||0;if(this.totalProspectCount.set(e),e===0){this.kpi.set({senzaContatto:0,daRichiamare:0,configurati:0});return}let{data:i,error:o}=yield this.soggettiService.getSoggettiByTipo("prospect",0,Math.max(e,1e3));if(o)throw console.warn("\u26A0\uFE0F Errore caricamento prospect per KPI:",o),o;if(!i||i.length===0){this.kpi.set({senzaContatto:0,daRichiamare:0,configurati:0});return}if(i.map(h=>h.id).filter(h=>!!h).length===0){this.kpi.set({senzaContatto:0,daRichiamare:0,configurati:0});return}yield this.loadConfiguredCount();let d=0,C=0;i.forEach(h=>{let O=this.getLastEsito(h.esiti);O||d++,O?.tipo==="Richiamare"&&C++});let k=this.configuredCountValue>=0?this.configuredCountValue:0;this.kpi.set({senzaContatto:d,daRichiamare:C,configurati:k}),console.log("\u2705 KPI calcolati:",{total:e,senzaContatto:d,daRichiamare:C,configurati:k,prospectProcessati:i.length})}catch(t){console.error("\u274C Errore nel caricamento KPI totali:",t),this.refreshLocalKPI()}finally{this.kpiLoading.set(!1)}})}loadConfiguredCount(){return v(this,null,function*(){try{let t=new Set,{data:e,error:i}=yield this.supa.supabase.from("configurazioni_promethea").select("prospect_id");!i&&Array.isArray(e)&&e.forEach(d=>{d?.prospect_id&&t.add(String(d.prospect_id))});let{data:o,error:c}=yield this.supa.supabase.from("trattative_yuvi").select("prospect_id");!c&&Array.isArray(o)&&o.forEach(d=>{d?.prospect_id&&t.add(String(d.prospect_id))}),this.configuredCountValue=t.size}catch(t){console.error("Errore conteggio configurati:",t),this.configuredCountValue=0}})}refreshLocalKPI(){console.log("\u{1F504} Usando KPI locali come fallback...");let t=this.rows();if(t.length===0){let i=this.kpi();i.senzaContatto===0&&i.daRichiamare===0&&i.configurati===0&&(this.totalProspectCount.set(0),this.kpi.set({senzaContatto:0,daRichiamare:0,configurati:0}));return}let e={senzaContatto:t.filter(i=>!i.ultimoEsito).length,daRichiamare:t.filter(i=>i.ultimoEsito?.tipo==="Richiamare").length,configurati:t.filter(i=>i.hasConfigPromethea||i.hasTrattativaYuvi).length};this.totalProspectCount.set(t.length),this.kpi.set(e),this.configuredCountValue=e.configurati,console.log("\u{1F4CA} KPI locali:",T({totalLocal:t.length},e))}getLastEsito(t){return!Array.isArray(t)||t.length===0?null:t.reduce((e,i)=>{let o=new Date(i.ts).getTime(),c=new Date(e.ts).getTime();return o>c?i:e})}formatEsitoDate(t){if(!t)return"";let e=t.tipo==="Appuntamento"||t.tipo==="Fissato appuntamento";if(t.tipo==="Richiamare"&&t.scheduleAt){let i=new Date(t.scheduleAt),o=i.getDate().toString().padStart(2,"0"),c=(i.getMonth()+1).toString().padStart(2,"0"),d=i.getFullYear(),C=i.getHours().toString().padStart(2,"0"),k=i.getMinutes().toString().padStart(2,"0");return`${o}/${c}/${d} alle ${C}:${k}`}if(e&&t.dataAppuntamento){let i=t.oraAppuntamento?` alle ${t.oraAppuntamento}`:"";return`${this.formatDateString(t.dataAppuntamento)}${i}`}return""}pad(t){return t.toString().padStart(2,"0")}formatDateString(t){if(!t&&t!==0)return"";if(t instanceof Date)return`${this.pad(t.getDate())}/${this.pad(t.getMonth()+1)}/${t.getFullYear()}`;let e=String(t).trim(),i=e.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(i)return`${i[3]}/${i[2]}/${i[1]}`;let o=Date.parse(e);if(!isNaN(o)){let c=new Date(o);return`${this.pad(c.getDate())}/${this.pad(c.getMonth()+1)}/${c.getFullYear()}`}return e}apriScheda(t){t?.id&&this.router.navigate(["/soggetti",t.tipo??"cliente",t.id])}getSelectedProducts(t){if(t._prodottiCache)return t._prodottiCache;let e=[];if(t.prodotto){let i=t.prodotto.split(",").map(o=>o.trim()).filter(o=>{let c=o.toLowerCase();return o&&c!=="promethea"&&c!=="yuvi"});e.push(...i)}return t.hasConfigPromethea&&!e.includes("Promethea")&&e.push("Promethea"),t.hasTrattativaYuvi&&!e.includes("YUVI")&&e.push("YUVI"),t._prodottiCache=e,e}isProdottoAutomatico(t,e){let i=(t??"").toString().trim().toLowerCase();return i==="promethea"?!!e.hasConfigPromethea:i==="yuvi"?!!e.hasTrattativaYuvi:!1}removeSelectedProduct(t,e){if(!t)return;let o=(Array.isArray(this.getSelectedProducts(t))?this.getSelectedProducts(t):[]).filter(c=>c!==e);this.onChangeProdotto(t,o)}openProductPicker(t,e){e&&e.stopPropagation(),this.productPickerOpenId=t?.id??null,this.closeAllDropdowns()}closeProductPicker(){this.productPickerOpenId=null}isProductPickerOpen(t){return!!t&&this.productPickerOpenId===t.id}getManualProducts(){let t=new Set(["promethea","yuvi"]);return this.prodotti().filter(e=>{let i=(e.nome??"").toString().trim().toLowerCase();return i&&!t.has(i)})}prodottiOptions(){let t=new Map;for(let e of this.prodotti()){let i=(e.nome??"").toString().trim();if(!i)continue;let o=i.toLowerCase();t.has(o)||t.set(o,i)}return t.set("promethea",t.get("promethea")??"Promethea"),t.set("yuvi",t.get("yuvi")??"YUVI"),Array.from(t.values())}onChangeFiltroProdotto(t){this.listaService.applicaFiltri({prodotto:t})}resetAllFilters(){return v(this,null,function*(){this.searchTerm="",this.filtroConfigurato=null,this.listaService.applicaFiltri({provincia:"tutte",searchTerm:"",esito:"tutti",sortDir:"desc",configurato:null,prodotto:"tutti",conIban:!1,conReferente:!1});try{yield this.listaService.caricaIniziali(),yield this.loadTotalKPI()}catch(t){console.error("Errore reset filtri:",t)}})}configuredCount(){return this.configuredCountValue>=0?this.configuredCountValue:this.kpi&&this.kpi().configurati?this.kpi().configurati:0}updateConfiguredCount(...t){let e=new Set,i=o=>{if(o){if(o instanceof Map){o.forEach((c,d)=>{d&&e.add(String(d))});return}if(Array.isArray(o)){for(let c of o){let d=c?.prospect_id??c?.soggetto_id??c?.id??null;d&&e.add(String(d))}return}typeof o=="object"&&Object.keys(o).forEach(c=>{c&&e.add(String(c))})}};for(let o of t)i(o);this.configuredCountValue=e.size}displayRows(){return this.filtroConfigurato===!0?this.rows().filter(t=>!!(t.hasConfigPromethea||t.hasTrattativaYuvi)):this.filteredRows()}static \u0275fac=function(e){return new(e||a)};static \u0275cmp=R({type:a,selectors:[["app-lista-prospect"]],hostBindings:function(e,i){e&1&&_("scroll",function(){return i.onWindowScroll()},A)},decls:120,vars:37,consts:[["loadingSpinner",""],["filtroSel",""],["ordinaSel",""],["provSel",""],["prodSel",""],["noEsito",""],["sel",""],["title","Caricamento Prospect","subtitle","Stiamo caricando i tuoi prospect...",3,"isLoading"],[1,"form-section"],[1,"section-header"],[1,"material-icons","header-icon"],[1,"section-titles"],[1,"section-title"],[1,"sottotitolo"],[1,"flex-1"],["title","Aggiungi prospect","aria-label","Aggiungi prospect",1,"icon-btn",3,"routerLink"],[1,"material-icons"],[1,"prospect-cards"],[1,"card",3,"click"],[1,"card-title"],[1,"card-number"],[4,"ngIf","ngIfElse"],[1,"table-section"],[1,"table-tools"],[1,"tool"],["for","search",1,"label"],["id","search","type","text","placeholder","Nome, telefono, email...",1,"table-inline-input",3,"ngModelChange","ngModel"],["for","filtroEsito",1,"label"],["id","filtroEsito",1,"table-inline-select",3,"change","value"],["value","tutti"],["value","senza-esito"],[3,"value",4,"ngFor","ngForOf"],["for","ordinaPer",1,"label"],["id","ordinaPer",1,"table-inline-select",3,"change","value"],["value","desc"],["value","asc"],["for","filtroProvincia",1,"label"],["id","filtroProvincia",1,"table-inline-select",3,"change","value"],["value","tutte"],["for","filtroProdotto",1,"label"],["id","filtroProdotto",1,"table-inline-select",3,"change","value"],["type","button",1,"promethea-button","ghost",3,"click"],[1,"table-container"],[1,"crm-table"],["class","row-clickable",4,"ngFor","ngForOf","ngForTrackBy"],[4,"ngIf"],["class","load-more-container",4,"ngIf"],["style","text-align:center; color:#ef4444; margin-top:1rem;",4,"ngIf"],[3,"closed","open","soggettoId","tipo"],[1,"loading-spinner"],[3,"value"],[1,"row-clickable"],["data-label","Ragione Sociale"],[1,"cell-content"],[1,"link",3,"click"],["data-label","Referente"],["data-label","Telefono"],["data-label","Localit\xE0"],["style","color: #6b7280; font-style: italic;",4,"ngIf"],["data-label","Configurato"],["class","badge badge-success",4,"ngIf"],["class","badge badge-danger",4,"ngIf"],["data-label","Ultimo Esito"],["data-label","Prodotto"],["class","selected-badges",4,"ngIf"],["class","product-picker",4,"ngIf"],["data-label","Azioni"],[1,"actions-container"],["class","action-btn document","title","Configurazione Promethea",3,"click",4,"ngIf"],["class","action-btn email","title","Trattativa YUVI",3,"click",4,"ngIf"],[1,"actions-dropdown"],["title","Altre azioni",1,"action-btn",3,"click"],["class","modal",4,"ngIf"],["class","mobile-dropdown-backdrop",3,"click",4,"ngIf"],[2,"color","#6b7280","font-style","italic"],[1,"badge","badge-success"],[1,"badge","badge-danger"],[1,"esito-container"],[1,"esito-tipo"],["class","esito-details text-muted",4,"ngIf"],[1,"esito-details","text-muted"],[1,"selected-badges"],["class","product-badge",3,"ngClass",4,"ngFor","ngForOf"],[1,"product-badge",3,"ngClass"],["class","badge-remove","type","button",3,"title","click",4,"ngIf"],["type","button",1,"badge-remove",3,"click","title"],[1,"product-picker"],["multiple","",1,"table-inline-select",3,"change","value","disabled"],[2,"margin-top","0.5rem","display","flex","gap","0.5rem","align-items","center"],[1,"promethea-button","outline",3,"click"],["class","loading-indicator","style","margin-left:0.5rem;",4,"ngIf"],[1,"loading-indicator",2,"margin-left","0.5rem"],[1,"loading-spinner",2,"width","20px","height","20px","border-width","2px"],["title","Configurazione Promethea",1,"action-btn","document",3,"click"],["src","assets/Logo.png","alt","Promethea",1,"icon-img"],["title","Trattativa YUVI",1,"action-btn","email",3,"click"],["src","assets/yuvi.png","alt","YUVI",1,"icon-img"],[1,"modal"],[1,"modal-body",2,"padding","0"],["class","dropdown-item mobile-only",3,"click",4,"ngIf"],[1,"dropdown-item",3,"click"],[1,"dropdown-item",3,"click","disabled"],[1,"dropdown-item","mobile-only",3,"click"],["src","assets/Logo.png","alt","Promethea",1,"icon-img",2,"width","16px","height","16px"],["src","assets/yuvi.png","alt","YUVI",1,"icon-img",2,"width","16px","height","16px"],[1,"mobile-dropdown-backdrop",3,"click"],["colspan","8",2,"text-align","center","padding","1.5rem"],[1,"load-more-container"],[1,"promethea-button",3,"click","disabled"],["class","material-icons",4,"ngIf"],[2,"text-align","center","color","#ef4444","margin-top","1rem"]],template:function(e,i){if(e&1){let o=x();b(0,"app-page-loader",7),n(1,"div")(2,"div",8)(3,"div",9)(4,"i",10),s(5,"group"),r(),n(6,"div",11)(7,"h2",12),s(8,"Prospect"),r(),n(9,"p",13),s(10,"Panoramica prospect e filtri rapidi"),r()(),b(11,"div",14),n(12,"a",15)(13,"span",16),s(14,"add_circle"),r()()(),n(15,"div",17)(16,"div",18),_("click",function(){return u(o),g(i.onFiltroTotale())}),n(17,"h3",19),s(18,"Totale"),r(),n(19,"div",20),f(20,vt,2,1,"span",21),r()(),n(21,"div",18),_("click",function(){return u(o),g(i.onFiltroSenzaContatto())}),n(22,"h3",19),s(23,"Senza Contatto"),r(),n(24,"div",20),f(25,Pt,2,1,"span",21),r()(),n(26,"div",18),_("click",function(){return u(o),g(i.onFiltroDaRichiamare())}),n(27,"h3",19),s(28,"Da Richiamare"),r(),n(29,"div",20),f(30,xt,2,1,"span",21),r()(),n(31,"div",18),_("click",function(){return u(o),g(i.onFiltroConfigurati())}),n(32,"h3",19),s(33,"Configurati"),r(),n(34,"div",20),f(35,Ct,2,1,"span",21),r()(),f(36,bt,1,0,"ng-template",null,0,M),r()(),n(38,"section",22)(39,"div",23)(40,"div",24)(41,"label",25)(42,"span",16),s(43,"search"),r(),s(44," Cerca "),r(),n(45,"input",26),j("ngModelChange",function(d){return u(o),B(i.searchTerm,d)||(i.searchTerm=d),g(d)}),_("ngModelChange",function(d){return u(o),g(i.onSearchChange(d))}),r()(),n(46,"div",24)(47,"label",27)(48,"span",16),s(49,"filter_list"),r(),s(50," Ultimo esito "),r(),n(51,"select",28,1),_("change",function(){u(o);let d=E(52);return g(i.onChangeFiltroEsito(d.value))}),n(53,"option",29),s(54,"Tutti"),r(),n(55,"option",30),s(56,"Senza esito"),r(),f(57,St,2,2,"option",31),r()(),n(58,"div",24)(59,"label",32)(60,"span",16),s(61,"sort"),r(),s(62," Ordina per: "),r(),n(63,"select",33,2),_("change",function(){u(o);let d=E(64);return g(i.onChangeSortDir(d.value))}),n(65,"option",34),s(66,"Pi\xF9 recente"),r(),n(67,"option",35),s(68,"Meno recente"),r()()(),n(69,"div",24)(70,"label",36)(71,"span",16),s(72,"place"),r(),s(73," Provincia "),r(),n(74,"select",37,3),_("change",function(){u(o);let d=E(75);return g(i.onChangeFiltroProvincia(d.value))}),n(76,"option",38),s(77,"Tutte"),r(),f(78,yt,2,2,"option",31),r()(),n(79,"div",24)(80,"label",39)(81,"span",16),s(82,"inventory_2"),r(),s(83," Prodotto "),r(),n(84,"select",40,4),_("change",function(){u(o);let d=E(85);return g(i.onChangeFiltroProdotto(d.value))}),n(86,"option",29),s(87,"Tutti"),r(),f(88,wt,2,2,"option",31),r()(),n(89,"div",24)(90,"button",41),_("click",function(){return u(o),g(i.resetAllFilters())}),n(91,"span",16),s(92,"filter_alt_off"),r(),s(93," Azzera filtri "),r()()(),n(94,"div",42)(95,"table",43)(96,"thead")(97,"tr")(98,"th"),s(99,"Ragione Sociale"),r(),n(100,"th"),s(101,"Referente"),r(),n(102,"th"),s(103,"Telefono"),r(),n(104,"th"),s(105,"Localit\xE0"),r(),n(106,"th"),s(107,"Configurato"),r(),n(108,"th"),s(109,"Ultimo Esito"),r(),n(110,"th"),s(111,"Prodotto"),r(),n(112,"th"),s(113,"Azioni"),r()()(),n(114,"tbody"),f(115,Ht,39,19,"tr",44)(116,Wt,3,1,"tr",45),r()()(),f(117,Jt,5,4,"div",46)(118,Qt,2,1,"div",47),r(),n(119,"app-esito-popup",48),_("closed",function(d){return u(o),g(i.onPopupClosed(d))}),r()()}if(e&2){let o=E(37);p("isLoading",i.isLoading()),l(),I("hidden",i.isLoading()),l(11),p("routerLink",W(36,ft)),l(4),I("card-active",i.currentFiltri().esito==="tutti"&&i.filtroConfigurato===null),l(4),p("ngIf",!i.kpiLoading())("ngIfElse",o),l(),I("card-active",i.currentFiltri().esito==="senza-esito"),l(4),p("ngIf",!i.kpiLoading())("ngIfElse",o),l(),I("card-active",i.currentFiltri().esito==="Richiamare"),l(4),p("ngIf",!i.kpiLoading())("ngIfElse",o),l(),I("card-active",i.filtroConfigurato===!0),l(4),p("ngIf",!i.kpiLoading())("ngIfElse",o),l(10),K("ngModel",i.searchTerm),l(6),p("value",i.currentFiltri().esito),l(6),p("ngForOf",i.esitiTipi),l(6),p("value",i.currentFiltri().sortDir),l(11),p("value",i.currentFiltri().provincia),l(4),p("ngForOf",i.province()),l(6),p("value",i.currentFiltri().prodotto||"tutti"),l(4),p("ngForOf",i.prodottiOptions()),l(27),p("ngForOf",i.displayRows())("ngForTrackBy",i.trackById),l(),p("ngIf",!i.loading()&&!i.error()&&i.displayRows().length===0),l(),p("ngIf",!i.error()&&i.hasMore()),l(),p("ngIf",i.error()),l(),p("open",i.showEsito)("soggettoId",i.selectedId)("tipo","prospect")}},dependencies:[X,G,J,Q,gt,ct,st,lt,ot,rt,at,tt,pt],styles:['.actions-dropdown[_ngcontent-%COMP%]{position:relative;display:inline-flex}.actions-dropdown[_ngcontent-%COMP%]   .modal[_ngcontent-%COMP%]{position:absolute;top:100%;right:0;width:200px;z-index:1000;border:1px solid var(--smoke-color-1);border-radius:12px;box-shadow:0 8px 24px var(--shadow);background:var(--background);animation:_ngcontent-%COMP%_slideDown .2s ease-out}@keyframes _ngcontent-%COMP%_slideDown{0%{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}.dropdown-item[_ngcontent-%COMP%]{width:100%;display:flex;align-items:center;gap:var(--gutter-sm);padding:.75rem 1rem;border:none;background:transparent;color:var(--text-color);cursor:pointer;transition:background .15s ease;font-size:var(--fs-sm);text-align:left;border-bottom:1px solid var(--smoke-color-1)}.dropdown-item[_ngcontent-%COMP%]:last-child{border-bottom:none}.dropdown-item[_ngcontent-%COMP%]:hover{background:var(--smoke-color-2)}.dropdown-item[_ngcontent-%COMP%]:disabled{opacity:.4;cursor:not-allowed}.dropdown-item[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:1.1rem;width:20px}.dropdown-overlay[_ngcontent-%COMP%]{position:fixed;inset:0;background:transparent;z-index:999;display:none}.actions-dropdown.open[_ngcontent-%COMP%] ~ .dropdown-overlay[_ngcontent-%COMP%]{display:block}@container (max-width: 768px){.crm-table[_ngcontent-%COMP%]   td[data-label=Azioni][_ngcontent-%COMP%]   .actions-container[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]:not(.actions-dropdown){display:none}.crm-table[_ngcontent-%COMP%]   td[data-label=Azioni][_ngcontent-%COMP%]   .actions-dropdown[_ngcontent-%COMP%]   .dropdown-item[style*="display: none"][_ngcontent-%COMP%]{display:flex!important}.crm-table[_ngcontent-%COMP%]   td[data-label=Azioni][_ngcontent-%COMP%]   .actions-dropdown.open[_ngcontent-%COMP%]   .modal[_ngcontent-%COMP%]{position:fixed!important;inset:50% auto auto 50%!important;transform:translate(-50%,-50%)!important;width:min(90vw,300px)!important;max-height:70vh!important;overflow-y:auto!important;z-index:1001!important;border-radius:16px!important;box-shadow:0 20px 40px var(--shadow)!important}.crm-table[_ngcontent-%COMP%]   td[data-label=Azioni][_ngcontent-%COMP%]   .actions-dropdown[_ngcontent-%COMP%]   .action-btn[_ngcontent-%COMP%]{width:3rem!important;height:3rem!important;font-size:1.3rem!important}.crm-table[_ngcontent-%COMP%]   td[data-label=Azioni][_ngcontent-%COMP%]   .actions-container[_ngcontent-%COMP%]{justify-content:center!important;padding:var(--gutter-sm) 0}}@container (min-width: 769px){.actions-dropdown[_ngcontent-%COMP%]   .modal[_ngcontent-%COMP%]{min-width:180px}.actions-dropdown.left[_ngcontent-%COMP%]   .modal[_ngcontent-%COMP%]{right:auto;left:0}.actions-dropdown.top[_ngcontent-%COMP%]   .modal[_ngcontent-%COMP%]{top:auto;bottom:100%}}.table-container[_ngcontent-%COMP%]{overflow-x:auto;position:relative}body.dropdown-open[_ngcontent-%COMP%]{overflow:hidden}.mobile-dropdown-backdrop[_ngcontent-%COMP%]{position:fixed;inset:0;background:color-mix(in srgb,var(--text-color) 20%,transparent);-webkit-backdrop-filter:blur(2px);backdrop-filter:blur(2px);z-index:998;display:none}.actions-dropdown.open[_ngcontent-%COMP%] ~ .mobile-dropdown-backdrop[_ngcontent-%COMP%]{display:block}.esito-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.2rem}.esito-details[_ngcontent-%COMP%]{line-height:1.2;font-size:calc(var(--fs-sm) / 1.25)}.crm-table[_ngcontent-%COMP%]   td[data-label="Ultimo Esito"][_ngcontent-%COMP%]{min-width:120px}@media (max-width: 768px){.crm-table[_ngcontent-%COMP%]   td[data-label="Ultimo Esito"][_ngcontent-%COMP%]{min-width:auto}.esito-details[_ngcontent-%COMP%]{font-size:.7rem}}.table-inline-select[multiple][_ngcontent-%COMP%]{width:100%;min-width:160px;max-height:9rem;height:auto;padding:.35rem .5rem;border-radius:10px;border:1px solid var(--smoke-color-1);background:var(--background);color:var(--text-color);overflow-y:auto;box-sizing:border-box;line-height:1.25}.table-inline-select[multiple][_ngcontent-%COMP%]   option.prodotto-automatico[_ngcontent-%COMP%]{color:color-mix(in srgb,var(--text-color) 40%,transparent);font-style:italic;background:linear-gradient(90deg,rgba(0,0,0,.02),transparent)}.table-inline-select[multiple][_ngcontent-%COMP%]   option[_ngcontent-%COMP%]:checked{background:color-mix(in srgb,var(--primary) 12%,transparent);color:var(--text-color)}.selected-badges[_ngcontent-%COMP%]{display:flex;gap:.4rem;flex-wrap:wrap;margin-top:.5rem;align-items:center}.selected-badges[_ngcontent-%COMP%]   .product-badge[_ngcontent-%COMP%]{padding:.25rem .6rem;font-size:.85rem;border-radius:999px;display:inline-flex;align-items:center;gap:.4rem;border:1px solid var(--smoke-color-1);background:var(--smoke-color-2)}.selected-badges[_ngcontent-%COMP%]   .product-promethea[_ngcontent-%COMP%]{background:var(--primary);color:#fff;border-color:color-mix(in srgb,var(--primary) 60%,transparent)}.selected-badges[_ngcontent-%COMP%]   .product-yuvi[_ngcontent-%COMP%]{background:color-mix(in srgb,var(--secondary) 18%,transparent);color:var(--text-color);border-color:color-mix(in srgb,var(--secondary) 60%,transparent)}.selected-badges[_ngcontent-%COMP%]   .badge-remove[_ngcontent-%COMP%]{border:none;background:transparent;color:inherit;font-weight:700;cursor:pointer;padding:0 .15rem;line-height:1;border-radius:4px}.selected-badges[_ngcontent-%COMP%]   .badge-remove[_ngcontent-%COMP%]:hover{color:var(--secondary);transform:translateY(-1px)}td[_ngcontent-%COMP%]   .cell-content[_ngcontent-%COMP%]   .table-inline-select[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   .cell-content[_ngcontent-%COMP%]   .selected-badges[_ngcontent-%COMP%]{width:100%}@media (max-width: 768px){.table-inline-select[multiple][_ngcontent-%COMP%]{max-height:7rem}.selected-badges[_ngcontent-%COMP%]{gap:.25rem}}.product-picker[_ngcontent-%COMP%]{width:100%;margin-top:.5rem}.product-picker[_ngcontent-%COMP%]   .table-inline-select[_ngcontent-%COMP%]{width:100%;min-height:88px;max-height:10rem;overflow-y:auto}']})};export{_t as ListaProspect};
