import{a as w}from"./chunk-V5FVNXN7.js";import{c as v}from"./chunk-PIGK44NO.js";import{Hb as c,O as S,T as p,ga as d}from"./chunk-IZFCH7PQ.js";import{a as g,b as m,i as f}from"./chunk-ODN5LVDJ.js";var b=class h{soggettiService=p(w);authService=p(v);stato=d({rows:[],filteredRows:[],loading:!1,error:null,hasMore:!0,page:0});filtri=d({provincia:"tutte",searchTerm:"",esito:"tutti",sortDir:"desc"});config;rows=c(()=>this.stato().rows);filteredRows=c(()=>this.stato().filteredRows);loading=c(()=>this.stato().loading);error=c(()=>this.stato().error);hasMore=c(()=>this.stato().hasMore);currentFiltri=c(()=>this.filtri());inizializza(o){this.config=g({pageSize:20,abilitaConfigurazioni:!0,abilitaTrattative:!0},o),this.reset()}caricaAltri(o=!1){return f(this,null,function*(){if(!this.authService.user()){console.error("\u274C No authenticated user for caricaAltri"),this.aggiornaStato({loading:!1,error:"Utente non autenticato. Ricarica la pagina."});return}if(this.stato().loading||!this.stato().hasMore&&!o){console.log("\u23F9\uFE0F Uscita anticipata - loading o no more data");return}this.aggiornaStato({loading:!0,error:null});try{o&&(console.log("\u{1F504} Reset stato..."),this.aggiornaStato({page:0,rows:[],hasMore:!0,filteredRows:[]}));let e=this.stato().page*this.config.pageSize,a=e+this.config.pageSize-1;console.log("\u{1F50D} Query range:",{from:e,to:a,tipo:this.config.tipo});let{data:r,error:t}=yield this.soggettiService.getSoggettiByTipo(this.config.tipo,e,a);if(console.log("\u{1F4CA} Query result:",{data:r?.length||0,error:t?.message||null,firstItem:r?.[0]?.ragione_sociale||"N/A"}),t)throw t;let n=r??[];if(n.length===0){console.log("\u{1F4ED} Nessun dato - fine caricamento"),this.aggiornaStato({hasMore:!1}),this.applicaFiltri();return}console.log("\u{1F527} Arricchimento dati...");let s=yield this.arricchisciDati(n);if(console.log("\u{1F4DD} Rows arricchite:",{count:s.length,sample:s[0]?.ragione_sociale||"N/A"}),o)this.aggiornaStato({rows:s});else{let y=new Set(this.stato().rows.map(u=>u.id)),T=s.filter(u=>!y.has(u.id));this.aggiornaStato({rows:[...this.stato().rows,...T]})}this.aggiornaStato({hasMore:n.length===this.config.pageSize,page:this.stato().page+1}),console.log("\u{1F3AF} Applicazione filtri..."),this.applicaFiltri();let l=this.stato();console.log("\u2705 Stato finale:",{totalRows:l.rows.length,filteredRows:l.filteredRows.length,hasMore:l.hasMore,page:l.page})}catch(e){console.error("\u274C Errore caricaAltri:",e),e.message?.includes("JWT")||e.message?.includes("auth")?this.aggiornaStato({error:"Sessione scaduta. Ricarica la pagina e accedi nuovamente."}):this.aggiornaStato({error:e?.message||"Errore durante il caricamento"})}finally{this.aggiornaStato({loading:!1})}})}cerca(o){return f(this,null,function*(){this.aggiornaStato({loading:!0,error:null});try{if(!o.trim()){yield this.caricaAltri(!0);return}let i=yield this.soggettiService.searchSoggetti(o,this.config.tipo);if(i.error)throw i.error;let e=i.data??[],a=yield this.arricchisciDati(e);this.aggiornaStato({rows:a,hasMore:!1,page:0}),this.applicaFiltri()}catch(i){this.aggiornaStato({error:i?.message||"Errore durante la ricerca"})}finally{this.aggiornaStato({loading:!1})}})}applicaFiltri(o){o&&this.filtri.update(t=>g(g({},t),o));let i=this.filtri(),e=this.stato().rows;console.log("\u{1F39B}\uFE0F Applicazione filtri:",{filtri:i,rowsOriginali:e.length,tipo:this.config.tipo});let a=e.filter(t=>!(i.provincia!=="tutte"&&t.provincia!==i.provincia||i.esito!=="tutti"&&(i.esito==="senza-esito"&&t.ultimoEsito||i.esito!=="senza-esito"&&t.ultimoEsito?.tipo!==i.esito)||(this.config.tipo==="cliente"||this.config.tipo==="fornitore")&&(i.conIban&&!t.iban||i.conReferente&&!t.referente)||this.config.tipo==="prospect"&&i.configurato!==null&&i.configurato!==void 0&&t.configurato!==i.configurato));console.log("\u{1F50D} Dopo filtri:",{filtrati:a.length,eliminati:e.length-a.length});let r=t=>{let n=t.ultimoEsito?.ts?new Date(t.ultimoEsito.ts).getTime():0,s=t.created_at?new Date(t.created_at).getTime():0;return n||s};a.sort((t,n)=>{let s=r(t),l=r(n);return i.sortDir==="desc"?l-s:s-l}),console.log("\u{1F4CA} Filtri finali applicati:",a.length),this.aggiornaStato({filteredRows:a})}eliminaSoggetto(o){return f(this,null,function*(){try{let i=yield this.soggettiService.deleteSoggetto(o);if(!i.success)throw new Error(i.error);return this.aggiornaStato({rows:this.stato().rows.filter(e=>e.id!==o)}),this.applicaFiltri(),!0}catch(i){return this.aggiornaStato({error:i.message||"Errore durante l'eliminazione"}),!1}})}aggiornaProdotto(o,i){return f(this,null,function*(){try{let e=yield this.soggettiService.updateSoggetto({id:o,prodotto:i});if(!e.success)throw new Error(e.error);return this.aggiornaStato({rows:this.stato().rows.map(a=>a.id===o?m(g({},a),{prodotto:i}):a)}),this.applicaFiltri(),!0}catch(e){return this.aggiornaStato({error:e?.message||"Errore aggiornamento prodotto"}),!1}})}arricchisciDati(o){return f(this,null,function*(){let i=o.map(t=>t.id).filter(t=>!!t);if(i.length===0)return o;let e=[];if(this.config.abilitaConfigurazioni?e.push(this.soggettiService.getConfigurazioniPrometheaByCliente(i)):e.push(Promise.resolve(new Map)),this.config.abilitaTrattative){let t=this.config.tipo==="prospect"?this.soggettiService.getTrattativeYuviByProspect(i):this.soggettiService.getTrattativeYuviByCliente(i);e.push(t)}else e.push(Promise.resolve(new Map));let[a,r]=yield Promise.all(e);return o.map(t=>({id:t.id,ragione_sociale:t.ragione_sociale||"Senza nome",referente:t.referente,telefono:t.telefono,email:t.email,provincia:t.provincia,comune:t.comune,prodotto:t.prodotto||"Promethea",esiti:t.esiti,ultimoEsito:this.getUltimoEsito(t.esiti),configurato:a.get(t.id)||!1,hasConfigPromethea:a.get(t.id)||!1,hasTrattativaYuvi:r.get(t.id)||!1,created_at:t.created_at,iban:t.iban}))})}getUltimoEsito(o){return!Array.isArray(o)||o.length===0?null:o.reduce((i,e)=>{let a=new Date(e.ts).getTime(),r=new Date(i.ts).getTime();return a>r?e:i})}aggiornaStato(o){this.stato.update(i=>g(g({},i),o))}reset(){this.stato.set({rows:[],filteredRows:[],loading:!1,error:null,hasMore:!0,page:0}),this.filtri.set({provincia:"tutte",searchTerm:"",esito:"tutti",sortDir:"desc"})}static \u0275fac=function(i){return new(i||h)};static \u0275prov=S({token:h,factory:h.\u0275fac,providedIn:"root"})};export{b as a};
