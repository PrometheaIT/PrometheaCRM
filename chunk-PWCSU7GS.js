import{a as yt}from"./chunk-QMKOTDWG.js";import{a as ht}from"./chunk-KF64YYTK.js";import{a as Pt}from"./chunk-DFDHLCS7.js";import{c as _t,f as vt}from"./chunk-DS74SF54.js";import{a as ft}from"./chunk-5KN6QFI4.js";import{a as st,b as lt,d as ct,f as dt,o as pt,p as ut,u as mt}from"./chunk-EXOBR4AO.js";import{b as gt}from"./chunk-JUOMJRR2.js";import{a as at}from"./chunk-Y2XJCRVM.js";import{b as ot,c as rt}from"./chunk-3ZXX2K2L.js";import{c as X,d as Z,e as tt,k as et,p as it,q as nt}from"./chunk-3DLJ4ULO.js";import{A as N,Ab as D,Cb as J,Eb as Q,Ga as W,Gb as R,I as K,La as f,Mb as $,S,Wa as H,X as m,Xa as p,Y as g,Ya as a,Za as o,_a as M,cb as q,db as G,ea as k,f as A,fb as x,ib as h,jb as u,qb as w,sa as B,sb as T,ua as l,ub as c,vb as y,wb as b,x as Y,yb as F,za as j,zb as z}from"./chunk-6W5NKFNP.js";import"./chunk-X5YLR3NI.js";import{a as V,b as U,i as v}from"./chunk-ODN5LVDJ.js";var St=()=>["/soggetto","nuovo","prospect"],xt=(r,t)=>({promethea:r,yuvi:t}),wt=(r,t)=>({"product-promethea":r,"product-yuvi":t});function Et(r,t){if(r&1&&(a(0,"span"),c(1),o()),r&2){let e=u();l(),y(e.totalProspectCount())}}function It(r,t){if(r&1&&(a(0,"span"),c(1),o()),r&2){let e=u();l(),y(e.kpi().senzaContatto)}}function kt(r,t){if(r&1&&(a(0,"span"),c(1),o()),r&2){let e=u();l(),y(e.kpi().daRichiamare)}}function Mt(r,t){if(r&1&&(a(0,"span"),c(1),o()),r&2){let e=u();l(),y(e.configuredCount())}}function Tt(r,t){r&1&&M(0,"span",56)}function Ot(r,t){if(r&1&&(a(0,"option",57),c(1),o()),r&2){let e=t.$implicit;p("value",e),l(),y(e)}}function Lt(r,t){if(r&1&&(a(0,"option",57),c(1),o()),r&2){let e=t.$implicit;p("value",e),l(),y(e)}}function Vt(r,t){if(r&1&&(a(0,"option",57),c(1),o()),r&2){let e=t.$implicit;p("value",e),l(),y(e)}}function At(r,t){if(r&1&&(a(0,"option",57),c(1),o()),r&2){let e=t.$implicit;p("value",e),l(),y(e)}}function Ft(r,t){if(r&1&&(a(0,"span"),c(1),o()),r&2){let e=u().$implicit;l(),y(e.comune)}}function zt(r,t){if(r&1&&(a(0,"span"),c(1),o()),r&2){let e=u().$implicit;l(),b(" (",e.provincia,")")}}function Dt(r,t){r&1&&(a(0,"span",78),c(1," Nessun indirizzo "),o())}function Rt(r,t){r&1&&(a(0,"span",79),c(1,"S\xEC"),o())}function $t(r,t){r&1&&(a(0,"span",80),c(1,"No"),o())}function Ut(r,t){if(r&1&&(a(0,"div",84),c(1),o()),r&2){let e=u().ngIf,i=u(2);l(),b(" ",i.formatEsitoDate(e)," ")}}function Yt(r,t){if(r&1&&(q(0),a(1,"div",81)(2,"div",82),c(3),o(),f(4,Ut,2,1,"div",83),o(),G()),r&2){let e=t.ngIf;l(3),y(e.tipo),l(),p("ngIf",e.tipo==="Richiamare"||e.tipo==="Appuntamento")}}function Nt(r,t){r&1&&c(0,"\u2014")}function Kt(r,t){if(r&1){let e=x();a(0,"button",89),h("click",function(){m(e);let n=u().$implicit,s=u(2).$implicit,d=u();return g(d.removeSelectedProduct(s,n))}),c(1," \xD7 "),o()}if(r&2){let e=u().$implicit;p("title",J("Rimuovi ",e))}}function Bt(r,t){if(r&1&&(a(0,"span",87),c(1),f(2,Kt,2,2,"button",88),o()),r&2){let e=t.$implicit,i=u(2).$implicit,n=u();p("ngClass",R(3,wt,e==="Promethea",e==="YUVI")),l(),b(" ",e," "),l(),p("ngIf",!n.isProdottoAutomatico(e,i))}}function jt(r,t){if(r&1&&(a(0,"div",85),f(1,Bt,3,6,"span",86),o()),r&2){let e=u().$implicit,i=u();l(),p("ngForOf",i.getSelectedProducts(e))}}function Wt(r,t){if(r&1&&(a(0,"option",57),c(1),o()),r&2){let e=t.$implicit;p("value",e.nome),l(),b(" ",e.nome," ")}}function Ht(r,t){r&1&&(a(0,"div",95),M(1,"span",96),o())}function qt(r,t){if(r&1){let e=x();a(0,"div",90)(1,"select",91,7),h("change",function(n){m(e);let s=u().$implicit,d=u();return g(d.onProductSelectChange(s,n))}),f(3,Wt,2,2,"option",32),o(),a(4,"div",92)(5,"button",93),h("click",function(){m(e);let n=u(2);return g(n.closeProductPicker())}),c(6,"Chiudi"),o(),f(7,Ht,2,0,"div",94),o()()}if(r&2){let e=u().$implicit,i=u();l(),p("value",i.getSelectedProducts(e))("disabled",i.updatingProdottoIds.has(e.id)),l(2),p("ngForOf",i.getManualProducts()),l(4),p("ngIf",i.updatingProdottoIds.has(e.id))}}function Gt(r,t){if(r&1){let e=x();a(0,"button",97),h("click",function(n){m(e);let s=u().$implicit,d=u();return n.stopPropagation(),g(d.vediConfigurazionePromethea(s))}),M(1,"img",98),o()}}function Jt(r,t){if(r&1){let e=x();a(0,"button",99),h("click",function(n){m(e);let s=u().$implicit,d=u();return n.stopPropagation(),g(d.vediTrattativaYuvi(s))}),M(1,"img",100),o()}}function Qt(r,t){if(r&1){let e=x();a(0,"tr",58)(1,"td",59)(2,"div",60)(3,"strong",61),h("click",function(){let n=m(e).$implicit,s=u();return g(s.apriScheda(n))}),c(4),o()()(),a(5,"td",62)(6,"div",60),c(7),o()(),a(8,"td",63)(9,"div",60),c(10),o()(),a(11,"td",64)(12,"div",60),f(13,Ft,2,1,"span",52)(14,zt,2,1,"span",52)(15,Dt,2,0,"span",65),o()(),a(16,"td",66)(17,"div",60),f(18,Rt,2,0,"span",67)(19,$t,2,0,"span",68),o()(),a(20,"td",69)(21,"div",60),f(22,Yt,5,2,"ng-container",22)(23,Nt,1,0,"ng-template",null,6,$),o()(),a(25,"td",70)(26,"div",60),f(27,jt,2,1,"div",71)(28,qt,8,4,"div",72),o()(),a(29,"td",73)(30,"div",74),f(31,Gt,2,0,"button",75)(32,Jt,2,0,"button",76),a(33,"app-action-dropdown",77),h("action",function(n){let s=m(e).$implicit,d=u();return g(d.handleRowAction(n,s))}),o()()()()}if(r&2){let e=t.$implicit,i=w(24),n=u();H("data-row-id",e.id),l(4),y(e.ragione_sociale),l(3),y(e.referente||"\u2014"),l(3),y(e.telefono||"\u2014"),l(3),p("ngIf",e.comune),l(),p("ngIf",e.provincia),l(),p("ngIf",!e.comune&&!e.provincia),l(3),p("ngIf",e.configurato),l(),p("ngIf",!e.configurato),l(3),p("ngIf",e.ultimoEsito)("ngIfElse",i),l(5),p("ngIf",n.getSelectedProducts(e).length>0),l(),p("ngIf",n.isProductPickerOpen(e)),l(3),p("ngIf",e.hasConfigPromethea),l(),p("ngIf",e.hasTrattativaYuvi),l(),p("row",e)("primaryIcons",R(17,xt,e.hasConfigPromethea,e.hasTrattativaYuvi))}}function Xt(r,t){if(r&1&&(a(0,"tr")(1,"td",101),c(2),o()()),r&2){let e=u();l(2),b(" ",e.searchTerm?"Nessun prospect trovato":"Nessun prospect"," ")}}function Zt(r,t){r&1&&(a(0,"span",17),c(1,"unfold_more"),o())}function te(r,t){r&1&&(a(0,"span",17),c(1,"hourglass_bottom"),o())}function ee(r,t){if(r&1){let e=x();a(0,"div",102)(1,"button",103),h("click",function(){m(e);let n=u();return g(n.caricaTutti())}),f(2,Zt,2,0,"span",104)(3,te,2,0,"span",104),c(4),o()()}if(r&2){let e=u();l(),p("disabled",e.loading()),l(),p("ngIf",!e.loading()),l(),p("ngIf",e.loading()),l(),b(" ",e.loading()?"Caricamento\u2026":"Carica tutti"," ")}}function ie(r,t){if(r&1&&(a(0,"div",105),c(1),o()),r&2){let e=u();l(),b(" ",e.error()," ")}}var Ct=class r{listaService=S(ht);soggettiService=S(gt);authService=S(rt);userService=S(at);router=S(it);renderer=S(j);supa=S(ot);searchSubject=new A;destroy$=new A;rows=this.listaService.rows;filteredRows=this.listaService.filteredRows;loading=this.listaService.loading;error=this.listaService.error;hasMore=this.listaService.hasMore;currentFiltri=this.listaService.currentFiltri;prodottiList=[];prodotti=k([]);updatingProdottoIds=new Set;productPickerOpenId=null;configuredCountValue=-1;categorieMerceologiche=vt;selectedCategoria="tutte";soloMiei=!1;currentUserId=null;_computeRowsForDisplay;province=k([]);kpiLoading=k(!1);kpi=k({senzaContatto:0,daRichiamare:0,configurati:0});totalProspectCount=k(0);deletingIds=new Set;showEsito=!1;selectedId=null;activeDropdownId=null;clickListener;esitiTipi=_t;searchTerm="";filtroConfigurato=null;isLoading=k(!0);constructor(){this.searchSubject.pipe(K(this.destroy$),Y(300),N()).subscribe(t=>{this.onSearchExecuted(t)})}ngOnInit(){return v(this,null,function*(){this.isLoading.set(!0);try{typeof this.authService.getAuthState=="function"&&(yield this.authService.getAuthState());let t=null,e=this.authService;typeof e.user=="function"?t=yield e.user():t=e.currentUserValue??e.user??null;let i=t?.id??t?.uid??t?.app_user_id??t?.appUserId??null;if(!i&&t?.email)try{let{data:n,error:s}=yield this.supa.supabase.from("app_users").select("id").eq("email",String(t.email).trim()).maybeSingle();!s&&n?.id&&(i=n.id)}catch(n){console.debug("[lista-prospect] lookup app_users by email failed",n)}this.currentUserId=i??null;try{console.debug("[lista-prospect] currentUserId resolved:",this.currentUserId);let n=typeof this.rows=="function"?this.rows()[0]:Array.isArray(this.rows)?this.rows[0]:null;console.debug("[lista-prospect] sample row.created_by:",n?.created_by??n)}catch{}yield this.loadProdotti(),this.listaService.inizializza({tipo:"prospect",abilitaConfigurazioni:!0,abilitaTrattative:!0}),this._computeRowsForDisplay=()=>{try{let n=this.filteredRows;if(typeof n=="function"){let d=n();if(Array.isArray(d))return d}let s=this.rows;if(typeof s=="function"){let d=s();if(Array.isArray(d))return d}return Array.isArray(s)?s:[]}catch{return[]}},yield Promise.all([this.listaService.caricaIniziali(),this.loadProvince(),this.loadTotalKPI()]),yield this.loadConfiguredCount()}catch(t){console.error("Errore durante init lista-prospect:",t),this.refreshLocalKPI()}finally{setTimeout(()=>this.isLoading.set(!1),300)}})}refreshData(){return v(this,null,function*(){try{yield this.listaService.caricaTutti(),yield this.loadTotalKPI()}catch(t){console.error("\u274C Errore refresh data:",t),this.refreshLocalKPI()}})}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete(),this.closeAllDropdowns()}loadMore(t=!1){return v(this,null,function*(){yield this.listaService.caricaTutti()})}loadProdotti(){return v(this,null,function*(){try{let t=yield this.supa.getProdotti();if(t.error)throw t.error;let e=(t.data??[]).map(i=>U(V({},i),{nome:String(i.nome??"").trim()})).filter(i=>!!i.attivo);this.prodotti.set(e)}catch(t){console.error("Errore loadProdotti lista-prospect:",t),this.prodotti.set([{nome:"Promethea",attivo:!0},{nome:"YUVI",attivo:!0}])}})}allLoaded(){return this.listaService.allLoaded()}caricaTutti(){return v(this,null,function*(){yield this.listaService.caricaTutti()})}onSearchExecuted(t){return v(this,null,function*(){yield this.listaService.cerca(t)})}onSearchChange(t){this.searchTerm=t,this.searchSubject.next(t)}onChangeFiltroEsito(t){this.listaService.applicaFiltri({esito:t,configurato:null}),this.filtroConfigurato=null}onChangeFiltroProvincia(t){this.listaService.applicaFiltri({provincia:t})}onChangeSortDir(t){this.listaService.applicaFiltri({sortDir:t})}onFiltroTotale(){this.listaService.applicaFiltri({esito:"tutti",provincia:"tutte",configurato:null}),this.filtroConfigurato=null}onFiltroSenzaContatto(){this.listaService.applicaFiltri({esito:"senza-esito",configurato:null}),this.filtroConfigurato=null}onFiltroDaRichiamare(){this.listaService.applicaFiltri({esito:"Richiamare",configurato:null}),this.filtroConfigurato=null}onFiltroConfigurati(){this.listaService.applicaFiltri({esito:"tutti",configurato:!0}),this.filtroConfigurato=!0}vediConfigurazionePromethea(t){this.router.navigate(["/alchemizzatore"],{queryParams:{prospectId:t.id,step:6}})}vediTrattativaYuvi(t){return v(this,null,function*(){try{let{data:e,error:i}=yield this.soggettiService.supabaseService.supabase.from("trattative_yuvi").select("*").eq("prospect_id",t.id).order("created_at",{ascending:!1}).limit(1).single();if(i)throw i;if(!e){alert("Nessuna trattativa YUVI trovata per questo prospect");return}this.router.navigate(["/yuvi-trattativa"],{queryParams:{prospectId:t.id,trattativaId:e.id,step:7},state:{prospect:t,trattativaEsistente:e,from:"lista-prospect"}})}catch(e){alert("Errore nel caricamento della trattativa: "+e.message)}})}onDelete(t){return v(this,null,function*(){if(!(!t?.id||!confirm(`Eliminare il prospect "${t.ragione_sociale}"?`))){this.deletingIds.add(t.id);try{(yield this.listaService.eliminaSoggetto(t.id))&&(yield this.loadTotalKPI())}catch(i){console.error("Errore durante l'eliminazione:",i)}finally{this.deletingIds.delete(t.id)}}})}onEdit(t){t?.id&&this.router.navigate(["/soggetto",t.id,"edit"])}openEsito(t){this.selectedId=t.id,this.showEsito=!0}onPopupClosed(t){return v(this,null,function*(){this.showEsito=!1,this.selectedId=null,t.saved&&(yield Promise.all([this.listaService.caricaTutti(),this.loadTotalKPI()]))})}onProductSelectChange(t,e){let i=e.target,n=Array.from(i.selectedOptions).map(s=>s.value);this.onChangeProdotto(t,n)}invalidateProdottoCache(t){t._prodottiCache&&delete t._prodottiCache}onChangeProdotto(t,e){return v(this,null,function*(){if(!t?.id||this.updatingProdottoIds.has(t.id))return;let i=this.prodotti().map(_=>_.nome),n=e.filter(_=>i.includes(_)),s=[];t.hasConfigPromethea&&s.push("Promethea"),t.hasTrattativaYuvi&&s.push("YUVI");let P=[...new Set([...s,...n])].join(", ");if((t.prodotto||"").toString().trim()!==P){this.updatingProdottoIds.add(t.id);try{let _=yield this.listaService.aggiornaProdotto(t.id,P);_&&!_.error?(t.prodotto=P,this.invalidateProdottoCache(t),yield this.listaService.caricaIniziali(),this.closeProductPicker()):console.error("Errore aggiornamento prodotto:",_?.error)}catch(_){console.error("Errore durante aggiornamento prodotto:",_)}finally{this.updatingProdottoIds.delete(t.id)}}})}getProdottiAutomatici(t){let e=[];return t.hasConfigPromethea&&e.push("Promethea"),t.hasTrattativaYuvi&&e.push("YUVI"),e.length?e.join(", "):(t.prodotto??"").toString()}trackById=(t,e)=>`${e.id}-${e.prodotto}-${e.hasConfigPromethea}-${e.hasTrattativaYuvi}`;toggleActionsDropdown(t,e){e&&e.stopPropagation();let i=this.activeDropdownId===t;this.activeDropdownId=i?null:t,this.activeDropdownId?(this.clickListener=this.renderer.listen("document","click",n=>{n.target.closest(".actions-dropdown")||this.closeAllDropdowns()}),document.body.classList.add("dropdown-open")):this.closeAllDropdowns()}closeAllDropdowns(){this.activeDropdownId=null,document.body.classList.remove("dropdown-open"),this.clickListener&&(this.clickListener(),this.clickListener=void 0)}onWindowScroll(){this.activeDropdownId&&this.closeAllDropdowns()}loadProvince(){return v(this,null,function*(){let{data:t}=yield this.soggettiService.getProvinceByTipo("prospect");t&&this.province.set(t)})}loadTotalKPI(){return v(this,null,function*(){this.kpiLoading.set(!0);try{let e=(yield this.soggettiService.countByTipo("prospect")).data||0;if(this.totalProspectCount.set(e),e===0){this.kpi.set({senzaContatto:0,daRichiamare:0,configurati:0});return}let{data:i,error:n}=yield this.soggettiService.getSoggettiByTipo("prospect",0,Math.max(e,1e3));if(n)throw console.warn("\u26A0\uFE0F Errore caricamento prospect per KPI:",n),n;if(!i||i.length===0){this.kpi.set({senzaContatto:0,daRichiamare:0,configurati:0});return}if(i.map(_=>_.id).filter(_=>!!_).length===0){this.kpi.set({senzaContatto:0,daRichiamare:0,configurati:0});return}yield this.loadConfiguredCount();let d=0,P=0;i.forEach(_=>{let L=this.getLastEsito(_.esiti);L||d++,L?.tipo==="Richiamare"&&P++});let E=this.configuredCountValue>=0?this.configuredCountValue:0;this.kpi.set({senzaContatto:d,daRichiamare:P,configurati:E}),console.log("\u2705 KPI calcolati:",{total:e,senzaContatto:d,daRichiamare:P,configurati:E,prospectProcessati:i.length})}catch(t){console.error("\u274C Errore nel caricamento KPI totali:",t),this.refreshLocalKPI()}finally{this.kpiLoading.set(!1)}})}loadConfiguredCount(){return v(this,null,function*(){try{let t=new Set,{data:e,error:i}=yield this.supa.supabase.from("configurazioni_promethea").select("prospect_id");!i&&Array.isArray(e)&&e.forEach(C=>{let I=C?.prospect_id??null,O=I?String(I).trim():null;O&&t.add(O)});let{data:n,error:s}=yield this.supa.supabase.from("trattative_yuvi").select("prospect_id");!s&&Array.isArray(n)&&n.forEach(C=>{let I=C?.prospect_id??null,O=I?String(I).trim():null;O&&t.add(O)});let d=Array.from(t);if(console.debug("[lista-prospect] raw configured ids:",d),d.length===0){this.configuredCountValue=0;return}let{data:P,error:E}=yield this.supa.supabase.from("soggetti").select("id").in("id",d).eq("tipo","prospect");if(!E&&Array.isArray(P)){let C=P.map(I=>String(I.id).trim());console.debug("[lista-prospect] configured ids filtered to prospect:",C),this.configuredCountValue=C.length;return}console.warn("[lista-prospect] errore filtro soggetti o errore DB, uso fallback rows");let _=typeof this.rows=="function"?this.rows():Array.isArray(this.rows)?this.rows:[],L=new Set((_||[]).map(C=>String(C.id).trim())),bt=d.filter(C=>L.has(C)).length;this.configuredCountValue=bt}catch(t){console.error("Errore conteggio configurati:",t),this.configuredCountValue=0}})}refreshLocalKPI(){console.log("\u{1F504} Usando KPI locali come fallback...");let t=this.rows();if(t.length===0){let i=this.kpi();i.senzaContatto===0&&i.daRichiamare===0&&i.configurati===0&&(this.totalProspectCount.set(0),this.kpi.set({senzaContatto:0,daRichiamare:0,configurati:0}));return}let e={senzaContatto:t.filter(i=>!i.ultimoEsito).length,daRichiamare:t.filter(i=>i.ultimoEsito?.tipo==="Richiamare").length,configurati:t.filter(i=>i.hasConfigPromethea||i.hasTrattativaYuvi).length};this.totalProspectCount.set(t.length),this.kpi.set(e),this.configuredCountValue=e.configurati,console.log("\u{1F4CA} KPI locali:",V({totalLocal:t.length},e))}getLastEsito(t){return!Array.isArray(t)||t.length===0?null:t.reduce((e,i)=>{let n=new Date(i.ts).getTime(),s=new Date(e.ts).getTime();return n>s?i:e})}formatEsitoDate(t){if(!t)return"";let e=t.tipo==="Appuntamento"||t.tipo==="Fissato appuntamento";if(t.tipo==="Richiamare"&&t.scheduleAt){let i=new Date(t.scheduleAt),n=i.getDate().toString().padStart(2,"0"),s=(i.getMonth()+1).toString().padStart(2,"0"),d=i.getFullYear(),P=i.getHours().toString().padStart(2,"0"),E=i.getMinutes().toString().padStart(2,"0");return`${n}/${s}/${d} alle ${P}:${E}`}if(e&&t.dataAppuntamento){let i=t.oraAppuntamento?` alle ${t.oraAppuntamento}`:"";return`${this.formatDateString(t.dataAppuntamento)}${i}`}return""}pad(t){return t.toString().padStart(2,"0")}formatDateString(t){if(!t&&t!==0)return"";if(t instanceof Date)return`${this.pad(t.getDate())}/${this.pad(t.getMonth()+1)}/${t.getFullYear()}`;let e=String(t).trim(),i=e.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(i)return`${i[3]}/${i[2]}/${i[1]}`;let n=Date.parse(e);if(!isNaN(n)){let s=new Date(n);return`${this.pad(s.getDate())}/${this.pad(s.getMonth()+1)}/${s.getFullYear()}`}return e}apriScheda(t){t?.id&&this.router.navigate(["/soggetto",t.id])}getSelectedProducts(t){if(t._prodottiCache)return t._prodottiCache;let e=[];if(t.prodotto){let i=t.prodotto.split(",").map(n=>n.trim()).filter(n=>{let s=n.toLowerCase();return n&&s!=="promethea"&&s!=="yuvi"});e.push(...i)}return t.hasConfigPromethea&&!e.includes("Promethea")&&e.push("Promethea"),t.hasTrattativaYuvi&&!e.includes("YUVI")&&e.push("YUVI"),t._prodottiCache=e,e}isProdottoAutomatico(t,e){let i=(t??"").toString().trim().toLowerCase();return i==="promethea"?!!e.hasConfigPromethea:i==="yuvi"?!!e.hasTrattativaYuvi:!1}removeSelectedProduct(t,e){if(!t)return;let n=(Array.isArray(this.getSelectedProducts(t))?this.getSelectedProducts(t):[]).filter(s=>s!==e);this.onChangeProdotto(t,n)}openProductPicker(t,e){e&&e.stopPropagation(),this.productPickerOpenId=t?.id??null,this.closeAllDropdowns()}closeProductPicker(){this.productPickerOpenId=null}isProductPickerOpen(t){return!!t&&this.productPickerOpenId===t.id}getManualProducts(){let t=new Set(["promethea","yuvi"]);return this.prodotti().filter(e=>{let i=(e.nome??"").toString().trim().toLowerCase();return i&&!t.has(i)})}prodottiOptions(){let t=new Map;for(let e of this.prodotti()){let i=(e.nome??"").toString().trim();if(!i)continue;let n=i.toLowerCase();t.has(n)||t.set(n,i)}return t.set("promethea",t.get("promethea")??"Promethea"),t.set("yuvi",t.get("yuvi")??"YUVI"),Array.from(t.values())}onChangeFiltroProdotto(t){this.listaService.applicaFiltri({prodotto:t})}resetAllFilters(){return v(this,null,function*(){this.searchTerm="",this.filtroConfigurato=null,this.listaService.applicaFiltri({provincia:"tutte",searchTerm:"",esito:"tutti",sortDir:"desc",configurato:null,prodotto:"tutti",categoria_ateco:"tutte",conIban:!1,conReferente:!1});try{yield this.listaService.caricaIniziali(),yield this.loadTotalKPI()}catch(t){console.error("Errore reset filtri:",t)}})}configuredCount(){return this.configuredCountValue>=0?this.configuredCountValue:this.kpi&&this.kpi().configurati?this.kpi().configurati:0}updateConfiguredCount(...t){let e=new Set,i=n=>{if(n){if(n instanceof Map){n.forEach((s,d)=>{d&&e.add(String(d))});return}if(Array.isArray(n)){for(let s of n){let d=s?.prospect_id??s?.soggetto_id??s?.id??null;d&&e.add(String(d))}return}typeof n=="object"&&Object.keys(n).forEach(s=>{s&&e.add(String(s))})}};for(let n of t)i(n);this.configuredCountValue=e.size}displayRows(){let t=this._computeRowsForDisplay?this._computeRowsForDisplay():typeof this.rows=="function"?this.rows():Array.isArray(this.rows)?this.rows:[];if(this.soloMiei){if(!this.currentUserId){let i=this.authService;try{let n=typeof i.user=="function"?i.user():i.currentUserValue??i.user??null;if(n&&typeof n=="object"&&typeof n.then=="function")return[];let s=n;this.currentUserId=s?.id??s?.uid??null}catch{return[]}}return this.currentUserId?t.filter(i=>{let n=i,s=n.created_by??n.created_by_user??n.owner??null,d=s;return s&&typeof s=="object"&&(d=s.id??s.user_id??s.uid??s.toString()),String(d??"").trim()===String(this.currentUserId??"").trim()}):[]}return t}onChangeFiltroCategoria(t){this.selectedCategoria=t;let e=t==="tutte"?null:t||null;this.listaService.applicaFiltri({categoria_ateco:e}),console.debug("Filtro categoria impostato:",e,"currentFiltri():",this.currentFiltri())}onToggleSoloMiei(){return v(this,null,function*(){if(this.soloMiei){if(!this.currentUserId){let e=this.authService;try{if(typeof e.getAuthState=="function"&&(yield e.getAuthState()),typeof e.user=="function"){let i=yield e.user();this.currentUserId=i?.id??i?.uid??null}else{let i=e.currentUserValue??e.user??null;this.currentUserId=i?.id??i?.uid??null}}catch(i){console.warn("Impossibile risolvere currentUserId:",i)}}let t=typeof this.rows=="function"?this.rows():Array.isArray(this.rows)?this.rows:[];(!t||t.length===0)&&(yield this.listaService.caricaIniziali());return}yield this.listaService.caricaIniziali()})}handleRowAction(t,e){switch(t){case"promethea":this.vediConfigurazionePromethea(e);break;case"yuvi":this.vediTrattativaYuvi(e);break;case"add-product":this.openProductPicker(e);break;case"edit":this.onEdit(e);break;case"esito":this.openEsito(e);break;case"delete":this.onDelete(e);break;default:console.warn("Azione non gestita",t)}}static \u0275fac=function(e){return new(e||r)};static \u0275cmp=W({type:r,selectors:[["app-lista-prospect"]],hostBindings:function(e,i){e&1&&h("scroll",function(){return i.onWindowScroll()},B)},decls:136,vars:41,consts:[["loadingSpinner",""],["filtroSel",""],["ordinaSel",""],["provSel",""],["prodSel",""],["categoriaSel",""],["noEsito",""],["sel",""],["title","Caricamento Prospect","subtitle","Stiamo caricando i tuoi prospect...",3,"isLoading"],[1,"form-section"],[1,"section-header"],[1,"material-icons","header-icon"],[1,"section-titles"],[1,"section-title"],[1,"sottotitolo"],[1,"flex-1"],["title","Aggiungi prospect","aria-label","Aggiungi prospect",1,"icon-btn",3,"routerLink"],[1,"material-icons"],[1,"prospect-cards"],[1,"card",3,"click"],[1,"card-title"],[1,"card-number"],[4,"ngIf","ngIfElse"],[1,"table-section"],[1,"table-tools"],[1,"tool"],["for","search",1,"label"],["id","search","type","text","placeholder","Nome, telefono, email...",1,"table-inline-input",3,"ngModelChange","ngModel"],["for","filtroEsito",1,"label"],["id","filtroEsito",1,"table-inline-select",3,"change","value"],["value","tutti"],["value","senza-esito"],[3,"value",4,"ngFor","ngForOf"],["for","ordinaPer",1,"label"],["id","ordinaPer",1,"table-inline-select",3,"change","value"],["value","desc"],["value","asc"],["for","filtroProvincia",1,"label"],["id","filtroProvincia",1,"table-inline-select",3,"change","value"],["value","tutte"],["for","filtroProdotto",1,"label"],["id","filtroProdotto",1,"table-inline-select",3,"change","value"],["for","filtroCategoria",1,"label"],["id","filtroCategoria",1,"table-inline-select",3,"change","value"],["type","button",1,"promethea-button","ghost",3,"click"],[1,"tool",2,"display","flex","align-items","center","gap","var(--gutter-sm)","margin","var(--gutter-sm) 0"],["id","soloMiei","type","checkbox",3,"ngModelChange","change","ngModel"],["for","soloMiei",2,"margin","0","font-size","0.95rem"],["title","Risultati filtrati",1,"chip",2,"margin","0 var(--gutter-lg)"],[1,"table-container"],[1,"crm-table"],["class","row-clickable",4,"ngFor","ngForOf","ngForTrackBy"],[4,"ngIf"],["class","load-more-container",4,"ngIf"],["style","text-align:center; color:#ef4444; margin-top:1rem;",4,"ngIf"],[3,"closed","open","soggettoId","tipo"],[1,"loading-spinner"],[3,"value"],[1,"row-clickable"],["data-label","Ragione Sociale"],[1,"cell-content"],[1,"link",3,"click"],["data-label","Referente"],["data-label","Telefono"],["data-label","Localit\xE0"],["style","color: #6b7280; font-style: italic;",4,"ngIf"],["data-label","Configurato"],["class","badge badge-success",4,"ngIf"],["class","badge badge-danger",4,"ngIf"],["data-label","Ultimo Esito"],["data-label","Prodotto"],["class","selected-badges",4,"ngIf"],["class","product-picker",4,"ngIf"],["data-label","Azioni"],[1,"actions-container"],["class","action-btn document","title","Configurazione Promethea",3,"click",4,"ngIf"],["class","action-btn email","title","Trattativa YUVI",3,"click",4,"ngIf"],[3,"action","row","primaryIcons"],[2,"color","#6b7280","font-style","italic"],[1,"badge","badge-success"],[1,"badge","badge-danger"],[1,"esito-container"],[1,"esito-tipo"],["class","esito-details text-muted",4,"ngIf"],[1,"esito-details","text-muted"],[1,"selected-badges"],["class","product-badge",3,"ngClass",4,"ngFor","ngForOf"],[1,"product-badge",3,"ngClass"],["class","badge-remove","type","button",3,"title","click",4,"ngIf"],["type","button",1,"badge-remove",3,"click","title"],[1,"product-picker"],["multiple","",1,"table-inline-select",3,"change","value","disabled"],[2,"margin-top","0.5rem","display","flex","gap","0.5rem","align-items","center"],[1,"promethea-button","outline",3,"click"],["class","loading-indicator","style","margin-left:0.5rem;",4,"ngIf"],[1,"loading-indicator",2,"margin-left","0.5rem"],[1,"loading-spinner",2,"width","20px","height","20px","border-width","2px"],["title","Configurazione Promethea",1,"action-btn","document",3,"click"],["src","assets/Logo.png","alt","Promethea",1,"icon-img"],["title","Trattativa YUVI",1,"action-btn","email",3,"click"],["src","assets/yuvi.png","alt","YUVI",1,"icon-img"],["colspan","8",2,"text-align","center","padding","1.5rem"],[1,"load-more-container"],[1,"promethea-button",3,"click","disabled"],["class","material-icons",4,"ngIf"],[2,"text-align","center","color","#ef4444","margin-top","1rem"]],template:function(e,i){if(e&1){let n=x();M(0,"app-page-loader",8),a(1,"div")(2,"div",9)(3,"div",10)(4,"i",11),c(5,"group"),o(),a(6,"div",12)(7,"h2",13),c(8,"Prospect"),o(),a(9,"p",14),c(10,"Panoramica prospect e filtri rapidi"),o()(),M(11,"div",15),a(12,"a",16)(13,"span",17),c(14,"add_circle"),o()()(),a(15,"div",18)(16,"div",19),h("click",function(){return m(n),g(i.onFiltroTotale())}),a(17,"h3",20),c(18,"Totale"),o(),a(19,"div",21),f(20,Et,2,1,"span",22),o()(),a(21,"div",19),h("click",function(){return m(n),g(i.onFiltroSenzaContatto())}),a(22,"h3",20),c(23,"Senza Contatto"),o(),a(24,"div",21),f(25,It,2,1,"span",22),o()(),a(26,"div",19),h("click",function(){return m(n),g(i.onFiltroDaRichiamare())}),a(27,"h3",20),c(28,"Da Richiamare"),o(),a(29,"div",21),f(30,kt,2,1,"span",22),o()(),a(31,"div",19),h("click",function(){return m(n),g(i.onFiltroConfigurati())}),a(32,"h3",20),c(33,"Configurati"),o(),a(34,"div",21),f(35,Mt,2,1,"span",22),o()(),f(36,Tt,1,0,"ng-template",null,0,$),o()(),a(38,"section",23)(39,"div",24)(40,"div",25)(41,"label",26)(42,"span",17),c(43,"search"),o(),c(44," Cerca "),o(),a(45,"input",27),D("ngModelChange",function(d){return m(n),z(i.searchTerm,d)||(i.searchTerm=d),g(d)}),h("ngModelChange",function(d){return m(n),g(i.onSearchChange(d))}),o()(),a(46,"div",25)(47,"label",28)(48,"span",17),c(49,"filter_list"),o(),c(50," Ultimo esito "),o(),a(51,"select",29,1),h("change",function(){m(n);let d=w(52);return g(i.onChangeFiltroEsito(d.value))}),a(53,"option",30),c(54,"Tutti"),o(),a(55,"option",31),c(56,"Senza esito"),o(),f(57,Ot,2,2,"option",32),o()(),a(58,"div",25)(59,"label",33)(60,"span",17),c(61,"sort"),o(),c(62," Ordina per: "),o(),a(63,"select",34,2),h("change",function(){m(n);let d=w(64);return g(i.onChangeSortDir(d.value))}),a(65,"option",35),c(66,"Pi\xF9 recente"),o(),a(67,"option",36),c(68,"Meno recente"),o()()(),a(69,"div",25)(70,"label",37)(71,"span",17),c(72,"place"),o(),c(73," Provincia "),o(),a(74,"select",38,3),h("change",function(){m(n);let d=w(75);return g(i.onChangeFiltroProvincia(d.value))}),a(76,"option",39),c(77,"Tutte"),o(),f(78,Lt,2,2,"option",32),o()(),a(79,"div",25)(80,"label",40)(81,"span",17),c(82,"inventory_2"),o(),c(83," Prodotto "),o(),a(84,"select",41,4),h("change",function(){m(n);let d=w(85);return g(i.onChangeFiltroProdotto(d.value))}),a(86,"option",30),c(87,"Tutti"),o(),f(88,Vt,2,2,"option",32),o()(),a(89,"div",25)(90,"label",42)(91,"span",17),c(92,"category"),o(),c(93," Categoria "),o(),a(94,"select",43,5),h("change",function(){m(n);let d=w(95);return g(i.onChangeFiltroCategoria(d.value))}),a(96,"option",39),c(97,"Tutte"),o(),f(98,At,2,2,"option",32),o()(),a(99,"div",25)(100,"button",44),h("click",function(){return m(n),g(i.resetAllFilters())}),a(101,"span",17),c(102,"filter_alt_off"),o(),c(103," Azzera filtri "),o()(),a(104,"div",45)(105,"input",46),D("ngModelChange",function(d){return m(n),z(i.soloMiei,d)||(i.soloMiei=d),g(d)}),h("change",function(){return m(n),g(i.onToggleSoloMiei())}),o(),a(106,"label",47),c(107,"Solo i miei"),o(),a(108,"span",48),c(109),o()()(),a(110,"div",49)(111,"table",50)(112,"thead")(113,"tr")(114,"th"),c(115,"Ragione Sociale"),o(),a(116,"th"),c(117,"Referente"),o(),a(118,"th"),c(119,"Telefono"),o(),a(120,"th"),c(121,"Localit\xE0"),o(),a(122,"th"),c(123,"Configurato"),o(),a(124,"th"),c(125,"Ultimo Esito"),o(),a(126,"th"),c(127,"Prodotto"),o(),a(128,"th"),c(129,"Azioni"),o()()(),a(130,"tbody"),f(131,Qt,34,20,"tr",51)(132,Xt,3,1,"tr",52),o()()(),f(133,ee,5,4,"div",53)(134,ie,2,1,"div",54),o(),a(135,"app-esito-popup",55),h("closed",function(d){return m(n),g(i.onPopupClosed(d))}),o()()}if(e&2){let n=w(37);p("isLoading",i.isLoading()),l(),T("hidden",i.isLoading()),l(11),p("routerLink",Q(40,St)),l(4),T("card-active",i.currentFiltri().esito==="tutti"&&i.filtroConfigurato===null),l(4),p("ngIf",!i.kpiLoading())("ngIfElse",n),l(),T("card-active",i.currentFiltri().esito==="senza-esito"),l(4),p("ngIf",!i.kpiLoading())("ngIfElse",n),l(),T("card-active",i.currentFiltri().esito==="Richiamare"),l(4),p("ngIf",!i.kpiLoading())("ngIfElse",n),l(),T("card-active",i.filtroConfigurato===!0),l(4),p("ngIf",!i.kpiLoading())("ngIfElse",n),l(10),F("ngModel",i.searchTerm),l(6),p("value",i.currentFiltri().esito),l(6),p("ngForOf",i.esitiTipi),l(6),p("value",i.currentFiltri().sortDir),l(11),p("value",i.currentFiltri().provincia),l(4),p("ngForOf",i.province()),l(6),p("value",i.currentFiltri().prodotto||"tutti"),l(4),p("ngForOf",i.prodottiOptions()),l(6),p("value",i.currentFiltri().categoria_ateco||"tutte"),l(4),p("ngForOf",i.categorieMerceologiche),l(7),F("ngModel",i.soloMiei),l(4),b(" Risultati: ",i.displayRows().length," "),l(22),p("ngForOf",i.displayRows())("ngForTrackBy",i.trackById),l(),p("ngIf",!i.loading()&&!i.error()&&i.displayRows().length===0),l(),p("ngIf",!i.error()&&i.hasMore()),l(),p("ngIf",i.error()),l(),p("open",i.showEsito)("soggettoId",i.selectedId)("tipo","prospect")}},dependencies:[et,X,Z,tt,yt,mt,pt,ut,lt,st,ct,dt,nt,ft,Pt],styles:['.actions-dropdown[_ngcontent-%COMP%]{position:relative;display:inline-flex}.actions-dropdown[_ngcontent-%COMP%]   .modal[_ngcontent-%COMP%]{position:absolute;top:100%;right:0;width:200px;z-index:1000;border:1px solid var(--smoke-color-1);border-radius:12px;box-shadow:0 8px 24px var(--shadow);background:var(--background);animation:_ngcontent-%COMP%_slideDown .2s ease-out}@keyframes _ngcontent-%COMP%_slideDown{0%{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}.dropdown-item[_ngcontent-%COMP%]{width:100%;display:flex;align-items:center;gap:var(--gutter-sm);padding:.75rem 1rem;border:none;background:transparent;color:var(--text-color);cursor:pointer;transition:background .15s ease;font-size:var(--fs-sm);text-align:left;border-bottom:1px solid var(--smoke-color-1)}.dropdown-item[_ngcontent-%COMP%]:last-child{border-bottom:none}.dropdown-item[_ngcontent-%COMP%]:hover{background:var(--smoke-color-2)}.dropdown-item[_ngcontent-%COMP%]:disabled{opacity:.4;cursor:not-allowed}.dropdown-item[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:1.1rem;width:20px}.dropdown-overlay[_ngcontent-%COMP%]{position:fixed;inset:0;background:transparent;z-index:999;display:none}.actions-dropdown.open[_ngcontent-%COMP%] ~ .dropdown-overlay[_ngcontent-%COMP%]{display:block}@container (max-width: 768px){.crm-table[_ngcontent-%COMP%]   td[data-label=Azioni][_ngcontent-%COMP%]   .actions-container[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]:not(.actions-dropdown){display:none}.crm-table[_ngcontent-%COMP%]   td[data-label=Azioni][_ngcontent-%COMP%]   .actions-dropdown[_ngcontent-%COMP%]   .dropdown-item[style*="display: none"][_ngcontent-%COMP%]{display:flex!important}.crm-table[_ngcontent-%COMP%]   td[data-label=Azioni][_ngcontent-%COMP%]   .actions-dropdown.open[_ngcontent-%COMP%]   .modal[_ngcontent-%COMP%]{position:fixed!important;inset:50% auto auto 50%!important;transform:translate(-50%,-50%)!important;width:min(90vw,300px)!important;max-height:70vh!important;overflow-y:auto!important;z-index:1001!important;border-radius:16px!important;box-shadow:0 20px 40px var(--shadow)!important}.crm-table[_ngcontent-%COMP%]   td[data-label=Azioni][_ngcontent-%COMP%]   .actions-dropdown[_ngcontent-%COMP%]   .action-btn[_ngcontent-%COMP%]{width:3rem!important;height:3rem!important;font-size:1.3rem!important}.crm-table[_ngcontent-%COMP%]   td[data-label=Azioni][_ngcontent-%COMP%]   .actions-container[_ngcontent-%COMP%]{justify-content:center!important;padding:var(--gutter-sm) 0}}@container (min-width: 769px){.actions-dropdown[_ngcontent-%COMP%]   .modal[_ngcontent-%COMP%]{min-width:180px}.actions-dropdown.left[_ngcontent-%COMP%]   .modal[_ngcontent-%COMP%]{right:auto;left:0}.actions-dropdown.top[_ngcontent-%COMP%]   .modal[_ngcontent-%COMP%]{top:auto;bottom:100%}}.table-container[_ngcontent-%COMP%]{overflow-x:auto;position:relative}body.dropdown-open[_ngcontent-%COMP%]{overflow:hidden}.mobile-dropdown-backdrop[_ngcontent-%COMP%]{position:fixed;inset:0;background:color-mix(in srgb,var(--text-color) 20%,transparent);-webkit-backdrop-filter:blur(2px);backdrop-filter:blur(2px);z-index:998;display:none}.actions-dropdown.open[_ngcontent-%COMP%] ~ .mobile-dropdown-backdrop[_ngcontent-%COMP%]{display:block}.esito-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.2rem}.esito-details[_ngcontent-%COMP%]{line-height:1.2;font-size:calc(var(--fs-sm) / 1.25)}.crm-table[_ngcontent-%COMP%]   td[data-label="Ultimo Esito"][_ngcontent-%COMP%]{min-width:120px}@media (max-width: 768px){.crm-table[_ngcontent-%COMP%]   td[data-label="Ultimo Esito"][_ngcontent-%COMP%]{min-width:auto}.esito-details[_ngcontent-%COMP%]{font-size:.7rem}}.table-inline-select[multiple][_ngcontent-%COMP%]{width:100%;min-width:160px;max-height:9rem;height:auto;padding:.35rem .5rem;border-radius:10px;border:1px solid var(--smoke-color-1);background:var(--background);color:var(--text-color);overflow-y:auto;box-sizing:border-box;line-height:1.25}.table-inline-select[multiple][_ngcontent-%COMP%]   option.prodotto-automatico[_ngcontent-%COMP%]{color:color-mix(in srgb,var(--text-color) 40%,transparent);font-style:italic;background:linear-gradient(90deg,rgba(0,0,0,.02),transparent)}.table-inline-select[multiple][_ngcontent-%COMP%]   option[_ngcontent-%COMP%]:checked{background:color-mix(in srgb,var(--primary) 12%,transparent);color:var(--text-color)}.selected-badges[_ngcontent-%COMP%]{display:flex;gap:.4rem;flex-wrap:wrap;margin-top:.5rem;align-items:center}.selected-badges[_ngcontent-%COMP%]   .product-badge[_ngcontent-%COMP%]{padding:.25rem .6rem;font-size:.85rem;border-radius:999px;display:inline-flex;align-items:center;gap:.4rem;border:1px solid var(--smoke-color-1);background:var(--smoke-color-2)}.selected-badges[_ngcontent-%COMP%]   .product-promethea[_ngcontent-%COMP%]{background:var(--primary);color:#fff;border-color:color-mix(in srgb,var(--primary) 60%,transparent)}.selected-badges[_ngcontent-%COMP%]   .product-yuvi[_ngcontent-%COMP%]{background:color-mix(in srgb,var(--secondary) 18%,transparent);color:var(--text-color);border-color:color-mix(in srgb,var(--secondary) 60%,transparent)}.selected-badges[_ngcontent-%COMP%]   .badge-remove[_ngcontent-%COMP%]{border:none;background:transparent;color:inherit;font-weight:700;cursor:pointer;padding:0 .15rem;line-height:1;border-radius:4px}.selected-badges[_ngcontent-%COMP%]   .badge-remove[_ngcontent-%COMP%]:hover{color:var(--secondary);transform:translateY(-1px)}td[_ngcontent-%COMP%]   .cell-content[_ngcontent-%COMP%]   .table-inline-select[_ngcontent-%COMP%], td[_ngcontent-%COMP%]   .cell-content[_ngcontent-%COMP%]   .selected-badges[_ngcontent-%COMP%]{width:100%}@media (max-width: 768px){.table-inline-select[multiple][_ngcontent-%COMP%]{max-height:7rem}.selected-badges[_ngcontent-%COMP%]{gap:.25rem}}.product-picker[_ngcontent-%COMP%]{width:100%;margin-top:.5rem}.product-picker[_ngcontent-%COMP%]   .table-inline-select[_ngcontent-%COMP%]{width:100%;min-height:88px;max-height:10rem;overflow-y:auto}']})};export{Ct as ListaProspect};
