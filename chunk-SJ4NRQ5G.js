import{f as m}from"./chunk-NWP7JNX6.js";import{b as y}from"./chunk-7K4EWSAC.js";import{N as f,S as c,ea as g,f as d,g as p}from"./chunk-QBO2HR3F.js";import{a as h,i}from"./chunk-ODN5LVDJ.js";var b=class a{router=c(m);supabaseService=c(y);user=g(null);isLoading=g(!0);userSubject=new p(null);user$=this.userSubject.asObservable();destroy$=new d;constructor(){this.initializeAuth()}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}initializeAuth(){return i(this,null,function*(){try{this.isLoading.set(!0);let{data:{session:e},error:t}=yield this.supabaseService.supabase.auth.getSession();if(t){console.error("\u274C Error getting initial session:",t),this.isLoading.set(!1);return}e?.user?(console.log("\u2705 Initial session found:",e.user.id),this.user.set(e.user),this.userSubject.next(e.user)):(console.log("\u2139\uFE0F No initial session found"),this.user.set(null),this.userSubject.next(null)),this.supabaseService.supabase.auth.onAuthStateChange((s,r)=>{console.log("\u{1F504} Auth state changed:",s,r?.user?.id),r?.user?(this.user.set(r.user),this.userSubject.next(r.user)):(this.user.set(null),this.userSubject.next(null)),this.isLoading.set(!1)}),this.isLoading.set(!1)}catch(e){console.error("\u274C Error initializing auth:",e),this.isLoading.set(!1)}})}getAuthState(){return i(this,null,function*(){return this.isLoading()?(console.log("\u23F3 Auth state check waiting for initialization..."),new Promise(e=>{let t=setInterval(()=>{this.isLoading()||(clearInterval(t),e(this.user()))},100);setTimeout(()=>{clearInterval(t),console.warn("\u26A0\uFE0F Auth state check timeout"),e(this.user())},5e3)})):this.user()})}login(e,t){return i(this,null,function*(){try{this.isLoading.set(!0);let{data:s,error:r}=yield this.supabaseService.supabase.auth.signInWithPassword({email:e,password:t});return r?(console.error("\u274C Supabase login error details:",r),this.isLoading.set(!1),{success:!1,error:r.message??String(r)}):s?.user?(this.user.set(s.user),this.userSubject.next(s.user),console.log("\u2705 Login successful:",s.user.id),this.isLoading.set(!1),{success:!0}):(this.isLoading.set(!1),{success:!1,error:"Login fallito"})}catch(s){return console.error("\u274C Login exception:",s),this.isLoading.set(!1),{success:!1,error:s?.message??String(s)}}})}logout(){return i(this,null,function*(){try{this.isLoading.set(!0);let{error:e}=yield this.supabaseService.supabase.auth.signOut();e&&console.error("\u274C Logout error:",e),this.user.set(null),this.userSubject.next(null),console.log("\u2705 Logout successful"),this.isLoading.set(!1),yield this.router.navigate(["/login"])}catch(e){console.error("\u274C Logout exception:",e),this.isLoading.set(!1)}})}register(e,t,s,r,o){return i(this,null,function*(){try{this.isLoading.set(!0);let{data:n,error:u}=yield this.supabaseService.supabase.auth.signUp({email:e,password:t,options:{data:{invite_token:o??void 0}}});if(u)return console.error("\u274C Registration error:",u),this.isLoading.set(!1),{success:!1,error:u.message};let l=n?.user?.id??n?.id??null;if(l)try{yield this.supabaseService.createAppUser({id:l,email:e,first_name:s??null,last_name:r??null,display_name:`${(s||"").trim()} ${(r||"").trim()}`.trim()||null,is_active:!1})}catch(S){console.warn("\u26A0\uFE0F createAppUser failed:",S)}return console.log("\u2705 Registration successful:",l),this.isLoading.set(!1),{success:!0}}catch(n){return console.error("\u274C Registration exception:",n),this.isLoading.set(!1),{success:!1,error:n.message}}})}isAuthenticated(){return this.user()!==null}getCurrentUserId(){return this.user()?.id||null}isAuthInitialized(){return!this.isLoading()}getAccessToken(){return i(this,null,function*(){try{let{data:e}=yield this.supabaseService.supabase.auth.getSession();return e?.session?.access_token??null}catch(e){return console.warn("getAccessToken failed",e),null}})}decodeJwt(e){try{let s=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),r=decodeURIComponent(Array.prototype.map.call(atob(s),o=>"%"+("00"+o.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(r)}catch{return null}}getJwtPayload(){return i(this,null,function*(){let e=yield this.getAccessToken();return e?this.decodeJwt(e):null})}getRole(){return i(this,null,function*(){let e=yield this.getJwtPayload(),t=e?.role??e?.["https://your-namespace/role"],s=this.user()?.user_metadata??{},r=s?.role??s?.["https://your-namespace/role"];return typeof t=="string"?t:typeof r=="string"?r:null})}ensureAuthInitialized(e=5e3){return i(this,null,function*(){if(this.isLoading())return new Promise(t=>{let s=Date.now(),r=setInterval(()=>{(!this.isLoading()||Date.now()-s>e)&&(clearInterval(r),t())},100)})})}postToAdminEndpoint(e,t){return i(this,null,function*(){let s=yield this.getAccessToken();return fetch(e,{method:"POST",headers:h({"Content-Type":"application/json"},s?{Authorization:`Bearer ${s}`}:{}),body:JSON.stringify(t)})})}static \u0275fac=function(t){return new(t||a)};static \u0275prov=f({token:a,factory:a.\u0275fac,providedIn:"root"})};export{b as a};
