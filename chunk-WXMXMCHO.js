import{a as w}from"./chunk-PBTFW77J.js";import{w as v}from"./chunk-VUYFDMJB.js";import{Gb as l,N as S,S as p,fa as d}from"./chunk-CVFHM34U.js";import{a as g,b as m,i as c}from"./chunk-ODN5LVDJ.js";var b=class f{soggettiService=p(w);authService=p(v);stato=d({rows:[],filteredRows:[],loading:!1,error:null,hasMore:!0,page:0});filtri=d({provincia:"tutte",searchTerm:"",esito:"tutti",sortDir:"desc"});config;rows=l(()=>this.stato().rows);filteredRows=l(()=>this.stato().filteredRows);loading=l(()=>this.stato().loading);error=l(()=>this.stato().error);hasMore=l(()=>this.stato().hasMore);currentFiltri=l(()=>this.filtri());inizializza(e){this.config=g({pageSize:20,abilitaConfigurazioni:!0,abilitaTrattative:!0},e),this.reset()}caricaAltri(e=!1){return c(this,null,function*(){if(console.log("\u{1F504} caricaAltri:",{reset:e,loading:this.stato().loading,hasMore:this.stato().hasMore,currentPage:this.stato().page,tipo:this.config.tipo}),this.stato().loading||!this.stato().hasMore&&!e){console.log("\u23F9\uFE0F Uscita anticipata - loading o no more data");return}this.aggiornaStato({loading:!0,error:null});try{e&&(console.log("\u{1F504} Reset stato..."),this.aggiornaStato({page:0,rows:[],hasMore:!0,filteredRows:[]}));let t=this.stato().page*this.config.pageSize,o=t+this.config.pageSize-1;console.log("\u{1F50D} Query range:",{from:t,to:o,tipo:this.config.tipo});let{data:a,error:r}=yield this.soggettiService.getSoggettiByTipo(this.config.tipo,t,o);if(console.log("\u{1F4CA} Query result:",{data:a?.length||0,error:r?.message||null,firstItem:a?.[0]?.ragione_sociale||"N/A"}),r)throw r;let i=a??[];if(i.length===0){console.log("\u{1F4ED} Nessun dato - fine caricamento"),this.aggiornaStato({hasMore:!1}),this.applicaFiltri();return}console.log("\u{1F527} Arricchimento dati...");let n=yield this.arricchisciDati(i);if(console.log("\u{1F4DD} Rows arricchite:",{count:n.length,sample:n[0]?.ragione_sociale||"N/A"}),e)this.aggiornaStato({rows:n});else{let h=new Set(this.stato().rows.map(u=>u.id)),y=n.filter(u=>!h.has(u.id));this.aggiornaStato({rows:[...this.stato().rows,...y]})}this.aggiornaStato({hasMore:i.length===this.config.pageSize,page:this.stato().page+1}),console.log("\u{1F3AF} Applicazione filtri..."),this.applicaFiltri();let s=this.stato();console.log("\u2705 Stato finale:",{totalRows:s.rows.length,filteredRows:s.filteredRows.length,hasMore:s.hasMore,page:s.page})}catch(t){console.error("\u274C Errore caricaAltri:",t),this.aggiornaStato({error:t?.message||"Errore durante il caricamento"})}finally{this.aggiornaStato({loading:!1})}})}cerca(e){return c(this,null,function*(){this.aggiornaStato({loading:!0,error:null});try{if(!e.trim()){yield this.caricaAltri(!0);return}let t=yield this.soggettiService.searchSoggetti(e,this.config.tipo);if(t.error)throw t.error;let o=t.data??[],a=yield this.arricchisciDati(o);this.aggiornaStato({rows:a,hasMore:!1,page:0}),this.applicaFiltri()}catch(t){this.aggiornaStato({error:t?.message||"Errore durante la ricerca"})}finally{this.aggiornaStato({loading:!1})}})}applicaFiltri(e){e&&this.filtri.update(i=>g(g({},i),e));let t=this.filtri(),o=this.stato().rows;console.log("\u{1F39B}\uFE0F Applicazione filtri:",{filtri:t,rowsOriginali:o.length,tipo:this.config.tipo});let a=o.filter(i=>!(t.provincia!=="tutte"&&i.provincia!==t.provincia||t.esito!=="tutti"&&(t.esito==="senza-esito"&&i.ultimoEsito||t.esito!=="senza-esito"&&i.ultimoEsito?.tipo!==t.esito)||(this.config.tipo==="cliente"||this.config.tipo==="fornitore")&&(t.conIban&&!i.iban||t.conReferente&&!i.referente)||this.config.tipo==="prospect"&&t.configurato!==null&&t.configurato!==void 0&&i.configurato!==t.configurato));console.log("\u{1F50D} Dopo filtri:",{filtrati:a.length,eliminati:o.length-a.length});let r=i=>{let n=i.ultimoEsito?.ts?new Date(i.ultimoEsito.ts).getTime():0,s=i.created_at?new Date(i.created_at).getTime():0;return n||s};a.sort((i,n)=>{let s=r(i),h=r(n);return t.sortDir==="desc"?h-s:s-h}),console.log("\u{1F4CA} Filtri finali applicati:",a.length),this.aggiornaStato({filteredRows:a})}eliminaSoggetto(e){return c(this,null,function*(){try{let t=yield this.soggettiService.deleteSoggetto(e);if(!t.success)throw new Error(t.error);return this.aggiornaStato({rows:this.stato().rows.filter(o=>o.id!==e)}),this.applicaFiltri(),!0}catch(t){return this.aggiornaStato({error:t.message||"Errore durante l'eliminazione"}),!1}})}aggiornaProdotto(e,t){return c(this,null,function*(){try{let o=yield this.soggettiService.updateSoggetto({id:e,prodotto:t});if(!o.success)throw new Error(o.error);return this.aggiornaStato({rows:this.stato().rows.map(a=>a.id===e?m(g({},a),{prodotto:t}):a)}),this.applicaFiltri(),!0}catch(o){return this.aggiornaStato({error:o?.message||"Errore aggiornamento prodotto"}),!1}})}arricchisciDati(e){return c(this,null,function*(){let t=e.map(i=>i.id).filter(i=>!!i);if(t.length===0)return e;let o=[];if(this.config.abilitaConfigurazioni?o.push(this.soggettiService.getConfigurazioniPrometheaByCliente(t)):o.push(Promise.resolve(new Map)),this.config.abilitaTrattative){let i=this.config.tipo==="prospect"?this.soggettiService.getTrattativeYuviByProspect(t):this.soggettiService.getTrattativeYuviByCliente(t);o.push(i)}else o.push(Promise.resolve(new Map));let[a,r]=yield Promise.all(o);return e.map(i=>({id:i.id,ragione_sociale:i.ragione_sociale||"Senza nome",referente:i.referente,telefono:i.telefono,email:i.email,provincia:i.provincia,comune:i.comune,prodotto:i.prodotto||"Promethea",esiti:i.esiti,ultimoEsito:this.getUltimoEsito(i.esiti),configurato:a.get(i.id)||!1,hasConfigPromethea:a.get(i.id)||!1,hasTrattativaYuvi:r.get(i.id)||!1,created_at:i.created_at,iban:i.iban}))})}getUltimoEsito(e){return!Array.isArray(e)||e.length===0?null:e.reduce((t,o)=>{let a=new Date(o.ts).getTime(),r=new Date(t.ts).getTime();return a>r?o:t})}aggiornaStato(e){this.stato.update(t=>g(g({},t),e))}reset(){this.stato.set({rows:[],filteredRows:[],loading:!1,error:null,hasMore:!0,page:0}),this.filtri.set({provincia:"tutte",searchTerm:"",esito:"tutti",sortDir:"desc"})}static \u0275fac=function(t){return new(t||f)};static \u0275prov=S({token:f,factory:f.\u0275fac,providedIn:"root"})};export{b as a};
