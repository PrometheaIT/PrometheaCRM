import{a as B}from"./chunk-AW2I6Z2Q.js";import{a as F}from"./chunk-HJKRPVL5.js";import{b as U}from"./chunk-LWVBIPYG.js";import"./chunk-I5UR3M7V.js";import{b as A,c as K}from"./chunk-5QACXCZZ.js";import{g as H}from"./chunk-74XWVHEF.js";import{i as D,j as L,k as N,r as R}from"./chunk-53FSC42K.js";import{Bb as P,Fa as s,Fb as n,Gb as d,Hb as x,Qb as w,Ra as C,S as y,Wa as f,Xb as z,ea as k,gb as p,hb as r,ib as i,jb as T,ub as g}from"./chunk-CPJK23XT.js";import"./chunk-X5YLR3NI.js";import{i as _}from"./chunk-ODN5LVDJ.js";var $=o=>["/soggetto",o];function q(o,e){o&1&&T(0,"app-page-loader",3)}function V(o,e){if(o&1&&(r(0,"div",27),n(1),i()),o&2){let t=g(2);s(),d(t.error)}}function j(o,e){if(o&1&&(r(0,"div",42),n(1),i()),o&2){let t=g().$implicit;s(),x(" Ref: ",t.prospect.referente," ")}}function G(o,e){if(o&1&&(r(0,"div"),n(1),i()),o&2){let t=g().$implicit;s(),d(t.prospect.telefono)}}function J(o,e){if(o&1&&(r(0,"div",43),n(1),i()),o&2){let t=g().$implicit;s(),x(" ",t.prospect.email," ")}}function Q(o,e){o&1&&(r(0,"div"),n(1,"\u2014"),i())}function W(o,e){if(o&1&&(r(0,"span",43),n(1),i()),o&2){let t=g().$implicit,a=g(3);s(),x(" ",a.truncate(t.esito.note,50)," ")}}function X(o,e){o&1&&(r(0,"span"),n(1,"\u2014"),i())}function Z(o,e){if(o&1&&(r(0,"tr")(1,"td",31)(2,"div",32)(3,"strong",33),n(4),i(),f(5,j,2,1,"div",34),i()(),r(6,"td",35)(7,"div",32),f(8,G,2,1,"div",2)(9,J,2,1,"div",36)(10,Q,2,0,"div",2),i()(),r(11,"td",37)(12,"div",32),n(13),i()(),r(14,"td",38)(15,"div",32)(16,"span",39),n(17),i()()(),r(18,"td",40)(19,"div",32),n(20),i()(),r(21,"td",41)(22,"div",32),f(23,W,2,1,"span",36)(24,X,2,0,"span",2),i()()()),o&2){let t=e.$implicit,a=g(3);s(3),p("routerLink",w(12,$,t.prospect.id)),s(),x(" ",t.prospect.ragione_sociale," "),s(),p("ngIf",t.prospect.referente),s(3),p("ngIf",t.prospect.telefono),s(),p("ngIf",t.prospect.email),s(),p("ngIf",!t.prospect.telefono&&!t.prospect.email),s(3),d(t.prospect.provincia||"\u2014"),s(3),p("ngClass",a.getBadgeClass(t.esito.tipo)),s(),x(" ",a.getTestoEsito(t.esito)," "),s(3),d(a.formatDate(t.dataEsito)),s(3),p("ngIf",t.esito.note),s(),p("ngIf",!t.esito.note)}}function tt(o,e){if(o&1&&(r(0,"div",28)(1,"table",29)(2,"thead")(3,"tr")(4,"th"),n(5,"Prospect"),i(),r(6,"th"),n(7,"Contatto"),i(),r(8,"th"),n(9,"Provincia"),i(),r(10,"th"),n(11,"Ultimo Esito"),i(),r(12,"th"),n(13,"Data Esito"),i(),r(14,"th"),n(15,"Note"),i()()(),r(16,"tbody"),f(17,Z,25,14,"tr",30),i()()()),o&2){let t=g(2);s(17),p("ngForOf",t.ultimiEsiti)}}function et(o,e){o&1&&(r(0,"div",44)(1,"i",45),n(2,"history"),i(),r(3,"p"),n(4,"Nessun esito recente trovato."),i(),r(5,"p",46),n(6,"I contatti con i prospect appariranno qui."),i()())}function it(o,e){if(o&1&&(r(0,"div")(1,"div",4)(2,"div",5)(3,"i",6),n(4,"dashboard"),i(),r(5,"div",7)(6,"h2",8),n(7,"Dashboard CRM"),i(),r(8,"p",9),n(9,"Panoramica rapida su attivit\xE0 e KPI"),i()()(),f(10,V,2,1,"div",10),r(11,"div",11)(12,"a",12)(13,"h3",13),n(14,"Totale Prospect"),i(),r(15,"div",14),n(16),i()(),r(17,"a",15)(18,"h3",13),n(19,"Totale Clienti"),i(),r(20,"div",14),n(21),i()(),r(22,"a",12)(23,"h3",13),n(24,"Da Richiamare"),i(),r(25,"div",14),n(26),i()(),r(27,"a",12)(28,"h3",13),n(29,"Senza Contatto"),i(),r(30,"div",14),n(31),i()(),r(32,"a",12)(33,"h3",13),n(34,"Configurati"),i(),r(35,"div",14),n(36),i()(),r(37,"a",16)(38,"h3",13),n(39,"Trattative YUVI"),i(),r(40,"div",14),n(41),i()(),r(42,"a",17)(43,"h3",13),n(44,"Trattative Promethea"),i(),r(45,"div",14),n(46),i()(),r(47,"a",18)(48,"h3",13),n(49,"Referenze da CTR"),i(),r(50,"div",14),n(51),i()()(),r(52,"div",19)(53,"a",20),n(54,"Nuovo Prospect"),i(),r(55,"a",21),n(56,"Nuova Trattativa YUVI"),i(),r(57,"a",22),n(58,"Visualizza KPI"),i()()(),r(59,"div",23)(60,"div",5)(61,"i",6),n(62,"history"),i(),r(63,"div",7)(64,"h3",8),n(65,"Ultimi Esiti"),i(),r(66,"p",9),n(67,"I contatti pi\xF9 recenti con i prospect"),i()()(),f(68,tt,18,1,"div",24)(69,et,7,0,"ng-template",null,0,z),r(71,"div",25)(72,"a",26),n(73,"Vai alla lista prospect"),i()()()()),o&2){let t=P(70),a=g();s(10),p("ngIf",a.error),s(6),d(a.kpi.prospect),s(5),d(a.kpi.clienti),s(5),d(a.kpi.daRichiamare),s(5),d(a.kpi.senzaContatto),s(5),d(a.kpi.configurati),s(5),d(a.kpi.trattativeYuvi),s(5),d(a.kpi.trattativePromethea),s(5),d(a.kpi.referenzeCtr),s(17),p("ngIf",a.ultimiEsiti.length>0)("ngIfElse",t)}}var O=class o{soggetti=y(U);supabase=y(A);authService=y(K);kpiService=y(F);isLoading=k(!0);error=null;kpi={prospect:0,clienti:0,daRichiamare:0,senzaContatto:0,configurati:0,trattativeYuvi:0,trattativePromethea:0,referenzeCtr:0};ultimiEsiti=[];ngOnInit(){this.caricaDashboard()}caricaDashboard(){return _(this,null,function*(){try{this.isLoading.set(!0),yield Promise.all([this.caricaKPI(),this.caricaUltimiEsiti()])}catch(e){console.error("Errore caricamento dashboard:",e),this.error=e.message||"Errore nel caricamento della dashboard"}finally{this.isLoading.set(!1)}})}caricaKPI(){return _(this,null,function*(){try{let e=0,t=0;if(this.soggetti&&typeof this.soggetti.countByTipo=="function"){let[a,l]=yield Promise.all([this.soggetti.countByTipo("prospect"),this.soggetti.countByTipo("cliente")]);a?.error||(e=Number(a.data??0)),l?.error||(t=Number(l.data??0))}else try{let[{count:a,error:l},{count:c,error:m}]=yield Promise.all([this.supabase.supabase.from("soggetti").select("id",{count:"exact",head:!0}).eq("tipo","prospect"),this.supabase.supabase.from("soggetti").select("id",{count:"exact",head:!0}).eq("tipo","cliente")]);l||(e=Number(a??0)),m||(t=Number(c??0))}catch(a){console.warn("Fallback conteggio soggetti fallito",a)}this.kpi.prospect=e,this.kpi.clienti=t;try{let a=yield this.kpiService.getKPIYuvi();this.kpi.trattativeYuvi=a?.totaleTrattative??this.kpi.trattativeYuvi}catch(a){console.warn("KPI Yuvi non disponibile",a)}try{let a=yield this.kpiService.getKPIPromethea();this.kpi.trattativePromethea=a?.totaleTrattative??this.kpi.trattativePromethea}catch(a){console.warn("KPI Promethea non disponibile",a)}}catch(e){throw console.error("Errore caricamento KPI:",e),new Error("Errore nel caricamento dei KPI")}})}caricaUltimiEsiti(){return _(this,null,function*(){try{let t=0,a=[];for(;;){let c=yield this.soggetti.getSoggettiByTipo("prospect",t,t+500-1);if(c.error)throw c.error;let m=c.data??[];if(a.push(...m),m.length<500||(t+=500,t>=5e3))break}let l=[];a.forEach(c=>{let m=Array.isArray(c.esiti)?c.esiti.filter(u=>u&&u.ts):[];if(m.length===0)return;let h=m.reduce((u,E)=>{try{return new Date(E.ts).getTime()>new Date(u.ts).getTime()?E:u}catch{return u}},m[0]);h&&l.push({prospect:c,esito:h,dataEsito:new Date(h.ts)})}),this.ultimiEsiti=l.sort((c,m)=>m.dataEsito.getTime()-c.dataEsito.getTime()).slice(0,10)}catch(e){throw console.error("Errore caricamento ultimi esiti:",e),this.ultimiEsiti=[],new Error("Errore nel caricamento degli ultimi esiti")}})}formatDate(e){return e.toLocaleDateString("it-IT")}getLastEsito(e){if(!Array.isArray(e)||e.length===0)return null;let t=e[0];for(let a of e)new Date(a.ts).getTime()>new Date(t.ts).getTime()&&(t=a);return t}getBadgeClass(e){switch(e){case"Richiamare":return"badge-warning";case"Appuntamento":case"Contratto Chiuso":return"badge-success";case"Non Interessato":return"badge-error";default:return"badge-info"}}getTestoEsito(e){if(!e)return"\u2014";let t=e,a=t.dataAppuntamento??t.data_appuntamento??t.appuntamento_ts;if(e.tipo==="Appuntamento"&&a){let l=new Date(a);if(!isNaN(l.getTime()))return`Appuntamento il ${this.formatDateTime(l)}`}if(e.tipo==="Richiamare"){let l=t.dataRichiamare??t.data_richiamare??t.richiamare_ts??t.callback_ts??t.ts_richiamare??t.ts??t.date;if(l){let c=new Date(l);if(!isNaN(c.getTime()))return`Richiamare il ${this.formatDateTime(c)}`}}return t.testo?t.testo:e.tipo||"\u2014"}formatDateTime(e){if(!e)return"\u2014";let t=e instanceof Date?e:new Date(e);return isNaN(t.getTime())?"\u2014":t.toLocaleString("it-IT",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}loadData(){return _(this,null,function*(){this.error=null;try{if(yield this.authService.getAuthState(),!this.authService.user()){this.error="Utente non autenticato. Effettua il login.";return}let[t,a,l,c,m,h]=yield Promise.all([this.soggetti.countByTipo("prospect"),this.soggetti.countByTipo("cliente"),this.soggetti.getSoggettiByTipo("prospect",0,199),this.supabase.supabase.from("trattative_yuvi").select("id",{count:"exact",head:!0}),this.supabase.supabase.from("configurazioni_promethea").select("id",{count:"exact",head:!0}),this.supabase.supabase.from("trattative_yuvi").select("nominativi_presi")]);if(console.log("\u{1F4CA} Dati caricati:",{prospect:t.data,clienti:a.data,trattative:c.count}),!t.error&&typeof t.data=="number"&&(this.kpi.prospect=t.data),!a.error&&typeof a.data=="number"&&(this.kpi.clienti=a.data),l.error)throw l.error;let u=l.data??[],E=0,I=0,Y=u.map(v=>this.verificaConfigurazioniProspect(v.id)),M=yield Promise.all(Y);for(let v=0;v<u.length;v++){let b=u[v],S=this.getLastEsito(b.esiti);S||E++,S&&S.tipo==="Richiamare"&&I++,M[v]&&this.kpi.configurati++}this.kpi.senzaContatto=E,this.kpi.daRichiamare=I,!c.error&&typeof c.count=="number"&&(this.kpi.trattativeYuvi=c.count),!m?.error&&typeof m?.count=="number"&&(this.kpi.trattativePromethea=m.count),!h.error&&Array.isArray(h.data)&&(this.kpi.referenzeCtr=h.data.reduce((v,b)=>v+(b.nominativi_presi??0),0)),console.log("\u2705 Home - Caricamento completato")}catch(e){console.error("\u274C Errore nel caricamento home:",e),this.error=e?.message||"Errore durante il caricamento della dashboard"}})}truncate(e,t=50){return e?e.length<=t?e:e.slice(0,t)+"...":"\u2014"}verificaConfigurazioniProspect(e){return _(this,null,function*(){try{let[t,a]=yield Promise.all([this.supabase.supabase.from("configurazioni_promethea").select("id").eq("prospect_id",e).maybeSingle(),this.supabase.supabase.from("trattative_yuvi").select("id").eq("prospect_id",e).maybeSingle()]);return!!(t.data||a.data)}catch(t){return console.warn(`\u26A0\uFE0F Errore verifica configurazioni per prospect ${e}:`,t),!1}})}static \u0275fac=function(t){return new(t||o)};static \u0275cmp=C({type:o,selectors:[["app-home"]],decls:2,vars:2,consts:[["emptyEsiti",""],["title","Caricamento Dashboard","subtitle","Stiamo preparando i tuoi dati...",4,"ngIf"],[4,"ngIf"],["title","Caricamento Dashboard","subtitle","Stiamo preparando i tuoi dati..."],[1,"form-section"],[1,"section-header"],[1,"material-icons","header-icon"],[1,"section-titles"],[1,"section-title"],[1,"sottotitolo"],["class","status-message error",4,"ngIf"],[1,"prospect-cards"],["routerLink","/lista-prospect",1,"card","clickable"],[1,"card-title"],[1,"card-number"],["routerLink","/clienti",1,"card","clickable"],["routerLink","/yuvi-trattativa",1,"card","clickable"],["routerLink","/alchemizzatore",1,"card","clickable"],["routerLink","/visualizzazione-kpi",1,"card","clickable"],[1,"actions-container",2,"margin-top","var(--gutter-lg)","justify-content","center"],["routerLink","/aggiungi-prospect",1,"promethea-button","outline"],["routerLink","/yuvi-trattativa",1,"promethea-button"],["routerLink","/visualizzazione-kpi",1,"promethea-button","secondary"],[1,"form-section",2,"margin-top","var(--gutter-lg)"],["class","table-container",4,"ngIf","ngIfElse"],[1,"actions-container",2,"margin-top","var(--gutter-md)"],["routerLink","/lista-prospect",1,"promethea-button","secondary"],[1,"status-message","error"],[1,"table-container"],[1,"crm-table"],[4,"ngFor","ngForOf"],["data-label","Prospect"],[1,"cell-content"],["title","Apri scheda soggetto",1,"link",3,"routerLink"],["class","text-muted","style","font-size: 0.875rem; margin-top: 4px;",4,"ngIf"],["data-label","Contatto"],["class","text-muted","style","font-size: 0.875rem;",4,"ngIf"],["data-label","Provincia"],["data-label","Ultimo Esito"],[1,"badge",3,"ngClass"],["data-label","Data Esito"],["data-label","Note"],[1,"text-muted",2,"font-size","0.875rem","margin-top","4px"],[1,"text-muted",2,"font-size","0.875rem"],[1,"empty-state"],[1,"material-icons",2,"font-size","48px","color","var(--text-muted)","margin-bottom","16px"],[1,"text-muted",2,"margin-top","8px"]],template:function(t,a){t&1&&f(0,q,1,0,"app-page-loader",1)(1,it,74,11,"div",2),t&2&&(p("ngIf",a.isLoading()),s(),p("ngIf",!a.isLoading()))},dependencies:[R,D,L,N,H,B],styles:["a.card[_ngcontent-%COMP%]{text-decoration:none;color:inherit}.form-section[_ngcontent-%COMP%] + .form-section[_ngcontent-%COMP%]{margin-top:var(--gutter-lg)}"]})};export{O as Home};
