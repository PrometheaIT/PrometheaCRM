import{b as C}from"./chunk-Q4FMGKSF.js";import{N as v,S as _}from"./chunk-PE6PP35I.js";import{a as b,b as d,i as f}from"./chunk-ODN5LVDJ.js";var P=class g{supabaseService=_(C);getKPIYuvi(t){return f(this,null,function*(){try{let e=this.supabaseService.supabase.from("trattative_yuvi").select("*, soggetti!inner(*)").order("created_at",{ascending:!1});t&&(e=e.eq("soggetti.created_by",t));let{data:a,error:r}=yield e,i=this.supabaseService.supabase.from("trattative_yuvi").select("nominativi_presi, soggetti!inner(created_by)");t&&(i=i.eq("soggetti.created_by",t));let{data:u,error:n}=yield i,s=0;u&&!n&&(s=u.reduce((o,m)=>o+(m.nominativi_presi||0),0)),r&&console.error("Errore KPI (trattative):",r),n&&console.error("Errore conteggio referenze da CTR:",n);let l=this.calcolaKPI(a||[]),c=this.raccogliDettagliSoftware(a||[]);return d(b({},l),{referenzeDaCtr:s,dettagliSoftware:c})}catch(e){return console.error("Errore generale KPI:",e),this.getKPIEmpty()}})}raccogliDettagliSoftware(t){let e={};return t.forEach(a=>{if(a.motivazione==="usano_software_proprio"&&a.risposte_questionario){let r=a.risposte_questionario,i="Non specificato";r.domanda_software&&r.domanda_software.nome_software?i=r.domanda_software.nome_software:r.domanda_software&&r.domanda_software.utilizza_software==="si"&&(i="Software non specificato"),i&&(e[i]=(e[i]||0)+1)}}),e}calcolaKPI(t){let e=new Date,a=new Date(e.getFullYear(),e.getMonth(),1),r=t.length,i=t.filter(o=>o.esito==="contratto_chiuso"),u=i.filter(o=>new Date(o.created_at)>=a),n=i.filter(o=>o.nominativi_presi&&o.nominativi_presi>0),s=t.filter(o=>o.esito==="da_richiamare").length,l=t.filter(o=>o.esito==="non_chiuso"),c={};return l.forEach(o=>{o.motivazione&&(c[o.motivazione]=(c[o.motivazione]||0)+1)}),{totaleTrattative:r,contrattiChiusiTotali:i.length,contrattiChiusiMeseCorrente:u.length,percentualeChiusiTotali:r>0?i.length/r*100:0,percentualeChiusiMese:r>0?u.length/r*100:0,percentualeNominativiPresi:i.length>0?n.length/i.length*100:0,percentualeDaRichiamare:r>0?s/r*100:0,motivazioniNonChiusi:c,referenzeDaCtr:0,dettagliSoftware:{}}}getKPIEmpty(){return{totaleTrattative:0,contrattiChiusiTotali:0,contrattiChiusiMeseCorrente:0,percentualeChiusiTotali:0,percentualeChiusiMese:0,percentualeNominativiPresi:0,percentualeDaRichiamare:0,motivazioniNonChiusi:{},referenzeDaCtr:0,dettagliSoftware:{}}}getProspectKPI(){return f(this,null,function*(){let{data:t,error:e}=yield this.supabaseService.supabase.rpc("get_prospect_kpi");if(e)return console.error("get_prospect_kpi error",e),{totale:0,senzaContatto:0,daRichiamare:0,configurati:0};let a=(Array.isArray(t)?t[0]:t)||{};return{totale:a.totale??0,senzaContatto:a.senza_contatto??0,daRichiamare:a.da_richiamare??0,configurati:a.configurati??0}})}getAnagraficaKPI(t){return f(this,null,function*(){let{data:e,error:a}=yield this.supabaseService.supabase.rpc("get_anagrafica_kpi",{p_tipo:t});if(a)return console.error("get_anagrafica_kpi error",t,a),{totale:0,conIban:0,conReferente:0};let r=(Array.isArray(e)?e[0]:e)||{};return{totale:r.totale??0,conIban:r.con_iban??0,conReferente:r.con_referente??0}})}getKPIPromethea(t){return f(this,null,function*(){try{let e=this.supabaseService.supabase.from("configurazioni_promethea").select("*, soggetti!inner(*)").order("created_at",{ascending:!1});t&&(e=e.eq("soggetti.created_by",t));let{data:a,error:r}=yield e;if(r)return console.error("getKPIPromethea error",r),this.getKPIEmpty();let i=new Date,u=new Date(i.getFullYear(),i.getMonth(),1),n=(a??[]).length,s=(a??[]).filter(h=>Number(h.totale)>0).length,l=(a??[]).filter(h=>new Date(h.created_at)>=u).length,c=this.supabaseService.supabase.from("soggetti").select("id, created_at, created_by").eq("prodotto","Promethea").ilike("note","%Creato da configurazione Promethea%");t&&(c=c.eq("created_by",t));let{data:o,error:m}=yield c;m&&console.error("Errore conteggio nominativi Promethea:",m);let p=Array.isArray(o)?o.length:0,w=s>0?p/s*100:n>0?p/n*100:0;return{totaleTrattative:n,contrattiChiusiTotali:s,contrattiChiusiMeseCorrente:l,percentualeChiusiTotali:n>0?s/n*100:0,percentualeChiusiMese:n>0?l/n*100:0,percentualeNominativiPresi:Math.round(w*100)/100,percentualeDaRichiamare:0,motivazioniNonChiusi:{},referenzeDaCtr:p,dettagliSoftware:{}}}catch(e){return console.error("getKPIPromethea exception",e),this.getKPIEmpty()}})}static \u0275fac=function(e){return new(e||g)};static \u0275prov=v({token:g,factory:g.\u0275fac,providedIn:"root"})};export{P as a};
