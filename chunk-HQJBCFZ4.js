import{b}from"./chunk-Q4FMGKSF.js";import{N as k,S as T}from"./chunk-PE6PP35I.js";import{a as i,b as n,i as o}from"./chunk-ODN5LVDJ.js";var f=class l{supabaseService=T(b);STATI_MACRO={da_fare:"Da Fare",in_lavorazione:"In Lavorazione",completato:"Completato",in_attesa:"In Attesa"};PRIORITA_MAP={1:"Minima",2:"Bassa",3:"Media",4:"Alta",5:"Urgente"};MODULI_MAP={immagine_marketing:"Immagine e Marketing",digitalizzazione_automatismi:"Digitalizzazione e Automatismi",contabilita_fiscalita:"Contabilit\xE0 e Fiscalit\xE0",ottimizzazione_management:"Ottimizzazione e Management"};getMacroTasks(){return o(this,null,function*(){let{data:a,error:t}=yield this.supabaseService.supabase.from("macro_tasks").select(`
        *,
        cliente:cliente_id (id, ragione_sociale, provincia),
        sotto_tasks (
          *,
          task_dettaglio (*)
        )
      `).order("created_at",{ascending:!1});return a&&a.forEach(e=>this.calcolaMetricheTask(e)),{data:a,error:t}})}getMacroTaskById(a){return o(this,null,function*(){let{data:t,error:e}=yield this.supabaseService.supabase.from("macro_tasks").select(`
        *,
        cliente:cliente_id (*),
        sotto_tasks (
          *,
          task_dettaglio (*)
        )
      `).eq("id",a).single();return t&&this.calcolaMetricheTask(t),{data:t,error:e}})}createMacroTask(a){return o(this,null,function*(){let t=new Date().toISOString(),e={nome:a.nome,data_scadenza:a.data_scadenza,note:a.note||"",stato:a.stato||"da_fare",progresso:a.progresso||0,priorita_globale:a.priorita_globale||1,extra_data:{},created_at:t,updated_at:t};a.cliente_id&&this.isValidUUID(a.cliente_id)&&(e.cliente_id=a.cliente_id),a.assegnazione_id&&(e.assegnazione_id=a.assegnazione_id);let{data:s,error:r}=yield this.supabaseService.supabase.from("macro_tasks").insert([e]).select("id").maybeSingle();return{data:s,error:r}})}isValidUUID(a){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(a)}updateMacroTask(a,t){return o(this,null,function*(){let e=n(i({},t),{updated_at:new Date().toISOString()}),{data:s,error:r}=yield this.supabaseService.supabase.from("macro_tasks").update(e).eq("id",a).select(`
        *,
        cliente:cliente_id (*)
      `).single();return{data:s,error:r}})}createSottoTask(a){return o(this,null,function*(){let t=new Date().toISOString(),{data:e,error:s}=yield this.supabaseService.supabase.from("sotto_tasks").insert([n(i({},a),{stato:"da_fare",created_at:t,updated_at:t})]).select().single();return e&&(yield this.aggiornaMacroTaskAutomaticamente(a.macro_task_id)),{data:e,error:s}})}updateSottoTask(a,t){return o(this,null,function*(){let{data:e}=yield this.supabaseService.supabase.from("sotto_tasks").select("id, macro_task_id").eq("id",a).single();if(!e)return{data:null,error:{message:"Sotto-task non trovata",details:"",hint:"",code:"404"}};let{data:s,error:r}=yield this.supabaseService.supabase.from("sotto_tasks").update(n(i({},t),{updated_at:new Date().toISOString()})).eq("id",a).select().single();return s&&e.macro_task_id&&(yield this.aggiornaMacroTaskAutomaticamente(e.macro_task_id)),{data:s,error:r}})}createTaskDettaglio(a){return o(this,null,function*(){let t=new Date().toISOString(),{data:e,error:s}=yield this.supabaseService.supabase.from("task_dettaglio").insert([n(i({},a),{completato:!1,data_completamento:null,created_at:t,updated_at:t})]).select().single();return{data:e,error:s}})}toggleTaskDettaglioCompletato(a,t){return o(this,null,function*(){let e={completato:t,data_completamento:t?new Date().toISOString():null,updated_at:new Date().toISOString()},{data:s,error:r}=yield this.supabaseService.supabase.from("task_dettaglio").update(e).eq("id",a).select().single();return{data:s,error:r}})}deleteTaskDettaglio(a){return o(this,null,function*(){let{error:t}=yield this.supabaseService.supabase.from("task_dettaglio").delete().eq("id",a);return{data:null,error:t}})}deleteMacroTaskCascade(a){return o(this,null,function*(){try{let{error:t}=yield this.supabaseService.supabase.from("macro_tasks").delete().eq("id",a);return{data:null,error:t}}catch(t){return{data:null,error:t}}})}calcolaMetricheTask(a){a.progresso=this.calcolaProgressoAutomatico(a.sotto_tasks||[]),a.stato=this.calcolaStatoMacroTaskAutomatico(a.sotto_tasks||[])}calcolaProgressoAutomatico(a){if(!a.length)return 0;let t=a.filter(e=>e.stato==="completato").length;return Math.round(t/a.length*100)}calcolaStatoMacroTaskAutomatico(a){if(!a.length)return"da_fare";let t=a.every(s=>s.stato==="completato"),e=a.some(s=>s.stato==="in_lavorazione"||s.stato==="completato");return t?"completato":e?"in_lavorazione":"da_fare"}aggiornaMacroTaskAutomaticamente(a){return o(this,null,function*(){let{data:t}=yield this.getMacroTaskById(a);t&&(yield this.updateMacroTask(a,{progresso:t.progresso,stato:t.stato,priorita_globale:this.calcolaPrioritaGlobale(t.sotto_tasks||[])}))})}calcolaPrioritaGlobale(a){return a.length>0?Math.max(...a.map(t=>t.priorita)):1}getSottoTaskCounts(a){return{daFare:a.filter(t=>t.stato==="da_fare").length,inLavorazione:a.filter(t=>t.stato==="in_lavorazione").length,completate:a.filter(t=>t.stato==="completato").length}}getNomePriorita(a){return this.PRIORITA_MAP[a]||"Non definita"}getStatoTesto(a){return this.STATI_MACRO[a]||a}getModuloName(a){return a?{immagine:"Immagine",digitalizzazione:"Digitalizzazione",contabilita:"Contabilit\xE0",ottimizzazione:"Ottimizzazione"}[a]||"Modulo sconosciuto":"Modulo non assegnato"}updateTaskDettaglio(a,t){return o(this,null,function*(){let{data:e,error:s}=yield this.supabaseService.supabase.from("task_dettaglio").update(n(i({},t),{updated_at:new Date().toISOString()})).eq("id",a).select().single();return{data:e,error:s}})}getStatoBadgeClass(a){return{completato:"status-yes",in_lavorazione:"status-warning",in_attesa:"status-info",da_fare:"status-badge"}[a]||"status-badge"}getPrioritaBadgeClass(a){return{5:"status-no",4:"status-warning",3:"status-info",2:"status-badge",1:"status-badge"}[a]||"status-badge"}isScadenzaImminente(a){let t=new Date(a),e=new Date,s=Math.ceil((t.getTime()-e.getTime())/(1e3*3600*24));return s<=3&&s>=0}isScaduta(a){return new Date(a)<new Date}getMacroTaskTemplates(){return o(this,null,function*(){let{data:a,error:t}=yield this.supabaseService.supabase.from("macro_task_templates").select("*").order("nome",{ascending:!0});return{data:a,error:t}})}createMacroTaskTemplate(a){return o(this,null,function*(){let{data:t,error:e}=yield this.supabaseService.supabase.from("macro_task_templates").insert([n(i({},a),{created_at:new Date().toISOString(),updated_at:new Date().toISOString()})]).select().single();return{data:t,error:e}})}createMacroTaskFromTemplate(a,t,e){return o(this,null,function*(){try{let{data:s,error:r}=yield this.supabaseService.supabase.from("macro_task_templates").select("*").eq("id",a).single();if(r)return{data:null,error:r};let S={nome:s.nome,data_scadenza:e,cliente_id:t,assegnazione_id:s.modulo,note:s.descrizione||"",stato:"da_fare"},{data:d,error:m}=yield this.createMacroTask(S);if(m)return{data:null,error:m};if(!d?.id)return{data:null,error:{message:"ID non restituito dalla creazione della macro task",details:"",hint:"",code:"no-id"}};let p=s.struttura_template||{},M=Array.isArray(p.sotto_tasks)?p.sotto_tasks:[];for(let c of M){let D={nome:c.nome,priorita:c.priorita,macro_task_id:d.id},{data:_,error:h}=yield this.createSottoTask(D);if(h||!_)continue;let z=Array.isArray(c.task_dettaglio)?c.task_dettaglio:[];for(let u of z){let g=new Date,v=Number(u.data_scadenza_prevista_offset)||0;g.setDate(g.getDate()+v);let y={nome:u.nome,descrizione:u.descrizione||"",data_scadenza_prevista:g.toISOString().split("T")[0],sotto_task_id:_.id};yield this.createTaskDettaglio(y)}}return yield this.getMacroTaskById(d.id)}catch(s){return{data:null,error:s}}})}static \u0275fac=function(t){return new(t||l)};static \u0275prov=k({token:l,factory:l.\u0275fac,providedIn:"root"})};export{f as a};
