import{b as S,c as P}from"./chunk-Q4FMGKSF.js";import{N as y,S as z}from"./chunk-PE6PP35I.js";import{a as C,b as _,i as d}from"./chunk-ODN5LVDJ.js";var N=class m{supabaseService=z(S);authService=z(P);ALLOW_CLIENT_GEOCODING=!0;coordinateCache=new Map;provinceFallback={Roma:{lat:41.9028,lng:12.4964,indirizzo:"Roma"},Milano:{lat:45.4642,lng:9.19,indirizzo:"Milano"},Napoli:{lat:40.8518,lng:14.2681,indirizzo:"Napoli"},Torino:{lat:45.0703,lng:7.6869,indirizzo:"Torino"},Palermo:{lat:38.1157,lng:13.3615,indirizzo:"Palermo"},Genova:{lat:44.4056,lng:8.9463,indirizzo:"Genova"},Bologna:{lat:44.4949,lng:11.3426,indirizzo:"Bologna"},Firenze:{lat:43.7696,lng:11.2558,indirizzo:"Firenze"},Bari:{lat:41.1171,lng:16.8719,indirizzo:"Bari"},Catania:{lat:37.5079,lng:15.083,indirizzo:"Catania"},Venezia:{lat:45.4408,lng:12.3155,indirizzo:"Venezia"},Verona:{lat:45.4384,lng:10.9916,indirizzo:"Verona"},Trieste:{lat:45.6495,lng:13.7768,indirizzo:"Trieste"},Ancona:{lat:43.6158,lng:13.5189,indirizzo:"Ancona"}};constructor(){Object.entries(this.provinceFallback).forEach(([i,e])=>{this.coordinateCache.set(i.toLowerCase(),e)})}loadSoggettiPerMappa(i){return d(this,null,function*(){let e=this.authService.user(),n=yield this.supabaseService.isAdmin(),a=i?.includeFornitori?["prospect","cliente","fornitore"]:["prospect","cliente"],o=this.supabaseService.supabase.from("soggetti").select("id, tipo, ragione_sociale, referente, telefono, email, provincia, comune, indirizzo, numero_civico, prodotto, latitude, longitude").in("tipo",a);!n&&e&&(o=o.eq("created_by",e.id));let{data:l,error:s}=yield o;if(s||!l)return s&&console.error("Errore loadSoggettiPerMappa:",s),[];let u=l.map(t=>{let f=this.resolveCoordinate(t);return{id:t.id,ragione_sociale:t.ragione_sociale,referente:t.referente??null,telefono:t.telefono??null,email:t.email??null,provincia:t.provincia??null,comune:t.comune??null,indirizzo:t.indirizzo??null,numero_civico:t.numero_civico??null,prodotto:t.prodotto??null,tipo:this.normalizeTipo(t.tipo),coordinate:f,hasCoordinate:!!f,configurato:!1,hasConfigPromethea:!1,hasTrattativaYuvi:!1,ultimoEsito:null}}),r=u.map(t=>t.id);if(!r.length)return u;let c=this.supabaseService.supabase.from("configurazioni_promethea").select("prospect_id").in("prospect_id",r),g=this.supabaseService.supabase.from("trattative_yuvi").select("prospect_id").in("prospect_id",r),h=this.supabaseService.supabase.from("esiti").select("soggetto_id, esito, created_at").in("soggetto_id",r).order("created_at",{ascending:!1});!n&&e&&(c=c.eq("created_by",e.id),g=g.eq("created_by",e.id),h=h.eq("created_by",e.id));let[w,k,p]=yield Promise.all([c,g,h]),I=new Set((w.data??[]).map(t=>t.prospect_id)),F=new Set((k.data??[]).map(t=>t.prospect_id)),v=new Map;if(!p.error&&p.data)for(let t of p.data)v.has(t.soggetto_id)||v.set(t.soggetto_id,t.esito??null);else p.error&&console.warn("Errore recupero ultimo esito:",p.error);return u.map(t=>{let f=I.has(t.id),b=F.has(t.id);return _(C({},t),{hasConfigPromethea:f,hasTrattativaYuvi:b,configurato:f||b,ultimoEsito:v.get(t.id)??null})})})}getProvinceConSoggetti(){return d(this,null,function*(){let i=this.authService.user(),e=yield this.supabaseService.isAdmin(),n=this.supabaseService.supabase.from("soggetti").select("provincia").in("tipo",["prospect","cliente"]);!e&&i&&(n=n.eq("created_by",i.id));let{data:a,error:o}=yield n;if(o||!a)return o&&console.error("Errore getProvinceConSoggetti:",o),[];let l=a.reduce((r,c)=>(c.provincia&&(r[c.provincia]=(r[c.provincia]??0)+1),r),{}),s=Object.entries(l),u=[];for(let[r,c]of s){let g=yield this.getCoordinateProvincia(r);g&&u.push({nome:r,coordinate:g,conteggio:c})}return u.sort((r,c)=>c.conteggio-r.conteggio)})}getProvinciaUtenteCorrente(){return d(this,null,function*(){let i=this.authService.user();if(!i)return null;let{data:e,error:n}=yield this.supabaseService.supabase.from("app_users").select("provincia").eq("id",i.id).single();return n?(console.warn("Provincia utente non reperita:",n),null):e?.provincia??null})}getCoordinateProvincia(i){return d(this,null,function*(){let e=i?.toLowerCase();if(!e)return null;if(this.coordinateCache.has(e))return this.coordinateCache.get(e);let n=yield this.geocodificaIndirizzo(void 0,i);return n&&this.coordinateCache.set(e,n),n??null})}geocodificaSoggetto(i){return d(this,null,function*(){return this.geocodificaIndirizzo(i.comune,i.provincia,i.indirizzo,i.numero_civico)})}geocodificaSoggettiBatch(i){return d(this,null,function*(){let e=new Map,n=5;for(let a=0;a<i.length;a+=n){let o=i.slice(a,a+n);yield Promise.all(o.map(l=>d(this,null,function*(){let s=yield this.geocodificaSoggetto(l);s&&e.set(l.id,s)}))),a+n<i.length&&(yield new Promise(l=>setTimeout(l,1e3)))}return e})}normalizeTipo(i){return i==="cliente"?"cliente":i==="fornitore"?"fornitore":"prospect"}resolveCoordinate(i){let e=o=>o==null?NaN:typeof o=="number"?o:Number(o.toString().trim().replace(",",".")),n=e(i.latitude),a=e(i.longitude);if(!Number.isNaN(n)&&!Number.isNaN(a)&&Math.abs(n)<=90&&Math.abs(a)<=180&&!(n===0&&a===0)){let o=[i.indirizzo,i.numero_civico,i.comune,i.provincia].filter(Boolean).join(" ").trim();return{lat:n,lng:a,indirizzo:o||`${i.comune??""} ${i.provincia??""}`.trim()}}return i.provincia&&this.provinceFallback[i.provincia]?this.provinceFallback[i.provincia]:null}geocodificaIndirizzo(i,e,n,a){return d(this,null,function*(){let o=[n,a,i,e].filter(Boolean).map(s=>s.toLowerCase().trim());if(!o.length)return null;let l=o.join("|");if(this.coordinateCache.has(l))return this.coordinateCache.get(l);if(!this.ALLOW_CLIENT_GEOCODING){let s=e?this.provinceFallback[e]:void 0;return s?(this.coordinateCache.set(l,s),s):null}try{let s=[n?`${n}${a?` ${a}`:""}`:null,i,e,"Italia"].filter(Boolean).join(", "),u=yield fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(s)}&limit=1`,{headers:{"Accept-Language":"it"}});if(!u.ok)throw new Error(`Nominatim ${u.status}`);let r=yield u.json();if(Array.isArray(r)&&r.length>0){let g={lat:parseFloat(r[0].lat),lng:parseFloat(r[0].lon),indirizzo:r[0].display_name};return this.coordinateCache.set(l,g),g}let c=e?this.provinceFallback[e]:void 0;return c?(this.coordinateCache.set(l,c),c):null}catch(s){console.warn("Geocodifica fallita, uso fallback provincia:",s);let u=e?this.provinceFallback[e]:void 0;return u?(this.coordinateCache.set(l,u),u):null}})}static \u0275fac=function(e){return new(e||m)};static \u0275prov=y({token:m,factory:m.\u0275fac,providedIn:"root"})};export{N as a};
