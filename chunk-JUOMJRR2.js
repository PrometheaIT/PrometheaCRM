import{a as N}from"./chunk-Y2XJCRVM.js";import{b as C,c as k}from"./chunk-3ZXX2K2L.js";import{N as E,S}from"./chunk-6W5NKFNP.js";import{a as I,b as B,i as l}from"./chunk-ODN5LVDJ.js";var w=class y{supabaseService=S(C);authService=S(k);ALLOW_CLIENT_GEOCODING=!0;coordinateCache=new Map;provinceFallback={Roma:{lat:41.9028,lng:12.4964,indirizzo:"Roma"},Milano:{lat:45.4642,lng:9.19,indirizzo:"Milano"},Napoli:{lat:40.8518,lng:14.2681,indirizzo:"Napoli"},Torino:{lat:45.0703,lng:7.6869,indirizzo:"Torino"},Palermo:{lat:38.1157,lng:13.3615,indirizzo:"Palermo"},Genova:{lat:44.4056,lng:8.9463,indirizzo:"Genova"},Bologna:{lat:44.4949,lng:11.3426,indirizzo:"Bologna"},Firenze:{lat:43.7696,lng:11.2558,indirizzo:"Firenze"},Bari:{lat:41.1171,lng:16.8719,indirizzo:"Bari"},Catania:{lat:37.5079,lng:15.083,indirizzo:"Catania"},Venezia:{lat:45.4408,lng:12.3155,indirizzo:"Venezia"},Verona:{lat:45.4384,lng:10.9916,indirizzo:"Verona"},Trieste:{lat:45.6495,lng:13.7768,indirizzo:"Trieste"},Ancona:{lat:43.6158,lng:13.5189,indirizzo:"Ancona"}};constructor(){Object.entries(this.provinceFallback).forEach(([e,t])=>{this.coordinateCache.set(e.toLowerCase(),t)})}loadSoggettiPerMappa(e){return l(this,null,function*(){let t=this.authService.user(),r=yield this.supabaseService.isAdmin(),i=e?.includeFornitori?["prospect","cliente","fornitore"]:["prospect","cliente"],o=this.supabaseService.supabase.from("soggetti").select(`id, tipo, ragione_sociale, referente, telefono, email, provincia, comune, indirizzo, numero_civico,
        prodotto, latitude, longitude, created_at, updated_at, created_by, piva, formula_societaria, categoria_ateco,
        sito_web, facebook, instagram, metodo_pagamento, iban, note, esiti, "Modulo", referenza_da_id`).in("tipo",i);!r&&t&&(o=o.eq("created_by",t.id));let{data:a,error:n}=yield o;if(n||!a)return n&&console.error("Errore loadSoggettiPerMappa:",n),[];let c=(a??[]).map(s=>{let p=s.created_at??s.createdAt??new Date().toISOString(),f=s.updated_at??s.updatedAt??p,h=s.latitude??s.lat??null,z=s.longitude??s.lng??null,m=h!=null&&z!=null;return{id:s.id,tipo:s.tipo,ragione_sociale:s.ragione_sociale??s.ragioneSociale??"",piva:s.piva??null,formula_societaria:s.formula_societaria??s.formulaSocietaria??null,categoria_ateco:s.categoria_ateco??null,referente:s.referente??null,telefono:s.telefono??null,email:s.email??null,sito_web:s.sito_web??null,facebook:s.facebook??null,instagram:s.instagram??null,metodo_pagamento:s.metodo_pagamento??null,iban:s.iban??null,provincia:s.provincia??null,comune:s.comune??null,indirizzo:s.indirizzo??null,numero_civico:s.numero_civico??s.numeroCivico??null,note:s.note??null,prodotto:s.prodotto??"Promethea",esiti:s.esiti??[],Modulo:s.Modulo??null,created_at:p,updated_at:f,created_by:s.created_by??null,latitude:h,longitude:z,referenza_da_id:s.referenza_da_id??null,coordinate:m?{lat:h,lng:z}:null,hasCoordinate:m,configurato:!1,hasConfigPromethea:!1,hasTrattativaYuvi:!1,ultimoEsito:null}}),g=c.map(s=>s.id);if(!g.length)return c;console.log("\u{1F50D} Verifica configurazioni per IDs:",g);try{let p=[],f=[],h=[];for(let u=0;u<g.length;u+=500)h.push(g.slice(u,u+500));let z=h.map(u=>this.supabaseService.supabase.from("configurazioni_promethea").select("prospect_id").in("prospect_id",u)),m=h.map(u=>this.supabaseService.supabase.from("trattative_yuvi").select("prospect_id").in("prospect_id",u));(yield Promise.allSettled(z)).forEach((u,v)=>{if(u.status==="fulfilled"){let{data:b,error:_}=u.value;_?console.warn(`Batch config error (batch ${v}):`,_):Array.isArray(b)&&p.push(...b)}else console.warn(`Batch config rejected (batch ${v}):`,u.reason)}),(yield Promise.allSettled(m)).forEach((u,v)=>{if(u.status==="fulfilled"){let{data:b,error:_}=u.value;_?console.warn(`Batch trattative error (batch ${v}):`,_):Array.isArray(b)&&f.push(...b)}else console.warn(`Batch trattative rejected (batch ${v}):`,u.reason)});let A=new Set(p.map(u=>u.prospect_id)),M=new Set(f.map(u=>u.prospect_id));console.log("\u{1F3AF} ID TROVATI (chunked):",{configuratiPromethea:Array.from(A).slice(0,50),configuratiYuvi:Array.from(M).slice(0,50),totalConfigurazioni:A.size,totalTrattative:M.size});let $=c.map(u=>{let v=A.has(u.id),b=M.has(u.id),_=v||b;return B(I({},u),{hasConfigPromethea:v,hasTrattativaYuvi:b,configurato:_,ultimoEsito:u.esiti&&u.esiti.length>0?u.esiti[u.esiti.length-1].tipo:null})}),O=$.filter(u=>u.configurato).length;return console.log(`\u{1F4C8} TOTALE SOGGETTI CONFIGURATI: ${O}/${$.length}`),$}catch(s){return console.error("\u{1F4A5} Errore critico nel caricamento configurazioni:",s),c}})}getProvinceConSoggetti(){return l(this,null,function*(){let e=this.authService.user(),t=yield this.supabaseService.isAdmin(),r=this.supabaseService.supabase.from("soggetti").select("provincia").in("tipo",["prospect","cliente"]);!t&&e&&(r=r.eq("created_by",e.id));let{data:i,error:o}=yield r;if(o||!i)return o&&console.error("Errore getProvinceConSoggetti:",o),[];let a=i.reduce((c,g)=>(g.provincia&&(c[g.provincia]=(c[g.provincia]??0)+1),c),{}),n=Object.entries(a),d=[];for(let[c,g]of n){let s=Object.keys(this.provinceFallback).find(p=>p.toLowerCase()===c.toLowerCase());if(s){let p=this.provinceFallback[s];d.push({nome:c,coordinate:p,conteggio:g})}else{console.warn(`Provincia non trovata nel fallback: ${c}`);let p=yield this.getCoordinateProvinciaSemplice(c);p&&d.push({nome:c,coordinate:p,conteggio:g})}}return d.sort((c,g)=>g.conteggio-c.conteggio)})}getCoordinateProvinciaSemplice(e){return l(this,null,function*(){let t=e.toLowerCase();if(this.coordinateCache.has(t))return this.coordinateCache.get(t);let i=B(I({},this.provinceFallback),{Udine:{lat:46.0647,lng:13.24,indirizzo:"Udine"},Pordenone:{lat:45.9544,lng:12.6575,indirizzo:"Pordenone"},Gorizia:{lat:45.9414,lng:13.6217,indirizzo:"Gorizia"},Trieste:{lat:45.6495,lng:13.7768,indirizzo:"Trieste"},Torino:{lat:45.0703,lng:7.6869,indirizzo:"Torino"},Vercelli:{lat:45.321,lng:8.426,indirizzo:"Vercelli"},Novara:{lat:45.445,lng:8.616,indirizzo:"Novara"},Cuneo:{lat:44.388,lng:7.547,indirizzo:"Cuneo"},Asti:{lat:44.9,lng:8.206,indirizzo:"Asti"},Alessandria:{lat:44.913,lng:8.616,indirizzo:"Alessandria"},Imperia:{lat:43.887,lng:8.03,indirizzo:"Imperia"}})[e];return i?(this.coordinateCache.set(t,i),i):(console.warn(`Nessun fallback per provincia: ${e}`),null)})}getProvinciaUtenteCorrente(){return l(this,null,function*(){let e=this.authService.user();if(!e)return null;let{data:t,error:r}=yield this.supabaseService.supabase.from("app_users").select("provincia").eq("id",e.id).single();return r?(console.warn("Provincia utente non reperita:",r),null):t?.provincia??null})}getCoordinateProvincia(e){return l(this,null,function*(){let t=e?.toLowerCase();if(!t)return null;if(this.coordinateCache.has(t))return this.coordinateCache.get(t);let r=yield this.geocodificaIndirizzo(void 0,e);return r&&this.coordinateCache.set(t,r),r??null})}geocodificaSoggetto(e){return l(this,null,function*(){return this.geocodificaIndirizzo(e.comune,e.provincia,e.indirizzo,e.numero_civico)})}geocodificaSoggettiBatch(e){return l(this,null,function*(){let t=new Map,r=5;for(let i=0;i<e.length;i+=r){let o=e.slice(i,i+r);yield Promise.all(o.map(a=>l(this,null,function*(){let n=yield this.geocodificaSoggetto(a);n&&t.set(a.id,n)}))),i+r<e.length&&(yield new Promise(a=>setTimeout(a,1e3)))}return t})}normalizeTipo(e){return e==="cliente"?"cliente":e==="fornitore"?"fornitore":"prospect"}resolveCoordinate(e){let t=o=>o==null?NaN:typeof o=="number"?o:Number(o.toString().trim().replace(",",".")),r=t(e.latitude),i=t(e.longitude);if(!Number.isNaN(r)&&!Number.isNaN(i)&&Math.abs(r)<=90&&Math.abs(i)<=180&&!(r===0&&i===0)){let o=[e.indirizzo,e.numero_civico,e.comune,e.provincia].filter(Boolean).join(" ").trim();return{lat:r,lng:i,indirizzo:o||`${e.comune??""} ${e.provincia??""}`.trim()}}return e.provincia&&this.provinceFallback[e.provincia]?this.provinceFallback[e.provincia]:null}geocodificaIndirizzo(e,t,r,i){return l(this,null,function*(){let o=[r,i,e,t].filter(Boolean).map(n=>n.toLowerCase().trim());if(!o.length)return null;let a=o.join("|");if(this.coordinateCache.has(a))return this.coordinateCache.get(a);if(t&&!r&&!e){let n=this.provinceFallback[t];return n?(this.coordinateCache.set(a,n),n):null}if(!this.ALLOW_CLIENT_GEOCODING){let n=t?this.provinceFallback[t]:void 0;return n?(this.coordinateCache.set(a,n),n):null}try{let n=[r?`${r}${i?` ${i}`:""}`:null,e,t,"Italia"].filter(Boolean).join(", ");console.log(`\u{1F30D} Tentativo geocodifica: ${n}`);let d=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(n)}&limit=1`,c=yield fetch(d,{headers:{"Accept-Language":"it","User-Agent":"PrometheaApp/1.0"}});if(!c.ok)throw console.warn(`Nominatim risposta non ok: ${c.status}`),new Error(`Nominatim ${c.status}`);let g=yield c.json();if(Array.isArray(g)&&g.length>0){let p={lat:parseFloat(g[0].lat),lng:parseFloat(g[0].lon),indirizzo:g[0].display_name};return this.coordinateCache.set(a,p),console.log(`\u2705 Geocodifica riuscita: ${p.lat}, ${p.lng}`),p}console.warn("Nessun risultato dalla geocodifica, uso fallback provincia");let s=t?this.provinceFallback[t]:void 0;return s?(this.coordinateCache.set(a,s),s):null}catch(n){console.warn("Geocodifica fallita, uso fallback provincia:",n);let d=t?this.provinceFallback[t]:void 0;return d?(this.coordinateCache.set(a,d),d):null}})}static \u0275fac=function(t){return new(t||y)};static \u0275prov=E({token:y,factory:y.\u0275fac,providedIn:"root"})};var R=class y{supabaseService=S(C);authService=S(k);userService=S(N);mapService=S(w);soggettoCache=new Map;CACHE_TTL=3e4;createSoggetto(e){return l(this,null,function*(){try{if(console.log("\u{1F527} Creazione soggetto con dati:",e),e.piva?.trim()&&(yield this.supabaseService.checkPivaExists(e.piva.trim())))return{success:!1,error:"P.IVA gi\xE0 esistente nel sistema"};let t=this.mapToSnakeCase(e),r=this.authService.user();r&&(t.created_by=r.id),t.created_at=new Date().toISOString(),t.updated_at=t.created_at;let i=yield this.supabaseService.createSoggetto(t);return i.error?(console.error("\u274C Errore Supabase:",i.error),{success:!1,error:this.getErrorMessage(i.error)}):(this.soggettoCache.clear(),{success:!0,data:i.data||void 0})}catch(t){return console.error("\u274C Errore createSoggetto:",t),{success:!1,error:"Errore di sistema durante il salvataggio"}}})}clearCache(){this.soggettoCache.clear()}get supabase(){return this.supabaseService.supabase}getSoggettiByTipo(e,t=0,r=49){return l(this,null,function*(){if(this.userService.isAdmin()||e!=="prospect")return this.supabaseService.getSoggettiByTipo(e,t,r);let i=this.authService.user();if(!i)return{data:[],error:null};console.log(`\u{1F50D} Query prospect per utente: user=${i.id}, range=${t}-${r}`);let{data:o,error:a}=yield this.supabaseService.supabase.from("soggetti").select("*").eq("tipo",e).eq("created_by",i.id).order("created_at",{ascending:!1}).range(t,r);return{data:o,error:a}})}getSoggettoById(e){return l(this,null,function*(){return yield this.supabaseService.getSoggettoById(e)})}deleteSoggetto(e){return l(this,null,function*(){try{let t=yield this.unlinkOrDelete("trattative_yuvi","prospect_id",e);if(!t.ok)return{success:!1,error:this.getErrorMessage(t.error)};let r=yield this.unlinkOrDelete("configurazioni_promethea","prospect_id",e);if(!r.ok)return{success:!1,error:this.getErrorMessage(r.error)};let i=yield this.supabaseService.deleteSoggetto(e);return i.error?{success:!1,error:this.getErrorMessage(i.error),code:i.error.code}:{success:!0,data:i.data||void 0}}catch{return{success:!1,error:"Errore di sistema durante l'eliminazione"}}})}unlinkOrDelete(e,t,r){return l(this,null,function*(){let{error:i}=yield this.supabaseService.supabase.from(e).update({[t]:null}).eq(t,r);if(!i)return{ok:!0};let o=String(i?.message||"");if(!(i?.code==="23502"||/not[- ]?null/i.test(o)||/violates not-null constraint/i.test(o)))return{ok:!1,error:i};let{error:n}=yield this.supabaseService.supabase.from(e).delete().eq(t,r);return n?{ok:!1,error:n}:{ok:!0}})}updateSoggetto(e){return l(this,null,function*(){try{let t=this.mapUpdateToSnakeCase(e),r=yield this.supabaseService.updateSoggetto(e.id,t);return r.error?{success:!1,error:this.getErrorMessage(r.error),code:r.error.code}:{success:!0,data:r.data||void 0}}catch{return{success:!1,error:"Errore di sistema durante l'aggiornamento"}}})}searchSoggetti(e,t){return l(this,null,function*(){try{if(t!=="prospect"||this.userService.isAdmin()){let n=yield this.supabaseService.searchSoggetti(e,t);return t?{data:(n.data??[]).filter(c=>c.tipo===t),error:null}:n}let r=this.authService.user();if(!r)return{data:[],error:null};let i=(e??"").trim(),{data:o,error:a}=yield this.supabaseService.supabase.from("soggetti").select("*").eq("tipo","prospect").eq("created_by",r.id).or(`ragione_sociale.ilike.%${i}%,referente.ilike.%${i}%,piva.ilike.%${i}%,telefono.ilike.%${i}%,email.ilike.%${i}%`).order("created_at",{ascending:!1}).limit(50);return{data:o,error:a}}catch(r){return console.error("Errore nella ricerca soggetti:",r),{data:null,error:r}}})}updateProdotto(e,t){return l(this,null,function*(){try{let r=yield this.supabaseService.updateSoggetto(e,{prodotto:t});return r.error?{success:!1,error:this.getErrorMessage(r.error),code:r.error.code}:{success:!0,data:r.data||void 0}}catch{return{success:!1,error:"Errore di sistema durante l'aggiornamento del prodotto"}}})}getProvinceByTipo(e){return l(this,null,function*(){return this.supabaseService.getProvinceByTipo(e)})}countByTipo(e){return l(this,null,function*(){if(this.userService.isAdmin()||e!=="prospect")return this.supabaseService.countSoggettiByTipo(e);let t=this.authService.user();if(!t)return{data:0,error:null};let{count:r,error:i}=yield this.supabaseService.supabase.from("soggetti").select("*",{count:"exact",head:!0}).eq("tipo",e).eq("created_by",t.id);return{data:r??0,error:i}})}getConfigurazioniProspect(e){return l(this,null,function*(){try{if(!e.length)return new Map;let[t,r]=yield Promise.all([this.supabaseService.supabase.from("configurazioni_promethea").select("prospect_id").in("prospect_id",e),this.supabaseService.supabase.from("trattative_yuvi").select("prospect_id").in("prospect_id",e)]),i=new Map;return e.forEach(o=>i.set(o,!1)),t.data&&t.data.forEach(o=>{o.prospect_id&&i.set(o.prospect_id,!0)}),r.data&&r.data.forEach(o=>{o.prospect_id&&i.set(o.prospect_id,!0)}),i}catch(t){return console.error("Errore bulk configurazioni:",t),new Map}})}getConfigurazioniPrometheaByCliente(e){return l(this,null,function*(){if(!e.length)return new Map;let t=(r,i=100)=>{let o=[];for(let a=0;a<r.length;a+=i)o.push(r.slice(a,a+i));return o};try{let r=new Map;e.forEach(n=>r.set(n,null));let o=t(e,100).map(n=>this.supabaseService.supabase.from("configurazioni_promethea").select("prospect_id, dettagli").in("prospect_id",n)),a=yield Promise.all(o);for(let n of a){if(n.error){console.warn("Partial fetch error for configurazioni_promethea chunk:",n.error);continue}(n.data??[]).forEach(c=>{c?.prospect_id&&r.set(c.prospect_id,c.dettagli)})}return r}catch(r){return console.error("Errore bulk configurazioni Promethea per clienti:",r),new Map}})}getTrattativeYuviByProspect(e){return l(this,null,function*(){if(!e.length)return new Map;let t=(r,i=100)=>{let o=[];for(let a=0;a<r.length;a+=i)o.push(r.slice(a,a+i));return o};try{let r=new Map;e.forEach(n=>r.set(n,!1));let o=t(e,100).map(n=>this.supabaseService.supabase.from("trattative_yuvi").select("prospect_id").in("prospect_id",n)),a=yield Promise.all(o);for(let n of a){if(n.error){console.warn("Partial fetch error for trattative_yuvi chunk:",n.error);continue}(n.data??[]).forEach(c=>{c?.prospect_id&&r.set(c.prospect_id,!0)})}return r}catch(r){return console.error("Errore bulk trattative YUVI:",r),new Map}})}getTrattativeYuviByCliente(e){return l(this,null,function*(){if(!e.length)return new Map;let t=(r,i=100)=>{let o=[];for(let a=0;a<r.length;a+=i)o.push(r.slice(a,a+i));return o};try{let r=new Map;e.forEach(n=>r.set(n,!1));let o=t(e,100).map(n=>this.supabaseService.supabase.from("trattative_yuvi").select("prospect_id").in("prospect_id",n)),a=yield Promise.all(o);for(let n of a){if(n.error){console.warn("Partial fetch error for trattative_yuvi chunk (clienti):",n.error);continue}(n.data??[]).forEach(c=>{c?.prospect_id&&r.set(c.prospect_id,!0)})}return r}catch(r){return console.error("Errore bulk trattative YUVI per clienti:",r),new Map}})}syncProdottiForProspects(e){return l(this,null,function*(){if(!e||e.length===0)return{updated:0,errors:[]};let t=(r,i=100)=>{let o=[];for(let a=0;a<r.length;a+=i)o.push(r.slice(a,a+i));return o};try{let[r,i]=yield Promise.all([this.getConfigurazioniPrometheaByCliente(e),this.getTrattativeYuviByProspect(e)]),o=0,a=[],n=t(e,100);for(let d of n){let{data:c,error:g}=yield this.supabaseService.supabase.from("soggetti").select("id, prodotto").in("id",d);if(g){console.warn("Errore fetch soggetti per sync prodotti chunk:",g),a.push(String(g.message||g));continue}let s=[];(c||[]).forEach(p=>{let f=p.id,h=!!r.get(f),z=!!i.get(f),m=[];if(h&&m.push("Promethea"),z&&m.push("Yuvi"),m.length===0)return;let T=m.join(", ");(p.prodotto??"").trim()!==T&&s.push(this.supabaseService.updateSoggetto(f,{prodotto:T}).then(P=>{P.error?a.push(`id=${f}: ${P.error.message||P.error}`):o++}).catch(P=>{a.push(`id=${f}: ${String(P)}`)}))}),yield Promise.all(s)}return{updated:o,errors:a}}catch(r){return console.error("Errore sync prodotti:",r),{updated:0,errors:[String(r)]}}})}mapToSnakeCase(e){return{tipo:e.tipo,ragione_sociale:e.ragioneSociale,piva:e.piva&&e.piva.trim()!==""?e.piva:null,formula_societaria:e.formulaSocietaria||null,categoria_ateco:e.categoriaAteco||null,referente:e.referente||null,telefono:e.telefono||null,email:e.email||null,sito_web:e.sitoWeb||null,facebook:e.facebook||null,instagram:e.instagram||null,metodo_pagamento:e.metodoPagamento||null,iban:e.iban||null,note:e.note||null,prodotto:e.prodotto||"Promethea",referenza_da_id:e.referenzaDaId??null,provincia:e.provincia||null,comune:e.comune||null,indirizzo:e.indirizzo||null,numero_civico:e.numeroCivico||null,esiti:[],created_by:null}}mapUpdateToSnakeCase(e){let t={};return e.tipo!==void 0&&(t.tipo=e.tipo),e.ragioneSociale!==void 0&&(t.ragione_sociale=e.ragioneSociale),e.piva!==void 0&&(t.piva=e.piva&&e.piva.trim()!==""?e.piva:null),e.formulaSocietaria!==void 0&&(t.formula_societaria=e.formulaSocietaria),e.categoriaAteco!==void 0&&(t.categoria_ateco=e.categoriaAteco),e.referente!==void 0&&(t.referente=e.referente),e.telefono!==void 0&&(t.telefono=e.telefono),e.email!==void 0&&(t.email=e.email),e.sitoWeb!==void 0&&(t.sito_web=e.sitoWeb),e.facebook!==void 0&&(t.facebook=e.facebook),e.instagram!==void 0&&(t.instagram=e.instagram),e.metodoPagamento!==void 0&&(t.metodo_pagamento=e.metodoPagamento),e.iban!==void 0&&(t.iban=e.iban),e.note!==void 0&&(t.note=e.note),e.prodotto!==void 0&&(t.prodotto=e.prodotto),e.provincia!==void 0&&(t.provincia=e.provincia),e.comune!==void 0&&(t.comune=e.comune),e.indirizzo!==void 0&&(t.indirizzo=e.indirizzo),e.numeroCivico!==void 0&&(t.numero_civico=e.numeroCivico),e.referenzaDaId!==void 0&&(t.referenza_da_id=e.referenzaDaId??null),t}getErrorMessage(e){return typeof e=="string"?e:{23505:"Dati duplicati: il soggetto potrebbe gi\xE0 esistere",42501:"Permessi insufficienti per completare l'operazione",P0001:"Errore di validazione dei dati",network_error:"Errore di connessione al server"}[e.code]||e.message||"Errore durante il salvataggio"}getEsitiBySoggetto(e){return l(this,null,function*(){try{let{data:t,error:r}=yield this.supabaseService.getSoggettoById(e);if(r)return{data:null,error:r};let i=t?.esiti??[];return{data:this.normalizzaEsiti(i),error:null}}catch(t){return{data:null,error:t}}})}appendEsito(e,t){return l(this,null,function*(){try{let r=[];try{r=(yield this.getEsitiBySoggetto(e)).data??[]}catch(n){console.warn("Errore recupero esiti, procedo con array vuoto:",n),r=[]}let i=this.creaEsitoCompleto(t),o=[...r,i],a=yield this.supabaseService.updateSoggetto(e,{esiti:o});return a.error?{success:!1,error:this.getErrorMessage(a.error),code:a.error.code}:{success:!0,data:a.data||void 0}}catch(r){return console.error("Errore in appendEsito:",r),{success:!1,error:"Errore di sistema durante il salvataggio dell'esito"}}})}normalizzaEsiti(e){return e.map(t=>({tipo:t.tipo||"Non interessato",note:t.note||null,ts:t.ts||new Date().toISOString(),scheduleAt:t.scheduleAt||null,dataAppuntamento:t.dataAppuntamento||null,oraAppuntamento:t.oraAppuntamento||null}))}creaEsitoCompleto(e){return{tipo:e.tipo,note:e.note||null,ts:new Date().toISOString(),scheduleAt:e.scheduleAt||null,dataAppuntamento:e.dataAppuntamento||null,oraAppuntamento:e.oraAppuntamento||null}}convertiProspectInCliente(e){return l(this,null,function*(){try{let t={tipo:"cliente",updated_at:new Date().toISOString()},{data:r,error:i}=yield this.supabaseService.supabase.from("soggetti").update(t).eq("id",e).eq("tipo","prospect").select().single();return i?(console.error("Errore nella conversione prospect -> cliente:",i),{data:null,error:i}):(console.log("Prospect convertito in cliente:",r),{data:r,error:null})}catch(t){return console.error("Errore generale nella conversione:",t),{data:null,error:t}}})}aggiornaCoordinateSoggetto(e,t,r){return l(this,null,function*(){try{let i=yield this.supabaseService.updateSoggetto(e,{latitude:t,longitude:r,updated_at:new Date().toISOString()});return i.error?{success:!1,error:this.getErrorMessage(i.error),code:i.error.code}:{success:!0,data:i.data||void 0}}catch(i){return console.error("Errore aggiornamento coordinate:",i),{success:!1,error:"Errore durante l'aggiornamento delle coordinate"}}})}geocodificaEAggiornaSoggetto(e){return l(this,null,function*(){try{let{data:t,error:r}=yield this.getSoggettoById(e);if(r||!t)return{success:!1,error:"Soggetto non trovato"};if(!t.provincia&&!t.comune)return{success:!1,error:"Dati insufficienti per la geocodifica (manca provincia/comune)"};let i=yield this.mapService.geocodificaSoggetto(t);return i?yield this.aggiornaCoordinateSoggetto(e,i.lat,i.lng):{success:!1,error:"Impossibile determinare le coordinate dall'indirizzo"}}catch(t){return console.error("Errore geocodifica soggetto:",t),{success:!1,error:"Errore durante la geocodifica"}}})}geocodificaSoggettiSenzaCoordinate(e=50){return l(this,null,function*(){try{let{data:t,error:r}=yield this.supabaseService.supabase.from("soggetti").select("*").or("latitude.is.null,longitude.is.null").not("provincia","is",null).limit(e);if(r)throw r;if(!t||t.length===0)return{success:0,failed:0,total:0,errors:[]};console.log(`\u{1F504} Geocodifica batch di ${t.length} soggetti...`);let i=yield this.mapService.geocodificaSoggettiBatch(t),o=0,a=0,n=[];for(let d of t){let c=i.get(d.id);if(c){let g=yield this.aggiornaCoordinateSoggetto(d.id,c.lat,c.lng);g.success?o++:(a++,n.push(`${d.ragione_sociale}: ${g.error}`))}else a++,n.push(`${d.ragione_sociale}: Coordinate non trovate`)}return console.log(`\u2705 Geocodifica batch completata: ${o} successi, ${a} falliti`),{success:o,failed:a,total:t.length,errors:n}}catch(t){return console.error("Errore geocodifica batch:",t),{success:0,failed:0,total:0,errors:["Errore generale durante la geocodifica batch"]}}})}static \u0275fac=function(t){return new(t||y)};static \u0275prov=E({token:y,factory:y.\u0275fac,providedIn:"root"})};export{w as a,R as b};
