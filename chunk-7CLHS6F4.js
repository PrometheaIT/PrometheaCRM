import{a as z}from"./chunk-7W463TKQ.js";import{b as T}from"./chunk-7VD3EVFT.js";import{j as U,k,p as V}from"./chunk-CSZ7WPY7.js";import{Ga as S,La as w,S as M,X as v,Xa as d,Y as _,Ya as r,Za as o,_a as b,db as E,fa as f,gb as h,hb as c,ib as C,mb as m,nb as I,ua as l}from"./chunk-QS6MTI54.js";import"./chunk-X5YLR3NI.js";import{i as A}from"./chunk-ODN5LVDJ.js";function $(s,t){if(s&1){let e=E();r(0,"label",19)(1,"input",8),h("change",function(){let n=v(e).$implicit,a=c(2);return _(a.toggleInviteModulo(n))}),o(),r(2,"span",20),m(3),o()()}if(s&2){let e=t.$implicit,i=c(2);l(),d("checked",i.inviteMods().includes(e)),l(2),I(e)}}function N(s,t){s&1&&b(0,"span",21)}function D(s,t){if(s&1){let e=E();r(0,"label",19)(1,"input",8),h("change",function(){let n=v(e).$implicit,a=c().$implicit,p=c(2);return _(p.toggleModulo(a,n))}),o(),r(2,"span",20),m(3),o()()}if(s&2){let e=t.$implicit,i=c().$implicit;l(),d("checked",i.moduli.includes(e)),l(2),I(e)}}function O(s,t){s&1&&b(0,"span",21)}function F(s,t){if(s&1){let e=E();r(0,"tr")(1,"td",22)(2,"div",23),m(3),o()(),r(4,"td",24)(5,"div",23)(6,"label",7)(7,"input",8),h("change",function(){let n=v(e).$implicit,a=c(2);return _(a.toggleAdmin(n))}),o(),b(8,"span",9),o()()(),r(9,"td",25)(10,"div",26),w(11,D,4,2,"label",11),o()(),r(12,"td",27)(13,"div",23)(14,"button",13),h("click",function(){let n=v(e).$implicit,a=c(2);return _(a.saveRow(n))}),w(15,O,1,0,"span",14),m(16," Salva "),o()()(),r(17,"td",28)(18,"div",23)(19,"label",29)(20,"input",8),h("change",function(){let n=v(e).$implicit;return _(n.is_active=!n.is_active)}),o(),b(21,"span",9),o()()()()}if(s&2){let e=t.$implicit,i=c(2);l(3),I(e.email),l(4),d("checked",e.ruoli.includes("admin")),l(4),d("ngForOf",i.mods),l(3),d("disabled",!i.hasChanges(e)||i.savingIds.has(e.id)),l(),d("ngIf",i.savingIds.has(e.id)),l(5),d("checked",e.is_active===!0)}}function q(s,t){if(s&1){let e=E();r(0,"div",2)(1,"section",3)(2,"div",4)(3,"h3"),m(4,"Invita nuovo utente"),o(),r(5,"div",5)(6,"input",6,0),h("input",function(){v(e);let n=C(7),a=c();return _(a.inviteEmail.set(n.value))}),o(),r(8,"label",7)(9,"input",8),h("change",function(){v(e);let n=c();return _(n.inviteIsAdmin.set(!n.inviteIsAdmin()))}),o(),b(10,"span",9),o(),r(11,"span"),m(12,"Admin"),o()(),r(13,"div",10),w(14,$,4,2,"label",11),o(),r(15,"div",12)(16,"button",13),h("click",function(){v(e);let n=c();return _(n.sendInvite())}),w(17,N,1,0,"span",14),m(18," Invia invito "),o()()()(),r(19,"section",15)(20,"div",16)(21,"table",17)(22,"thead")(23,"tr")(24,"th"),m(25,"Email"),o(),r(26,"th"),m(27,"Admin"),o(),r(28,"th"),m(29,"Moduli"),o(),r(30,"th"),m(31,"Azioni"),o(),r(32,"th"),m(33,"Attivo"),o()()(),r(34,"tbody"),w(35,F,22,6,"tr",18),o()()()()()}if(s&2){let e=c();l(6),d("value",e.inviteEmail()),l(3),d("checked",e.inviteIsAdmin()),l(5),d("ngForOf",e.mods),l(2),d("disabled",!e.canSendInvite||e.inviting()),l(),d("ngIf",e.inviting()),l(18),d("ngForOf",e.rows())}}var R=class s{supa=M(T);mail=M(z);loading=f(!0);isAdmin=f(!1);error=f(null);rows=f([]);mods=["immagine","digitalizzazione","contabilita","ottimizzazione"];savingIds=new Set;inviteEmail=f("");inviteIsAdmin=f(!1);inviteMods=f([]);inviting=f(!1);original=new Map;ngOnInit(){return A(this,null,function*(){this.loading.set(!0);try{if(this.isAdmin.set(yield this.supa.isAdmin()),!this.isAdmin()){this.error.set("Non autorizzato");return}yield this.refreshRows()}catch(t){this.error.set(t?.message||"Errore")}finally{this.loading.set(!1)}})}refreshRows(){return A(this,null,function*(){let t=yield this.supa.getAppUsers();if(t.error)throw t.error;let e=t.data??[];this.original.clear();for(let i of e)this.original.set(i.id,{ruoli:[...i.ruoli||[]],moduli:[...i.moduli||[]]});this.rows.set(e)})}toggleAdmin(t){let e=new Set(t.ruoli||[]);e.has("admin")?e.delete("admin"):e.add("admin"),t.ruoli=Array.from(e)}toggleModulo(t,e){let i=[...t.moduli||[]],n=i.indexOf(e);n>=0?i.splice(n,1):i.push(e),t.moduli=i}hasChanges(t){let e=this.original.get(t.id);if(!e)return!0;let i=new Set(e.ruoli||[]),n=new Set(t.ruoli||[]);if(i.size!==n.size)return!0;for(let x of i)if(!n.has(x))return!0;let a=new Set(e.moduli||[]),p=new Set(t.moduli||[]);if(a.size!==p.size)return!0;for(let x of a)if(!p.has(x))return!0;return!1}saveRow(t){return A(this,null,function*(){let e=this.original.get(t.id);if(e){this.savingIds.add(t.id);try{let i=e.ruoli?.includes("admin")||!1,n=t.ruoli?.includes("admin")||!1;if(i!==n){let u=yield this.supa.setUserAdminStatus(t.id,n);if(u.error)throw u.error}let a=new Set(e.moduli||[]),p=new Set(t.moduli||[]),x=[...p].filter(u=>!a.has(u)),y=[...a].filter(u=>!p.has(u));for(let u of x){let g=yield this.supa.toggleUserModulo(t.id,u,!0);if(g.error)throw g.error}for(let u of y){let g=yield this.supa.toggleUserModulo(t.id,u,!1);if(g.error)throw g.error}yield this.refreshRows()}catch(i){alert(i?.message||"Errore durante il salvataggio"),t.ruoli=[...e.ruoli],t.moduli=[...e.moduli]}finally{this.savingIds.delete(t.id)}}})}toggleInviteModulo(t){let e=new Set(this.inviteMods());e.has(t)?e.delete(t):e.add(t),this.inviteMods.set([...e])}get canSendInvite(){let t=this.inviteEmail().trim();return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)&&(this.inviteIsAdmin()||this.inviteMods().length>0)}sendInvite(){return A(this,null,function*(){let t=this.inviteEmail().trim(),e=this.inviteIsAdmin(),i=this.inviteMods();if(t){this.inviting.set(!0);try{console.log("\u{1F3AF} Creazione invito per:",t);let n=e?["admin","user"]:["user"],a=yield this.supa.createInviteToken(t,e,i,10080);if(a.error)throw console.error("\u274C Errore creazione token:",a.error),new Error(a.error.message||"Errore nella creazione invito");let p=a.data;if(!p)throw console.error("\u274C Token non generato"),new Error("Token non generato");console.log("\u2705 Token generato:",p);let x=`${location.origin}/register?token=${encodeURIComponent(p)}&email=${encodeURIComponent(t)}`;console.log("\u{1F517} Link invito:",x);let y="Invito a Promethea CRM",u=`Ciao,

sei stato invitato ad accedere a Promethea CRM.

Clicca qui per registrarti: ${x}

Questo link scadr\xE0 tra 7 giorni.

Se non ti aspettavi questo invito, ignora questa email.`;console.log("\u{1F4E7} Invio email a:",t);let g=yield this.mail.sendEmail({to:t,subject:y,message:u});if(!g.success)throw console.error("\u274C Errore invio email:",g.error),new Error(g.error||"Invio email fallito");console.log("\u2705 Email inviata con successo"),this.inviteEmail.set(""),this.inviteIsAdmin.set(!1),this.inviteMods.set([]),this.error.set(null),alert("Invito inviato con successo!")}catch(n){console.error("\u{1F4A5} Errore completo:",n),this.error.set(n.message||"Errore durante l'invio")}finally{this.inviting.set(!1)}}})}static \u0275fac=function(e){return new(e||s)};static \u0275cmp=S({type:s,selectors:[["app-admin-utenti"]],decls:1,vars:1,consts:[["inviteEmailInput",""],["class","admin-users",4,"ngIf"],[1,"admin-users"],[1,"table-section",2,"margin-bottom","var(--gutter-lg)"],[1,"table-container",2,"padding","var(--gutter-sm)"],[1,"cell-content",2,"gap","1rem","flex-wrap","wrap"],["type","email","placeholder","email@azienda.it",3,"input","value"],["title","Admin",1,"toggle-switch"],["type","checkbox",3,"change","checked"],[1,"slider"],[1,"cell-content",2,"flex-wrap","wrap","gap",".5rem","margin-top",".5rem"],["class","mod-toggle",4,"ngFor","ngForOf"],[1,"cell-content",2,"margin-top","1rem"],["type","button",1,"promethea-button",3,"click","disabled"],["class","loading-spinner",4,"ngIf"],[1,"table-section"],[1,"table-container"],[1,"crm-table"],[4,"ngFor","ngForOf"],[1,"mod-toggle"],[1,"mod-chip"],[1,"loading-spinner"],["data-label","Email"],[1,"cell-content"],["data-label","Admin"],["data-label","Moduli"],[1,"cell-content",2,"flex-wrap","wrap","gap",".5rem"],["data-label","Azioni"],["data-label","Attivo"],["title","Attivo",1,"toggle-switch"]],template:function(e,i){e&1&&w(0,q,36,6,"div",1),e&2&&d("ngIf",!i.loading()&&!i.error())},dependencies:[V,U,k],encapsulation:2})};export{R as AdminUtenti};
