import{a as O}from"./chunk-OCVT6WLO.js";import{a as M}from"./chunk-WOMB6SWO.js";import{b as U}from"./chunk-3Y2ZP6KK.js";import"./chunk-3347WCPA.js";import{b as K,c as N}from"./chunk-2ONBSOVF.js";import{c as D,d as L,e as R,k as H,r as A}from"./chunk-233B5766.js";import{Bb as z,Fa as s,Fb as n,Gb as m,Hb as x,Qb as T,Ra as C,S,Wa as f,Xb as w,ea as k,gb as c,hb as a,ib as i,jb as P,ub as u}from"./chunk-R6HFAJZF.js";import"./chunk-X5YLR3NI.js";import{i as _}from"./chunk-ODN5LVDJ.js";var B=r=>["/soggetto",r];function V(r,e){r&1&&P(0,"app-page-loader",3)}function q(r,e){if(r&1&&(a(0,"div",27),n(1),i()),r&2){let t=u(2);s(),m(t.error)}}function j(r,e){if(r&1&&(a(0,"div",42),n(1),i()),r&2){let t=u().$implicit;s(),x(" Ref: ",t.prospect.referente," ")}}function G(r,e){if(r&1&&(a(0,"div"),n(1),i()),r&2){let t=u().$implicit;s(),m(t.prospect.telefono)}}function J(r,e){if(r&1&&(a(0,"div",43),n(1),i()),r&2){let t=u().$implicit;s(),x(" ",t.prospect.email," ")}}function Q(r,e){r&1&&(a(0,"div"),n(1,"\u2014"),i())}function W(r,e){if(r&1&&(a(0,"span",43),n(1),i()),r&2){let t=u().$implicit,o=u(3);s(),x(" ",o.truncate(t.esito.note,50)," ")}}function X(r,e){r&1&&(a(0,"span"),n(1,"\u2014"),i())}function Z(r,e){if(r&1&&(a(0,"tr")(1,"td",31)(2,"div",32)(3,"strong",33),n(4),i(),f(5,j,2,1,"div",34),i()(),a(6,"td",35)(7,"div",32),f(8,G,2,1,"div",2)(9,J,2,1,"div",36)(10,Q,2,0,"div",2),i()(),a(11,"td",37)(12,"div",32),n(13),i()(),a(14,"td",38)(15,"div",32)(16,"span",39),n(17),i()()(),a(18,"td",40)(19,"div",32),n(20),i()(),a(21,"td",41)(22,"div",32),f(23,W,2,1,"span",36)(24,X,2,0,"span",2),i()()()),r&2){let t=e.$implicit,o=u(3);s(3),c("routerLink",T(12,B,t.prospect.id)),s(),x(" ",t.prospect.ragione_sociale," "),s(),c("ngIf",t.prospect.referente),s(3),c("ngIf",t.prospect.telefono),s(),c("ngIf",t.prospect.email),s(),c("ngIf",!t.prospect.telefono&&!t.prospect.email),s(3),m(t.prospect.provincia||"\u2014"),s(3),c("ngClass",o.getBadgeClass(t.esito.tipo)),s(),x(" ",o.getTestoEsito(t.esito)," "),s(3),m(o.formatDate(t.dataEsito)),s(3),c("ngIf",t.esito.note),s(),c("ngIf",!t.esito.note)}}function tt(r,e){if(r&1&&(a(0,"div",28)(1,"table",29)(2,"thead")(3,"tr")(4,"th"),n(5,"Prospect"),i(),a(6,"th"),n(7,"Contatto"),i(),a(8,"th"),n(9,"Provincia"),i(),a(10,"th"),n(11,"Ultimo Esito"),i(),a(12,"th"),n(13,"Data Esito"),i(),a(14,"th"),n(15,"Note"),i()()(),a(16,"tbody"),f(17,Z,25,14,"tr",30),i()()()),r&2){let t=u(2);s(17),c("ngForOf",t.ultimiEsiti)}}function et(r,e){r&1&&(a(0,"div",44)(1,"i",45),n(2,"history"),i(),a(3,"p"),n(4,"Nessun esito recente trovato."),i(),a(5,"p",46),n(6,"I contatti con i prospect appariranno qui."),i()())}function it(r,e){if(r&1&&(a(0,"div")(1,"div",4)(2,"div",5)(3,"i",6),n(4,"dashboard"),i(),a(5,"div",7)(6,"h2",8),n(7,"Dashboard CRM"),i(),a(8,"p",9),n(9,"Panoramica rapida su attivit\xE0 e KPI"),i()()(),f(10,q,2,1,"div",10),a(11,"div",11)(12,"a",12)(13,"h3",13),n(14,"Totale Prospect"),i(),a(15,"div",14),n(16),i()(),a(17,"a",15)(18,"h3",13),n(19,"Totale Clienti"),i(),a(20,"div",14),n(21),i()(),a(22,"a",12)(23,"h3",13),n(24,"Da Richiamare"),i(),a(25,"div",14),n(26),i()(),a(27,"a",12)(28,"h3",13),n(29,"Senza Contatto"),i(),a(30,"div",14),n(31),i()(),a(32,"a",12)(33,"h3",13),n(34,"Configurati"),i(),a(35,"div",14),n(36),i()(),a(37,"a",16)(38,"h3",13),n(39,"Trattative YUVI"),i(),a(40,"div",14),n(41),i()(),a(42,"a",17)(43,"h3",13),n(44,"Trattative Promethea"),i(),a(45,"div",14),n(46),i()(),a(47,"a",18)(48,"h3",13),n(49,"Referenze da CTR"),i(),a(50,"div",14),n(51),i()()(),a(52,"div",19)(53,"a",20),n(54,"Nuovo Prospect"),i(),a(55,"a",21),n(56,"Nuova Trattativa YUVI"),i(),a(57,"a",22),n(58,"Visualizza KPI"),i()()(),a(59,"div",23)(60,"div",5)(61,"i",6),n(62,"history"),i(),a(63,"div",7)(64,"h3",8),n(65,"Ultimi Esiti"),i(),a(66,"p",9),n(67,"I contatti pi\xF9 recenti con i prospect"),i()()(),f(68,tt,18,1,"div",24)(69,et,7,0,"ng-template",null,0,w),a(71,"div",25)(72,"a",26),n(73,"Vai alla lista prospect"),i()()()()),r&2){let t=z(70),o=u();s(10),c("ngIf",o.error),s(6),m(o.kpi.prospect),s(5),m(o.kpi.clienti),s(5),m(o.kpi.daRichiamare),s(5),m(o.kpi.senzaContatto),s(5),m(o.kpi.configurati),s(5),m(o.kpi.trattativeYuvi),s(5),m(o.kpi.trattativePromethea),s(5),m(o.kpi.referenzeCtr),s(17),c("ngIf",o.ultimiEsiti.length>0)("ngIfElse",t)}}var F=class r{soggetti=S(U);supabase=S(K);authService=S(N);kpiService=S(M);isLoading=k(!0);error=null;kpi={prospect:0,clienti:0,daRichiamare:0,senzaContatto:0,configurati:0,trattativeYuvi:0,trattativePromethea:0,referenzeCtr:0};ultimiEsiti=[];ngOnInit(){this.caricaDashboard()}caricaDashboard(){return _(this,null,function*(){try{this.isLoading.set(!0),yield Promise.all([this.caricaKPI(),this.caricaUltimiEsiti()])}catch(e){console.error("Errore caricamento dashboard:",e),this.error=e.message||"Errore nel caricamento della dashboard"}finally{this.isLoading.set(!1)}})}caricaKPI(){return _(this,null,function*(){try{let e=yield this.kpiService.getProspectKPI();this.kpi.prospect=e.totale,this.kpi.daRichiamare=e.daRichiamare,this.kpi.senzaContatto=e.senzaContatto,this.kpi.configurati=e.configurati;let t=yield this.kpiService.getAnagraficaKPI("cliente");this.kpi.clienti=t.totale;let o=yield this.kpiService.getKPIYuvi();this.kpi.trattativeYuvi=o.totaleTrattative,this.kpi.referenzeCtr=o.referenzeDaCtr;let v=yield this.kpiService.getKPIPromethea();this.kpi.trattativePromethea=v.totaleTrattative}catch(e){throw console.error("Errore caricamento KPI:",e),new Error("Errore nel caricamento dei KPI")}})}caricaUltimiEsiti(){return _(this,null,function*(){try{let t=0,o=[];for(;;){let l=yield this.soggetti.getSoggettiByTipo("prospect",t,t+500-1);if(l.error)throw l.error;let p=l.data??[];if(o.push(...p),p.length<500||(t+=500,t>=5e3))break}let v=[];o.forEach(l=>{let p=Array.isArray(l.esiti)?l.esiti.filter(d=>d&&d.ts):[];if(p.length===0)return;let h=p.reduce((d,E)=>{try{return new Date(E.ts).getTime()>new Date(d.ts).getTime()?E:d}catch{return d}},p[0]);h&&v.push({prospect:l,esito:h,dataEsito:new Date(h.ts)})}),this.ultimiEsiti=v.sort((l,p)=>p.dataEsito.getTime()-l.dataEsito.getTime()).slice(0,10)}catch(e){throw console.error("Errore caricamento ultimi esiti:",e),this.ultimiEsiti=[],new Error("Errore nel caricamento degli ultimi esiti")}})}formatDate(e){return e.toLocaleDateString("it-IT")}getLastEsito(e){if(!Array.isArray(e)||e.length===0)return null;let t=e[0];for(let o of e)new Date(o.ts).getTime()>new Date(t.ts).getTime()&&(t=o);return t}getBadgeClass(e){switch(e){case"Richiamare":return"badge-warning";case"Appuntamento":case"Contratto Chiuso":return"badge-success";case"Non Interessato":return"badge-error";default:return"badge-info"}}getTestoEsito(e){return e.tipo==="Appuntamento"&&e.dataAppuntamento?`Appuntamento il ${this.formatDate(new Date(e.dataAppuntamento))}`:e.tipo}loadData(){return _(this,null,function*(){this.error=null;try{if(yield this.authService.getAuthState(),!this.authService.user()){this.error="Utente non autenticato. Effettua il login.";return}let[t,o,v,l,p,h]=yield Promise.all([this.soggetti.countByTipo("prospect"),this.soggetti.countByTipo("cliente"),this.soggetti.getSoggettiByTipo("prospect",0,199),this.supabase.supabase.from("trattative_yuvi").select("id",{count:"exact",head:!0}),this.supabase.supabase.from("configurazioni_promethea").select("id",{count:"exact",head:!0}),this.supabase.supabase.from("trattative_yuvi").select("nominativi_presi")]);if(console.log("\u{1F4CA} Dati caricati:",{prospect:t.data,clienti:o.data,trattative:l.count}),!t.error&&typeof t.data=="number"&&(this.kpi.prospect=t.data),!o.error&&typeof o.data=="number"&&(this.kpi.clienti=o.data),v.error)throw v.error;let d=v.data??[],E=0,I=0,Y=d.map(g=>this.verificaConfigurazioniProspect(g.id)),$=yield Promise.all(Y);for(let g=0;g<d.length;g++){let y=d[g],b=this.getLastEsito(y.esiti);b||E++,b&&b.tipo==="Richiamare"&&I++,$[g]&&this.kpi.configurati++}this.kpi.senzaContatto=E,this.kpi.daRichiamare=I,!l.error&&typeof l.count=="number"&&(this.kpi.trattativeYuvi=l.count),!p?.error&&typeof p?.count=="number"&&(this.kpi.trattativePromethea=p.count),!h.error&&Array.isArray(h.data)&&(this.kpi.referenzeCtr=h.data.reduce((g,y)=>g+(y.nominativi_presi??0),0)),console.log("\u2705 Home - Caricamento completato")}catch(e){console.error("\u274C Errore nel caricamento home:",e),this.error=e?.message||"Errore durante il caricamento della dashboard"}})}truncate(e,t=50){return e?e.length<=t?e:e.slice(0,t)+"...":"\u2014"}verificaConfigurazioniProspect(e){return _(this,null,function*(){try{let[t,o]=yield Promise.all([this.supabase.supabase.from("configurazioni_promethea").select("id").eq("prospect_id",e).maybeSingle(),this.supabase.supabase.from("trattative_yuvi").select("id").eq("prospect_id",e).maybeSingle()]);return!!(t.data||o.data)}catch(t){return console.warn(`\u26A0\uFE0F Errore verifica configurazioni per prospect ${e}:`,t),!1}})}static \u0275fac=function(t){return new(t||r)};static \u0275cmp=C({type:r,selectors:[["app-home"]],decls:2,vars:2,consts:[["emptyEsiti",""],["title","Caricamento Dashboard","subtitle","Stiamo preparando i tuoi dati...",4,"ngIf"],[4,"ngIf"],["title","Caricamento Dashboard","subtitle","Stiamo preparando i tuoi dati..."],[1,"form-section"],[1,"section-header"],[1,"material-icons","header-icon"],[1,"section-titles"],[1,"section-title"],[1,"sottotitolo"],["class","status-message error",4,"ngIf"],[1,"prospect-cards"],["routerLink","/lista-prospect",1,"card","clickable"],[1,"card-title"],[1,"card-number"],["routerLink","/clienti",1,"card","clickable"],["routerLink","/yuvi-trattativa",1,"card","clickable"],["routerLink","/alchemizzatore",1,"card","clickable"],["routerLink","/visualizzazione-kpi",1,"card","clickable"],[1,"actions-container",2,"margin-top","var(--gutter-lg)","justify-content","center"],["routerLink","/aggiungi-prospect",1,"promethea-button","outline"],["routerLink","/yuvi-trattativa",1,"promethea-button"],["routerLink","/visualizzazione-kpi",1,"promethea-button","secondary"],[1,"form-section",2,"margin-top","var(--gutter-lg)"],["class","table-container",4,"ngIf","ngIfElse"],[1,"actions-container",2,"margin-top","var(--gutter-md)"],["routerLink","/lista-prospect",1,"promethea-button","secondary"],[1,"status-message","error"],[1,"table-container"],[1,"crm-table"],[4,"ngFor","ngForOf"],["data-label","Prospect"],[1,"cell-content"],["title","Apri scheda soggetto",1,"link",3,"routerLink"],["class","text-muted","style","font-size: 0.875rem; margin-top: 4px;",4,"ngIf"],["data-label","Contatto"],["class","text-muted","style","font-size: 0.875rem;",4,"ngIf"],["data-label","Provincia"],["data-label","Ultimo Esito"],[1,"badge",3,"ngClass"],["data-label","Data Esito"],["data-label","Note"],[1,"text-muted",2,"font-size","0.875rem","margin-top","4px"],[1,"text-muted",2,"font-size","0.875rem"],[1,"empty-state"],[1,"material-icons",2,"font-size","48px","color","var(--text-muted)","margin-bottom","16px"],[1,"text-muted",2,"margin-top","8px"]],template:function(t,o){t&1&&f(0,V,1,0,"app-page-loader",1)(1,it,74,11,"div",2),t&2&&(c("ngIf",o.isLoading()),s(),c("ngIf",!o.isLoading()))},dependencies:[H,D,L,R,A,O],styles:["a.card[_ngcontent-%COMP%]{text-decoration:none;color:inherit}.form-section[_ngcontent-%COMP%] + .form-section[_ngcontent-%COMP%]{margin-top:var(--gutter-lg)}"]})};export{F as Home};
