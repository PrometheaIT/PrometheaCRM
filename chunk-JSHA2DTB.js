import{a as Fe}from"./chunk-YVZQBS76.js";import{b as De,e as Ve,f as Oe,g as ke}from"./chunk-K3JKJW2Z.js";import{a as Me}from"./chunk-O7PKPPU5.js";import{a as Ne}from"./chunk-GY4AAC65.js";import{b as ve,c as A,d as xe,e as he,f as Se,g as be,k as ye,n as Ce,o as Ee,p as Pe,q as we,u as Ie,v as Ae,w as Te}from"./chunk-DITEEB7V.js";import{b as ze}from"./chunk-4ZO3JJK7.js";import{a as fe}from"./chunk-23T6KXZP.js";import"./chunk-6TYR3BRN.js";import{d as ge,f as ue}from"./chunk-KPVFMQJV.js";import{b as _e}from"./chunk-7SDV3Z56.js";import{g as re,j as le,k as se,n as ce,o as de,q as me,r as pe}from"./chunk-G7C3XVRV.js";import{$b as S,Ab as d,Fa as q,Ga as r,Jb as N,Lb as l,Mb as u,N as K,Nb as v,Ob as ee,Pb as te,Qb as ie,Rb as oe,S as z,Sa as J,Sb as ne,Vb as L,X as y,Xa as p,Y as C,_b as h,ac as ae,ea as I,gb as Q,hc as O,mb as c,nb as s,ob as n,pb as f,tb as G,ub as Y,wb as M,zb as E}from"./chunk-S7YZFXYO.js";import"./chunk-X5YLR3NI.js";import{a as j,b as X,i as T}from"./chunk-ODN5LVDJ.js";var $=class i{fallbackProvinces=[{code:"AG",name:"Agrigento",region:"Sicilia"},{code:"AL",name:"Alessandria",region:"Piemonte"},{code:"AN",name:"Ancona",region:"Marche"},{code:"AO",name:"Aosta",region:"Valle d'Aosta"},{code:"AR",name:"Arezzo",region:"Toscana"},{code:"AP",name:"Ascoli Piceno",region:"Marche"},{code:"AT",name:"Asti",region:"Piemonte"},{code:"AV",name:"Avellino",region:"Campania"},{code:"BA",name:"Bari",region:"Puglia"},{code:"BG",name:"Bergamo",region:"Lombardia"},{code:"BI",name:"Biella",region:"Piemonte"},{code:"BL",name:"Belluno",region:"Veneto"},{code:"BN",name:"Benevento",region:"Campania"},{code:"BR",name:"Brindisi",region:"Puglia"},{code:"BS",name:"Brescia",region:"Lombardia"},{code:"BT",name:"Barletta-Andria-Trani",region:"Puglia"},{code:"CA",name:"Cagliari",region:"Sardegna"},{code:"CB",name:"Campobasso",region:"Molise"},{code:"CE",name:"Caserta",region:"Campania"},{code:"CH",name:"Chieti",region:"Abruzzo"},{code:"CI",name:"Carboni Iglesias",region:"Sardegna"},{code:"CL",name:"Caltanissetta",region:"Sicilia"},{code:"CN",name:"Cuneo",region:"Piemonte"},{code:"CO",name:"Como",region:"Lombardia"},{code:"CR",name:"Cremona",region:"Lombardia"},{code:"CS",name:"Cosenza",region:"Calabria"},{code:"CT",name:"Catania",region:"Sicilia"},{code:"CZ",name:"Catanzaro",region:"Calabria"},{code:"EN",name:"Enna",region:"Sicilia"},{code:"FC",name:"Forl\xEC Cesena",region:"Emilia Romagna"},{code:"FE",name:"Ferrara",region:"Emilia Romagna"},{code:"FG",name:"Foggia",region:"Puglia"},{code:"FI",name:"Firenze",region:"Toscana"},{code:"FM",name:"Fermo",region:"Marche"},{code:"FR",name:"Frosinone",region:"Lazio"},{code:"GE",name:"Genova",region:"Liguria"},{code:"GO",name:"Gorizia",region:"Friuli Venezia Giulia"},{code:"GR",name:"Grosseto",region:"Toscana"},{code:"IM",name:"Imperia",region:"Liguria"},{code:"IS",name:"Isernia",region:"Molise"},{code:"KR",name:"Crotone",region:"Calabria"},{code:"LC",name:"Lecco",region:"Lombardia"},{code:"LE",name:"Lecce",region:"Puglia"},{code:"LI",name:"Livorno",region:"Toscana"},{code:"LO",name:"Lodi",region:"Lombardia"},{code:"LT",name:"Latina",region:"Lazio"},{code:"LU",name:"Lucca",region:"Toscana"},{code:"MB",name:"Monza e della Brianza",region:"Lombardia"},{code:"MC",name:"Macerata",region:"Marche"},{code:"ME",name:"Messina",region:"Sicilia"},{code:"MI",name:"Milano",region:"Lombardia"},{code:"MN",name:"Mantova",region:"Lombardia"},{code:"MO",name:"Modena",region:"Emilia Romagna"},{code:"MS",name:"Massa Carrara",region:"Toscana"},{code:"MT",name:"Matera",region:"Basilicata"},{code:"NA",name:"Napoli",region:"Campania"},{code:"NO",name:"Novara",region:"Piemonte"},{code:"NU",name:"Nuoro",region:"Sardegna"},{code:"OG",name:"Ogliastra",region:"Sardegna"},{code:"OR",name:"Oristano",region:"Sardegna"},{code:"OT",name:"Olbia Tempio",region:"Sardegna"},{code:"PA",name:"Palermo",region:"Sicilia"},{code:"PC",name:"Piacenza",region:"Emilia Romagna"},{code:"PD",name:"Padova",region:"Veneto"},{code:"PE",name:"Pescara",region:"Abruzzo"},{code:"PG",name:"Perugia",region:"Umbria"},{code:"PI",name:"Pisa",region:"Toscana"},{code:"PN",name:"Pordenone",region:"Friuli Venezia Giulia"},{code:"PO",name:"Prato",region:"Toscana"},{code:"PR",name:"Parma",region:"Emilia Romagna"},{code:"PT",name:"Pistoia",region:"Toscana"},{code:"PV",name:"Pavia",region:"Lombardia"},{code:"PZ",name:"Potenza",region:"Basilicata"},{code:"RA",name:"Ravenna",region:"Emilia Romagna"},{code:"RC",name:"Reggio Calabria",region:"Calabria"},{code:"RE",name:"Reggio Emilia",region:"Emilia Romagna"},{code:"RG",name:"Ragusa",region:"Sicilia"},{code:"RI",name:"Rieti",region:"Lazio"},{code:"RM",name:"Roma",region:"Lazio"},{code:"RN",name:"Rimini",region:"Emilia Romagna"},{code:"RO",name:"Rovigo",region:"Veneto"},{code:"SA",name:"Salerno",region:"Campania"},{code:"SI",name:"Siena",region:"Toscana"},{code:"SO",name:"Sondrio",region:"Lombardia"},{code:"SP",name:"La Spezia",region:"Liguria"},{code:"SR",name:"Siracusa",region:"Sicilia"},{code:"SS",name:"Sassari",region:"Sardegna"},{code:"SU",name:"Medio Campidano",region:"Sardegna"},{code:"SV",name:"Savona",region:"Liguria"},{code:"TA",name:"Taranto",region:"Puglia"},{code:"TE",name:"Teramo",region:"Abruzzo"},{code:"TN",name:"Trento",region:"Trentino-Alto Adige"},{code:"TO",name:"Torino",region:"Piemonte"},{code:"TP",name:"Trapani",region:"Sicilia"},{code:"TR",name:"Terni",region:"Umbria"},{code:"TS",name:"Trieste",region:"Friuli Venezia Giulia"},{code:"TV",name:"Treviso",region:"Veneto"},{code:"UD",name:"Udine",region:"Friuli Venezia Giulia"},{code:"VA",name:"Varese",region:"Lombardia"},{code:"VB",name:"Verbano-Cusio-Ossola",region:"Piemonte"},{code:"VC",name:"Vercelli",region:"Piemonte"},{code:"VE",name:"Venezia",region:"Veneto"},{code:"VI",name:"Vicenza",region:"Veneto"},{code:"VT",name:"Viterbo",region:"Lazio"}];getProvinces(){return[...this.fallbackProvinces].sort((t,e)=>t.name.localeCompare(e.name))}searchProvinces(t){if(!t||t.length<1)return this.getProvinces();let e=t.toLowerCase();return this.fallbackProvinces.filter(a=>a.name.toLowerCase().includes(e)||a.code.toLowerCase().includes(e)||a.region.toLowerCase().includes(e)).sort((a,o)=>a.name.localeCompare(o.name))}getProvinceByCode(t){return this.fallbackProvinces.find(e=>e.code.toUpperCase()===t.toUpperCase())||null}getRegions(){return[...new Set(this.fallbackProvinces.map(e=>e.region))].sort()}getProvincesByRegion(t){return this.fallbackProvinces.filter(e=>e.region===t).sort((e,a)=>e.name.localeCompare(a.name))}static \u0275fac=function(e){return new(e||i)};static \u0275prov=K({token:i,factory:i.\u0275fac,providedIn:"root"})};var U=()=>[],Re=()=>({standalone:!0});function Ge(i,t){if(i&1&&f(0,"app-page-loader",13),i&2){let e=d();c("isLoading",e.loading())}}function Ye(i,t){if(i&1&&(s(0,"p",14),l(1),n()),i&2){let e=d();r(),v(" ",e.sottotitolo()," ")}}function $e(i,t){if(i&1){let e=M();G(0),s(1,"button",15),E("click",function(){y(e);let o=d();return C(o.navigateBack())}),s(2,"span",16),l(3,"arrow_back"),n(),l(4," Indietro "),n(),Y()}}function Ue(i,t){if(i&1){let e=M();G(0),s(1,"button",15),E("click",function(){y(e);let o=d();return C(o.cancel())}),s(2,"span",16),l(3,"close"),n(),l(4," Annulla "),n(),Y()}}function He(i,t){if(i&1&&(s(0,"div",17)(1,"span",18)(2,"span",16),l(3,"location_on"),n(),l(4," Coordinate "),n(),s(5,"span",19),l(6),h(7,"number"),h(8,"number"),n()()),i&2){let e,a=d();r(6),v(" ",(e=a.soggettoData())!=null&&e.latitude&&((e=a.soggettoData())!=null&&e.longitude)?S(7,1,(e=a.soggettoData())==null?null:e.latitude,"1.4-4")+", "+S(8,4,(e=a.soggettoData())==null?null:e.longitude,"1.4-4"):"\u2014"," ")}}function We(i,t){i&1&&(s(0,"span",16),l(1,"save"),n())}function je(i,t){i&1&&f(0,"span",53)}function qe(i,t){if(i&1&&(s(0,"span",54),l(1),n()),i&2){let e=d(2);r(),v(" Prodotto: ",e.prodottoDisplay()," ")}}function Ze(i,t){i&1&&(s(0,"span",54),l(1," Configurazione salvata "),n())}function Xe(i,t){if(i&1&&(s(0,"span",54),l(1),n()),i&2){let e=d(2);r(),v(" Trattative Yuvi: ",(e.trattativeYuvi()??L(1,U)).length," ")}}function Ke(i,t){i&1&&f(0,"input",55)}function Je(i,t){if(i&1&&(s(0,"span",19),l(1),n()),i&2){let e,a=d(2);r(),u(((e=a.soggettoData())==null?null:e.ragione_sociale)||"\u2014")}}function Qe(i,t){i&1&&(s(0,"small",56),l(1,"Campo obbligatorio"),n())}function et(i,t){i&1&&(s(0,"small",56),l(1,"Minimo 2 caratteri"),n())}function tt(i,t){i&1&&f(0,"input",57)}function it(i,t){if(i&1&&(s(0,"span",19),l(1),n()),i&2){let e,a=d(2);r(),u(((e=a.soggettoData())==null?null:e.piva)||"\u2014")}}function ot(i,t){i&1&&(s(0,"small",56),l(1,"Formato non valido (max 11 cifre)"),n())}function nt(i,t){if(i&1&&(s(0,"option",61),l(1),n()),i&2){let e=t.$implicit;c("value",e),r(),u(e)}}function at(i,t){if(i&1&&(s(0,"select",58)(1,"option",59),l(2,"\u2014 Seleziona \u2014"),n(),p(3,nt,2,2,"option",60),n()),i&2){let e=d(2);r(3),c("ngForOf",e.formuleSocietarie)}}function rt(i,t){if(i&1&&(s(0,"span",19),l(1),n()),i&2){let e,a=d(2);r(),u(((e=a.soggettoData())==null?null:e.formula_societaria)||"\u2014")}}function lt(i,t){i&1&&(s(0,"small",56),l(1,"Campo obbligatorio"),n())}function st(i,t){if(i&1&&(s(0,"option",61),l(1),n()),i&2){let e=t.$implicit;c("value",e),r(),u(e)}}function ct(i,t){if(i&1&&(s(0,"select",62)(1,"option",59),l(2,"\u2014 Seleziona \u2014"),n(),p(3,st,2,2,"option",60),n()),i&2){let e=d(2);r(3),c("ngForOf",e.categorieAtecoMacro)}}function dt(i,t){if(i&1&&(s(0,"span",19),l(1),n()),i&2){let e,a=d(2);r(),u(((e=a.soggettoData())==null?null:e.categoria_ateco)||"\u2014")}}function mt(i,t){if(i&1){let e=M();s(0,"div",68),E("click",function(){let o=y(e).$implicit,m=d(4);return C(m.onProvinciaSelect(o))}),s(1,"div",69)(2,"strong"),l(3),n(),s(4,"span",70),l(5),n()(),s(6,"small",71),l(7),n()()}if(i&2){let e=t.$implicit;r(3),u(e.name),r(2),v("(",e.code,")"),r(2),u(e.region)}}function pt(i,t){if(i&1&&(s(0,"div",66),p(1,mt,8,3,"div",67),n()),i&2){let e=d(3);r(),c("ngForOf",e.filteredProvinces.slice(0,8))}}function gt(i,t){if(i&1){let e=M();s(0,"div",63)(1,"input",64),oe("ngModelChange",function(o){y(e);let m=d(2);return ie(m.provinciaSearch,o)||(m.provinciaSearch=o),C(o)}),E("input",function(o){y(e);let m=d(2);return C(m.onProvinciaSearchChange(o.target.value))})("focus",function(){y(e);let o=d(2);return C(o.onProvinciaFocus())})("blur",function(){y(e);let o=d(2);return C(o.onProvinciaBlur())}),n(),p(2,pt,2,1,"div",65),n()}if(i&2){let e=d(2);r(),te("ngModel",e.provinciaSearch),c("ngModelOptions",L(3,Re)),r(),c("ngIf",e.showProvinceDropdown&&e.filteredProvinces.length>0)}}function ut(i,t){if(i&1&&(s(0,"span",19),l(1),n()),i&2){let e,a=d(2);r(),u(a.getProvinciaName(((e=a.soggettoData())==null?null:e.provincia)||"")||"\u2014")}}function _t(i,t){i&1&&f(0,"input",72)}function ft(i,t){if(i&1&&(s(0,"span",19),l(1),n()),i&2){let e,a=d(2);r(),u(((e=a.soggettoData())==null?null:e.comune)||"\u2014")}}function vt(i,t){i&1&&f(0,"input",73)}function xt(i,t){if(i&1&&(s(0,"span",19),l(1),n()),i&2){let e,a=d(2);r(),u(((e=a.soggettoData())==null?null:e.indirizzo)||"\u2014")}}function ht(i,t){i&1&&f(0,"input",74)}function St(i,t){if(i&1&&(s(0,"span",19),l(1),n()),i&2){let e,a=d(2);r(),u(((e=a.soggettoData())==null?null:e.numero_civico)||"\u2014")}}function bt(i,t){if(i&1&&(s(0,"div",17)(1,"span",18)(2,"span",16),l(3,"location_on"),n(),l(4," Coordinate "),n(),s(5,"span",19),l(6),h(7,"number"),h(8,"number"),n()()),i&2){let e,a=d(2);r(6),v(" ",(e=a.soggettoData())!=null&&e.latitude&&((e=a.soggettoData())!=null&&e.longitude)?S(7,1,(e=a.soggettoData())==null?null:e.latitude,"1.4-4")+", "+S(8,4,(e=a.soggettoData())==null?null:e.longitude,"1.4-4"):"\u2014"," ")}}function yt(i,t){i&1&&f(0,"input",75)}function Ct(i,t){if(i&1&&(s(0,"span",19),l(1),n()),i&2){let e,a=d(2);r(),u(((e=a.soggettoData())==null?null:e.referente)||"\u2014")}}function Et(i,t){i&1&&f(0,"input",76)}function Pt(i,t){if(i&1&&(s(0,"span",19),l(1),n()),i&2){let e,a=d(2);r(),u(((e=a.soggettoData())==null?null:e.telefono)||"\u2014")}}function wt(i,t){i&1&&(s(0,"small",56),l(1,"Numero non valido"),n())}function It(i,t){i&1&&f(0,"input",77)}function At(i,t){if(i&1&&(s(0,"span",19),l(1),n()),i&2){let e,a=d(2);r(),u(((e=a.soggettoData())==null?null:e.email)||"\u2014")}}function Tt(i,t){i&1&&(s(0,"small",56),l(1,"Email non valida"),n())}function zt(i,t){i&1&&f(0,"input",78)}function Mt(i,t){if(i&1&&(s(0,"span",19),l(1),n()),i&2){let e,a=d(2);r(),u(((e=a.soggettoData())==null?null:e.sito_web)||"\u2014")}}function Nt(i,t){i&1&&(s(0,"small",56),l(1,"URL non valido"),n())}function Dt(i,t){i&1&&f(0,"input",79)}function Vt(i,t){if(i&1&&(s(0,"span",19),l(1),n()),i&2){let e,a=d(2);r(),u(((e=a.soggettoData())==null?null:e.facebook)||"\u2014")}}function Ot(i,t){i&1&&f(0,"input",80)}function kt(i,t){if(i&1&&(s(0,"span",19),l(1),n()),i&2){let e,a=d(2);r(),u(((e=a.soggettoData())==null?null:e.instagram)||"\u2014")}}function Ft(i,t){if(i&1&&(s(0,"option",61),l(1),n()),i&2){let e=t.$implicit;c("value",e),r(),u(e)}}function Bt(i,t){if(i&1&&(s(0,"select",81)(1,"option",59),l(2,"\u2014 Non specificato \u2014"),n(),p(3,Ft,2,2,"option",60),n()),i&2){let e=d(2);r(3),c("ngForOf",e.metodiPagamento)}}function Lt(i,t){if(i&1&&(s(0,"span",19),l(1),n()),i&2){let e,a=d(2);r(),u(((e=a.soggettoData())==null?null:e.metodo_pagamento)||"\u2014")}}function Rt(i,t){i&1&&f(0,"input",82)}function Gt(i,t){if(i&1&&(s(0,"span",19),l(1),n()),i&2){let e,a=d(2);r(),u(((e=a.soggettoData())==null?null:e.iban)||"\u2014")}}function Yt(i,t){i&1&&(s(0,"small",56),l(1,"IBAN non valido"),n())}function $t(i,t){i&1&&f(0,"textarea",83)}function Ut(i,t){if(i&1&&(s(0,"span",19),l(1),n()),i&2){let e,a=d(2);r(),u(((e=a.soggettoData())==null?null:e.note)||"\u2014")}}function Ht(i,t){if(i&1){let e=M();s(0,"div",89)(1,"input",90),E("change",function(o){let m=y(e).$implicit,_=d(4);return C(_.toggleProduct(m,o.target.checked))}),n(),s(2,"label",91),l(3),n()()}if(i&2){let e=t.$implicit,a=t.index,o=d(4);r(),c("id","prod-"+a)("checked",o.isProductSelected(e)),Q("aria-label","Seleziona prodotto "+e),r(),c("title",ne(e))("for","prod-"+a),r(),v(" ",e," ")}}function Wt(i,t){if(i&1&&(s(0,"div",85),p(1,Ht,4,7,"div",86),s(2,"div",87)(3,"small",88),l(4,"Promethea e YUVI vengono aggiunti automaticamente quando presenti."),n()()()),i&2){let e=d(3);r(),c("ngForOf",e.prodottiFiltered())}}function jt(i,t){if(i&1&&(s(0,"span",19),l(1),n()),i&2){let e=d(3);r(),v(" ",e.prodottoDisplay()||"\u2014"," ")}}function qt(i,t){if(i&1&&(s(0,"fieldset",30)(1,"legend",5)(2,"span",16),l(3,"widgets"),n(),l(4," Prodotto "),n(),s(5,"div",31)(6,"label",35)(7,"span",18)(8,"span",16),l(9,"apps"),n(),l(10," Prodotto assegnato"),n(),p(11,Wt,5,1,"div",84)(12,jt,2,1,"span",33),n()()()),i&2){let e=d(2);r(11),c("ngIf",e.mode()!=="view"),r(),c("ngIf",e.mode()==="view")}}function Zt(i,t){if(i&1&&(s(0,"span",95),l(1),h(2,"date"),n()),i&2){let e,a=d(3);r(),v(" Creato il ",S(2,1,(e=a.soggettoData())==null?null:e.created_at,"dd/MM/yyyy HH:mm")," ")}}function Xt(i,t){if(i&1&&(s(0,"span",95),l(1),h(2,"date"),n()),i&2){let e,a=d(3);r(),v(" Aggiornato il ",S(2,1,(e=a.soggettoData())==null?null:e.updated_at,"dd/MM/yyyy HH:mm")," ")}}function Kt(i,t){if(i&1&&(s(0,"span",104)(1,"small"),l(2),h(3,"number"),n()()),i&2){let e,a=d(4);r(2),v("(da ",S(3,1,(e=a.configurazionePromethea())==null?null:e.totale_mensile,"1.0-2")," \u20AC)")}}function Jt(i,t){if(i&1&&(s(0,"span",104)(1,"small"),l(2),h(3,"number"),n()()),i&2){let e,a=d(4);r(2),v("(da ",S(3,1,(e=a.configurazionePromethea())==null?null:e.totale_una_tantum,"1.0-2")," \u20AC)")}}function Qt(i,t){if(i&1&&(s(0,"span"),l(1),h(2,"number"),n()),i&2){let e,a=d(4);r(),ee(" \u2014 sconto ",S(2,2,(e=a.configurazionePromethea())==null?null:e._sconto_percentuale,"1.2-2"),"% (",(e=a.configurazionePromethea())==null?null:e._sconto_target,")")}}function ei(i,t){if(i&1){let e=M();s(0,"button",105),E("click",function(){y(e);let o=d(4);return C(o.apriConfigurazione())}),s(1,"span",16),l(2,"description"),n(),l(3," Vai al Preventivo "),n()}}function ti(i,t){if(i&1&&(s(0,"fieldset",96)(1,"legend",5),f(2,"img",97),l(3," Configurazione Promethea "),n(),s(4,"div",98)(5,"div",99)(6,"h3",100),l(7),n(),s(8,"p",101),l(9," Totale mensile: "),s(10,"strong"),l(11),h(12,"number"),n(),p(13,Kt,4,4,"span",102),f(14,"br"),l(15," Totale una tantum: "),s(16,"strong"),l(17),h(18,"number"),n(),p(19,Jt,4,4,"span",102),f(20,"br"),s(21,"small",88),l(22," Totale complessivo scontato: "),s(23,"strong"),l(24),h(25,"number"),n(),p(26,Qt,3,5,"span",9),n()(),p(27,ei,4,0,"button",103),n()()()),i&2){let e,a,o,m,_,g,P,b=d(3);r(7),v("N. Preventivo: ",((e=b.configurazionePromethea())==null?null:e.numero_preventivo_formattato)??((e=b.configurazionePromethea())!=null&&e.numero_preventivo?"Preventivo #"+((e=b.configurazionePromethea())==null?null:e.numero_preventivo):"Riepilogo")," "),r(4),v(" ",S(12,8,((a=b.configurazionePromethea())==null?null:a.totale_mensile_scontato)??((a=b.configurazionePromethea())==null?null:a.totale_mensile),"1.0-2")," \u20AC "),r(2),c("ngIf",(o=b.configurazionePromethea())==null?null:o._sconto_percentuale),r(4),v(" ",S(18,11,((m=b.configurazionePromethea())==null?null:m.totale_una_tantum_scontato)??((m=b.configurazionePromethea())==null?null:m.totale_una_tantum),"1.0-2")," \u20AC "),r(2),c("ngIf",(_=b.configurazionePromethea())==null?null:_._sconto_percentuale),r(5),v("",S(25,14,((g=b.configurazionePromethea())==null?null:g.totale_scontato)??((g=b.configurazionePromethea())==null?null:g.totale),"1.0-2")," \u20AC"),r(2),c("ngIf",(P=b.configurazionePromethea())==null?null:P._sconto_percentuale),r(),c("ngIf",b.configurazionePromethea())}}function ii(i,t){if(i&1&&(s(0,"p",88),l(1," Importo: "),s(2,"strong"),l(3),h(4,"number"),n()()),i&2){let e=d().$implicit;r(3),v("",S(4,1,e.importo??e.amount,"1.0-0")," \u20AC")}}function oi(i,t){if(i&1&&(s(0,"p",88),l(1),h(2,"date"),n()),i&2){let e=d().$implicit;r(),v(" Data: ",S(2,1,e.data??e.created_at,"dd/MM/yyyy")," ")}}function ni(i,t){if(i&1){let e=M();s(0,"div",109)(1,"div",110)(2,"h3",100),l(3),h(4,"slice"),n(),s(5,"span",95),l(6),n()(),p(7,ii,5,4,"p",111)(8,oi,3,4,"p",111),s(9,"div",112)(10,"button",113),E("click",function(){let o=y(e).$implicit,m=d(4);return C(m.vaiTrattativaYuviById(o.id))}),s(11,"span",16),l(12,"open_in_new"),n(),l(13," Apri trattativa "),n()()()}if(i&2){let e=t.$implicit;r(3),u(e.nome||"Trattativa "+ae(4,4,e.id,0,8)),r(3),u(e.stato||e.status||"\u2014"),r(),c("ngIf",e.importo||e.amount),r(),c("ngIf",e.data||e.created_at)}}function ai(i,t){if(i&1&&(s(0,"fieldset",96)(1,"legend",5),f(2,"img",106),l(3," Trattative Yuvi "),n(),s(4,"div",107),p(5,ni,14,8,"div",108),n()()),i&2){let e=d(3);r(5),c("ngForOf",e.trattativeYuvi()??L(1,U))}}function ri(i,t){if(i&1&&(s(0,"p",118),l(1),n()),i&2){let e=d().$implicit;r(),u(e.note)}}function li(i,t){if(i&1&&(s(0,"div",116)(1,"div",110)(2,"h3",100),l(3),n(),s(4,"span",95),l(5),h(6,"date"),n()(),p(7,ri,2,1,"p",117),n()),i&2){let e=t.$implicit;r(3),u(e.tipo),r(2),u(S(6,3,e.ts,"dd/MM/yyyy HH:mm")),r(2),c("ngIf",e.note)}}function si(i,t){if(i&1&&(s(0,"fieldset",96)(1,"legend",5)(2,"span",16),l(3,"history"),n(),l(4," Cronologia esiti "),n(),s(5,"div",114),p(6,li,8,6,"div",115),n()()),i&2){let e=d(3);r(6),c("ngForOf",e.esitiOrdinati())}}function ci(i,t){if(i&1&&(G(0),s(1,"div",92),p(2,Zt,3,4,"span",93)(3,Xt,3,4,"span",93),n(),p(4,ti,28,17,"fieldset",94)(5,ai,6,2,"fieldset",94)(6,si,7,1,"fieldset",94),Y()),i&2){let e,a,o=d(2);r(2),c("ngIf",(e=o.soggettoData())==null?null:e.created_at),r(),c("ngIf",(a=o.soggettoData())==null?null:a.updated_at),r(),c("ngIf",o.configurazionePromethea()),r(),c("ngIf",(o.trattativeYuvi()??L(5,U)).length),r(),c("ngIf",o.esitiOrdinati().length)}}function di(i,t){if(i&1){let e=M();s(0,"form",20),E("submit",function(){y(e);let o=d();return C(o.submit())}),s(1,"div",21)(2,"button",22),E("click",function(){y(e);let o=d();return C(o.switchToEdit())}),s(3,"span",16),l(4,"edit"),n(),l(5," Modifica "),n(),s(6,"button",23),E("click",function(){y(e);let o=d();return C(o.apriEsito())}),s(7,"span",16),l(8,"note_add"),n(),l(9," Aggiungi esito "),n(),s(10,"button",24),p(11,We,2,0,"span",25)(12,je,1,0,"span",26),l(13),n()(),s(14,"fieldset",27),p(15,qe,2,1,"span",28)(16,Ze,2,0,"span",28)(17,Xe,2,2,"span",28),s(18,"span",29),l(19," Creato da: "),s(20,"span",19),l(21),n()()(),s(22,"fieldset",30)(23,"legend",5)(24,"span",16),l(25,"apartment"),n(),l(26," Dati aziendali "),n(),s(27,"div",31)(28,"label",17)(29,"span",18)(30,"span",16),l(31,"business"),n(),l(32," Ragione sociale"),n(),p(33,Ke,1,0,"input",32)(34,Je,2,1,"span",33)(35,Qe,2,0,"small",34)(36,et,2,0,"small",34),n(),s(37,"label",35)(38,"span",18)(39,"span",16),l(40,"numbers"),n(),l(41," P.IVA"),n(),p(42,tt,1,0,"input",36)(43,it,2,1,"span",33)(44,ot,2,0,"small",34),n(),s(45,"label",35)(46,"span",18)(47,"span",16),l(48,"domain"),n(),l(49," Formula societaria"),n(),p(50,at,4,1,"select",37)(51,rt,2,1,"span",33)(52,lt,2,0,"small",34),n(),s(53,"label",35)(54,"span",18)(55,"span",16),l(56,"category"),n(),l(57," Categoria merceologica (ATECO macro)"),n(),p(58,ct,4,1,"select",38)(59,dt,2,1,"span",33),n()()(),s(60,"fieldset",30)(61,"legend",5)(62,"span",16),l(63,"place"),n(),l(64," Indirizzo "),n(),s(65,"div",31)(66,"label",35)(67,"span",18)(68,"span",16),l(69,"map"),n(),l(70," Provincia "),n(),p(71,gt,3,4,"div",39)(72,ut,2,1,"span",33),n(),s(73,"label",35)(74,"span",18)(75,"span",16),l(76,"location_city"),n(),l(77," Comune "),n(),p(78,_t,1,0,"input",40)(79,ft,2,1,"span",33),n(),s(80,"label",17)(81,"span",18)(82,"span",16),l(83,"signpost"),n(),l(84," Indirizzo "),n(),p(85,vt,1,0,"input",41)(86,xt,2,1,"span",33),n(),s(87,"label",35)(88,"span",18)(89,"span",16),l(90,"home"),n(),l(91," Numero Civico "),n(),p(92,ht,1,0,"input",42)(93,St,2,1,"span",33),n(),p(94,bt,9,7,"div",10),n()(),s(95,"fieldset",30)(96,"legend",5)(97,"span",16),l(98,"contacts"),n(),l(99," Referente e contatti "),n(),s(100,"div",31)(101,"label",35)(102,"span",18)(103,"span",16),l(104,"badge"),n(),l(105," Referente"),n(),p(106,yt,1,0,"input",43)(107,Ct,2,1,"span",33),n(),s(108,"label",35)(109,"span",18)(110,"span",16),l(111,"call"),n(),l(112," Telefono"),n(),p(113,Et,1,0,"input",44)(114,Pt,2,1,"span",33)(115,wt,2,0,"small",34),n(),s(116,"label",35)(117,"span",18)(118,"span",16),l(119,"mail"),n(),l(120," Email"),n(),p(121,It,1,0,"input",45)(122,At,2,1,"span",33)(123,Tt,2,0,"small",34),n()()(),s(124,"fieldset",30)(125,"legend",5)(126,"span",16),l(127,"public"),n(),l(128," Web e social "),n(),s(129,"div",31)(130,"label",35)(131,"span",18)(132,"span",16),l(133,"language"),n(),l(134," Sito web"),n(),p(135,zt,1,0,"input",46)(136,Mt,2,1,"span",33)(137,Nt,2,0,"small",34),n(),s(138,"label",35)(139,"span",18)(140,"span",16),l(141,"facebook"),n(),l(142," Facebook"),n(),p(143,Dt,1,0,"input",47)(144,Vt,2,1,"span",33),n(),s(145,"label",35)(146,"span",18)(147,"span",16),l(148,"camera_alt"),n(),l(149," Instagram"),n(),p(150,Ot,1,0,"input",48)(151,kt,2,1,"span",33),n()()(),s(152,"fieldset",30)(153,"legend",5)(154,"span",16),l(155,"payments"),n(),l(156," Pagamenti "),n(),s(157,"div",31)(158,"label",35)(159,"span",18)(160,"span",16),l(161,"account_balance_wallet"),n(),l(162," Metodo di pagamento"),n(),p(163,Bt,4,1,"select",49)(164,Lt,2,1,"span",33),n(),s(165,"label",17)(166,"span",18)(167,"span",16),l(168,"credit_card"),n(),l(169," IBAN"),n(),p(170,Rt,1,0,"input",50)(171,Gt,2,1,"span",33)(172,Yt,2,0,"small",34),n()()(),s(173,"fieldset",30)(174,"legend",5)(175,"span",16),l(176,"notes"),n(),l(177," Note "),n(),s(178,"div",31)(179,"label",17),p(180,$t,1,0,"textarea",51)(181,Ut,2,1,"span",33),n()()(),p(182,qt,13,2,"fieldset",52)(183,ci,7,6,"ng-container",9),n()}if(i&2){let e,a,o=d();N("view-mode",o.mode()==="view"),c("formGroup",o.form),r(6),c("disabled",!((e=o.soggettoData())!=null&&e.id)),r(4),c("disabled",o.form.invalid||o.isSubmitting()),r(),c("ngIf",!o.isSubmitting()),r(),c("ngIf",o.isSubmitting()),r(),v(" ",o.isSubmitting()?"Salvataggio...":o.mode()==="create"?"Crea":"Aggiorna"," "),r(),N("disabled",o.mode()==="view"),r(),c("ngIf",o.prodottoDisplay()),r(),c("ngIf",o.configurazionePromethea()),r(),c("ngIf",(o.trattativeYuvi()??L(71,U)).length),r(4),u(o.creatorName()||((a=o.soggettoData())==null?null:a.created_by)||"\u2014"),r(),N("disabled",o.mode()==="view"),r(11),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(),c("ngIf",o.mode()!=="view"&&o.hasError("ragioneSociale","required")),r(),c("ngIf",o.mode()!=="view"&&o.hasError("ragioneSociale","minlength")),r(6),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(),c("ngIf",o.mode()!=="view"&&o.hasError("piva","pattern")),r(6),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(),c("ngIf",o.mode()!=="view"&&o.hasError("formulaSocietaria","required")),r(6),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(),N("disabled",o.mode()==="view"),r(11),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(6),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(6),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(6),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(),c("ngIf",o.mode()==="view"),r(),N("disabled",o.mode()==="view"),r(11),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(6),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(),c("ngIf",o.mode()!=="view"&&o.hasError("telefono","pattern")),r(6),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(),c("ngIf",o.mode()!=="view"&&o.hasError("email","email")),r(),N("disabled",o.mode()==="view"),r(11),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(),c("ngIf",o.mode()!=="view"&&o.hasError("sitoWeb","pattern")),r(6),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(6),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(),N("disabled",o.mode()==="view"),r(11),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(6),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(),c("ngIf",o.mode()!=="view"&&o.hasError("iban","pattern")),r(),N("disabled",o.mode()==="view"),r(7),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view"),r(),c("ngIf",o.mode()!=="view"),r(),c("ngIf",o.mode()==="view")}}var Be=class i{fb=z(Ie);route=z(ge);router=z(ue);location=z(re);soggettiService=z(ze);alchemizzatoreService=z(Ne);geoService=z($);userService=z(fe);supa=z(_e);creatorName=I(null);mode=I("create");loading=I(!1);isSubmitting=I(!1);esitoPopupOpen=I(!1);selectedProducts=I([]);prodottiDynamic=[];tipo=I("prospect");id=I(null);soggettoData=I(null);configurazionePromethea=I(null);trattativeYuvi=I(null);form;provinces=[];filteredProvinces=[];showProvinceDropdown=!1;selectedProvince="";provinciaSearch="";prodotti=De;formuleSocietarie=Ve;categorieAtecoMacro=Oe;metodiPagamento=ke;submitCooldown=!1;titolo=O(()=>{let t=e=>e==="cliente"?"Cliente":e==="fornitore"?"Fornitore":"Prospect";switch(this.mode()){case"create":return`Nuovo ${t(this.tipo())}`;case"edit":return`Modifica ${t(this.tipo())}`;case"view":return this.soggettoData()?.ragione_sociale||"Scheda soggetto"}});sottotitolo=O(()=>{let t=this.tipo();return t==="cliente"?"Cliente":t==="fornitore"?"Fornitore":"Prospect"});icona=O(()=>{let t=this.tipo();return t==="cliente"?"person":t==="fornitore"?"local_shipping":"person_search"});prodottoDisplay=O(()=>{let e=((this.soggettoData()?.prodotto??"")?.toString()??"").split(",").map(o=>o.trim()).filter(Boolean),a=new Set(e.map(o=>o.toLowerCase()));return this.configurazionePromethea()&&(a.has("promethea")||(e.unshift("Promethea"),a.add("promethea"))),(this.trattativeYuvi()??[]).length&&(a.has("yuvi")||(e.push("YUVI"),a.add("yuvi"))),e.length?e.join(", "):null});isCliente=O(()=>this.tipo()==="cliente");esitiOrdinati=O(()=>[...Array.isArray(this.soggettoData()?.esiti)?this.soggettoData()?.esiti:[]].sort((e,a)=>new Date(a.ts).getTime()-new Date(e.ts).getTime()));ngOnInit(){return T(this,null,function*(){this.provinces=this.geoService.getProvinces(),this.filteredProvinces=this.provinces,yield this.loadProdotti(),yield this.determineModeAndParams(),this.initializeForm(),this.mode()!=="create"&&this.id()&&(yield this.loadSoggetto(this.id()),this.mode()==="view"&&(yield this.loadConfigurazionePromethea(this.id()),yield this.loadTrattativeYuvi(this.id()))),this.route.paramMap.subscribe(t=>T(this,null,function*(){yield this.determineModeAndParams()}))})}determineModeAndParams(){return T(this,null,function*(){let t=this.route.snapshot.paramMap.get("id"),e=(this.route.snapshot.paramMap.get("tipo")||"").toLowerCase(),a=this.router.url;["cliente","fornitore","prospect"].includes(e)&&this.tipo.set(e),t?(this.id.set(t),a.includes("/edit")?this.mode.set("edit"):this.mode.set("view")):this.mode.set("create")})}initializeForm(){this.form=this.fb.group({ragioneSociale:["",[A.required,A.minLength(2)]],piva:["",[A.pattern(/^\d{0,11}$/)]],formulaSocietaria:[""],categoriaAteco:[""],referente:[""],telefono:["",[A.pattern(/^[+]?[\d\s\-()]{0,}$/)]],email:["",[A.email]],sitoWeb:["",[A.pattern(/^(https?:\/\/)?([\w\-]+\.)+[\w\-]{2,}(\/.*)?$|^$/i)]],facebook:[""],instagram:[""],iban:["",[A.pattern(/^[A-Z]{2}\d{2}[A-Z0-9]{0,30}$|^$/i)]],metodoPagamento:[""],note:[""],prodotto:["Promethea"],provincia:[""],comune:[""],indirizzo:[""],numeroCivico:[""]}),this.updateConditionalValidators(),this.form.get("metodoPagamento").valueChanges.subscribe(t=>{let e=this.form.get("iban");t==="Bonifico"||t==="SEPA Direct Debit"?e.enable({emitEvent:!1}):(e.disable({emitEvent:!1}),e.reset("",{emitEvent:!1}))})}loadSoggetto(t){return T(this,null,function*(){this.loading.set(!0);let{data:e,error:a}=yield this.soggettiService.getSoggettoById(t);if(a||!e){alert("Impossibile caricare il soggetto selezionato"),this.loading.set(!1);return}if(this.tipo.set(e.tipo),this.soggettoData.set(e),this.creatorName.set(null),console.log("[AddSoggetto] loadSoggetto id=",t,"created_by=",e.created_by),e.created_by)try{let o=yield this.userService.getUserById(e.created_by);if(console.log("[AddSoggetto] getUserById result=",o),o&&o.data&&!o.error){let m=[o.data.first_name,o.data.last_name].filter(Boolean).join(" ").trim();this.creatorName.set(m||o.data.email||e.created_by),this.soggettoData.set(X(j({},e),{created_by_user:{id:o.data.id,first_name:o.data.first_name??null,last_name:o.data.last_name??null}}))}else console.warn("[AddSoggetto] user not found or error:",o?.error),this.creatorName.set(e.created_by)}catch(o){console.warn("Errore recupero creatore:",o),this.creatorName.set(e.created_by)}if(e.provincia){this.selectedProvince=e.provincia;let o=this.geoService.getProvinceByCode(e.provincia);o&&(this.provinciaSearch=`${o.name} (${o.code})`)}if(this.mode()==="edit"){let m=String(e.prodotto||"").split(",").map(_=>_.trim()).filter(Boolean).filter(_=>{let g=String(_).toLowerCase();return g!=="promethea"&&g!=="yuvi"});this.selectedProducts.set(m),this.form.patchValue({ragioneSociale:e.ragione_sociale,piva:e.piva,formulaSocietaria:e.formula_societaria,categoriaAteco:e.categoria_ateco,prodotto:m.join(","),referente:e.referente,telefono:e.telefono,email:e.email,sitoWeb:e.sito_web,facebook:e.facebook,instagram:e.instagram,metodoPagamento:e.metodo_pagamento,iban:e.iban,note:e.note,provincia:e.provincia,comune:e.comune,indirizzo:e.indirizzo,numeroCivico:e.numero_civico}),this.updateConditionalValidators()}this.loading.set(!1)})}loadConfigurazionePromethea(t){return T(this,null,function*(){try{let e=yield this.alchemizzatoreService.getConfigurazioniByProspect(t);if(console.log("[loadConfigurazionePromethea] raw result:",e),!e||e.error){console.warn("[loadConfigurazionePromethea] no config or error:",e?.error),this.configurazionePromethea.set(null);return}let a=(e.data??[]).at(0)??null;if(!a){this.configurazionePromethea.set(null);return}let o=a,m=[],_=o.dettagli??o.items??o.lines??o.struttura??o;Array.isArray(_)?m=_.slice():_&&typeof _=="object"?Object.values(_).forEach(x=>{if(!x)return;let B=x.servizi_selezionati??x.servizi??x.items??[];Array.isArray(B)&&m.push(...B)}):["immagine_marketing","contabilita_fiscalita","ottimizzazione_management","digitalizzazione_automatismi"].forEach(B=>{let D=o[B];if(D){let V=D.servizi_selezionati??D.servizi??[];Array.isArray(V)&&m.push(...V)}});let g=0,P=0;m.forEach(x=>{if(!x)return;let B=(x.id??x.key??"").toString(),D=Number(x.prezzo_mensile??x.prezzoMensile??x.price_monthly??x.priceMonthly??0)||0,V=Number(x.prezzo??x.price??x.totale??x.valore??0)||0;D>0&&(g+=D),B.startsWith("social_")&&D===0&&V>0?g+=V:V>0&&(P+=V)}),typeof o.totale_mensile=="number"&&(g=o.totale_mensile||g),typeof o.totale_una_tantum=="number"&&(P=o.totale_una_tantum||P),g=Number(g.toFixed(2)),P=Number(P.toFixed(2));let b=Number((g+P).toFixed(2)),R=o.meta??o.dettagli?.meta??{},k=Number(R.scontoPercentuale??R.sconto_percentuale??R.sconto??0)||0,F=(R.scontoTarget??R.sconto_target??"una").toString().toLowerCase(),H=k>0&&(F==="mensile"||F==="entrambi")?Number((g*(1-k/100)).toFixed(2)):g,W=k>0&&(F==="una"||F==="entrambi")?Number((P*(1-k/100)).toFixed(2)):P,Z=Number((H+W).toFixed(2)),w=j({},o);w.totale_mensile=g,w.totale_una_tantum=P,w.totale=b,w.totale_mensile_scontato=H,w.totale_una_tantum_scontato=W,w.totale_scontato=Z,w._sconto_percentuale=k,w._sconto_target=F,console.log("[loadConfigurazionePromethea] calcolati:",{totaleMensile:w.totale_mensile,totaleUnaTantum:w.totale_una_tantum,totale:w.totale,mensileScontato:H,unaScontata:W,totaleScontato:Z,scontoPercentuale:k,scontoTarget:F}),this.configurazionePromethea.set(w)}catch(e){console.error("[loadConfigurazionePromethea] error",e),this.configurazionePromethea.set(null)}})}loadTrattativeYuvi(t){return T(this,null,function*(){try{console.log("[loadTrattativeYuvi] ricerca trattative_yuvi per prospect",t);let e=this.soggettiService.supabaseService?.supabase??this.soggettiService.supabase;if(!e){console.warn("[loadTrattativeYuvi] supabase client non disponibile su soggettiService"),this.trattativeYuvi.set([]);return}let{data:a,error:o}=yield e.from("trattative_yuvi").select("*").eq("prospect_id",t).order("created_at",{ascending:!1});if(o){console.warn("[loadTrattativeYuvi] query errore:",o),this.trattativeYuvi.set([]);return}let m=Array.isArray(a)?a:a?[a]:[];console.log("[loadTrattativeYuvi] raw rows count:",m.length,m.slice(0,3));let _=m.map(g=>({id:g.id??g.uuid??g.trattativa_id??null,nome:g.nome??g.title??g.name??`Trattativa ${String(g.id??"").slice(0,8)}`,stato:g.stato??g.status??null,importo:g.importo??g.amount??g.totale??null,data:g.created_at??g.data??g.ts??null,prospectId:g.prospect_id??g.prospectId??null,raw:g})).filter(g=>!!g.id);console.log("[loadTrattativeYuvi] normalizzate count",_.length,_.slice(0,3)),this.trattativeYuvi.set(_)}catch(e){console.error("[loadTrattativeYuvi] eccezione",e),this.trattativeYuvi.set([])}})}vaiTrattativaYuviById(t){return T(this,null,function*(){let e=this.soggettoData();if(e?.id)try{let a=this.soggettiService.supabaseService?.supabase??this.soggettiService.supabase;if(!a){alert("Client Supabase non disponibile");return}let o=null;if(t){let{data:m,error:_}=yield a.from("trattative_yuvi").select("*").eq("id",t).single();!_&&m&&(o=m)}if(!o){let{data:m,error:_}=yield a.from("trattative_yuvi").select("*").eq("prospect_id",e.id).order("created_at",{ascending:!1}).limit(1).single();!_&&m&&(o=m)}if(!o){alert("Nessuna trattativa YUVI trovata per questo prospect");return}this.router.navigate(["/yuvi-trattativa"],{queryParams:{prospectId:e.id,trattativaId:o.id,step:7},state:{prospect:e,trattativaEsistente:o,from:"add-soggetto"}})}catch(a){console.error("Errore apertura trattativa Yuvi:",a),alert("Errore nel caricamento della trattativa: "+(a?.message??String(a)))}})}vaiTrattativaYuvi(){let t=(this.trattativeYuvi()??[]).at(0);t?.id&&this.vaiTrattativaYuviById(t.id)}apriConfigurazione(){let t=this.configurazionePromethea();t?.id&&this.router.navigate(["/preventivo",t.id])}switchToEdit(){this.id()&&this.router.navigate(["/soggetto",this.id(),"edit"])}cancel(){if(this.id())this.router.navigate(["/soggetto",this.id()]);else{let t=globalThis?.history;t&&typeof t.length=="number"&&t.length>1?this.location.back():this.router.navigate([this.tipo()==="prospect"?"/lista-prospect":"/home"])}}navigateBack(){let t=globalThis?.history;t&&typeof t.length=="number"&&t.length>1?this.location.back():this.router.navigate([this.tipo()==="prospect"?"/lista-prospect":"/home"])}submit(){return T(this,null,function*(){if(this.submitCooldown||this.isSubmitting())return;if(this.submitCooldown=!0,setTimeout(()=>{this.submitCooldown=!1},2e3),this.form.markAllAsTouched(),this.form.invalid){alert("Compila tutti i campi obbligatori correttamente");return}this.isSubmitting.set(!0);let t=this.form.value;try{let e=this.selectedProducts().length?this.selectedProducts().join(","):t.prodotto||"";if(this.mode()==="edit"&&this.id()){let a={id:this.id(),ragioneSociale:t.ragioneSociale,piva:t.piva?.trim()??"",formulaSocietaria:t.formulaSocietaria,categoriaAteco:t.categoriaAteco,referente:t.referente,telefono:t.telefono,email:t.email,sitoWeb:t.sitoWeb,facebook:t.facebook,instagram:t.instagram,metodoPagamento:t.metodoPagamento,iban:t.iban,note:t.note,prodotto:e,provincia:t.provincia,comune:t.comune,indirizzo:t.indirizzo,numeroCivico:t.numeroCivico},o=yield this.soggettiService.updateSoggetto(a);if(!o.success)throw new Error(o.error);if(t.provincia||t.comune){console.log("\u{1F504} Geocodifica automatica dopo modifica...");let m=yield this.soggettiService.geocodificaEAggiornaSoggetto(this.id());m.success?console.log("\u2705 Coordinate aggiornate con successo"):console.warn("\u26A0\uFE0F Geocodifica non riuscita:",m.error)}alert("Anagrafica aggiornata con successo"),this.router.navigate(["/soggetto",this.id()])}else if(this.mode()==="create"){let a={tipo:this.tipo(),ragioneSociale:t.ragioneSociale,piva:t.piva?.trim()||void 0,formulaSocietaria:t.formulaSocietaria,categoriaAteco:t.categoriaAteco,referente:t.referente,telefono:t.telefono,email:t.email,sitoWeb:t.sitoWeb,facebook:t.facebook,instagram:t.instagram,metodoPagamento:t.metodoPagamento,iban:t.iban,note:t.note,prodotto:e||"Promethea",provincia:t.provincia,comune:t.comune,indirizzo:t.indirizzo,numeroCivico:t.numeroCivico},o=yield this.soggettiService.createSoggetto(a);if(!o.success)throw new Error(o.error);if(o.data&&o.data.id){if(t.provincia||t.comune){console.log("\u{1F504} Geocodifica automatica dopo creazione...");let m=yield this.soggettiService.geocodificaEAggiornaSoggetto(o.data.id);m.success?console.log("\u2705 Coordinate aggiornate con successo"):console.warn("\u26A0\uFE0F Geocodifica non riuscita:",m.error)}alert(`${this.titolo()} aggiunto con successo!`),this.router.navigate(["/soggetto",o.data.id])}else throw new Error("ID del soggetto non restituito dal server")}}catch(e){console.error("Errore durante il salvataggio:",e),alert(`Errore: ${e?.message||"Operazione non riuscita"}`)}finally{this.isSubmitting.set(!1)}})}apriEsito(){this.soggettoData()?.id&&this.esitoPopupOpen.set(!0)}onEsitoPopupClosed(t){return T(this,null,function*(){this.esitoPopupOpen.set(!1),t.saved&&this.id()&&(yield this.loadSoggetto(this.id()))})}updateConditionalValidators(){let t=this.tipo()!=="prospect",e=this.form.get("ragioneSociale"),a=this.form.get("formulaSocietaria");t?(e.addValidators(A.required),a.removeValidators(A.required)):(e.removeValidators(A.required),a.removeValidators(A.required)),e.updateValueAndValidity(),a.updateValueAndValidity()}hasError(t,e){let a=this.form.get(t);return!!(a&&a.touched&&a.hasError(e))}onProvinciaSearchChange(t){if(this.provinciaSearch=t,!t||t.length<1){this.filteredProvinces=[];return}this.filteredProvinces=this.geoService.searchProvinces(t),this.showProvinceDropdown=!0}onProvinciaSelect(t){this.selectedProvince=t.code,this.provinciaSearch=`${t.name} (${t.code})`,this.form.patchValue({provincia:t.code}),this.filteredProvinces=[],this.showProvinceDropdown=!1}onProvinciaFocus(){this.provinciaSearch.length>0&&(this.filteredProvinces=this.geoService.searchProvinces(this.provinciaSearch)),this.showProvinceDropdown=!0}onProvinciaBlur(){setTimeout(()=>{this.showProvinceDropdown=!1},200)}getProvinciaName(t){if(!t)return"";let e=this.geoService.getProvinceByCode(t);return e?`${e.name} (${e.code})`:t}prodottiFiltered=()=>{let t=Array.isArray(this.prodotti)?this.prodotti.map(a=>typeof a=="string"?a:a.nome??""):[];return Array.from(new Map([...t,...this.prodottiDynamic].filter(Boolean).map(a=>[a.toLowerCase(),a])).values()).filter(a=>{let o=(a??"").toString().toLowerCase();return o!=="promethea"&&o!=="yuvi"})};isProductSelected(t){return this.selectedProducts().includes(t)}toggleProduct(t,e){let a=[...this.selectedProducts()];if(e)a.includes(t)||a.push(t);else{let o=a.indexOf(t);o>=0&&a.splice(o,1)}this.selectedProducts.set(a),this.form&&this.form.patchValue({prodotto:a.join(",")},{emitEvent:!1})}loadProdotti(){return T(this,null,function*(){try{let t=yield this.supa.getProdotti();if(t?.error||!Array.isArray(t.data)){this.prodottiDynamic=Array.isArray(this.prodotti)?this.prodotti.map(o=>typeof o=="string"?o:o.nome??"").filter(Boolean):[];return}let e=(t.data??[]).map(o=>String(o.nome??"").trim()).filter(Boolean),a=new Map;e.forEach(o=>a.set(o.toLowerCase(),o)),this.prodottiDynamic=Array.from(a.values())}catch(t){console.warn("[add-soggetto] loadProdotti failed",t),this.prodottiDynamic=Array.isArray(this.prodotti)?this.prodotti.map(e=>typeof e=="string"?e:e.nome??"").filter(Boolean):[]}})}onCtrlS(t){t.preventDefault(),this.mode()!=="view"&&!this.isSubmitting()&&this.submit()}static \u0275fac=function(e){return new(e||i)};static \u0275cmp=J({type:i,selectors:[["app-soggetto"]],hostBindings:function(e,a){e&1&&E("keydown.control.s",function(m){return a.onCtrlS(m)},q)("keydown.meta.s",function(m){return a.onCtrlS(m)},q)},decls:16,vars:11,consts:[["title","Caricamento in corso","subtitle","Recupero informazioni dal database...",3,"isLoading",4,"ngIf"],[1,"add-wrapper"],[1,"section-header"],[1,"material-icons","header-icon"],[1,"section-titles"],[1,"section-title"],["class","section-subtitle",4,"ngIf"],[1,"flex-1"],[1,"actions-container"],[4,"ngIf"],["class","form-field form-field-col-span",4,"ngIf"],["class","form-sections","id","soggettoForm",3,"formGroup","view-mode","submit",4,"ngIf"],[3,"closed","open","soggettoId","tipo"],["title","Caricamento in corso","subtitle","Recupero informazioni dal database...",3,"isLoading"],[1,"section-subtitle"],["type","button",1,"promethea-button","ghost",3,"click"],[1,"material-icons"],[1,"form-field","form-field-col-span"],[1,"form-label"],[1,"view-value"],["id","soggettoForm",1,"form-sections",3,"submit","formGroup"],[1,"actions-container","sticky-actions",2,"flex-direction","row"],["type","button",1,"promethea-button",3,"click"],["type","button",1,"promethea-button",3,"click","disabled"],["type","submit","form","soggettoForm",1,"promethea-button",3,"disabled"],["class","material-icons",4,"ngIf"],["class","loading-spinner",4,"ngIf"],[2,"padding","var(--gutter-sm)","border","1px solid var(--smoke-color-1)","border-radius","16px","box-shadow","0 4px 12px var(--shadow)","gap","var(--gutter-sm)"],["class","chip info","style","margin: var(--gutter-sm) ;",4,"ngIf"],[2,"margin","var(--gutter-sm)"],[1,"form-section"],[1,"grid-form"],["type","text","formControlName","ragioneSociale","placeholder","Es. Acme S.r.l.",4,"ngIf"],["class","view-value",4,"ngIf"],["class","error",4,"ngIf"],[1,"form-field"],["type","text","formControlName","piva","placeholder","Opzionale - 11 cifre","inputmode","numeric",4,"ngIf"],["formControlName","formulaSocietaria",4,"ngIf"],["formControlName","categoriaAteco",4,"ngIf"],["class","autocomplete-container",4,"ngIf"],["type","text","formControlName","comune","placeholder","Es. Trieste",4,"ngIf"],["type","text","formControlName","indirizzo","placeholder","Es. Via Roma",4,"ngIf"],["type","text","formControlName","numeroCivico","placeholder","Es. 123",4,"ngIf"],["type","text","formControlName","referente","placeholder","Es. Mario Rossi",4,"ngIf"],["type","tel","formControlName","telefono","placeholder","+39 ...","inputmode","tel",4,"ngIf"],["type","email","formControlName","email","placeholder","nome@dominio.tld",4,"ngIf"],["type","url","formControlName","sitoWeb","placeholder","https://...",4,"ngIf"],["type","url","formControlName","facebook","placeholder","https://facebook.com/...",4,"ngIf"],["type","url","formControlName","instagram","placeholder","https://instagram.com/...",4,"ngIf"],["formControlName","metodoPagamento",4,"ngIf"],["type","text","formControlName","iban","placeholder","IT60X0542811101000000123456",4,"ngIf"],["rows","4","formControlName","note","placeholder","Aggiungi note utili...",4,"ngIf"],["class","form-section",4,"ngIf"],[1,"loading-spinner"],[1,"chip","info",2,"margin","var(--gutter-sm)"],["type","text","formControlName","ragioneSociale","placeholder","Es. Acme S.r.l."],[1,"error"],["type","text","formControlName","piva","placeholder","Opzionale - 11 cifre","inputmode","numeric"],["formControlName","formulaSocietaria"],["value",""],[3,"value",4,"ngFor","ngForOf"],[3,"value"],["formControlName","categoriaAteco"],[1,"autocomplete-container"],["type","text","placeholder","Cerca provincia...","autocomplete","off",3,"ngModelChange","input","focus","blur","ngModel","ngModelOptions"],["class","autocomplete-dropdown",4,"ngIf"],[1,"autocomplete-dropdown"],["class","autocomplete-item",3,"click",4,"ngFor","ngForOf"],[1,"autocomplete-item",3,"click"],[1,"autocomplete-main"],[1,"province-code"],[1,"autocomplete-secondary"],["type","text","formControlName","comune","placeholder","Es. Trieste"],["type","text","formControlName","indirizzo","placeholder","Es. Via Roma"],["type","text","formControlName","numeroCivico","placeholder","Es. 123"],["type","text","formControlName","referente","placeholder","Es. Mario Rossi"],["type","tel","formControlName","telefono","placeholder","+39 ...","inputmode","tel"],["type","email","formControlName","email","placeholder","nome@dominio.tld"],["type","url","formControlName","sitoWeb","placeholder","https://..."],["type","url","formControlName","facebook","placeholder","https://facebook.com/..."],["type","url","formControlName","instagram","placeholder","https://instagram.com/..."],["formControlName","metodoPagamento"],["type","text","formControlName","iban","placeholder","IT60X0542811101000000123456"],["rows","4","formControlName","note","placeholder","Aggiungi note utili..."],["class","product-checkboxes",4,"ngIf"],[1,"product-checkboxes"],["class","mod-toggle","style","margin:0 0.4rem 0.4rem 0;",4,"ngFor","ngForOf"],[2,"width","100%","margin-top","0.25rem"],[1,"text-muted"],[1,"mod-toggle",2,"margin","0 0.4rem 0.4rem 0"],["type","checkbox",3,"change","id","checked"],[1,"mod-chip",3,"for","title"],[1,"chips-row"],["class","chip outline",4,"ngIf"],["class","form-section view-section",4,"ngIf"],[1,"chip","outline"],[1,"form-section","view-section"],["src","assets/Logo.png","alt","Promethea",1,"section-logo","promethea-logo"],[1,"config-section"],[1,"card","highlight"],[1,"card-title"],[1,"totale"],["class","text-muted","style","margin-left:6px;",4,"ngIf"],["type","button","style","margin-top: var(--gutter-md)","class","promethea-button",3,"click",4,"ngIf"],[1,"text-muted",2,"margin-left","6px"],["type","button",1,"promethea-button",2,"margin-top","var(--gutter-md)",3,"click"],["src","assets/yuvi.png","alt","Yuvi",1,"section-logo","yuvi-logo"],[1,"list-section"],["class","card soft",4,"ngFor","ngForOf"],[1,"card","soft"],[1,"card-title-row"],["class","text-muted",4,"ngIf"],[1,"card-actions"],[1,"promethea-button",2,"margin-top","var(--gutter-md)",3,"click"],[1,"esiti-timeline"],["class","card soft esito-card",4,"ngFor","ngForOf"],[1,"card","soft","esito-card"],["class","text-muted","style","margin-top: var(--gutter-sm);",4,"ngIf"],[1,"text-muted",2,"margin-top","var(--gutter-sm)"]],template:function(e,a){if(e&1&&(p(0,Ge,1,1,"app-page-loader",0),s(1,"section",1)(2,"header",2)(3,"i",3),l(4),n(),s(5,"div",4)(6,"h2",5),l(7),n(),p(8,Ye,2,1,"p",6),n(),f(9,"div",7),s(10,"div",8),p(11,$e,5,0,"ng-container",9)(12,Ue,5,0,"ng-container",9),n()(),p(13,He,9,7,"div",10)(14,di,184,72,"form",11),n(),s(15,"app-esito-popup",12),E("closed",function(m){return a.onEsitoPopupClosed(m)}),n()),e&2){let o;c("ngIf",a.loading()),r(4),u(a.icona()),r(3),u(a.titolo()),r(),c("ngIf",a.mode()==="view"),r(3),c("ngIf",a.mode()==="view"),r(),c("ngIf",a.mode()!=="view"),r(),c("ngIf",a.mode()==="view"),r(),c("ngIf",!a.loading()),r(),c("open",a.esitoPopupOpen())("soggettoId",((o=a.soggettoData())==null?null:o.id)??"")("tipo",a.tipo())}},dependencies:[pe,le,se,Te,be,Pe,we,ve,Ee,xe,he,ye,Ce,Ae,Se,Me,Fe,me,de,ce],styles:[".form-sections[_ngcontent-%COMP%]{display:grid;gap:var(--gutter-lg)}.autocomplete-container[_ngcontent-%COMP%]{position:relative}.autocomplete-dropdown[_ngcontent-%COMP%]{position:absolute;top:100%;left:0;right:0;background:var(--background);border:1px solid var(--smoke-color-1);border-radius:8px;box-shadow:0 4px 12px var(--shadow);max-height:250px;overflow-y:auto;z-index:1000;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)}.autocomplete-item[_ngcontent-%COMP%]{padding:var(--gutter-sm);cursor:pointer;border-bottom:1px solid var(--smoke-color-1);transition:background-color .2s ease;display:flex;flex-direction:column;gap:.25rem}.autocomplete-item[_ngcontent-%COMP%]:hover{background:color-mix(in srgb,var(--primary) 10%,transparent)}.autocomplete-item[_ngcontent-%COMP%]:last-child{border-bottom:none}.autocomplete-main[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem}.province-code[_ngcontent-%COMP%]{color:var(--primary);font-weight:500;font-size:var(--fs-sm)}.autocomplete-secondary[_ngcontent-%COMP%]{color:var(--text-muted);font-size:var(--fs-sm);font-style:italic}.section-titles[_ngcontent-%COMP%]   .section-title[_ngcontent-%COMP%]{white-space:normal;overflow-wrap:anywhere;word-break:break-word;line-height:1.1}.section-header[_ngcontent-%COMP%]{padding:var(--gutter-sm)}.chips-row[_ngcontent-%COMP%]{display:flex;gap:var(--gutter-sm);margin:var(--gutter-sm) 0;flex-wrap:wrap}.section-title[_ngcontent-%COMP%]   .section-logo[_ngcontent-%COMP%], .section-logo[_ngcontent-%COMP%]{width:var(--fs-lg);height:var(--fs-lg);display:inline-block;object-fit:contain;vertical-align:middle;margin-right:.6rem;border-radius:6px}.section-logo.promethea-logo[_ngcontent-%COMP%], .section-logo.yuvi-logo[_ngcontent-%COMP%]{background:transparent}.esiti-timeline[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:var(--gutter-sm)}legend.section-title[_ngcontent-%COMP%]{margin:0}fieldset.form-section[_ngcontent-%COMP%]{margin-bottom:var(--gutter-lg)}.actions-container.sticky-actions[_ngcontent-%COMP%]{position:sticky;top:0;z-index:60;display:flex;align-items:center;gap:.5rem;background:transparent;padding:var(--gutter-sm);-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px)}"]})};export{Be as AddSoggetto};
