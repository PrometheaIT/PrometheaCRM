import{a as T}from"./chunk-62NP47TA.js";import{b as R}from"./chunk-PIGK44NO.js";import{d as P,e as z,j as k}from"./chunk-2OIVJVMF.js";import{$a as x,Ia as U,Na as _,T as E,Y as f,Ya as c,Z as h,Za as r,_a as n,fb as C,ga as S,ib as b,jb as m,mb as A,nb as I,ob as s,pb as u,qb as O,wa as l}from"./chunk-IZFCH7PQ.js";import"./chunk-X5YLR3NI.js";import{a as M,b as w,i as y}from"./chunk-ODN5LVDJ.js";function V(a,e){a&1&&(r(0,"div",11),x(1,"span",12),s(2," Caricamento utenti\u2026 "),n())}function $(a,e){if(a&1&&(r(0,"div",13),s(1),n()),a&2){let t=m();l(),u(t.error())}}function F(a,e){if(a&1&&(r(0,"div",14)(1,"div",15)(2,"h3",16),s(3,"Totale Utenti"),n(),r(4,"div",17),s(5),n()(),r(6,"div",15)(7,"h3",16),s(8,"In Attesa Approvazione"),n(),r(9,"div",17),s(10),n()(),r(11,"div",15)(12,"h3",16),s(13,"Utenti Attivi"),n(),r(14,"div",17),s(15),n()(),r(16,"div",15)(17,"h3",16),s(18,"Amministratori"),n(),r(19,"div",17),s(20),n()()()),a&2){let t=m();l(5),u(t.getTotalUsers()),l(),A("card-highlight",t.getPendingUsers()>0),l(3),A("text-danger",t.getPendingUsers()>0),l(),O(" ",t.getPendingUsers()," "),l(5),u(t.getActiveUsers()),l(5),u(t.getAdminUsers())}}function D(a,e){a&1&&(r(0,"small",39),s(1," In attesa di approvazione "),n())}function j(a,e){if(a&1){let t=C();r(0,"label",40)(1,"input",27),b("change",function(){let o=f(t).$implicit,d=m().$implicit,g=m(2);return h(g.toggleModulo(d,o))}),n(),r(2,"span",41),s(3),n()()}if(a&2){let t=e.$implicit,i=m().$implicit;l(),c("checked",i.moduli.includes(t)||!1),l(),I("mod-chip-"+t),l(),u(t)}}function q(a,e){a&1&&x(0,"span",12)}function G(a,e){a&1&&(r(0,"i",42),s(1,"save"),n())}function B(a,e){if(a&1){let t=C();r(0,"tr")(1,"td",22)(2,"div",23)(3,"div")(4,"strong"),s(5),n(),_(6,D,2,0,"small",24),n()()(),r(7,"td",25)(8,"div",23)(9,"label",26)(10,"input",27),b("change",function(){let o=f(t).$implicit;return h(o.is_active=!o.is_active)}),n(),x(11,"span",28),n(),r(12,"span",29),s(13),n()()(),r(14,"td",30)(15,"div",23)(16,"label",31)(17,"input",27),b("change",function(){let o=f(t).$implicit,d=m(2);return h(d.toggleAdmin(o))}),n(),x(18,"span",28),n()()(),r(19,"td",32)(20,"div",33),_(21,j,4,4,"label",34),n()(),r(22,"td",35)(23,"div",23)(24,"button",36),b("click",function(){let o=f(t).$implicit,d=m(2);return h(d.saveRow(o))}),_(25,q,1,0,"span",37)(26,G,2,0,"i",38),s(27," Salva "),n()()()()}if(a&2){let t=e.$implicit,i=m(2);A("row-inactive",!t.is_active),l(5),u(t.email),l(),c("ngIf",!t.is_active),l(4),c("checked",t.is_active===!0),l(3),u(t.is_active?"Attivo":"Inattivo"),l(4),c("checked",t.ruoli.includes("admin")||!1),l(4),c("ngForOf",i.mods),l(3),c("disabled",!i.hasChanges(t)||i.savingIds.has(t.id)),l(),c("ngIf",i.savingIds.has(t.id)),l(),c("ngIf",!i.savingIds.has(t.id))}}function H(a,e){if(a&1&&(r(0,"section",18)(1,"div",19)(2,"table",20)(3,"thead")(4,"tr")(5,"th"),s(6,"Email"),n(),r(7,"th"),s(8,"Stato"),n(),r(9,"th"),s(10,"Admin"),n(),r(11,"th"),s(12,"Moduli"),n(),r(13,"th"),s(14,"Azioni"),n()()(),r(15,"tbody"),_(16,B,28,11,"tr",21),n()()()()),a&2){let t=m();l(16),c("ngForOf",t.rows())}}function J(a,e){a&1&&(r(0,"div",43)(1,"i",44),s(2,"group"),n(),r(3,"p"),s(4,"Nessun utente trovato nel sistema."),n()())}var N=class a{supa=E(R);userService=E(T);loading=S(!0);error=S(null);rows=S([]);mods=["immagine","digitalizzazione","contabilita","ottimizzazione"];savingIds=new Set;original=new Map;ngOnInit(){return y(this,null,function*(){this.loading.set(!0),this.error.set(null);try{if(!this.userService.isAdmin()){this.error.set("Non autorizzato ad accedere a questa sezione");return}yield this.refreshRows()}catch(e){console.error("\u274C Errore AdminUtenti ngOnInit:",e),this.error.set(e?.message||"Errore durante il caricamento degli utenti")}finally{this.loading.set(!1)}})}refreshRows(){return y(this,null,function*(){try{let e=yield this.supa.getAppUsers();if(e.error)throw new Error(e.error.message||"Errore durante il recupero degli utenti");let t=e.data??[];this.original.clear();let i=t.map(o=>w(M({},o),{ruoli:o.ruoli||[],moduli:o.moduli||[]}));for(let o of i)this.original.set(o.id,{ruoli:[...o.ruoli],moduli:[...o.moduli],is_active:o.is_active});this.rows.set(i),console.log("\u2705 Caricati",i.length,"utenti")}catch(e){throw console.error("\u274C Errore refreshRows:",e),e}})}toggleAdmin(e){e.ruoli||(e.ruoli=[]);let t=new Set(e.ruoli);t.has("admin")?(t.delete("admin"),t.add("user")):t.add("admin"),e.ruoli=Array.from(t)}toggleModulo(e,t){e.moduli||(e.moduli=[]);let i=[...e.moduli],o=i.indexOf(t);o>=0?i.splice(o,1):i.push(t),e.moduli=i}hasChanges(e){let t=this.original.get(e.id);if(!t||t.is_active!==e.is_active)return!0;let i=new Set(t.ruoli||[]),o=new Set(e.ruoli||[]);if(i.size!==o.size)return!0;for(let p of i)if(!o.has(p))return!0;let d=new Set(t.moduli||[]),g=new Set(e.moduli||[]);if(d.size!==g.size)return!0;for(let p of d)if(!g.has(p))return!0;return!1}saveRow(e){return y(this,null,function*(){if(!e.id){console.error("\u274C Row senza ID:",e);return}let t=this.original.get(e.id);if(!t){console.error("\u274C Nessun originale trovato per:",e.id);return}if(this.savingIds.has(e.id)){console.log("\u23F3 Salvataggio gi\xE0 in corso per:",e.id);return}this.savingIds.add(e.id);try{console.log("\u{1F4BE} Salvando utente:",e.email);let i={};t.is_active!==e.is_active&&(i.is_active=e.is_active);let o=new Set(t.ruoli||[]),d=new Set(e.ruoli||[]);(o.size!==d.size||[...o].some(v=>!d.has(v)))&&(i.ruoli=e.ruoli);let g=new Set(t.moduli||[]),p=new Set(e.moduli||[]);if((g.size!==p.size||[...g].some(v=>!p.has(v)))&&(i.moduli=e.moduli),Object.keys(i).length>0){console.log("\u{1F504} Aggiornamenti da salvare:",i);let v=yield this.supa.updateAppUser(e.id,i);if(v.error)throw new Error(v.error.message||"Errore durante l'aggiornamento");console.log("\u2705 Utente aggiornato:",e.email)}else console.log("\u2139\uFE0F Nessun cambiamento da salvare per:",e.email);yield this.refreshRows()}catch(i){console.error("\u274C Errore saveRow:",i),this.error.set(`Errore durante il salvataggio di ${e.email}: ${i.message}`);let o=this.original.get(e.id);if(o){e.ruoli=[...o.ruoli],e.moduli=[...o.moduli],e.is_active=o.is_active;let g=this.rows().map(p=>p.id===e.id?M({},e):p);this.rows.set(g)}setTimeout(()=>this.error.set(null),5e3)}finally{this.savingIds.delete(e.id)}})}getTotalUsers(){return this.rows().length}getAdminUsers(){return this.rows().filter(e=>e.ruoli?.includes("admin")||!1).length}getActiveUsers(){return this.rows().filter(e=>e.is_active===!0).length}getPendingUsers(){return this.rows().filter(e=>e.is_active===!1).length}static \u0275fac=function(t){return new(t||a)};static \u0275cmp=U({type:a,selectors:[["app-admin-utenti"]],decls:14,vars:5,consts:[[1,"form-section"],[1,"section-header"],[1,"material-icons","header-icon"],[1,"section-titles"],[1,"section-title"],[1,"text-muted"],["class","status-message loading",4,"ngIf"],["class","status-message error",4,"ngIf"],["class","prospect-cards",4,"ngIf"],["class","table-section",4,"ngIf"],["class","empty-state",4,"ngIf"],[1,"status-message","loading"],[1,"loading-spinner"],[1,"status-message","error"],[1,"prospect-cards"],[1,"card"],[1,"card-title"],[1,"card-number"],[1,"table-section"],[1,"table-container"],[1,"crm-table"],[3,"row-inactive",4,"ngFor","ngForOf"],["data-label","Email"],[1,"cell-content"],["class","text-danger user-pending",4,"ngIf"],["data-label","Stato"],["title","Utente attivo",1,"toggle-switch"],["type","checkbox",3,"change","checked"],[1,"toggle-slider"],[1,"status-label"],["data-label","Admin"],["title","Amministratore",1,"toggle-switch"],["data-label","Moduli"],[1,"cell-content","modules-container"],["class","mod-toggle",4,"ngFor","ngForOf"],["data-label","Azioni"],["type","button",1,"promethea-button",3,"click","disabled"],["class","loading-spinner",4,"ngIf"],["class","material-icons",4,"ngIf"],[1,"text-danger","user-pending"],[1,"mod-toggle"],[1,"chip","mod-chip"],[1,"material-icons"],[1,"empty-state"],[1,"material-icons",2,"font-size","4rem","opacity","0.3","margin-bottom","var(--gutter-md)"]],template:function(t,i){t&1&&(r(0,"div",0)(1,"div",1)(2,"i",2),s(3,"admin_panel_settings"),n(),r(4,"div",3)(5,"h2",4),s(6,"Gestione Utenti"),n(),r(7,"p",5),s(8,"Amministra utenti, ruoli e permessi del sistema"),n()()(),_(9,V,3,0,"div",6)(10,$,2,1,"div",7)(11,F,21,8,"div",8),n(),_(12,H,17,1,"section",9)(13,J,5,0,"div",10)),t&2&&(l(9),c("ngIf",i.loading()),l(),c("ngIf",i.error()),l(),c("ngIf",!i.loading()),l(),c("ngIf",!i.loading()&&!i.error()),l(),c("ngIf",!i.loading()&&!i.error()&&i.rows().length===0))},dependencies:[k,P,z],styles:['.toggle-switch[_ngcontent-%COMP%]{position:relative;display:inline-block;width:44px;height:24px}.toggle-switch[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{opacity:0;width:0;height:0}.toggle-slider[_ngcontent-%COMP%]{position:absolute;cursor:pointer;inset:0;background-color:var(--smoke-color-1);transition:.3s;border-radius:24px}.toggle-slider[_ngcontent-%COMP%]:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:#fff;transition:.3s;border-radius:50%}.toggle-switch[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:checked + .toggle-slider[_ngcontent-%COMP%]{background:var(--primary)}.toggle-switch[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:checked + .toggle-slider[_ngcontent-%COMP%]:before{transform:translate(20px)}.row-inactive[_ngcontent-%COMP%]{opacity:.6;background:color-mix(in srgb,#ef4444 5%,transparent)!important}.status-label[_ngcontent-%COMP%]{margin-left:var(--gutter-sm);font-size:var(--fs-sm);color:var(--text-muted)}.user-pending[_ngcontent-%COMP%]{display:block;font-style:italic;margin-top:.25rem}.text-danger[_ngcontent-%COMP%]{color:#ef4444!important}.card-highlight[_ngcontent-%COMP%]{border-color:#ef4444!important;animation:_ngcontent-%COMP%_pulse-warning 2s infinite}@keyframes _ngcontent-%COMP%_pulse-warning{0%,to{box-shadow:0 4px 12px var(--shadow)}50%{box-shadow:0 4px 16px color-mix(in srgb,#ef4444 30%,transparent)}}.modules-container[_ngcontent-%COMP%]{flex-wrap:wrap;gap:var(--gutter-sm)}.mod-chip-immagine[_ngcontent-%COMP%]{background:color-mix(in srgb,var(--primary) 10%,transparent)!important;border-color:var(--primary)!important;color:var(--primary)!important}.mod-chip-digitalizzazione[_ngcontent-%COMP%]{background:color-mix(in srgb,var(--secondary) 10%,transparent)!important;border-color:var(--secondary)!important;color:var(--secondary)!important}.mod-chip-contabilita[_ngcontent-%COMP%]{background:color-mix(in srgb,var(--tertiary) 10%,transparent)!important;border-color:var(--tertiary)!important;color:var(--tertiary)!important}.mod-chip-ottimizzazione[_ngcontent-%COMP%]{background:color-mix(in srgb,var(--viola) 10%,transparent)!important;border-color:var(--viola)!important;color:var(--viola)!important}@media (max-width: 768px){.modules-container[_ngcontent-%COMP%]{flex-direction:column;align-items:flex-start}.toggle-switch[_ngcontent-%COMP%]{flex-shrink:0}.status-label[_ngcontent-%COMP%]{margin-left:var(--gutter-sm);font-size:var(--fs-sm)}}']})};export{N as AdminUtenti};
