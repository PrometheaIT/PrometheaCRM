import{j as C,k as T,p as R,v as k}from"./chunk-67GYVHNT.js";import{Ga as U,La as g,S as I,X as f,Xa as d,Y as h,Ya as a,Za as n,_a as x,db as y,fa as A,gb as S,hb as m,jb as w,kb as E,lb as z,mb as s,nb as u,ob as M,ua as o}from"./chunk-QS6MTI54.js";import"./chunk-X5YLR3NI.js";import{i as b}from"./chunk-ODN5LVDJ.js";function V(r,t){r&1&&(a(0,"div",11),x(1,"span",12),s(2," Caricamento utenti\u2026 "),n())}function N(r,t){if(r&1&&(a(0,"div",13),s(1),n()),r&2){let e=m();o(),u(e.error())}}function P(r,t){if(r&1&&(a(0,"div",14)(1,"div",15)(2,"h3",16),s(3,"Totale Utenti"),n(),a(4,"div",17),s(5),n()(),a(6,"div",15)(7,"h3",16),s(8,"In Attesa Approvazione"),n(),a(9,"div",17),s(10),n()(),a(11,"div",15)(12,"h3",16),s(13,"Utenti Attivi"),n(),a(14,"div",17),s(15),n()(),a(16,"div",15)(17,"h3",16),s(18,"Amministratori"),n(),a(19,"div",17),s(20),n()()()),r&2){let e=m();o(5),u(e.getTotalUsers()),o(),E("card-active",e.getPendingUsers()>0),o(3),w("color",e.getPendingUsers()>0?"var(--error)":"inherit"),o(),M(" ",e.getPendingUsers()," "),o(5),u(e.getActiveUsers()),o(5),u(e.getAdminUsers())}}function F(r,t){r&1&&(a(0,"small",39),s(1," In attesa di approvazione "),n())}function $(r,t){if(r&1){let e=y();a(0,"label",40)(1,"input",27),S("change",function(){let l=f(e).$implicit,c=m().$implicit,p=m(2);return h(p.toggleModulo(c,l))}),n(),a(2,"span",41),s(3),n()()}if(r&2){let e=t.$implicit,i=m().$implicit;o(),d("checked",(i.moduli==null?null:i.moduli.includes(e))||!1),o(),z("mod-chip-"+e),o(),u(e)}}function D(r,t){r&1&&x(0,"span",12)}function j(r,t){r&1&&(a(0,"i",42),s(1,"save"),n())}function G(r,t){if(r&1){let e=y();a(0,"tr")(1,"td",22)(2,"div",23)(3,"strong"),s(4),n(),g(5,F,2,0,"small",24),n()(),a(6,"td",25)(7,"div",23)(8,"label",26)(9,"input",27),S("change",function(){let l=f(e).$implicit;return h(l.is_active=!l.is_active)}),n(),x(10,"span",28),n(),a(11,"span",29),s(12),n()()(),a(13,"td",30)(14,"div",23)(15,"label",31)(16,"input",27),S("change",function(){let l=f(e).$implicit,c=m(2);return h(c.toggleAdmin(l))}),n(),x(17,"span",28),n()()(),a(18,"td",32)(19,"div",33),g(20,$,4,4,"label",34),n()(),a(21,"td",35)(22,"div",23)(23,"button",36),S("click",function(){let l=f(e).$implicit,c=m(2);return h(c.saveRow(l))}),g(24,D,1,0,"span",37)(25,j,2,0,"i",38),s(26," Salva "),n()()()()}if(r&2){let e=t.$implicit,i=m(2);E("row-inactive",!e.is_active),o(4),u(e.email),o(),d("ngIf",!e.is_active),o(4),d("checked",e.is_active===!0),o(3),u(e.is_active?"Attivo":"Inattivo"),o(4),d("checked",(e.ruoli==null?null:e.ruoli.includes("admin"))||!1),o(4),d("ngForOf",i.mods),o(3),d("disabled",!i.hasChanges(e)||i.savingIds.has(e.id)),o(),d("ngIf",i.savingIds.has(e.id)),o(),d("ngIf",!i.savingIds.has(e.id))}}function q(r,t){if(r&1&&(a(0,"section",18)(1,"div",19)(2,"table",20)(3,"thead")(4,"tr")(5,"th"),s(6,"Email"),n(),a(7,"th"),s(8,"Stato"),n(),a(9,"th"),s(10,"Admin"),n(),a(11,"th"),s(12,"Moduli"),n(),a(13,"th"),s(14,"Azioni"),n()()(),a(15,"tbody"),g(16,G,27,11,"tr",21),n()()()()),r&2){let e=m();o(16),d("ngForOf",e.rows())}}function B(r,t){r&1&&(a(0,"div",43)(1,"i",44),s(2,"group"),n(),a(3,"p"),s(4,"Nessun utente trovato nel sistema."),n()())}var O=class r{supa=I(k);loading=A(!0);error=A(null);rows=A([]);mods=["immagine","digitalizzazione","contabilita","ottimizzazione"];savingIds=new Set;original=new Map;ngOnInit(){return b(this,null,function*(){this.loading.set(!0);try{if(!(yield this.supa.isAdmin())){this.error.set("Non autorizzato");return}yield this.refreshRows()}catch(t){this.error.set(t?.message||"Errore")}finally{this.loading.set(!1)}})}refreshRows(){return b(this,null,function*(){let t=yield this.supa.getAppUsers();if(t.error)throw t.error;let e=t.data??[];this.original.clear();for(let i of e)this.original.set(i.id,{ruoli:[...i.ruoli||[]],moduli:[...i.moduli||[]],is_active:i.is_active});this.rows.set(e)})}toggleAdmin(t){let e=new Set(t.ruoli||[]);e.has("admin")?e.delete("admin"):e.add("admin"),t.ruoli=Array.from(e)}toggleModulo(t,e){let i=[...t.moduli||[]],l=i.indexOf(e);l>=0?i.splice(l,1):i.push(e),t.moduli=i}hasChanges(t){let e=this.original.get(t.id);if(!e||e.is_active!==t.is_active)return!0;let i=new Set(e.ruoli||[]),l=new Set(t.ruoli||[]);if(i.size!==l.size)return!0;for(let _ of i)if(!l.has(_))return!0;let c=new Set(e.moduli||[]),p=new Set(t.moduli||[]);if(c.size!==p.size)return!0;for(let _ of c)if(!p.has(_))return!0;return!1}saveRow(t){return b(this,null,function*(){let e=this.original.get(t.id);if(e){this.savingIds.add(t.id);try{let i={};e.is_active!==t.is_active&&(i.is_active=t.is_active);let l=new Set(e.ruoli||[]),c=new Set(t.ruoli||[]);(l.size!==c.size||[...l].some(v=>!c.has(v)))&&(i.ruoli=t.ruoli);let p=new Set(e.moduli||[]),_=new Set(t.moduli||[]);if((p.size!==_.size||[...p].some(v=>!_.has(v)))&&(i.moduli=t.moduli),Object.keys(i).length>0){let v=yield this.supa.updateAppUser(t.id,i);if(v.error)throw v.error}yield this.refreshRows()}catch(i){alert(i?.message||"Errore durante il salvataggio");let l=this.original.get(t.id);l&&(t.ruoli=[...l.ruoli],t.moduli=[...l.moduli],t.is_active=l.is_active)}finally{this.savingIds.delete(t.id)}}})}getTotalUsers(){return this.rows().length}getAdminUsers(){return this.rows().filter(t=>t.ruoli?.includes("admin")).length}getActiveUsers(){return this.rows().filter(t=>t.is_active===!0).length}getPendingUsers(){return this.rows().filter(t=>t.is_active===!1).length}static \u0275fac=function(e){return new(e||r)};static \u0275cmp=U({type:r,selectors:[["app-admin-utenti"]],decls:14,vars:5,consts:[[1,"form-section"],[1,"section-header"],[1,"material-icons","header-icon"],[1,"section-titles"],[1,"section-title"],[1,"sottotitolo"],["class","status-message loading",4,"ngIf"],["class","status-message error",4,"ngIf"],["class","prospect-cards",4,"ngIf"],["class","table-section",4,"ngIf"],["class","empty-state",4,"ngIf"],[1,"status-message","loading"],[1,"loading-spinner"],[1,"status-message","error"],[1,"prospect-cards"],[1,"card"],[1,"card-title"],[1,"card-number"],[1,"table-section"],[1,"table-container"],[1,"crm-table"],[3,"row-inactive",4,"ngFor","ngForOf"],["data-label","Email"],[1,"cell-content"],["style","color: var(--error); display: block;",4,"ngIf"],["data-label","Stato"],["title","Utente attivo",1,"toggle-switch"],["type","checkbox",3,"change","checked"],[1,"slider"],[1,"status-text"],["data-label","Admin"],["title","Amministratore",1,"toggle-switch"],["data-label","Moduli"],[1,"cell-content",2,"flex-wrap","wrap","gap","var(--gutter-sm)"],["class","mod-toggle",4,"ngFor","ngForOf"],["data-label","Azioni"],["type","button",1,"promethea-button",3,"click","disabled"],["class","loading-spinner",4,"ngIf"],["class","material-icons",4,"ngIf"],[2,"color","var(--error)","display","block"],[1,"mod-toggle"],[1,"chip"],[1,"material-icons"],[1,"empty-state"],[1,"material-icons",2,"font-size","4rem","opacity","0.3","margin-bottom","var(--gutter-md)"]],template:function(e,i){e&1&&(a(0,"div",0)(1,"div",1)(2,"i",2),s(3,"admin_panel_settings"),n(),a(4,"div",3)(5,"h2",4),s(6,"Gestione Utenti"),n(),a(7,"p",5),s(8,"Amministra utenti, ruoli e permessi del sistema"),n()()(),g(9,V,3,0,"div",6)(10,N,2,1,"div",7)(11,P,21,8,"div",8),n(),g(12,q,17,1,"section",9)(13,B,5,0,"div",10)),e&2&&(o(9),d("ngIf",i.loading()),o(),d("ngIf",i.error()),o(),d("ngIf",!i.loading()),o(),d("ngIf",!i.loading()&&!i.error()),o(),d("ngIf",!i.loading()&&!i.error()&&i.rows().length===0))},dependencies:[R,C,T],encapsulation:2})};export{O as AdminUtenti};
