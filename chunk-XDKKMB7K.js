import{b as l,c as S}from"./chunk-WPZ527DH.js";import{N as c,S as n,g as a}from"./chunk-R5VHGKSY.js";import{i as s}from"./chunk-ODN5LVDJ.js";var h=class i{authService=n(S);supabaseService=n(l);isAdminSubject=new a(!1);currentRoleSubject=new a("user");isAdmin$=this.isAdminSubject.asObservable();currentRole$=this.currentRoleSubject.asObservable();isInitialized=!1;constructor(){this.initializeUserStatus()}initializeUserStatus(){return s(this,null,function*(){if(!this.isInitialized)try{let e=this.authService.user();e&&(yield this.updateUserStatus(e.id),this.isInitialized=!0)}catch(e){console.error("Error initializing user status:",e),this.setDefaultUserStatus()}})}updateUserStatus(e){return s(this,null,function*(){try{console.log("\u{1F464} Aggiornamento stato utente:",e),this.isAdminSubject.next(!1);let{data:t,error:u}=yield this.supabaseService.getAppUserById(e);if(u){console.error("\u274C Errore nel recupero dati utente:",u),this.setDefaultUserStatus();return}if(!t){console.warn("\u26A0\uFE0F Utente non trovato nel database"),this.setDefaultUserStatus();return}let o=t.is_active===!0,r=!1;o&&(r=t.is_admin===!0||Array.isArray(t.ruoli)&&t.ruoli.includes("admin")),this.isAdminSubject.next(r),this.currentRoleSubject.next(r?"admin":"user"),console.log("\u2705 Stato utente aggiornato:",{userId:e,isActive:o,isAdmin:r,ruoli:t.ruoli})}catch(t){console.error("\u274C Errore aggiornamento stato utente:",t),this.setDefaultUserStatus()}})}setDefaultUserStatus(){this.isAdminSubject.next(!1),this.currentRoleSubject.next("user")}refreshAdminStatus(){return s(this,null,function*(){try{let e=this.authService.user();return e?(yield this.updateUserStatus(e.id),this.isAdminSubject.value):(this.setDefaultUserStatus(),!1)}catch(e){return console.error("Error refreshing admin status:",e),this.setDefaultUserStatus(),!1}})}isAdmin(){return this.isAdminSubject.value}getCurrentRole(){return this.currentRoleSubject.value}resetUserStatus(){this.isInitialized=!1,this.setDefaultUserStatus()}static \u0275fac=function(t){return new(t||i)};static \u0275prov=c({token:i,factory:i.\u0275fac,providedIn:"root"})};export{h as a};
