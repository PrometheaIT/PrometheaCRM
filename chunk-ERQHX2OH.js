import{a as f}from"./chunk-SJ4NRQ5G.js";import{b as c}from"./chunk-7K4EWSAC.js";import{N as l,S as u,g as n}from"./chunk-QBO2HR3F.js";import{i as r}from"./chunk-ODN5LVDJ.js";var h=class i{authService=u(f);supabaseService=u(c);isAdminSubject=new n(!1);currentRoleSubject=new n("user");isAdmin$=this.isAdminSubject.asObservable();currentRole$=this.currentRoleSubject.asObservable();usersMap=this.usersMap??{};isInitialized=!1;constructor(){this.initializeUserStatus()}initializeUserStatus(){return r(this,null,function*(){if(!this.isInitialized)try{let e=this.authService.user();e&&(yield this.updateUserStatus(e.id),this.isInitialized=!0)}catch(e){console.error("Error initializing user status:",e),this.setDefaultUserStatus()}})}updateUserStatus(e){return r(this,null,function*(){try{console.log("\u{1F464} Aggiornamento stato utente:",e),this.isAdminSubject.next(!1);let{data:t,error:a}=yield this.supabaseService.getAppUserById(e);if(a){console.error("\u274C Errore nel recupero dati utente:",a),this.setDefaultUserStatus();return}if(!t){console.warn("\u26A0\uFE0F Utente non trovato nel database"),this.setDefaultUserStatus();return}let o=t.is_active===!0,s=!1;o&&(s=t.is_admin===!0||Array.isArray(t.ruoli)&&t.ruoli.includes("admin")),this.isAdminSubject.next(s),this.currentRoleSubject.next(s?"admin":"user"),console.log("\u2705 Stato utente aggiornato:",{userId:e,isActive:o,isAdmin:s,ruoli:t.ruoli})}catch(t){console.error("\u274C Errore aggiornamento stato utente:",t),this.setDefaultUserStatus()}})}setDefaultUserStatus(){this.isAdminSubject.next(!1),this.currentRoleSubject.next("user")}getUserById(e){return r(this,null,function*(){let t=yield this.supabaseService.getAppUserById(e);return{data:t.data,error:t.error}})}refreshAdminStatus(){return r(this,null,function*(){try{let e=this.authService.user();return e?(yield this.updateUserStatus(e.id),this.isAdminSubject.value):(this.setDefaultUserStatus(),!1)}catch(e){return console.error("Error refreshing admin status:",e),this.setDefaultUserStatus(),!1}})}isAdmin(){return this.isAdminSubject.value}getCurrentRole(){return this.currentRoleSubject.value}resetUserStatus(){this.isInitialized=!1,this.setDefaultUserStatus()}getFullName(e){if(!e)return null;let t=this.usersMap?.[e];return t&&[t.first_name,t.last_name].filter(Boolean).join(" ").trim()||null}static \u0275fac=function(t){return new(t||i)};static \u0275prov=l({token:i,factory:i.\u0275fac,providedIn:"root"})};export{h as a};
