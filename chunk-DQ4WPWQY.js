import{b as v}from"./chunk-4VPSVKZE.js";import{c as m}from"./chunk-UNZMF5LD.js";import{Ib as l,N as h,S as f,ea as p}from"./chunk-54AF7LZE.js";import{a as g,i as c}from"./chunk-ODN5LVDJ.js";var S=class d{soggettiService=f(v);authService=f(m);stato=p({rows:[],filteredRows:[],loading:!1,error:null,hasMore:!0,page:0,allLoaded:!1});allLoaded=l(()=>this.stato().allLoaded);filtri=p({provincia:"tutte",searchTerm:"",esito:"tutti",sortDir:"desc"});config;rows=l(()=>this.stato().rows);filteredRows=l(()=>this.stato().filteredRows);loading=l(()=>this.stato().loading);error=l(()=>this.stato().error);hasMore=l(()=>this.stato().hasMore);currentFiltri=l(()=>this.filtri());inizializza(e){this.config=g({pageSize:20,abilitaConfigurazioni:!0,abilitaTrattative:!0},e),this.reset()}caricaIniziali(){return c(this,null,function*(){if(!this.stato().loading){this.aggiornaStato({loading:!0,error:null});try{let e=this.config.pageSize??20,[{data:i,error:a},{data:s,error:n}]=yield Promise.all([this.soggettiService.countByTipo(this.config.tipo),this.soggettiService.getSoggettiByTipo(this.config.tipo,0,Math.max(e-1,0))]);if(a)throw a;if(n)throw n;let t=i??0,o=s??[],r=yield this.arricchisciDati(o);this.aggiornaStato({rows:r,hasMore:t>e,page:t>0?1:0,allLoaded:t<=e}),this.applicaFiltri()}catch(e){this.aggiornaStato({error:e?.message||"Errore durante il caricamento"})}finally{this.aggiornaStato({loading:!1})}}})}caricaTutti(){return c(this,null,function*(){if(!this.stato().loading){this.aggiornaStato({loading:!0,error:null});try{let{data:e,error:i}=yield this.soggettiService.countByTipo(this.config.tipo);if(i)throw i;let a=e??0;if(a===0){this.aggiornaStato({rows:[],filteredRows:[],hasMore:!1,page:0,allLoaded:!0});return}let s=Math.max(a-1,0),{data:n,error:t}=yield this.soggettiService.getSoggettiByTipo(this.config.tipo,0,s);if(t)throw t;let o=n??[],r=yield this.arricchisciDati(o);this.aggiornaStato({rows:r,hasMore:!1,page:1,allLoaded:!0}),this.applicaFiltri()}catch(e){this.aggiornaStato({error:e?.message||"Errore durante il caricamento"})}finally{this.aggiornaStato({loading:!1})}}})}cerca(e){return c(this,null,function*(){this.aggiornaStato({loading:!0,error:null});try{if(!e.trim()){this.stato().allLoaded?this.applicaFiltri():yield this.caricaIniziali();return}let i=yield this.soggettiService.searchSoggetti(e,this.config.tipo);if(i.error)throw i.error;let a=i.data??[],s=yield this.arricchisciDati(a);this.aggiornaStato({rows:s,hasMore:!1,page:0}),this.applicaFiltri()}catch(i){this.aggiornaStato({error:i?.message||"Errore durante la ricerca"})}finally{this.aggiornaStato({loading:!1})}})}applicaFiltri(e){if(e&&Object.keys(e).length>0){let t=r=>r==="tutte"||r==="tutti"||r===""?null:r,o=g({},e||{});if("provincia"in o&&(o.provincia=t(o.provincia)),"esito"in o&&(o.esito=t(o.esito)),"prodotto"in o&&(o.prodotto=t(o.prodotto)),"categoria_ateco"in o&&(o.categoria_ateco=t(o.categoria_ateco)),"configurato"in o&&typeof o.configurato=="string"){let r=String(o.configurato).toLowerCase();o.configurato=r==="true"?!0:r==="false"?!1:null}this.filtri.update(r=>g(g({},r),o))}let i=this.filtri(),a=this.stato().rows;console.debug("\u{1F39B}\uFE0F Applicazione filtri:",{filtri:i,totaleRows:a.length});let s=a.filter(t=>{if(i.provincia&&i.provincia!=="tutte"&&i.provincia!=="tutti"&&t.provincia!==i.provincia)return!1;if(i.esito&&i.esito!=="tutti"){if(i.esito==="senza-esito"){if(t.ultimoEsito)return!1}else if(t.ultimoEsito?.tipo!==i.esito)return!1}if(i.categoria_ateco){let o=String(i.categoria_ateco).trim().toLowerCase(),r=String(t.categoria_ateco??t.categoria??"").trim().toLowerCase();if(!r||r!==o)return!1}if((this.config.tipo==="cliente"||this.config.tipo==="fornitore")&&(i.conIban&&!t.iban||i.conReferente&&!t.referente)||this.config.tipo==="prospect"&&i.configurato!==null&&i.configurato!==void 0&&t.configurato!==i.configurato)return!1;if(i.prodotto&&i.prodotto!=="tutti"){let o=String(i.prodotto).trim().toLowerCase();if(!(String(t.prodotto??"").toLowerCase().split(",").map(y=>y.trim()).filter(Boolean).includes(o)||o==="promethea"&&!!t.hasConfigPromethea||o==="yuvi"&&!!t.hasTrattativaYuvi))return!1}return!0}),n=t=>{let o=t.ultimoEsito?.ts?new Date(t.ultimoEsito.ts).getTime():0,r=t.created_at?new Date(t.created_at).getTime():0;return o||r};s.sort((t,o)=>{let r=n(t),u=n(o);return i.sortDir==="desc"?u-r:r-u}),console.debug("\u{1F50D} Filtri applicati, risultati:",s.length),this.aggiornaStato({filteredRows:s})}eliminaSoggetto(e){return c(this,null,function*(){try{let i=yield this.soggettiService.deleteSoggetto(e);if(!i.success)throw new Error(i.error);return this.aggiornaStato({rows:this.stato().rows.filter(a=>a.id!==e)}),this.applicaFiltri(),!0}catch(i){return this.aggiornaStato({error:i.message||"Errore durante l'eliminazione"}),!1}})}aggiornaProdotto(e,i){return c(this,null,function*(){try{return yield this.soggettiService.updateProdotto(e,i)}catch(a){return console.error("Errore aggiornamento prodotto:",a),{error:a}}})}getModuliAttivi(e){if(!e)return[];let i=e.dettagli??e;if(!i||typeof i!="object")return[];let a={immagine_marketing:"immagine",digitalizzazione_automatismi:"digital",contabilita_fiscalita:"accounting",ottimizzazione_management:"optimization"},s=[];return Object.entries(a).forEach(([n,t])=>{let o=i[n];if(!o)return;let r=o.totale??o.totale_modulo??0,u=Array.isArray(o.servizi_selezionati)?o.servizi_selezionati:Array.isArray(o.servizi)?o.servizi:[];(r&&r>0||u.length>0)&&s.push(t)}),s}arricchisciDati(e){return c(this,null,function*(){let i=e.map(t=>t.id).filter(t=>!!t);if(i.length===0)return[];let a=[];if(this.config.abilitaConfigurazioni?a.push(this.soggettiService.getConfigurazioniPrometheaByCliente(i)):a.push(Promise.resolve(new Map)),this.config.abilitaTrattative){let t=this.config.tipo==="prospect"?this.soggettiService.getTrattativeYuviByProspect(i):this.soggettiService.getTrattativeYuviByCliente(i);a.push(t)}else a.push(Promise.resolve(new Map));let[s,n]=yield Promise.all(a);return e.map(t=>{let o=s.get(t.id),r=this.getModuliAttivi(o);return{id:t.id,tipo:t.tipo??this.config.tipo,ragione_sociale:t.ragione_sociale||"Senza nome",referente:t.referente,telefono:t.telefono,email:t.email,provincia:t.provincia,comune:t.comune,prodotto:typeof t.prodotto=="string"?t.prodotto.trim():"",esiti:t.esiti,ultimoEsito:this.getUltimoEsito(t.esiti),configurato:!!o,hasConfigPromethea:!!o,hasTrattativaYuvi:n.get(t.id)||!1,moduliAttivi:r,created_at:t.created_at,iban:t.iban,categoria_ateco:t.categoria_ateco??t.categoriaAteco??t.categoria??null,created_by:t.created_by??t.createdBy??null,created_by_user:t.created_by_user??t.createdByUser??null}})})}getUltimoEsito(e){return!Array.isArray(e)||e.length===0?null:e.reduce((i,a)=>{let s=new Date(a.ts).getTime(),n=new Date(i.ts).getTime();return s>n?a:i})}aggiornaStato(e){this.stato.update(i=>g(g({},i),e))}reset(){this.stato.set({rows:[],filteredRows:[],loading:!1,error:null,hasMore:!0,page:0,allLoaded:!1}),this.filtri.set({provincia:"tutte",searchTerm:"",esito:"tutti",sortDir:"desc",prodotto:"tutti"})}static \u0275fac=function(i){return new(i||d)};static \u0275prov=h({token:d,factory:d.\u0275fac,providedIn:"root"})};export{S as a};
