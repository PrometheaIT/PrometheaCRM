import{a as U}from"./chunk-64LBLDON.js";import{a as O}from"./chunk-UONBFLMY.js";import{b as N}from"./chunk-H4JMM7IJ.js";import"./chunk-XDKKMB7K.js";import{b as K,c as A}from"./chunk-WPZ527DH.js";import{c as w,d as D,e as L,j as R,p as H}from"./chunk-PJ4DYJTI.js";import{Bb as T,Ga as C,La as f,S as E,Wa as m,Xa as a,Ya as i,Za as P,ea as k,hb as u,ib as z,mb as n,nb as c,ob as S,ua as s}from"./chunk-R5VHGKSY.js";import"./chunk-X5YLR3NI.js";import{i as _}from"./chunk-ODN5LVDJ.js";function B(o,t){o&1&&P(0,"app-page-loader",3)}function F(o,t){if(o&1&&(a(0,"div",27),n(1),i()),o&2){let e=u(2);s(),c(e.error)}}function V(o,t){if(o&1&&(a(0,"div",41),n(1),i()),o&2){let e=u().$implicit;s(),S(" Ref: ",e.prospect.referente," ")}}function q(o,t){if(o&1&&(a(0,"div"),n(1),i()),o&2){let e=u().$implicit;s(),c(e.prospect.telefono)}}function j(o,t){if(o&1&&(a(0,"div",42),n(1),i()),o&2){let e=u().$implicit;s(),S(" ",e.prospect.email," ")}}function G(o,t){o&1&&(a(0,"div"),n(1,"\u2014"),i())}function J(o,t){if(o&1&&(a(0,"span",42),n(1),i()),o&2){let e=u().$implicit,r=u(3);s(),S(" ",r.truncate(e.esito.note,50)," ")}}function Q(o,t){o&1&&(a(0,"span"),n(1,"\u2014"),i())}function W(o,t){if(o&1&&(a(0,"tr")(1,"td",31)(2,"div",32)(3,"strong"),n(4),i(),f(5,V,2,1,"div",33),i()(),a(6,"td",34)(7,"div",32),f(8,q,2,1,"div",2)(9,j,2,1,"div",35)(10,G,2,0,"div",2),i()(),a(11,"td",36)(12,"div",32),n(13),i()(),a(14,"td",37)(15,"div",32)(16,"span",38),n(17),i()()(),a(18,"td",39)(19,"div",32),n(20),i()(),a(21,"td",40)(22,"div",32),f(23,J,2,1,"span",35)(24,Q,2,0,"span",2),i()()()),o&2){let e=t.$implicit,r=u(3);s(4),c(e.prospect.ragione_sociale),s(),m("ngIf",e.prospect.referente),s(3),m("ngIf",e.prospect.telefono),s(),m("ngIf",e.prospect.email),s(),m("ngIf",!e.prospect.telefono&&!e.prospect.email),s(3),c(e.prospect.provincia||"\u2014"),s(3),m("ngClass",r.getBadgeClass(e.esito.tipo)),s(),S(" ",r.getTestoEsito(e.esito)," "),s(3),c(r.formatDate(e.dataEsito)),s(3),m("ngIf",e.esito.note),s(),m("ngIf",!e.esito.note)}}function X(o,t){if(o&1&&(a(0,"div",28)(1,"table",29)(2,"thead")(3,"tr")(4,"th"),n(5,"Prospect"),i(),a(6,"th"),n(7,"Contatto"),i(),a(8,"th"),n(9,"Provincia"),i(),a(10,"th"),n(11,"Ultimo Esito"),i(),a(12,"th"),n(13,"Data Esito"),i(),a(14,"th"),n(15,"Note"),i()()(),a(16,"tbody"),f(17,W,25,11,"tr",30),i()()()),o&2){let e=u(2);s(17),m("ngForOf",e.ultimiEsiti)}}function Z(o,t){o&1&&(a(0,"div",43)(1,"i",44),n(2,"history"),i(),a(3,"p"),n(4,"Nessun esito recente trovato."),i(),a(5,"p",45),n(6,"I contatti con i prospect appariranno qui."),i()())}function tt(o,t){if(o&1&&(a(0,"div")(1,"div",4)(2,"div",5)(3,"i",6),n(4,"dashboard"),i(),a(5,"div",7)(6,"h2",8),n(7,"Dashboard CRM"),i(),a(8,"p",9),n(9,"Panoramica rapida su attivit\xE0 e KPI"),i()()(),f(10,F,2,1,"div",10),a(11,"div",11)(12,"a",12)(13,"h3",13),n(14,"Totale Prospect"),i(),a(15,"div",14),n(16),i()(),a(17,"a",15)(18,"h3",13),n(19,"Totale Clienti"),i(),a(20,"div",14),n(21),i()(),a(22,"a",12)(23,"h3",13),n(24,"Da Richiamare"),i(),a(25,"div",14),n(26),i()(),a(27,"a",12)(28,"h3",13),n(29,"Senza Contatto"),i(),a(30,"div",14),n(31),i()(),a(32,"a",12)(33,"h3",13),n(34,"Configurati"),i(),a(35,"div",14),n(36),i()(),a(37,"a",16)(38,"h3",13),n(39,"Trattative YUVI"),i(),a(40,"div",14),n(41),i()(),a(42,"a",17)(43,"h3",13),n(44,"Trattative Promethea"),i(),a(45,"div",14),n(46),i()(),a(47,"a",18)(48,"h3",13),n(49,"Referenze da CTR"),i(),a(50,"div",14),n(51),i()()(),a(52,"div",19)(53,"a",20),n(54,"Nuovo Prospect"),i(),a(55,"a",21),n(56,"Nuova Trattativa YUVI"),i(),a(57,"a",22),n(58,"Visualizza KPI"),i()()(),a(59,"div",23)(60,"div",5)(61,"i",6),n(62,"history"),i(),a(63,"div",7)(64,"h3",8),n(65,"Ultimi Esiti"),i(),a(66,"p",9),n(67,"I contatti pi\xF9 recenti con i prospect"),i()()(),f(68,X,18,1,"div",24)(69,Z,7,0,"ng-template",null,0,T),a(71,"div",25)(72,"a",26),n(73,"Vai alla lista prospect"),i()()()()),o&2){let e=z(70),r=u();s(10),m("ngIf",r.error),s(6),c(r.kpi.prospect),s(5),c(r.kpi.clienti),s(5),c(r.kpi.daRichiamare),s(5),c(r.kpi.senzaContatto),s(5),c(r.kpi.configurati),s(5),c(r.kpi.trattativeYuvi),s(5),c(r.kpi.trattativePromethea),s(5),c(r.kpi.referenzeCtr),s(17),m("ngIf",r.ultimiEsiti.length>0)("ngIfElse",e)}}var M=class o{soggetti=E(N);supabase=E(K);authService=E(A);kpiService=E(O);isLoading=k(!0);error=null;kpi={prospect:0,clienti:0,daRichiamare:0,senzaContatto:0,configurati:0,trattativeYuvi:0,trattativePromethea:0,referenzeCtr:0};ultimiEsiti=[];ngOnInit(){this.caricaDashboard()}caricaDashboard(){return _(this,null,function*(){try{this.isLoading.set(!0),yield Promise.all([this.caricaKPI(),this.caricaUltimiEsiti()])}catch(t){console.error("Errore caricamento dashboard:",t),this.error=t.message||"Errore nel caricamento della dashboard"}finally{this.isLoading.set(!1)}})}caricaKPI(){return _(this,null,function*(){try{let t=yield this.kpiService.getProspectKPI();this.kpi.prospect=t.totale,this.kpi.daRichiamare=t.daRichiamare,this.kpi.senzaContatto=t.senzaContatto,this.kpi.configurati=t.configurati;let e=yield this.kpiService.getAnagraficaKPI("cliente");this.kpi.clienti=e.totale;let r=yield this.kpiService.getKPIYuvi();this.kpi.trattativeYuvi=r.totaleTrattative,this.kpi.referenzeCtr=r.referenzeDaCtr;let v=yield this.kpiService.getKPIPromethea();this.kpi.trattativePromethea=v.totaleTrattative}catch(t){throw console.error("Errore caricamento KPI:",t),new Error("Errore nel caricamento dei KPI")}})}caricaUltimiEsiti(){return _(this,null,function*(){try{let e=0,r=[];for(;;){let l=yield this.soggetti.getSoggettiByTipo("prospect",e,e+500-1);if(l.error)throw l.error;let p=l.data??[];if(r.push(...p),p.length<500||(e+=500,e>=5e3))break}let v=[];r.forEach(l=>{let p=Array.isArray(l.esiti)?l.esiti.filter(d=>d&&d.ts):[];if(p.length===0)return;let h=p.reduce((d,x)=>{try{return new Date(x.ts).getTime()>new Date(d.ts).getTime()?x:d}catch{return d}},p[0]);h&&v.push({prospect:l,esito:h,dataEsito:new Date(h.ts)})}),this.ultimiEsiti=v.sort((l,p)=>p.dataEsito.getTime()-l.dataEsito.getTime()).slice(0,10)}catch(t){throw console.error("Errore caricamento ultimi esiti:",t),this.ultimiEsiti=[],new Error("Errore nel caricamento degli ultimi esiti")}})}formatDate(t){return t.toLocaleDateString("it-IT")}getLastEsito(t){if(!Array.isArray(t)||t.length===0)return null;let e=t[0];for(let r of t)new Date(r.ts).getTime()>new Date(e.ts).getTime()&&(e=r);return e}getBadgeClass(t){switch(t){case"Richiamare":return"badge-warning";case"Appuntamento":case"Contratto Chiuso":return"badge-success";case"Non Interessato":return"badge-error";default:return"badge-info"}}getTestoEsito(t){return t.tipo==="Appuntamento"&&t.dataAppuntamento?`Appuntamento il ${this.formatDate(new Date(t.dataAppuntamento))}`:t.tipo}loadData(){return _(this,null,function*(){this.error=null;try{if(yield this.authService.getAuthState(),!this.authService.user()){this.error="Utente non autenticato. Effettua il login.";return}let[e,r,v,l,p,h]=yield Promise.all([this.soggetti.countByTipo("prospect"),this.soggetti.countByTipo("cliente"),this.soggetti.getSoggettiByTipo("prospect",0,199),this.supabase.supabase.from("trattative_yuvi").select("id",{count:"exact",head:!0}),this.supabase.supabase.from("configurazioni_promethea").select("id",{count:"exact",head:!0}),this.supabase.supabase.from("trattative_yuvi").select("nominativi_presi")]);if(console.log("\u{1F4CA} Dati caricati:",{prospect:e.data,clienti:r.data,trattative:l.count}),!e.error&&typeof e.data=="number"&&(this.kpi.prospect=e.data),!r.error&&typeof r.data=="number"&&(this.kpi.clienti=r.data),v.error)throw v.error;let d=v.data??[],x=0,I=0,Y=d.map(g=>this.verificaConfigurazioniProspect(g.id)),$=yield Promise.all(Y);for(let g=0;g<d.length;g++){let y=d[g],b=this.getLastEsito(y.esiti);b||x++,b&&b.tipo==="Richiamare"&&I++,$[g]&&this.kpi.configurati++}this.kpi.senzaContatto=x,this.kpi.daRichiamare=I,!l.error&&typeof l.count=="number"&&(this.kpi.trattativeYuvi=l.count),!p?.error&&typeof p?.count=="number"&&(this.kpi.trattativePromethea=p.count),!h.error&&Array.isArray(h.data)&&(this.kpi.referenzeCtr=h.data.reduce((g,y)=>g+(y.nominativi_presi??0),0)),console.log("\u2705 Home - Caricamento completato")}catch(t){console.error("\u274C Errore nel caricamento home:",t),this.error=t?.message||"Errore durante il caricamento della dashboard"}})}truncate(t,e=50){return t?t.length<=e?t:t.slice(0,e)+"...":"\u2014"}verificaConfigurazioniProspect(t){return _(this,null,function*(){try{let[e,r]=yield Promise.all([this.supabase.supabase.from("configurazioni_promethea").select("id").eq("prospect_id",t).maybeSingle(),this.supabase.supabase.from("trattative_yuvi").select("id").eq("prospect_id",t).maybeSingle()]);return!!(e.data||r.data)}catch(e){return console.warn(`\u26A0\uFE0F Errore verifica configurazioni per prospect ${t}:`,e),!1}})}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=C({type:o,selectors:[["app-home"]],decls:2,vars:2,consts:[["emptyEsiti",""],["title","Caricamento Dashboard","subtitle","Stiamo preparando i tuoi dati...",4,"ngIf"],[4,"ngIf"],["title","Caricamento Dashboard","subtitle","Stiamo preparando i tuoi dati..."],[1,"form-section"],[1,"section-header"],[1,"material-icons","header-icon"],[1,"section-titles"],[1,"section-title"],[1,"sottotitolo"],["class","status-message error",4,"ngIf"],[1,"prospect-cards"],["routerLink","/lista-prospect",1,"card","clickable"],[1,"card-title"],[1,"card-number"],["routerLink","/clienti",1,"card","clickable"],["routerLink","/yuvi-trattativa",1,"card","clickable"],["routerLink","/alchemizzatore",1,"card","clickable"],["routerLink","/visualizzazione-kpi",1,"card","clickable"],[1,"actions-container",2,"margin-top","var(--gutter-lg)","justify-content","center"],["routerLink","/aggiungi-prospect",1,"promethea-button","outline"],["routerLink","/yuvi-trattativa",1,"promethea-button"],["routerLink","/visualizzazione-kpi",1,"promethea-button","secondary"],[1,"form-section",2,"margin-top","var(--gutter-lg)"],["class","table-container",4,"ngIf","ngIfElse"],[1,"actions-container",2,"margin-top","var(--gutter-md)"],["routerLink","/lista-prospect",1,"promethea-button","secondary"],[1,"status-message","error"],[1,"table-container"],[1,"crm-table"],[4,"ngFor","ngForOf"],["data-label","Prospect"],[1,"cell-content"],["class","text-muted","style","font-size: 0.875rem; margin-top: 4px;",4,"ngIf"],["data-label","Contatto"],["class","text-muted","style","font-size: 0.875rem;",4,"ngIf"],["data-label","Provincia"],["data-label","Ultimo Esito"],[1,"badge",3,"ngClass"],["data-label","Data Esito"],["data-label","Note"],[1,"text-muted",2,"font-size","0.875rem","margin-top","4px"],[1,"text-muted",2,"font-size","0.875rem"],[1,"empty-state"],[1,"material-icons",2,"font-size","48px","color","var(--text-muted)","margin-bottom","16px"],[1,"text-muted",2,"margin-top","8px"]],template:function(e,r){e&1&&f(0,B,1,0,"app-page-loader",1)(1,tt,74,11,"div",2),e&2&&(m("ngIf",r.isLoading()),s(),m("ngIf",!r.isLoading()))},dependencies:[R,w,D,L,H,U],styles:["a.card[_ngcontent-%COMP%]{text-decoration:none;color:inherit}.form-section[_ngcontent-%COMP%] + .form-section[_ngcontent-%COMP%]{margin-top:var(--gutter-lg)}"]})};export{M as Home};
