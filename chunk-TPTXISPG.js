import{a as ke}from"./chunk-QMKOTDWG.js";import{b as Ne,e as De,f as Ve,g as Oe}from"./chunk-DS74SF54.js";import{a as ze}from"./chunk-5KN6QFI4.js";import{a as Me}from"./chunk-K6RKOU55.js";import{b as fe,c as A,d as ve,e as xe,f as he,g as Se,j as be,m as ye,n as Ce,o as Ee,p as Pe,t as we,u as Ie,v as Ae}from"./chunk-EXOBR4AO.js";import{b as Te}from"./chunk-JUOMJRR2.js";import{a as _e}from"./chunk-Y2XJCRVM.js";import{b as ue}from"./chunk-3ZXX2K2L.js";import{b as ae,d as re,e as le,h as se,i as ce,j as me,k as de,n as pe,p as ge}from"./chunk-3DLJ4ULO.js";import{Ab as ie,Bb as oe,Eb as L,Ga as K,Jb as S,Kb as C,La as p,Lb as ne,N as X,Rb as O,S as z,Wa as J,X as b,Xa as c,Y as y,Ya as l,Za as n,_a as f,cb as G,db as Y,ea as w,fb as M,ib as I,jb as m,sb as N,ua as a,ub as r,vb as u,wb as v,xb as Q,yb as ee,zb as te}from"./chunk-6W5NKFNP.js";import"./chunk-X5YLR3NI.js";import{a as q,b as Z,i as T}from"./chunk-ODN5LVDJ.js";var $=class o{fallbackProvinces=[{code:"AG",name:"Agrigento",region:"Sicilia"},{code:"AL",name:"Alessandria",region:"Piemonte"},{code:"AN",name:"Ancona",region:"Marche"},{code:"AO",name:"Aosta",region:"Valle d'Aosta"},{code:"AR",name:"Arezzo",region:"Toscana"},{code:"AP",name:"Ascoli Piceno",region:"Marche"},{code:"AT",name:"Asti",region:"Piemonte"},{code:"AV",name:"Avellino",region:"Campania"},{code:"BA",name:"Bari",region:"Puglia"},{code:"BG",name:"Bergamo",region:"Lombardia"},{code:"BI",name:"Biella",region:"Piemonte"},{code:"BL",name:"Belluno",region:"Veneto"},{code:"BN",name:"Benevento",region:"Campania"},{code:"BR",name:"Brindisi",region:"Puglia"},{code:"BS",name:"Brescia",region:"Lombardia"},{code:"BT",name:"Barletta-Andria-Trani",region:"Puglia"},{code:"CA",name:"Cagliari",region:"Sardegna"},{code:"CB",name:"Campobasso",region:"Molise"},{code:"CE",name:"Caserta",region:"Campania"},{code:"CH",name:"Chieti",region:"Abruzzo"},{code:"CI",name:"Carboni Iglesias",region:"Sardegna"},{code:"CL",name:"Caltanissetta",region:"Sicilia"},{code:"CN",name:"Cuneo",region:"Piemonte"},{code:"CO",name:"Como",region:"Lombardia"},{code:"CR",name:"Cremona",region:"Lombardia"},{code:"CS",name:"Cosenza",region:"Calabria"},{code:"CT",name:"Catania",region:"Sicilia"},{code:"CZ",name:"Catanzaro",region:"Calabria"},{code:"EN",name:"Enna",region:"Sicilia"},{code:"FC",name:"Forl\xEC Cesena",region:"Emilia Romagna"},{code:"FE",name:"Ferrara",region:"Emilia Romagna"},{code:"FG",name:"Foggia",region:"Puglia"},{code:"FI",name:"Firenze",region:"Toscana"},{code:"FM",name:"Fermo",region:"Marche"},{code:"FR",name:"Frosinone",region:"Lazio"},{code:"GE",name:"Genova",region:"Liguria"},{code:"GO",name:"Gorizia",region:"Friuli Venezia Giulia"},{code:"GR",name:"Grosseto",region:"Toscana"},{code:"IM",name:"Imperia",region:"Liguria"},{code:"IS",name:"Isernia",region:"Molise"},{code:"KR",name:"Crotone",region:"Calabria"},{code:"LC",name:"Lecco",region:"Lombardia"},{code:"LE",name:"Lecce",region:"Puglia"},{code:"LI",name:"Livorno",region:"Toscana"},{code:"LO",name:"Lodi",region:"Lombardia"},{code:"LT",name:"Latina",region:"Lazio"},{code:"LU",name:"Lucca",region:"Toscana"},{code:"MB",name:"Monza e della Brianza",region:"Lombardia"},{code:"MC",name:"Macerata",region:"Marche"},{code:"ME",name:"Messina",region:"Sicilia"},{code:"MI",name:"Milano",region:"Lombardia"},{code:"MN",name:"Mantova",region:"Lombardia"},{code:"MO",name:"Modena",region:"Emilia Romagna"},{code:"MS",name:"Massa Carrara",region:"Toscana"},{code:"MT",name:"Matera",region:"Basilicata"},{code:"NA",name:"Napoli",region:"Campania"},{code:"NO",name:"Novara",region:"Piemonte"},{code:"NU",name:"Nuoro",region:"Sardegna"},{code:"OG",name:"Ogliastra",region:"Sardegna"},{code:"OR",name:"Oristano",region:"Sardegna"},{code:"OT",name:"Olbia Tempio",region:"Sardegna"},{code:"PA",name:"Palermo",region:"Sicilia"},{code:"PC",name:"Piacenza",region:"Emilia Romagna"},{code:"PD",name:"Padova",region:"Veneto"},{code:"PE",name:"Pescara",region:"Abruzzo"},{code:"PG",name:"Perugia",region:"Umbria"},{code:"PI",name:"Pisa",region:"Toscana"},{code:"PN",name:"Pordenone",region:"Friuli Venezia Giulia"},{code:"PO",name:"Prato",region:"Toscana"},{code:"PR",name:"Parma",region:"Emilia Romagna"},{code:"PT",name:"Pistoia",region:"Toscana"},{code:"PV",name:"Pavia",region:"Lombardia"},{code:"PZ",name:"Potenza",region:"Basilicata"},{code:"RA",name:"Ravenna",region:"Emilia Romagna"},{code:"RC",name:"Reggio Calabria",region:"Calabria"},{code:"RE",name:"Reggio Emilia",region:"Emilia Romagna"},{code:"RG",name:"Ragusa",region:"Sicilia"},{code:"RI",name:"Rieti",region:"Lazio"},{code:"RM",name:"Roma",region:"Lazio"},{code:"RN",name:"Rimini",region:"Emilia Romagna"},{code:"RO",name:"Rovigo",region:"Veneto"},{code:"SA",name:"Salerno",region:"Campania"},{code:"SI",name:"Siena",region:"Toscana"},{code:"SO",name:"Sondrio",region:"Lombardia"},{code:"SP",name:"La Spezia",region:"Liguria"},{code:"SR",name:"Siracusa",region:"Sicilia"},{code:"SS",name:"Sassari",region:"Sardegna"},{code:"SU",name:"Medio Campidano",region:"Sardegna"},{code:"SV",name:"Savona",region:"Liguria"},{code:"TA",name:"Taranto",region:"Puglia"},{code:"TE",name:"Teramo",region:"Abruzzo"},{code:"TN",name:"Trento",region:"Trentino-Alto Adige"},{code:"TO",name:"Torino",region:"Piemonte"},{code:"TP",name:"Trapani",region:"Sicilia"},{code:"TR",name:"Terni",region:"Umbria"},{code:"TS",name:"Trieste",region:"Friuli Venezia Giulia"},{code:"TV",name:"Treviso",region:"Veneto"},{code:"UD",name:"Udine",region:"Friuli Venezia Giulia"},{code:"VA",name:"Varese",region:"Lombardia"},{code:"VB",name:"Verbano-Cusio-Ossola",region:"Piemonte"},{code:"VC",name:"Vercelli",region:"Piemonte"},{code:"VE",name:"Venezia",region:"Veneto"},{code:"VI",name:"Vicenza",region:"Veneto"},{code:"VT",name:"Viterbo",region:"Lazio"}];getProvinces(){return[...this.fallbackProvinces].sort((i,e)=>i.name.localeCompare(e.name))}searchProvinces(i){if(!i||i.length<1)return this.getProvinces();let e=i.toLowerCase();return this.fallbackProvinces.filter(t=>t.name.toLowerCase().includes(e)||t.code.toLowerCase().includes(e)||t.region.toLowerCase().includes(e)).sort((t,s)=>t.name.localeCompare(s.name))}getProvinceByCode(i){return this.fallbackProvinces.find(e=>e.code.toUpperCase()===i.toUpperCase())||null}getRegions(){return[...new Set(this.fallbackProvinces.map(e=>e.region))].sort()}getProvincesByRegion(i){return this.fallbackProvinces.filter(e=>e.region===i).sort((e,t)=>e.name.localeCompare(t.name))}static \u0275fac=function(e){return new(e||o)};static \u0275prov=X({token:o,factory:o.\u0275fac,providedIn:"root"})};var U=()=>[],Le=()=>({standalone:!0});function Re(o,i){if(o&1&&(l(0,"p",12),r(1),n()),o&2){let e=m();a(),v(" ",e.sottotitolo()," ")}}function Ge(o,i){if(o&1){let e=M();G(0),l(1,"button",13),I("click",function(){b(e);let s=m();return y(s.navigateBack())}),l(2,"span",14),r(3,"arrow_back"),n(),r(4," Indietro "),n(),l(5,"button",15),I("click",function(){b(e);let s=m();return y(s.switchToEdit())}),l(6,"span",14),r(7,"edit"),n(),r(8," Modifica "),n(),l(9,"button",16),I("click",function(){b(e);let s=m();return y(s.apriEsito())}),l(10,"span",14),r(11,"note_add"),n(),r(12," Aggiungi esito "),n(),Y()}if(o&2){let e,t=m();a(9),c("disabled",!((e=t.soggettoData())!=null&&e.id))}}function Ye(o,i){o&1&&(l(0,"span",14),r(1,"save"),n())}function $e(o,i){o&1&&f(0,"span",20)}function Ue(o,i){if(o&1){let e=M();G(0),l(1,"button",13),I("click",function(){b(e);let s=m();return y(s.cancel())}),l(2,"span",14),r(3,"close"),n(),r(4," Annulla "),n(),l(5,"button",17),p(6,Ye,2,0,"span",18)(7,$e,1,0,"span",19),r(8),n(),Y()}if(o&2){let e=m();a(5),c("disabled",e.form.invalid||e.isSubmitting()),a(),c("ngIf",!e.isSubmitting()),a(),c("ngIf",e.isSubmitting()),a(),v(" ",e.isSubmitting()?"Salvataggio...":e.mode()==="create"?"Crea":"Aggiorna"," ")}}function We(o,i){if(o&1&&f(0,"app-page-loader",21),o&2){let e=m();c("isLoading",e.loading())}}function je(o,i){if(o&1&&(l(0,"span",53),r(1),n()),o&2){let e=m(2);a(),v(" Prodotto: ",e.prodottoDisplay()," ")}}function qe(o,i){o&1&&(l(0,"span",53),r(1," Configurazione salvata "),n())}function He(o,i){if(o&1&&(l(0,"span",53),r(1),n()),o&2){let e=m(2);a(),v(" Trattative Yuvi: ",(e.trattativeYuvi()??L(1,U)).length," ")}}function Ze(o,i){o&1&&f(0,"input",54)}function Xe(o,i){if(o&1&&(l(0,"span",26),r(1),n()),o&2){let e,t=m(2);a(),u(((e=t.soggettoData())==null?null:e.ragione_sociale)||"\u2014")}}function Ke(o,i){o&1&&(l(0,"small",55),r(1,"Campo obbligatorio"),n())}function Je(o,i){o&1&&(l(0,"small",55),r(1,"Minimo 2 caratteri"),n())}function Qe(o,i){o&1&&f(0,"input",56)}function et(o,i){if(o&1&&(l(0,"span",26),r(1),n()),o&2){let e,t=m(2);a(),u(((e=t.soggettoData())==null?null:e.piva)||"\u2014")}}function tt(o,i){o&1&&(l(0,"small",55),r(1,"Formato non valido (max 11 cifre)"),n())}function it(o,i){if(o&1&&(l(0,"option",60),r(1),n()),o&2){let e=i.$implicit;c("value",e),a(),u(e)}}function ot(o,i){if(o&1&&(l(0,"select",57)(1,"option",58),r(2,"\u2014 Seleziona \u2014"),n(),p(3,it,2,2,"option",59),n()),o&2){let e=m(2);a(3),c("ngForOf",e.formuleSocietarie)}}function nt(o,i){if(o&1&&(l(0,"span",26),r(1),n()),o&2){let e,t=m(2);a(),u(((e=t.soggettoData())==null?null:e.formula_societaria)||"\u2014")}}function at(o,i){o&1&&(l(0,"small",55),r(1,"Campo obbligatorio"),n())}function rt(o,i){if(o&1&&(l(0,"option",60),r(1),n()),o&2){let e=i.$implicit;c("value",e),a(),u(e)}}function lt(o,i){if(o&1&&(l(0,"select",61)(1,"option",58),r(2,"\u2014 Seleziona \u2014"),n(),p(3,rt,2,2,"option",59),n()),o&2){let e=m(2);a(3),c("ngForOf",e.categorieAtecoMacro)}}function st(o,i){if(o&1&&(l(0,"span",26),r(1),n()),o&2){let e,t=m(2);a(),u(((e=t.soggettoData())==null?null:e.categoria_ateco)||"\u2014")}}function ct(o,i){if(o&1){let e=M();l(0,"div",67),I("click",function(){let s=b(e).$implicit,d=m(4);return y(d.onProvinciaSelect(s))}),l(1,"div",68)(2,"strong"),r(3),n(),l(4,"span",69),r(5),n()(),l(6,"small",70),r(7),n()()}if(o&2){let e=i.$implicit;a(3),u(e.name),a(2),v("(",e.code,")"),a(2),u(e.region)}}function mt(o,i){if(o&1&&(l(0,"div",65),p(1,ct,8,3,"div",66),n()),o&2){let e=m(3);a(),c("ngForOf",e.filteredProvinces.slice(0,8))}}function dt(o,i){if(o&1){let e=M();l(0,"div",62)(1,"input",63),ie("ngModelChange",function(s){b(e);let d=m(2);return te(d.provinciaSearch,s)||(d.provinciaSearch=s),y(s)}),I("input",function(s){b(e);let d=m(2);return y(d.onProvinciaSearchChange(s.target.value))})("focus",function(){b(e);let s=m(2);return y(s.onProvinciaFocus())})("blur",function(){b(e);let s=m(2);return y(s.onProvinciaBlur())}),n(),p(2,mt,2,1,"div",64),n()}if(o&2){let e=m(2);a(),ee("ngModel",e.provinciaSearch),c("ngModelOptions",L(3,Le)),a(),c("ngIf",e.showProvinceDropdown&&e.filteredProvinces.length>0)}}function pt(o,i){if(o&1&&(l(0,"span",26),r(1),n()),o&2){let e,t=m(2);a(),u(t.getProvinciaName(((e=t.soggettoData())==null?null:e.provincia)||"")||"\u2014")}}function gt(o,i){o&1&&f(0,"input",71)}function ut(o,i){if(o&1&&(l(0,"span",26),r(1),n()),o&2){let e,t=m(2);a(),u(((e=t.soggettoData())==null?null:e.comune)||"\u2014")}}function _t(o,i){o&1&&f(0,"input",72)}function ft(o,i){if(o&1&&(l(0,"span",26),r(1),n()),o&2){let e,t=m(2);a(),u(((e=t.soggettoData())==null?null:e.indirizzo)||"\u2014")}}function vt(o,i){o&1&&f(0,"input",73)}function xt(o,i){if(o&1&&(l(0,"span",26),r(1),n()),o&2){let e,t=m(2);a(),u(((e=t.soggettoData())==null?null:e.numero_civico)||"\u2014")}}function ht(o,i){if(o&1&&(l(0,"div",29)(1,"span",30)(2,"span",14),r(3,"location_on"),n(),r(4," Coordinate "),n(),l(5,"span",26),r(6),S(7,"number"),S(8,"number"),n()()),o&2){let e,t=m(2);a(6),v(" ",(e=t.soggettoData())!=null&&e.latitude&&((e=t.soggettoData())!=null&&e.longitude)?C(7,1,(e=t.soggettoData())==null?null:e.latitude,"1.4-4")+", "+C(8,4,(e=t.soggettoData())==null?null:e.longitude,"1.4-4"):"\u2014"," ")}}function St(o,i){o&1&&f(0,"input",74)}function bt(o,i){if(o&1&&(l(0,"span",26),r(1),n()),o&2){let e,t=m(2);a(),u(((e=t.soggettoData())==null?null:e.referente)||"\u2014")}}function yt(o,i){o&1&&f(0,"input",75)}function Ct(o,i){if(o&1&&(l(0,"span",26),r(1),n()),o&2){let e,t=m(2);a(),u(((e=t.soggettoData())==null?null:e.telefono)||"\u2014")}}function Et(o,i){o&1&&(l(0,"small",55),r(1,"Numero non valido"),n())}function Pt(o,i){o&1&&f(0,"input",76)}function wt(o,i){if(o&1&&(l(0,"span",26),r(1),n()),o&2){let e,t=m(2);a(),u(((e=t.soggettoData())==null?null:e.email)||"\u2014")}}function It(o,i){o&1&&(l(0,"small",55),r(1,"Email non valida"),n())}function At(o,i){o&1&&f(0,"input",77)}function Tt(o,i){if(o&1&&(l(0,"span",26),r(1),n()),o&2){let e,t=m(2);a(),u(((e=t.soggettoData())==null?null:e.sito_web)||"\u2014")}}function zt(o,i){o&1&&(l(0,"small",55),r(1,"URL non valido"),n())}function Mt(o,i){o&1&&f(0,"input",78)}function Nt(o,i){if(o&1&&(l(0,"span",26),r(1),n()),o&2){let e,t=m(2);a(),u(((e=t.soggettoData())==null?null:e.facebook)||"\u2014")}}function Dt(o,i){o&1&&f(0,"input",79)}function Vt(o,i){if(o&1&&(l(0,"span",26),r(1),n()),o&2){let e,t=m(2);a(),u(((e=t.soggettoData())==null?null:e.instagram)||"\u2014")}}function Ot(o,i){if(o&1&&(l(0,"option",60),r(1),n()),o&2){let e=i.$implicit;c("value",e),a(),u(e)}}function kt(o,i){if(o&1&&(l(0,"select",80)(1,"option",58),r(2,"\u2014 Non specificato \u2014"),n(),p(3,Ot,2,2,"option",59),n()),o&2){let e=m(2);a(3),c("ngForOf",e.metodiPagamento)}}function Ft(o,i){if(o&1&&(l(0,"span",26),r(1),n()),o&2){let e,t=m(2);a(),u(((e=t.soggettoData())==null?null:e.metodo_pagamento)||"\u2014")}}function Bt(o,i){o&1&&f(0,"input",81)}function Lt(o,i){if(o&1&&(l(0,"span",26),r(1),n()),o&2){let e,t=m(2);a(),u(((e=t.soggettoData())==null?null:e.iban)||"\u2014")}}function Rt(o,i){o&1&&(l(0,"small",55),r(1,"IBAN non valido"),n())}function Gt(o,i){o&1&&f(0,"textarea",82)}function Yt(o,i){if(o&1&&(l(0,"span",26),r(1),n()),o&2){let e,t=m(2);a(),u(((e=t.soggettoData())==null?null:e.note)||"\u2014")}}function $t(o,i){if(o&1){let e=M();l(0,"div",88)(1,"input",89),I("change",function(s){let d=b(e).$implicit,_=m(4);return y(_.toggleProduct(d,s.target.checked))}),n(),l(2,"label",90),r(3),n()()}if(o&2){let e=i.$implicit,t=i.index,s=m(4);a(),c("id","prod-"+t)("checked",s.isProductSelected(e)),J("aria-label","Seleziona prodotto "+e),a(),c("title",oe(e))("for","prod-"+t),a(),v(" ",e," ")}}function Ut(o,i){if(o&1&&(l(0,"div",84),p(1,$t,4,7,"div",85),l(2,"div",86)(3,"small",87),r(4,"Promethea e YUVI vengono aggiunti automaticamente quando presenti."),n()()()),o&2){let e=m(3);a(),c("ngForOf",e.prodottiFiltered())}}function Wt(o,i){if(o&1&&(l(0,"span",26),r(1),n()),o&2){let e=m(3);a(),v(" ",e.prodottoDisplay()||"\u2014"," ")}}function jt(o,i){if(o&1&&(l(0,"fieldset",27)(1,"legend",4)(2,"span",14),r(3,"widgets"),n(),r(4," Prodotto "),n(),l(5,"div",28)(6,"label",34)(7,"span",30)(8,"span",14),r(9,"apps"),n(),r(10," Prodotto assegnato"),n(),p(11,Ut,5,1,"div",83)(12,Wt,2,1,"span",32),n()()()),o&2){let e=m(2);a(11),c("ngIf",e.mode()!=="view"),a(),c("ngIf",e.mode()==="view")}}function qt(o,i){if(o&1&&(l(0,"span",94),r(1),S(2,"date"),n()),o&2){let e,t=m(3);a(),v(" Creato il ",C(2,1,(e=t.soggettoData())==null?null:e.created_at,"dd/MM/yyyy HH:mm")," ")}}function Ht(o,i){if(o&1&&(l(0,"span",94),r(1),S(2,"date"),n()),o&2){let e,t=m(3);a(),v(" Aggiornato il ",C(2,1,(e=t.soggettoData())==null?null:e.updated_at,"dd/MM/yyyy HH:mm")," ")}}function Zt(o,i){if(o&1&&(l(0,"span",103)(1,"small"),r(2),S(3,"number"),n()()),o&2){let e,t=m(4);a(2),v("(da ",C(3,1,(e=t.configurazionePromethea())==null?null:e.totale_mensile,"1.0-2")," \u20AC)")}}function Xt(o,i){if(o&1&&(l(0,"span",103)(1,"small"),r(2),S(3,"number"),n()()),o&2){let e,t=m(4);a(2),v("(da ",C(3,1,(e=t.configurazionePromethea())==null?null:e.totale_una_tantum,"1.0-2")," \u20AC)")}}function Kt(o,i){if(o&1&&(l(0,"span"),r(1),S(2,"number"),n()),o&2){let e,t=m(4);a(),Q(" \u2014 sconto ",C(2,2,(e=t.configurazionePromethea())==null?null:e._sconto_percentuale,"1.2-2"),"% (",(e=t.configurazionePromethea())==null?null:e._sconto_target,")")}}function Jt(o,i){if(o&1){let e=M();l(0,"button",104),I("click",function(){b(e);let s=m(4);return y(s.apriConfigurazione())}),l(1,"span",14),r(2,"description"),n(),r(3," Vai al Preventivo "),n()}}function Qt(o,i){if(o&1&&(l(0,"fieldset",95)(1,"legend",4),f(2,"img",96),r(3," Configurazione Promethea "),n(),l(4,"div",97)(5,"div",98)(6,"h3",99),r(7),n(),l(8,"p",100),r(9," Totale mensile: "),l(10,"strong"),r(11),S(12,"number"),n(),p(13,Zt,4,4,"span",101),f(14,"br"),r(15," Totale una tantum: "),l(16,"strong"),r(17),S(18,"number"),n(),p(19,Xt,4,4,"span",101),f(20,"br"),l(21,"small",87),r(22," Totale complessivo scontato: "),l(23,"strong"),r(24),S(25,"number"),n(),p(26,Kt,3,5,"span",8),n()(),p(27,Jt,4,0,"button",102),n()()()),o&2){let e,t,s,d,_,g,E,h=m(3);a(7),v("N. Preventivo: ",((e=h.configurazionePromethea())==null?null:e.numero_preventivo_formattato)??((e=h.configurazionePromethea())!=null&&e.numero_preventivo?"Preventivo #"+((e=h.configurazionePromethea())==null?null:e.numero_preventivo):"Riepilogo")," "),a(4),v(" ",C(12,8,((t=h.configurazionePromethea())==null?null:t.totale_mensile_scontato)??((t=h.configurazionePromethea())==null?null:t.totale_mensile),"1.0-2")," \u20AC "),a(2),c("ngIf",(s=h.configurazionePromethea())==null?null:s._sconto_percentuale),a(4),v(" ",C(18,11,((d=h.configurazionePromethea())==null?null:d.totale_una_tantum_scontato)??((d=h.configurazionePromethea())==null?null:d.totale_una_tantum),"1.0-2")," \u20AC "),a(2),c("ngIf",(_=h.configurazionePromethea())==null?null:_._sconto_percentuale),a(5),v("",C(25,14,((g=h.configurazionePromethea())==null?null:g.totale_scontato)??((g=h.configurazionePromethea())==null?null:g.totale),"1.0-2")," \u20AC"),a(2),c("ngIf",(E=h.configurazionePromethea())==null?null:E._sconto_percentuale),a(),c("ngIf",h.configurazionePromethea())}}function ei(o,i){if(o&1&&(l(0,"p",87),r(1," Importo: "),l(2,"strong"),r(3),S(4,"number"),n()()),o&2){let e=m().$implicit;a(3),v("",C(4,1,e.importo??e.amount,"1.0-0")," \u20AC")}}function ti(o,i){if(o&1&&(l(0,"p",87),r(1),S(2,"date"),n()),o&2){let e=m().$implicit;a(),v(" Data: ",C(2,1,e.data??e.created_at,"dd/MM/yyyy")," ")}}function ii(o,i){if(o&1){let e=M();l(0,"div",108)(1,"div",109)(2,"h3",99),r(3),S(4,"slice"),n(),l(5,"span",94),r(6),n()(),p(7,ei,5,4,"p",110)(8,ti,3,4,"p",110),l(9,"div",111)(10,"button",112),I("click",function(){let s=b(e).$implicit,d=m(4);return y(d.vaiTrattativaYuviById(s.id))}),l(11,"span",14),r(12,"open_in_new"),n(),r(13," Apri trattativa "),n()()()}if(o&2){let e=i.$implicit;a(3),u(e.nome||"Trattativa "+ne(4,4,e.id,0,8)),a(3),u(e.stato||e.status||"\u2014"),a(),c("ngIf",e.importo||e.amount),a(),c("ngIf",e.data||e.created_at)}}function oi(o,i){if(o&1&&(l(0,"fieldset",95)(1,"legend",4),f(2,"img",105),r(3," Trattative Yuvi "),n(),l(4,"div",106),p(5,ii,14,8,"div",107),n()()),o&2){let e=m(3);a(5),c("ngForOf",e.trattativeYuvi()??L(1,U))}}function ni(o,i){if(o&1&&(l(0,"p",117),r(1),n()),o&2){let e=m().$implicit;a(),u(e.note)}}function ai(o,i){if(o&1&&(l(0,"div",115)(1,"div",109)(2,"h3",99),r(3),n(),l(4,"span",94),r(5),S(6,"date"),n()(),p(7,ni,2,1,"p",116),n()),o&2){let e=i.$implicit;a(3),u(e.tipo),a(2),u(C(6,3,e.ts,"dd/MM/yyyy HH:mm")),a(2),c("ngIf",e.note)}}function ri(o,i){if(o&1&&(l(0,"fieldset",95)(1,"legend",4)(2,"span",14),r(3,"history"),n(),r(4," Cronologia esiti "),n(),l(5,"div",113),p(6,ai,8,6,"div",114),n()()),o&2){let e=m(3);a(6),c("ngForOf",e.esitiOrdinati())}}function li(o,i){if(o&1&&(G(0),l(1,"div",91),p(2,qt,3,4,"span",92)(3,Ht,3,4,"span",92),n(),p(4,Qt,28,17,"fieldset",93)(5,oi,6,2,"fieldset",93)(6,ri,7,1,"fieldset",93),Y()),o&2){let e,t,s=m(2);a(2),c("ngIf",(e=s.soggettoData())==null?null:e.created_at),a(),c("ngIf",(t=s.soggettoData())==null?null:t.updated_at),a(),c("ngIf",s.configurazionePromethea()),a(),c("ngIf",(s.trattativeYuvi()??L(5,U)).length),a(),c("ngIf",s.esitiOrdinati().length)}}function si(o,i){if(o&1){let e=M();l(0,"form",22),I("submit",function(){b(e);let s=m();return y(s.submit())}),l(1,"fieldset",23),p(2,je,2,1,"span",24)(3,qe,2,0,"span",24)(4,He,2,2,"span",24),l(5,"span",25),r(6," Creato da: "),l(7,"span",26),r(8),n()()(),l(9,"fieldset",27)(10,"legend",4)(11,"span",14),r(12,"apartment"),n(),r(13," Dati aziendali "),n(),l(14,"div",28)(15,"label",29)(16,"span",30)(17,"span",14),r(18,"business"),n(),r(19," Ragione sociale"),n(),p(20,Ze,1,0,"input",31)(21,Xe,2,1,"span",32)(22,Ke,2,0,"small",33)(23,Je,2,0,"small",33),n(),l(24,"label",34)(25,"span",30)(26,"span",14),r(27,"numbers"),n(),r(28," P.IVA"),n(),p(29,Qe,1,0,"input",35)(30,et,2,1,"span",32)(31,tt,2,0,"small",33),n(),l(32,"label",34)(33,"span",30)(34,"span",14),r(35,"domain"),n(),r(36," Formula societaria"),n(),p(37,ot,4,1,"select",36)(38,nt,2,1,"span",32)(39,at,2,0,"small",33),n(),l(40,"label",34)(41,"span",30)(42,"span",14),r(43,"category"),n(),r(44," Categoria merceologica (ATECO macro)"),n(),p(45,lt,4,1,"select",37)(46,st,2,1,"span",32),n()()(),l(47,"fieldset",27)(48,"legend",4)(49,"span",14),r(50,"place"),n(),r(51," Indirizzo "),n(),l(52,"div",28)(53,"label",34)(54,"span",30)(55,"span",14),r(56,"map"),n(),r(57," Provincia "),n(),p(58,dt,3,4,"div",38)(59,pt,2,1,"span",32),n(),l(60,"label",34)(61,"span",30)(62,"span",14),r(63,"location_city"),n(),r(64," Comune "),n(),p(65,gt,1,0,"input",39)(66,ut,2,1,"span",32),n(),l(67,"label",29)(68,"span",30)(69,"span",14),r(70,"signpost"),n(),r(71," Indirizzo "),n(),p(72,_t,1,0,"input",40)(73,ft,2,1,"span",32),n(),l(74,"label",34)(75,"span",30)(76,"span",14),r(77,"home"),n(),r(78," Numero Civico "),n(),p(79,vt,1,0,"input",41)(80,xt,2,1,"span",32),n(),p(81,ht,9,7,"div",42),n()(),l(82,"fieldset",27)(83,"legend",4)(84,"span",14),r(85,"contacts"),n(),r(86," Referente e contatti "),n(),l(87,"div",28)(88,"label",34)(89,"span",30)(90,"span",14),r(91,"badge"),n(),r(92," Referente"),n(),p(93,St,1,0,"input",43)(94,bt,2,1,"span",32),n(),l(95,"label",34)(96,"span",30)(97,"span",14),r(98,"call"),n(),r(99," Telefono"),n(),p(100,yt,1,0,"input",44)(101,Ct,2,1,"span",32)(102,Et,2,0,"small",33),n(),l(103,"label",34)(104,"span",30)(105,"span",14),r(106,"mail"),n(),r(107," Email"),n(),p(108,Pt,1,0,"input",45)(109,wt,2,1,"span",32)(110,It,2,0,"small",33),n()()(),l(111,"fieldset",27)(112,"legend",4)(113,"span",14),r(114,"public"),n(),r(115," Web e social "),n(),l(116,"div",28)(117,"label",34)(118,"span",30)(119,"span",14),r(120,"language"),n(),r(121," Sito web"),n(),p(122,At,1,0,"input",46)(123,Tt,2,1,"span",32)(124,zt,2,0,"small",33),n(),l(125,"label",34)(126,"span",30)(127,"span",14),r(128,"facebook"),n(),r(129," Facebook"),n(),p(130,Mt,1,0,"input",47)(131,Nt,2,1,"span",32),n(),l(132,"label",34)(133,"span",30)(134,"span",14),r(135,"camera_alt"),n(),r(136," Instagram"),n(),p(137,Dt,1,0,"input",48)(138,Vt,2,1,"span",32),n()()(),l(139,"fieldset",27)(140,"legend",4)(141,"span",14),r(142,"payments"),n(),r(143," Pagamenti "),n(),l(144,"div",28)(145,"label",34)(146,"span",30)(147,"span",14),r(148,"account_balance_wallet"),n(),r(149," Metodo di pagamento"),n(),p(150,kt,4,1,"select",49)(151,Ft,2,1,"span",32),n(),l(152,"label",29)(153,"span",30)(154,"span",14),r(155,"credit_card"),n(),r(156," IBAN"),n(),p(157,Bt,1,0,"input",50)(158,Lt,2,1,"span",32)(159,Rt,2,0,"small",33),n()()(),l(160,"fieldset",27)(161,"legend",4)(162,"span",14),r(163,"notes"),n(),r(164," Note "),n(),l(165,"div",28)(166,"label",29),p(167,Gt,1,0,"textarea",51)(168,Yt,2,1,"span",32),n()()(),p(169,jt,13,2,"fieldset",52)(170,li,7,6,"ng-container",8),n()}if(o&2){let e,t=m();N("view-mode",t.mode()==="view"),c("formGroup",t.form),a(),N("disabled",t.mode()==="view"),a(),c("ngIf",t.prodottoDisplay()),a(),c("ngIf",t.configurazionePromethea()),a(),c("ngIf",(t.trattativeYuvi()??L(66,U)).length),a(4),u(t.creatorName()||((e=t.soggettoData())==null?null:e.created_by)||"\u2014"),a(),N("disabled",t.mode()==="view"),a(11),c("ngIf",t.mode()!=="view"),a(),c("ngIf",t.mode()==="view"),a(),c("ngIf",t.mode()!=="view"&&t.hasError("ragioneSociale","required")),a(),c("ngIf",t.mode()!=="view"&&t.hasError("ragioneSociale","minlength")),a(6),c("ngIf",t.mode()!=="view"),a(),c("ngIf",t.mode()==="view"),a(),c("ngIf",t.mode()!=="view"&&t.hasError("piva","pattern")),a(6),c("ngIf",t.mode()!=="view"),a(),c("ngIf",t.mode()==="view"),a(),c("ngIf",t.mode()!=="view"&&t.hasError("formulaSocietaria","required")),a(6),c("ngIf",t.mode()!=="view"),a(),c("ngIf",t.mode()==="view"),a(),N("disabled",t.mode()==="view"),a(11),c("ngIf",t.mode()!=="view"),a(),c("ngIf",t.mode()==="view"),a(6),c("ngIf",t.mode()!=="view"),a(),c("ngIf",t.mode()==="view"),a(6),c("ngIf",t.mode()!=="view"),a(),c("ngIf",t.mode()==="view"),a(6),c("ngIf",t.mode()!=="view"),a(),c("ngIf",t.mode()==="view"),a(),c("ngIf",t.mode()==="view"),a(),N("disabled",t.mode()==="view"),a(11),c("ngIf",t.mode()!=="view"),a(),c("ngIf",t.mode()==="view"),a(6),c("ngIf",t.mode()!=="view"),a(),c("ngIf",t.mode()==="view"),a(),c("ngIf",t.mode()!=="view"&&t.hasError("telefono","pattern")),a(6),c("ngIf",t.mode()!=="view"),a(),c("ngIf",t.mode()==="view"),a(),c("ngIf",t.mode()!=="view"&&t.hasError("email","email")),a(),N("disabled",t.mode()==="view"),a(11),c("ngIf",t.mode()!=="view"),a(),c("ngIf",t.mode()==="view"),a(),c("ngIf",t.mode()!=="view"&&t.hasError("sitoWeb","pattern")),a(6),c("ngIf",t.mode()!=="view"),a(),c("ngIf",t.mode()==="view"),a(6),c("ngIf",t.mode()!=="view"),a(),c("ngIf",t.mode()==="view"),a(),N("disabled",t.mode()==="view"),a(11),c("ngIf",t.mode()!=="view"),a(),c("ngIf",t.mode()==="view"),a(6),c("ngIf",t.mode()!=="view"),a(),c("ngIf",t.mode()==="view"),a(),c("ngIf",t.mode()!=="view"&&t.hasError("iban","pattern")),a(),N("disabled",t.mode()==="view"),a(7),c("ngIf",t.mode()!=="view"),a(),c("ngIf",t.mode()==="view"),a(),c("ngIf",t.mode()!=="view"),a(),c("ngIf",t.mode()==="view")}}var Fe=class o{fb=z(we);route=z(pe);router=z(ge);location=z(ae);soggettiService=z(Te);alchemizzatoreService=z(Me);geoService=z($);userService=z(_e);supa=z(ue);creatorName=w(null);mode=w("create");loading=w(!1);isSubmitting=w(!1);esitoPopupOpen=w(!1);selectedProducts=w([]);prodottiDynamic=[];tipo=w("prospect");id=w(null);soggettoData=w(null);configurazionePromethea=w(null);trattativeYuvi=w(null);form;provinces=[];filteredProvinces=[];showProvinceDropdown=!1;selectedProvince="";provinciaSearch="";prodotti=Ne;formuleSocietarie=De;categorieAtecoMacro=Ve;metodiPagamento=Oe;submitCooldown=!1;titolo=O(()=>{let i=e=>e==="cliente"?"Cliente":e==="fornitore"?"Fornitore":"Prospect";switch(this.mode()){case"create":return`Nuovo ${i(this.tipo())}`;case"edit":return`Modifica ${i(this.tipo())}`;case"view":return this.soggettoData()?.ragione_sociale||"Scheda soggetto"}});sottotitolo=O(()=>{let i=this.tipo();return i==="cliente"?"Cliente":i==="fornitore"?"Fornitore":"Prospect"});icona=O(()=>{let i=this.tipo();return i==="cliente"?"person":i==="fornitore"?"local_shipping":"person_search"});prodottoDisplay=O(()=>{let e=((this.soggettoData()?.prodotto??"")?.toString()??"").split(",").map(s=>s.trim()).filter(Boolean),t=new Set(e.map(s=>s.toLowerCase()));return this.configurazionePromethea()&&(t.has("promethea")||(e.unshift("Promethea"),t.add("promethea"))),(this.trattativeYuvi()??[]).length&&(t.has("yuvi")||(e.push("YUVI"),t.add("yuvi"))),e.length?e.join(", "):null});isCliente=O(()=>this.tipo()==="cliente");esitiOrdinati=O(()=>[...Array.isArray(this.soggettoData()?.esiti)?this.soggettoData()?.esiti:[]].sort((e,t)=>new Date(t.ts).getTime()-new Date(e.ts).getTime()));ngOnInit(){return T(this,null,function*(){this.provinces=this.geoService.getProvinces(),this.filteredProvinces=this.provinces,yield this.loadProdotti(),yield this.determineModeAndParams(),this.initializeForm(),this.mode()!=="create"&&this.id()&&(yield this.loadSoggetto(this.id()),this.mode()==="view"&&(yield this.loadConfigurazionePromethea(this.id()),yield this.loadTrattativeYuvi(this.id()))),this.route.paramMap.subscribe(i=>T(this,null,function*(){yield this.determineModeAndParams()}))})}determineModeAndParams(){return T(this,null,function*(){let i=this.route.snapshot.paramMap.get("id"),e=(this.route.snapshot.paramMap.get("tipo")||"").toLowerCase(),t=this.router.url;["cliente","fornitore","prospect"].includes(e)&&this.tipo.set(e),i?(this.id.set(i),t.includes("/edit")?this.mode.set("edit"):this.mode.set("view")):this.mode.set("create")})}initializeForm(){this.form=this.fb.group({ragioneSociale:["",[A.required,A.minLength(2)]],piva:["",[A.pattern(/^\d{0,11}$/)]],formulaSocietaria:[""],categoriaAteco:[""],referente:[""],telefono:["",[A.pattern(/^[+]?[\d\s\-()]{0,}$/)]],email:["",[A.email]],sitoWeb:["",[A.pattern(/^(https?:\/\/)?([\w\-]+\.)+[\w\-]{2,}(\/.*)?$|^$/i)]],facebook:[""],instagram:[""],iban:["",[A.pattern(/^[A-Z]{2}\d{2}[A-Z0-9]{0,30}$|^$/i)]],metodoPagamento:[""],note:[""],prodotto:["Promethea"],provincia:[""],comune:[""],indirizzo:[""],numeroCivico:[""]}),this.updateConditionalValidators(),this.form.get("metodoPagamento").valueChanges.subscribe(i=>{let e=this.form.get("iban");i==="Bonifico"||i==="SEPA Direct Debit"?e.enable({emitEvent:!1}):(e.disable({emitEvent:!1}),e.reset("",{emitEvent:!1}))})}loadSoggetto(i){return T(this,null,function*(){this.loading.set(!0);let{data:e,error:t}=yield this.soggettiService.getSoggettoById(i);if(t||!e){alert("Impossibile caricare il soggetto selezionato"),this.loading.set(!1);return}if(this.tipo.set(e.tipo),this.soggettoData.set(e),this.creatorName.set(null),console.log("[AddSoggetto] loadSoggetto id=",i,"created_by=",e.created_by),e.created_by)try{let s=yield this.userService.getUserById(e.created_by);if(console.log("[AddSoggetto] getUserById result=",s),s&&s.data&&!s.error){let d=[s.data.first_name,s.data.last_name].filter(Boolean).join(" ").trim();this.creatorName.set(d||s.data.email||e.created_by),this.soggettoData.set(Z(q({},e),{created_by_user:{id:s.data.id,first_name:s.data.first_name??null,last_name:s.data.last_name??null}}))}else console.warn("[AddSoggetto] user not found or error:",s?.error),this.creatorName.set(e.created_by)}catch(s){console.warn("Errore recupero creatore:",s),this.creatorName.set(e.created_by)}if(e.provincia){this.selectedProvince=e.provincia;let s=this.geoService.getProvinceByCode(e.provincia);s&&(this.provinciaSearch=`${s.name} (${s.code})`)}if(this.mode()==="edit"){let d=String(e.prodotto||"").split(",").map(_=>_.trim()).filter(Boolean).filter(_=>{let g=String(_).toLowerCase();return g!=="promethea"&&g!=="yuvi"});this.selectedProducts.set(d),this.form.patchValue({ragioneSociale:e.ragione_sociale,piva:e.piva,formulaSocietaria:e.formula_societaria,categoriaAteco:e.categoria_ateco,prodotto:d.join(","),referente:e.referente,telefono:e.telefono,email:e.email,sitoWeb:e.sito_web,facebook:e.facebook,instagram:e.instagram,metodoPagamento:e.metodo_pagamento,iban:e.iban,note:e.note,provincia:e.provincia,comune:e.comune,indirizzo:e.indirizzo,numeroCivico:e.numero_civico}),this.updateConditionalValidators()}this.loading.set(!1)})}loadConfigurazionePromethea(i){return T(this,null,function*(){try{let e=yield this.alchemizzatoreService.getConfigurazioniByProspect(i);if(console.log("[loadConfigurazionePromethea] raw result:",e),!e||e.error){console.warn("[loadConfigurazionePromethea] no config or error:",e?.error),this.configurazionePromethea.set(null);return}let t=(e.data??[]).at(0)??null;if(!t){this.configurazionePromethea.set(null);return}let s=t,d=[],_=s.dettagli??s.items??s.lines??s.struttura??s;Array.isArray(_)?d=_.slice():_&&typeof _=="object"?Object.values(_).forEach(x=>{if(!x)return;let B=x.servizi_selezionati??x.servizi??x.items??[];Array.isArray(B)&&d.push(...B)}):["immagine_marketing","contabilita_fiscalita","ottimizzazione_management","digitalizzazione_automatismi"].forEach(B=>{let D=s[B];if(D){let V=D.servizi_selezionati??D.servizi??[];Array.isArray(V)&&d.push(...V)}});let g=0,E=0;d.forEach(x=>{if(!x)return;let B=(x.id??x.key??"").toString(),D=Number(x.prezzo_mensile??x.prezzoMensile??x.price_monthly??x.priceMonthly??0)||0,V=Number(x.prezzo??x.price??x.totale??x.valore??0)||0;D>0&&(g+=D),B.startsWith("social_")&&D===0&&V>0?g+=V:V>0&&(E+=V)}),typeof s.totale_mensile=="number"&&(g=s.totale_mensile||g),typeof s.totale_una_tantum=="number"&&(E=s.totale_una_tantum||E),g=Number(g.toFixed(2)),E=Number(E.toFixed(2));let h=Number((g+E).toFixed(2)),R=s.meta??s.dettagli?.meta??{},k=Number(R.scontoPercentuale??R.sconto_percentuale??R.sconto??0)||0,F=(R.scontoTarget??R.sconto_target??"una").toString().toLowerCase(),W=k>0&&(F==="mensile"||F==="entrambi")?Number((g*(1-k/100)).toFixed(2)):g,j=k>0&&(F==="una"||F==="entrambi")?Number((E*(1-k/100)).toFixed(2)):E,H=Number((W+j).toFixed(2)),P=q({},s);P.totale_mensile=g,P.totale_una_tantum=E,P.totale=h,P.totale_mensile_scontato=W,P.totale_una_tantum_scontato=j,P.totale_scontato=H,P._sconto_percentuale=k,P._sconto_target=F,console.log("[loadConfigurazionePromethea] calcolati:",{totaleMensile:P.totale_mensile,totaleUnaTantum:P.totale_una_tantum,totale:P.totale,mensileScontato:W,unaScontata:j,totaleScontato:H,scontoPercentuale:k,scontoTarget:F}),this.configurazionePromethea.set(P)}catch(e){console.error("[loadConfigurazionePromethea] error",e),this.configurazionePromethea.set(null)}})}loadTrattativeYuvi(i){return T(this,null,function*(){try{console.log("[loadTrattativeYuvi] ricerca trattative_yuvi per prospect",i);let e=this.soggettiService.supabaseService?.supabase??this.soggettiService.supabase;if(!e){console.warn("[loadTrattativeYuvi] supabase client non disponibile su soggettiService"),this.trattativeYuvi.set([]);return}let{data:t,error:s}=yield e.from("trattative_yuvi").select("*").eq("prospect_id",i).order("created_at",{ascending:!1});if(s){console.warn("[loadTrattativeYuvi] query errore:",s),this.trattativeYuvi.set([]);return}let d=Array.isArray(t)?t:t?[t]:[];console.log("[loadTrattativeYuvi] raw rows count:",d.length,d.slice(0,3));let _=d.map(g=>({id:g.id??g.uuid??g.trattativa_id??null,nome:g.nome??g.title??g.name??`Trattativa ${String(g.id??"").slice(0,8)}`,stato:g.stato??g.status??null,importo:g.importo??g.amount??g.totale??null,data:g.created_at??g.data??g.ts??null,prospectId:g.prospect_id??g.prospectId??null,raw:g})).filter(g=>!!g.id);console.log("[loadTrattativeYuvi] normalizzate count",_.length,_.slice(0,3)),this.trattativeYuvi.set(_)}catch(e){console.error("[loadTrattativeYuvi] eccezione",e),this.trattativeYuvi.set([])}})}vaiTrattativaYuviById(i){return T(this,null,function*(){let e=this.soggettoData();if(e?.id)try{let t=this.soggettiService.supabaseService?.supabase??this.soggettiService.supabase;if(!t){alert("Client Supabase non disponibile");return}let s=null;if(i){let{data:d,error:_}=yield t.from("trattative_yuvi").select("*").eq("id",i).single();!_&&d&&(s=d)}if(!s){let{data:d,error:_}=yield t.from("trattative_yuvi").select("*").eq("prospect_id",e.id).order("created_at",{ascending:!1}).limit(1).single();!_&&d&&(s=d)}if(!s){alert("Nessuna trattativa YUVI trovata per questo prospect");return}this.router.navigate(["/yuvi-trattativa"],{queryParams:{prospectId:e.id,trattativaId:s.id,step:7},state:{prospect:e,trattativaEsistente:s,from:"add-soggetto"}})}catch(t){console.error("Errore apertura trattativa Yuvi:",t),alert("Errore nel caricamento della trattativa: "+(t?.message??String(t)))}})}vaiTrattativaYuvi(){let i=(this.trattativeYuvi()??[]).at(0);i?.id&&this.vaiTrattativaYuviById(i.id)}apriConfigurazione(){let i=this.configurazionePromethea();i?.id&&this.router.navigate(["/preventivo",i.id])}switchToEdit(){this.id()&&this.router.navigate(["/soggetto",this.id(),"edit"])}cancel(){if(this.id())this.router.navigate(["/soggetto",this.id()]);else{let i=globalThis?.history;i&&typeof i.length=="number"&&i.length>1?this.location.back():this.router.navigate([this.tipo()==="prospect"?"/lista-prospect":"/home"])}}navigateBack(){let i=globalThis?.history;i&&typeof i.length=="number"&&i.length>1?this.location.back():this.router.navigate([this.tipo()==="prospect"?"/lista-prospect":"/home"])}submit(){return T(this,null,function*(){if(this.submitCooldown||this.isSubmitting())return;if(this.submitCooldown=!0,setTimeout(()=>{this.submitCooldown=!1},2e3),this.form.markAllAsTouched(),this.form.invalid){alert("Compila tutti i campi obbligatori correttamente");return}this.isSubmitting.set(!0);let i=this.form.value;try{let e=this.selectedProducts().length?this.selectedProducts().join(","):i.prodotto||"";if(this.mode()==="edit"&&this.id()){let t={id:this.id(),ragioneSociale:i.ragioneSociale,piva:i.piva?.trim()??"",formulaSocietaria:i.formulaSocietaria,categoriaAteco:i.categoriaAteco,referente:i.referente,telefono:i.telefono,email:i.email,sitoWeb:i.sitoWeb,facebook:i.facebook,instagram:i.instagram,metodoPagamento:i.metodoPagamento,iban:i.iban,note:i.note,prodotto:e,provincia:i.provincia,comune:i.comune,indirizzo:i.indirizzo,numeroCivico:i.numeroCivico},s=yield this.soggettiService.updateSoggetto(t);if(!s.success)throw new Error(s.error);if(i.provincia||i.comune){console.log("\u{1F504} Geocodifica automatica dopo modifica...");let d=yield this.soggettiService.geocodificaEAggiornaSoggetto(this.id());d.success?console.log("\u2705 Coordinate aggiornate con successo"):console.warn("\u26A0\uFE0F Geocodifica non riuscita:",d.error)}alert("Anagrafica aggiornata con successo"),this.router.navigate(["/soggetto",this.id()])}else if(this.mode()==="create"){let t={tipo:this.tipo(),ragioneSociale:i.ragioneSociale,piva:i.piva?.trim()||void 0,formulaSocietaria:i.formulaSocietaria,categoriaAteco:i.categoriaAteco,referente:i.referente,telefono:i.telefono,email:i.email,sitoWeb:i.sitoWeb,facebook:i.facebook,instagram:i.instagram,metodoPagamento:i.metodoPagamento,iban:i.iban,note:i.note,prodotto:e||"Promethea",provincia:i.provincia,comune:i.comune,indirizzo:i.indirizzo,numeroCivico:i.numeroCivico},s=yield this.soggettiService.createSoggetto(t);if(!s.success)throw new Error(s.error);if(s.data&&s.data.id){if(i.provincia||i.comune){console.log("\u{1F504} Geocodifica automatica dopo creazione...");let d=yield this.soggettiService.geocodificaEAggiornaSoggetto(s.data.id);d.success?console.log("\u2705 Coordinate aggiornate con successo"):console.warn("\u26A0\uFE0F Geocodifica non riuscita:",d.error)}alert(`${this.titolo()} aggiunto con successo!`),this.router.navigate(["/soggetto",s.data.id])}else throw new Error("ID del soggetto non restituito dal server")}}catch(e){console.error("Errore durante il salvataggio:",e),alert(`Errore: ${e?.message||"Operazione non riuscita"}`)}finally{this.isSubmitting.set(!1)}})}apriEsito(){this.soggettoData()?.id&&this.esitoPopupOpen.set(!0)}onEsitoPopupClosed(i){return T(this,null,function*(){this.esitoPopupOpen.set(!1),i.saved&&this.id()&&(yield this.loadSoggetto(this.id()))})}updateConditionalValidators(){let i=this.tipo()!=="prospect",e=this.form.get("ragioneSociale"),t=this.form.get("formulaSocietaria");i?(e.addValidators(A.required),t.removeValidators(A.required)):(e.removeValidators(A.required),t.removeValidators(A.required)),e.updateValueAndValidity(),t.updateValueAndValidity()}hasError(i,e){let t=this.form.get(i);return!!(t&&t.touched&&t.hasError(e))}onProvinciaSearchChange(i){if(this.provinciaSearch=i,!i||i.length<1){this.filteredProvinces=[];return}this.filteredProvinces=this.geoService.searchProvinces(i),this.showProvinceDropdown=!0}onProvinciaSelect(i){this.selectedProvince=i.code,this.provinciaSearch=`${i.name} (${i.code})`,this.form.patchValue({provincia:i.code}),this.filteredProvinces=[],this.showProvinceDropdown=!1}onProvinciaFocus(){this.provinciaSearch.length>0&&(this.filteredProvinces=this.geoService.searchProvinces(this.provinciaSearch)),this.showProvinceDropdown=!0}onProvinciaBlur(){setTimeout(()=>{this.showProvinceDropdown=!1},200)}getProvinciaName(i){if(!i)return"";let e=this.geoService.getProvinceByCode(i);return e?`${e.name} (${e.code})`:i}prodottiFiltered=()=>{let i=Array.isArray(this.prodotti)?this.prodotti.map(t=>typeof t=="string"?t:t.nome??""):[];return Array.from(new Map([...i,...this.prodottiDynamic].filter(Boolean).map(t=>[t.toLowerCase(),t])).values()).filter(t=>{let s=(t??"").toString().toLowerCase();return s!=="promethea"&&s!=="yuvi"})};isProductSelected(i){return this.selectedProducts().includes(i)}toggleProduct(i,e){let t=[...this.selectedProducts()];if(e)t.includes(i)||t.push(i);else{let s=t.indexOf(i);s>=0&&t.splice(s,1)}this.selectedProducts.set(t),this.form&&this.form.patchValue({prodotto:t.join(",")},{emitEvent:!1})}loadProdotti(){return T(this,null,function*(){try{let i=yield this.supa.getProdotti();if(i?.error||!Array.isArray(i.data)){this.prodottiDynamic=Array.isArray(this.prodotti)?this.prodotti.map(s=>typeof s=="string"?s:s.nome??"").filter(Boolean):[];return}let e=(i.data??[]).map(s=>String(s.nome??"").trim()).filter(Boolean),t=new Map;e.forEach(s=>t.set(s.toLowerCase(),s)),this.prodottiDynamic=Array.from(t.values())}catch(i){console.warn("[add-soggetto] loadProdotti failed",i),this.prodottiDynamic=Array.isArray(this.prodotti)?this.prodotti.map(e=>typeof e=="string"?e:e.nome??"").filter(Boolean):[]}})}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=K({type:o,selectors:[["app-soggetto"]],decls:15,vars:10,consts:[[1,"add-wrapper"],[1,"section-header"],[1,"material-icons","header-icon"],[1,"section-titles"],[1,"section-title"],["class","section-subtitle",4,"ngIf"],[1,"flex-1"],[1,"actions-container"],[4,"ngIf"],["title","Caricamento in corso","subtitle","Recupero informazioni dal database...",3,"isLoading",4,"ngIf"],["class","form-sections","id","soggettoForm",3,"formGroup","view-mode","submit",4,"ngIf"],[3,"closed","open","soggettoId","tipo"],[1,"section-subtitle"],["type","button",1,"promethea-button","ghost",3,"click"],[1,"material-icons"],["type","button",1,"promethea-button",3,"click"],["type","button",1,"promethea-button",3,"click","disabled"],["type","submit","form","soggettoForm",1,"promethea-button",3,"disabled"],["class","material-icons",4,"ngIf"],["class","loading-spinner",4,"ngIf"],[1,"loading-spinner"],["title","Caricamento in corso","subtitle","Recupero informazioni dal database...",3,"isLoading"],["id","soggettoForm",1,"form-sections",3,"submit","formGroup"],[2,"padding","var(--gutter-sm)","border","1px solid var(--smoke-color-1)","border-radius","16px","box-shadow","0 4px 12px var(--shadow)","gap","var(--gutter-sm)"],["class","chip info","style","margin: var(--gutter-sm) ;",4,"ngIf"],[2,"margin","var(--gutter-sm)"],[1,"view-value"],[1,"form-section"],[1,"grid-form"],[1,"form-field","form-field-col-span"],[1,"form-label"],["type","text","formControlName","ragioneSociale","placeholder","Es. Acme S.r.l.",4,"ngIf"],["class","view-value",4,"ngIf"],["class","error",4,"ngIf"],[1,"form-field"],["type","text","formControlName","piva","placeholder","Opzionale - 11 cifre","inputmode","numeric",4,"ngIf"],["formControlName","formulaSocietaria",4,"ngIf"],["formControlName","categoriaAteco",4,"ngIf"],["class","autocomplete-container",4,"ngIf"],["type","text","formControlName","comune","placeholder","Es. Trieste",4,"ngIf"],["type","text","formControlName","indirizzo","placeholder","Es. Via Roma",4,"ngIf"],["type","text","formControlName","numeroCivico","placeholder","Es. 123",4,"ngIf"],["class","form-field form-field-col-span",4,"ngIf"],["type","text","formControlName","referente","placeholder","Es. Mario Rossi",4,"ngIf"],["type","tel","formControlName","telefono","placeholder","+39 ...","inputmode","tel",4,"ngIf"],["type","email","formControlName","email","placeholder","nome@dominio.tld",4,"ngIf"],["type","url","formControlName","sitoWeb","placeholder","https://...",4,"ngIf"],["type","url","formControlName","facebook","placeholder","https://facebook.com/...",4,"ngIf"],["type","url","formControlName","instagram","placeholder","https://instagram.com/...",4,"ngIf"],["formControlName","metodoPagamento",4,"ngIf"],["type","text","formControlName","iban","placeholder","IT60X0542811101000000123456",4,"ngIf"],["rows","4","formControlName","note","placeholder","Aggiungi note utili...",4,"ngIf"],["class","form-section",4,"ngIf"],[1,"chip","info",2,"margin","var(--gutter-sm)"],["type","text","formControlName","ragioneSociale","placeholder","Es. Acme S.r.l."],[1,"error"],["type","text","formControlName","piva","placeholder","Opzionale - 11 cifre","inputmode","numeric"],["formControlName","formulaSocietaria"],["value",""],[3,"value",4,"ngFor","ngForOf"],[3,"value"],["formControlName","categoriaAteco"],[1,"autocomplete-container"],["type","text","placeholder","Cerca provincia...","autocomplete","off",3,"ngModelChange","input","focus","blur","ngModel","ngModelOptions"],["class","autocomplete-dropdown",4,"ngIf"],[1,"autocomplete-dropdown"],["class","autocomplete-item",3,"click",4,"ngFor","ngForOf"],[1,"autocomplete-item",3,"click"],[1,"autocomplete-main"],[1,"province-code"],[1,"autocomplete-secondary"],["type","text","formControlName","comune","placeholder","Es. Trieste"],["type","text","formControlName","indirizzo","placeholder","Es. Via Roma"],["type","text","formControlName","numeroCivico","placeholder","Es. 123"],["type","text","formControlName","referente","placeholder","Es. Mario Rossi"],["type","tel","formControlName","telefono","placeholder","+39 ...","inputmode","tel"],["type","email","formControlName","email","placeholder","nome@dominio.tld"],["type","url","formControlName","sitoWeb","placeholder","https://..."],["type","url","formControlName","facebook","placeholder","https://facebook.com/..."],["type","url","formControlName","instagram","placeholder","https://instagram.com/..."],["formControlName","metodoPagamento"],["type","text","formControlName","iban","placeholder","IT60X0542811101000000123456"],["rows","4","formControlName","note","placeholder","Aggiungi note utili..."],["class","product-checkboxes",4,"ngIf"],[1,"product-checkboxes"],["class","mod-toggle","style","margin:0 0.4rem 0.4rem 0;",4,"ngFor","ngForOf"],[2,"width","100%","margin-top","0.25rem"],[1,"text-muted"],[1,"mod-toggle",2,"margin","0 0.4rem 0.4rem 0"],["type","checkbox",3,"change","id","checked"],[1,"mod-chip",3,"for","title"],[1,"chips-row"],["class","chip outline",4,"ngIf"],["class","form-section view-section",4,"ngIf"],[1,"chip","outline"],[1,"form-section","view-section"],["src","assets/Logo.png","alt","Promethea",1,"section-logo","promethea-logo"],[1,"config-section"],[1,"card","highlight"],[1,"card-title"],[1,"totale"],["class","text-muted","style","margin-left:6px;",4,"ngIf"],["type","button","style","margin-top: var(--gutter-md)","class","promethea-button",3,"click",4,"ngIf"],[1,"text-muted",2,"margin-left","6px"],["type","button",1,"promethea-button",2,"margin-top","var(--gutter-md)",3,"click"],["src","assets/yuvi.png","alt","Yuvi",1,"section-logo","yuvi-logo"],[1,"list-section"],["class","card soft",4,"ngFor","ngForOf"],[1,"card","soft"],[1,"card-title-row"],["class","text-muted",4,"ngIf"],[1,"card-actions"],[1,"promethea-button",2,"margin-top","var(--gutter-md)",3,"click"],[1,"esiti-timeline"],["class","card soft esito-card",4,"ngFor","ngForOf"],[1,"card","soft","esito-card"],["class","text-muted","style","margin-top: var(--gutter-sm);",4,"ngIf"],[1,"text-muted",2,"margin-top","var(--gutter-sm)"]],template:function(e,t){if(e&1&&(l(0,"section",0)(1,"header",1)(2,"i",2),r(3),n(),l(4,"div",3)(5,"h2",4),r(6),n(),p(7,Re,2,1,"p",5),n(),f(8,"div",6),l(9,"div",7),p(10,Ge,13,1,"ng-container",8)(11,Ue,9,4,"ng-container",8),n()(),p(12,We,1,1,"app-page-loader",9)(13,si,171,67,"form",10),n(),l(14,"app-esito-popup",11),I("closed",function(d){return t.onEsitoPopupClosed(d)}),n()),e&2){let s;a(3),u(t.icona()),a(3),u(t.titolo()),a(),c("ngIf",t.mode()==="view"),a(3),c("ngIf",t.mode()==="view"),a(),c("ngIf",t.mode()!=="view"),a(),c("ngIf",t.loading()),a(),c("ngIf",!t.loading()),a(),c("open",t.esitoPopupOpen())("soggettoId",((s=t.soggettoData())==null?null:s.id)??"")("tipo",t.tipo())}},dependencies:[de,re,le,Ae,Se,Ee,Pe,fe,Ce,ve,xe,be,ye,Ie,he,ze,ke,me,ce,se],styles:[".form-sections[_ngcontent-%COMP%]{display:grid;gap:var(--gutter-lg)}.autocomplete-container[_ngcontent-%COMP%]{position:relative}.autocomplete-dropdown[_ngcontent-%COMP%]{position:absolute;top:100%;left:0;right:0;background:var(--background);border:1px solid var(--smoke-color-1);border-radius:8px;box-shadow:0 4px 12px var(--shadow);max-height:250px;overflow-y:auto;z-index:1000;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)}.autocomplete-item[_ngcontent-%COMP%]{padding:var(--gutter-sm);cursor:pointer;border-bottom:1px solid var(--smoke-color-1);transition:background-color .2s ease;display:flex;flex-direction:column;gap:.25rem}.autocomplete-item[_ngcontent-%COMP%]:hover{background:color-mix(in srgb,var(--primary) 10%,transparent)}.autocomplete-item[_ngcontent-%COMP%]:last-child{border-bottom:none}.autocomplete-main[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem}.province-code[_ngcontent-%COMP%]{color:var(--primary);font-weight:500;font-size:var(--fs-sm)}.autocomplete-secondary[_ngcontent-%COMP%]{color:var(--text-muted);font-size:var(--fs-sm);font-style:italic}.section-titles[_ngcontent-%COMP%]   .section-title[_ngcontent-%COMP%]{white-space:normal;overflow-wrap:anywhere;word-break:break-word;line-height:1.1}.section-header[_ngcontent-%COMP%]{padding:var(--gutter-sm)}.chips-row[_ngcontent-%COMP%]{display:flex;gap:var(--gutter-sm);margin:var(--gutter-sm) 0;flex-wrap:wrap}.section-title[_ngcontent-%COMP%]   .section-logo[_ngcontent-%COMP%], .section-logo[_ngcontent-%COMP%]{width:var(--fs-lg);height:var(--fs-lg);display:inline-block;object-fit:contain;vertical-align:middle;margin-right:.6rem;border-radius:6px}.section-logo.promethea-logo[_ngcontent-%COMP%], .section-logo.yuvi-logo[_ngcontent-%COMP%]{background:transparent}.esiti-timeline[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:var(--gutter-sm)}legend.section-title[_ngcontent-%COMP%]{margin:0}fieldset.form-section[_ngcontent-%COMP%]{margin-bottom:var(--gutter-lg)}"]})};export{Fe as AddSoggetto};
