import{v as _}from"./chunk-67GYVHNT.js";import{N as h,S as b}from"./chunk-QS6MTI54.js";import{a as p,b as g,i as l}from"./chunk-ODN5LVDJ.js";var d=class f{supabaseService=b(_);getKPIYuvi(r){return l(this,null,function*(){try{let e=this.supabaseService.supabase.from("trattative_yuvi").select("*, soggetti!inner(*)").order("created_at",{ascending:!1});r&&(e=e.eq("soggetti.created_by",r));let{data:a,error:t}=yield e,i=this.supabaseService.supabase.from("trattative_yuvi").select("nominativi_presi, soggetti!inner(created_by)");r&&(i=i.eq("soggetti.created_by",r));let{data:n,error:s}=yield i,u=0;n&&!s&&(u=n.reduce((o,v)=>o+(v.nominativi_presi||0),0)),t&&console.error("Errore KPI (trattative):",t),s&&console.error("Errore conteggio referenze da CTR:",s);let m=this.calcolaKPI(a||[]),c=this.raccogliDettagliSoftware(a||[]);return g(p({},m),{referenzeDaCtr:u,dettagliSoftware:c})}catch(e){return console.error("Errore generale KPI:",e),this.getKPIEmpty()}})}raccogliDettagliSoftware(r){let e={};return r.forEach(a=>{if(a.motivazione==="usano_software_proprio"&&a.risposte_questionario){let t=a.risposte_questionario,i="Non specificato";t.domanda_software&&t.domanda_software.nome_software?i=t.domanda_software.nome_software:t.domanda_software&&t.domanda_software.utilizza_software==="si"&&(i="Software non specificato"),i&&(e[i]=(e[i]||0)+1)}}),e}calcolaKPI(r){let e=new Date,a=new Date(e.getFullYear(),e.getMonth(),1),t=r.length,i=r.filter(o=>o.esito==="contratto_chiuso"),n=i.filter(o=>new Date(o.created_at)>=a),s=i.filter(o=>o.nominativi_presi&&o.nominativi_presi>0),u=r.filter(o=>o.esito==="da_richiamare").length,m=r.filter(o=>o.esito==="non_chiuso"),c={};return m.forEach(o=>{o.motivazione&&(c[o.motivazione]=(c[o.motivazione]||0)+1)}),{totaleTrattative:t,contrattiChiusiTotali:i.length,contrattiChiusiMeseCorrente:n.length,percentualeChiusiTotali:t>0?i.length/t*100:0,percentualeChiusiMese:t>0?n.length/t*100:0,percentualeNominativiPresi:i.length>0?s.length/i.length*100:0,percentualeDaRichiamare:t>0?u/t*100:0,motivazioniNonChiusi:c,referenzeDaCtr:0,dettagliSoftware:{}}}getKPIEmpty(){return{totaleTrattative:0,contrattiChiusiTotali:0,contrattiChiusiMeseCorrente:0,percentualeChiusiTotali:0,percentualeChiusiMese:0,percentualeNominativiPresi:0,percentualeDaRichiamare:0,motivazioniNonChiusi:{},referenzeDaCtr:0,dettagliSoftware:{}}}getProspectKPI(){return l(this,null,function*(){let{data:r,error:e}=yield this.supabaseService.supabase.rpc("get_prospect_kpi");if(e)return console.error("get_prospect_kpi error",e),{totale:0,senzaContatto:0,daRichiamare:0,configurati:0};let a=(Array.isArray(r)?r[0]:r)||{};return{totale:a.totale??0,senzaContatto:a.senza_contatto??0,daRichiamare:a.da_richiamare??0,configurati:a.configurati??0}})}getAnagraficaKPI(r){return l(this,null,function*(){let{data:e,error:a}=yield this.supabaseService.supabase.rpc("get_anagrafica_kpi",{p_tipo:r});if(a)return console.error("get_anagrafica_kpi error",r,a),{totale:0,conIban:0,conReferente:0};let t=(Array.isArray(e)?e[0]:e)||{};return{totale:t.totale??0,conIban:t.con_iban??0,conReferente:t.con_referente??0}})}static \u0275fac=function(e){return new(e||f)};static \u0275prov=h({token:f,factory:f.\u0275fac,providedIn:"root"})};export{d as a};
