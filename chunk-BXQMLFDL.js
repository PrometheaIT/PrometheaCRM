import{a as De}from"./chunk-OPZ6X3ZX.js";import{b as Te,e as ze,f as Me,g as Ne}from"./chunk-DS74SF54.js";import{a as we}from"./chunk-VXKDGQT4.js";import{a as Ae}from"./chunk-FR5ZWDXS.js";import{b as ge,c as E,d as ue,e as _e,f as fe,g as ve,j as xe,m as he,n as Se,o as be,p as Ce,t as ye,u as Ee,v as Pe}from"./chunk-JKQMCFLO.js";import{b as Ie}from"./chunk-4VPSVKZE.js";import{a as pe}from"./chunk-AQO4YHIS.js";import"./chunk-UNZMF5LD.js";import{b as oe,d as ne,e as ae,h as re,i as le,j as ce,k as se,n as me,p as de}from"./chunk-T73ZBVQL.js";import{Ab as S,Bb as y,Cb as ie,Ga as K,Ib as O,La as d,N as X,S as z,Wa as s,X as b,Xa as l,Y as C,Ya as n,Za as _,bb as G,cb as Y,ea as w,eb as N,hb as A,ib as m,lb as M,nb as r,ob as u,pb as v,qb as J,rb as Q,sb as ee,tb as te,ua as a,wb as L}from"./chunk-54AF7LZE.js";import"./chunk-X5YLR3NI.js";import{a as j,b as Z,i as T}from"./chunk-ODN5LVDJ.js";var $=class t{fallbackProvinces=[{code:"AG",name:"Agrigento",region:"Sicilia"},{code:"AL",name:"Alessandria",region:"Piemonte"},{code:"AN",name:"Ancona",region:"Marche"},{code:"AO",name:"Aosta",region:"Valle d'Aosta"},{code:"AR",name:"Arezzo",region:"Toscana"},{code:"AP",name:"Ascoli Piceno",region:"Marche"},{code:"AT",name:"Asti",region:"Piemonte"},{code:"AV",name:"Avellino",region:"Campania"},{code:"BA",name:"Bari",region:"Puglia"},{code:"BG",name:"Bergamo",region:"Lombardia"},{code:"BI",name:"Biella",region:"Piemonte"},{code:"BL",name:"Belluno",region:"Veneto"},{code:"BN",name:"Benevento",region:"Campania"},{code:"BR",name:"Brindisi",region:"Puglia"},{code:"BS",name:"Brescia",region:"Lombardia"},{code:"BT",name:"Barletta-Andria-Trani",region:"Puglia"},{code:"CA",name:"Cagliari",region:"Sardegna"},{code:"CB",name:"Campobasso",region:"Molise"},{code:"CE",name:"Caserta",region:"Campania"},{code:"CH",name:"Chieti",region:"Abruzzo"},{code:"CI",name:"Carboni Iglesias",region:"Sardegna"},{code:"CL",name:"Caltanissetta",region:"Sicilia"},{code:"CN",name:"Cuneo",region:"Piemonte"},{code:"CO",name:"Como",region:"Lombardia"},{code:"CR",name:"Cremona",region:"Lombardia"},{code:"CS",name:"Cosenza",region:"Calabria"},{code:"CT",name:"Catania",region:"Sicilia"},{code:"CZ",name:"Catanzaro",region:"Calabria"},{code:"EN",name:"Enna",region:"Sicilia"},{code:"FC",name:"Forl\xEC Cesena",region:"Emilia Romagna"},{code:"FE",name:"Ferrara",region:"Emilia Romagna"},{code:"FG",name:"Foggia",region:"Puglia"},{code:"FI",name:"Firenze",region:"Toscana"},{code:"FM",name:"Fermo",region:"Marche"},{code:"FR",name:"Frosinone",region:"Lazio"},{code:"GE",name:"Genova",region:"Liguria"},{code:"GO",name:"Gorizia",region:"Friuli Venezia Giulia"},{code:"GR",name:"Grosseto",region:"Toscana"},{code:"IM",name:"Imperia",region:"Liguria"},{code:"IS",name:"Isernia",region:"Molise"},{code:"KR",name:"Crotone",region:"Calabria"},{code:"LC",name:"Lecco",region:"Lombardia"},{code:"LE",name:"Lecce",region:"Puglia"},{code:"LI",name:"Livorno",region:"Toscana"},{code:"LO",name:"Lodi",region:"Lombardia"},{code:"LT",name:"Latina",region:"Lazio"},{code:"LU",name:"Lucca",region:"Toscana"},{code:"MB",name:"Monza e della Brianza",region:"Lombardia"},{code:"MC",name:"Macerata",region:"Marche"},{code:"ME",name:"Messina",region:"Sicilia"},{code:"MI",name:"Milano",region:"Lombardia"},{code:"MN",name:"Mantova",region:"Lombardia"},{code:"MO",name:"Modena",region:"Emilia Romagna"},{code:"MS",name:"Massa Carrara",region:"Toscana"},{code:"MT",name:"Matera",region:"Basilicata"},{code:"NA",name:"Napoli",region:"Campania"},{code:"NO",name:"Novara",region:"Piemonte"},{code:"NU",name:"Nuoro",region:"Sardegna"},{code:"OG",name:"Ogliastra",region:"Sardegna"},{code:"OR",name:"Oristano",region:"Sardegna"},{code:"OT",name:"Olbia Tempio",region:"Sardegna"},{code:"PA",name:"Palermo",region:"Sicilia"},{code:"PC",name:"Piacenza",region:"Emilia Romagna"},{code:"PD",name:"Padova",region:"Veneto"},{code:"PE",name:"Pescara",region:"Abruzzo"},{code:"PG",name:"Perugia",region:"Umbria"},{code:"PI",name:"Pisa",region:"Toscana"},{code:"PN",name:"Pordenone",region:"Friuli Venezia Giulia"},{code:"PO",name:"Prato",region:"Toscana"},{code:"PR",name:"Parma",region:"Emilia Romagna"},{code:"PT",name:"Pistoia",region:"Toscana"},{code:"PV",name:"Pavia",region:"Lombardia"},{code:"PZ",name:"Potenza",region:"Basilicata"},{code:"RA",name:"Ravenna",region:"Emilia Romagna"},{code:"RC",name:"Reggio Calabria",region:"Calabria"},{code:"RE",name:"Reggio Emilia",region:"Emilia Romagna"},{code:"RG",name:"Ragusa",region:"Sicilia"},{code:"RI",name:"Rieti",region:"Lazio"},{code:"RM",name:"Roma",region:"Lazio"},{code:"RN",name:"Rimini",region:"Emilia Romagna"},{code:"RO",name:"Rovigo",region:"Veneto"},{code:"SA",name:"Salerno",region:"Campania"},{code:"SI",name:"Siena",region:"Toscana"},{code:"SO",name:"Sondrio",region:"Lombardia"},{code:"SP",name:"La Spezia",region:"Liguria"},{code:"SR",name:"Siracusa",region:"Sicilia"},{code:"SS",name:"Sassari",region:"Sardegna"},{code:"SU",name:"Medio Campidano",region:"Sardegna"},{code:"SV",name:"Savona",region:"Liguria"},{code:"TA",name:"Taranto",region:"Puglia"},{code:"TE",name:"Teramo",region:"Abruzzo"},{code:"TN",name:"Trento",region:"Trentino-Alto Adige"},{code:"TO",name:"Torino",region:"Piemonte"},{code:"TP",name:"Trapani",region:"Sicilia"},{code:"TR",name:"Terni",region:"Umbria"},{code:"TS",name:"Trieste",region:"Friuli Venezia Giulia"},{code:"TV",name:"Treviso",region:"Veneto"},{code:"UD",name:"Udine",region:"Friuli Venezia Giulia"},{code:"VA",name:"Varese",region:"Lombardia"},{code:"VB",name:"Verbano-Cusio-Ossola",region:"Piemonte"},{code:"VC",name:"Vercelli",region:"Piemonte"},{code:"VE",name:"Venezia",region:"Veneto"},{code:"VI",name:"Vicenza",region:"Veneto"},{code:"VT",name:"Viterbo",region:"Lazio"}];getProvinces(){return[...this.fallbackProvinces].sort((o,e)=>o.name.localeCompare(e.name))}searchProvinces(o){if(!o||o.length<1)return this.getProvinces();let e=o.toLowerCase();return this.fallbackProvinces.filter(i=>i.name.toLowerCase().includes(e)||i.code.toLowerCase().includes(e)||i.region.toLowerCase().includes(e)).sort((i,c)=>i.name.localeCompare(c.name))}getProvinceByCode(o){return this.fallbackProvinces.find(e=>e.code.toUpperCase()===o.toUpperCase())||null}getRegions(){return[...new Set(this.fallbackProvinces.map(e=>e.region))].sort()}getProvincesByRegion(o){return this.fallbackProvinces.filter(e=>e.region===o).sort((e,i)=>e.name.localeCompare(i.name))}static \u0275fac=function(e){return new(e||t)};static \u0275prov=X({token:t,factory:t.\u0275fac,providedIn:"root"})};var U=()=>[],Fe=()=>({standalone:!0});function ke(t,o){if(t&1&&(l(0,"p",12),r(1),n()),t&2){let e=m();a(),v(" ",e.sottotitolo()," ")}}function Be(t,o){if(t&1){let e=N();G(0),l(1,"button",13),A("click",function(){b(e);let c=m();return C(c.navigateBack())}),l(2,"span",14),r(3,"arrow_back"),n(),r(4," Indietro "),n(),l(5,"button",15),A("click",function(){b(e);let c=m();return C(c.switchToEdit())}),l(6,"span",14),r(7,"edit"),n(),r(8," Modifica "),n(),l(9,"button",16),A("click",function(){b(e);let c=m();return C(c.apriEsito())}),l(10,"span",14),r(11,"note_add"),n(),r(12," Aggiungi esito "),n(),Y()}if(t&2){let e,i=m();a(9),s("disabled",!((e=i.soggettoData())!=null&&e.id))}}function Le(t,o){t&1&&(l(0,"span",14),r(1,"save"),n())}function Re(t,o){t&1&&_(0,"span",20)}function Ge(t,o){if(t&1){let e=N();G(0),l(1,"button",13),A("click",function(){b(e);let c=m();return C(c.cancel())}),l(2,"span",14),r(3,"close"),n(),r(4," Annulla "),n(),l(5,"button",17),d(6,Le,2,0,"span",18)(7,Re,1,0,"span",19),r(8),n(),Y()}if(t&2){let e=m();a(5),s("disabled",e.form.invalid||e.isSubmitting()),a(),s("ngIf",!e.isSubmitting()),a(),s("ngIf",e.isSubmitting()),a(),v(" ",e.isSubmitting()?"Salvataggio...":e.mode()==="create"?"Crea":"Aggiorna"," ")}}function Ye(t,o){if(t&1&&_(0,"app-page-loader",21),t&2){let e=m();s("isLoading",e.loading())}}function $e(t,o){if(t&1&&(l(0,"span",53),r(1),n()),t&2){let e=m(2);a(),v(" Prodotto: ",e.prodottoDisplay()," ")}}function Ue(t,o){t&1&&(l(0,"span",53),r(1," Configurazione salvata "),n())}function We(t,o){if(t&1&&(l(0,"span",53),r(1),n()),t&2){let e=m(2);a(),v(" Trattative Yuvi: ",(e.trattativeYuvi()??L(1,U)).length," ")}}function qe(t,o){t&1&&_(0,"input",54)}function je(t,o){if(t&1&&(l(0,"span",26),r(1),n()),t&2){let e,i=m(2);a(),u(((e=i.soggettoData())==null?null:e.ragione_sociale)||"\u2014")}}function He(t,o){t&1&&(l(0,"small",55),r(1,"Campo obbligatorio"),n())}function Ze(t,o){t&1&&(l(0,"small",55),r(1,"Minimo 2 caratteri"),n())}function Xe(t,o){t&1&&_(0,"input",56)}function Ke(t,o){if(t&1&&(l(0,"span",26),r(1),n()),t&2){let e,i=m(2);a(),u(((e=i.soggettoData())==null?null:e.piva)||"\u2014")}}function Je(t,o){t&1&&(l(0,"small",55),r(1,"Formato non valido (max 11 cifre)"),n())}function Qe(t,o){if(t&1&&(l(0,"option",60),r(1),n()),t&2){let e=o.$implicit;s("value",e),a(),u(e)}}function et(t,o){if(t&1&&(l(0,"select",57)(1,"option",58),r(2,"\u2014 Seleziona \u2014"),n(),d(3,Qe,2,2,"option",59),n()),t&2){let e=m(2);a(3),s("ngForOf",e.formuleSocietarie)}}function tt(t,o){if(t&1&&(l(0,"span",26),r(1),n()),t&2){let e,i=m(2);a(),u(((e=i.soggettoData())==null?null:e.formula_societaria)||"\u2014")}}function it(t,o){t&1&&(l(0,"small",55),r(1,"Campo obbligatorio"),n())}function ot(t,o){if(t&1&&(l(0,"option",60),r(1),n()),t&2){let e=o.$implicit;s("value",e),a(),u(e)}}function nt(t,o){if(t&1&&(l(0,"select",61)(1,"option",58),r(2,"\u2014 Seleziona \u2014"),n(),d(3,ot,2,2,"option",59),n()),t&2){let e=m(2);a(3),s("ngForOf",e.categorieAtecoMacro)}}function at(t,o){if(t&1&&(l(0,"span",26),r(1),n()),t&2){let e,i=m(2);a(),u(((e=i.soggettoData())==null?null:e.categoria_ateco)||"\u2014")}}function rt(t,o){if(t&1){let e=N();l(0,"div",67),A("click",function(){let c=b(e).$implicit,g=m(4);return C(g.onProvinciaSelect(c))}),l(1,"div",68)(2,"strong"),r(3),n(),l(4,"span",69),r(5),n()(),l(6,"small",70),r(7),n()()}if(t&2){let e=o.$implicit;a(3),u(e.name),a(2),v("(",e.code,")"),a(2),u(e.region)}}function lt(t,o){if(t&1&&(l(0,"div",65),d(1,rt,8,3,"div",66),n()),t&2){let e=m(3);a(),s("ngForOf",e.filteredProvinces.slice(0,8))}}function ct(t,o){if(t&1){let e=N();l(0,"div",62)(1,"input",63),te("ngModelChange",function(c){b(e);let g=m(2);return ee(g.provinciaSearch,c)||(g.provinciaSearch=c),C(c)}),A("input",function(c){b(e);let g=m(2);return C(g.onProvinciaSearchChange(c.target.value))})("focus",function(){b(e);let c=m(2);return C(c.onProvinciaFocus())})("blur",function(){b(e);let c=m(2);return C(c.onProvinciaBlur())}),n(),d(2,lt,2,1,"div",64),n()}if(t&2){let e=m(2);a(),Q("ngModel",e.provinciaSearch),s("ngModelOptions",L(3,Fe)),a(),s("ngIf",e.showProvinceDropdown&&e.filteredProvinces.length>0)}}function st(t,o){if(t&1&&(l(0,"span",26),r(1),n()),t&2){let e,i=m(2);a(),u(i.getProvinciaName(((e=i.soggettoData())==null?null:e.provincia)||"")||"\u2014")}}function mt(t,o){t&1&&_(0,"input",71)}function dt(t,o){if(t&1&&(l(0,"span",26),r(1),n()),t&2){let e,i=m(2);a(),u(((e=i.soggettoData())==null?null:e.comune)||"\u2014")}}function pt(t,o){t&1&&_(0,"input",72)}function gt(t,o){if(t&1&&(l(0,"span",26),r(1),n()),t&2){let e,i=m(2);a(),u(((e=i.soggettoData())==null?null:e.indirizzo)||"\u2014")}}function ut(t,o){t&1&&_(0,"input",73)}function _t(t,o){if(t&1&&(l(0,"span",26),r(1),n()),t&2){let e,i=m(2);a(),u(((e=i.soggettoData())==null?null:e.numero_civico)||"\u2014")}}function ft(t,o){if(t&1&&(l(0,"div",29)(1,"span",30)(2,"span",14),r(3,"location_on"),n(),r(4," Coordinate "),n(),l(5,"span",26),r(6),S(7,"number"),S(8,"number"),n()()),t&2){let e,i=m(2);a(6),v(" ",(e=i.soggettoData())!=null&&e.latitude&&((e=i.soggettoData())!=null&&e.longitude)?y(7,1,(e=i.soggettoData())==null?null:e.latitude,"1.4-4")+", "+y(8,4,(e=i.soggettoData())==null?null:e.longitude,"1.4-4"):"\u2014"," ")}}function vt(t,o){t&1&&_(0,"input",74)}function xt(t,o){if(t&1&&(l(0,"span",26),r(1),n()),t&2){let e,i=m(2);a(),u(((e=i.soggettoData())==null?null:e.referente)||"\u2014")}}function ht(t,o){t&1&&_(0,"input",75)}function St(t,o){if(t&1&&(l(0,"span",26),r(1),n()),t&2){let e,i=m(2);a(),u(((e=i.soggettoData())==null?null:e.telefono)||"\u2014")}}function bt(t,o){t&1&&(l(0,"small",55),r(1,"Numero non valido"),n())}function Ct(t,o){t&1&&_(0,"input",76)}function yt(t,o){if(t&1&&(l(0,"span",26),r(1),n()),t&2){let e,i=m(2);a(),u(((e=i.soggettoData())==null?null:e.email)||"\u2014")}}function Et(t,o){t&1&&(l(0,"small",55),r(1,"Email non valida"),n())}function Pt(t,o){t&1&&_(0,"input",77)}function It(t,o){if(t&1&&(l(0,"span",26),r(1),n()),t&2){let e,i=m(2);a(),u(((e=i.soggettoData())==null?null:e.sito_web)||"\u2014")}}function wt(t,o){t&1&&(l(0,"small",55),r(1,"URL non valido"),n())}function At(t,o){t&1&&_(0,"input",78)}function Tt(t,o){if(t&1&&(l(0,"span",26),r(1),n()),t&2){let e,i=m(2);a(),u(((e=i.soggettoData())==null?null:e.facebook)||"\u2014")}}function zt(t,o){t&1&&_(0,"input",79)}function Mt(t,o){if(t&1&&(l(0,"span",26),r(1),n()),t&2){let e,i=m(2);a(),u(((e=i.soggettoData())==null?null:e.instagram)||"\u2014")}}function Nt(t,o){if(t&1&&(l(0,"option",60),r(1),n()),t&2){let e=o.$implicit;s("value",e),a(),u(e)}}function Dt(t,o){if(t&1&&(l(0,"select",80)(1,"option",58),r(2,"\u2014 Non specificato \u2014"),n(),d(3,Nt,2,2,"option",59),n()),t&2){let e=m(2);a(3),s("ngForOf",e.metodiPagamento)}}function Vt(t,o){if(t&1&&(l(0,"span",26),r(1),n()),t&2){let e,i=m(2);a(),u(((e=i.soggettoData())==null?null:e.metodo_pagamento)||"\u2014")}}function Ot(t,o){t&1&&_(0,"input",81)}function Ft(t,o){if(t&1&&(l(0,"span",26),r(1),n()),t&2){let e,i=m(2);a(),u(((e=i.soggettoData())==null?null:e.iban)||"\u2014")}}function kt(t,o){t&1&&(l(0,"small",55),r(1,"IBAN non valido"),n())}function Bt(t,o){t&1&&_(0,"textarea",82)}function Lt(t,o){if(t&1&&(l(0,"span",26),r(1),n()),t&2){let e,i=m(2);a(),u(((e=i.soggettoData())==null?null:e.note)||"\u2014")}}function Rt(t,o){if(t&1&&(l(0,"option",60),r(1),n()),t&2){let e=o.$implicit;s("value",e),a(),u(e)}}function Gt(t,o){if(t&1&&(l(0,"fieldset",27)(1,"legend",4)(2,"span",14),r(3,"widgets"),n(),r(4," Prodotto "),n(),l(5,"div",28)(6,"label",34)(7,"span",30)(8,"span",14),r(9,"apps"),n(),r(10," Prodotto assegnato"),n(),l(11,"select",83),d(12,Rt,2,2,"option",59),n()()()()),t&2){let e=m(2);a(12),s("ngForOf",e.prodotti)}}function Yt(t,o){if(t&1&&(l(0,"span",87),r(1),S(2,"date"),n()),t&2){let e,i=m(3);a(),v(" Creato il ",y(2,1,(e=i.soggettoData())==null?null:e.created_at,"dd/MM/yyyy HH:mm")," ")}}function $t(t,o){if(t&1&&(l(0,"span",87),r(1),S(2,"date"),n()),t&2){let e,i=m(3);a(),v(" Aggiornato il ",y(2,1,(e=i.soggettoData())==null?null:e.updated_at,"dd/MM/yyyy HH:mm")," ")}}function Ut(t,o){if(t&1&&(l(0,"span",97)(1,"small"),r(2),S(3,"number"),n()()),t&2){let e,i=m(4);a(2),v("(da ",y(3,1,(e=i.configurazionePromethea())==null?null:e.totale_mensile,"1.0-2")," \u20AC)")}}function Wt(t,o){if(t&1&&(l(0,"span",97)(1,"small"),r(2),S(3,"number"),n()()),t&2){let e,i=m(4);a(2),v("(da ",y(3,1,(e=i.configurazionePromethea())==null?null:e.totale_una_tantum,"1.0-2")," \u20AC)")}}function qt(t,o){if(t&1&&(l(0,"span"),r(1),n()),t&2){let e,i=m(4);a(),J(" \u2014 sconto ",(e=i.configurazionePromethea())==null?null:e._sconto_percentuale,"% (",(e=i.configurazionePromethea())==null?null:e._sconto_target,")")}}function jt(t,o){if(t&1){let e=N();l(0,"button",98),A("click",function(){b(e);let c=m(4);return C(c.apriConfigurazione())}),l(1,"span",14),r(2,"settings"),n(),r(3," Vai al Preventivo "),n()}}function Ht(t,o){if(t&1&&(l(0,"fieldset",88)(1,"legend",4),_(2,"img",89),r(3," Configurazione Promethea "),n(),l(4,"div",90)(5,"div",91)(6,"h3",92),r(7),n(),l(8,"p",93),r(9," Totale mensile: "),l(10,"strong"),r(11),S(12,"number"),n(),d(13,Ut,4,4,"span",94),_(14,"br"),r(15," Totale una tantum: "),l(16,"strong"),r(17),S(18,"number"),n(),d(19,Wt,4,4,"span",94),_(20,"br"),l(21,"small",95),r(22," Totale complessivo scontato: "),l(23,"strong"),r(24),S(25,"number"),n(),d(26,qt,2,2,"span",8),n()(),d(27,jt,4,0,"button",96),n()()()),t&2){let e,i,c,g,x,p,P,h=m(3);a(7),v("N. Preventivo: ",((e=h.configurazionePromethea())==null?null:e.numero_preventivo_formattato)??((e=h.configurazionePromethea())!=null&&e.numero_preventivo?"Preventivo #"+((e=h.configurazionePromethea())==null?null:e.numero_preventivo):"Riepilogo")," "),a(4),v(" ",y(12,8,((i=h.configurazionePromethea())==null?null:i.totale_mensile_scontato)??((i=h.configurazionePromethea())==null?null:i.totale_mensile),"1.0-2")," \u20AC "),a(2),s("ngIf",(c=h.configurazionePromethea())==null?null:c._sconto_percentuale),a(4),v(" ",y(18,11,((g=h.configurazionePromethea())==null?null:g.totale_una_tantum_scontato)??((g=h.configurazionePromethea())==null?null:g.totale_una_tantum),"1.0-2")," \u20AC "),a(2),s("ngIf",(x=h.configurazionePromethea())==null?null:x._sconto_percentuale),a(5),v("",y(25,14,((p=h.configurazionePromethea())==null?null:p.totale_scontato)??((p=h.configurazionePromethea())==null?null:p.totale),"1.0-2")," \u20AC"),a(2),s("ngIf",(P=h.configurazionePromethea())==null?null:P._sconto_percentuale),a(),s("ngIf",h.configurazionePromethea())}}function Zt(t,o){if(t&1&&(l(0,"p",95),r(1," Importo: "),l(2,"strong"),r(3),S(4,"number"),n()()),t&2){let e=m().$implicit;a(3),v("",y(4,1,e.importo??e.amount,"1.0-0")," \u20AC")}}function Xt(t,o){if(t&1&&(l(0,"p",95),r(1),S(2,"date"),n()),t&2){let e=m().$implicit;a(),v(" Data: ",y(2,1,e.data??e.created_at,"dd/MM/yyyy")," ")}}function Kt(t,o){if(t&1){let e=N();l(0,"div",102)(1,"div",103)(2,"h3",92),r(3),S(4,"slice"),n(),l(5,"span",87),r(6),n()(),d(7,Zt,5,4,"p",104)(8,Xt,3,4,"p",104),l(9,"div",105)(10,"button",106),A("click",function(){let c=b(e).$implicit,g=m(4);return C(g.vaiTrattativaYuviById(c.id))}),l(11,"span",14),r(12,"open_in_new"),n(),r(13," Apri trattativa "),n()()()}if(t&2){let e=o.$implicit;a(3),u(e.nome||"Trattativa "+ie(4,4,e.id,0,8)),a(3),u(e.stato||e.status||"\u2014"),a(),s("ngIf",e.importo||e.amount),a(),s("ngIf",e.data||e.created_at)}}function Jt(t,o){if(t&1&&(l(0,"fieldset",88)(1,"legend",4),_(2,"img",99),r(3," Trattative Yuvi "),n(),l(4,"div",100),d(5,Kt,14,8,"div",101),n()()),t&2){let e=m(3);a(5),s("ngForOf",e.trattativeYuvi()??L(1,U))}}function Qt(t,o){if(t&1&&(l(0,"p",111),r(1),n()),t&2){let e=m().$implicit;a(),u(e.note)}}function ei(t,o){if(t&1&&(l(0,"div",109)(1,"div",103)(2,"h3",92),r(3),n(),l(4,"span",87),r(5),S(6,"date"),n()(),d(7,Qt,2,1,"p",110),n()),t&2){let e=o.$implicit;a(3),u(e.tipo),a(2),u(y(6,3,e.ts,"dd/MM/yyyy HH:mm")),a(2),s("ngIf",e.note)}}function ti(t,o){if(t&1&&(l(0,"fieldset",88)(1,"legend",4)(2,"span",14),r(3,"history"),n(),r(4," Cronologia esiti "),n(),l(5,"div",107),d(6,ei,8,6,"div",108),n()()),t&2){let e=m(3);a(6),s("ngForOf",e.esitiOrdinati())}}function ii(t,o){if(t&1&&(G(0),l(1,"div",84),d(2,Yt,3,4,"span",85)(3,$t,3,4,"span",85),n(),d(4,Ht,28,17,"fieldset",86)(5,Jt,6,2,"fieldset",86)(6,ti,7,1,"fieldset",86),Y()),t&2){let e,i,c=m(2);a(2),s("ngIf",(e=c.soggettoData())==null?null:e.created_at),a(),s("ngIf",(i=c.soggettoData())==null?null:i.updated_at),a(),s("ngIf",c.configurazionePromethea()),a(),s("ngIf",(c.trattativeYuvi()??L(5,U)).length),a(),s("ngIf",c.esitiOrdinati().length)}}function oi(t,o){if(t&1){let e=N();l(0,"form",22),A("submit",function(){b(e);let c=m();return C(c.submit())}),l(1,"fieldset",23),d(2,$e,2,1,"span",24)(3,Ue,2,0,"span",24)(4,We,2,2,"span",24),l(5,"span",25),r(6," Creato da: "),l(7,"span",26),r(8),n()()(),l(9,"fieldset",27)(10,"legend",4)(11,"span",14),r(12,"apartment"),n(),r(13," Dati aziendali "),n(),l(14,"div",28)(15,"label",29)(16,"span",30)(17,"span",14),r(18,"business"),n(),r(19," Ragione sociale"),n(),d(20,qe,1,0,"input",31)(21,je,2,1,"span",32)(22,He,2,0,"small",33)(23,Ze,2,0,"small",33),n(),l(24,"label",34)(25,"span",30)(26,"span",14),r(27,"numbers"),n(),r(28," P.IVA"),n(),d(29,Xe,1,0,"input",35)(30,Ke,2,1,"span",32)(31,Je,2,0,"small",33),n(),l(32,"label",34)(33,"span",30)(34,"span",14),r(35,"domain"),n(),r(36," Formula societaria"),n(),d(37,et,4,1,"select",36)(38,tt,2,1,"span",32)(39,it,2,0,"small",33),n(),l(40,"label",34)(41,"span",30)(42,"span",14),r(43,"category"),n(),r(44," Categoria merceologica (ATECO macro)"),n(),d(45,nt,4,1,"select",37)(46,at,2,1,"span",32),n()()(),l(47,"fieldset",27)(48,"legend",4)(49,"span",14),r(50,"place"),n(),r(51," Indirizzo "),n(),l(52,"div",28)(53,"label",34)(54,"span",30)(55,"span",14),r(56,"map"),n(),r(57," Provincia "),n(),d(58,ct,3,4,"div",38)(59,st,2,1,"span",32),n(),l(60,"label",34)(61,"span",30)(62,"span",14),r(63,"location_city"),n(),r(64," Comune "),n(),d(65,mt,1,0,"input",39)(66,dt,2,1,"span",32),n(),l(67,"label",29)(68,"span",30)(69,"span",14),r(70,"signpost"),n(),r(71," Indirizzo "),n(),d(72,pt,1,0,"input",40)(73,gt,2,1,"span",32),n(),l(74,"label",34)(75,"span",30)(76,"span",14),r(77,"home"),n(),r(78," Numero Civico "),n(),d(79,ut,1,0,"input",41)(80,_t,2,1,"span",32),n(),d(81,ft,9,7,"div",42),n()(),l(82,"fieldset",27)(83,"legend",4)(84,"span",14),r(85,"contacts"),n(),r(86," Referente e contatti "),n(),l(87,"div",28)(88,"label",34)(89,"span",30)(90,"span",14),r(91,"badge"),n(),r(92," Referente"),n(),d(93,vt,1,0,"input",43)(94,xt,2,1,"span",32),n(),l(95,"label",34)(96,"span",30)(97,"span",14),r(98,"call"),n(),r(99," Telefono"),n(),d(100,ht,1,0,"input",44)(101,St,2,1,"span",32)(102,bt,2,0,"small",33),n(),l(103,"label",34)(104,"span",30)(105,"span",14),r(106,"mail"),n(),r(107," Email"),n(),d(108,Ct,1,0,"input",45)(109,yt,2,1,"span",32)(110,Et,2,0,"small",33),n()()(),l(111,"fieldset",27)(112,"legend",4)(113,"span",14),r(114,"public"),n(),r(115," Web e social "),n(),l(116,"div",28)(117,"label",34)(118,"span",30)(119,"span",14),r(120,"language"),n(),r(121," Sito web"),n(),d(122,Pt,1,0,"input",46)(123,It,2,1,"span",32)(124,wt,2,0,"small",33),n(),l(125,"label",34)(126,"span",30)(127,"span",14),r(128,"facebook"),n(),r(129," Facebook"),n(),d(130,At,1,0,"input",47)(131,Tt,2,1,"span",32),n(),l(132,"label",34)(133,"span",30)(134,"span",14),r(135,"camera_alt"),n(),r(136," Instagram"),n(),d(137,zt,1,0,"input",48)(138,Mt,2,1,"span",32),n()()(),l(139,"fieldset",27)(140,"legend",4)(141,"span",14),r(142,"payments"),n(),r(143," Pagamenti "),n(),l(144,"div",28)(145,"label",34)(146,"span",30)(147,"span",14),r(148,"account_balance_wallet"),n(),r(149," Metodo di pagamento"),n(),d(150,Dt,4,1,"select",49)(151,Vt,2,1,"span",32),n(),l(152,"label",29)(153,"span",30)(154,"span",14),r(155,"credit_card"),n(),r(156," IBAN"),n(),d(157,Ot,1,0,"input",50)(158,Ft,2,1,"span",32)(159,kt,2,0,"small",33),n()()(),l(160,"fieldset",27)(161,"legend",4)(162,"span",14),r(163,"notes"),n(),r(164," Note "),n(),l(165,"div",28)(166,"label",29),d(167,Bt,1,0,"textarea",51)(168,Lt,2,1,"span",32),n()()(),d(169,Gt,13,1,"fieldset",52)(170,ii,7,6,"ng-container",8),n()}if(t&2){let e,i=m();M("view-mode",i.mode()==="view"),s("formGroup",i.form),a(),M("disabled",i.mode()==="view"),a(),s("ngIf",i.prodottoDisplay()),a(),s("ngIf",i.configurazionePromethea()),a(),s("ngIf",(i.trattativeYuvi()??L(66,U)).length),a(4),u(i.creatorName()||((e=i.soggettoData())==null?null:e.created_by)||"\u2014"),a(),M("disabled",i.mode()==="view"),a(11),s("ngIf",i.mode()!=="view"),a(),s("ngIf",i.mode()==="view"),a(),s("ngIf",i.mode()!=="view"&&i.hasError("ragioneSociale","required")),a(),s("ngIf",i.mode()!=="view"&&i.hasError("ragioneSociale","minlength")),a(6),s("ngIf",i.mode()!=="view"),a(),s("ngIf",i.mode()==="view"),a(),s("ngIf",i.mode()!=="view"&&i.hasError("piva","pattern")),a(6),s("ngIf",i.mode()!=="view"),a(),s("ngIf",i.mode()==="view"),a(),s("ngIf",i.mode()!=="view"&&i.hasError("formulaSocietaria","required")),a(6),s("ngIf",i.mode()!=="view"),a(),s("ngIf",i.mode()==="view"),a(),M("disabled",i.mode()==="view"),a(11),s("ngIf",i.mode()!=="view"),a(),s("ngIf",i.mode()==="view"),a(6),s("ngIf",i.mode()!=="view"),a(),s("ngIf",i.mode()==="view"),a(6),s("ngIf",i.mode()!=="view"),a(),s("ngIf",i.mode()==="view"),a(6),s("ngIf",i.mode()!=="view"),a(),s("ngIf",i.mode()==="view"),a(),s("ngIf",i.mode()==="view"),a(),M("disabled",i.mode()==="view"),a(11),s("ngIf",i.mode()!=="view"),a(),s("ngIf",i.mode()==="view"),a(6),s("ngIf",i.mode()!=="view"),a(),s("ngIf",i.mode()==="view"),a(),s("ngIf",i.mode()!=="view"&&i.hasError("telefono","pattern")),a(6),s("ngIf",i.mode()!=="view"),a(),s("ngIf",i.mode()==="view"),a(),s("ngIf",i.mode()!=="view"&&i.hasError("email","email")),a(),M("disabled",i.mode()==="view"),a(11),s("ngIf",i.mode()!=="view"),a(),s("ngIf",i.mode()==="view"),a(),s("ngIf",i.mode()!=="view"&&i.hasError("sitoWeb","pattern")),a(6),s("ngIf",i.mode()!=="view"),a(),s("ngIf",i.mode()==="view"),a(6),s("ngIf",i.mode()!=="view"),a(),s("ngIf",i.mode()==="view"),a(),M("disabled",i.mode()==="view"),a(11),s("ngIf",i.mode()!=="view"),a(),s("ngIf",i.mode()==="view"),a(6),s("ngIf",i.mode()!=="view"),a(),s("ngIf",i.mode()==="view"),a(),s("ngIf",i.mode()!=="view"&&i.hasError("iban","pattern")),a(),M("disabled",i.mode()==="view"),a(7),s("ngIf",i.mode()!=="view"),a(),s("ngIf",i.mode()==="view"),a(),s("ngIf",i.mode()!=="view"),a(),s("ngIf",i.mode()==="view")}}var Ve=class t{fb=z(ye);route=z(me);router=z(de);location=z(oe);soggettiService=z(Ie);alchemizzatoreService=z(Ae);geoService=z($);userService=z(pe);creatorName=w(null);mode=w("create");loading=w(!1);isSubmitting=w(!1);esitoPopupOpen=w(!1);tipo=w("prospect");id=w(null);soggettoData=w(null);configurazionePromethea=w(null);trattativeYuvi=w(null);form;provinces=[];filteredProvinces=[];showProvinceDropdown=!1;selectedProvince="";provinciaSearch="";prodotti=Te;formuleSocietarie=ze;categorieAtecoMacro=Me;metodiPagamento=Ne;submitCooldown=!1;titolo=O(()=>{let o=e=>e==="cliente"?"Cliente":e==="fornitore"?"Fornitore":"Prospect";switch(this.mode()){case"create":return`Nuovo ${o(this.tipo())}`;case"edit":return`Modifica ${o(this.tipo())}`;case"view":return this.soggettoData()?.ragione_sociale||"Scheda soggetto"}});sottotitolo=O(()=>{let o=this.tipo();return o==="cliente"?"Cliente":o==="fornitore"?"Fornitore":"Prospect"});icona=O(()=>{let o=this.tipo();return o==="cliente"?"person":o==="fornitore"?"local_shipping":"person_search"});prodottoDisplay=O(()=>{let e=((this.soggettoData()?.prodotto??"")?.toString()??"").split(",").map(c=>c.trim()).filter(Boolean),i=new Set(e.map(c=>c.toLowerCase()));return this.configurazionePromethea()&&(i.has("promethea")||(e.unshift("Promethea"),i.add("promethea"))),(this.trattativeYuvi()??[]).length&&(i.has("yuvi")||(e.push("YUVI"),i.add("yuvi"))),e.length?e.join(", "):null});isCliente=O(()=>this.tipo()==="cliente");esitiOrdinati=O(()=>[...Array.isArray(this.soggettoData()?.esiti)?this.soggettoData()?.esiti:[]].sort((e,i)=>new Date(i.ts).getTime()-new Date(e.ts).getTime()));ngOnInit(){return T(this,null,function*(){this.provinces=this.geoService.getProvinces(),this.filteredProvinces=this.provinces,yield this.determineModeAndParams(),this.initializeForm(),this.mode()!=="create"&&this.id()&&(yield this.loadSoggetto(this.id()),this.mode()==="view"&&(yield this.loadConfigurazionePromethea(this.id()),yield this.loadTrattativeYuvi(this.id()))),this.route.paramMap.subscribe(o=>T(this,null,function*(){yield this.determineModeAndParams()}))})}determineModeAndParams(){return T(this,null,function*(){let o=this.route.snapshot.paramMap.get("id"),e=(this.route.snapshot.paramMap.get("tipo")||"").toLowerCase(),i=this.router.url;["cliente","fornitore","prospect"].includes(e)&&this.tipo.set(e),o?(this.id.set(o),i.includes("/edit")?this.mode.set("edit"):this.mode.set("view")):this.mode.set("create")})}initializeForm(){this.form=this.fb.group({ragioneSociale:["",[E.required,E.minLength(2)]],piva:["",[E.pattern(/^\d{0,11}$/)]],formulaSocietaria:[""],categoriaAteco:[""],referente:[""],telefono:["",[E.pattern(/^[+]?[\d\s\-()]{0,}$/)]],email:["",[E.email]],sitoWeb:["",[E.pattern(/^(https?:\/\/)?([\w\-]+\.)+[\w\-]{2,}(\/.*)?$|^$/i)]],facebook:[""],instagram:[""],iban:["",[E.pattern(/^[A-Z]{2}\d{2}[A-Z0-9]{0,30}$|^$/i)]],metodoPagamento:[""],note:[""],prodotto:["Promethea",E.required],provincia:[""],comune:[""],indirizzo:[""],numeroCivico:[""]}),this.updateConditionalValidators(),this.form.get("metodoPagamento").valueChanges.subscribe(o=>{let e=this.form.get("iban");o==="Bonifico"||o==="SEPA Direct Debit"?e.enable({emitEvent:!1}):(e.disable({emitEvent:!1}),e.reset("",{emitEvent:!1}))})}loadSoggetto(o){return T(this,null,function*(){this.loading.set(!0);let{data:e,error:i}=yield this.soggettiService.getSoggettoById(o);if(i||!e){alert("Impossibile caricare il soggetto selezionato"),this.loading.set(!1);return}if(this.tipo.set(e.tipo),this.soggettoData.set(e),this.creatorName.set(null),console.log("[AddSoggetto] loadSoggetto id=",o,"created_by=",e.created_by),e.created_by)try{let c=yield this.userService.getUserById(e.created_by);if(console.log("[AddSoggetto] getUserById result=",c),c&&c.data&&!c.error){let g=[c.data.first_name,c.data.last_name].filter(Boolean).join(" ").trim();this.creatorName.set(g||c.data.email||e.created_by),this.soggettoData.set(Z(j({},e),{created_by_user:{id:c.data.id,first_name:c.data.first_name??null,last_name:c.data.last_name??null}}))}else console.warn("[AddSoggetto] user not found or error:",c?.error),this.creatorName.set(e.created_by)}catch(c){console.warn("Errore recupero creatore:",c),this.creatorName.set(e.created_by)}if(e.provincia){this.selectedProvince=e.provincia;let c=this.geoService.getProvinceByCode(e.provincia);c&&(this.provinciaSearch=`${c.name} (${c.code})`)}this.mode()==="edit"&&(this.form.patchValue({ragioneSociale:e.ragione_sociale,piva:e.piva,formulaSocietaria:e.formula_societaria,categoriaAteco:e.categoria_ateco,prodotto:e.prodotto||"Promethea",referente:e.referente,telefono:e.telefono,email:e.email,sitoWeb:e.sito_web,facebook:e.facebook,instagram:e.instagram,metodoPagamento:e.metodo_pagamento,iban:e.iban,note:e.note,provincia:e.provincia,comune:e.comune,indirizzo:e.indirizzo,numeroCivico:e.numero_civico}),this.updateConditionalValidators()),this.loading.set(!1)})}loadConfigurazionePromethea(o){return T(this,null,function*(){try{let e=yield this.alchemizzatoreService.getConfigurazioniByProspect(o);if(console.log("[loadConfigurazionePromethea] raw result:",e),!e||e.error){console.warn("[loadConfigurazionePromethea] no config or error:",e?.error),this.configurazionePromethea.set(null);return}let i=(e.data??[]).at(0)??null;if(!i){this.configurazionePromethea.set(null);return}let c=i,g=[],x=c.dettagli??c.items??c.lines??c.struttura??c;Array.isArray(x)?g=x.slice():x&&typeof x=="object"?Object.values(x).forEach(f=>{if(!f)return;let B=f.servizi_selezionati??f.servizi??f.items??[];Array.isArray(B)&&g.push(...B)}):["immagine_marketing","contabilita_fiscalita","ottimizzazione_management","digitalizzazione_automatismi"].forEach(B=>{let D=c[B];if(D){let V=D.servizi_selezionati??D.servizi??[];Array.isArray(V)&&g.push(...V)}});let p=0,P=0;g.forEach(f=>{if(!f)return;let B=(f.id??f.key??"").toString(),D=Number(f.prezzo_mensile??f.prezzoMensile??f.price_monthly??f.priceMonthly??0)||0,V=Number(f.prezzo??f.price??f.totale??f.valore??0)||0;D>0&&(p+=D),B.startsWith("social_")&&D===0&&V>0?p+=V:V>0&&(P+=V)}),typeof c.totale_mensile=="number"&&(p=c.totale_mensile||p),typeof c.totale_una_tantum=="number"&&(P=c.totale_una_tantum||P),p=Number(p.toFixed(2)),P=Number(P.toFixed(2));let h=Number((p+P).toFixed(2)),R=c.meta??c.dettagli?.meta??{},F=Number(R.scontoPercentuale??R.sconto_percentuale??R.sconto??0)||0,k=(R.scontoTarget??R.sconto_target??"una").toString().toLowerCase(),W=F>0&&(k==="mensile"||k==="entrambi")?Number((p*(1-F/100)).toFixed(2)):p,q=F>0&&(k==="una"||k==="entrambi")?Number((P*(1-F/100)).toFixed(2)):P,H=Number((W+q).toFixed(2)),I=j({},c);I.totale_mensile=p,I.totale_una_tantum=P,I.totale=h,I.totale_mensile_scontato=W,I.totale_una_tantum_scontato=q,I.totale_scontato=H,I._sconto_percentuale=F,I._sconto_target=k,console.log("[loadConfigurazionePromethea] calcolati:",{totaleMensile:I.totale_mensile,totaleUnaTantum:I.totale_una_tantum,totale:I.totale,mensileScontato:W,unaScontata:q,totaleScontato:H,scontoPercentuale:F,scontoTarget:k}),this.configurazionePromethea.set(I)}catch(e){console.error("[loadConfigurazionePromethea] error",e),this.configurazionePromethea.set(null)}})}loadTrattativeYuvi(o){return T(this,null,function*(){try{console.log("[loadTrattativeYuvi] ricerca trattative_yuvi per prospect",o);let e=this.soggettiService.supabaseService?.supabase??this.soggettiService.supabase;if(!e){console.warn("[loadTrattativeYuvi] supabase client non disponibile su soggettiService"),this.trattativeYuvi.set([]);return}let{data:i,error:c}=yield e.from("trattative_yuvi").select("*").eq("prospect_id",o).order("created_at",{ascending:!1});if(c){console.warn("[loadTrattativeYuvi] query errore:",c),this.trattativeYuvi.set([]);return}let g=Array.isArray(i)?i:i?[i]:[];console.log("[loadTrattativeYuvi] raw rows count:",g.length,g.slice(0,3));let x=g.map(p=>({id:p.id??p.uuid??p.trattativa_id??null,nome:p.nome??p.title??p.name??`Trattativa ${String(p.id??"").slice(0,8)}`,stato:p.stato??p.status??null,importo:p.importo??p.amount??p.totale??null,data:p.created_at??p.data??p.ts??null,prospectId:p.prospect_id??p.prospectId??null,raw:p})).filter(p=>!!p.id);console.log("[loadTrattativeYuvi] normalizzate count",x.length,x.slice(0,3)),this.trattativeYuvi.set(x)}catch(e){console.error("[loadTrattativeYuvi] eccezione",e),this.trattativeYuvi.set([])}})}vaiTrattativaYuviById(o){return T(this,null,function*(){let e=this.soggettoData();if(e?.id)try{let i=this.soggettiService.supabaseService?.supabase??this.soggettiService.supabase;if(!i){alert("Client Supabase non disponibile");return}let c=null;if(o){let{data:g,error:x}=yield i.from("trattative_yuvi").select("*").eq("id",o).single();!x&&g&&(c=g)}if(!c){let{data:g,error:x}=yield i.from("trattative_yuvi").select("*").eq("prospect_id",e.id).order("created_at",{ascending:!1}).limit(1).single();!x&&g&&(c=g)}if(!c){alert("Nessuna trattativa YUVI trovata per questo prospect");return}this.router.navigate(["/yuvi-trattativa"],{queryParams:{prospectId:e.id,trattativaId:c.id,step:7},state:{prospect:e,trattativaEsistente:c,from:"add-soggetto"}})}catch(i){console.error("Errore apertura trattativa Yuvi:",i),alert("Errore nel caricamento della trattativa: "+(i?.message??String(i)))}})}vaiTrattativaYuvi(){let o=(this.trattativeYuvi()??[]).at(0);o?.id&&this.vaiTrattativaYuviById(o.id)}apriConfigurazione(){let o=this.configurazionePromethea();o?.id&&this.router.navigate(["/preventivo",o.id])}switchToEdit(){this.id()&&this.router.navigate(["/soggetto",this.id(),"edit"])}cancel(){if(this.id())this.router.navigate(["/soggetto",this.id()]);else{let o=globalThis?.history;o&&typeof o.length=="number"&&o.length>1?this.location.back():this.router.navigate([this.tipo()==="prospect"?"/lista-prospect":"/home"])}}navigateBack(){let o=globalThis?.history;o&&typeof o.length=="number"&&o.length>1?this.location.back():this.router.navigate([this.tipo()==="prospect"?"/lista-prospect":"/home"])}submit(){return T(this,null,function*(){if(this.submitCooldown||this.isSubmitting())return;if(this.submitCooldown=!0,setTimeout(()=>{this.submitCooldown=!1},2e3),this.form.markAllAsTouched(),this.form.invalid){alert("Compila tutti i campi obbligatori correttamente");return}this.isSubmitting.set(!0);let o=this.form.value;try{if(this.mode()==="edit"&&this.id()){let e={id:this.id(),ragioneSociale:o.ragioneSociale,piva:o.piva?.trim()??"",formulaSocietaria:o.formulaSocietaria,categoriaAteco:o.categoriaAteco,referente:o.referente,telefono:o.telefono,email:o.email,sitoWeb:o.sitoWeb,facebook:o.facebook,instagram:o.instagram,metodoPagamento:o.metodoPagamento,iban:o.iban,note:o.note,prodotto:o.prodotto,provincia:o.provincia,comune:o.comune,indirizzo:o.indirizzo,numeroCivico:o.numeroCivico},i=yield this.soggettiService.updateSoggetto(e);if(!i.success)throw new Error(i.error);if(o.provincia||o.comune){console.log("\u{1F504} Geocodifica automatica dopo modifica...");let c=yield this.soggettiService.geocodificaEAggiornaSoggetto(this.id());c.success?console.log("\u2705 Coordinate aggiornate con successo"):console.warn("\u26A0\uFE0F Geocodifica non riuscita:",c.error)}alert("Anagrafica aggiornata con successo"),this.router.navigate(["/soggetto",this.id()])}else if(this.mode()==="create"){let e={tipo:this.tipo(),ragioneSociale:o.ragioneSociale,piva:o.piva?.trim()||void 0,formulaSocietaria:o.formulaSocietaria,categoriaAteco:o.categoriaAteco,referente:o.referente,telefono:o.telefono,email:o.email,sitoWeb:o.sitoWeb,facebook:o.facebook,instagram:o.instagram,metodoPagamento:o.metodoPagamento,iban:o.iban,note:o.note,prodotto:o.prodotto||"Promethea",provincia:o.provincia,comune:o.comune,indirizzo:o.indirizzo,numeroCivico:o.numeroCivico},i=yield this.soggettiService.createSoggetto(e);if(!i.success)throw new Error(i.error);if(i.data&&i.data.id){if(o.provincia||o.comune){console.log("\u{1F504} Geocodifica automatica dopo creazione...");let c=yield this.soggettiService.geocodificaEAggiornaSoggetto(i.data.id);c.success?console.log("\u2705 Coordinate aggiornate con successo"):console.warn("\u26A0\uFE0F Geocodifica non riuscita:",c.error)}alert(`${this.titolo()} aggiunto con successo!`),this.router.navigate(["/soggetto",i.data.id])}else throw new Error("ID del soggetto non restituito dal server")}}catch(e){console.error("Errore durante il salvataggio:",e),alert(`Errore: ${e?.message||"Operazione non riuscita"}`)}finally{this.isSubmitting.set(!1)}})}apriEsito(){this.soggettoData()?.id&&this.esitoPopupOpen.set(!0)}onEsitoPopupClosed(o){return T(this,null,function*(){this.esitoPopupOpen.set(!1),o.saved&&this.id()&&(yield this.loadSoggetto(this.id()))})}updateConditionalValidators(){let o=this.tipo()!=="prospect",e=this.form.get("ragioneSociale"),i=this.form.get("formulaSocietaria");o?(e.addValidators(E.required),i.addValidators(E.required)):(e.removeValidators(E.required),i.removeValidators(E.required)),e.updateValueAndValidity(),i.updateValueAndValidity()}hasError(o,e){let i=this.form.get(o);return!!(i&&i.touched&&i.hasError(e))}onProvinciaSearchChange(o){if(this.provinciaSearch=o,!o||o.length<1){this.filteredProvinces=[];return}this.filteredProvinces=this.geoService.searchProvinces(o),this.showProvinceDropdown=!0}onProvinciaSelect(o){this.selectedProvince=o.code,this.provinciaSearch=`${o.name} (${o.code})`,this.form.patchValue({provincia:o.code}),this.filteredProvinces=[],this.showProvinceDropdown=!1}onProvinciaFocus(){this.provinciaSearch.length>0&&(this.filteredProvinces=this.geoService.searchProvinces(this.provinciaSearch)),this.showProvinceDropdown=!0}onProvinciaBlur(){setTimeout(()=>{this.showProvinceDropdown=!1},200)}getProvinciaName(o){if(!o)return"";let e=this.geoService.getProvinceByCode(o);return e?`${e.name} (${e.code})`:o}static \u0275fac=function(e){return new(e||t)};static \u0275cmp=K({type:t,selectors:[["app-soggetto"]],decls:15,vars:10,consts:[[1,"add-wrapper"],[1,"section-header"],[1,"material-icons","header-icon"],[1,"section-titles"],[1,"section-title"],["class","section-subtitle",4,"ngIf"],[1,"flex-1"],[1,"action-buttons"],[4,"ngIf"],["title","Caricamento in corso","subtitle","Recupero informazioni dal database...",3,"isLoading",4,"ngIf"],["class","form-sections","id","soggettoForm",3,"formGroup","view-mode","submit",4,"ngIf"],[3,"closed","open","soggettoId","tipo"],[1,"section-subtitle"],["type","button",1,"promethea-button","ghost",3,"click"],[1,"material-icons"],["type","button",1,"promethea-button",3,"click"],["type","button",1,"promethea-button",3,"click","disabled"],["type","submit","form","soggettoForm",1,"promethea-button",3,"disabled"],["class","material-icons",4,"ngIf"],["class","loading-spinner",4,"ngIf"],[1,"loading-spinner"],["title","Caricamento in corso","subtitle","Recupero informazioni dal database...",3,"isLoading"],["id","soggettoForm",1,"form-sections",3,"submit","formGroup"],[2,"padding","var(--gutter-sm)","border","1px solid var(--smoke-color-1)","border-radius","16px","box-shadow","0 4px 12px var(--shadow)","gap","var(--gutter-sm)"],["class","chip info","style","margin: var(--gutter-sm) ;",4,"ngIf"],[2,"margin","var(--gutter-sm)"],[1,"view-value"],[1,"form-section"],[1,"grid-form"],[1,"form-field","form-field-col-span"],[1,"form-label"],["type","text","formControlName","ragioneSociale","placeholder","Es. Acme S.r.l.",4,"ngIf"],["class","view-value",4,"ngIf"],["class","error",4,"ngIf"],[1,"form-field"],["type","text","formControlName","piva","placeholder","Opzionale - 11 cifre","inputmode","numeric",4,"ngIf"],["formControlName","formulaSocietaria",4,"ngIf"],["formControlName","categoriaAteco",4,"ngIf"],["class","autocomplete-container",4,"ngIf"],["type","text","formControlName","comune","placeholder","Es. Trieste",4,"ngIf"],["type","text","formControlName","indirizzo","placeholder","Es. Via Roma",4,"ngIf"],["type","text","formControlName","numeroCivico","placeholder","Es. 123",4,"ngIf"],["class","form-field form-field-col-span",4,"ngIf"],["type","text","formControlName","referente","placeholder","Es. Mario Rossi",4,"ngIf"],["type","tel","formControlName","telefono","placeholder","+39 ...","inputmode","tel",4,"ngIf"],["type","email","formControlName","email","placeholder","nome@dominio.tld",4,"ngIf"],["type","url","formControlName","sitoWeb","placeholder","https://...",4,"ngIf"],["type","url","formControlName","facebook","placeholder","https://facebook.com/...",4,"ngIf"],["type","url","formControlName","instagram","placeholder","https://instagram.com/...",4,"ngIf"],["formControlName","metodoPagamento",4,"ngIf"],["type","text","formControlName","iban","placeholder","IT60X0542811101000000123456",4,"ngIf"],["rows","4","formControlName","note","placeholder","Aggiungi note utili...",4,"ngIf"],["class","form-section",4,"ngIf"],[1,"chip","info",2,"margin","var(--gutter-sm)"],["type","text","formControlName","ragioneSociale","placeholder","Es. Acme S.r.l."],[1,"error"],["type","text","formControlName","piva","placeholder","Opzionale - 11 cifre","inputmode","numeric"],["formControlName","formulaSocietaria"],["value",""],[3,"value",4,"ngFor","ngForOf"],[3,"value"],["formControlName","categoriaAteco"],[1,"autocomplete-container"],["type","text","placeholder","Cerca provincia...","autocomplete","off",3,"ngModelChange","input","focus","blur","ngModel","ngModelOptions"],["class","autocomplete-dropdown",4,"ngIf"],[1,"autocomplete-dropdown"],["class","autocomplete-item",3,"click",4,"ngFor","ngForOf"],[1,"autocomplete-item",3,"click"],[1,"autocomplete-main"],[1,"province-code"],[1,"autocomplete-secondary"],["type","text","formControlName","comune","placeholder","Es. Trieste"],["type","text","formControlName","indirizzo","placeholder","Es. Via Roma"],["type","text","formControlName","numeroCivico","placeholder","Es. 123"],["type","text","formControlName","referente","placeholder","Es. Mario Rossi"],["type","tel","formControlName","telefono","placeholder","+39 ...","inputmode","tel"],["type","email","formControlName","email","placeholder","nome@dominio.tld"],["type","url","formControlName","sitoWeb","placeholder","https://..."],["type","url","formControlName","facebook","placeholder","https://facebook.com/..."],["type","url","formControlName","instagram","placeholder","https://instagram.com/..."],["formControlName","metodoPagamento"],["type","text","formControlName","iban","placeholder","IT60X0542811101000000123456"],["rows","4","formControlName","note","placeholder","Aggiungi note utili..."],["formControlName","prodotto"],[1,"chips-row"],["class","chip outline",4,"ngIf"],["class","form-section view-section",4,"ngIf"],[1,"chip","outline"],[1,"form-section","view-section"],["src","assets/Logo.png","alt","Promethea",1,"section-logo","promethea-logo"],[1,"config-section"],[1,"card","highlight"],[1,"card-title"],[1,"totale"],["class","text-muted","style","margin-left:6px;",4,"ngIf"],[1,"text-muted"],["type","button","style","margin-top: var(--gutter-md)","class","promethea-button",3,"click",4,"ngIf"],[1,"text-muted",2,"margin-left","6px"],["type","button",1,"promethea-button",2,"margin-top","var(--gutter-md)",3,"click"],["src","assets/yuvi.png","alt","Yuvi",1,"section-logo","yuvi-logo"],[1,"list-section"],["class","card soft",4,"ngFor","ngForOf"],[1,"card","soft"],[1,"card-title-row"],["class","text-muted",4,"ngIf"],[1,"card-actions"],[1,"promethea-button",2,"margin-top","var(--gutter-md)",3,"click"],[1,"esiti-timeline"],["class","card soft esito-card",4,"ngFor","ngForOf"],[1,"card","soft","esito-card"],["class","text-muted","style","margin-top: var(--gutter-sm);",4,"ngIf"],[1,"text-muted",2,"margin-top","var(--gutter-sm)"]],template:function(e,i){if(e&1&&(l(0,"section",0)(1,"header",1)(2,"i",2),r(3),n(),l(4,"div",3)(5,"h2",4),r(6),n(),d(7,ke,2,1,"p",5),n(),_(8,"div",6),l(9,"div",7),d(10,Be,13,1,"ng-container",8)(11,Ge,9,4,"ng-container",8),n()(),d(12,Ye,1,1,"app-page-loader",9)(13,oi,171,67,"form",10),n(),l(14,"app-esito-popup",11),A("closed",function(g){return i.onEsitoPopupClosed(g)}),n()),e&2){let c;a(3),u(i.icona()),a(3),u(i.titolo()),a(),s("ngIf",i.mode()==="view"),a(3),s("ngIf",i.mode()==="view"),a(),s("ngIf",i.mode()!=="view"),a(),s("ngIf",i.loading()),a(),s("ngIf",!i.loading()),a(),s("open",i.esitoPopupOpen())("soggettoId",((c=i.soggettoData())==null?null:c.id)??"")("tipo",i.tipo())}},dependencies:[se,ne,ae,Pe,ve,be,Ce,ge,Se,ue,_e,xe,he,Ee,fe,we,De,ce,le,re],styles:[".form-sections[_ngcontent-%COMP%]{display:grid;gap:var(--gutter-lg)}.autocomplete-container[_ngcontent-%COMP%]{position:relative}.autocomplete-dropdown[_ngcontent-%COMP%]{position:absolute;top:100%;left:0;right:0;background:var(--background);border:1px solid var(--smoke-color-1);border-radius:8px;box-shadow:0 4px 12px var(--shadow);max-height:250px;overflow-y:auto;z-index:1000;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)}.autocomplete-item[_ngcontent-%COMP%]{padding:var(--gutter-sm);cursor:pointer;border-bottom:1px solid var(--smoke-color-1);transition:background-color .2s ease;display:flex;flex-direction:column;gap:.25rem}.autocomplete-item[_ngcontent-%COMP%]:hover{background:color-mix(in srgb,var(--primary) 10%,transparent)}.autocomplete-item[_ngcontent-%COMP%]:last-child{border-bottom:none}.autocomplete-main[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem}.province-code[_ngcontent-%COMP%]{color:var(--primary);font-weight:500;font-size:var(--fs-sm)}.autocomplete-secondary[_ngcontent-%COMP%]{color:var(--text-muted);font-size:var(--fs-sm);font-style:italic}.section-header[_ngcontent-%COMP%]{padding:var(--gutter-sm)}.chips-row[_ngcontent-%COMP%]{display:flex;gap:var(--gutter-sm);margin:var(--gutter-sm) 0;flex-wrap:wrap}.section-title[_ngcontent-%COMP%]   .section-logo[_ngcontent-%COMP%], .section-logo[_ngcontent-%COMP%]{width:var(--fs-lg);height:var(--fs-lg);display:inline-block;object-fit:contain;vertical-align:middle;margin-right:.6rem;border-radius:6px}.section-logo.promethea-logo[_ngcontent-%COMP%], .section-logo.yuvi-logo[_ngcontent-%COMP%]{background:transparent}.esiti-timeline[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:var(--gutter-sm)}"]})};export{Ve as AddSoggetto};
