import{b as X,d as Z,f as ee,h as ie,o as te,p as ne,q as oe,v as re}from"./chunk-DK6BTRCD.js";import{a as Q}from"./chunk-ERQHX2OH.js";import{a as K}from"./chunk-SJ4NRQ5G.js";import"./chunk-NWP7JNX6.js";import{b as H}from"./chunk-7K4EWSAC.js";import{j as q,k as $,o as G,r as Y}from"./chunk-XADZCZ3D.js";import{Fa as v,Gb as O,Ib as D,Kb as l,La as A,Lb as S,Mb as L,Nb as V,Ob as P,Pb as w,Qb as b,Ra as B,S as W,Ub as T,Wa as f,X as g,Y as m,Zb as U,_b as z,ac as k,jc as R,lb as p,mb as r,nb as a,sb as j,tb as J,vb as C,yb as y,zb as c}from"./chunk-QBO2HR3F.js";import"./chunk-X5YLR3NI.js";import{a as N,b as F,i as x}from"./chunk-ODN5LVDJ.js";var ae=()=>({standalone:!0});function le(o,i){if(o&1&&(r(0,"option",30),l(1),a()),o&2){let e=i.$implicit;p("value",e.id),v(),S(e.label)}}function ve(o,i){if(o&1){let e=C();j(0),r(1,"select",21),b("ngModelChange",function(t){g(e);let s=c(3);return w(s.selectedUserId,t)||(s.selectedUserId=t),m(t)}),y("ngModelChange",function(t){g(e);let s=c(3);return m(s.onUserChange(t))}),f(2,le,2,2,"option",29),a(),J()}if(o&2){let e=c(3);v(),P("ngModel",e.selectedUserId),v(),p("ngForOf",e.users)}}function de(o,i){if(o&1&&(r(0,"div",31),l(1),a(),r(2,"div",19),l(3,"Stai modificando il sistema del tuo account"),a()),o&2){let e=c(3);v(),S(e.getUserLabel(e.selectedUserId))}}function ce(o,i){if(o&1&&(r(0,"option",17),l(1),a()),o&2){let e=i.$implicit;p("ngValue",e.id),v(),S(e.nome)}}function pe(o,i){if(o&1){let e=C();r(0,"div",36)(1,"input",37),b("ngModelChange",function(t){let s=g(e).$implicit;return w(s.titolo,t)||(s.titolo=t),m(t)}),a(),r(2,"input",38),b("ngModelChange",function(t){let s=g(e).$implicit;return w(s.importo,t)||(s.importo=t),m(t)}),a(),r(3,"button",11),y("click",function(){let t=g(e).index,s=c(4);return m(s.removeImporto(t))}),l(4,"Rimuovi"),a()()}if(o&2){let e=i.$implicit;v(),P("ngModel",e.titolo),p("ngModelOptions",T(4,ae)),v(),P("ngModel",e.importo),p("ngModelOptions",T(5,ae))}}function ge(o,i){if(o&1){let e=C();r(0,"div",36)(1,"input",39),b("ngModelChange",function(t){let s=g(e).$implicit;return w(s.soglia,t)||(s.soglia=t),m(t)}),a(),r(2,"input",40),b("ngModelChange",function(t){let s=g(e).$implicit;return w(s.bonus,t)||(s.bonus=t),m(t)}),a(),r(3,"button",11),y("click",function(){let t=g(e).index,s=c(4);return m(s.removePasso(t))}),l(4,"Rimuovi"),a()()}if(o&2){let e=i.$implicit;v(),P("ngModel",e.soglia),v(),P("ngModel",e.bonus)}}function me(o,i){if(o&1){let e=C();r(0,"div")(1,"div",20)(2,"label",14),l(3,"Importi per tipologia"),a(),f(4,pe,5,6,"div",32),r(5,"div",33)(6,"button",34),y("click",function(){g(e);let t=c(3);return m(t.addImporto())}),l(7,"Aggiungi importo"),a()(),r(8,"div",35),l(9,"Puoi aggiungere pi\xF9 importi per diverse tipologie (es. mensile, annuale). Modifica il titolo per distinguerli."),a()(),r(10,"div",20)(11,"label",14),l(12,"Step / Bonus"),a(),f(13,ge,5,2,"div",32),r(14,"div",33)(15,"button",34),y("click",function(){g(e);let t=c(3);return m(t.addPasso())}),l(16,"Aggiungi passo"),a()()()()}if(o&2){let e=c(3);v(4),p("ngForOf",e.provvigioni.gettone.importi)("ngForTrackBy",e.trackByImporto),v(9),p("ngForOf",e.provvigioni.gettone.passi)("ngForTrackBy",e.trackByPasso)}}function _e(o,i){if(o&1){let e=C();r(0,"div")(1,"div",20)(2,"label",14),l(3,"Percentuale (%)"),a(),r(4,"input",41),b("ngModelChange",function(t){g(e);let s=c(3);return w(s.provvigioni.percentuale.percent,t)||(s.provvigioni.percentuale.percent=t),m(t)}),a()()()}if(o&2){let e=c(3);v(4),P("ngModel",e.provvigioni.percentuale.percent)}}function ue(o,i){o&1&&(r(0,"span"),l(1,"Salvataggio..."),a())}function he(o,i){o&1&&(r(0,"span"),l(1,"Salva"),a())}function fe(o,i){if(o&1&&(r(0,"span",42),l(1),a()),o&2){let e=c(3);v(),S(e.message)}}function ye(o,i){if(o&1){let e=C();r(0,"div")(1,"div",13)(2,"label",14),l(3,"Utente"),a(),f(4,ve,3,2,"ng-container",12)(5,de,4,1,"ng-template",null,2,k),a(),r(7,"div",15)(8,"label",14),l(9,"Prodotto collegato (opzionale)"),a(),r(10,"select",16),b("ngModelChange",function(t){g(e);let s=c(2);return w(s.provvigioni.prodotto_id,t)||(s.provvigioni.prodotto_id=t),m(t)}),r(11,"option",17),l(12,"Nessun prodotto"),a(),f(13,ce,2,2,"option",18),a(),r(14,"div",19),l(15,"Seleziona il prodotto a cui associare questo sistema provvigionale. Puoi anche associare importi specifici per tipologia."),a()(),r(16,"div",20)(17,"label",14),l(18,"Modalit\xE0"),a(),r(19,"select",21),b("ngModelChange",function(t){g(e);let s=c(2);return w(s.provvigioni.tipo,t)||(s.provvigioni.tipo=t),m(t)}),r(20,"option",22),l(21,"Gettone (importo fisso per contratto)"),a(),r(22,"option",23),l(23,"Percentuale sul totale"),a()()(),f(24,me,17,4,"div",24)(25,_e,5,1,"div",24),r(26,"div",20)(27,"label",14),l(28,"Note"),a(),r(29,"textarea",21),b("ngModelChange",function(t){g(e);let s=c(2);return w(s.provvigioni.note,t)||(s.provvigioni.note=t),m(t)}),a()(),r(30,"div",25)(31,"button",26),y("click",function(){g(e);let t=c(2);return m(t.save())}),f(32,ue,2,0,"span",24)(33,he,2,0,"span",24),a(),r(34,"button",27),y("click",function(){g(e);let t=c(2);return m(t.cancelEdit())}),l(35,"Annulla"),a(),f(36,fe,2,1,"span",28),a()()}if(o&2){let e=O(6),n=c(2);v(4),p("ngIf",n.isAdmin)("ngIfElse",e),v(6),P("ngModel",n.provvigioni.prodotto_id),v(),p("ngValue",null),v(2),p("ngForOf",n.prodotti),v(6),P("ngModel",n.provvigioni.tipo),v(5),p("ngIf",n.provvigioni.tipo==="gettone"),v(),p("ngIf",n.provvigioni.tipo==="percentuale"),v(4),P("ngModel",n.provvigioni.note),v(2),p("disabled",n.saving),v(),p("ngIf",n.saving),v(),p("ngIf",!n.saving),v(),p("disabled",n.saving),v(2),p("ngIf",n.message)}}function xe(o,i){if(o&1&&(r(0,"div",58)(1,"label"),l(2,"Percentuale"),a(),r(3,"div",62),l(4),a()()),o&2){let e=c().$implicit;v(4),L("",(e.percentuale==null?null:e.percentuale.percent)??"\u2014","%")}}function Se(o,i){if(o&1&&(r(0,"div"),l(1),U(2,"number"),a()),o&2){let e=i.$implicit;v(),V(" ",e.titolo," \u2014 \u20AC",z(2,2,e.importo,"1.2-2")," ")}}function Pe(o,i){o&1&&(r(0,"div"),l(1,"Nessun importo"),a())}function we(o,i){if(o&1&&(r(0,"div",58)(1,"label"),l(2,"Importi"),a(),r(3,"div",62),f(4,Se,3,5,"div",63)(5,Pe,2,0,"div",24),a()()),o&2){let e=c().$implicit;v(4),p("ngForOf",e.gettone==null?null:e.gettone.importi),v(),p("ngIf",!(!(e.gettone==null||e.gettone.importi==null)&&e.gettone.importi.length))}}function be(o,i){if(o&1&&(r(0,"div"),l(1),U(2,"number"),a()),o&2){let e=i.$implicit;v(),V("",e.soglia," \u2192 \u20AC",z(2,2,e.bonus,"1.2-2"))}}function Ce(o,i){if(o&1&&(r(0,"div",58)(1,"label"),l(2,"Step / Bonus"),a(),r(3,"div",62),f(4,be,3,5,"div",63),a()()),o&2){let e=c().$implicit;v(4),p("ngForOf",e.gettone.passi)}}function Ee(o,i){if(o&1){let e=C();r(0,"div",47),y("click",function(){let t=g(e).index,s=c(4);return m(s.selectProvvigione(t))}),r(1,"div",48)(2,"div",49)(3,"div",50),l(4),a(),r(5,"div",51),l(6),a()(),r(7,"div",52)(8,"div",53),l(9),a(),r(10,"div",54),l(11),a()()(),r(12,"div",55)(13,"div",56),f(14,xe,5,1,"div",57)(15,we,6,2,"div",57)(16,Ce,5,1,"div",57),r(17,"div",58)(18,"label"),l(19,"Note"),a(),r(20,"div",59),l(21),a()(),r(22,"div",58)(23,"label"),l(24,"ID"),a(),r(25,"div",59),l(26),a()()()(),r(27,"div",60)(28,"button",11),y("click",function(t){let s=g(e).index;return c(4).editProvvigione(s),m(t.stopPropagation())}),l(29,"Modifica"),a(),r(30,"button",61),y("click",function(t){let s=g(e).index;return c(4).deleteProvvigione(s),m(t.stopPropagation())}),a()()()}if(o&2){let e=i.$implicit,n=i.index,t=c(4);D("active",n===t.activeProvvigioneIndex),v(4),S(e.tipo==="gettone"?"Gettone":"Percentuale"),v(2),S(t.productName(e.prodotto_id)||"Nessun prodotto"),v(3),S(e.__owner_label||t.getUserLabel(e.__owner_id)||"\u2014"),v(2),L("#",n+1),v(3),p("ngIf",e.tipo==="percentuale"),v(),p("ngIf",e.tipo==="gettone"),v(),p("ngIf",e.gettone==null||e.gettone.passi==null?null:e.gettone.passi.length),v(5),S(e.note||"\u2014"),v(5),S(e.__owner_id||"\u2014")}}function Ie(o,i){if(o&1&&(r(0,"div",20)(1,"h2",44),l(2,"Sistemi provvigionali presenti"),a(),r(3,"div",45),f(4,Ee,31,11,"div",46),a()()),o&2){let e=c(3);v(4),p("ngForOf",e.provvigioniList)}}function Me(o,i){o&1&&(r(0,"div",19),l(1,'Non sono presenti sistemi provvigionali. Premi "Aggiungi sistema" per crearne uno.'),a())}function Oe(o,i){if(o&1&&f(0,Ie,5,1,"div",43)(1,Me,2,0,"ng-template",null,3,k),o&2){let e=O(2),n=c(2);p("ngIf",n.provvigioniList&&n.provvigioniList.length)("ngIfElse",e)}}function ke(o,i){if(o&1&&(r(0,"div"),f(1,ye,37,14,"div",12)(2,Oe,3,2,"ng-template",null,1,k),a()),o&2){let e=O(3),n=c();v(),p("ngIf",n.isEditing)("ngIfElse",e)}}function Ae(o,i){o&1&&(r(0,"div",64),l(1,"Caricamento..."),a())}var se=class o{constructor(i,e,n){this.auth=i;this.userService=e;this.supabaseService=n}loading=!1;saving=!1;message=null;isAdmin=!1;users=[];selectedUserId=null;fetchingLabels=new Set;prodotti=[];userId=null;provvigioni=null;provvigioniList=[];activeProvvigioneIndex=0;isEditing=!1;cdr=W(R);ngOnInit(){return x(this,null,function*(){this.loading=!0;try{yield this.auth.ensureAuthInitialized(),this.userId=this.auth.getCurrentUserId();try{this.isAdmin=yield this.supabaseService.isAdmin()}catch{this.isAdmin=this.userService.isAdmin?.()??!1}yield this.loadProducts?.(),this.isAdmin?yield this.loadUsersAndProvvigioni():this.userId?yield this.loadProvvigioniFor(this.userId):(this.users=[],this.provvigioniList=[this.normalizeProvvigioni(null)])}catch(i){console.error("ngOnInit sistema provvigionale error",i),this.message="Errore caricamento",this.users=[],this.provvigioniList=[this.normalizeProvvigioni(null)]}finally{this.loading=!1,this.cdr.markForCheck()}})}loadUsers(){return x(this,null,function*(){try{let{data:i,error:e}=yield this.supabaseService.getAppUsers();if(e)throw e;let n=Array.isArray(i)?i:[];this.users=n.map(t=>F(N({},t),{label:(t.first_name||t.last_name)&&`${(t.first_name||"").trim()} ${(t.last_name||"").trim()}`.trim()||(t.display_name&&String(t.display_name).trim()!==""?t.display_name:t.email||"\u2014")}))}catch(i){console.error("Errore loadUsers",i),this.users=[]}})}loadAllProvvigioniFromUsers(){return x(this,null,function*(){try{let i=[];for(let e of this.users)try{let n=e.id;if(!n)continue;let d=((yield this.userService.getUserById(n))?.data??null)?.provvigioni??null;if(Array.isArray(d))d.forEach(_=>{let h=this.normalizeProvvigioni(JSON.parse(JSON.stringify(_)));h.__owner_id=n,h.__owner_label=e.label??e.email??n,i.push(h)});else if(d&&typeof d=="object"){let _=this.normalizeProvvigioni(JSON.parse(JSON.stringify(d)));_.__owner_id=n,_.__owner_label=e.label??e.email??n,i.push(_)}}catch(n){console.warn("Errore caricamento provvigioni per user",e.id,n);continue}i.length===0&&i.push(this.normalizeProvvigioni(null)),this.provvigioniList=i,this.activeProvvigioneIndex=0,this.provvigioni=this.provvigioniList[this.activeProvvigioneIndex],this.cdr.markForCheck()}catch(i){console.error("Errore loadAllProvvigioniFromUsers",i),this.message="Errore caricamento provvigioni"}})}loadProducts(){return x(this,null,function*(){try{let i=yield this.supabaseService.getProdotti?.()??this.supabaseService.supabase.from("prodotti").select("id, nome, descrizione, categoria, prezzo_base, attivo");console.debug("[sistema-provvigionale] raw products response:",i);let e=Array.isArray(i)?i:i?.data??null,n=Array.isArray(e)?e:[];if(!n.length){console.warn('[sistema-provvigionale] Nessun prodotto trovato nel DB. Verifica tabella "prodotti" o permessi.'),this.prodotti=[{id:"promethea",nome:"Promethea",descrizione:"",categoria:"Standard",prezzo_base:null,attivo:!0},{id:"yuvi",nome:"YUVI",descrizione:"",categoria:"Standard",prezzo_base:null,attivo:!0}];return}this.prodotti=n.map(t=>({id:t.id??t.ID??null,nome:t.nome??t.name??"",descrizione:t.descrizione??t.description??"",categoria:t.categoria??t.category??"",prezzo_base:t.prezzo_base??t.price??null,attivo:!!(t.attivo??t.active??!0)})).filter(t=>!!t.nome),console.debug("[sistema-provvigionale] prodotti caricati normalizzati:",this.prodotti)}catch(i){console.error("Errore loadProducts",i),this.prodotti=[]}})}loadProvvigioniFor(i){return x(this,null,function*(){this.loading=!0;try{let t=((yield this.userService.getUserById(i))?.data??null)?.provvigioni??null;Array.isArray(t)?this.provvigioniList=t.map(d=>this.normalizeProvvigioni(JSON.parse(JSON.stringify(d)))):t&&typeof t=="object"?this.provvigioniList=[this.normalizeProvvigioni(JSON.parse(JSON.stringify(t)))]:this.provvigioniList=[this.normalizeProvvigioni(null)];let s=this.users.find(d=>d.id===i)?.label??null;this.provvigioniList=this.provvigioniList.map(d=>(d.__owner_id=i,d.__owner_label=s,d)),this.provvigioniList.length===0&&this.provvigioniList.push(this.normalizeProvvigioni(null)),this.activeProvvigioneIndex=0,this.provvigioni=this.provvigioniList[this.activeProvvigioneIndex],this.message=null}catch(e){console.error("Errore loadProvvigioniFor",e),this.message="Errore caricamento provvigioni"}finally{this.loading=!1,this.cdr.markForCheck()}})}selectProvvigione(i){i<0||i>=this.provvigioniList.length||(this.activeProvvigioneIndex=i,this.provvigioni=this.provvigioniList[i],this.cdr.markForCheck())}addNewProvvigione(){let i=this.normalizeProvvigioni(null);i.__isNew=!0,this.provvigioniList.push(i),this.selectProvvigione(this.provvigioniList.length-1),this.isEditing=!0}cancelEdit(){if(!this.provvigioni){this.isEditing=!1;return}this.provvigioni.__isNew&&(this.provvigioniList.splice(this.activeProvvigioneIndex,1),this.activeProvvigioneIndex=Math.max(0,this.provvigioneListLength-1)),this.provvigioni=this.provvigioniList.length?this.provvigioniList[0]:null,this.isEditing=!1,this.cdr.markForCheck()}get provvigioneListLength(){return Array.isArray(this.provvigioniList)?this.provvigioniList.length:0}onUserChange(i){i&&(this.selectedUserId=i,this.loadProvvigioniFor(i))}addPasso(i=5,e=0){(!this.provvigioni.gettone||typeof this.provvigioni.gettone!="object")&&(this.provvigioni.gettone={per_contratto:0,passi:[]}),Array.isArray(this.provvigioni.gettone.passi)||(this.provvigioni.gettone.passi=[]);let n=Object.assign({__uid:this.makeUid()},{soglia:i,bonus:e});this.provvigioni.gettone.passi.push(n),this.cdr.markForCheck()}trackByPasso(i,e){return e&&e.__uid?e.__uid:i}removePasso(i){this.provvigioni.gettone?.passi&&this.provvigioni.gettone.passi.splice(i,1)}save(){return x(this,null,function*(){let i=this.selectedUserId??this.userId;if(!i){this.message="Utente non selezionato";return}if(!this.isAdmin&&i!==this.userId){this.message="Permesso negato";return}this.saving=!0,this.message=null;try{yield this.auth.ensureAuthInitialized();let e=this.provvigioniList,{data:n,error:t}=yield this.supabaseService.updateAppUser(i,{provvigioni:e});if(t)throw t;this.provvigioniList=this.provvigioniList.map(s=>(s&&s.__isNew&&delete s.__isNew,s)),this.isEditing=!1,this.message="Impostazioni salvate"}catch(e){console.error("Errore salvataggio provvigioni",e),this.message=e?.message?`Errore: ${e.message}`:"Errore salvataggio"}finally{this.saving=!1,this.cdr.markForCheck()}})}getUserLabel(i){if(!i)return"";let e=this.users.find(n=>n.id===i);return e&&e.label?e.label:(this.fetchAndCacheUserLabel(i),"Caricamento nome...")}fetchAndCacheUserLabel(i){return x(this,null,function*(){if(!(!i||this.fetchingLabels.has(i))){this.fetchingLabels.add(i);try{let{data:e,error:n}=yield this.supabaseService.supabase.from("app_users").select("id, display_name, first_name, last_name, email").eq("id",i).single();if(n){console.error("Errore fetch user",n);return}let t=e||{},s=`${(t.first_name??"").trim()} ${(t.last_name??"").trim()}`.trim(),d=s||(t.display_name&&String(t.display_name).trim()!==""?String(t.display_name):t.email||"\u2014"),_=this.users.findIndex(h=>h.id===i);_>=0?this.users[_]=Object.assign({},this.users[_],t,{label:d}):this.users.push(Object.assign({},t,{id:i,label:d})),this.cdr.markForCheck()}catch(e){console.error("Errore fetchAndCacheUserLabel",e)}finally{this.fetchingLabels.delete(i)}}})}makeUid(){return"i"+Date.now().toString(36)+Math.floor(Math.random()*1e4).toString(36)}addImporto(i="Importo per contratto",e=0){(!this.provvigioni.gettone||typeof this.provvigioni.gettone!="object")&&(this.provvigioni.gettone={per_contratto:0,importi:[],passi:[]}),Array.isArray(this.provvigioni.gettone.importi)||(this.provvigioni.gettone.importi=[]);let n=Object.assign({__uid:this.makeUid()},{titolo:i,importo:e});this.provvigioni.gettone.importi.push(n),this.cdr.markForCheck()}normalizeProvvigioni(i){return i?(i=JSON.parse(JSON.stringify(i)),Object.prototype.hasOwnProperty.call(i,"prodotto_id")||(i.prodotto_id=null),(!i.gettone||typeof i.gettone!="object")&&(i.gettone={per_contratto:0,importi:[],passi:[]}),Array.isArray(i.gettone.importi)||(i.gettone.importi=[]),Array.isArray(i.gettone.passi)||(i.gettone.passi=[]),i.gettone.importi=i.gettone.importi.map(e=>(e.__uid||(e.__uid=this.makeUid()),e)),(i.gettone.per_contratto||i.gettone.per_contratto===0)&&i.gettone.importi.length===0&&i.gettone.importi.push({__uid:this.makeUid(),titolo:"Importo per contratto",importo:Number(i.gettone.per_contratto||0)}),i.percentuale||(i.percentuale={percent:0}),i):{tipo:"gettone",gettone:{per_contratto:0,importi:[{__uid:this.makeUid(),titolo:"Importo per contratto",importo:0}],passi:[]},percentuale:{percent:0},abilitato:!0,note:"",prodotto_id:null}}removeImporto(i){this.provvigioni.gettone?.importi&&(this.provvigioni.gettone.importi.splice(i,1),this.cdr.markForCheck())}trackByImporto(i,e){return e&&e.__uid?e.__uid:i}productName(i){if(!i)return"Nessun prodotto";let e=this.prodotti.find(n=>n.id===i);return e&&(e.nome??e.id)||i||"Nessun prodotto"}editProvvigione(i){if(!(i<0||i>=this.provvigioniList.length)){if(this.selectProvvigione(i),this.isEditing=!0,delete this.provvigioni.__isNew,this.selectedUserId=this.provvigioni.__owner_id??null,Object.prototype.hasOwnProperty.call(this.provvigioni,"prodotto_id")||(this.provvigioni.prodotto_id=null),this.prodotti?.length){let e=this.prodotti.find(n=>String(n.id)===String(this.provvigioni.prodotto_id));this.provvigioni.prodotto_id=e?e.id:null}else this.provvigioni.prodotto_id=this.provvigioni.prodotto_id??null;this.cdr.markForCheck()}}deleteProvvigione(i){return x(this,null,function*(){if(!window.confirm("Confermi l'eliminazione del sistema provvigionale selezionato?"))return;let n=this.provvigioniList?.[i];if(!n)return;let t=n.__owner_id??this.selectedUserId??this.userId;if(!t){this.message="Impossibile determinare il proprietario del sistema";return}this.saving=!0,this.message=null;let s=_=>{try{let h=JSON.parse(JSON.stringify(_||{}));return delete h.__owner_id,delete h.__owner_label,h}catch{return _}},d=JSON.stringify(s(n));try{let{data:_,error:h}=yield this.supabaseService.supabase.from("app_users").select("provvigioni").eq("id",t).single();if(h)throw h;let u=_?.provvigioni??null;if(Array.isArray(u)){let I=!1;for(let M=0;M<u.length;M++)if(JSON.stringify(s(u[M]))===d){u.splice(M,1),I=!0;break}I||(u=u.filter(M=>JSON.stringify(s(M))!==d))}else u&&typeof u=="object"?JSON.stringify(s(u))===d&&(u=null):u=u;let E=yield this.supabaseService.supabase.from("app_users").update({provvigioni:u}).eq("id",t);if(E.error)throw E.error;yield this.loadUsersAndProvvigioni(),this.message="Sistema provvigionale eliminato"}catch(_){console.error("Errore eliminazione provvigione",_),this.message=_?.message?`Errore: ${_.message}`:"Errore eliminazione"}finally{this.saving=!1,this.cdr.markForCheck()}})}loadUsersAndProvvigioni(){return x(this,null,function*(){try{let{data:i,error:e}=yield this.supabaseService.supabase.from("app_users").select("id, first_name, last_name, display_name, email, provvigioni");if(e)throw e;let n=Array.isArray(i)?i:[],t=[],s=[];for(let d of n){let h=`${(d.first_name??"").trim()} ${(d.last_name??"").trim()}`.trim()||(d.display_name&&String(d.display_name).trim()!==""?d.display_name:d.email||"\u2014");t.push({id:d.id,label:h,email:d.email,first_name:d.first_name,last_name:d.last_name});let u=d.provvigioni;if(Array.isArray(u))u.forEach(E=>{let I=this.normalizeProvvigioni(JSON.parse(JSON.stringify(E)));I.__owner_id=d.id,I.__owner_label=h,s.push(I)});else if(u&&typeof u=="object"){let E=this.normalizeProvvigioni(JSON.parse(JSON.stringify(u)));E.__owner_id=d.id,E.__owner_label=h,s.push(E)}}this.users=t,this.provvigioniList=s.length?s:[this.normalizeProvvigioni(null)],this.activeProvvigioneIndex=0,this.provvigioni=this.provvigioniList[this.activeProvvigioneIndex],this.cdr.markForCheck()}catch(i){console.error("Errore loadUsersAndProvvigioni",i),this.users=[],this.provvigioniList=[this.normalizeProvvigioni(null)]}})}static \u0275fac=function(e){return new(e||o)(A(K),A(Q),A(H))};static \u0275cmp=B({type:o,selectors:[["app-sistema-provvigionale"]],decls:15,vars:2,consts:[["loadingTpl",""],["previewOnly",""],["readonlyUser",""],["emptyList",""],[1,"form-section"],[1,"section-header"],[1,"material-icons","header-icon"],[1,"section-titles"],[1,"section-title"],[1,"sottotitolo"],[2,"display","flex","gap","0.75rem","align-items","center","margin-bottom","1rem","flex-wrap","wrap"],["type","button",1,"promethea-button","ghost",3,"click"],[4,"ngIf","ngIfElse"],[1,"form-field",2,"margin-bottom","1rem"],[1,"form-label"],[1,"form-field",2,"margin-bottom","0.5rem"],["name","prodotto",1,"form-control",3,"ngModelChange","ngModel"],[3,"ngValue"],[3,"ngValue",4,"ngFor","ngForOf"],[1,"hint"],[1,"form-field"],[3,"ngModelChange","ngModel"],["value","gettone"],["value","percentuale"],[4,"ngIf"],[1,"actions-container",2,"margin-top","1rem"],[1,"promethea-button",3,"click","disabled"],["type","button",1,"promethea-button","ghost",2,"margin-left","0.5rem",3,"click","disabled"],["style","margin-left:1rem;color:var(--success-color)",4,"ngIf"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],[1,"readonly-field"],["style","display:flex; gap:0.5rem; align-items:center; margin-bottom:0.375rem;",4,"ngFor","ngForOf","ngForTrackBy"],[2,"margin-top","0.5rem"],["type","button",1,"promethea-button",3,"click"],[1,"hint",2,"margin-top","0.5rem"],[2,"display","flex","gap","0.5rem","align-items","center","margin-bottom","0.375rem"],["type","text","placeholder","Titolo (es. contratti mensili)",2,"flex","1",3,"ngModelChange","ngModel","ngModelOptions"],["type","number","placeholder","\u20AC",2,"width","120px",3,"ngModelChange","ngModel","ngModelOptions"],["type","number","placeholder","Soglia (n contratti)",3,"ngModelChange","ngModel"],["type","number","placeholder","Bonus \u20AC",3,"ngModelChange","ngModel"],["type","number",3,"ngModelChange","ngModel"],[2,"margin-left","1rem","color","var(--success-color)"],["class","form-field",4,"ngIf","ngIfElse"],[1,"section-title",2,"margin-top","var(--gutter-lg)"],[1,"provvigioni-grid"],["class","card provvigione-card",3,"active","click",4,"ngFor","ngForOf"],[1,"card","provvigione-card",3,"click"],[1,"card-header"],[1,"card-title"],[1,"title-strong"],[1,"meta-row"],[1,"card-meta"],[1,"owner-label"],[1,"chip"],[1,"card-body"],[1,"provvigione-detail"],["class","detail-row",4,"ngIf"],[1,"detail-row"],[1,"value","small"],[1,"card-actions"],["type","button","title","Elimina",1,"icon-btn","close",3,"click"],[1,"value"],[4,"ngFor","ngForOf"],[1,"loading"]],template:function(e,n){if(e&1){let t=C();r(0,"div",4)(1,"div",5)(2,"div",6),l(3,"attach_money"),a(),r(4,"div",7)(5,"h1",8),l(6,"Sistema provvigionale"),a(),r(7,"div",9),l(8,"Configura i sistemi provvigionali aziendali e crea nuovi sistemi"),a()()(),r(9,"div",10)(10,"button",11),y("click",function(){return g(t),m(n.addNewProvvigione())}),l(11," Aggiungi sistema "),a()(),f(12,ke,4,2,"div",12)(13,Ae,2,0,"ng-template",null,0,k),a()}if(e&2){let t=O(14);v(12),p("ngIf",!n.loading)("ngIfElse",t)}},dependencies:[Y,q,$,re,ne,oe,X,ie,te,Z,ee,G],styles:[".provvigioni-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1rem;align-items:start}.provvigione-card[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.5rem;padding:.75rem;min-height:160px;transition:box-shadow .12s ease,transform .08s ease;cursor:pointer}.provvigione-card[_ngcontent-%COMP%]:hover{transform:translateY(-4px);box-shadow:var(--shadow-md)}.provvigione-card.active[_ngcontent-%COMP%]{border:1px solid var(--primary);box-shadow:var(--shadow-lg)}.card-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:flex-start;gap:.5rem}.card-title[_ngcontent-%COMP%]   .title-strong[_ngcontent-%COMP%]{font-weight:700}.card-meta[_ngcontent-%COMP%]{display:flex;gap:.5rem;align-items:center}.card-body[_ngcontent-%COMP%]{flex:1;display:block}.provvigione-detail[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.5rem}.detail-row[_ngcontent-%COMP%]{display:flex;justify-content:space-between;gap:.75rem;align-items:flex-start}.detail-row[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{font-size:.8rem;color:var(--muted-color)}.detail-row[_ngcontent-%COMP%]   .value[_ngcontent-%COMP%]{font-size:.95rem;color:var(--text-color)}.card-actions[_ngcontent-%COMP%]{display:flex;gap:.5rem;justify-content:flex-end;align-items:center;margin-top:.25rem}.card-actions[_ngcontent-%COMP%]   .promethea-button[_ngcontent-%COMP%]{height:36px;padding:0 .75rem}.owner-label[_ngcontent-%COMP%], .small[_ngcontent-%COMP%]{font-size:.85rem;color:var(--muted-color)}@media (max-width:720px){.provvigioni-grid[_ngcontent-%COMP%]{grid-template-columns:1fr}.detail-row[_ngcontent-%COMP%]{flex-direction:column;align-items:flex-start;gap:.25rem}}"]})};export{se as SistemaProvvigionale};
