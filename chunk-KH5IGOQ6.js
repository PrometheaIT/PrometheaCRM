import{b as S}from"./chunk-5QACXCZZ.js";import{N as T,S as b}from"./chunk-CPJK23XT.js";import{a as u,b as m,i as r}from"./chunk-ODN5LVDJ.js";var z=class p{supabaseService=b(S);STATI_MACRO={da_fare:"Da Fare",in_lavorazione:"In Lavorazione",completato:"Completato",in_attesa:"In Attesa"};PRIORITA_MAP={1:"Minima",2:"Bassa",3:"Media",4:"Alta",5:"Urgente"};MODULI_MAP={immagine_marketing:"Immagine e Marketing",digitalizzazione_automatismi:"Digitalizzazione e Automatismi",contabilita_fiscalita:"Contabilit\xE0 e Fiscalit\xE0",ottimizzazione_management:"Ottimizzazione e Management"};getMacroTasks(){return r(this,null,function*(){let{data:a,error:t}=yield this.supabaseService.supabase.from("macro_tasks").select(`
        *,
        cliente:cliente_id (id, ragione_sociale, provincia),
        sotto_tasks (
          *,
          task_dettaglio (*)
        )
      `).order("created_at",{ascending:!1});return a&&a.forEach(e=>this.calcolaMetricheTask(e)),{data:a,error:t}})}getMacroTaskById(a){return r(this,null,function*(){try{let{data:t,error:e}=yield this.supabaseService.supabase.from("macro_tasks").select("*, sotto_tasks(*, task_dettaglio(*))").eq("id",a).single();if(e)return{data:null,error:e};if(t)try{this.calcolaMetricheTask(t)}catch{}return{data:t,error:null}}catch(t){return{data:null,error:t}}})}createMacroTask(a){return r(this,null,function*(){let t=new Date().toISOString(),e={nome:a.nome,data_scadenza:a.data_scadenza,note:a.note||"",stato:a.stato||"da_fare",progresso:a.progresso||0,priorita_globale:a.priorita_globale||1,extra_data:{},created_at:t,updated_at:t};a.cliente_id&&this.isValidUUID(a.cliente_id)&&(e.cliente_id=a.cliente_id),a.assegnazione_id&&(e.assegnazione_id=a.assegnazione_id);let{data:s,error:o}=yield this.supabaseService.supabase.from("macro_tasks").insert([e]).select("id").maybeSingle();return{data:s,error:o}})}isValidUUID(a){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(a)}updateMacroTask(a,t){return r(this,null,function*(){let e=m(u({},t),{updated_at:new Date().toISOString()});console.debug("[TaskService] updateMacroTask request:",{id:a,updateData:e});let{data:s,error:o}=yield this.supabaseService.supabase.from("macro_tasks").update(e).eq("id",a).select(`
        *,
        cliente:cliente_id (*)
      `).single();return o?console.error("[TaskService] updateMacroTask error:",o):console.debug("[TaskService] updateMacroTask response data:",s),{data:s,error:o}})}createSottoTask(a){return r(this,null,function*(){let t=new Date().toISOString(),{data:e,error:s}=yield this.supabaseService.supabase.from("sotto_tasks").insert([m(u({},a),{stato:"da_fare",created_at:t,updated_at:t})]).select().single();return e&&(yield this.aggiornaMacroTaskAutomaticamente(a.macro_task_id)),{data:e,error:s}})}updateSottoTask(a,t){return r(this,null,function*(){let{data:e}=yield this.supabaseService.supabase.from("sotto_tasks").select("id, macro_task_id").eq("id",a).single();if(!e)return{data:null,error:{message:"Sotto-task non trovata",details:"",hint:"",code:"404"}};let{data:s,error:o}=yield this.supabaseService.supabase.from("sotto_tasks").update(m(u({},t),{updated_at:new Date().toISOString()})).eq("id",a).select().single();return s&&e.macro_task_id&&(yield this.aggiornaMacroTaskAutomaticamente(e.macro_task_id)),{data:s,error:o}})}createTaskDettaglio(a){return r(this,null,function*(){let t=new Date().toISOString(),{data:e,error:s}=yield this.supabaseService.supabase.from("task_dettaglio").insert([m(u({},a),{completato:!1,data_completamento:null,created_at:t,updated_at:t})]).select().single();return{data:e,error:s}})}toggleTaskDettaglioCompletato(a,t){return r(this,null,function*(){let e={completato:t,data_completamento:t?new Date().toISOString():null,updated_at:new Date().toISOString()},{data:s,error:o}=yield this.supabaseService.supabase.from("task_dettaglio").update(e).eq("id",a).select().single();return{data:s,error:o}})}deleteTaskDettaglio(a){return r(this,null,function*(){let{error:t}=yield this.supabaseService.supabase.from("task_dettaglio").delete().eq("id",a);return{data:null,error:t}})}deleteMacroTaskCascade(a){return r(this,null,function*(){try{let{error:t}=yield this.supabaseService.supabase.from("macro_tasks").delete().eq("id",a);return{data:null,error:t}}catch(t){return{data:null,error:t}}})}calcolaMetricheTask(a){a.progresso=this.calcolaProgressoAutomatico(a.sotto_tasks||[]),a.stato=this.calcolaStatoMacroTaskAutomatico(a.sotto_tasks||[])}calcolaProgressoAutomatico(a){if(!a||a.length===0)return 0;let t=0;for(let e of a){let s=Array.isArray(e.task_dettaglio)?e.task_dettaglio:[],o=Math.max(1,s.length),n=0;s.length>0?n=s.filter(c=>!!c.completato).length:n=e.stato==="completato"?1:0;let i=Math.round(n/o*100);t+=i}return Math.round(t/a.length)}calcolaStatoMacroTaskAutomatico(a){if(!a.length)return"da_fare";let t=a.every(s=>s.stato==="completato"),e=a.some(s=>s.stato==="in_lavorazione"||s.stato==="completato");return t?"completato":e?"in_lavorazione":"da_fare"}aggiornaMacroTaskAutomaticamente(a){return r(this,null,function*(){let{data:t}=yield this.getMacroTaskById(a);t&&(yield this.updateMacroTask(a,{progresso:t.progresso,stato:t.stato}))})}calcolaPrioritaGlobale(a){return a.length>0?Math.max(...a.map(t=>t.priorita)):1}getSottoTaskCounts(a){return{daFare:a.filter(t=>t.stato==="da_fare").length,inLavorazione:a.filter(t=>t.stato==="in_lavorazione").length,completate:a.filter(t=>t.stato==="completato").length}}getNomePriorita(a){return this.PRIORITA_MAP[a]||"Non definita"}getStatoTesto(a){return this.STATI_MACRO[a]||a}getModuloName(a){return a?{immagine:"Immagine",digitalizzazione:"Digitalizzazione",contabilita:"Contabilit\xE0",ottimizzazione:"Ottimizzazione"}[a]||"Modulo sconosciuto":"Modulo non assegnato"}updateTaskDettaglio(a,t){return r(this,null,function*(){let{data:e,error:s}=yield this.supabaseService.supabase.from("task_dettaglio").update(m(u({},t),{updated_at:new Date().toISOString()})).eq("id",a).select().single();return{data:e,error:s}})}getStatoBadgeClass(a){return{completato:"status-yes",in_lavorazione:"status-warning",in_attesa:"status-info",da_fare:"status-badge"}[a]||"status-badge"}getPrioritaBadgeClass(a){return{5:"status-no",4:"status-warning",3:"status-info",2:"status-badge",1:"status-badge"}[a]||"status-badge"}isScadenzaImminente(a){let t=new Date(a),e=new Date,s=Math.ceil((t.getTime()-e.getTime())/(1e3*3600*24));return s<=3&&s>=0}isScaduta(a){return new Date(a)<new Date}getMacroTaskTemplates(){return r(this,null,function*(){let{data:a,error:t}=yield this.supabaseService.supabase.from("macro_task_templates").select("*").order("nome",{ascending:!0});return{data:a,error:t}})}createMacroTaskTemplate(a){return r(this,null,function*(){let{data:t,error:e}=yield this.supabaseService.supabase.from("macro_task_templates").insert([m(u({},a),{created_at:new Date().toISOString(),updated_at:new Date().toISOString()})]).select().single();return{data:t,error:e}})}createMacroTaskFromTemplate(a,t,e){return r(this,null,function*(){try{let{data:s,error:o}=yield this.supabaseService.supabase.from("macro_task_templates").select("*").eq("id",a).single();if(o)return{data:null,error:o};let n={nome:s.nome,data_scadenza:e,cliente_id:t,assegnazione_id:s.modulo,note:s.descrizione||"",stato:"da_fare"},{data:i,error:c}=yield this.createMacroTask(n);if(c)return{data:null,error:c};if(!i?.id)return{data:null,error:{message:"ID non restituito dalla creazione della macro task",details:"",hint:"",code:"no-id"}};let l=s.struttura_template||{},g=Array.isArray(l.sotto_tasks)?l.sotto_tasks:[];for(let d of g){let M={nome:d.nome,priorita:d.priorita,macro_task_id:i.id},{data:f,error:y}=yield this.createSottoTask(M);if(y||!f)continue;let h=Array.isArray(d.task_dettaglio)?d.task_dettaglio:[];for(let _ of h){let k=new Date,D=Number(_.data_scadenza_prevista_offset)||0;k.setDate(k.getDate()+D);let v={nome:_.nome,descrizione:_.descrizione||"",data_scadenza_prevista:k.toISOString().split("T")[0],sotto_task_id:f.id};yield this.createTaskDettaglio(v)}}return yield this.getMacroTaskById(i.id)}catch(s){return{data:null,error:s}}})}canModifyTask(a,t){if(!a||!t)return!1;if(a.is_admin)return!0;let e=t.assegnazione_id??null;return e?e==="tutti"?a.moduli&&a.moduli.length>0||!0:!!a.moduli&&a.moduli.includes(e):!1}canViewTask(a,t){if(!t||!a)return!1;if(a.is_admin)return!0;let e=(t.assegnazione_id??"").toString();if(!e)return!1;if(e==="tutti")return!0;let o={immagine_marketing:"immagine",immagine:"immagine",digitalizzazione_automatismi:"digitalizzazione",digitalizzazione:"digitalizzazione",contabilita_fiscalita:"contabilita",contabilita:"contabilita",ottimizzazione_management:"ottimizzazione",ottimizzazione:"ottimizzazione"}[e]??e;return Array.isArray(a.moduli)&&(a.moduli.includes(e)||a.moduli.includes(o))}copyMacroTask(a,t){return r(this,null,function*(){try{let{data:e,error:s}=yield this.supabaseService.supabase.from("macro_tasks").select("*, sotto_tasks(*, task_dettaglio(*))").eq("id",a).single();if(s||!e)return{data:null,error:s||{message:"Fonte non trovata"}};let o=new Date().toISOString(),n={nome:e.nome+" (copia)",data_scadenza:e.data_scadenza,note:e.note,stato:"da_fare",progresso:0,priorita_globale:e.priorita_globale||1,cliente_id:t??e.cliente_id??null,created_at:o,updated_at:o},{data:i,error:c}=yield this.supabaseService.supabase.from("macro_tasks").insert([n]).select("id").maybeSingle();if(c||!i?.id)return{data:null,error:c||{message:"Errore creazione copia"}};for(let l of e.sotto_tasks||[]){let{data:g}=yield this.createSottoTask({nome:l.nome,priorita:l.priorita,macro_task_id:i.id});if(g&&l.task_dettaglio)for(let d of l.task_dettaglio)yield this.createTaskDettaglio({nome:d.nome,descrizione:d.descrizione,data_scadenza_prevista:d.data_scadenza_prevista,sotto_task_id:g.id})}return yield this.getMacroTaskById(i.id)}catch(e){return{data:null,error:e}}})}getCountsAggregate(a){let t=a.sotto_tasks||[],e=t.length,s=t.filter(i=>i.stato==="completato").length,o=0,n=0;for(let i of t){let c=i.task_dettaglio||[];o+=c.length||0,n+=c.filter(l=>l.completato).length}return{totalSotto:e,completedSotto:s,totalDet:o,completedDet:n}}deleteSottoTask(a){return r(this,null,function*(){let{data:t}=yield this.supabaseService.supabase.from("sotto_tasks").select("id, macro_task_id").eq("id",a).single();if(!t)return{data:null,error:{message:"Sotto-task non trovata"}};let{error:e}=yield this.supabaseService.supabase.from("sotto_tasks").delete().eq("id",a);return!e&&t.macro_task_id&&(yield this.aggiornaMacroTaskAutomaticamente(t.macro_task_id)),{data:null,error:e}})}static \u0275fac=function(t){return new(t||p)};static \u0275prov=T({token:p,factory:p.\u0275fac,providedIn:"root"})};export{z as a};
